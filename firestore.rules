rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ===== Auth helpers =====
    function signedIn() {
      return request.auth != null;
    }

    // ìµëª… ì°¨ë‹¨(Email/Password ë“±ë§Œ í—ˆìš©)
    function isSignedInNonAnon() {
      return request.auth != null
        && request.auth.token.firebase.sign_in_provider != 'anonymous';
    }

    // ===== user_roles ê¸°ë°˜ Admin íŒë³„(ì•ˆì „íŒ/ë¶€íŠ¸ìŠ¤íŠ¸ë©) =====
    function isAdmin() {
      return isSignedInNonAnon()
        && exists(/databases/$(database)/documents/user_roles/$(request.auth.uid))
        && get(/databases/$(database)/documents/user_roles/$(request.auth.uid)).data.role == "admin";
    }

    // ===== projects ê¶Œí•œ(ë‹¨ì¼ ì§„ì‹¤ ì†ŒìŠ¤: projects/{projectId}/members/{uid}) =====
    function hasRoleInProject(projectId) {
      return isSignedInNonAnon()
        && exists(/databases/$(database)/documents/projects/$(projectId)/members/$(request.auth.uid));
    }

    // âœ… ë©¤ë²„ ë¬¸ì„œ ê°€ì ¸ì˜¤ê¸° í—¬í¼
    function myMemberDoc(projectId) {
      return get(/databases/$(database)/documents/projects/$(projectId)/members/$(request.auth.uid));
    }

    // âœ… ì—­í•  ê°’ ì •ê·œí™” (ëŒ€ì†Œë¬¸ì/ê³µë°±/ì´ìƒê°’ ë°©ì–´)
    // í—ˆìš© ë¦¬ìŠ¤íŠ¸ ì™¸ì—ëŠ” viewerë¡œ ê°•ì œ
    function safeRole(r) {
      return (r in ["admin", "editor", "viewer"]) ? r : "viewer";
    }

    // âœ… í¬í„¸ ì—­í•  í™•ì¸ (í¬í„¸ UI/ê¸°ëŠ¥ìš©)
    // portalRoleì´ null/ë¯¸ì¡´ì¬ë©´ viewerë¡œ ê¸°ë³¸ê°’ ì„¤ì •
    function myPortalRole(projectId) {
      let r = myMemberDoc(projectId).data.portalRole;
      return (r in ["admin", "editor", "viewer"]) ? r : "viewer";
    }

    // âœ… ê³µì •í‘œ ì—­í•  í™•ì¸ (ê³µì •í‘œ ê¶Œí•œìš©) - processRole ìš°ì„ , ì—†ìœ¼ë©´ role (í•˜ìœ„ í˜¸í™˜)
    // ğŸ”¥ í•µì‹¬ ì•ˆì „ì¥ì¹˜: portal adminì´ ì•„ë‹ˆë©´ process admin ë¶ˆê°€
    function myProcessRole(projectId) {
      let m = myMemberDoc(projectId).data;
      
      // í•˜ìœ„í˜¸í™˜: processRole ìš°ì„ , ì—†ìœ¼ë©´ role
      let role = (m.processRole != null) ? m.processRole : m.role;
      
      // âœ… ì—­í•  ê°’ ì •ê·œí™” (ëŒ€ì†Œë¬¸ì/ê³µë°±/ì´ìƒê°’ ë°©ì–´)
      role = safeRole(role);

      // ğŸš« ì •ì±… ê°•ì œ: portal adminì´ ì•„ë‹ˆë©´ process admin ë¶ˆê°€
      // portal editorê°€ ê³µì •í‘œ adminì´ ë˜ëŠ” ê²ƒì„ êµ¬ì¡°ì ìœ¼ë¡œ ì°¨ë‹¨
      return (myPortalRole(projectId) != "admin" && role == "admin")
        ? "editor"
        : role;
    }

    // âœ… ê³µì •í‘œ admin í™•ì¸ (processRole ê¸°ë°˜)
    // ğŸ”¥ í•µì‹¬: portalRoleì´ adminì´ì–´ì•¼ "ê³µì •í‘œ admin" ì¸ì •
    // portal editor + processRole adminì€ ì ˆëŒ€ adminìœ¼ë¡œ ì¸ì •ë˜ì§€ ì•ŠìŒ
    function isProcessAdminInProject(projectId) {
      return isSignedInNonAnon()
        && exists(/databases/$(database)/documents/projects/$(projectId)/members/$(request.auth.uid))
        && myPortalRole(projectId) == "admin"  // âœ… portalRoleì´ adminì´ì–´ì•¼ ê³µì •í‘œ admin ì¸ì •
        && myProcessRole(projectId) == "admin";
    }

    // âœ… ê³µì •í‘œ editor ì´ìƒ í™•ì¸ (processRole ê¸°ë°˜)
    function canEditProcessTable(projectId) {
      return isSignedInNonAnon()
        && exists(/databases/$(database)/documents/projects/$(projectId)/members/$(request.auth.uid))
        && myProcessRole(projectId) in ["editor", "admin"];
    }

    // âš ï¸ í•˜ìœ„ í˜¸í™˜: ê¸°ì¡´ isAdminInProject (role í•„ë“œ ì‚¬ìš©)
    function isAdminInProject(projectId) {
      return isSignedInNonAnon()
        && exists(/databases/$(database)/documents/projects/$(projectId)/members/$(request.auth.uid))
        && (myProcessRole(projectId) == "admin" || get(/databases/$(database)/documents/projects/$(projectId)/members/$(request.auth.uid)).data.role == "admin");
    }

    // ===== user_roles =====
    match /user_roles/{uid} {
      allow read: if isSignedInNonAnon()
        && (request.auth.uid == uid || isAdmin());
      allow write: if isAdmin();
    }

    // ===== Projects =====
    match /projects/{projectId} {

      // âœ… ë°©ë²• A: í”„ë¡œì íŠ¸ ë©¤ë²„ë©´ ë£¨íŠ¸ ë¬¸ì„œ read í—ˆìš© (role ë¬´ê´€)
      allow read: if hasRoleInProject(projectId);

      // ë£¨íŠ¸ ë¬¸ì„œ writeëŠ” í”„ë¡œì íŠ¸ adminë§Œ(ì›í•˜ë©´ falseë¡œ ì ê¶ˆë„ ë¨)
      allow write: if isAdminInProject(projectId);

      // (1) ë©¤ë²„: í”„ë¡œì íŠ¸ ê¶Œí•œì˜ ë‹¨ì¼ ì§„ì‹¤ ì†ŒìŠ¤
      match /members/{uid} {
        // ë³¸ì¸ ë¬¸ì„œ ì½ê¸° ë˜ëŠ” (ì •ì±… ê²€ì¦ëœ) ê³µì •í‘œ adminë§Œ ì½ê¸°
        allow read: if isSignedInNonAnon()
          && (request.auth.uid == uid || isProcessAdminInProject(projectId));
        
        // âœ… ë©¤ë²„ ë¬¸ì„œ ìˆ˜ì •ì€ ë³¸ì¸ë„ ë¶ˆê°€ (ê¶Œí•œì„ ìŠ¤ìŠ¤ë¡œ ì˜¬ë¦¬ëŠ” ê²ƒ ë°©ì§€)
        // (ì •ì±… ê²€ì¦ëœ) ê³µì •í‘œ adminë§Œ ë‹¤ë¥¸ ë©¤ë²„ ê¶Œí•œ ë³€ê²½ ê°€ëŠ¥
        // âœ… í—ˆìš© í•„ë“œ ì œí•œ: role ê´€ë ¨ í•„ë“œë§Œ ë³€ê²½ ê°€ëŠ¥
        allow update: if isSignedInNonAnon()
          && request.auth.uid != uid  // ë³¸ì¸ ë¬¸ì„œ ìˆ˜ì • ë¶ˆê°€
          && isProcessAdminInProject(projectId)  // (ì •ì±… ê²€ì¦ëœ) ê³µì •í‘œ adminë§Œ ê°€ëŠ¥
          && request.resource.data.diff(resource.data).changedKeys()
             .hasOnly(["portalRole", "processRole", "allowedProcesses"]);  // âœ… role ê´€ë ¨ í•„ë“œë§Œ ë³€ê²½ ê°€ëŠ¥
        
        // ìƒì„±/ì‚­ì œëŠ” (ì •ì±… ê²€ì¦ëœ) ê³µì •í‘œ adminë§Œ
        allow create, delete: if isSignedInNonAnon()
          && isProcessAdminInProject(projectId);
      }

      // (2) í¬í„¸ ì—­í• : ì°¸ê³ /í‘œì‹œìš©(ì½ê¸° ì „ìš©) â€” âœ… ë³¸ì¸ë§Œ
      match /portal_members/{uid} {
        allow read: if isSignedInNonAnon() && request.auth.uid == uid;
        allow write: if false;
      }

      // (3) ìŠ¤ì¼€ì¤„ (ê³µì •í‘œ ë°ì´í„° ì˜ˆì‹œ)
      match /schedules/{scheduleId} {
        // ì¡°íšŒëŠ” processRoleì´ viewer ì´ìƒì´ë©´ í—ˆìš©
        allow read: if isSignedInNonAnon()
          && hasRoleInProject(projectId)
          && myProcessRole(projectId) in ["viewer", "editor", "admin"];
        
        // ì…ë ¥/ìˆ˜ì •ì€ processRoleì´ editor ì´ìƒ
        allow create, update: if isSignedInNonAnon()
          && canEditProcessTable(projectId);
        
        // ì‚­ì œ/ì´ˆê¸°í™” ê°™ì€ ê°•ê¶Œí•œì€ processRole=adminë§Œ
        allow delete: if isSignedInNonAnon()
          && isProcessAdminInProject(projectId);
      }
      
      // (4) ê³µì •í‘œ ë°ì´í„° (kcolumn ë“±ë„ ë™ì¼í•œ ì›ì¹™ ì ìš©)
      match /processTable/{docId} {
        allow read: if isSignedInNonAnon()
          && hasRoleInProject(projectId)
          && myProcessRole(projectId) in ["viewer", "editor", "admin"];
        allow create, update: if isSignedInNonAnon()
          && canEditProcessTable(projectId);
        allow delete: if isSignedInNonAnon()
          && isProcessAdminInProject(projectId);
      }
    }

    // ===== kcolumn (ë¬¸ì„œIDì— projectIdê°€ í¬í•¨: "P1_xxx") =====
    function projectIdFromKcolumnId(docId) {
      return docId.split('_')[0];
    }

    match /kcolumn/{docId} {
      // ì¡°íšŒëŠ” processRoleì´ viewer ì´ìƒ
      allow read: if isSignedInNonAnon()
        && hasRoleInProject(projectIdFromKcolumnId(docId))
        && myProcessRole(projectIdFromKcolumnId(docId)) in ["viewer", "editor", "admin"];
      
      // ì…ë ¥/ìˆ˜ì •ì€ processRoleì´ editor ì´ìƒ
      allow create, update: if isSignedInNonAnon()
        && canEditProcessTable(projectIdFromKcolumnId(docId));
      
      // ì‚­ì œëŠ” processRole=adminë§Œ
      allow delete: if isSignedInNonAnon()
        && isProcessAdminInProject(projectIdFromKcolumnId(docId));
    }

    // ===== ê¸°ì¡´ /portal_members ê²½ë¡œ ì™„ì „ ì°¨ë‹¨ =====
    match /portal_members/{document=**} {
      allow read, write: if false;
    }

    // âœ… ê°•ì œ ì•ˆì „ëª¨ë“œ(ì„ íƒ): ìœ„ì—ì„œ í—ˆìš©í•œ ì»¬ë ‰ì…˜ ì™¸ ì „ë¶€ ì°¨ë‹¨
    match /{top=**} {
      allow read, write: if false;
    }
  }
}
