rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 사용자 역할 가져오기 헬퍼 함수
    function getUserRole() {
      let roleDoc = get(/databases/$(database)/documents/user_roles/$(request.auth.uid));
      return roleDoc != null ? roleDoc.data.role : null;
    }
    
    // 역할이 있는지 확인 (익명 사용자 차단)
    function hasRole() {
      return getUserRole() != null;
    }
    
    // 사용자 역할 관리
    match /user_roles/{userId} {
      // 인증된 사용자는 자신의 역할 읽기 가능
      allow read: if request.auth != null && request.auth.uid == userId;
      // Admin만 사용자 역할 수정 가능
      allow write: if request.auth != null && 
        get(/databases/$(database)/documents/user_roles/$(request.auth.uid)).data.role == 'admin';
    }
    
    // kcolumn collection: projectId 기반 접근 허용
    // 경로: kcolumn/{projectId}_{suffix}
    // 예: kcolumn/P1_columnData, kcolumn/P1_dailyData 등
    match /kcolumn/{document=**} {
      // 인증된 사용자는 모두 읽기 가능 (익명 사용자 포함)
      allow read: if request.auth != null;
      
      // 역할이 있는 사용자만 읽기 가능 (Viewer, Editor, Approver, Admin)
      // allow read: if request.auth != null && hasRole();
      
      // 인증된 사용자는 모두 쓰기 가능 (익명 사용자 포함, 테스트용)
      // 프로덕션 환경에서는 아래 주석 처리된 규칙을 사용하세요
      allow write: if request.auth != null;
      
      // Editor, Approver, Admin: 쓰기 가능 (프로덕션용)
      // allow write: if request.auth != null && hasRole() && 
      //   (getUserRole() == 'editor' || getUserRole() == 'approver' || getUserRole() == 'admin');
      
      // Admin: 모든 권한 (즉시 적용)
      allow read, write: if request.auth != null && getUserRole() == 'admin';
    }
  }
}
