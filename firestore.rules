rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // 이메일/비밀번호 로그인만 허용(익명 차단)
    function isSignedInNonAnon() {
      return request.auth != null
        && request.auth.token.firebase.sign_in_provider != 'anonymous';
    }

    // 현재 사용자의 멤버 문서
    function myMemberDoc(projectId) {
      return get(/databases/$(database)/documents/projects/$(projectId)/members/$(request.auth.uid));
    }

    // 프로젝트 멤버인지
    function hasRoleInProject(projectId) {
      return isSignedInNonAnon()
        && exists(/databases/$(database)/documents/projects/$(projectId)/members/$(request.auth.uid));
    }

    // Admin인지 (문서 존재 + role 체크)
    function isAdminInProject(projectId) {
      return isSignedInNonAnon()
        && myMemberDoc(projectId).exists()
        && myMemberDoc(projectId).data.role == "admin";
    }

    // Editor인지 (참고용)
    function isEditorInProject(projectId) {
      return isSignedInNonAnon()
        && myMemberDoc(projectId).exists()
        && myMemberDoc(projectId).data.role == "editor";
    }

    // projects
    match /projects/{projectId} {

      // 멤버만 프로젝트 문서 read
      allow read: if hasRoleInProject(projectId);

      // Admin만 프로젝트 write
      allow write: if isAdminInProject(projectId);

      // members
      match /members/{uid} {

        // 본인은 자기 멤버 문서 read 가능(부트스트랩)
        // Admin은 전체 멤버 문서 read 가능
        allow read: if isSignedInNonAnon() && (
          request.auth.uid == uid ||
          isAdminInProject(projectId)
        );

        // Admin만 멤버 write
        allow write: if isAdminInProject(projectId);
      }

      // schedules
      match /schedules/{scheduleId} {

        // 멤버만 read
        allow read: if hasRoleInProject(projectId);

        // Admin만 write
        allow write: if isAdminInProject(projectId);
      }
    }

    // 레거시 차단
    match /user_roles/{document=**} {
      allow read, write: if false;
    }

    // kcolumn: docId = P1_xxx 형태
    function projectIdFromKcolumnId(docId) {
      return docId.split('_')[0];
    }

    match /kcolumn/{docId} {
      allow read: if isSignedInNonAnon() && hasRoleInProject(projectIdFromKcolumnId(docId));
      allow write: if isSignedInNonAnon() && isAdminInProject(projectIdFromKcolumnId(docId));
    }
  }
}
