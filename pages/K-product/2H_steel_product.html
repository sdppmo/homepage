<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1200, initial-scale=1.0">
    <title>K-COLUMN ê³µì •ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- jsPDF -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <!-- autoTable -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Malgun Gothic', 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            min-width: 1200px; /* ë°ìŠ¤í¬í†± ìµœì†Œ ë„ˆë¹„ ë³´ì¥ */
            color: #333;
        }

        .container {
            max-width: 1600px;
            min-width: 1200px; /* ë°ìŠ¤í¬í†± ìµœì†Œ ë„ˆë¹„ ë³´ì¥ */
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #2c4a7c, #4a6fa5);
            color: white;
            padding: 20px 30px;
            padding-left: 320px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .header-info {
            text-align: right;
            font-size: 14px;
            padding-bottom: 60px;
        }

        .home-btn {
            position: absolute;
            bottom: 20px;
            right: 30px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            z-index: 10;
        }

        .home-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        /* Company Selector */
        .company-selector {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .company-selector h3 {
            margin-bottom: 15px;
            color: #2c4a7c;
        }

        .company-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .company-btn {
            padding: 15px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            min-width: 0;
            transform: scale(0.932);
            transform-origin: center;
        }

        .company-btn.yuseok {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .company-btn.jusin {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .company-btn.jinhung {
            background: linear-gradient(135deg, #27ae60, #1e8449);
            color: white;
        }

        /* Process Buttons */
        .process-btn.p1 {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }
        .process-btn.p2 {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
        }
        .process-btn.p3 {
            background: linear-gradient(135deg, #2196f3, #1976d2);
            color: white;
        }
        .process-btn.p4 {
            background: linear-gradient(135deg, #00bcd4, #0097a7);
            color: white;
        }
        .process-btn.p5 {
            background: linear-gradient(135deg, #9c27b0, #7b1fa2); /* ì›ë˜ ë§ˆì  íƒ€ */
            color: white;
        }
        .process-btn.p6 {
            background: linear-gradient(135deg, #4caf50, #388e3c);
            color: white;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .process-btn.active {
            box-shadow: 0 0 0 4px #ffd700;
            transform: scale(1.05);
        }

        .company-btn:hover {
            transform: scale(0.932) translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .company-btn.active {
            box-shadow: 0 0 0 4px rgba(255,255,255,0.5), 0 4px 15px rgba(0,0,0,0.3);
            transform: scale(0.956);
        }

        .company-btn small {
            display: block;
            font-weight: 400;
            margin-top: 5px;
            opacity: 0.9;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-btn {
            padding: 19.382px 42.424px;
            background: white;
            border: none;
            border-radius: 8px;
            font-size: 21.5px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            color: #666;
        }

        /* ìƒë‹¨ íƒ­ ë²„íŠ¼ë§Œ 2ë‹¨ ë°°ì¹˜ (ì´ëª¨ì§€ ìœ„ / ê¸€ì ì•„ë˜) */
        .tabs > .tab-btn {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            line-height: 1.35;
            min-height: 4.5em;
        }

        .tab-btn.active {
            background: #2c4a7c;
            color: white;
        }
        .tabs .tab-btn-icon {
            width: 63px !important;
            height: 63px !important;
            min-width: 63px;
            min-height: 63px;
        }
        .tab-btn.active .tab-btn-icon {
            filter: brightness(0) invert(1);
        }
        .tab-btn.tab-btn-icon-left .tab-btn-inner {
            display: inline-flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .tab-btn.tab-btn-icon-left .tab-btn-text-2line {
            display: block;
            text-align: center;
            line-height: 1.35;
        }

        .tab-btn:hover:not(.active) {
            background: #f0f0f0;
        }
        
        /* ì¼ì¼ ì…ë ¥ ë²„íŠ¼ì€ í•­ìƒ í…Œë‘ë¦¬ ìœ ì§€ */
        .company-selector .tab-btn {
            border: 1px solid #ddd;
        }
        
        .company-selector .tab-btn.active {
            border-color: #2c4a7c;
        }
        
        .company-selector .tab-btn:not(.active) {
            border-color: #ddd;
        }

        /* Content Panels */
        .panel {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .panel.active {
            display: block;
        }

        /* ì¢Œí‘œ ì„¤ì • ëª¨ë“œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .coordinate-setup-btn {
            padding: 8px 16px;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        
        .coordinate-setup-btn.inactive {
            background: #ff9800 !important;
            background-color: #ff9800 !important;
        }
        
        .coordinate-setup-btn.active {
            background: #4caf50 !important;
            background-color: #4caf50 !important;
        }

        /* Input Panel */
        .input-section {
            margin-bottom: 20px;
        }

        .input-section h3 {
            margin-bottom: 15px;
            color: #2c4a7c;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .date-selector {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .date-selector label {
            font-weight: 600;
            color: #555;
        }

        .date-selector input[type="date"] {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        /* Column Grid */
        .column-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        .column-item {
            position: relative;
            aspect-ratio: 1;
            border: 2px solid #ddd;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            background: #f8f9fa;
            font-size: 12px;
            overflow: hidden;
        }

        .column-item:hover {
            border-color: #2c4a7c;
            transform: scale(1.05);
            z-index: 10;
        }

        .column-item .col-num {
            font-weight: 700;
            font-size: 14px;
            color: #333;
        }

        .column-item .col-status {
            font-size: 10px;
            color: #666;
            margin-top: 2px;
        }

        /* Status Colors */
        .column-item.status-0 { background: #f8f9fa; border-color: #ddd; }
        .column-item.status-1 { background: #ffebee; border-color: #e74c3c; }
        .column-item.status-2 { background: #fff3e0; border-color: #ff9800; }
        .column-item.status-3 { background: #e3f2fd; border-color: #2196f3; }
        .column-item.status-4 { background: #e0f7fa; border-color: #00bcd4; }
        .column-item.status-5 { background: #fff5ff; border-color: #9c27b0; }
        .column-item.status-6 { background: #4caf50; border-color: #2e7d32; color: white; }
        .column-item.status-6 .col-num, .column-item.status-6 .col-status { color: white; }

        /* Process Legend */
        .process-legend {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        /* Gantt Chart */
        .gantt-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        .gantt-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            min-width: 2000px;
        }

        .gantt-table th, .gantt-table td {
            border: 1px solid #ddd;
            padding: 4px;
            text-align: center;
            min-width: 30px;
        }

        .gantt-table th {
            background: #2c4a7c;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .gantt-table th.col-header {
            min-width: 80px;
            background: #1a3a5c;
        }

        .gantt-table .date-header {
            font-size: 10px;
        }

        .gantt-table .weekend {
            background: #fff3e0 !important;
        }
        
        /* í† ìš”ì¼/ì¼ìš”ì¼ ë‚ ì§œ í…ìŠ¤íŠ¸ ìƒ‰ìƒ: ì§„í•œ íŒŒë€ìƒ‰ */
        .gantt-table .date-header.weekend,
        .gantt-table .weekend.date-header {
            color: #1565c0 !important;
            font-weight: 600;
        }

        .gantt-table td.col-name {
            background: #f5f5f5;
            font-weight: 600;
            text-align: left;
            padding-left: 10px;
            position: sticky;
            left: 0;
            z-index: 5;
        }

        .gantt-cell {
            width: 100%;
            height: 20px;
            cursor: pointer;
        }

        .gantt-cell.p1 { background: #e74c3c; }
        .gantt-cell.p2 { background: #ff9800; }
        .gantt-cell.p3 { background: #2196f3; }
        .gantt-cell.p4 { background: #00bcd4; }
        .gantt-cell.p5 { background: #e1bee7; } /* ì§„í•œ ë§ˆì  íƒ€ - ë°°ì†¡ê³„íš */
        .gantt-cell.p5.confirmed { background: #9c27b0; } /* ì§™ì€ ë§ˆì  íƒ€ - ë°°ì†¡í™•ì¸ */
        .gantt-cell.p5.adjusted { background: #ff9800; } /* ì˜¤ë Œì§€ - ì¡°ì •ëœ ê³µì •í‘œ */
        .gantt-cell.p6 { background: #4caf50; }

        /* íœ´ë¬´ì¼ ìŠ¤íƒ€ì¼ */
        .gantt-table .holiday {
            background: #ffcdd2 !important;
            position: relative;
        }
        .gantt-table .holiday-header {
            background: #e53935 !important;
            color: white !important;
        }
        .holiday-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 8px;
            color: #c62828;
            white-space: nowrap;
            font-weight: bold;
        }
        
        /* ìš´ì†¡ë¬¼ëŸ‰ í…Œì´ë¸” í°íŠ¸ (PDF/í™”ë©´ ê³µí†µ â€” html2canvasê°€ ì ìš©ëœ CSS ê·¸ëŒ€ë¡œ ìº¡ì²˜) */
        #transport-volume-table-wrapper {
            font-family: 'Pretendard', 'Noto Sans KR', 'Malgun Gothic', sans-serif;
            font-size: 12px;
            line-height: 1.45;
            letter-spacing: 0.02em;
        }

        /* í…Œì´ë¸” ë ˆì´ì•„ì›ƒ ì•ˆì •í™” (PDF ìº¡ì²˜ ì‹œ ì»¬ëŸ¼ ê¹¨ì§ ë°©ì§€) */
        #transport-volume-table-wrapper table {
            table-layout: fixed;
            width: 100%;
        }

        /* í—¤ë” ê°€ë…ì„± */
        #transport-volume-table-wrapper th {
            font-weight: 600;
            text-align: center;
        }

        /* ìˆ«ì ì»¬ëŸ¼ ì •ë ¬ */
        #transport-volume-table-wrapper td:nth-child(5),
        #transport-volume-table-wrapper td:nth-child(6) {
            text-align: right;
            font-family: 'Roboto', 'Consolas', 'Malgun Gothic', sans-serif;
        }

        /* ì…€ ì—¬ë°±Â·í–‰ê°„ (ë”°ë¶™ìŒ ë°©ì§€) */
        #transport-volume-table-wrapper td,
        #transport-volume-table-wrapper th {
            padding: 6px 8px;
            line-height: 1.45;
        }

        /* ì°¨ìˆ˜ìš”ì•½ ì„¹ì…˜ (Page3 í•˜ë‹¨) ê°€ë…ì„± */
        #transport-volume-adjustment-section {
            font-family: 'Pretendard', 'Noto Sans KR', 'Malgun Gothic', sans-serif;
            line-height: 1.5;
            letter-spacing: 0.02em;
        }
        #transport-volume-adjustment-section th,
        #transport-volume-adjustment-section td {
            padding: 6px 8px;
            line-height: 1.45;
        }

        #transport-volume-table-wrapper::-webkit-scrollbar {
            display: none;
        }
        .trip-select-no-scrollbar {
            font-size: 9px;
            padding: 1px 2px;
            min-width: 52px;
        }
        .trip-select-no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Progress Summary */
        .progress-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 1200px) {
            .progress-summary {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .progress-summary {
                grid-template-columns: 1fr;
            }
        }

        .progress-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .progress-card h4 {
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .progress-card .company-badge {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            color: white;
        }

        .progress-card .company-badge.yuseok { background: #e74c3c; }
        .progress-card .company-badge.jusin { background: #3498db; }
        .progress-card .company-badge.jinhung { background: #27ae60; }

        .progress-bar-container {
            margin-bottom: 10px;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 13px;
        }

        .progress-bar {
            height: 24px;
            background: #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            border-radius: 12px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 11px;
        }

        .progress-bar-fill.p1 { background: linear-gradient(90deg, #e74c3c, #c0392b); }
        .progress-bar-fill.p2 { background: linear-gradient(90deg, #ff9800, #f57c00); }
        .progress-bar-fill.p3 { background: linear-gradient(90deg, #2196f3, #1976d2); }
        .progress-bar-fill.p4 { background: linear-gradient(90deg, #00bcd4, #0097a7); }
        .progress-bar-fill.p5 { background: linear-gradient(90deg, #fff5ff, #fef7ff); } /* ì˜…ì€ ë§ˆì  íƒ€ - ìš´ì†¡ì°¨ìˆ˜ê³„íš */
        .progress-bar-fill.p6 { background: linear-gradient(90deg, #4caf50, #388e3c); }

        /* Chart Container */
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .chart-container h3 {
            margin-bottom: 20px;
            color: #2c4a7c;
        }

        #progressChart {
            max-height: 400px;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .action-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .action-btn.primary {
            background: #2c4a7c;
            color: white;
        }

        .action-btn.secondary {
            background: #6c757d;
            color: white;
        }

        .action-btn.danger {
            background: #dc3545;
            color: white;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content h3 {
            margin-bottom: 20px;
            color: #2c4a7c;
        }

        .modal-content .form-group {
            margin-bottom: 15px;
        }
        
        /* ë‚ ì§œ ì…ë ¥ í•„ë“œ ê°•ì œ í‘œì‹œ */
        #modal-date-group {
            display: block !important;
            visibility: visible !important;
        }
        
        #modal-work-date {
            display: block !important;
            visibility: visible !important;
            width: 100% !important;
            padding: 10px !important;
            border: 2px solid #ddd !important;
            border-radius: 8px !important;
            font-size: 14px !important;
        }

        .modal-content label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .modal-content select, .modal-content input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        /* Process Selection Modal */
        .process-selection-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .process-selection-modal.active {
            display: flex;
        }

        .process-selection-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .process-selection-content h3 {
            margin-bottom: 15px;
            color: #e74c3c;
            font-size: 18px;
        }

        .process-selection-content p {
            margin-bottom: 20px;
            color: #555;
            line-height: 1.6;
        }

        .process-selection-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .process-select-btn {
            flex: 1;
            padding: 15px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
        }

        .process-select-btn.p1 {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .process-select-btn.p1:hover {
            background: linear-gradient(135deg, #c0392b, #a93226);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);
        }

        .process-select-btn.p2 {
            background: linear-gradient(135deg, #ff9800, #f57c00);
        }

        .process-select-btn.p2:hover {
            background: linear-gradient(135deg, #f57c00, #e65100);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4);
        }

        .process-select-btn.cancel {
            background: #6c757d;
            color: white;
        }

        .process-select-btn.cancel:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .column-grid {
                grid-template-columns: repeat(5, 1fr);
            }
            
            .company-buttons {
                flex-direction: column;
            }
            
            .company-btn {
                min-width: 100%;
            }
        }
        
        /* í† ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ (ì•¡ì…˜ ë²„íŠ¼ í¬í•¨) */
        #toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.85);
            color: #fff;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 14px;
            opacity: 0;
            pointer-events: none;
            transition: opacity .25s ease;
            z-index: 9999;
            display: flex;
            gap: 10px;
            align-items: center;
            max-width: 90vw;
        }
        #toast.show {
            opacity: 1;
            pointer-events: auto;
        }
        #toast-action {
            border: 1px solid rgba(255,255,255,0.5);
            background: transparent;
            color: #fff;
            border-radius: 6px;
            padding: 6px 10px;
            cursor: pointer;
            white-space: nowrap;
        }
        #toast-action:hover {
            border-color: #fff;
        }
        #toast-msg {
            word-break: keep-all;
        }

        /* í™”ë©´ì—ì„œëŠ” ìˆ¨ê¹€, ì¸ì‡„ ì‹œì—ë§Œ í˜ì´ì§€ ë°˜ë³µ í—¤ë”ë¡œ ì‚¬ìš© */
        .print-header {
            display: none;
        }
        @media print {
            .print-header {
                display: block !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                z-index: 9999;
                background: #fff !important;
                padding: 8px 12px;
                border-bottom: 1px solid #ddd;
                font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif;
                color: #000;
                box-sizing: border-box;
                height: 52px;
            }
            body {
                margin-top: 52px !important;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- ============================================================
         PROJECT_ID ì •ì˜ (ìµœìƒë‹¨ - ëª¨ë“  ìŠ¤í¬ë¦½íŠ¸ë³´ë‹¤ ë¨¼ì € ì‹¤í–‰)
         URL íŒŒë¼ë¯¸í„°ì—ì„œ ê°€ì ¸ì˜¤ê¸° - ê°€ì¥ ìƒë‹¨ì— 1ë²ˆë§Œ ì„ ì–¸
         ì „ì—­ ìƒìˆ˜ë¡œ ì •ì˜í•˜ì—¬ ëª¨ë“  ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ í•¨
         ============================================================ -->
    <script>
        // ============================================================
        // âœ… [1ë‹¨ê³„] PROJECT_ID ë‹¨ì¼ ì†ŒìŠ¤ ì„ ì–¸ (ê°€ì¥ ìƒë‹¨ - ì²« ë²ˆì§¸ <script>)
        // 
        // âš ï¸ ì¤‘ìš”: ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” ë°˜ë“œì‹œ ë¬¸ë²• ì—ëŸ¬ ì—†ì´ ê°€ì¥ ë¨¼ì € ì‹¤í–‰ë˜ì–´ì•¼ í•¨
        // urlParams ë³€ìˆ˜ë¥¼ ë‹¤ë¥¸ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì¬ì‚¬ìš©í•˜ì§€ ë§ ê²ƒ
        // 
        // âš ï¸ ê¸ˆì§€: const PROJECT_IDë¡œ ì—¬ëŸ¬ ë²ˆ ì„ ì–¸í•˜ë©´ ì—ëŸ¬ ë°œìƒ
        // âœ… ì •ë‹µ: window.PROJECT_IDë§Œ ì‚¬ìš© (ì „ì—­ ë³€ìˆ˜)
        // ============================================================
        (function() {
            const urlParams = new URLSearchParams(location.search);
            // âœ… window.PROJECT_IDë§Œ ì‚¬ìš© (const PROJECT_ID ì„ ì–¸ ê¸ˆì§€)
            window.PROJECT_ID = (urlParams.get("project") || localStorage.getItem("kcol:lastProject") || "P1").toString();
            localStorage.setItem("kcol:lastProject", window.PROJECT_ID);
            console.log("[PROJECT_ID]", window.PROJECT_ID);
        })();
        
        // âœ… TDZ ë°©ì§€: ì „ì—­ 1íšŒ ì„ ì–¸ (var ì¶”ì²œ)
        // í˜¹ì‹œ ì„ ì–¸ ìˆœì„œê°€ ë˜ ê¼¬ì—¬ë„ typeof currentProcessê°€ ì ˆëŒ€ í„°ì§€ì§€ ì•Šê²Œ í•˜ê¸° ìœ„í•¨
        var currentProcess = null;
        
        // =====================================================
        // âœ… ìµœì¢… í†µí•©ë³¸: ë¡œê·¸ì¸ ì‹œ ì†Œì‹¤ ë°©ì§€ + ì¤‘ë³µ ì €ì¥ ë£¨í”„ ì°¨ë‹¨
        // (1) ì´ˆê¸° ë¡œë”© ì €ì¥ ì°¨ë‹¨ (isInitialLoad)
        // (2) ë¹ˆ ê°ì²´ í•„ë“œ ì œê±° (omitEmptyObjects)
        // (3) safePayload ë¹„ë©´ ì €ì¥ ì•ˆ í•¨
        // (4) merge:true ì €ì¥
        // (+) onSnapshot ì›ê²© ë°˜ì˜ ì¤‘ ì €ì¥ ì°¨ë‹¨ (isApplyingRemoteData)
        // =====================================================
        
        // ì „ì—­/ìƒë‹¨
        let projectRef = null;
        let realtimeUnsubscribe = null;
        
        let isInitialLoad = true;          // â‘  ì²« ìŠ¤ëƒ…ìƒ· ì „ ì €ì¥ ê¸ˆì§€
        let isApplyingRemoteData = false;  // + ì›ê²© ë°˜ì˜ ì¤‘ ì €ì¥ ê¸ˆì§€(ë£¨í”„ ì°¨ë‹¨)
    </script>
    
    <script>
        // ============================================================
        // âœ… [2ë‹¨ê³„] ì´ˆê¸° UI ì ê¸ˆ (PROJECT_ID ì„ ì–¸ ë°”ë¡œ ë‹¤ìŒ)
        // 
        // âš ï¸ ì¤‘ìš”: ë¡œë”© ì‹œì‘ë¶€í„° admin íŒ¨ë„ì´ ë³´ì´ë©´ ì•ˆ ë¨
        // ì´ˆê¸° UIëŠ” ë¬´ì¡°ê±´ viewer ì ê¸ˆ ìƒíƒœë¡œ ì‹œì‘
        // ============================================================
        window.userRole = "viewer";
        window.allowedProcesses = [];
        
        // DOMContentLoaded ì „ì—ë„ ì‹¤í–‰ ê°€ëŠ¥í•˜ë„ë¡ ì¦‰ì‹œ ì‹¤í–‰
        (function() {
            // applyRoleBasedUIëŠ” ë‚˜ì¤‘ì— ì •ì˜ë˜ë¯€ë¡œ, ì—¬ê¸°ì„œëŠ” ê¸°ë³¸ ì ê¸ˆë§Œ ìˆ˜í–‰
            // ì‹¤ì œ applyRoleBasedUIëŠ” ë‚˜ì¤‘ì— í˜¸ì¶œë¨
            console.log("[INIT] ì´ˆê¸° UI ì ê¸ˆ: viewer");
        })();
    </script>
</head>
<body>
    <!-- ì¸ì‡„ ì‹œ ëª¨ë“  í˜ì´ì§€ ìƒë‹¨ ë°˜ë³µ (position:fixed â†’ @media print). Puppeteer ì‚¬ìš© ì‹œ pdf({ displayHeaderFooter: true, headerTemplate: '...' }) ë¡œ í•˜ë©´ ë” í™•ì‹¤í•¨ -->
    <div id="print-header" class="print-header">
        <div style="font-size:16px;font-weight:bold;margin-bottom:4px;">K-COLUMN ê³µì •ê´€ë¦¬ ì‹œìŠ¤í…œ</div>
        <div style="font-size:11px;margin-bottom:2px;">K-COLUMN 100ê°œ (ìƒë¶€ 50)+(í•˜ë¶€ 50) ì œì‘ ë° ì„¤ì¹˜ ê³µì •</div>
        <div style="font-size:10px;">ìë£Œí˜‘ì¡° : (ì£¼) ì§€ë•ì´ì—”ì§€ / (ì£¼) ìœ ì„ì² ê°•ì‚°ì—… / (ì£¼) ì£¼ì‹ ì‚°ì—…</div>
    </div>
    <!-- í† ìŠ¤íŠ¸ ë©”ì‹œì§€ (ì•¡ì…˜ ë²„íŠ¼ í¬í•¨) -->
    <div id="toast" role="status" aria-live="polite">
        <span id="toast-msg"></span>
        <button id="toast-action" type="button" style="display:none;">ê¶Œí•œ ìš”ì²­</button>
    </div>
    
    <div class="container">
        <!-- Header -->
        <!-- ë¡œê·¸ì¸ ëª¨ë‹¬ (í˜ì´ì§€ ì ‘ê·¼ ì‹œ í‘œì‹œ) -->
        <!-- ë¡œê·¸ì¸ ëª¨ë‹¬ (í˜ì´ì§€ ì ‘ê·¼ ì‹œ í‘œì‹œ) -->
        <div id="login-modal" style="display:flex;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:10000;flex-direction:column;align-items:center;justify-content:center;">
            <div style="background:linear-gradient(135deg, #2c4a7c, #4a6fa5);padding:40px;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.3);max-width:400px;width:90%;">
                <h2 style="margin:0 0 20px 0;color:white;font-size:24px;text-align:center;">ğŸ” ë¡œê·¸ì¸ í•„ìš”</h2>
                <p style="margin:0 0 30px 0;color:rgba(255,255,255,0.9);text-align:center;font-size:13.58px;">
                    ê³µì •í‘œì— ì ‘ê·¼í•˜ë ¤ë©´ Firebase ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.<br>
                    <span style="font-size:12px;color:rgba(255,255,255,0.8);">Email/Passwordë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”.</span>
                </p>
                <div style="display:flex;flex-direction:column;gap:15px;">
                    <input type="email" id="modal-login-email" placeholder="ì´ë©”ì¼" 
                           style="padding:12px;border:2px solid #ddd;border-radius:6px;font-size:14px;" autocomplete="email">
                    <div style="position:relative;">
                        <input type="password" id="modal-login-password" placeholder="ë¹„ë°€ë²ˆí˜¸" 
                               style="padding:12px;padding-right:45px;border:2px solid #ddd;border-radius:6px;font-size:14px;width:100%;box-sizing:border-box;" autocomplete="current-password">
                        <button type="button" id="modal-login-password-toggle" 
                                onclick="togglePasswordVisibility('modal-login-password', 'modal-login-password-toggle')"
                                style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;font-size:18px;padding:4px 8px;color:#666;transition:color 0.2s;"
                                onmouseover="this.style.color='#2196f3';" onmouseout="this.style.color='#666';"
                                title="ë¹„ë°€ë²ˆí˜¸ ë³´ê¸°/ìˆ¨ê¸°ê¸°">
                            ğŸ‘ï¸
                        </button>
                    </div>
                    <button id="modal-login-btn" 
                            style="padding:12px;background:#2c4a7c;color:white;border:none;border-radius:6px;font-size:16px;font-weight:600;cursor:pointer;transition:background 0.3s;">
                        ë¡œê·¸ì¸
                    </button>
                </div>
                <div id="modal-login-status" style="margin-top:15px;font-size:12px;text-align:center;color:#f44336;min-height:20px;"></div>
                <div style="margin-top:20px;padding-top:20px;border-top:1px solid #eee;font-size:11px;color:#999;text-align:center;">
                    â„¹ï¸ ë¡œê·¸ì¸ í›„ ì—­í• (Admin/Editor/Viewer)ì— ë”°ë¼ ê¶Œí•œì´ ë¶€ì—¬ë©ë‹ˆë‹¤.
                </div>
            </div>
        </div>

        <div class="header" style="position: relative;">
            <img src="../../assets/images/songdo_logo_transparent.png" alt="ì†¡ë„íŒŒíŠ¸ë„ˆìŠ¤í”¼ì— ì˜¤" style="position: absolute; top: 20px; left: 20px; height: 45.6192px; width: auto; z-index: 5;">
            <a href="../../index.html" class="home-btn">
                <span>ğŸ </span>
                <span>í™ˆìœ¼ë¡œ</span>
            </a>
            <div>
                <h1>ğŸ—ï¸ K-COLUMN ê³µì •ê´€ë¦¬ ì‹œìŠ¤í…œ <span id="project-badge" style="margin-left:10px;font-size:12px;font-weight:800;background:rgba(255,255,255,0.18);padding:6px 10px;border-radius:999px;">PROJECT</span></h1>
                <p style="margin-top:5px;opacity:0.9;">K-COLUMN 100ê°œ (ìƒë¶€ 50)+(í•˜ë¶€ 50) ì œì‘ ë° ì„¤ì¹˜ ê³µì •</p>
                <p style="margin-top:5px;opacity:0.9;font-size:13px;">ìë£Œí˜‘ì¡° : (ì£¼) ì§€ë•ì´ì—”ì§€ / (ì£¼) ìœ ì„ì² ê°•ì‚°ì—… / (ì£¼) ì£¼ì‹ ì‚°ì—…</p>
            </div>
            <div class="header-info">
                <div>ê³µì‚¬ê¸°ê°„: 2025.12.26 ~ 2026.04.30</div>
                <div style="margin-top:5px;">ì´ ê¸°ë‘¥ìˆ˜: <strong>50ê°œ</strong></div>
                <div style="margin-top:10px;padding:8px;background:rgba(255,255,255,0.1);border-radius:6px;font-size:12px;">
                    <!-- Firebase ë¡œê·¸ì¸ -->
                    <div style="margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid rgba(255,255,255,0.2);">
                        <div id="login-section" style="display:flex;align-items:center;gap:6px;">
                            <input type="email" id="login-email-input" placeholder="ì´ë©”ì¼" 
                                   style="flex:1;padding:6px 10px;border:1px solid rgba(255,255,255,0.3);border-radius:4px;background:rgba(255,255,255,0.9);color:#333;font-size:11px;">
                            <input type="password" id="login-password-input" placeholder="ë¹„ë°€ë²ˆí˜¸" 
                                   style="flex:1;padding:6px 10px;border:1px solid rgba(255,255,255,0.3);border-radius:4px;background:rgba(255,255,255,0.9);color:#333;font-size:11px;">
                            <button id="login-btn"
                                    style="padding:6px 12px;background:#4caf50;border:none;border-radius:4px;color:white;cursor:pointer;font-size:11px;font-weight:600;white-space:nowrap;">
                                ë¡œê·¸ì¸
                            </button>
                            <button id="logout-btn" style="display:none;padding:6px 12px;background:#f44336;border:none;border-radius:4px;color:white;cursor:pointer;font-size:11px;font-weight:600;white-space:nowrap;">
                                ë¡œê·¸ì•„ì›ƒ
                            </button>
                            <!-- ê°œë°œììš© ìºì‹œ ì´ˆê¸°í™” ë²„íŠ¼ (ê°œë°œ í™˜ê²½ì—ì„œë§Œ í‘œì‹œ) -->
                            <button id="clear-cache-btn" onclick="clearAppCache()" style="display:none;padding:6px 12px;background:#9e9e9e;border:none;border-radius:4px;color:white;cursor:pointer;font-size:11px;font-weight:600;white-space:nowrap;margin-left:8px;" title="Firebase ìºì‹œ ë° ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì´ˆê¸°í™”">
                                ğŸ—‘ï¸ ìºì‹œ ì´ˆê¸°í™”
                            </button>
                        </div>
                        <div id="login-status" style="margin-top:4px;font-size:10px;opacity:0.8;"></div>
                        <div id="user-info" style="margin-top:4px;font-size:10px;opacity:0.9;display:none;">
                            <div>ë¡œê·¸ì¸: <span id="user-email"></span></div>
                            <div>ì—­í• : <span id="user-role-badge"></span></div>
                        </div>
                    </div>
                    
                    <!-- ============================================================
                         Project Admin ì„¤ì • ì˜ì—­ (í”„ë¡œì íŠ¸ ê´€ë¦¬ìë§Œ ë³¼ ìˆ˜ ìˆìŒ)
                         
                         âš ï¸ ì¤‘ìš”: Portal Admin â‰  Project Admin
                         - Portal Admin: í¬í„¸ ì „ì²´ ìš´ì˜ ê¶Œí•œ (portal_members/{uid}.portalRole)
                         - Project Admin: í”„ë¡œì íŠ¸ ë‚´ë¶€ ê¶Œí•œ (projects/{projectId}/members/{uid}.role)
                         
                         ì´ íŒ¨ë„ì€ ì˜¤ì§ projects/{projectId}/members/{uid}.role === "admin" ì¼ ë•Œë§Œ í‘œì‹œë©ë‹ˆë‹¤.
                         email, portalRole, localStorage ê°’ìœ¼ë¡œëŠ” ì ˆëŒ€ íŒë‹¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                         ============================================================ -->
                    <!-- ë¡œë”© UI (ê¶Œí•œ í™•ì¸ ì¤‘) -->
                    <div id="auth-loading" style="display:none;padding:12px;text-align:center;background:#f5f5f5;border-radius:6px;margin-bottom:12px;">
                        <span style="color:#666;">â³ ê¶Œí•œ í™•ì¸ ì¤‘...</span>
                    </div>
                    
                    <div id="admin-panel" style="display:none;">
                        <!-- Admin ì„¤ì • -->
                        <div style="margin-bottom:8px;">
                            <div style="display:flex;align-items:center;gap:6px;">
                                <input type="text" id="admin-uid-input" placeholder="Admin UID ì…ë ¥" 
                                       style="flex:1;padding:6px 10px;border:1px solid rgba(255,255,255,0.3);border-radius:4px;background:rgba(255,255,255,0.9);color:#333;font-size:11px;">
                                <button id="admin-setup-btn"
                                        style="padding:6px 12px;background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.3);border-radius:4px;color:white;cursor:pointer;font-size:11px;font-weight:600;white-space:nowrap;">
                                    Admin ì„¤ì •
                                </button>
                            </div>
                            <div id="admin-uid-status" style="margin-top:4px;font-size:10px;opacity:0.8;"></div>
                        </div>
                        
                        <!-- Editor ì„¤ì • -->
                        <div style="padding-top:8px;border-top:1px solid rgba(255,255,255,0.2);">
                            <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;">
                                <input type="text" id="editor-uid-input" placeholder="Editor UID ì…ë ¥" 
                                       style="flex:1;padding:6px 10px;border:1px solid rgba(255,255,255,0.3);border-radius:4px;background:rgba(255,255,255,0.9);color:#333;font-size:11px;">
                                <button id="editor-setup-btn"
                                        style="padding:6px 12px;background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.3);border-radius:4px;color:white;cursor:pointer;font-size:11px;font-weight:600;white-space:nowrap;">
                                    Editor ì„¤ì •
                                </button>
                            </div>
                            <div style="margin-bottom:6px;font-size:10px;color:rgba(255,255,255,0.9);">
                                í—ˆìš©í•  ê³µì • ì„ íƒ:
                            </div>
                            <div id="editor-process-select" style="display:grid;grid-template-columns:repeat(3,1fr);gap:4px;margin-bottom:6px;">
                                <label style="display:flex;align-items:center;gap:4px;font-size:10px;color:rgba(255,255,255,0.9);cursor:pointer;">
                                    <input type="checkbox" value="1" class="editor-process-checkbox" style="margin:0;">
                                    <span>1. ì£¼ê¸°ë‘¥ì»¤íŒ…</span>
                                </label>
                                <label style="display:flex;align-items:center;gap:4px;font-size:10px;color:rgba(255,255,255,0.9);cursor:pointer;">
                                    <input type="checkbox" value="2" class="editor-process-checkbox" style="margin:0;">
                                    <span>2. ì†Œë¶€ì¬ì»¤íŒ…</span>
                                </label>
                                <label style="display:flex;align-items:center;gap:4px;font-size:10px;color:rgba(255,255,255,0.9);cursor:pointer;">
                                    <input type="checkbox" value="3" class="editor-process-checkbox" style="margin:0;">
                                    <span>3. ì£¼ê¸°ë‘¥ì¡°ë¦½</span>
                                </label>
                                <label style="display:flex;align-items:center;gap:4px;font-size:10px;color:rgba(255,255,255,0.9);cursor:pointer;">
                                    <input type="checkbox" value="4" class="editor-process-checkbox" style="margin:0;">
                                    <span>4. ì†Œë¶€ì¬ì¡°ë¦½</span>
                                </label>
                                <label style="display:flex;align-items:center;gap:4px;font-size:10px;color:rgba(255,255,255,0.9);cursor:pointer;">
                                    <input type="checkbox" value="5" class="editor-process-checkbox" style="margin:0;">
                                    <span>5. í˜„ì¥ë°°ì†¡</span>
                                </label>
                                <label style="display:flex;align-items:center;gap:4px;font-size:10px;color:rgba(255,255,255,0.9);cursor:pointer;">
                                    <input type="checkbox" value="6" class="editor-process-checkbox" style="margin:0;">
                                    <span>6. í˜„ì¥ì„¤ì¹˜</span>
                                </label>
                            </div>
                            <div id="editor-uid-status" style="margin-top:4px;font-size:10px;opacity:0.8;"></div>
                        </div>
                        
                        <!-- Viewer ì„¤ì • -->
                        <div style="padding-top:8px;border-top:1px solid rgba(255,255,255,0.2);">
                            <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;">
                                <input type="text" id="viewer-uid-input" placeholder="Viewer UID ì…ë ¥ (ì—¬ëŸ¬ ê°œëŠ” ì‰¼í‘œë¡œ êµ¬ë¶„)" 
                                       style="flex:1;padding:6px 10px;border:1px solid rgba(255,255,255,0.3);border-radius:4px;background:rgba(255,255,255,0.9);color:#333;font-size:11px;">
                                <button id="viewer-setup-btn"
                                        style="padding:6px 12px;background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.3);border-radius:4px;color:white;cursor:pointer;font-size:11px;font-weight:600;white-space:nowrap;">
                                    Viewer ì„¤ì •
                                </button>
                            </div>
                            <div style="margin-top:4px;font-size:10px;color:rgba(255,255,255,0.8);">
                                â„¹ï¸ ViewerëŠ” ì½ê¸° ì „ìš© ê¶Œí•œì…ë‹ˆë‹¤. ì—¬ëŸ¬ UIDëŠ” ì‰¼í‘œ(,)ë¡œ êµ¬ë¶„í•˜ì„¸ìš”.
                            </div>
                            <div id="viewer-uid-status" style="margin-top:4px;font-size:10px;opacity:0.8;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" onclick="showPanel('overview', this)">ğŸ“Š<br>ì „ì²´<br>í˜„í™©</button>
            <button class="tab-btn tab-btn-icon-left" onclick="showPanel('transport', this)"><span class="tab-btn-inner"><img src="../../assets/images/favicon-ìš´ì†¡ì°¨ìˆ˜ê³„íš.png" alt="" class="tab-btn-icon" style="width:63px;height:63px;object-fit:contain;flex-shrink:0;"><span class="tab-btn-text-2line">ìš´ì†¡ì°¨ìˆ˜<br>ê³„íš</span></span></button>
            <button class="tab-btn" onclick="showPanel('gantt', this)">ğŸ“…<br>ê³µì •í‘œ (Gantt)</button>
            <button class="tab-btn tab-btn-icon-left" onclick="showPanel('transportVolume', this)"><span class="tab-btn-inner"><img src="../../assets/images/favicon-ìš´ì†¡ë¬¼ëŸ‰ì‚°ì •.png" alt="" class="tab-btn-icon" style="width:63px;height:63px;object-fit:contain;flex-shrink:0;"><span class="tab-btn-text-2line">ìš´ì†¡ì°¨ìˆ˜ì¡°ì •<br>ê³„íš</span></span></button>
            <button class="tab-btn" onclick="showPanel('chart', this)">ğŸ“ˆ<br>ì§„í–‰ë¥ <br>ì°¨íŠ¸</button>
            <button class="tab-btn" onclick="showPanel('installation', this)">ğŸ—ï¸<br>í˜„ì¥ì„¤ì¹˜<br>í˜„í™©ë„</button>
            <button class="tab-btn" onclick="showPanel('transportVolumePdf', this)">ğŸ“„<br>PDF<br>ì¶œë ¥</button>
        </div>

        <!-- Company Selector -->
        <div class="company-selector">
            <div class="company-buttons" style="display:grid;grid-template-columns:auto repeat(6,1fr);gap:8px;align-items:center;">
                    <button class="tab-btn active" onclick="showPanel('input', this)" style="margin:0;">âœï¸ ì¼ì¼ ì…ë ¥</button>
                <button class="company-btn process-btn p1" data-process="1" onclick="onCurrentProcessReady(1); selectPreocess(1); showPanel('input', null);">
                    1. ì£¼ê¸°ë‘¥ì»¤íŒ…
                    <small>ìœ ì„ì² ê°•(ì¶©ì£¼ê³µì¥)</small>
                </button>
                <button class="company-btn process-btn p2" data-process="2" onclick="onCurrentProcessReady(2); selectPreocess(2); showPanel('input', null);">
                    2. ì†Œë¶€ì¬ì»¤íŒ…
                    <small>ìœ ì„ì² ê°•(ì˜¤ì°½ê³µì¥)</small>
                </button>
                <button class="company-btn process-btn p3" data-process="3" onclick="onCurrentProcessReady(3); selectPreocess(3); showPanel('input', null);">
                    3. ì£¼ê¸°ë‘¥ì¡°ë¦½
                    <small>ìœ ì„ì² ê°•(ìŒì„±ê³µì¥)</small>
                </button>
                <button class="company-btn process-btn p4" data-process="4" onclick="onCurrentProcessReady(4); selectPreocess(4); showPanel('input', null);">
                    4. ì†Œë¶€ì¬ì¡°ë¦½
                    <small>ìœ ì„ì² ê°•(ìŒì„±ê³µì¥)</small>
                </button>
                <button class="company-btn process-btn p5" data-process="5" onclick="onCurrentProcessReady(5); selectPreocess(5); showPanel('input', null);">
                    5. í˜„ì¥ë°°ì†¡
                    <small>ìœ ì„ì² ê°•(ìŒì„±ê³µì¥)</small>
                </button>
                <button class="company-btn process-btn p6" data-process="6" onclick="onCurrentProcessReady(6); selectPreocess(6); showPanel('input', null);">
                    6. í˜„ì¥ì„¤ì¹˜
                    <small>ì§„í¥ê¸°ì—…</small>
                </button>
            </div>
        </div>

        <!-- Overview Panel -->
        <div class="panel active" id="panel-overview">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h3 style="margin:0;color:#2c4a7c;">ğŸ“Š ì „ì²´ ê³µì • í˜„í™©</h3>
                <button id="reset-all-data-btn" class="action-btn" onclick="resetAllData()" data-role-visible="admin" style="background:#f44336;color:white;padding:8px 16px;border:none;border-radius:6px;cursor:pointer;font-weight:600;">
                    ğŸ”„ ì „ì²´ ì´ˆê¸°í™”
                </button>
            </div>
            
            <!-- Progress Summary -->
            <div class="progress-summary">
                <div class="progress-card">
                    <h4>
                        <span>1. ì£¼ê¸°ë‘¥ì»¤íŒ…</span>
                        <span class="company-badge yuseok">ìœ ì„ì² ê°•(ì¶©ì£¼ê³µì¥)</span>
                    </h4>
                    <div class="progress-bar-container">
                        <div class="progress-label">
                            <span>ì™„ë£Œ</span>
                            <span id="progress-p1-text">0 / 100</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-bar-fill p1" id="progress-p1" style="width:0%">0%</div>
                        </div>
                    </div>
                </div>

                <div class="progress-card">
                    <h4>
                        <span>2. ì†Œë¶€ì¬ì»¤íŒ…</span>
                        <span class="company-badge yuseok">ìœ ì„ì² ê°•(ì˜¤ì°½ê³µì¥)</span>
                    </h4>
                    <div class="progress-bar-container">
                        <div class="progress-label">
                            <span>ì™„ë£Œ</span>
                            <span id="progress-p2-text">0 / 100</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-bar-fill p2" id="progress-p2" style="width:0%">0%</div>
                        </div>
                    </div>
                </div>

                <div class="progress-card">
                    <h4>
                        <span>3. ì£¼ê¸°ë‘¥ì¡°ë¦½</span>
                        <span class="company-badge yuseok">ìœ ì„ì² ê°•(ìŒì„±ê³µì¥)</span>
                    </h4>
                    <div class="progress-bar-container">
                        <div class="progress-label">
                            <span>ì™„ë£Œ</span>
                            <span id="progress-p3-text">0 / 100</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-bar-fill p3" id="progress-p3" style="width:0%">0%</div>
                        </div>
                    </div>
                </div>

                <div class="progress-card">
                    <h4>
                        <span>4. ì†Œë¶€ì¬ì¡°ë¦½</span>
                        <span class="company-badge yuseok">ìœ ì„ì² ê°•(ìŒì„±ê³µì¥)</span>
                    </h4>
                    <div class="progress-bar-container">
                        <div class="progress-label">
                            <span>ì™„ë£Œ</span>
                            <span id="progress-p4-text">0 / 100</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-bar-fill p4" id="progress-p4" style="width:0%">0%</div>
                        </div>
                    </div>
                </div>

                <div class="progress-card">
                    <h4>
                        <span>5. í˜„ì¥ë°°ì†¡</span>
                        <span class="company-badge yuseok">ìœ ì„ì² ê°•(ìŒì„±ê³µì¥)</span>
                    </h4>
                    <div class="progress-bar-container">
                        <div class="progress-label">
                            <span>ì™„ë£Œ</span>
                            <span id="progress-p5-text">0 / 100</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-bar-fill p5" id="progress-p5" style="width:0%">0%</div>
                        </div>
                    </div>
                </div>

                <div class="progress-card">
                    <h4>
                        <span>6. í˜„ì¥ì„¤ì¹˜</span>
                        <span class="company-badge jinhung">ì§„í¥ê¸°ì—…</span>
                    </h4>
                    <div class="progress-bar-container">
                        <div class="progress-label">
                            <span>ì™„ë£Œ</span>
                            <span id="progress-p6-text">0 / 100</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-bar-fill p6" id="progress-p6" style="width:0%">0%</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Column Status Grid -->
            <h3 style="margin:20px 0 15px;color:#2c4a7c;">ğŸ”© ê¸°ë‘¥ë³„ í˜„ì¬ ê³µì • ìƒíƒœ</h3>
            <div class="process-legend">
                <div class="legend-item"><div class="legend-color" style="background:#f8f9fa;"></div><span>ë¯¸ì°©ìˆ˜</span></div>
                <div class="legend-item"><div class="legend-color" style="background:#ffebee;"></div><span>1.ì£¼ê¸°ë‘¥ì»¤íŒ…</span></div>
                <div class="legend-item"><div class="legend-color" style="background:#fff3e0;"></div><span>2.ì†Œë¶€ì¬ì»¤íŒ…</span></div>
                <div class="legend-item"><div class="legend-color" style="background:#e3f2fd;"></div><span>3.ì£¼ê¸°ë‘¥ì¡°ë¦½</span></div>
                <div class="legend-item"><div class="legend-color" style="background:#e0f7fa;"></div><span>4.ì†Œë¶€ì¬ì¡°ë¦½</span></div>
                <div class="legend-item"><div class="legend-color" style="background:#fff5ff;"></div><span>5.í˜„ì¥ë°°ì†¡</span></div>
                <div class="legend-item"><div class="legend-color" style="background:#4caf50;"></div><span>6.ì„¤ì¹˜ì™„ë£Œ</span></div>
            </div>
            <div class="column-grid" id="column-grid-overview">
                <!-- Generated by JS -->
            </div>
        </div>

        <!-- Input Panel -->
        <div class="panel" id="panel-input">
            <div class="input-section">
                <h3>âœï¸ ì¼ì¼ ê³µì • ì…ë ¥ <span id="selected-company-name" style="color:#666;font-weight:400;font-size:14px;"></span></h3>
                
                <!-- ê³µì •ë³„ ì…ë ¥ ì•ˆë‚´ -->
                <div id="process-guide" style="margin-bottom:20px;padding:15px;background:#f5f5f5;border-radius:8px;border-left:4px solid #2196f3;"></div>
                
                <!-- ì—‘ì…€ ì¼ê´„ ì—…ë¡œë“œ ì„¹ì…˜ (ê³µì • 1-6) -->
                <div id="process-excel-upload" style="margin-bottom:20px;padding:20px;background:#e3f2fd;border-radius:8px;border:2px solid #2196f3;box-shadow:0 2px 8px rgba(33,150,243,0.2);">
                    <div style="margin-bottom:12px;font-weight:700;color:#2c4a7c;font-size:16px;">ğŸ“Š ì—‘ì…€ ì¼ê´„ ì—…ë¡œë“œ (ê³µì • 1-6)</div>
                    <div style="margin-bottom:15px;padding:10px;background:rgba(255,255,255,0.7);border-radius:6px;font-size:13px;color:#555;line-height:1.6;overflow:hidden;">
                        ì—‘ì…€ íŒŒì¼ë¡œ ëª¨ë“  ê³µì •(ì£¼ê¸°ë‘¥ì»¤íŒ…, ì†Œë¶€ì¬ì»¤íŒ…, ì£¼ê¸°ë‘¥ì¡°ë¦½, ì†Œë¶€ì¬ì¡°ë¦½, í˜„ì¥ë°°ì†¡, í˜„ì¥ì„¤ì¹˜)ì„ í•œêº¼ë²ˆì— ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                        <strong style="color:#2c4a7c;">ì—‘ì…€ í˜•ì‹:</strong> ì²« í–‰ì— <strong style="color:#d32f2f;">ê¸°ë‘¥ë²ˆí˜¸, ê¸°ë‘¥ì´ë¦„, ì£¼ê¸°ë‘¥ì»¤íŒ…ë‚ ì§œ, ì†Œë¶€ì¬ì»¤íŒ…ë‚ ì§œ, ì£¼ê¸°ë‘¥ì¡°ë¦½ë‚ ì§œ, ì†Œë¶€ì¬ì¡°ë¦½ë‚ ì§œ, í˜„ì¥ë°°ì†¡ë‚ ì§œ, í˜„ì¥ì„¤ì¹˜ë‚ ì§œ</strong> í—¤ë”ë¥¼ ë„£ì–´ì£¼ì„¸ìš”.<br>
                        <strong style="color:#2c4a7c;">íŒŒì¼ í™•ì¥ì:</strong> <strong style="color:#d32f2f;">*.xlsx</strong> (ì—‘ì…€ 2007 ì´ìƒ í˜•ì‹)<br>
                        <span style="color:#666;font-size:12px;">â€» ê¸°ë‘¥ë²ˆí˜¸ í˜•ì‹: 1C001, 1C002, 43TC001 ë“± (C ë˜ëŠ” TC í¬í•¨)<br>
                        â€» ê¸°ë‘¥ì´ë¦„ì´ ì—†ìœ¼ë©´ ê¸°ë‘¥ë²ˆí˜¸ë¥¼ ê¸°ë‘¥ì´ë¦„ìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.<br>
                        â€» ë‚ ì§œê°€ ì—†ëŠ” ê³µì •ì€ ë¹ˆ ì…€ë¡œ ë‘ë©´ ë©ë‹ˆë‹¤.</span>
                    </div>
                    <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;padding-top:10px;border-top:1px solid rgba(33,150,243,0.3);">
                        <input type="file" accept=".xlsx,.xls,.csv" id="process-excel-file" onchange="handleProcessExcelFile(event)" style="padding:10px 15px;border:2px solid #2196f3;border-radius:6px;background:white;font-size:14px;cursor:pointer;min-width:200px;" title="ì—‘ì…€ íŒŒì¼ ì„ íƒ (*.xlsx)">
                        <div style="display:flex;gap:8px;flex-wrap:wrap;">
                            <button class="action-btn primary" onclick="downloadAllProcessTemplate()" style="padding:8px 16px;font-size:13px;font-weight:600;background:#2c4a7c;color:white;">ğŸ“„ í†µí•©í…œí”Œë¦¿ (1-6)</button>
                            <button class="action-btn" onclick="downloadProcessTemplate(1)" style="padding:8px 16px;font-size:13px;background:#e74c3c;color:white;">ğŸ“„ ì£¼ê¸°ë‘¥ì»¤íŒ…</button>
                            <button class="action-btn" onclick="downloadProcessTemplate(2)" style="padding:8px 16px;font-size:13px;background:#ff9800;color:white;">ğŸ“„ ì†Œë¶€ì¬ì»¤íŒ…</button>
                            <button class="action-btn" onclick="downloadProcessTemplate(3)" style="padding:8px 16px;font-size:13px;background:#2196f3;color:white;">ğŸ“„ ì£¼ê¸°ë‘¥ì¡°ë¦½</button>
                            <button class="action-btn" onclick="downloadProcessTemplate(4)" style="padding:8px 16px;font-size:13px;background:#00bcd4;color:white;">ğŸ“„ ì†Œë¶€ì¬ì¡°ë¦½</button>
                            <button class="action-btn" onclick="downloadProcessTemplate(5)" style="padding:8px 16px;font-size:13px;background:#9c27b0;color:white;">ğŸ“„ í˜„ì¥ë°°ì†¡</button>
                            <button class="action-btn" onclick="downloadProcessTemplate(6)" style="padding:8px 16px;font-size:13px;background:#4caf50;color:white;">ğŸ“„ í˜„ì¥ì„¤ì¹˜</button>
                        </div>
                        <span id="process-excel-status" style="color:#555;font-size:13px;font-weight:500;margin-left:10px;">íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</span>
                    </div>
                </div>
                
                <!-- ì¤‘ë³µ ì…ë ¥ ê²½ê³  -->
                <div id="duplicate-warning" style="display:none;margin-bottom:15px;padding:12px;background:#fff3cd;border:2px solid #ff9800;border-radius:8px;color:#856404;font-size:13px;">
                    <div id="duplicate-warning-content" style="margin-bottom:10px;">
                        <!-- ì¤‘ë³µ ê²½ê³  ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                    <button onclick="deleteAllDuplicates()" style="padding:6px 12px;background:#f44336;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:12px;">
                        ğŸ—‘ï¸ ì¤‘ë³µ í•­ëª© ëª¨ë‘ ì‚­ì œ
                    </button>
                </div>
                
                <div class="date-selector">
                    <label>ğŸ“… ì‘ì—…ì¼ì:</label>
                    <input type="date" id="work-date" onchange="loadDayData()">
                    <div id="weekday-buttons" style="display:flex;gap:8px;flex-wrap:wrap;">
                        <!-- ìš”ì¼ ë²„íŠ¼ë“¤ì´ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ (ì§€ë‚œì£¼ 7ê°œ + ì´ë²ˆ ì£¼ 7ê°œ = ì´ 14ê°œ) -->
                    </div>
                </div>

                <div class="process-legend">
                    <div class="legend-item"><div class="legend-color" style="background:#f8f9fa;"></div><span>ë¯¸ì°©ìˆ˜</span></div>
                    <div class="legend-item"><div class="legend-color" style="background:#ffebee;"></div><span>1.ì£¼ê¸°ë‘¥ì»¤íŒ…</span></div>
                    <div class="legend-item"><div class="legend-color" style="background:#fff3e0;"></div><span>2.ì†Œë¶€ì¬ì»¤íŒ…</span></div>
                    <div class="legend-item"><div class="legend-color" style="background:#e3f2fd;"></div><span>3.ì£¼ê¸°ë‘¥ì¡°ë¦½</span></div>
                    <div class="legend-item"><div class="legend-color" style="background:#e0f7fa;"></div><span>4.ì†Œë¶€ì¬ì¡°ë¦½</span></div>
                    <div class="legend-item"><div class="legend-color" style="background:#fff5ff;"></div><span>5.í˜„ì¥ë°°ì†¡</span></div>
                    <div class="legend-item"><div class="legend-color" style="background:#4caf50;"></div><span>6.ì„¤ì¹˜ì™„ë£Œ</span></div>
                </div>

                <div id="guide-stats" style="margin-bottom:10px;padding:10px;background:#e8f5e9;border-radius:6px;font-size:12px;color:#2e7d32;display:none;"></div>

                <div class="column-grid" id="column-grid-input">
                    <!-- Generated by JS -->
                </div>

                <div class="action-buttons">
                    <button class="action-btn primary" onclick="saveData()">ğŸ’¾ ì €ì¥</button>
                    <button class="action-btn secondary" onclick="exportData()">ğŸ“¥ ë‚´ë³´ë‚´ê¸°</button>
                    <label class="action-btn secondary" style="cursor:pointer;">
                        ğŸ“¤ ê°€ì ¸ì˜¤ê¸°
                        <input type="file" accept=".json" onchange="importData(event)" style="display:none;">
                    </label>
                </div>
                <p style="margin-top:15px;padding:15px;background:#e3f2fd;border-radius:8px;font-size:13px;color:#1565c0;">
                    ğŸ’¡ <strong>ë¡œì»¬ ì €ì¥ ëª¨ë“œ:</strong> ë°ì´í„°ëŠ” ë¸Œë¼ìš°ì €ì˜ localStorageì— ì €ì¥ë©ë‹ˆë‹¤.<br>
                    <strong>ì—­í•  ì„¤ì •:</strong> ì—­í• ì€ Firestoreì˜ <code>projects/{projectId}/members/{uid}</code> ë¬¸ì„œì—ì„œ ê²°ì •ë©ë‹ˆë‹¤.<br>
                    <strong>Admin ì„¤ì •:</strong> Firestoreì—ì„œ members ë¬¸ì„œì˜ <code>role</code> í•„ë“œë¥¼ <code>"admin"</code>ìœ¼ë¡œ ì„¤ì •í•˜ì„¸ìš”.<br>
                    <strong>Editor ì—­í• :</strong> Editor 1(ê³µì •1), Editor 2(ê³µì •2), Editor 3(ê³µì •3,4,5), Editor 4(ê³µì •6)
                </p>
            </div>
        </div>

        <!-- Transport Panel -->
        <div class="panel" id="panel-transport">
            <h3 style="margin-bottom:20px;color:#2c4a7c;">ğŸšš í˜„ì¥ìš´ì†¡ì°¨ìˆ˜ê³„íšì…ë ¥</h3>
            
            <!-- ì…ë ¥ ì•ˆë‚´ì°½ -->
            <div id="transport-guide" style="margin-bottom:20px;padding:15px;background:#fff8e1;border-radius:8px;border:1px solid #ffc107;">
                <div style="margin-bottom:10px;">
                    <strong style="font-size:14px;color:#795548;">ğŸ”´ í˜„ì¥ìš´ì†¡ì°¨ìˆ˜ê³„íšì…ë ¥ : ìœ ì„ì² ê°•</strong>
                </div>
                <div style="font-size:13px;color:#795548;">
                    <div style="margin:3px 0;">â‘  í•´ë‹¹ì°¨ìˆ˜ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.</div>
                    <div style="margin:3px 0;">â‘¡ ì„ íƒí•œ ê¸°ë‘¥ì„ í´ë¦­í•©ë‹ˆë‹¤. ìƒ‰ìƒì´ ë…¹ìƒ‰ìœ¼ë¡œ ë³€ê²½ë©ë‹ˆë‹¤.</div>
                    <div style="margin:3px 0;">â‘¢ í•´ë‹¹ì°¨ìˆ˜ ê¸°ë‘¥ì„ ì„ íƒí›„ ì•„ë˜ ì €ì¥í•©ë‹ˆë‹¤.</div>
                    <div style="margin:3px 0;">â‘£ ìˆ˜ì •ì´ ë°œìƒë˜ë©´ í•´ë‹¹ì°¨ìˆ˜ì—ì„œ ì¬ì§€ì •í•˜ì—¬ ì €ì¥í•©ë‹ˆë‹¤.</div>
                    <div style="margin:3px 0;color:#d32f2f;font-weight:600;">â‘¤ ì¤‘ë³µì²´í¬ë¥¼ í†µí•´ ì…ë ¥ê¸°ë‘¥ì°¨ìˆ˜ì˜ ìµœì¢…ì¼ìë¥¼ í™•ì¸ë°”ëŒ.</div>
                </div>
            </div>
            
            <!-- ì—‘ì…€ ì¼ê´„ ì—…ë¡œë“œ ì„¹ì…˜ -->
            <div id="transport-excel-upload" style="margin-bottom:20px;padding:20px;background:#e8f5e9;border-radius:8px;border:2px solid #4caf50;box-shadow:0 2px 8px rgba(76,175,80,0.2);">
                <div style="margin-bottom:12px;font-weight:700;color:#2c4a7c;font-size:16px;">ğŸ“Š ì—‘ì…€ ì¼ê´„ ì—…ë¡œë“œ</div>
                <div style="margin-bottom:15px;padding:10px;background:rgba(255,255,255,0.7);border-radius:6px;font-size:13px;color:#555;line-height:1.6;">
                    ì—‘ì…€ íŒŒì¼ë¡œ ìš´ì†¡ì°¨ìˆ˜ê³„íšì„ í•œêº¼ë²ˆì— ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                    <strong style="color:#2c4a7c;">ì—‘ì…€ í˜•ì‹:</strong> ì²« í–‰ì— <strong style="color:#d32f2f;">ê³µì¢…, ë„ë©´ë²ˆí˜¸, ê¸°ë‘¥ë²ˆí˜¸, ê·œê²©, ê¸¸ì´(mm), ì¤‘ëŸ‰(kg), ìš´ì†¡ì°¨ìˆ˜ê³„íš(13ì°¨), ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš(12ì°¨)</strong> í—¤ë”ë¥¼ ë„£ì–´ì£¼ì„¸ìš”.<br>
                    <strong style="color:#2c4a7c;">íŒŒì¼ í™•ì¥ì:</strong> <strong style="color:#d32f2f;">*.xlsx</strong> (ì—‘ì…€ 2007 ì´ìƒ í˜•ì‹)<br>
                    <span style="color:#666;font-size:12px;">â€» ê¸°ë‘¥ë²ˆí˜¸ì™€ ìš´ì†¡ì°¨ìˆ˜ê³„íš(XXì°¨) ì»¬ëŸ¼ì´ í•„ìˆ˜ì…ë‹ˆë‹¤.</span>
                </div>
                    <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;padding-top:10px;border-top:1px solid rgba(76,175,80,0.3);">
                        <input type="file" accept=".xlsx,.xls,.csv" id="transport-plan-file" onchange="handleTransportPlanFile(event)" style="padding:10px 15px;border:2px solid #4caf50;border-radius:6px;background:white;font-size:14px;cursor:pointer;min-width:200px;" title="ì—‘ì…€ íŒŒì¼ ì„ íƒ (*.xlsx)">
                        <button class="action-btn primary" onclick="downloadProcessTemplate(5)" style="padding:10px 20px;font-size:14px;font-weight:600;background:#9c27b0;color:white;">ğŸ“„ í˜„ì¥ë°°ì†¡</button>
                        <span id="transport-plan-status" style="color:#555;font-size:13px;font-weight:500;margin-left:10px;">íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</span>
                    </div>
            </div>
            
            <!-- ì°¨ìˆ˜ ê´€ë¦¬ ì„¹ì…˜ -->
            <div style="margin-bottom:20px;padding:15px;background:#fff;border-radius:8px;border:1px solid #e0e0e0;">
                <div style="display:flex;align-items:center;gap:15px;margin-bottom:15px;flex-wrap:wrap;">
                    <label style="font-weight:600;color:#2c4a7c;">ì°¨ìˆ˜ ê´€ë¦¬:</label>
                    <input type="number" id="transport-trip-input" min="1" value="1" style="width:80px;padding:8px;border:1px solid #ddd;border-radius:4px;">
                    <button class="action-btn primary" onclick="addTransportTrip()">â• ì°¨ìˆ˜ ì¶”ê°€</button>
                    <button class="action-btn secondary" onclick="removeTransportTrip()">â– ì°¨ìˆ˜ ì‚­ì œ</button>
                </div>
                <div style="display:flex;align-items:center;gap:15px;margin-bottom:15px;flex-wrap:wrap;padding-top:15px;border-top:1px solid #e0e0e0;">
                    <label style="font-weight:600;color:#2c4a7c;">ì°¨ìˆ˜ ë²ˆí˜¸ ìˆ˜ì •:</label>
                    <input type="number" id="transport-trip-edit-input" min="1" value="1" style="width:80px;padding:8px;border:1px solid #ddd;border-radius:4px;">
                    <button class="action-btn" onclick="editTransportTrip()" style="background:#ff9800;color:white;">âœï¸ ì°¨ìˆ˜ ë²ˆí˜¸ ë³€ê²½</button>
                    <span style="font-size:12px;color:#666;">í˜„ì¬ ì„ íƒëœ ì°¨ìˆ˜ì˜ ë²ˆí˜¸ë¥¼ ë³€ê²½í•©ë‹ˆë‹¤</span>
                </div>
                <div id="transport-trips-list" style="display:flex;flex-wrap:wrap;gap:10px;">
                    <!-- ì°¨ìˆ˜ ë²„íŠ¼ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                </div>
            </div>

            <!-- í˜„ì¬ ì„ íƒëœ ì°¨ìˆ˜ ì •ë³´ -->
            <div id="current-trip-info" style="margin-bottom:20px;padding:15px;background:#e3f2fd;border-radius:8px;border-left:4px solid #2196f3;">
                <div style="font-weight:600;color:#1565c0;margin-bottom:10px;">
                    í˜„ì¬ ì„ íƒ: <span id="current-trip-number">-</span>ì°¨ìˆ˜
                </div>
                <div style="display:flex;align-items:center;gap:15px;flex-wrap:wrap;">
                    <div style="font-size:14px;color:#1976d2;">
                        ì„ íƒëœ ê¸°ë‘¥: <span id="selected-columns-count">0</span>ê°œ
                        <span style="margin-left:12px;">ì´ ë¬¼ëŸ‰: <span id="selected-columns-weight" style="font-weight:bold;color:#2c4a7c;">0í†¤</span></span>
                    </div>
                    <div style="display:flex;align-items:center;gap:8px;">
                        <label style="font-size:14px;color:#1976d2;font-weight:500;">ìš´ì†¡ë‚ ì§œ:</label>
                        <input type="date" id="transport-trip-date" style="padding:6px 10px;border:1px solid #90caf9;border-radius:4px;font-size:14px;" onchange="updateTransportTripDate()">
                    </div>
                </div>
            </div>

            <!-- ê¸°ë‘¥ ì„ íƒ ê·¸ë¦¬ë“œ -->
            <div style="margin-bottom:20px;">
                <div style="margin-bottom:10px;font-weight:600;color:#333;">ê¸°ë‘¥ ì„ íƒ (100ê°œ):</div>
                <div class="column-grid" id="column-grid-transport">
                    <!-- Generated by JS -->
                </div>
            </div>

            <!-- ì¤‘ë³µ ì²´í¬ ê²°ê³¼ í‘œì‹œ -->
            <div id="duplicate-check-result" style="display:none;margin-bottom:20px;padding:15px;background:#ffebee;border-radius:8px;border-left:4px solid #f44336;">
                <div style="font-weight:600;color:#c62828;margin-bottom:10px;">
                    âš ï¸ ì¤‘ë³µ ê¸°ë‘¥ ë°œê²¬
                </div>
                <div id="duplicate-info" style="font-size:13px;color:#d32f2f;">
                    <!-- ì¤‘ë³µ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
            </div>

            <!-- ì €ì¥ ë²„íŠ¼ -->
            <div style="text-align:right;">
                <button class="action-btn" onclick="checkDuplicateColumns()" style="background:#ff9800;color:white;margin-right:10px;">ğŸ” ì¤‘ë³µ ê¸°ë‘¥ ì²´í¬</button>
                <button class="action-btn" onclick="forceSyncToGantt()" style="background:#2196f3;color:white;margin-right:10px;">ğŸ”„ ê³µì •í‘œ ë™ê¸°í™”</button>
                <button class="action-btn primary" onclick="saveTransportPlan()">ğŸ’¾ ìš´ì†¡ì°¨ìˆ˜ê³„íš ì €ì¥</button>
                <button class="action-btn secondary" onclick="clearTransportSelection()">ğŸ”„ ì„ íƒ ì´ˆê¸°í™”</button>
            </div>
        </div>

        <!-- Gantt Panel -->
        <div class="panel" id="panel-gantt">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h3 style="margin:0;color:#2c4a7c;">ğŸ“… ì „ì²´ ê³µì •í‘œ (Gantt Chart)</h3>
                <div style="display:flex;gap:10px;align-items:center;">
                    <div id="gantt-left-panel" onclick="overwriteWithAdjustedPlan()" style="padding:8px 16px;background:#ff9800;border:1px solid #f57c00;border-radius:6px;cursor:pointer;font-weight:600;color:#fff;transition:background-color 0.2s;text-align:center;line-height:1.4;" onmouseover="this.style.background='#fb8c00';" onmouseout="this.style.background='#ff9800';">
                        ì¡°ì •ê³µì •í‘œë¡œ ë®ì–´ì“°ê¸°<br>
                        <span style="font-size:11px;font-weight:400;">ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜ë°”ëë‹ˆë‹¤.</span>
                    </div>
                    <div id="gantt-inquiry-panel" onclick="showInquiryPanel()" style="padding:8px 16px;background:#2196f3;border:1px solid #1976d2;border-radius:6px;cursor:pointer;font-weight:600;color:#fff;transition:background-color 0.2s;text-align:center;" onmouseover="this.style.background='#1976d2';" onmouseout="this.style.background='#2196f3';">
                        ë¬¸ì˜í•˜ê¸°
                    </div>
                    <button class="action-btn" onclick="exportGanttToExcel()" style="background:#4caf50;color:white;padding:8px 16px;border:none;border-radius:6px;cursor:pointer;font-weight:600;">
                        ğŸ“¥ ì—‘ì…€ ì¶œë ¥
                    </button>
                    <button class="action-btn" onclick="enableDeleteMode()" id="delete-mode-btn" style="background:#f44336;color:white;padding:8px 16px;border:none;border-radius:6px;cursor:pointer;font-weight:600;">
                        ğŸ—‘ï¸ ë°ì´í„° ì‚­ì œ
                    </button>
                </div>
            </div>
            
            <div style="margin-bottom:15px;padding:10px 12px;background:#fff3e0;border-left:4px solid #ff9800;border-radius:4px;font-size:13px;color:#e65100;">
                <strong>âš ï¸ ì£¼ì˜ì‚¬í•­:</strong>
                <ul style="margin:8px 0 0 0;padding-left:20px;line-height:1.8;">
                    <li>1. ì£¼ê¸°ë‘¥ì»¤íŒ… + 2. ì†Œë¶€ì¬ì»¤íŒ…ì´ ë™ì¼í•œ ë‚ ì§œë¥¼ 1ê°œê³µì •ë§Œ ì„ íƒí›„ ì‚­ì œê°€ëŠ¥</li>
                    <li>2. ë°ì´í„° ì‚­ì œì™„ë£Œí•˜ë©´ ë°ì´í„°ì‚­ì œì¤‘ì„ í´ë¦­í•˜ì—¬ ì¢…ë£Œí•¨.</li>
                </ul>
            </div>
            
            <div class="process-legend">
                <div class="legend-item"><div class="legend-color" style="background:#e74c3c;"></div><span>1.ì£¼ê¸°ë‘¥ì»¤íŒ…</span></div>
                <div class="legend-item"><div class="legend-color" style="background:#ff9800;"></div><span>2.ì†Œë¶€ì¬ì»¤íŒ…</span></div>
                <div class="legend-item"><div class="legend-color" style="background:#2196f3;"></div><span>3.ì£¼ê¸°ë‘¥ì¡°ë¦½</span></div>
                <div class="legend-item"><div class="legend-color" style="background:#00bcd4;"></div><span>4.ì†Œë¶€ì¬ì¡°ë¦½</span></div>
                <div class="legend-item"><div class="legend-color" style="background:#fef7ff;"></div><span>5.í˜„ì¥ë°°ì†¡</span></div>
                <div class="legend-item"><div class="legend-color" style="background:#4caf50;"></div><span>6.í˜„ì¥ì„¤ì¹˜</span></div>
            </div>

            <div class="gantt-container">
                <table class="gantt-table" id="gantt-table">
                    <!-- Generated by JS -->
                </table>
            </div>
        </div>

        <!-- Transport Volume Panel -->
        <div class="panel" id="panel-transportVolume">
            <h3 style="margin-bottom:16px;color:#2c4a7c;">ğŸ“¦ ìš´ì†¡ë¬¼ëŸ‰ì‚°ì •</h3>
            <figure class="transport-media" style="text-align:center;margin:0 0 16px 0;">
                <img src="../../assets/images/sptep/Site_Transport_1.png" alt="í˜„ì¥ ìš´ì†¡" loading="lazy" style="width:100%;max-width:408px;height:auto;display:block;margin:0 auto;border-radius:8px;border:1px solid #e0e0e0;">
                <figcaption style="margin-top:8px;color:#666;font-size:13px;">í˜„ì¥ìš´ì†¡(25í†¤ ê¸°ì¤€ ì ì¬/ì°¨ìˆ˜ ê³„íš ì—°ë™)</figcaption>
            </figure>
            <div style="margin-bottom:16px;padding:12px;border:1px solid #e0e0e0;border-radius:8px;background:#f9fafb;">
                <div style="margin-bottom:8px;font-weight:600;color:#2c4a7c;">ì…ë ¥ ì•ˆë‚´ (ì—‘ì…€ ì—…ë¡œë“œ)</div>
                <div style="color:#555;font-size:13px;line-height:1.5;">
                    1) ì—‘ì…€ ì²« í–‰ì— ì•„ë˜ ìˆœì„œë¡œ í—¤ë”ë¥¼ ë„£ì–´ì£¼ì„¸ìš”: <strong>ê³µì¢…, ë„ë©´ë²ˆí˜¸, ê¸°ë‘¥ë²ˆí˜¸, ê·œê²©, ê¸¸ì´(mm), ì¤‘ëŸ‰(kg), ìš´ì†¡ì°¨ìˆ˜ê³„íš(13ì°¨), ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš(12ì°¨)</strong><br>
                    2) ìµœëŒ€ 100ê°œ ê¸°ë‘¥ê¹Œì§€ í‘œì‹œë©ë‹ˆë‹¤. ì¶”ê°€ ë°ì´í„°ëŠ” ë¬´ì‹œë©ë‹ˆë‹¤.<br>
                    3) ì—…ë¡œë“œ í›„ í‘œì—ì„œ ë‚´ìš©ì„ ì¦‰ì‹œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </div>
            </div>

            <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:16px;">
                <input type="file" accept=".xlsx,.xls,.csv" id="transport-volume-file" onchange="handleTransportVolumeFile(event)" style="padding:8px;border:1px solid #ccc;border-radius:6px;">
                <button class="action-btn primary" onclick="downloadTransportVolumeTemplate()">ğŸ“„ í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ</button>
                <button class="action-btn" onclick="setDefaultTransportVolumeData()" style="background:#2196f3;color:white;">ğŸ’¾ ê¸°ë³¸ê°’ìœ¼ë¡œ ì €ì¥</button>
                <button class="action-btn" onclick="adjustTo25Ton()" style="background:#ff9800;color:white;">ìµœëŒ€ìš´ì†¡25í†¤</button>
                <button class="action-btn" onclick="exportTransportVolumePanelPdf()" style="background:#9c27b0;color:white;" title="í˜„ì¬ ìš´ì†¡ë¬¼ëŸ‰ì‚°ì • í™”ë©´ë§Œ PDFë¡œ ì €ì¥ (3í˜ì´ì§€ í˜•ì‹ê³¼ ë³„ë„)">ğŸ“„ ì´ í™”ë©´ â†’ PDF ì¶œë ¥</button>
                <div id="transport-volume-adjustment-panel" style="flex:1;min-width:300px;padding:12px;background:#f5f5f5;border-radius:6px;border:1px solid #ddd;display:none;">
                    <div style="font-weight:600;color:#2c4a7c;margin-bottom:8px;font-size:14px;">ğŸ“Š ì¡°ì • ê²°ê³¼</div>
                    <div id="transport-volume-adjustment-info" style="font-size:13px;color:#555;line-height:1.6;">
                        <!-- ì¡°ì • ê²°ê³¼ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>
                <div id="adjusted-plan-toggle" style="padding:12px;background:#fff;border-radius:6px;border:1px solid #ddd;">
                    <div style="display:flex;gap:8px;">
                        <div id="original-plan-btn" onclick="showOriginalPlan()" style="flex:1;padding:8px 12px;background:#e3f2fd;border:2px solid #2196f3;border-radius:6px;cursor:pointer;text-align:center;font-size:13px;font-weight:600;color:#2196f3;transition:all 0.2s;white-space:nowrap;" onmouseover="this.style.background='#bbdefb';" onmouseout="this.style.background='#e3f2fd';">
                            ì›ê³µì •í‘œ ë³´ê¸°
                        </div>
                        <div id="adjusted-plan-btn" onclick="showAdjustedPlan()" style="flex:1;padding:8px 12px;background:#fff;border:2px solid #ddd;border-radius:6px;cursor:pointer;text-align:center;font-size:13px;font-weight:600;color:#666;transition:all 0.2s;white-space:nowrap;" onmouseover="this.style.borderColor='#2196f3';this.style.background='#f5f5f5';" onmouseout="this.style.borderColor='#ddd';this.style.background='#fff';">
                            ì¡°ì •ê³µì •í‘œ ë³´ê¸°
                        </div>
                    </div>
                </div>
                <div id="export-adjusted-plan-panel" style="padding:12px;background:#fff;border-radius:6px;border:1px solid #ddd;width:25%;">
                    <button class="action-btn" onclick="exportAdjustedPlanToExcel()" style="padding:6px 12px;background:#4caf50;color:white;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;width:100%;margin-bottom:8px;">
                        ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš / ì—‘ì…€ë‹¤ìš´ë¡œë“œ
                    </button>
                    <input type="file" accept=".xlsx,.xls,.csv" id="verify-adjusted-plan-file" onchange="verifyAdjustedPlanFromExcel(event)" style="padding:6px;border:1px solid #ddd;border-radius:4px;font-size:11px;width:100%;" title="ì—‘ì…€ íŒŒì¼ ì„ íƒí•˜ì—¬ ì¼ì¹˜ ì—¬ë¶€ í™•ì¸">
                    <div id="adjusted-plan-verify-result" style="margin-top:8px;font-size:11px;color:#666;display:none;"></div>
                </div>
                <div id="export-filtered-data-panel" style="padding:12px;background:#fff;border-radius:6px;border:1px solid #ddd;min-width:246px;width:246px;box-sizing:border-box;text-align:center;">
                    <button class="action-btn" onclick="exportFilteredDataToExcel()" style="padding:6px 12px;background:#2196f3;color:white;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;width:100%;box-sizing:border-box;">
                        ì´ í™”ë©´ â†’ ì—‘ì…€ë‹¤ìš´ë¡œë“œ
                    </button>
                    <div style="font-weight:600;color:#2c4a7c;margin-top:8px;margin-bottom:0;font-size:14px;">ê·œê²©ë³„/ì°¨ìˆ˜ë¶€ì¬ë³„ í•„í„°ë§</div>
                </div>
                <div id="transport-volume-size-filter" style="padding:12px;background:#fff;border-radius:6px;border:1px solid #ddd;">
                    <div style="font-weight:600;color:#2c4a7c;margin-bottom:8px;font-size:14px;">ê·œê²©ë³„ ë¶€ì¬ - í•„í„°ë§</div>
                    <div id="transport-volume-size-toggles" style="display:flex;gap:8px;flex-wrap:wrap;">
                        <!-- ê·œê²©ë³„ í† ê¸€ ë²„íŠ¼ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                    </div>
                </div>
                <div id="transport-volume-trip-filter-original" style="padding:12px;background:#fff;border-radius:6px;border:1px solid #ddd;">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
                        <div style="font-weight:600;color:#2c4a7c;font-size:14px;">ì°¨ìˆ˜ë³„ë¶€ì¬(ì›13ì°¨ìˆ˜)</div>
                        <button id="toggle-all-original" onclick="toggleAllTrips('original')" style="padding:4px 12px;border:2px solid #2196f3;border-radius:6px;background:#fff;color:#2196f3;cursor:pointer;font-size:11px;font-weight:600;transition:all 0.2s;white-space:nowrap;" onmouseover="this.style.background='#e3f2fd';" onmouseout="this.style.background='#fff';">
                            OFF
                        </button>
                    </div>
                    <div id="transport-volume-trip-toggles-original" style="display:flex;gap:8px;flex-wrap:wrap;">
                        <!-- ìš´ì†¡ì°¨ìˆ˜ê³„íš(13ì°¨) í† ê¸€ ë²„íŠ¼ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                    </div>
                </div>
                <div id="transport-volume-trip-filter-adjusted" style="padding:12px;background:#fff;border-radius:6px;border:1px solid #ddd;">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
                        <div style="font-weight:600;color:#2c4a7c;font-size:14px;">ì°¨ìˆ˜ë³„ë¶€ì¬(ì¡°ì •12ì°¨ìˆ˜)</div>
                        <button id="toggle-all-adjusted" onclick="toggleAllTrips('adjusted')" style="padding:4px 12px;border:2px solid #ff9800;border-radius:6px;background:#fff;color:#ff9800;cursor:pointer;font-size:11px;font-weight:600;transition:all 0.2s;white-space:nowrap;" onmouseover="this.style.background='#fff3e0';" onmouseout="this.style.background='#fff';">
                            OFF
                        </button>
                    </div>
                    <div id="transport-volume-trip-toggles-adjusted" style="display:flex;gap:8px;flex-wrap:wrap;">
                        <!-- ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš(12ì°¨) í† ê¸€ ë²„íŠ¼ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                    </div>
                </div>
            </div>

            <div id="transport-volume-table-wrapper" style="overflow-x:auto;scrollbar-width:none;-ms-overflow-style:none;">
                <table class="gantt-table" style="min-width:600px;">
                    <thead>
                        <tr>
                            <th style="width:80px;">ê³µì¢…</th>
                            <th style="width:100px;">ë„ë©´ë²ˆí˜¸</th>
                            <th style="width:100px;">ê¸°ë‘¥ë²ˆí˜¸</th>
                            <th style="width:120px;">ê·œê²©</th>
                            <th style="width:100px;">ê¸¸ì´(mm)</th>
                            <th style="width:100px;">ì¤‘ëŸ‰(kg)</th>
                            <th style="width:150px;">ìš´ì†¡ì°¨ìˆ˜ê³„íš(13ì°¨)</th>
                            <th style="width:150px;">ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš</th>
                        </tr>
                    </thead>
                    <tbody id="transport-volume-tbody">
                        <tr><td colspan="8" style="text-align:center;color:#888;padding:16px;">ì—‘ì…€ì„ ì—…ë¡œë“œí•˜ë©´ ì—¬ê¸°ì—ì„œ 100ê°œ ê¸°ë‘¥ ë°ì´í„°ê°€ í‘œì‹œë©ë‹ˆë‹¤.</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- í†µê³„ ì •ë³´ -->
            <div id="transport-volume-stats" style="margin-top:20px;padding:20px;background:#f5f5f5;border-radius:8px;border:2px solid #2196f3;display:flex;justify-content:space-around;align-items:center;flex-wrap:wrap;gap:20px;">
                <div style="text-align:center;flex:1;min-width:200px;">
                    <div style="font-size:14px;color:#666;margin-bottom:8px;">ì „ì²´í•©ì‚°ì¤‘ëŸ‰</div>
                    <div id="total-weight" style="font-size:24px;font-weight:bold;color:#2196f3;">0 kg</div>
                </div>
                <div style="text-align:center;flex:1;min-width:200px;">
                    <div style="font-size:14px;color:#666;margin-bottom:8px;">ì´ë¶€ì¬ìˆ˜</div>
                    <div id="total-count" style="font-size:24px;font-weight:bold;color:#4caf50;">0 ê°œ</div>
                </div>
                <div style="text-align:center;flex:1;min-width:200px;">
                    <div style="font-size:14px;color:#666;margin-bottom:8px;">ë¶€ì¬1ê°œë‹¹ í‰ê· ì¤‘ëŸ‰</div>
                    <div id="average-weight" style="font-size:24px;font-weight:bold;color:#ff9800;">0 kg</div>
                </div>
            </div>

            <div id="transport-volume-adjustment-section">
            <h4 style="margin-top:20px;margin-bottom:16px;color:#2c4a7c;font-size:16px;font-weight:600;">í˜„ì¬ ìš´ì†¡ì°¨ìˆ˜ê³„íš (13ì°¨)</h4>

            <!-- ì°¨ìˆ˜ë³„ ì§‘ê³„ í…Œì´ë¸” -->
            <div style="margin-top:20px;overflow-x:auto;">
                <table class="gantt-table" style="min-width:800px;width:100%;table-layout:fixed;">
                    <thead>
                        <tr>
                            <th>ì°¨ìˆ˜</th>
                            <th>ë¶€ì¬ìˆ˜</th>
                            <th>ì°¨ìˆ˜í•©ì‚°ì¤‘ëŸ‰(ton)</th>
                            <th>25í†¤ ì´ˆê³¼ì—¬ë¶€</th>
                            <th>ì¶”ê°€ìš´ì†¡ì—¬ìœ ì¤‘ëŸ‰(ton)</th>
                            <th>ìš´ì†¡ë‚ ì§œ</th>
                        </tr>
                    </thead>
                    <tbody id="transport-volume-trip-summary-tbody">
                        <tr><td colspan="6" style="text-align:center;color:#888;padding:16px;">ì—‘ì…€ì„ ì—…ë¡œë“œí•˜ë©´ ì°¨ìˆ˜ë³„ ì§‘ê³„ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- ìµœëŒ€ìš´ì†¡ 25í†¤ì‹œ ì°¨ìˆ˜ ì¡°ì • í…Œì´ë¸” -->
            <div style="margin-top:30px;">
                <h4 style="margin-bottom:16px;color:#2c4a7c;font-size:16px;font-weight:600;">ìµœëŒ€ìš´ì†¡ 25í†¤ì‹œ ì°¨ìˆ˜ ì¡°ì •</h4>
                <div style="overflow-x:auto;">
                    <table class="gantt-table" style="min-width:800px;width:100%;table-layout:fixed;">
                        <thead>
                            <tr>
                                <th>ì°¨ìˆ˜</th>
                                <th>ë¶€ì¬ìˆ˜</th>
                                <th>ì°¨ìˆ˜í•©ì‚°ì¤‘ëŸ‰(ton)</th>
                                <th>25í†¤ ì´ˆê³¼ì—¬ë¶€</th>
                                <th>ì¶”ê°€ìš´ì†¡ì—¬ìœ ì¤‘ëŸ‰(ton)</th>
                                <th>ìš´ì†¡ë‚ ì§œ</th>
                            </tr>
                        </thead>
                        <tbody id="adjusted-transport-volume-trip-summary-tbody">
                            <tr><td colspan="6" style="text-align:center;color:#888;padding:16px;">"ìµœëŒ€ìš´ì†¡25í†¤" ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ì¡°ì •ëœ ì°¨ìˆ˜ê³„íšì´ í‘œì‹œë©ë‹ˆë‹¤.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            </div>
        </div>

        <!-- Chart Panel -->
        <div class="panel" id="panel-chart">
            <div class="chart-container">
                <h3>ğŸ“ˆ ì¼ë³„ ëˆ„ì  ì§„í–‰ë¥ </h3>
                <canvas id="progressChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>ğŸ“Š ì—…ì²´ë³„ ê³µì • í˜„í™©</h3>
                <canvas id="companyChart"></canvas>
            </div>
        </div>

        <!-- PDF ì¶œë ¥ íŒ¨ë„ (ì¶œë ¥ ìœ í˜• ì„ íƒ í›„ í•˜ë‚˜ì”© ì¶œë ¥) -->
        <div class="panel" id="panel-transportVolumePdf">
            <h3 style="margin-bottom:16px;color:#2c4a7c;">ğŸ“„ PDF ì¶œë ¥</h3>
            <p style="margin-bottom:12px;color:#555;font-size:14px;">ì¶œë ¥í•  í•­ëª©ì„ ì„ íƒí•œ ë’¤ PDFë¡œ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤. í•œ ë²ˆì— í•˜ë‚˜ì”©ë§Œ ì¶œë ¥ë©ë‹ˆë‹¤.</p>
            <div style="margin-bottom:16px;padding:12px;background:#f8f9fa;border-radius:8px;border:1px solid #e0e0e0;">
                <div style="font-weight:600;margin-bottom:8px;color:#2c4a7c;">ì¶œë ¥ í•­ëª© ì„ íƒ</div>
                <div style="display:flex;flex-wrap:wrap;gap:12px;">
                    <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:14px;">
                        <input type="radio" name="pdfExportType" value="gantt" style="margin:0;"> ğŸ“… ê³µì •í‘œ
                    </label>
                    <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:14px;">
                        <input type="radio" name="pdfExportType" value="transportVolume" checked style="margin:0;"> ğŸ“¦ ìš´ì†¡ì°¨ìˆ˜ì¡°ì •ê³„íš
                    </label>
                    <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:14px;">
                        <input type="radio" name="pdfExportType" value="chart" style="margin:0;"> ğŸ“ˆ ì§„í–‰ë¥  ì°¨íŠ¸
                    </label>
                    <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:14px;">
                        <input type="radio" name="pdfExportType" value="installation" style="margin:0;"> ğŸ—ï¸ í˜„ì¥ì„¤ì¹˜í˜„í™©ë„
                    </label>
                </div>
            </div>
            <div id="pdf-export-preview" style="position:relative;padding:30px;background:#fff;border:1px solid #ddd;border-radius:8px;overflow:auto;max-height:70vh;">
                <!-- ì„ íƒ í•­ëª©ë³„ ë¯¸ë¦¬ë³´ê¸° (ë™ì  ìƒì„±) -->
            </div>
            <div style="margin-top:16px;display:flex;flex-wrap:wrap;gap:10px;align-items:center;">
                <button class="action-btn primary" onclick="exportSelectedPdf()" style="background:#e91e63;">ğŸ“¥ PDF ë‹¤ìš´ë¡œë“œ</button>
            </div>
            <div id="pdf-export-html-wrap" style="display:none;margin-top:16px;padding:12px;background:#f5f5f5;border:1px solid #ddd;border-radius:8px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                    <span style="font-size:13px;color:#2c4a7c;font-weight:600;">PDF 1í˜ì´ì§€ì— ì‚¬ìš©ë˜ëŠ” HTML (ë³µì‚¬ ê°€ëŠ¥)</span>
                    <button type="button" onclick="copyPdfExportHtmlToClipboard()" style="padding:6px 12px;font-size:12px;background:#2c4a7c;color:white;border:none;border-radius:6px;cursor:pointer;">í´ë¦½ë³´ë“œì— ë³µì‚¬</button>
                </div>
                <textarea id="pdf-export-html-textarea" readonly style="width:100%;height:240px;font-family:Consolas,monospace;font-size:11px;padding:10px;border:1px solid #ccc;border-radius:4px;resize:vertical;"></textarea>
                <div style="margin-top:6px;font-size:11px;color:#666;">ìœ„ HTMLì„ ë³µì‚¬í•˜ì—¬ Puppeteer ë“±ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
            </div>
            <!-- ê´€ë¦¬ì ì „ìš©: PDF ì¶œë ¥ ê¸°ë¡ -->
            <div id="pdf-export-history-wrap" style="display:none;margin-top:24px;padding:16px;background:#f0f4f8;border-radius:8px;border:1px solid #d0d7de;">
                <h4 style="margin-bottom:12px;color:#2c4a7c;font-size:14px;">ğŸ“‹ PDF ì¶œë ¥ ê¸°ë¡ (ê´€ë¦¬ì)</h4>
                <div id="pdf-export-history-list" style="font-size:12px;color:#555;max-height:200px;overflow:auto;"></div>
                <button type="button" onclick="loadPdfExportHistory()" style="margin-top:8px;padding:6px 12px;font-size:12px;background:#2c4a7c;color:white;border:none;border-radius:6px;cursor:pointer;">ğŸ”„ ê¸°ë¡ ìƒˆë¡œê³ ì¹¨</button>
            </div>
        </div>

        <!-- Installation Status Panel -->
        <div class="panel" id="panel-installation">
            <h3 style="margin-bottom:16px;color:#2c4a7c;">ğŸ—ï¸ í˜„ì¥ì„¤ì¹˜í˜„í™©ë„</h3>
            
            <!-- ê³µì •ìœ¨ í‘œì‹œ -->
            <div style="margin-bottom:20px;padding:15px;background:#fff;border-radius:8px;border:1px solid #e0e0e0;">
                <h4 style="margin-bottom:12px;color:#2c4a7c;font-size:14px;font-weight:600;">ğŸ“Š ê³µì •ìœ¨ í˜„í™©</h4>
                <div id="installation-progress-summary" style="display:grid;grid-template-columns:repeat(6,1fr);gap:10px;">
                    <!-- ê³µì •ìœ¨ì´ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                </div>
            </div>
            
            <!-- ì¢Œí‘œ ì„¤ì • ëª¨ë“œ í† ê¸€ -->
            <div style="margin-bottom:15px;padding:12px;background:#fff3cd;border-radius:8px;border:1px solid #ffc107;">
                <button id="coordinate-setup-btn" onclick="toggleCoordinateSetup()" class="coordinate-setup-btn inactive" style="padding:8px 16px;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;">
                    ğŸ“ ì¢Œí‘œ ì„¤ì • ëª¨ë“œ
                </button>
                <span id="coordinate-setup-hint" style="margin-left:10px;font-size:13px;color:#856404;display:none;">
                    ì¢Œí‘œ ì„¤ì • ëª¨ë“œ: í‰ë©´ë„ ì´ë¯¸ì§€ì—ì„œ ê° ê¸°ë‘¥ ë²ˆí˜¸ ìœ„ì¹˜ë¥¼ í´ë¦­í•˜ì—¬ ì„¤ì •í•˜ì„¸ìš”.
                </span>
                <div id="coordinate-guide" style="margin-top:10px;padding:10px;background:#e8f5e9;border-radius:6px;font-size:12px;line-height:1.6;display:none;">
                    <strong>ğŸ“‹ ì‚¬ìš© ë°©ë²•:</strong><br>
                    1ï¸âƒ£ ì¢Œí‘œ ì„¤ì • ëª¨ë“œ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ í™œì„±í™”í•©ë‹ˆë‹¤<br>
                    2ï¸âƒ£ ì˜¤ë¥¸ìª½ ê¸°ë‘¥ ë²ˆí˜¸ ëª©ë¡ì—ì„œ ì¢Œí‘œë¥¼ ì„¤ì •í•  ê¸°ë‘¥ì„ í´ë¦­í•©ë‹ˆë‹¤<br>
                    3ï¸âƒ£ í‰ë©´ë„ ì´ë¯¸ì§€ì—ì„œ í•´ë‹¹ ê¸°ë‘¥ì˜ ì •í™•í•œ ìœ„ì¹˜ë¥¼ í´ë¦­í•©ë‹ˆë‹¤<br>
                    4ï¸âƒ£ ì¢Œí‘œê°€ ìë™ìœ¼ë¡œ ì €ì¥ë˜ê³  ë§ˆì»¤ê°€ í‘œì‹œë©ë‹ˆë‹¤<br>
                    <span style="color:#d32f2f;font-weight:600;">â€» ì¢Œí‘œëŠ” ìë™ ì €ì¥ë˜ë©° í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ë„ ìœ ì§€ë©ë‹ˆë‹¤</span>
                </div>
            </div>
            
            <div style="display:grid;grid-template-columns:2fr 1fr;gap:20px;margin-bottom:20px;">
                <!-- Floor Plan Image -->
                <div id="installation-floor-plan-image" style="position:relative;min-height:600px;background:#fff;border:1px solid #ccc;border-radius:8px;background-image:url('../../assets/images/floor-plan.png');background-size:contain;background-repeat:no-repeat;background-position:center;">
                    <!-- Column markers will be dynamically added here -->
                </div>
                
                <!-- Column Number List -->
                <div>
                    <h4 style="margin-bottom:12px;color:#2c4a7c;font-size:16px;">ê¸°ë‘¥ ë²ˆí˜¸ ëª©ë¡</h4>
                    <div id="installation-column-list" style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;">
                        <!-- Column number cards with status will be dynamically generated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Column Detail Modal -->
    <div class="modal" id="column-modal">
        <div class="modal-content">
            <h3>ğŸ”© ê¸°ë‘¥ <span id="modal-column-num"></span> ê³µì • ì…ë ¥</h3>
            <div class="form-group" id="modal-date-group" style="display:block !important;visibility:visible !important;margin-bottom:15px;">
                <label style="display:block;margin-bottom:5px;font-weight:600;color:#555;">ì‘ì—…ì¼ì:</label>
                <input type="date" id="modal-work-date" style="width:100% !important;padding:10px !important;border:2px solid #ddd !important;border-radius:8px !important;font-size:14px !important;display:block !important;visibility:visible !important;">
            </div>
            <div class="form-group">
                <label>í˜„ì¬ ê³µì • ìƒíƒœ:</label>
                <select id="modal-process-select">
                    <option value="0">0. ë¯¸ì°©ìˆ˜</option>
                    <option value="1">1. ì£¼ê¸°ë‘¥ì»¤íŒ… ì™„ë£Œ</option>
                    <option value="2">2. ê¸°ë‘¥ì†Œë¶€ì¬ì»¤íŒ… ì™„ë£Œ</option>
                    <option value="3">3. ì£¼ê¸°ë‘¥ì¡°ë¦½ ì™„ë£Œ</option>
                    <option value="4">4. í˜„ì¥ë°°ì†¡ ì™„ë£Œ</option>
                    <option value="5">5. í˜„ì¥ì„¤ì¹˜ ì™„ë£Œ</option>
                </select>
            </div>
            <div class="form-group">
                <label>ë¹„ê³ :</label>
                <input type="text" id="modal-note" placeholder="íŠ¹ì´ì‚¬í•­ ì…ë ¥">
            </div>
            <div class="modal-buttons">
                <button class="action-btn primary" onclick="saveColumnStatus()">ì €ì¥</button>
                <button class="action-btn secondary" onclick="closeModal()">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // ë¹Œë“œ ìŠ¤íƒ¬í”„
        // ============================================
        console.log("BUILD_STAMP: 2026-02-01_RevA");
        
        // ============================================
        // ì „ì—­ í•¨ìˆ˜ ì •ì˜ (HTML onclickì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•˜ë„ë¡ ë¨¼ì € ì •ì˜)
        // ============================================
        
        // Panel Navigation (ì „ì—­ í•¨ìˆ˜ë¡œ ë¨¼ì € ì •ì˜)
        window.showPanel = function showPanel(panelId, btnElement) {
            console.log('ğŸ”µ showPanel í˜¸ì¶œ:', panelId, btnElement);
            
            // ìš´ì†¡ì°¨ìˆ˜ê³„íš íŒ¨ë„ì€ Adminë§Œ ì ‘ê·¼ ê°€ëŠ¥
            if (panelId === 'transport' && typeof userRole !== 'undefined' && userRole !== 'admin') {
                alert('âš ï¸ ê¶Œí•œ ì—†ìŒ\n\nìš´ì†¡ì°¨ìˆ˜ê³„íšì€ ê´€ë¦¬ì(Admin)ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ëª¨ë“  íŒ¨ë„ ë¹„í™œì„±í™”
            document.querySelectorAll('.panel').forEach(p => {
                p.classList.remove('active');
                console.log('íŒ¨ë„ ë¹„í™œì„±í™”:', p.id);
            });
            
            // ì¼ì¼ ì…ë ¥ ë²„íŠ¼ì€ ì œì™¸í•˜ê³  active í´ë˜ìŠ¤ ì œê±°
            document.querySelectorAll('.tab-btn').forEach(b => {
                if (!b.closest('.company-selector')) {
                    b.classList.remove('active');
                }
            });
            
            // í•´ë‹¹ íŒ¨ë„ í™œì„±í™”
            const panel = document.getElementById('panel-' + panelId);
            console.log('íŒ¨ë„ ì°¾ê¸°:', 'panel-' + panelId, panel);
            if (panel) {
                panel.classList.add('active');
                console.log('âœ… íŒ¨ë„ í™œì„±í™”:', panel.id);
            } else {
                console.error('âŒ íŒ¨ë„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', 'panel-' + panelId);
            }
            
            // ë²„íŠ¼ í™œì„±í™”
            if (btnElement) {
                btnElement.classList.add('active');
                console.log('âœ… ë²„íŠ¼ í™œì„±í™”:', btnElement);
            } else {
                // btnElementê°€ ì—†ìœ¼ë©´ ì´ë²¤íŠ¸ì—ì„œ ì°¾ê¸°
                const clickedBtn = document.querySelector(`[onclick*="showPanel('${panelId}'"]`) || 
                                 document.querySelector(`[onclick*='showPanel("${panelId}"']`);
                if (clickedBtn) {
                    clickedBtn.classList.add('active');
                    console.log('âœ… ë²„íŠ¼ í™œì„±í™” (ì°¾ìŒ):', clickedBtn);
                }
            }
            
            // íŒ¨ë„ë³„ ì´ˆê¸°í™” ì‘ì—… (í•¨ìˆ˜ê°€ ì •ì˜ëœ í›„ì—ë§Œ ì‹¤í–‰)
            if (typeof loadTransportPlan === 'function' && panelId === 'gantt') {
                loadTransportPlan();
                if (typeof syncTransportToDailyData === 'function') {
                    syncTransportToDailyData(false);
                }
                if (typeof renderGanttChart === 'function') {
                    renderGanttChart();
                }
            } else if (typeof renderColumnGrid === 'function' && panelId === 'overview') {
                renderColumnGrid('column-grid-overview');
                if (typeof updateProgressBars === 'function') {
                    updateProgressBars();
                }
            } else if (typeof loadTransportPlan === 'function' && panelId === 'transport') {
                loadTransportPlan();
                if (typeof renderTransportColumnGrid === 'function') {
                    renderTransportColumnGrid();
                }
                if (typeof renderTransportTrips === 'function') {
                    renderTransportTrips();
                }
            } else if (typeof renderTransportVolumeTable === 'function' && panelId === 'transportVolume') {
                // ë¨¼ì € ê¸°ë³¸ê°’ì´ ìˆìœ¼ë©´ ê¸°ë³¸ê°’ ë¡œë“œ ì‹œë„
                const defaultLoaded = typeof loadDefaultTransportVolumeData === 'function' ? loadDefaultTransportVolumeData() : false;
                
                // ê¸°ë³¸ê°’ì´ ì—†ê±°ë‚˜ ë¡œë“œ ì‹¤íŒ¨í•œ ê²½ìš°, ì¼ë°˜ ì €ì¥ëœ ë°ì´í„° ë¡œë“œ
                if (!defaultLoaded) {
                    const savedTransportVolumeData = localStorage.getItem(kcolKey('transportVolumeData'));
                    if (savedTransportVolumeData) {
                        try {
                            const parsedData = JSON.parse(savedTransportVolumeData);
                            if (parsedData && parsedData.length > 0) {
                                transportVolumeData = parsedData;
                                console.log('âœ… ìš´ì†¡ë¬¼ëŸ‰ì‚°ì • ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', transportVolumeData.length, 'ê°œ');
                            }
                        } catch (e) {
                            console.error('âŒ transportVolumeData íŒŒì‹± ì‹¤íŒ¨:', e);
                        }
                    }
                }
                renderTransportVolumeTable();
                // ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš í…Œì´ë¸”ë„ ë Œë”ë§
                renderAdjustedTripSummarySafe();
            } else if (typeof renderInstallationStatus === 'function' && panelId === 'installation') {
                renderInstallationStatus();
            } else if (panelId === 'chart' && typeof renderCharts === 'function') {
                renderCharts();
            } else if (panelId === 'transportVolumePdf') {
                if (typeof renderTransportVolumeTable === 'function') {
                    renderTransportVolumeTable();
                    if (typeof renderTransportVolumeTripSummary === 'function') renderTransportVolumeTripSummary();
                    renderAdjustedTripSummarySafe();
                }
                if (typeof refreshPdfExportPreview === 'function') {
                    const t = document.querySelector('input[name="pdfExportType"]:checked')?.value || 'transportVolume';
                    refreshPdfExportPreview(t);
                }
                document.querySelectorAll('input[name="pdfExportType"]').forEach(function (radio) {
                    radio.removeEventListener('change', window._pdfExportTypeChange);
                });
                window._pdfExportTypeChange = function () {
                    if (typeof refreshPdfExportPreview === 'function') refreshPdfExportPreview(document.querySelector('input[name="pdfExportType"]:checked')?.value);
                };
                document.querySelectorAll('input[name="pdfExportType"]').forEach(function (radio) {
                    radio.addEventListener('change', window._pdfExportTypeChange);
                });
                var historyWrap = document.getElementById('pdf-export-history-wrap');
                if (historyWrap && typeof userRole !== 'undefined' && userRole === 'admin') {
                    historyWrap.style.display = 'block';
                    if (typeof loadPdfExportHistory === 'function') loadPdfExportHistory();
                } else if (historyWrap) {
                    historyWrap.style.display = 'none';
                }
            }
            
            console.log('âœ… showPanel ì™„ë£Œ');
        };
        
        // ============================================================
        // ê³µì • í™•ì • í•¨ìˆ˜ (ê³µì •ì´ í™•ì •ë˜ëŠ” ì§€ì ì—ì„œ í˜¸ì¶œ)
        // ============================================================
        function onCurrentProcessReady(processId) {
            window.currentProcess = processId;
            if (typeof currentProcess !== 'undefined') {
                currentProcess = processId;
            }

            console.log("[PROCESS READY]", processId);

            // ğŸ”‘ ì—¬ê¸°ì„œ ë‹¤ì‹œ ê¶Œí•œ ì ìš© (í•µì‹¬)
            applyRoleBasedUI(userRole, allowedProcesses);
        }

        // Process Selection (ê³µì •ë³„ ì„ íƒ)
        window.selectPreocess = function selectPreocess(processId) {
            // processIdë¥¼ ìˆ«ìë¡œ ì •ê·œí™” (íƒ€ì… ì¼ì¹˜ ë³´ì¥)
            const normalizedProcessId = parseInt(processId);
            if (isNaN(normalizedProcessId)) {
                console.error('âŒ ì˜ëª»ëœ ê³µì • ID:', processId);
                return;
            }
            
            // ê¶Œí•œ ì²´í¬: EditorëŠ” í—ˆìš©ë˜ì§€ ì•Šì€ ê³µì •ë„ ì½ê¸°(ì¡°íšŒ)ëŠ” ê°€ëŠ¥í•˜ì§€ë§Œ ì“°ê¸°ëŠ” ë¶ˆê°€
            // (ê³µì • ì„ íƒì€ í—ˆìš©í•˜ê³ , ì•„ë˜ì—ì„œ ì…ë ¥ì°½ë§Œ ë¹„í™œì„±í™”)
            if (typeof userRole !== 'undefined' && userRole === 'editor') {
                // allowedProcessesë¥¼ ìˆ«ì ë°°ì—´ë¡œ ì •ê·œí™” (íƒ€ì… ì¼ì¹˜ ë³´ì¥)
                const normalizedAllowedProcesses = Array.isArray(allowedProcesses)
                    ? allowedProcesses.map(p => parseInt(p)).filter(p => !isNaN(p))
                    : [];
                
                if (typeof allowedProcesses !== 'undefined' && !normalizedAllowedProcesses.includes(normalizedProcessId)) {
                    const proc = typeof PROCESSES !== 'undefined' ? PROCESSES.find(p => p.id === normalizedProcessId) : null;
                    const procName = proc ? proc.name : `ê³µì • ${normalizedProcessId}`;
                    console.warn(`âš ï¸ EditorëŠ” ${procName}ì— ëŒ€í•œ ì“°ê¸° ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ì½ê¸°(ì¡°íšŒ)ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
                    console.log(`í—ˆìš©ëœ ê³µì •: ${normalizedAllowedProcesses.map(p => {
                        const pr = typeof PROCESSES !== 'undefined' ? PROCESSES.find(pr => pr.id === p) : null;
                        return pr ? `${p}.${pr.name}` : `${p}`;
                    }).join(', ')}`);
                    // return ì œê±°: ê³µì • ì„ íƒì€ í—ˆìš©í•˜ê³ , ì•„ë˜ì—ì„œ ì…ë ¥ì°½ë§Œ ë¹„í™œì„±í™”
                }
            }
            
            // ViewerëŠ” ê³µì • ì„ íƒ ë¶ˆê°€
            if (typeof userRole !== 'undefined' && userRole === 'viewer') {
                alert('âš ï¸ ê¶Œí•œ ì—†ìŒ\n\nViewerëŠ” ê³µì •ì„ ì„ íƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\nì½ê¸° ì „ìš©ì…ë‹ˆë‹¤.');
                return;
            }
            
            // ê³µì • ë³€ê²½ ì‹œ ì„ íƒëœ ê¸°ë‘¥ ì´ˆê¸°í™”
            if (typeof selectedColumns !== 'undefined') {
                selectedColumns = [];
            }
            
            // í•´ë‹¹ ê³µì •ì˜ ë‹´ë‹¹ ì—…ì²´ ì„¤ì •
            if (typeof PROCESSES !== 'undefined') {
                const process = PROCESSES.find(p => p.id === normalizedProcessId);
                if (typeof currentCompany !== 'undefined' && process) {
                    currentCompany = process.company;
                }
            }
            
            // ë²„íŠ¼ í™œì„±í™” í‘œì‹œ
            document.querySelectorAll('.process-btn').forEach(btn => btn.classList.remove('active'));
            const processBtn = document.querySelector(`.process-btn.p${normalizedProcessId}`);
            if (processBtn) {
                processBtn.classList.add('active');
            }
            
            // Editorê°€ í—ˆìš©ë˜ì§€ ì•Šì€ ê³µì •ì„ ì„ íƒí•œ ê²½ìš° ì…ë ¥ì°½ ë¹„í™œì„±í™”
            if (typeof userRole !== 'undefined' && userRole === 'editor') {
                // allowedProcessesë¥¼ ìˆ«ì ë°°ì—´ë¡œ ì •ê·œí™” (íƒ€ì… ì¼ì¹˜ ë³´ì¥)
                const normalizedAllowedProcesses = Array.isArray(allowedProcesses)
                    ? allowedProcesses.map(p => parseInt(p)).filter(p => !isNaN(p))
                    : [];
                
                if (typeof allowedProcesses !== 'undefined' && !normalizedAllowedProcesses.includes(normalizedProcessId)) {
                    // ì…ë ¥ì°½ ë¹„í™œì„±í™” (ì½ê¸°ë§Œ ê°€ëŠ¥, ì“°ê¸° ë¶ˆê°€)
                    const workDateInput = document.getElementById('work-date');
                    const columnGridInput = document.getElementById('column-grid-input');
                    const saveButton = document.querySelector('#panel-input button[onclick*="saveSelectedColumns"]');
                    
                    if (workDateInput) {
                        workDateInput.disabled = true;
                        workDateInput.style.opacity = '0.5';
                    }
                    if (columnGridInput) {
                        columnGridInput.style.pointerEvents = 'none';
                        columnGridInput.style.opacity = '0.5';
                    }
                    if (saveButton) {
                        saveButton.disabled = true;
                        saveButton.style.opacity = '0.5';
                    }
                    // return ì œê±°: ê³µì • ì„ íƒì€ ì™„ë£Œí•˜ê³ , ë°ì´í„° ì¡°íšŒ(ì½ê¸°)ëŠ” ê°€ëŠ¥í•˜ë„ë¡ í•¨
                } else {
                    // í—ˆìš©ëœ ê³µì •ì¸ ê²½ìš° ì…ë ¥ì°½ í™œì„±í™”
                    const workDateInput = document.getElementById('work-date');
                    const columnGridInput = document.getElementById('column-grid-input');
                    const saveButton = document.querySelector('#panel-input button[onclick*="saveSelectedColumns"]');
                    
                    if (workDateInput) {
                        workDateInput.disabled = false;
                        workDateInput.style.opacity = '1';
                    }
                    if (columnGridInput) {
                        columnGridInput.style.pointerEvents = 'auto';
                        columnGridInput.style.opacity = '1';
                    }
                    if (saveButton) {
                        saveButton.disabled = false;
                        saveButton.style.opacity = '1';
                    }
                }
            }
            
            const processNames = {
                1: '1. ì£¼ê¸°ë‘¥ì»¤íŒ… (ìœ ì„ì² ê°•(ì¶©ì£¼ê³µì¥))',
                2: '2. ê¸°ë‘¥ì†Œë¶€ì¬ì»¤íŒ… (ìœ ì„ì² ê°•(ì˜¤ì°½ê³µì¥))',
                3: '3. ì£¼ê¸°ë‘¥ì¡°ë¦½ (ìœ ì„ì² ê°•(ìŒì„±ê³µì¥))',
                4: '4. ì†Œë¶€ì¬ì¡°ë¦½ (ìœ ì„ì² ê°•(ìŒì„±ê³µì¥))',
                5: '5. í˜„ì¥ë°°ì†¡ (ìœ ì„ì² ê°•(ìŒì„±ê³µì¥))',
                6: '6. í˜„ì¥ì„¤ì¹˜ (ì§„í¥ê¸°ì—…)'
            };
            const companyNameEl = document.getElementById('selected-company-name');
            if (companyNameEl) {
                companyNameEl.textContent = '- ' + (processNames[normalizedProcessId] || '');
            }
            
            // ============================================================
            // 10ì´ˆ ì§„ë‹¨ ì½”ë“œ (ê³µì • ì…ë ¥ í™”ë©´ ë Œë”ë§ ì§ì „)
            // ============================================================
            console.log('[DEBUG] userRole:', userRole);
            console.log('[DEBUG] canEditProcess(1):', canEditProcess(1));
            console.log('[DEBUG] PROJECT_ID:', window.PROJECT_ID);
            // userRole: "admin" + canEditProcess(1): trueë©´ â†’ ì¦‰ì‹œ ì…ë ¥ í’€ë¦¼
            // ì•„ë‹ˆë©´ â†’ ì•„ì§ ì–´ë”˜ê°€ì—ì„œ userRoleì„ ë‹¤ì‹œ ë®ì–´ì“°ê³  ìˆëŠ” ê²ë‹ˆë‹¤
            // ============================================================
            
            // Editor ê¶Œí•œì— ë”°ë¥¸ ì…ë ¥ì°½ í™œì„±í™”/ë¹„í™œì„±í™”
            if (typeof userRole !== 'undefined' && userRole === 'editor') {
                const canEdit = canEditProcess(normalizedProcessId);
                
                if (!canEdit) {
                    // í—ˆìš©ë˜ì§€ ì•Šì€ ê³µì •: ì…ë ¥ì°½ ë¹„í™œì„±í™” (ë³´ê¸°ë§Œ ê°€ëŠ¥ - opacity: 0.25)
                    const workDateInput = document.getElementById('work-date');
                    const columnGridInput = document.getElementById('column-grid-input');
                    const saveButton = document.querySelector('#panel-input button[onclick*="saveSelectedColumns"]');
                    
                    if (workDateInput) {
                        workDateInput.disabled = true;
                        workDateInput.style.opacity = '0.25';
                        workDateInput.title = 'EditorëŠ” ì´ ê³µì •ì„ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ë³´ê¸°ë§Œ ê°€ëŠ¥)';
                    }
                    if (columnGridInput) {
                        columnGridInput.style.pointerEvents = 'none';
                        columnGridInput.style.opacity = '0.25';
                    }
                    if (saveButton) {
                        saveButton.disabled = true;
                        saveButton.style.opacity = '0.25';
                        saveButton.title = 'EditorëŠ” ì´ ê³µì •ì„ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                    }
                } else {
                    // í—ˆìš©ëœ ê³µì •: ì…ë ¥ì°½ í™œì„±í™”
                    const workDateInput = document.getElementById('work-date');
                    const columnGridInput = document.getElementById('column-grid-input');
                    const saveButton = document.querySelector('#panel-input button[onclick*="saveSelectedColumns"]');
                    
                    if (workDateInput) {
                        workDateInput.disabled = false;
                        workDateInput.style.opacity = '1';
                        workDateInput.title = '';
                    }
                    if (columnGridInput) {
                        columnGridInput.style.pointerEvents = 'auto';
                        columnGridInput.style.opacity = '1';
                    }
                    if (saveButton) {
                        saveButton.disabled = false;
                        saveButton.style.opacity = '1';
                        saveButton.title = '';
                    }
                }
                
                // ê³µì •ë³„ ê¸°ë‘¥ ê·¸ë¦¬ë“œ ê¶Œí•œ ì ìš©
                applyProcessPermissionToColumnGrid();
            }
            
            // ê³µì •ë³„ ì…ë ¥ ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
            if (typeof showProcessGuide === 'function') {
                showProcessGuide(normalizedProcessId);
            }
            
            // ì¼ì¼ ì…ë ¥ íŒ¨ë„ ìë™ìœ¼ë¡œ ì—´ê¸°
            if (window.showPanel) {
                window.showPanel('input', null);
            } else {
                // showPanelì´ ì—†ì„ ê²½ìš° ì§ì ‘ ì²˜ë¦¬
                const inputPanel = document.getElementById('panel-input');
                if (inputPanel) {
                    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                    inputPanel.classList.add('active');
                    document.querySelectorAll('.tabs .tab-btn').forEach(btn => btn.classList.remove('active'));
                }
            }
            
            // ê·¸ë¦¬ë“œ ë Œë”ë§
            if (typeof renderColumnGrid === 'function') {
                renderColumnGrid('column-grid-input');
            }
        };

        // Constants
        const TOTAL_COLUMNS = 50; // ê¸°ë‘¥ ê°œìˆ˜ (ê° ê¸°ë‘¥ë§ˆë‹¤ 2ê°œ ì„œë¸Œ í•­ëª©)
        const SUB_ITEMS_PER_COLUMN = 2; // ê° ê¸°ë‘¥ë‹¹ ì„œë¸Œ í•­ëª© ê°œìˆ˜
        const TOTAL_PROGRESS_ITEMS = 100; // ì „ì²´ ê¸°ë‘¥ìˆ˜ 100ê°œ ê¸°ì¤€ ì§„í–‰ë¥ (100ê°œ ì™„ë£Œ = 100%)
        const START_DATE = new Date('2025-12-26');
        const END_DATE = new Date('2026-04-30');
        
        // TC í˜•ì‹ì„ ì‚¬ìš©í•˜ëŠ” ê¸°ë‘¥ ë²ˆí˜¸ ëª©ë¡ (7, 8, 15, 17, 36, 38, 39, 40, 43)
        const TC_COLUMN_INDICES = [7, 8, 15, 17, 36, 38, 39, 40, 43];
        
        // ê¸°ë‘¥ ID ìƒì„± í•¨ìˆ˜: columnIndex(1-50), subIndex(1-2) -> "1C001", "1C002" ë˜ëŠ” "7TC001", "7TC002" í˜•ì‹
        function getColumnId(columnIndex, subIndex) {
            const prefix = TC_COLUMN_INDICES.includes(columnIndex) ? 'TC' : 'C';
            return `${columnIndex}${prefix}${String(subIndex).padStart(3, '0')}`;
        }
        
        // ê¸°ë‘¥ IDì—ì„œ ê¸°ë‘¥ ë²ˆí˜¸ ì¶”ì¶œ: "1C001" ë˜ëŠ” "7TC001" -> 1 ë˜ëŠ” 7. "1", "2" ë“± ìˆ«ìë§Œ ìˆì–´ë„ ì¸ì‹
        function getColumnIndexFromId(colId) {
            const str = String(colId ?? '').trim();
            if (/^\d+$/.test(str)) return parseInt(str, 10);
            const match = str.match(/^(\d+)(?:TC|C)/);
            return match ? parseInt(match[1], 10) : null;
        }
        
        // dailyData ê¸°ì¤€ìœ¼ë¡œ í•´ë‹¹ ê¸°ë‘¥ì˜ ìµœëŒ€ ì™„ë£Œ ê³µì • ë²ˆí˜¸ ë°˜í™˜ (ì†Œë¶€ì¬ì¡°ë¦½(4) í¬í•¨)
        function getColumnStatus(colId) {
            const colStr = String(colId);
            const colNum = getColumnIndexFromId(colStr) || parseInt(colStr.replace(/[^0-9]/g, ''), 10);
            let maxStatus = 0;
            for (let date in dailyData) {
                if (!dailyData[date]) continue;
                for (let p = 1; p <= 6; p++) {
                    const arr = dailyData[date][p];
                    if (!arr || !Array.isArray(arr)) continue;
                    const has = arr.some(col => {
                        if (col === colId || col === colStr) return true;
                        if (typeof col === 'number' && col === colNum) return true;
                        if (String(col) === colStr) return true;
                        const cNum = getColumnIndexFromId(String(col)) || parseInt(String(col).replace(/[^0-9]/g, ''), 10);
                        return !isNaN(cNum) && cNum === colNum;
                    });
                    if (has) maxStatus = Math.max(maxStatus, p);
                }
            }
            return maxStatus;
        }
        
        // ê¸°ë‘¥ IDì—ì„œ ì„œë¸Œ ì¸ë±ìŠ¤ ì¶”ì¶œ: "1C001" ë˜ëŠ” "7TC001" -> 1
        function getSubIndexFromId(colId) {
            const match = colId.match(/(?:TC|C)(\d+)$/);
            return match ? parseInt(match[1]) : null;
        }

        // col ê°’ì„ í•­ìƒ ë§¤ì¹­ ê°€ëŠ¥í•œ ë¬¸ìì—´ë¡œ ë³€í™˜ (ê°ì²´/ë¬¸ìì—´/ìˆ«ì ëª¨ë‘ ì²˜ë¦¬)
        function normalizeColValue(col) {
            if (col == null) return '';
            if (typeof col === 'string' || typeof col === 'number') return String(col).trim();
            const candidate = col.colId ?? col.columnId ?? col.id ?? col.col ?? col.no ?? col.dno ?? col.column ?? col.name ?? '';
            return String(candidate ?? '').trim();
        }

        // transportVolumeData í•­ëª©ì—ì„œ ê¸°ë‘¥ ì‹ë³„ê°’ ì¶”ì¶œ (no ì—†ì„ ë•Œ ë‹¤ë¥¸ í‚¤ ìë™ íƒìƒ‰)
        function getTransportColNo(d) {
            if (!d) return '';
            if (d.no != null && String(d.no).trim() !== '') return String(d.no).trim();
            const directKeys = ['dno', 'DNO', 'col', 'COL', 'column', 'COLUMN', 'colNo', 'COLNO', 'columnNo', 'COLUMNNO', 'col_id', 'column_id'];
            for (const k of directKeys) {
                if (d[k] != null && String(d[k]).trim() !== '') return String(d[k]).trim();
            }
            const keys = Object.keys(d);
            for (const k of keys) {
                const lk = k.toLowerCase();
                if (lk === 'weight') continue;
                if (lk.includes('no') || lk.includes('col') || lk.includes('column')) {
                    const v = d[k];
                    if (v != null && String(v).trim() !== '') return String(v).trim();
                }
            }
            return '';
        }

        /** PDF/autoTableìš©: ê¸°ë‘¥ë²ˆí˜¸(colNo)ì— í•´ë‹¹í•˜ëŠ” ìš´ì†¡ì°¨ìˆ˜ê³„íš(13ì°¨) ì°¨ìˆ˜Â·ë‚ ì§œ */
        function getTransportPlanTripForColumn(colNo) {
            if (!colNo || !transportPlan || !Object.keys(transportPlan).length) return null;
            var colNoStr = String(colNo);
            var colIndex = getColumnIndexFromId(colNoStr);
            var colSubIndex = getSubIndexFromId(colNoStr);
            for (var tripNum in transportPlan) {
                var tripData = transportPlan[tripNum];
                if (!tripData || !tripData.columns || !tripData.columns.length) continue;
                var found = tripData.columns.some(function(col) {
                    var colStr = String(col);
                    if (colStr === colNoStr) return true;
                    var si = getColumnIndexFromId(colStr), ss = getSubIndexFromId(colStr);
                    if (colIndex && si && colIndex === si) {
                        if (colSubIndex && ss) return colSubIndex === ss;
                        return true;
                    }
                    var cn = parseInt(colStr.replace(/[^0-9]/g, ''), 10);
                    var cno = parseInt(colNoStr.replace(/[^0-9]/g, ''), 10);
                    if (cn && cno && cn === cno) return true;
                    return false;
                });
                if (found) return parseInt(tripNum, 10);
            }
            return null;
        }
        function getTransportPlanDateForColumn(colNo) {
            var trip = getTransportPlanTripForColumn(colNo);
            if (trip == null) return '';
            var t = transportPlan[trip];
            return (t && t.date) ? t.date : '';
        }
        function getAdjustedPlanTripForColumn(colNo) {
            if (!colNo || !adjustedTransportPlan || !Object.keys(adjustedTransportPlan).length) return null;
            var colNoStr = String(colNo);
            var colIndex = getColumnIndexFromId(colNoStr);
            var colSubIndex = getSubIndexFromId(colNoStr);
            for (var tripNum in adjustedTransportPlan) {
                var tripData = adjustedTransportPlan[tripNum];
                if (!tripData || !tripData.columns || !tripData.columns.length) continue;
                var found = tripData.columns.some(function(col) {
                    var colStr = String(col);
                    if (colStr === colNoStr) return true;
                    var si = getColumnIndexFromId(colStr), ss = getSubIndexFromId(colStr);
                    if (colIndex && si && colIndex === si) {
                        if (colSubIndex && ss) return colSubIndex === ss;
                        return true;
                    }
                    var cn = parseInt(colStr.replace(/[^0-9]/g, ''), 10);
                    var cno = parseInt(colNoStr.replace(/[^0-9]/g, ''), 10);
                    if (cn && cno && cn === cno) return true;
                    return false;
                });
                if (found) return parseInt(tripNum, 10);
            }
            return null;
        }
        function getAdjustedPlanDateForColumn(colNo) {
            var trip = getAdjustedPlanTripForColumn(colNo);
            if (trip == null) return '';
            var t = adjustedTransportPlan[trip];
            return (t && t.date) ? t.date : '';
        }

        // ê¸°ë‘¥ ë§¤ì¹­: col(adjustedTransportPlan ë‚´)ì™€ colNo(transportVolumeData)ê°€ ê°™ì€ ê¸°ë‘¥ì¸ì§€
        function columnsMatch(col, colNo) {
            if (!colNo) return false;
            const colStr = String(col).trim();
            const colNoStr = String(colNo).trim();
            if (colStr === colNoStr) return true;
            const colIndex = getColumnIndexFromId(colNoStr);
            const storedColIndex = getColumnIndexFromId(colStr);
            const colSubIndex = typeof getSubIndexFromId === 'function' ? getSubIndexFromId(colNoStr) : null;
            const storedColSubIndex = typeof getSubIndexFromId === 'function' ? getSubIndexFromId(colStr) : null;
            if (colIndex && storedColIndex && colIndex === storedColIndex) {
                if (colSubIndex && storedColSubIndex) return colSubIndex === storedColSubIndex;
                return true;
            }
            const colNum = parseInt(colStr.replace(/[^0-9]/g, ''), 10);
            const colNoNum = parseInt(colNoStr.replace(/[^0-9]/g, ''), 10);
            return Boolean(colNum && colNoNum && colNum === colNoNum);
        }
        
        // ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš: íŠ¹ì • ê¸°ë‘¥ì˜ ì°¨ìˆ˜ë¥¼ ë³€ê²½ (1~12ì°¨ ì„ íƒ ì‹œ)
        function updateAdjustedPlanTripForColumn(colNo, newTripNum) {
            if (!colNo) return;
            if (!adjustedTransportPlan) adjustedTransportPlan = {};
            const colId = String(colNo).trim();
            // ê¸°ì¡´ ì°¨ìˆ˜ì—ì„œ ì œê±°
            for (let tripNum in adjustedTransportPlan) {
                const tripData = adjustedTransportPlan[tripNum];
                if (tripData && tripData.columns) {
                    tripData.columns = tripData.columns.filter(col => !columnsMatch(col, colId));
                    if (tripData.columns.length === 0) delete adjustedTransportPlan[tripNum];
                }
            }
            const trip = parseInt(newTripNum);
            if (trip >= 1 && trip <= 12) {
                if (!adjustedTransportPlan[trip]) {
                    adjustedTransportPlan[trip] = { columns: [], date: transportPlan[trip]?.date || '' };
                }
                if (!adjustedTransportPlan[trip].columns.some(c => columnsMatch(c, colId))) {
                    adjustedTransportPlan[trip].columns.push(colId);
                    adjustedTransportPlan[trip].columns.sort((a, b) => {
                        const numA = getColumnIndexFromId(String(a)) || parseInt(String(a).replace(/[^0-9]/g, '')) || 0;
                        const numB = getColumnIndexFromId(String(b)) || parseInt(String(b).replace(/[^0-9]/g, '')) || 0;
                        if (numA !== numB) return numA - numB;
                        const subA = getSubIndexFromId(String(a)) || 1;
                        const subB = getSubIndexFromId(String(b)) || 1;
                        return subA - subB;
                    });
                }
                adjustedTransportPlan[trip].date = adjustedTransportPlan[trip].date || transportPlan[trip]?.date || '';
            }
            localStorage.setItem(kcolKey('adjustedTransportPlan'), JSON.stringify(adjustedTransportPlan));
            if (typeof renderTransportVolumeTable === 'function') renderTransportVolumeTable();
            renderAdjustedTripSummarySafe();
            if (typeof renderTransportVolumeTripSummary === 'function') renderTransportVolumeTripSummary();
        }
        
        // ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš: ë¶€ì¬ìˆ˜ +/- ì¡°ì • (-2,-1,0,+1,+2). ë¶€ì¬ìˆœ(ì—‘ì…€ìˆœì„œ)ëŒ€ë¡œ ì°¨ìˆ˜ ì¬ë°°ì¹˜
        function adjustAdjustedTripCount(tripNum, deltaStr) {
            const newDelta = deltaStr === '' ? 0 : parseInt(deltaStr);
            if (isNaN(newDelta) || newDelta < -10 || newDelta > 10) return;
            const trip = parseInt(tripNum);
            if (!adjustedTransportPlan || !transportVolumeData || transportVolumeData.length === 0) return;
            
            const oldDelta = tripCountDeltas[trip] || 0;
            const change = newDelta - oldDelta;
            if (change === 0) return;
            
            tripCountDeltas[trip] = newDelta;
            
            // ëª¨ë“  ì°¨ìˆ˜ì˜ ì»¬ëŸ¼ì„ ì—‘ì…€ìˆœì„œë¡œ ì •ë ¬í•œ ìˆœì„œ êµ¬í•˜ê¸°
            const getExcelOrder = (colId) => {
                const item = transportVolumeData.find(d => {
                    const no = d.no || '';
                    return no === colId || (getColumnIndexFromId(no) === getColumnIndexFromId(colId) && (!getSubIndexFromId(no) || getSubIndexFromId(no) === getSubIndexFromId(colId)));
                });
                return item && item.ì—‘ì…€ìˆœì„œ !== undefined ? item.ì—‘ì…€ìˆœì„œ : 999999;
            };
            
            const sortedTrips = Object.keys(adjustedTransportPlan).map(Number).sort((a, b) => a - b);
            const allColumns = [];
            sortedTrips.forEach(tn => {
                const cols = adjustedTransportPlan[tn]?.columns || [];
                cols.forEach(col => {
                    const c = typeof col === 'number' ? getColumnId(col, 1) : String(col);
                    if (c) allColumns.push({ colId: c, trip: tn, order: getExcelOrder(c) });
                });
            });
            allColumns.sort((a, b) => a.order - b.order);
            
            // ì°¨ìˆ˜ë³„ ê²½ê³„ ì¸ë±ìŠ¤: trip 1ì€ 0..b[1]-1, trip 2ëŠ” b[1]..b[2]-1, ...
            const boundaries = [0];
            sortedTrips.forEach(tn => {
                const count = (adjustedTransportPlan[tn]?.columns || []).length;
                boundaries.push(boundaries[boundaries.length - 1] + count);
            });
            
            const tripIdx = sortedTrips.indexOf(trip);
            if (tripIdx < 0 || tripIdx >= sortedTrips.length - 1) return; // ë§ˆì§€ë§‰ ì°¨ìˆ˜ëŠ” ë‹¤ìŒ ì°¨ìˆ˜ ì—†ìŒ
            const nextTrip = sortedTrips[tripIdx + 1];
            const currStart = boundaries[tripIdx];
            const currEnd = boundaries[tripIdx + 1];
            const nextEnd = boundaries[tripIdx + 2];
            
            if (change > 0) {
                // ì´ë²ˆ ì°¨ìˆ˜ì— ì¶”ê°€: ë‹¤ìŒ ì°¨ìˆ˜ì—ì„œ ì•ì—ì„œë¶€í„° ê°€ì ¸ì˜´
                const takeCount = Math.min(change, nextEnd - currEnd);
                const toMove = allColumns.slice(currEnd, currEnd + takeCount).map(x => x.colId);
                toMove.forEach(colId => {
                    const nextCols = adjustedTransportPlan[nextTrip].columns;
                    const idx = nextCols.findIndex(c => columnsMatch(c, colId));
                    if (idx >= 0) {
                        nextCols.splice(idx, 1);
                        if (!adjustedTransportPlan[trip]) adjustedTransportPlan[trip] = { columns: [], date: '' };
                        adjustedTransportPlan[trip].columns.push(colId);
                    }
                });
            } else if (change < 0) {
                // ì´ë²ˆ ì°¨ìˆ˜ì—ì„œ ì œê±°: ë‹¤ìŒ ì°¨ìˆ˜ ì•ì— ë¶™ì„
                const giveCount = Math.min(-change, currEnd - currStart);
                const toMove = allColumns.slice(currEnd - giveCount, currEnd).map(x => x.colId);
                toMove.forEach(colId => {
                    const currCols = adjustedTransportPlan[trip].columns;
                    const idx = currCols.findIndex(c => columnsMatch(c, colId));
                    if (idx >= 0) {
                        currCols.splice(idx, 1);
                        if (!adjustedTransportPlan[nextTrip]) adjustedTransportPlan[nextTrip] = { columns: [], date: transportPlan[nextTrip]?.date || '' };
                        adjustedTransportPlan[nextTrip].columns.unshift(colId);
                    }
                });
            }
            
            // ì •ë ¬ ìœ ì§€
            [trip, nextTrip].forEach(tn => {
                if (adjustedTransportPlan[tn]?.columns) {
                    adjustedTransportPlan[tn].columns.sort((a, b) => {
                        const oa = getExcelOrder(typeof a === 'number' ? getColumnId(a, 1) : a);
                        const ob = getExcelOrder(typeof b === 'number' ? getColumnId(b, 1) : b);
                        return oa - ob;
                    });
                }
            });
            
            localStorage.setItem(kcolKey('adjustedTransportPlan'), JSON.stringify(adjustedTransportPlan));
            localStorage.setItem(kcolKey('tripCountDeltas'), JSON.stringify(tripCountDeltas));
            if (typeof renderTransportVolumeTable === 'function') renderTransportVolumeTable();
            renderAdjustedTripSummarySafe();
            if (typeof renderTransportVolumeTripSummary === 'function') renderTransportVolumeTripSummary();
        }

        // Project scoping (6 projects)
        // âš ï¸ PROJECT_IDëŠ” ì´ë¯¸ ìƒë‹¨ì— ì •ì˜ë¨ (ì¤‘ë³µ ì •ì˜ ì œê±°)
        
        // ğŸ”’ ë””ë²„ê·¸ ëª¨ë“œ ì„¤ì • (ìš´ì˜ í™˜ê²½ì—ì„œëŠ” falseë¡œ ì„¤ì •)
        // URL íŒŒë¼ë¯¸í„° ?debug=true ë˜ëŠ” localStorageì— 'kcol:debugMode'ê°€ 'true'ì¼ ë•Œë§Œ í™œì„±í™”
        const urlParamsForDebug = new URLSearchParams(window.location.search);
        const DEBUG_MODE = urlParamsForDebug.get('debug') === 'true' || localStorage.getItem('kcol:debugMode') === 'true';

        // í”„ë¡œì íŠ¸ ì´ë¦„ ë§¤í•‘
        const PROJECT_NAMES = {
            'P1': 'ì§„í¥ê¸°ì—…',
            'P2': 'ì—¬ìˆ˜í•™ë™í”„ë¡œì íŠ¸',
            'P3': '00í”„ë¡œì íŠ¸',
            'P4': '00í”„ë¡œì íŠ¸',
            'P5': '00í”„ë¡œì íŠ¸',
            'P6': '00í”„ë¡œì íŠ¸'
        };

        function getProjectName() {
            return PROJECT_NAMES[window.PROJECT_ID] || `í”„ë¡œì íŠ¸ ${window.PROJECT_ID}`;
        }

        function kcolKey(suffix) {
            return `kcol:${window.PROJECT_ID}:${suffix}`;
        }

        // ì‚¬ìš©ì ì—­í•  ê´€ë¦¬ (Firebase + localStorage í•˜ì´ë¸Œë¦¬ë“œ)
        
        // Firebase ì¸ì¦ ìƒíƒœ í™•ì¸
        let firebaseAuth = null;
        let firebaseDb = null;
        let firebaseInitialized = false;
        
        // Firebase ì´ˆê¸°í™” í™•ì¸
        function initFirebase() {
            if (firebaseInitialized) return true;
            
            try {
                if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
                    firebaseAuth = firebase.auth();
                    firebaseDb = firebase.firestore();
                    firebaseInitialized = true;
                    console.log('âœ… Firebase ì´ˆê¸°í™” ì™„ë£Œ');
                    return true;
                }
            } catch (error) {
                console.warn('âš ï¸ Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
            }
            return false;
        }
        
        // ============================================================
        // Firestoreì—ì„œ Project Role ë¡œë“œ (projectId, uid íŒŒë¼ë¯¸í„° ë²„ì „)
        // 
        // âš ï¸ ì¤‘ìš”: Portal Admin â‰  Project Admin
        // - Portal Admin: portal_members/{uid}.portalRole (í¬í„¸ ì „ì²´ ìš´ì˜ ê¶Œí•œ)
        // - Project Admin: projects/{projectId}/members/{uid}.role (í”„ë¡œì íŠ¸ ë‚´ë¶€ ê¶Œí•œ)
        // 
        // ì´ í•¨ìˆ˜ëŠ” ì˜¤ì§ projects/{projectId}/members/{uid}.role ê°’ë§Œ ì½ìŠµë‹ˆë‹¤.
        // email, portalRole, localStorage ê°’ì€ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        // 
        // âš ï¸ Firestoreê°€ ë‹¨ì¼ ì§„ì‹¤ ì†ŒìŠ¤ì…ë‹ˆë‹¤. ë‹¤ë¥¸ ë¡œì§ì´ roleì„ ë®ì–´ì“°ì§€ ì•ŠìŠµë‹ˆë‹¤.
        // âš ï¸ catch / doc ì—†ìŒ ìƒí™©ì˜ ê¸°ë³¸ roleì€ ë¬´ì¡°ê±´ viewer (ë˜ëŠ” ì°¨ë‹¨)
        // âš ï¸ ì–´ë–¤ ê²½ìš°ì—ë„ í•­ìƒ ê°ì²´ë¥¼ ë°˜í™˜í•´ì•¼ í•¨ (undefined ë°˜í™˜ ê¸ˆì§€)
        // ============================================================
        async function loadUserRole(projectId, uid) {
            // ê¸°ë³¸ê°’ ê°ì²´ (í•­ìƒ ë°˜í™˜ ë³´ì¥)
            const defaultResult = { role: 'viewer', allowedProcesses: [], exists: false, permissionDenied: false };
            
            if (!initFirebase()) {
                console.log('[AUTH] Firebaseë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return defaultResult;
            }
            
            try {
                // Firestoreì—ì„œ ì‚¬ìš©ì ì—­í•  ì¡°íšŒ (projects/{projectId}/members/{uid} êµ¬ì¡° ì‚¬ìš©)
                // v8 compat SDK ì‚¬ìš©
                const userDoc = await firebaseDb.collection('projects').doc(projectId)
                    .collection('members').doc(uid).get();
                
                // âœ… snap.exists() ì²´í¬ (snapì´ undefinedì¸ ê²½ìš° ë°©ì§€)
                if (!userDoc || !userDoc.exists) {
                    // âš ï¸ doc ì—†ìŒ ìƒí™©: ë¬´ì¡°ê±´ viewerë¡œ ì²˜ë¦¬
                    console.log('[ROLE] Firestoreì— ì‚¬ìš©ì ì—­í•  ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.');
                    console.log('[ROLE] ê²½ë¡œ: projects/' + projectId + '/members/' + uid);
                    console.log('[ROLE] âš ï¸ members ë¬¸ì„œê°€ ì—†ìœ¼ë¯€ë¡œ viewerë¡œ ì²˜ë¦¬í•˜ê³  ì“°ê¸° ê¸°ëŠ¥ì„ ì°¨ë‹¨í•©ë‹ˆë‹¤.');
                    return { role: 'viewer', allowedProcesses: [], exists: false, permissionDenied: false };
                }
                
                // âœ… snap.data() ì²´í¬
                const userData = userDoc.data();
                if (!userData) {
                    console.warn('[ROLE] ë¬¸ì„œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. viewerë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤.');
                    return defaultResult;
                }
                
                const role = userData.role || 'viewer';
                // allowedProcessesë¥¼ ìˆ«ì ë°°ì—´ë¡œ ì •ê·œí™” (íƒ€ì… ì¼ì¹˜ ë³´ì¥)
                const rawAllowedProcesses = userData.allowedProcesses || [];
                const allowedProcesses = Array.isArray(rawAllowedProcesses) 
                    ? rawAllowedProcesses.map(p => parseInt(p)).filter(p => !isNaN(p))
                    : [];
                
                console.log('[ROLE] Firestoreì—ì„œ ì—­í•  ë¡œë“œ:', role, allowedProcesses);
                
                return { role, allowedProcesses, exists: true, permissionDenied: false };
            } catch (error) {
                // âš ï¸ catch ìƒí™©: ë¬´ì¡°ê±´ viewerë¡œ ì²˜ë¦¬ (ë˜ëŠ” ì°¨ë‹¨)
                console.error('[ROLE] Firebase ì—­í•  ë¡œë“œ ì˜¤ë¥˜:', error);
                
                // ê¶Œí•œ ì˜¤ë¥˜ì¸ ê²½ìš° íŠ¹ë³„ ì²˜ë¦¬
                if (error.code === 'permission-denied') {
                    console.error('[ROLE] âŒ ê¶Œí•œ ì˜¤ë¥˜: members ë¬¸ì„œë¥¼ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    console.error('[ROLE] âš ï¸ ê¶Œí•œ ë¬¸ì œë¡œ ì¸í•´ viewerë¡œ ì²˜ë¦¬í•˜ê³  ì“°ê¸° ê¸°ëŠ¥ì„ ì°¨ë‹¨í•©ë‹ˆë‹¤.');
                    return { role: 'viewer', allowedProcesses: [], exists: false, permissionDenied: true };
                }
                
                // âš ï¸ ê¸°íƒ€ ì˜¤ë¥˜ë„ ë¬´ì¡°ê±´ viewerë¡œ ì²˜ë¦¬
                console.error('[ROLE] âš ï¸ ì˜¤ë¥˜ ë°œìƒìœ¼ë¡œ ì¸í•´ viewerë¡œ ì²˜ë¦¬í•˜ê³  ì“°ê¸° ê¸°ëŠ¥ì„ ì°¨ë‹¨í•©ë‹ˆë‹¤.');
                return defaultResult;
            }
        }
        
        // ============================================================
        // Project Member Role ë¡œë“œ (ìƒˆë¡œìš´ ê°„ë‹¨í•œ ë²„ì „)
        // 
        // âš ï¸ ì¤‘ìš”: Portal Admin â‰  Project Admin
        // - Portal Admin: portal_members/{uid}.portalRole (í¬í„¸ ì „ì²´ ìš´ì˜ ê¶Œí•œ)
        // - Project Admin: projects/{projectId}/members/{uid}.role (í”„ë¡œì íŠ¸ ë‚´ë¶€ ê¶Œí•œ)
        // 
        // ì´ í•¨ìˆ˜ëŠ” ì˜¤ì§ projects/{projectId}/members/{uid}.role ê°’ë§Œ ì½ìŠµë‹ˆë‹¤.
        // email, portalRole, localStorage ê°’ì€ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        // ============================================================
        // ============================================================
        // ì—­í•  ì •ê·œí™” í•¨ìˆ˜
        // ============================================================
        function normalizeRole(v, fallback = "viewer") {
            const s = (v ?? "").toString().trim().toLowerCase();
            return ["admin", "editor", "viewer"].includes(s) ? s : fallback;
        }

        async function loadProjectMemberRole(projectId, uid) {
            // âœ… ë””ë²„ê·¸ ë¡œê·¸ ì¶”ê°€
            console.log("[DEBUG] uid:", uid);
            console.log("[DEBUG] members path: projects/" + projectId + "/members/" + uid);
            
            if (!initFirebase() || !projectId || !uid) {
                console.warn("[loadProjectMemberRole] íŒŒë¼ë¯¸í„° ë¶€ì¡±:", { projectId, uid });
                return { portalRole: "viewer", processRole: "viewer", allowedProcesses: [], exists: false };
            }
            
            // âœ… Firestore getDoc() ì‹¤í–‰: projects/{projectId}/members/{uid} ë¬¸ì„œ ì½ê¸°
            const ref = firebaseDb.collection("projects").doc(projectId)
                .collection("members").doc(uid);
            
            console.log("[loadProjectMemberRole] Firestore getDoc() ì‹¤í–‰:", ref.path);
            
            try {
                const snap = await ref.get(); // âœ… Firestore getDoc() ì™„ë£Œ ëŒ€ê¸°
                console.log("[loadProjectMemberRole] Firestore getDoc() ì™„ë£Œ:", snap.exists);
                
                if (!snap.exists) {
                    console.warn("[loadProjectMemberRole] member doc not found => viewer/viewer");
                    return { portalRole: "viewer", processRole: "viewer", allowedProcesses: [], exists: false, raw: null };
                }
                
                const data = snap.data() || {};
                
                // âœ… portalRole: ì—†ìœ¼ë©´ viewer
                const portalRole = normalizeRole(data.portalRole, "viewer");
                
                // âœ… processRole ìš°ì„ , ì—†ìœ¼ë©´ role(í•˜ìœ„í˜¸í™˜), ê·¸ë˜ë„ ì—†ìœ¼ë©´ viewer
                let processRole = "viewer";
                if (data.processRole != null) {
                    processRole = normalizeRole(data.processRole, "viewer");
                    console.log("[loadProjectMemberRole] âœ… processRole ì‚¬ìš©:", processRole);
                } else if (data.role != null) {
                    processRole = normalizeRole(data.role, "viewer");
                    console.warn("[loadProjectMemberRole] âš ï¸ ê¸°ì¡´ role ì‚¬ìš© (processRoleë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš”):", processRole);
                } else {
                    processRole = "viewer";
                }
                
                // âœ… í•µì‹¬ ì•ˆì „ì¥ì¹˜: portal editorê°€ ê³µì •í‘œ adminì´ ë˜ëŠ” ê²ƒ ë°©ì§€
                // (ì •ì±…ì— ë§ê²Œ ì¡°ì • ê°€ëŠ¥: ë³´í†µ portalRoleì€ ê³µì •í‘œ ê¶Œí•œì— ì˜í–¥ Xê°€ ë” ê¹”ë”í•˜ì§€ë§Œ,
                //  í˜¹ì‹œë¼ë„ ë°ì´í„°ê°€ ì˜ëª» ë“¤ì–´ì™€ë„ ì—¬ê¸°ì„œ 1ì°¨ ë°©ì–´)
                if (portalRole !== "admin" && processRole === "admin") {
                    console.warn("[loadProjectMemberRole] ğŸš« portalRole!=admin ì¸ë° processRole=admin => editorë¡œ ê°•ë“±");
                    processRole = "editor";
                }
                
                const allowedProcesses = Array.isArray(data.allowedProcesses)
                    ? data.allowedProcesses.map(x => parseInt(x, 10)).filter(n => Number.isFinite(n))
                    : [];
                
                // âœ… effectiveRole ê³„ì‚° (portalRole ì •ì±… ì ìš© í›„ ìµœì¢… ì—­í• )
                let effectiveRole = processRole;
                if (portalRole !== "admin" && processRole === "admin") {
                    effectiveRole = "editor"; // portal editorê°€ ê³µì •í‘œ adminì´ ë˜ëŠ” ê²ƒ ë°©ì§€
                }
                
                // âœ… ìƒì„¸ ë¡œê·¸ ì¶œë ¥
                console.log("[loadProjectMemberRole] ì—­í•  ì •ë³´:", {
                    portalRole: portalRole,
                    processRole: processRole,
                    legacyRole: data.role || "(ì—†ìŒ)",
                    effectiveRole: effectiveRole,
                    allowedProcesses: allowedProcesses
                });
                
                return { portalRole, processRole, allowedProcesses, exists: true, raw: data };
            } catch (error) {
                // âœ… ì˜ˆì™¸ ë°œìƒ ì‹œ viewer ë°˜í™˜ (permission-denied í¬í•¨)
                console.error("[loadProjectMemberRole] ì˜¤ë¥˜ ë°œìƒ:", error.code, error.message);
                if (error.code === 'permission-denied') {
                    console.warn("[loadProjectMemberRole] permission-denied â†’ viewer/viewer ë°˜í™˜");
                }
                return { portalRole: "viewer", processRole: "viewer", allowedProcesses: [], exists: false, raw: null };
            }
        }
        
        // ============================================================
        // âœ… ì›ì¹™ 2: "ì ˆëŒ€ ê°•ë“±" ë°©ì§€ - ì—­í•  ì •ê·œí™” ë° ì•ˆì „í•œ ì ìš©
        // ============================================================
        function normalizeRole(r, fallback = "viewer") {
            const s = (r ?? fallback).toString().trim().toLowerCase();
            // âœ… í—ˆìš©ëœ ì—­í•  ê°’ë§Œ í†µê³¼, ê·¸ ì™¸ëŠ” viewerë¡œ ê°•ì œ
            return (s === "admin" || s === "editor" || s === "viewer") ? s : fallback;
        }

        function applyRole(role, allowed, portalRole = null) {
            // âœ… ê³µì •í‘œ ê¶Œí•œì€ ì˜¤ì§ members.processRoleë§Œ ì‚¬ìš© (portalRole ë¬´ê´€)
            // âŒ portalRoleì€ ê³µì •í‘œ ê¶Œí•œ ê²°ì •ì— ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
            const r = normalizeRole(role);
            
            // âœ… ì•ˆì „ì¥ì¹˜: portalRoleì´ ì œê³µë˜ë©´ í™•ì¸í•˜ì—¬ portal editorê°€ ê³µì •í‘œ adminì´ ë˜ëŠ” ê²ƒ ë°©ì§€
            // portalRoleì´ ì œê³µë˜ì§€ ì•Šìœ¼ë©´ loadProjectMemberRole/watchMyMemberDocì—ì„œ ì´ë¯¸ ì•ˆì „ì¥ì¹˜ë¥¼ ê±°ì¹œ ê°’ìœ¼ë¡œ ê°„ì£¼
            let finalRole = r;
            
            if (portalRole !== null) {
                const normalizedPortalRole = normalizeRole(portalRole, "viewer");
                console.log("[APPLY ROLE] ê³µì •í‘œ ê¶Œí•œ ì ìš© ì‹œë„:", r, "portalRole:", normalizedPortalRole);
                
                // ğŸ”¥ í•µì‹¬ ì•ˆì „ì¥ì¹˜: portalRoleì´ adminì´ ì•„ë‹ˆë©´ processRoleì´ adminì´ì–´ë„ editorë¡œ ê°•ë“±
                if (normalizedPortalRole !== "admin" && r === "admin") {
                    console.warn("[APPLY ROLE] ğŸš« portalRole!=admin ì¸ë° processRole=admin => editorë¡œ ê°•ë“±");
                    finalRole = "editor";
                }
            } else {
                // portalRoleì´ ì œê³µë˜ì§€ ì•Šìœ¼ë©´ ì´ë¯¸ ì•ˆì „ì¥ì¹˜ë¥¼ ê±°ì¹œ ê°’ìœ¼ë¡œ ê°„ì£¼
                console.log("[APPLY ROLE] ê³µì •í‘œ ê¶Œí•œ ì ìš©:", r, "(portalRole ë¯¸ì œê³µ - ì´ë¯¸ ì•ˆì „ì¥ì¹˜ ì ìš©ë¨)");
            }
            
            console.log("[APPLY ROLE] ğŸ“‹ ìµœì¢… ì—­í• :", finalRole);
            console.log("[APPLY ROLE]    ê²½ë¡œ: projects/" + window.PROJECT_ID + "/members/" + (firebaseAuth.currentUser?.uid || "N/A"));

            // âœ… ìµœì¢… ì—­í•  ì ìš©
            if (finalRole === "admin") {
                window.userRole = "admin";
                window.allowedProcesses = [];
                userRole = "admin";
                allowedProcesses = [];
                applyRoleBasedUI("admin", []);
                
                // ì „ì²´ ì´ˆê¸°í™” ë²„íŠ¼ í™œì„±í™” (Adminë§Œ)
                const resetAllDataBtn = document.getElementById('reset-all-data-btn');
                if (resetAllDataBtn) {
                    resetAllDataBtn.disabled = false;
                    resetAllDataBtn.style.opacity = '1';
                    resetAllDataBtn.style.cursor = 'pointer';
                    resetAllDataBtn.title = 'ì „ì²´ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤. (ê´€ë¦¬ì ì „ìš©)';
                    console.log("[APPLY ROLE] ì „ì²´ ì´ˆê¸°í™” ë²„íŠ¼ í™œì„±í™”ë¨");
                }
                
                console.log("[APPLY ROLE] admin ì ìš© ì™„ë£Œ (portalRole=" + portalRole + " í™•ì¸ë¨)");
                console.log("[APPLY ROLE] âœ… ê³µì •í‘œ adminì€ ì˜¤ì§ portalRole=admin AND processRole=adminì—ì„œë§Œ ê²°ì •ë¨");
                return;
            }

            if (finalRole === "editor") {
                const arr = Array.isArray(allowed) ? allowed.map(n => parseInt(n, 10)).filter(Number.isFinite) : [];
                window.userRole = "editor";
                window.allowedProcesses = arr;
                userRole = "editor";
                allowedProcesses = arr;
                applyRoleBasedUI("editor", arr);
                
                // ì „ì²´ ì´ˆê¸°í™” ë²„íŠ¼ ë¹„í™œì„±í™” (EditorëŠ” ì‚¬ìš© ë¶ˆê°€)
                const resetAllDataBtn = document.getElementById('reset-all-data-btn');
                if (resetAllDataBtn) {
                    resetAllDataBtn.disabled = true;
                    resetAllDataBtn.style.opacity = '0.5';
                    resetAllDataBtn.style.cursor = 'not-allowed';
                    resetAllDataBtn.title = 'ì „ì²´ ì´ˆê¸°í™”ëŠ” ê´€ë¦¬ì(Admin)ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                }
                
                console.log("[APPLY ROLE] editor ì ìš© ì™„ë£Œ:", arr);
                return;
            }

            // viewer (ê¸°ë³¸ê°’)
            window.userRole = "viewer";
            window.allowedProcesses = [];
            userRole = "viewer";
            allowedProcesses = [];
            applyRoleBasedUI("viewer", []);
            
            // ì „ì²´ ì´ˆê¸°í™” ë²„íŠ¼ ë¹„í™œì„±í™” (ViewerëŠ” ì‚¬ìš© ë¶ˆê°€)
            const resetAllDataBtn = document.getElementById('reset-all-data-btn');
            if (resetAllDataBtn) {
                resetAllDataBtn.disabled = true;
                resetAllDataBtn.style.opacity = '0.5';
                resetAllDataBtn.style.cursor = 'not-allowed';
                resetAllDataBtn.title = 'ì „ì²´ ì´ˆê¸°í™”ëŠ” ê´€ë¦¬ì(Admin)ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
            }
            
            console.log("[APPLY ROLE] viewer ì ìš© ì™„ë£Œ");
        }

        // ============================================================
        // Firestoreì—ì„œ Project Role ë¡œë“œ (ê¸°ì¡´ í•¨ìˆ˜ - í˜¸í™˜ì„± ìœ ì§€)
        // loadProjectMemberRoleì„ ì‚¬ìš©í•˜ë„ë¡ ë˜í•‘
        // ============================================================
        // í”„ë¡œì íŠ¸ ê¶Œí•œ ì´ˆê¸°í™” í•¨ìˆ˜
        // ë¡œê·¸ì¸ ì§í›„/í”„ë¡œì íŠ¸ ì„ íƒ ì§í›„ì— í•œ ë²ˆë§Œ ì‹¤í–‰
        // ============================================================
        async function initProjectPermission(projectId) {
            if (!projectId) {
                console.warn('[PERM] initProjectPermission: PROJECT_ID ì—†ìŒ');
                return;
            }
            
            const uid = firebaseAuth.currentUser?.uid;
            if (!uid) {
                console.warn('[PERM] initProjectPermission: ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ì—†ìŒ');
                return;
            }
            
            console.log('[PERM] initProjectPermission ì‹œì‘:', { projectId, uid });
            
            const result = await loadProjectMemberRole(projectId, uid);
            
            if (result && result.exists) {
                // âœ… effectiveRole ê³„ì‚° (portalRole ì •ì±… ì ìš© í›„ ìµœì¢… ì—­í• )
                let effectiveRole = result.processRole;
                if (result.portalRole !== "admin" && result.processRole === "admin") {
                    effectiveRole = "editor"; // portal editorê°€ ê³µì •í‘œ adminì´ ë˜ëŠ” ê²ƒ ë°©ì§€
                }
                
                // âœ… ìƒì„¸ ë¡œê·¸ ì¶œë ¥
                console.log('[PERM] initProjectPermission ì™„ë£Œ:', {
                    portalRole: result.portalRole,
                    processRole: result.processRole,
                    legacyRole: result.raw?.role || "(ì—†ìŒ)",
                    effectiveRole: effectiveRole,
                    allowedProcesses: result.allowedProcesses
                });
                
                // âœ… applyRole í•¨ìˆ˜ ì‚¬ìš© (processRoleë§Œ ì „ë‹¬)
                applyRole(result.processRole, result.allowedProcesses, result.portalRole);
            } else {
                // âœ… members ë¬¸ì„œê°€ ì—†ê±°ë‚˜ ì½ê¸° ì‹¤íŒ¨ â†’ viewer + ê³µì •í‘œ íƒ­ ì ê¸ˆ
                console.warn('[PERM] members ë¬¸ì„œ ì—†ìŒ ë˜ëŠ” ì½ê¸° ì‹¤íŒ¨ â†’ viewer + ê³µì •í‘œ íƒ­ ì ê¸ˆ');
                lockScheduleTabs("âš ï¸ ê³µì •í‘œ ì‚¬ì „ë“±ë¡ì´ ë˜ì–´ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.\nê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.");
                applyRole("viewer", []);
                // âŒ ì—¬ê¸°ì„œ returní•˜ì—¬ ë¦¬ìŠ¤ë„ˆ ì‹œì‘ ì°¨ë‹¨ (ì´ë¯¸ gateì—ì„œ ì²˜ë¦¬ë˜ì§€ë§Œ ì´ì¤‘ ì•ˆì „ì¥ì¹˜)
                throw new Error("members ë¬¸ì„œ ì—†ìŒ - ê³µì •í‘œ ì ‘ê·¼ ì°¨ë‹¨");
            }
        }
        
        // ============================================================
        // membersì—ì„œ ì½ì€ roleì„ userRoleì— ê°•ì œ ê³ ì •í•˜ëŠ” í•¨ìˆ˜
        // ë¡œê·¸ì¸ ì§í›„/í”„ë¡œì íŠ¸ ì„ íƒ ì§í›„ì— í•œ ë²ˆë§Œ ì‹¤í–‰
        // ============================================================
        async function loadMemberAndSetPermission(uid) {
            if (!uid || !window.PROJECT_ID) {
                console.warn('[PERM] loadMemberAndSetPermission: uid ë˜ëŠ” PROJECT_ID ì—†ìŒ');
                return;
            }
            
            const result = await loadProjectMemberRole(window.PROJECT_ID, uid);
            if (result && result.exists) {
                // âœ… processRole ì‚¬ìš© (ì•ˆì „ì¥ì¹˜ ì ìš©ë¨)
                const processRole = result.processRole || "viewer";
                const allowed = Array.isArray(result.allowedProcesses) ? result.allowedProcesses : [];
                
                console.log('[PERM] portalRole:', result.portalRole, '(í¬í„¸ UIìš©)');
                console.log('[PERM] processRole:', processRole, '(ê³µì •í‘œ ê¶Œí•œìš©)');
                console.log('[PERM] allowedProcesses:', allowed);
                
                // âœ… applyRole í•¨ìˆ˜ ì‚¬ìš© (portalRole í•¨ê»˜ ì „ë‹¬)
                applyRole(processRole, allowed, result.portalRole);
            } else {
                // members ë¬¸ì„œê°€ ì—†ìœ¼ë©´ viewerë¡œ ê³ ì •
                console.log('[PERM] members ë¬¸ì„œ ì—†ìŒ â†’ viewerë¡œ ê³ ì •');
                applyRole("viewer", []);
            }
        }
        
        // ============================================================
        async function loadUserRoleFromFirebase(projectId, uid) {
            // ê¸°ë³¸ê°’ ê°ì²´ (í•­ìƒ ë°˜í™˜ ë³´ì¥)
            const defaultResult = { role: 'viewer', allowedProcesses: [], exists: false };
            
            if (!projectId || !uid) {
                console.warn('[ROLE] projectId ë˜ëŠ” uidê°€ ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. viewerë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤.');
                return defaultResult;
            }
            
            if (!initFirebase()) {
                console.log('[ROLE] Firebaseë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. viewerë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤.');
                return defaultResult;
            }
            
            try {
                // Firestoreì—ì„œ ì‚¬ìš©ì ì—­í•  ì¡°íšŒ (projects/{projectId}/members/{uid} êµ¬ì¡° ì‚¬ìš©)
                // v8 compat SDK ì‚¬ìš©
                const userDoc = await firebaseDb.collection('projects').doc(projectId)
                    .collection('members').doc(uid).get();
                
                // âœ… ë¬¸ì„œ ì¡´ì¬ ì—¬ë¶€ ì²´í¬
                if (!userDoc || !userDoc.exists) {
                    console.log('[ROLE] Firestoreì— ì‚¬ìš©ì ì—­í•  ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.');
                    console.log('[ROLE] ê²½ë¡œ: projects/' + projectId + '/members/' + uid);
                    console.log('[ROLE] âš ï¸ members ë¬¸ì„œê°€ ì—†ìœ¼ë¯€ë¡œ viewerë¡œ ì²˜ë¦¬í•˜ê³  ì“°ê¸° ê¸°ëŠ¥ì„ ì°¨ë‹¨í•©ë‹ˆë‹¤.');
                    return { role: 'viewer', allowedProcesses: [], exists: false, permissionDenied: false };
                }
                
                // âœ… ë¬¸ì„œ ë°ì´í„° ì²´í¬
                const userData = userDoc.data();
                if (!userData) {
                    console.warn('[ROLE] ë¬¸ì„œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. viewerë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤.');
                    return defaultResult;
                }
                
                const role = userData.role || 'viewer';
                // allowedProcessesë¥¼ ìˆ«ì ë°°ì—´ë¡œ ì •ê·œí™” (íƒ€ì… ì¼ì¹˜ ë³´ì¥)
                const rawAllowedProcesses = userData.allowedProcesses || [];
                const allowedProcesses = Array.isArray(rawAllowedProcesses) 
                    ? rawAllowedProcesses.map(x => parseInt(x, 10)).filter(n => Number.isFinite(n))
                    : [];
                
                console.log('[ROLE] Firestoreì—ì„œ ì—­í•  ë¡œë“œ:', role, allowedProcesses);
                
                return { role, allowedProcesses, exists: true, permissionDenied: false };
                
            } catch (error) {
                // âš ï¸ catch ìƒí™©: ë¬´ì¡°ê±´ viewerë¡œ ì²˜ë¦¬ (ë˜ëŠ” ì°¨ë‹¨)
                console.error('[ROLE] Firebase ì—­í•  ë¡œë“œ ì˜¤ë¥˜:', error);
                
                // ê¶Œí•œ ì˜¤ë¥˜ì¸ ê²½ìš° íŠ¹ë³„ ì²˜ë¦¬
                if (error.code === 'permission-denied') {
                    console.error('[ROLE] âŒ ê¶Œí•œ ì˜¤ë¥˜: members ë¬¸ì„œë¥¼ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    console.error('[ROLE] âš ï¸ ê¶Œí•œ ë¬¸ì œë¡œ ì¸í•´ viewerë¡œ ì²˜ë¦¬í•˜ê³  ì“°ê¸° ê¸°ëŠ¥ì„ ì°¨ë‹¨í•©ë‹ˆë‹¤.');
                    return { role: 'viewer', allowedProcesses: [], exists: false, permissionDenied: true };
                }
                
                // âš ï¸ ê¸°íƒ€ ì˜¤ë¥˜ë„ ë¬´ì¡°ê±´ viewerë¡œ ì²˜ë¦¬
                console.error('[ROLE] âš ï¸ ì˜¤ë¥˜ ë°œìƒìœ¼ë¡œ ì¸í•´ viewerë¡œ ì²˜ë¦¬í•˜ê³  ì“°ê¸° ê¸°ëŠ¥ì„ ì°¨ë‹¨í•©ë‹ˆë‹¤.');
                // âœ… ì‹¤íŒ¨í•´ë„ í•­ìƒ ê°ì²´ ë°˜í™˜
                return { role: 'viewer', allowedProcesses: [], exists: false, permissionDenied: false, error: String(error) };
            }
        }
        
        // Firebase ì‹¤ì‹œê°„ ë™ê¸°í™” ë¦¬ìŠ¤ë„ˆ (onSnapshot)
        // âœ… realtimeUnsubscribeëŠ” ìƒë‹¨ ì „ì—­ ë³€ìˆ˜ë¡œ ì´ë¯¸ ì„ ì–¸ë¨ (856ë²ˆ ë¼ì¸)
        let realtimeStatusCheckInterval = null;
        let lastRealtimeUpdateTime = null;
        
        // âœ… role ë³€ê²½ ê°ì§€ìš© ë¦¬ìŠ¤ë„ˆ (self-update ê°€ë“œ ë¬´ì‹œ)
        let memberRoleUnsubscribe = null;
        let myMemberDocUnsubscribe = null;

        // ---------- [A] projects ë¦¬ìŠ¤ë„ˆ: ì§€ìˆ˜ ë°±ì˜¤í”„ ì¬ì‹œë„ ----------
        let listenRetryTimer = null;
        let listenRetryCount = 0;
        function _clearProjectRetry() {
            if (listenRetryTimer) { clearTimeout(listenRetryTimer); listenRetryTimer = null; }
        }
        function _scheduleProjectRetry(startFn) {
            _clearProjectRetry();
            listenRetryCount += 1;
            var delay = Math.min(30000, 1000 * Math.pow(2, Math.min(5, listenRetryCount)));
            console.warn('âš ï¸ [PROJECT] Listen ì¬ì‹œë„ ì˜ˆì•½: ' + delay + 'ms (count=' + listenRetryCount + ')');
            listenRetryTimer = setTimeout(function() { startFn(); }, delay);
        }
        function startProjectListener(projectRef, onData, label) {
            label = label || 'PROJECT';
            if (realtimeUnsubscribe) { try { realtimeUnsubscribe(); } catch (e) {} realtimeUnsubscribe = null; }
            _clearProjectRetry();
            console.log('ğŸ”„ Firebase ì‹¤ì‹œê°„ ë™ê¸°í™” ì‹œì‘:', projectRef.id);
            realtimeUnsubscribe = projectRef.onSnapshot(
                function(docSnapshot) {
                    listenRetryCount = 0;
                    onData(docSnapshot);
                },
                function(err) {
                    console.error('âŒ [' + label + '] onSnapshot error:', err);
                    isApplyingRemoteData = false;
                    if (typeof updateRealtimeConnectionStatus === 'function') updateRealtimeConnectionStatus(false, err && err.message);
                    if (err && err.code === 'permission-denied') {
                        console.warn('ğŸ”’ permission-denied - ì¬ì‹œë„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                        if (typeof showToast === 'function') showToast('âš ï¸ ì‹¤ì‹œê°„ ë™ê¸°í™” ê¶Œí•œ ì˜¤ë¥˜', 'error');
                        return;
                    }
                    if (typeof showToast === 'function') showToast('âš ï¸ ì‹¤ì‹œê°„ ë™ê¸°í™” ì˜¤ë¥˜ - ì¬ì‹œë„ ì˜ˆì •', 'error');
                    _scheduleProjectRetry(function() { startProjectListener(projectRef, onData, label); });
                }
            );
            console.log('âœ… Firebase ì‹¤ì‹œê°„ ë™ê¸°í™” ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì™„ë£Œ');
            return realtimeUnsubscribe;
        }
        function stopProjectListener() {
            _clearProjectRetry();
            if (realtimeUnsubscribe) { try { realtimeUnsubscribe(); } catch (e) {} realtimeUnsubscribe = null; }
            console.log('ğŸ›‘ [PROJECT] ë¦¬ìŠ¤ë„ˆ ì¤‘ì§€ ì™„ë£Œ');
        }

        // ---------- [B] members ì—­í•  ë¦¬ìŠ¤ë„ˆ: ì§€ìˆ˜ ë°±ì˜¤í”„ ì¬ì‹œë„ ----------
        let roleRetryTimer = null;
        let roleRetryCount = 0;
        function _clearRoleRetry() {
            if (roleRetryTimer) { clearTimeout(roleRetryTimer); roleRetryTimer = null; }
        }
        function _scheduleRoleRetry(startFn) {
            _clearRoleRetry();
            roleRetryCount += 1;
            var delay = Math.min(30000, 1000 * Math.pow(2, Math.min(5, roleRetryCount)));
            console.warn('âš ï¸ [ROLE] members ë¦¬ìŠ¤ë„ˆ ì¬ì‹œë„ ì˜ˆì•½: ' + delay + 'ms (count=' + roleRetryCount + ')');
            roleRetryTimer = setTimeout(function() { startFn(); }, delay);
        }
        function startMyMemberDocListener(projectId, uid) {
            if (myMemberDocUnsubscribe) { try { myMemberDocUnsubscribe(); } catch (e) {} myMemberDocUnsubscribe = null; }
            if (memberRoleUnsubscribe) { try { memberRoleUnsubscribe(); } catch (e) {} memberRoleUnsubscribe = null; }
            _clearRoleRetry();
            if (!projectId || !uid) { console.warn('[ROLE] projectId ë˜ëŠ” uid ì—†ìŒ'); return null; }
            var ref = firebaseDb.collection('projects').doc(projectId).collection('members').doc(uid);
            console.log('âœ… [ROLE] members role ë¦¬ìŠ¤ë„ˆ ì‹œì‘: projects/' + projectId + '/members/' + uid);
            myMemberDocUnsubscribe = ref.onSnapshot(
                function(snap) {
                    roleRetryCount = 0;
                    var d = snap.exists ? (snap.data() || {}) : null;
                    var processRole = 'viewer';
                    if (d && d.processRole != null) {
                        processRole = normalizeRole(d.processRole, 'viewer');
                        console.log('[watchMyMemberDoc] âœ… processRole ì‚¬ìš©:', processRole);
                    } else if (d && d.role != null) {
                        processRole = normalizeRole(d.role, 'viewer');
                        console.warn('[watchMyMemberDoc] âš ï¸ ê¸°ì¡´ role ì‚¬ìš©(processRoleë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš”):', processRole);
                    }
                    var portalRole = (d && d.portalRole != null) ? normalizeRole(d.portalRole, 'viewer') : 'viewer';
                    if (portalRole !== 'admin' && processRole === 'admin') {
                        console.warn('[watchMyMemberDoc] ğŸš« portalRole!=admin & processRole=admin => editorë¡œ ê°•ë“±');
                        processRole = 'editor';
                    }
                    var allowed = (d && Array.isArray(d.allowedProcesses)) ? d.allowedProcesses.map(function(x) { return parseInt(x, 10); }).filter(function(n) { return Number.isFinite(n); }) : [];
                    var effectiveRole = processRole;
                    if (!d && typeof showToast === 'function') showToast('âš ï¸ í”„ë¡œì íŠ¸ ë©¤ë²„ê°€ ì•„ë‹™ë‹ˆë‹¤. ì½ê¸° ì „ìš© ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'warning');
                    if (typeof applyRoleBasedUI === 'function') applyRoleBasedUI(effectiveRole, allowed);
                    else if (typeof applyRole === 'function') applyRole(processRole, allowed, portalRole);
                    else { window.userRole = effectiveRole; window.allowedProcesses = allowed; }
                    if (!window.currentProcess && typeof onCurrentProcessReady === 'function' && typeof selectPreocess === 'function' && typeof showPanel === 'function') {
                        onCurrentProcessReady(1); selectPreocess(1); showPanel('input', null);
                    }
                    console.log('ğŸ“¡ [ROLE] members ë¬¸ì„œ ë³€ê²½ ê°ì§€:', snap.exists, { portalRole: portalRole, processRole: processRole, effectiveRole: effectiveRole, allowed: allowed });
                },
                function(err) {
                    console.error('âŒ [ROLE] onSnapshot error:', err);
                    if (err && err.code === 'permission-denied') return;
                    _scheduleRoleRetry(function() { startMyMemberDocListener(projectId, uid); });
                }
            );
            console.log('âœ… [ROLE] members role ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì™„ë£Œ');
            return myMemberDocUnsubscribe;
        }
        function stopMyMemberDocListener() {
            _clearRoleRetry();
            if (myMemberDocUnsubscribe) { try { myMemberDocUnsubscribe(); } catch (e) {} myMemberDocUnsubscribe = null; }
            if (memberRoleUnsubscribe) { try { memberRoleUnsubscribe(); } catch (e) {} memberRoleUnsubscribe = null; }
            console.log('ğŸ›‘ [ROLE] members ë¦¬ìŠ¤ë„ˆ ì¤‘ì§€ ì™„ë£Œ');
        }
        
        // Firebase ì¸ì¦ ìƒíƒœ ë¦¬ìŠ¤ë„ˆ ê´€ë¦¬ (ì¤‘ë³µ ë“±ë¡ ë°©ì§€)
        let authListenerUnsubscribe = null;
        let authListenerInitialized = false;
        
        // ì‹¤ì‹œê°„ ì—°ê²° ìƒíƒœ í‘œì‹œ UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateRealtimeConnectionStatus(isConnected, errorMessage = null) {
            // ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ê²½ìš° ìƒíƒœ í‘œì‹œê¸°ë¥¼ í‘œì‹œí•˜ì§€ ì•ŠìŒ
            if (!initFirebase() || !firebaseAuth.currentUser || firebaseAuth.currentUser.isAnonymous) {
                const statusIndicator = document.getElementById('realtime-status-indicator');
                if (statusIndicator) {
                    statusIndicator.style.display = 'none';
                }
                return;
            }
            
            let statusIndicator = document.getElementById('realtime-status-indicator');
            
            if (!statusIndicator) {
                // ì‹¤ì‹œê°„ ìƒíƒœ í‘œì‹œ UI ìƒì„±
                statusIndicator = document.createElement('div');
                statusIndicator.id = 'realtime-status-indicator';
                statusIndicator.style.cssText = 'position:fixed;bottom:20px;left:20px;background:rgba(0,0,0,0.8);color:white;padding:10px 15px;border-radius:8px;font-size:12px;z-index:9998;min-width:200px;box-shadow:0 2px 8px rgba(0,0,0,0.3);';
                document.body.appendChild(statusIndicator);
            }
            
            // ìƒíƒœ í‘œì‹œê¸° í‘œì‹œ
            statusIndicator.style.display = 'block';
            
            if (isConnected) {
                lastRealtimeUpdateTime = Date.now();
                statusIndicator.innerHTML = `
                    <div style="display:flex;align-items:center;gap:8px;">
                        <span style="display:inline-block;width:10px;height:10px;background:#4caf50;border-radius:50%;animation:pulse 2s infinite;"></span>
                        <span>ğŸ”„ ì‹¤ì‹œê°„ ë™ê¸°í™” í™œì„±</span>
                    </div>
                    <div style="margin-top:5px;font-size:10px;opacity:0.8;" id="realtime-last-update">
                        ì—°ê²°ë¨
                    </div>
                `;
                statusIndicator.style.borderLeft = '4px solid #4caf50';
                
                // í„ìŠ¤ ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
                if (!document.getElementById('realtime-pulse-style')) {
                    const style = document.createElement('style');
                    style.id = 'realtime-pulse-style';
                    style.textContent = `
                        @keyframes pulse {
                            0%, 100% { opacity: 1; }
                            50% { opacity: 0.5; }
                        }
                    `;
                    document.head.appendChild(style);
                }
            } else {
                statusIndicator.innerHTML = `
                    <div style="display:flex;align-items:center;gap:8px;">
                        <span style="display:inline-block;width:10px;height:10px;background:#f44336;border-radius:50%;"></span>
                        <span>âš ï¸ ì‹¤ì‹œê°„ ë™ê¸°í™” ì¤‘ë‹¨</span>
                    </div>
                    <div style="margin-top:5px;font-size:10px;opacity:0.8;">
                        ${errorMessage || 'ì—°ê²° ì˜¤ë¥˜'}
                    </div>
                `;
                statusIndicator.style.borderLeft = '4px solid #f44336';
            }
        }
        
        // ì‹¤ì‹œê°„ ì—°ê²° ìƒíƒœ ì£¼ê¸°ì  í™•ì¸
        function startRealtimeStatusCheck() {
            // ê¸°ì¡´ ì¸í„°ë²Œì´ ìˆìœ¼ë©´ ì œê±°
            if (realtimeStatusCheckInterval) {
                clearInterval(realtimeStatusCheckInterval);
            }
            
            // 5ì´ˆë§ˆë‹¤ ì—°ê²° ìƒíƒœ í™•ì¸
            realtimeStatusCheckInterval = setInterval(() => {
                if (realtimeUnsubscribe) {
                    // ë¦¬ìŠ¤ë„ˆê°€ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
                    const statusIndicator = document.getElementById('realtime-status-indicator');
                    const lastUpdateEl = document.getElementById('realtime-last-update');
                    
                    if (statusIndicator && lastUpdateEl) {
                        if (lastRealtimeUpdateTime) {
                            const timeSinceUpdate = Math.floor((Date.now() - lastRealtimeUpdateTime) / 1000);
                            if (timeSinceUpdate < 60) {
                                lastUpdateEl.textContent = `${timeSinceUpdate}ì´ˆ ì „ ì—…ë°ì´íŠ¸`;
                            } else {
                                const minutes = Math.floor(timeSinceUpdate / 60);
                                lastUpdateEl.textContent = `${minutes}ë¶„ ì „ ì—…ë°ì´íŠ¸`;
                            }
                        } else {
                            lastUpdateEl.textContent = 'ì—°ê²°ë¨ (ëŒ€ê¸° ì¤‘)';
                        }
                    }
                } else {
                    // ë¦¬ìŠ¤ë„ˆê°€ ì—†ìœ¼ë©´ ì—°ê²° ì¤‘ë‹¨ ìƒíƒœ í‘œì‹œ (ë¡œê·¸ì¸ëœ ê²½ìš°ì—ë§Œ)
                    if (initFirebase() && firebaseAuth.currentUser && !firebaseAuth.currentUser.isAnonymous) {
                        updateRealtimeConnectionStatus(false, 'ë¦¬ìŠ¤ë„ˆ ë¯¸ì„¤ì •');
                    }
                }
            }, 5000);
        }
        
        function stopRealtimeStatusCheck() {
            if (realtimeStatusCheckInterval) {
                clearInterval(realtimeStatusCheckInterval);
                realtimeStatusCheckInterval = null;
            }
            
            const statusIndicator = document.getElementById('realtime-status-indicator');
            if (statusIndicator) {
                statusIndicator.remove();
            }
        }
        
        async function setupFirebaseRealtimeListener() {
            console.log('ğŸ” setupFirebaseRealtimeListener í˜¸ì¶œë¨');
            
            if (!initFirebase()) {
                console.error('âŒ Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                updateRealtimeConnectionStatus(false, 'Firebase ë¯¸ì´ˆê¸°í™”');
                return;
            }
            
            if (!firebaseAuth.currentUser) {
                console.warn('âš ï¸ ë¡œê·¸ì¸ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤. ì‹¤ì‹œê°„ ë™ê¸°í™”ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                console.log('ğŸ”’ [ê°€ë“œ] ì¸ì¦ í™•ì¸ ì‹¤íŒ¨ - ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì„¸ìš”.');
                // ë¡œê·¸ì¸ ì „ì—ëŠ” ìƒíƒœ í‘œì‹œê¸°ë¥¼ ìˆ¨ê¹€
                const statusIndicator = document.getElementById('realtime-status-indicator');
                if (statusIndicator) {
                    statusIndicator.style.display = 'none';
                }
                // ë¡œê·¸ì¸ ëª¨ë‹¬ í‘œì‹œ
                if (typeof showLoginModal === 'function') {
                    showLoginModal();
                }
                return;
            }
            
            if (firebaseAuth.currentUser.isAnonymous) {
                console.warn('âš ï¸ ìµëª… ì‚¬ìš©ìëŠ” ì‹¤ì‹œê°„ ë™ê¸°í™”ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                updateRealtimeConnectionStatus(false, 'ìµëª… ì‚¬ìš©ì');
                return;
            }
            
            // ğŸ”’ [ê°€ë“œ] ë©¤ë²„ í™•ì¸ - projects/{projectId}/members/{uid} ì¡´ì¬ ì—¬ë¶€ í™•ì¸
            console.log('ğŸ”’ [ê°€ë“œ] í”„ë¡œì íŠ¸ ë©¤ë²„ í™•ì¸ ì¤‘...');
            console.log('   í”„ë¡œì íŠ¸ ID:', window.PROJECT_ID);
            console.log('   ì‚¬ìš©ì UID:', firebaseAuth.currentUser.uid);
            
            const memberRoleData = await loadUserRoleFromFirebase(window.PROJECT_ID, firebaseAuth.currentUser.uid);
            
            if (!memberRoleData || !memberRoleData.exists) {
                console.error('âŒ [ê°€ë“œ] í”„ë¡œì íŠ¸ ë©¤ë²„ê°€ ì•„ë‹™ë‹ˆë‹¤. ì ‘ê·¼ì´ ì°¨ë‹¨ë©ë‹ˆë‹¤.');
                console.log('ğŸ”’ [ê°€ë“œ] Firestore ê²½ë¡œ: projects/' + window.PROJECT_ID + '/members/' + firebaseAuth.currentUser.uid);
                console.log('ğŸ”’ [ê°€ë“œ] í•´ë‹¹ ê²½ë¡œì— ë©¤ë²„ ë¬¸ì„œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                console.log('ğŸ”’ [ê°€ë“œ] memberRoleData:', memberRoleData);
                
                stopProjectListener();
                stopMyMemberDocListener();

                // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
                const errorMessage = `í”„ë¡œì íŠ¸ ${window.PROJECT_ID}ì— ëŒ€í•œ ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.`;
                showToast(errorMessage, 'error');
                updateRealtimeConnectionStatus(false, 'ì ‘ê·¼ ê¶Œí•œ ì—†ìŒ');
                
                        // ì ‘ê·¼ ì°¨ë‹¨ UI í‘œì‹œ
                        const container = document.querySelector('.container');
                        if (container) {
                            // ë””ë²„ê·¸ ëª¨ë“œì—ì„œë§Œ UID/ê²½ë¡œ í‘œì‹œ
                            const debugInfo = DEBUG_MODE ? `
                                <div style="background:#f5f5f5;padding:15px;border-radius:8px;margin-bottom:20px;text-align:left;">
                                    <strong>í™•ì¸ ì‚¬í•­ (ë””ë²„ê·¸ ëª¨ë“œ):</strong><br>
                                    â€¢ ì‚¬ìš©ì UID: <code style="background:#fff;padding:2px 6px;border-radius:4px;">${firebaseAuth.currentUser.uid}</code><br>
                                    â€¢ í”„ë¡œì íŠ¸ ID: <code style="background:#fff;padding:2px 6px;border-radius:4px;">${window.PROJECT_ID}</code><br>
                                    â€¢ Firestore ê²½ë¡œ: <code style="background:#fff;padding:2px 6px;border-radius:4px;">projects/${window.PROJECT_ID}/members/${firebaseAuth.currentUser.uid}</code>
                                </div>
                            ` : '';
                            
                            container.innerHTML = `
                                <div style="max-width:600px;margin:100px auto;padding:40px;background:white;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.1);text-align:center;">
                                    <h2 style="color:#d32f2f;margin-bottom:20px;">ğŸš« ì ‘ê·¼ ê¶Œí•œ ì—†ìŒ</h2>
                                    <p style="color:#666;margin-bottom:30px;line-height:1.6;">
                                        í”„ë¡œì íŠ¸ <strong>${window.PROJECT_ID}</strong>ì— ëŒ€í•œ ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.<br>
                                        ê´€ë¦¬ìì—ê²Œ ë©¤ë²„ ì¶”ê°€ë¥¼ ìš”ì²­í•˜ì„¸ìš”.
                                    </p>
                                    ${debugInfo}
                                    <div style="display:flex;gap:10px;justify-content:center;margin-top:30px;">
                                        <button onclick="window.location.href='index.html'" style="padding:12px 24px;background:#2c4a7c;color:white;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;">
                                            í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°
                                        </button>
                                        <button onclick="window.location.href='../auth/login.html'" style="padding:12px 24px;background:#4caf50;color:white;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;">
                                            ë¡œê·¸ì¸
                                        </button>
                                    </div>
                                    <div style="margin-top:20px;padding:15px;background:#f5f5f5;border-radius:8px;text-align:left;font-size:12px;color:#666;">
                                        <strong>ğŸ’¡ ì½˜ì†”ì—ì„œ ë¡œê·¸ì¸í•˜ê¸°:</strong><br>
                                        <code style="background:#fff;padding:4px 8px;border-radius:4px;display:block;margin-top:8px;white-space:pre-wrap;word-break:break-all;">
firebase.auth().signInWithEmailAndPassword("email@example.com", "password")
  .then(() => location.reload())
                                        </code>
                                    </div>
                                </div>
                            `;
                        }
                
                return;
            }
            
            console.log('âœ… [ê°€ë“œ] ë©¤ë²„ í™•ì¸ ì™„ë£Œ:', memberRoleData.role, 'í—ˆìš© ê³µì •:', memberRoleData.allowedProcesses);
            console.log('âœ… [ê°€ë“œ] members ë¬¸ì„œ ì¡´ì¬ ì—¬ë¶€:', memberRoleData.exists);
            
            // âœ… members í™•ì¸ í›„ì—ë§Œ ê³µì •í‘œ ì½ê¸° ì‹œì‘ (í•„ìˆ˜)
            // âš ï¸ Firestore Security Rulesê°€ members ê¸°ë°˜ì´ë©´, members í™•ì¸ ì „ì— readë¥¼ ê±¸ë©´ ë§‰í ìˆ˜ ìˆìŒ
            if (!memberRoleData.exists) {
                console.error('âŒ [ê°€ë“œ] ë©¤ë²„ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤. ê³µì •í‘œ ì½ê¸°ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                console.log('ğŸ”’ [ê°€ë“œ] Firestore ê²½ë¡œ: projects/' + window.PROJECT_ID + '/members/' + firebaseAuth.currentUser.uid);
                console.log('ğŸ’¡ members ë¬¸ì„œê°€ ì—†ìœ¼ë©´ projects/{projectId} ë¬¸ì„œ ì½ê¸°ê°€ Security Rulesì—ì„œ ê±°ë¶€ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (memberRoleData.role !== 'admin' && memberRoleData.role !== 'editor' && memberRoleData.role !== 'viewer') {
                console.error('âŒ [ê°€ë“œ] ìœ íš¨í•œ ì—­í• ì´ ì•„ë‹™ë‹ˆë‹¤. ê³µì •í‘œ ì½ê¸°ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                console.log('ğŸ”’ [ê°€ë“œ] í˜„ì¬ ì—­í• :', memberRoleData.role);
                return;
            }
            
            // âœ… members í™•ì¸ ì™„ë£Œ í›„ ê³µì •í‘œ ì½ê¸° ì‹œì‘
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log('âœ… [ê°€ë“œ] members í™•ì¸ ì™„ë£Œ - ê³µì •í‘œ ì½ê¸° ì‹œì‘');
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            
            stopProjectListener();
            stopMyMemberDocListener();
            console.log('ğŸ”„ ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì •ë¦¬ ì™„ë£Œ');

            try {
                // âœ… projectRef ì „ì—­ ì„¤ì •
                projectRef = firebaseDb.collection('projects').doc(window.PROJECT_ID);
                const readPath = `projects/${window.PROJECT_ID}`;
                
                // âœ… ì½ê¸° ê²½ë¡œ ë¡œê·¸ (ê¶Œí•œ ì˜¤ë¥˜ ì§„ë‹¨ìš©)
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                console.log('[READ PATH]', readPath);
                console.log('[ROLE]', memberRoleData.role, '[UID]', firebaseAuth.currentUser.uid);
                console.log('[PROJECT_ID]', window.PROJECT_ID);
                console.log('[ALLOWED_PROCESSES]', memberRoleData.allowedProcesses || []);
                console.log('[MEMBER EXISTS]', memberRoleData.exists);
                console.log('');
                console.log('âš ï¸ [ì¤‘ìš”] í˜„ì¬ êµ¬ì¡°: projects/{projectId} ë¬¸ì„œë¥¼ ì§ì ‘ ì½ê³  ìˆìŠµë‹ˆë‹¤.');
                console.log('âš ï¸ [ì¤‘ìš”] ì´ ë¬¸ì„œì—ëŠ” columnData, dailyData ë“±ì˜ ê³µì •í‘œ ë°ì´í„°ê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
                console.log('');
                console.log('ğŸ’¡ [í•´ê²° ë°©ë²• A - ê¶Œì¥] Firestore Security Rulesì—ì„œ ë£¨íŠ¸ ë¬¸ì„œ read í—ˆìš©:');
                console.log('   match /projects/{projectId} {');
                console.log('     allow read: if request.auth != null');
                console.log('       && !request.auth.token.firebase.sign_in_provider == "anonymous"');
                console.log('       && exists(/databases/$(database)/documents/projects/$(projectId)/members/$(request.auth.uid));');
                console.log('     allow write: if false; // ë˜ëŠ” adminë§Œ');
                console.log('   }');
                console.log('');
                console.log('ğŸ’¡ [í•´ê²° ë°©ë²• B] í•˜ìœ„ ì»¬ë ‰ì…˜ êµ¬ì¡°ë¡œ ë³€ê²½:');
                console.log('   - projects/{projectId}/schedule/{docId}');
                console.log('   - projects/{projectId}/gantt/{docId}');
                console.log('   - projects/{projectId}/processes/{processId}');
                console.log('   (í˜„ì¬ëŠ” ë£¨íŠ¸ ë¬¸ì„œì— ëª¨ë“  ë°ì´í„°ê°€ í¬í•¨ë˜ì–´ ìˆìŒ)');
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                
                console.log('ğŸ”„ Firebase ì‹¤ì‹œê°„ ë™ê¸°í™” ì‹œì‘:', window.PROJECT_ID);
                console.log('ğŸ‘¤ í˜„ì¬ ì‚¬ìš©ì:', firebaseAuth.currentUser.uid, firebaseAuth.currentUser.email);
                console.log('âœ… [ê°€ë“œ] ë©¤ë²„ í™•ì¸ ì™„ë£Œ í›„ onSnapshot ì‹œì‘');
                
                // âœ… initProjectRealtime í•¨ìˆ˜ë¡œ í†µì¼ëœ ì‹¤ì‹œê°„ êµ¬ë… ì´ˆê¸°í™”
                initProjectRealtime(window.PROJECT_ID);
                
                console.log('âœ… Firebase ì‹¤ì‹œê°„ ë™ê¸°í™” ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì™„ë£Œ');
                console.log('ğŸ’¡ ì‹¤ì‹œê°„ ë™ê¸°í™”ê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì‚¬ìš©ìì˜ ë³€ê²½ì‚¬í•­ì´ ìë™ìœ¼ë¡œ ë°˜ì˜ë©ë‹ˆë‹¤.');
                
                // âœ… members/{uid} ë¬¸ì„œì— ëŒ€í•œ role ë³€ê²½ ê°ì§€ ë¦¬ìŠ¤ë„ˆ (ì§€ìˆ˜ ë°±ì˜¤í”„ ì¬ì‹œë„ í¬í•¨)
                startMyMemberDocListener(window.PROJECT_ID, firebaseAuth.currentUser.uid);
                
                // ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì„±ê³µ ì‹œ ì—°ê²° ìƒíƒœ í‘œì‹œ (ì´ˆê¸° ìƒíƒœ)
                updateRealtimeConnectionStatus(true);
                
                // ì²« ë°ì´í„° ìˆ˜ì‹ ì„ ê¸°ë‹¤ë¦¬ì§€ ì•Šê³  ìƒíƒœ ì²´í¬ ì‹œì‘
                setTimeout(() => {
                    if (realtimeUnsubscribe && !realtimeStatusCheckInterval) {
                        startRealtimeStatusCheck();
                    }
                }, 1000);
            } catch (error) {
                console.error('âŒ Firebase ì‹¤ì‹œê°„ ë™ê¸°í™” ì„¤ì • ì‹¤íŒ¨:', error);
                console.error('âŒ ì˜¤ë¥˜ ìƒì„¸:', error.code, error.message);
                console.error('âŒ ìŠ¤íƒ:', error.stack);
                updateRealtimeConnectionStatus(false, error.message || 'ì„¤ì • ì‹¤íŒ¨');
                showToast('âš ï¸ ì‹¤ì‹œê°„ ë™ê¸°í™” ì„¤ì • ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }
        
        // Firebase ì¸ì¦ ìƒíƒœ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        // âš ï¸ ë”± 1ë²ˆë§Œ í˜¸ì¶œë˜ë„ë¡ ë³´ì¥ (flag ì‚¬ìš©, ì¬ë“±ë¡ ì „ unsubscribe)
        function setupFirebaseAuthListener() {
            if (!initFirebase()) {
                console.warn('[AUTH] Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë¦¬ìŠ¤ë„ˆ ë“±ë¡ì„ ê±´ë„ˆëœë‹ˆë‹¤.');
                return;
            }
            
            // ì´ë¯¸ ë“±ë¡ë˜ì–´ ìˆìœ¼ë©´ ì¬ë“±ë¡ ì „ì— ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ í•´ì œ
            if (authListenerInitialized && authListenerUnsubscribe) {
                console.log('[AUTH] ê¸°ì¡´ ì¸ì¦ ë¦¬ìŠ¤ë„ˆ í•´ì œ ì¤‘...');
                authListenerUnsubscribe();
                authListenerUnsubscribe = null;
                authListenerInitialized = false;
            }
            
            // ì´ë¯¸ ë“±ë¡ë˜ì–´ ìˆìœ¼ë©´ ì¬ë“±ë¡ ê¸ˆì§€
            if (authListenerInitialized) {
                console.warn('[AUTH] ì¸ì¦ ë¦¬ìŠ¤ë„ˆê°€ ì´ë¯¸ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì¬ë“±ë¡ì„ ê±´ë„ˆëœë‹ˆë‹¤.');
                return;
            }
            
            console.log('[AUTH] Firebase ì¸ì¦ ìƒíƒœ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì¤‘...');
            
            // ============================================================
            // ë¡œë”© UI í† ê¸€ í•¨ìˆ˜ (ê°„ë‹¨ ë²„ì „)
            // ============================================================
            function setAuthLoading(isLoading) {
                const el = document.getElementById("auth-loading");
                if (!el) return;
                el.style.display = isLoading ? "block" : "none";
            }
            
            // ============================================================
            // ë¡œê·¸ì¸ ìƒíƒœ UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜
            // ============================================================
            function updateLoginStatusUI(user) {
                const loginStatus = document.getElementById('login-status');
                const userInfo = document.getElementById('user-info');
                
                if (user && !user.isAnonymous && user.email) {
                    // ë¡œê·¸ì¸ ìƒíƒœ: login-statusëŠ” ìˆ¨ê¸°ê³  user-infoë§Œ í‘œì‹œ
                    if (loginStatus) {
                        loginStatus.style.display = 'none';
                    }
                    if (userInfo) {
                        userInfo.style.display = 'block';
                    }
                } else {
                    // ë¡œê·¸ì•„ì›ƒ ìƒíƒœ: login-statusë§Œ í‘œì‹œ
                    if (loginStatus) {
                        loginStatus.textContent = 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.';
                        loginStatus.style.color = '#fff9c4';
                        loginStatus.style.display = 'block';
                    }
                    if (userInfo) {
                        userInfo.style.display = 'none';
                    }
                }
            }
            
            // onAuthStateChanged ë¦¬ìŠ¤ë„ˆ ë“±ë¡ (v8 compat API ì‚¬ìš©)
            // âœ… Auth íƒ€ì´ë° ë²„ê·¸ í•´ê²°: ëª¨ë“  ê¶Œí•œ ê´€ë ¨ ì½”ë“œë¥¼ ì—¬ê¸°ì„œë§Œ ì‹¤í–‰
            authListenerUnsubscribe = firebaseAuth.onAuthStateChanged(async (user) => {
                // âœ… STEP 1: Supabase í¬íƒˆ ë¡œê·¸ì¸ ì²´í¬ (í•„ìˆ˜)
                let portalSession = null;
                try {
                    // Supabase í¬íƒˆ ë¡œê·¸ì¸ í™•ì¸ (íƒœë¸”ë¦¿: "Signal is aborted" ì‹œ ì¬ì‹œë„)
                    if (window.SDP && window.SDP.auth) {
                        let lastErr = null;
                        for (let attempt = 0; attempt < 3; attempt++) {
                            try {
                                portalSession = await window.SDP.auth.getSession();
                                break;
                            } catch (e) {
                                lastErr = e;
                                const msg = (e && e.message) ? String(e.message) : '';
                                if ((msg.includes('abort') || msg.includes('Abort') || (e && e.name === 'AbortError')) && attempt < 2) {
                                    await new Promise(r => setTimeout(r, 500 + attempt * 500));
                                    continue;
                                }
                                throw e;
                            }
                        }
                        if (!portalSession) {
                            console.warn("[AUTH] âš ï¸ Supabase í¬íƒˆ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                            lockScheduleTabs("âš ï¸ í¬íƒˆ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.\në¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì„¸ìš”.");
                            showLoginModal();
                            const modeEl = document.getElementById('current-mode');
                            if (modeEl) {
                                modeEl.textContent = 'ğŸ”´ í¬íƒˆ ë¡œê·¸ì¸ í•„ìš”';
                                modeEl.style.color = '#f44336';
                            }
                            setAuthLoading(false);
                            return;
                        }
                        console.log("[AUTH] âœ… Supabase í¬íƒˆ ë¡œê·¸ì¸ í™•ì¸ë¨");
                    } else {
                        console.warn("[AUTH] âš ï¸ Supabase ì¸ì¦ ëª¨ë“ˆì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                        lockScheduleTabs("âš ï¸ ì¸ì¦ ëª¨ë“ˆì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.");
                        setAuthLoading(false);
                        return;
                    }
                } catch (err) {
                    console.error("[AUTH] Supabase í¬íƒˆ ë¡œê·¸ì¸ í™•ì¸ ì‹¤íŒ¨:", err);
                    const isAbort = err && (String(err.message || '').includes('abort') || err.name === 'AbortError');
                    lockScheduleTabs(
                        isAbort
                            ? "âš ï¸ ë„¤íŠ¸ì›Œí¬ê°€ ë¶ˆì•ˆì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\nì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜, í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ ì£¼ì„¸ìš”."
                            : "âš ï¸ í¬íƒˆ ë¡œê·¸ì¸ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\në¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì„¸ìš”."
                    );
                    showLoginModal();
                    setAuthLoading(false);
                    return;
                }
                
                if (!user) {
                    console.log("[AUTH] Firebase ë¡œê·¸ì¸ ëŒ€ê¸° ì¤‘ (í¬íƒˆ ë¡œê·¸ì¸ì€ ì™„ë£Œë¨)");
                    console.log('ğŸ”„ ë¡œê·¸ì•„ì›ƒ - ë¦¬ìŠ¤ë„ˆ í•´ì œ');
                    stopProjectListener();
                    stopMyMemberDocListener();
                    
                    // ì‹¤ì‹œê°„ ìƒíƒœ í™•ì¸ ì¤‘ì§€
                    stopRealtimeStatusCheck();
                    updateRealtimeConnectionStatus(false, 'ë¡œê·¸ì•„ì›ƒë¨');
                    
                    // âœ… ë¡œê·¸ì¸ ìƒíƒœ UI ì—…ë°ì´íŠ¸
                    updateLoginStatusUI(null);
                    
                    // UI ë¹„í™œì„±í™”
                    userRole = null;
                    allowedProcesses = [];
                    window.userRole = "viewer";
                    window.allowedProcesses = [];
                    applyRoleBasedUI("viewer", []);
                    
                    // ë¡œê·¸ì¸ ëª¨ë‹¬ í‘œì‹œ
                    showLoginModal();
                    
                    // ë¡œì»¬ ì €ì¥ ëª¨ë“œë¡œ ì—…ë°ì´íŠ¸
                    const modeEl = document.getElementById('current-mode');
                    if (modeEl) {
                        modeEl.textContent = 'ğŸ”´ Firebase ë¡œê·¸ì¸ í•„ìš” (Email/Password ë¡œê·¸ì¸ í•„ìˆ˜)';
                        modeEl.style.color = '#f44336';
                    }
                    
                    setAuthLoading(false);
                    return;
                }

                // ìµëª… ì‚¬ìš©ì ì¦‰ì‹œ ì°¨ë‹¨
                if (user.isAnonymous) {
                    console.warn('âš ï¸ ìµëª… ë¡œê·¸ì¸ìœ¼ë¡œëŠ” ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì•„ì›ƒí•©ë‹ˆë‹¤.');
                    showToast('ìµëª… ë¡œê·¸ì¸ìœ¼ë¡œëŠ” ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Email/Passwordë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”.', 'error');
                    await firebaseAuth.signOut();
                    return;
                }

                console.log("[AUTH] âœ… í¬íƒˆ ë¡œê·¸ì¸ + Firebase ë¡œê·¸ì¸ ì™„ë£Œ UID:", user.uid);
                
                // window.currentUid ì €ì¥ (ê¶Œí•œ ìš”ì²­ ë¡œê·¸ìš©)
                window.currentUid = user.uid;
                
                // âœ… ë¡œê·¸ì¸ ìƒíƒœ UI ì—…ë°ì´íŠ¸
                const loginStatus = document.getElementById('login-status');
                if (loginStatus && user.email) {
                    loginStatus.textContent = `ë¡œê·¸ì¸: ${user.email}`;
                }
                
                // PROJECT_ID í™•ì¸
                if (!window.PROJECT_ID) {
                    console.error("[AUTH] PROJECT_IDê°€ ì—†ìŠµë‹ˆë‹¤.");
                    window.userRole = "viewer";
                    window.allowedProcesses = [];
                    applyRoleBasedUI("viewer", []);
                    setAuthLoading(false);
                    return;
                }
                
                setAuthLoading(true);
                
                // âœ… STEP 2: ì‚¬ì „ë“±ë¡ ì²´í¬ (members ë¬¸ì„œ ì¡´ì¬ ì—¬ë¶€ í™•ì¸)
                const uid = user.uid;
                const projectId = window.PROJECT_ID; // ì˜ˆ: "P1"
                
                try {
                    const ref = firebaseDb
                        .collection("projects").doc(projectId)
                        .collection("members").doc(uid);
                    
                    const snap = await ref.get();
                    
                    if (!snap.exists) {
                        // ğŸ”’ ì‚¬ì „ë“±ë¡ ì•ˆ ëœ ì‚¬ìš©ì â†’ ê³µì •í‘œ íƒ­ ì ê¸ˆ
                        lockScheduleTabs("âš ï¸ ê³µì •í‘œ ì‚¬ì „ë“±ë¡ì´ ë˜ì–´ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.\nê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.");
                        setAuthLoading(false);
                        return; // ğŸ”¥ ì—¬ê¸°ì„œ ë (ê³µì •í‘œ ë°ì´í„° ë¡œë“œ/ë¦¬ìŠ¤ë„ˆ ì‹œì‘ ê¸ˆì§€)
                    }
                    
                    console.log("[OK] ê³µì •í‘œ ì‚¬ì „ë“±ë¡ ì‚¬ìš©ì:", uid);
                    // âœ… ì—¬ê¸°ë¶€í„°ëŠ” ê¸°ì¡´ ê³µì •í‘œ ë¡œì§(ë¦¬ìŠ¤ë„ˆ/ë°ì´í„° ë¡œë“œ) ê·¸ëŒ€ë¡œ ì‹¤í–‰
                } catch (e) {
                    console.error("[GATE] members í™•ì¸ ì‹¤íŒ¨:", e);
                    lockScheduleTabs("âš ï¸ ê¶Œí•œ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.");
                    setAuthLoading(false);
                    return;
                }
                
                try {
                    // ğŸ”‘ ì—¬ê¸°ì„œë¶€í„° ê¶Œí•œ ë¡œë”© ì‹œì‘ (ë‹¨ì¼ ì§„ì‹¤ ì†ŒìŠ¤)
                    // âœ… gate í†µê³¼ í›„ì—ë§Œ ì‹¤í–‰ë¨
                    await initProjectPermission(window.PROJECT_ID);

                    // âœ… initProjectPermissionì—ì„œ members ë¬¸ì„œ ì—†ìœ¼ë©´ throwí•˜ë¯€ë¡œ
                    // ì—¬ê¸° ë„ë‹¬í–ˆë‹¤ëŠ” ê²ƒì€ members ë¬¸ì„œê°€ ì¡´ì¬í•œë‹¤ëŠ” ì˜ë¯¸
                    // ğŸ”‘ ì‹¤ì‹œê°„ ê°ì‹œ ì‹œì‘ (members ë¬¸ì„œ ë³€ê²½ ê°ì§€)
                    // âœ… gate í†µê³¼ í›„ì—ë§Œ ì‹¤í–‰ë¨
                    watchMyMemberDoc();
                    
                    // ì‹¤ì‹œê°„ ë™ê¸°í™” ì‹œì‘ (admin/editorë§Œ)
                    // âœ… gate í†µê³¼ í›„ì—ë§Œ ì‹¤í–‰ë¨
                    if (userRole === "admin" || userRole === "editor") {
                        if (typeof setupFirebaseRealtimeListener === 'function') {
                            setupFirebaseRealtimeListener();
                        }
                    }
                    
                    // ê²€ì¦ ë¡œê·¸
                    console.log("[UID]", user.uid);
                    console.log("[PROJECT_ID]", window.PROJECT_ID);
                    console.log("[PROJECT ROLE]", window.userRole);
                    console.log("[ADMIN PANEL]", document.getElementById("admin-panel")?.style.display);
                    
                    // Firebase ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
                    const modeEl = document.getElementById('current-mode');
                    if (modeEl) {
                        modeEl.textContent = 'ğŸŸ¢ Firebase ì‹¤ì‹œê°„ ì—°ê²°ë¨';
                        modeEl.style.color = '#4caf50';
                    }
                    showConnectionStatus('ğŸŸ¢ Firebase ì‹¤ì‹œê°„ ì—°ê²°ë¨ - ì‹¤ì‹œê°„ ë™ê¸°í™” ì¤‘');
                    
                    // âœ… ë¡œê·¸ì¸ ìƒíƒœ UI ì—…ë°ì´íŠ¸ (ê¶Œí•œ ë¡œë“œ ì™„ë£Œ í›„, user-infoì— í‘œì‹œë˜ë¯€ë¡œ login-statusëŠ” ìˆ¨ê¹€)
                    updateLoginStatusUI(user);
                    
                    // âœ… ê¶Œí•œ í™•ì¸ ì™„ë£Œ - ë¡œë”© í•´ì œ
                    setAuthLoading(false);
                    
                } catch (err) {
                    // âœ… initProjectPermissionì—ì„œ throwí•œ ê²½ìš° (members ë¬¸ì„œ ì—†ìŒ) ë˜ëŠ” ê¸°íƒ€ ì˜¤ë¥˜
                    if (err.message && err.message.includes("members ë¬¸ì„œ ì—†ìŒ")) {
                        console.error("[AUTH] ê¶Œí•œ ì´ˆê¸°í™” ì‹¤íŒ¨:", err.message);
                        // lockScheduleTabsëŠ” ì´ë¯¸ initProjectPermissionì—ì„œ í˜¸ì¶œë¨
                        setAuthLoading(false);
                        return; // ë¦¬ìŠ¤ë„ˆ ì‹œì‘ ì°¨ë‹¨
                    } else {
                        console.error("[AUTH] ê¶Œí•œ ë¡œë“œ ì‹¤íŒ¨:", err);
                        window.userRole = "viewer";
                        window.allowedProcesses = [];
                        applyRoleBasedUI("viewer", []);
                        setAuthLoading(false);
                    }
                }
            });
            
            // ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ - flag ì„¤ì •
            authListenerInitialized = true;
            console.log('[AUTH] Firebase ì¸ì¦ ìƒíƒœ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ');
        }
        
        // í˜„ì¬ ì‚¬ìš©ì UID ìƒì„±/ê°€ì ¸ì˜¤ê¸° (Firebase ìš°ì„ , ì—†ìœ¼ë©´ localStorage)
        function getCurrentUID() {
            // Firebase ì‚¬ìš©ì ìš°ì„ 
            if (initFirebase()) {
                const user = firebaseAuth.currentUser;
                if (user) {
                    return user.uid;
                }
            }
            
            // Firebaseê°€ ì—†ê±°ë‚˜ ë¡œê·¸ì¸ ì•ˆ ëœ ê²½ìš° localStorage ì‚¬ìš©
            let uid = localStorage.getItem('kcol:currentUid');
            if (!uid) {
                // ê³ ìœ  ID ìƒì„± (íƒ€ì„ìŠ¤íƒ¬í”„ + ëœë¤)
                uid = 'uid_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('kcol:currentUid', uid);
            }
            return uid;
        }
        
        // ============================================================
        // âš ï¸ UID ê¸°ë°˜ Admin íŒë³„ ë¡œì§ ì œê±°ë¨
        // Admin ì—¬ë¶€ëŠ” ì˜¤ì§ Firestore members ë¬¸ì„œì˜ role ê°’ìœ¼ë¡œ ê²°ì •ë©ë‹ˆë‹¤.
        // Firestoreê°€ ê¶Œí•œì˜ ë‹¨ì¼ ì§„ì‹¤ ì†ŒìŠ¤(Single Source of Truth)ì…ë‹ˆë‹¤.
        // ============================================================
        
        // í˜„ì¬ ì‚¬ìš©ì UIDë¥¼ íŠ¹ì • UIDë¡œ ì„¤ì • (ë””ë²„ê·¸ìš©, role ë³€ê²½ ì•ˆ í•¨)
        function setCurrentUID(uid) {
            if (!uid) {
                console.error('âŒ UIDë¥¼ ì œê³µí•´ì£¼ì„¸ìš”.');
                console.log('ì‚¬ìš©ë²•: setCurrentUID("your-uid-here")');
                return;
            }
            
            localStorage.setItem('kcol:currentUid', uid);
            console.log(`âœ… í˜„ì¬ ì‚¬ìš©ì UID ì„¤ì • ì™„ë£Œ: ${uid}`);
            console.log('âš ï¸ ì°¸ê³ : roleì€ Firestore members ë¬¸ì„œì—ì„œë§Œ ê²°ì •ë©ë‹ˆë‹¤.');
            console.log('   roleì„ ë³€ê²½í•˜ë ¤ë©´ Firestoreì—ì„œ members ë¬¸ì„œë¥¼ ìˆ˜ì •í•˜ì„¸ìš”.');
            
            // roleì€ ë³€ê²½í•˜ì§€ ì•ŠìŒ (Firestoreê°€ ë‹¨ì¼ ì§„ì‹¤ ì†ŒìŠ¤)
            applyRoleBasedUI();
            console.log('ğŸ”‘ í˜„ì¬ ì—­í• :', userRole, '(Firestoreì—ì„œ ë¡œë“œë¨)');
        }
        
        // ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ (ë””ë²„ê·¸ìš©)
        window.setCurrentUID = setCurrentUID;
        
        // ============================================================
        // Firebase Admin ì„¤ì • í•¨ìˆ˜ë“¤
        // ============================================================
        
        // ìµëª… ë¡œê·¸ì¸ì€ ë³´ì•ˆìƒ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (Email/Passwordë§Œ í—ˆìš©)
        
        // Firebase Email/Password ë¡œê·¸ì¸ì€ ì§ì ‘ ì‚¬ìš©:
        // firebase.auth().signInWithEmailAndPassword(email, password)
        //   .then(() => location.reload())
        
        // ============================================================
        // Firestoreì— Project Admin ì—­í•  ì„¤ì •
        // 
        // âš ï¸ ì¤‘ìš”: Portal Admin â‰  Project Admin
        // - Portal Admin: portal_members/{uid}.portalRole (í¬í„¸ ì „ì²´ ìš´ì˜ ê¶Œí•œ)
        // - Project Admin: projects/{projectId}/members/{uid}.role (í”„ë¡œì íŠ¸ ë‚´ë¶€ ê¶Œí•œ)
        // 
        // ì´ í•¨ìˆ˜ëŠ” ì˜¤ì§ projects/{projectId}/members/{uid} ê²½ë¡œì—ë§Œ roleì„ ì €ì¥í•©ë‹ˆë‹¤.
        // email, portalRole, localStorage ê°’ì€ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        // ============================================================
        async function setAdminRoleInFirestore(uid) {
            if (!initFirebase()) {
                console.error('âŒ Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return false;
            }
            
            if (!uid) {
                console.error('âŒ UIDë¥¼ ì œê³µí•´ì£¼ì„¸ìš”.');
                return false;
            }
            
            try {
                // âœ… ë°˜ë“œì‹œ projects/{projectId}/members/{uid} ê²½ë¡œì—ë§Œ ì €ì¥
                const writePath = `projects/${window.PROJECT_ID}/members/${uid}`;
                await firebaseDb.collection('projects').doc(window.PROJECT_ID)
                    .collection('members').doc(uid).set({
                        role: 'admin',
                        allowedProcesses: [],
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                
                console.log('âœ… Firestoreì— Project Admin ì—­í•  ì„¤ì • ì™„ë£Œ:', uid);
                console.log('ğŸ“ [WRITE PATH]', writePath);
                console.log('ğŸ“ [ROLE SET]', 'admin');
                console.log('âš ï¸ [í™•ì¸] ì´ ê²½ë¡œëŠ” projects/{projectId}/members/{uid} ì…ë‹ˆë‹¤.');
                console.log('âš ï¸ [í™•ì¸] Portal Admin (portal_members)ê³¼ëŠ” ë³„ê°œì…ë‹ˆë‹¤.');
                
                // âœ… í˜„ì¬ ì‚¬ìš©ìê°€ í•´ë‹¹ UIDì¸ ê²½ìš° members ë¬¸ì„œë¥¼ ë‹¤ì‹œ ì½ì–´ì„œ applyRole í˜¸ì¶œ
                // âŒ ì§ì ‘ userRole ì„¤ì • ê¸ˆì§€ - applyRole í•¨ìˆ˜ë¥¼ í†µí•´ì„œë§Œ ì—­í•  ì ìš©
                const currentUser = firebaseAuth.currentUser;
                if (currentUser && currentUser.uid === uid) {
                    console.log('ğŸ”„ [ROLE] í˜„ì¬ ì‚¬ìš©ì role ë³€ê²½ ê°ì§€ - members ë¬¸ì„œ ì¬ë¡œë“œ');
                    // members ë¬¸ì„œë¥¼ ë‹¤ì‹œ ì½ì–´ì„œ applyRole í˜¸ì¶œ (ë‹¨ì¼ ì§„ì‹¤ ì†ŒìŠ¤)
                    const projectId = window.PROJECT_ID;
                    if (projectId) {
                        loadProjectMemberRole(projectId, uid).then(async result => {
                            if (result && result.exists) {
                                // âœ… processRole ì‚¬ìš© (ì•ˆì „ì¥ì¹˜ ì ìš©ë¨)
                                applyRole(result.processRole, result.allowedProcesses, result.portalRole);
                                console.log('âœ… [ROLE] Admin UI ì¦‰ì‹œ ê°±ì‹  ì™„ë£Œ (applyRole ì‚¬ìš©)');
                                console.log('âœ… [ROLE] portalRole:', result.portalRole, 'processRole:', result.processRole);
                            } else {
                                console.warn('âš ï¸ [ROLE] members ë¬¸ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                                applyRole("viewer", []);
                            }
                        }).catch(async err => {
                            console.error('âŒ [ROLE] members ë¬¸ì„œ ì¬ë¡œë“œ ì‹¤íŒ¨:', err);
                            applyRole("viewer", []);
                        });
                    }
                }
                
                return true;
            } catch (error) {
                console.error('âŒ Firestore ì—­í•  ì„¤ì • ì‹¤íŒ¨:', error);
                alert('ì—­í•  ì„¤ì • ì‹¤íŒ¨: ' + error.message);
                return false;
            }
        }
        
        // Firestoreì— Editor ì—­í•  ì„¤ì •
        async function setEditorRoleInFirestore(uid, allowedProcesses = []) {
            if (!initFirebase()) {
                console.error('âŒ Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return false;
            }
            
            const currentUser = firebaseAuth.currentUser;
            if (!currentUser) {
                throw new Error('ë¡œê·¸ì¸ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤. Editor ì—­í• ì„ ì„¤ì •í•˜ë ¤ë©´ ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.');
            }
            
            // Admin ê¶Œí•œ ì²´í¬ (í´ë¼ì´ì–¸íŠ¸ ì¸¡ í™•ì¸)
            let isCurrentUserAdmin = false;
            try {
                const currentUserRoleDoc = await firebaseDb.collection('projects').doc(window.PROJECT_ID)
                    .collection('members').doc(currentUser.uid).get();
                if (currentUserRoleDoc.exists) {
                    const roleData = currentUserRoleDoc.data();
                    isCurrentUserAdmin = roleData.role === 'admin';
                    console.log('ğŸ” í˜„ì¬ ì‚¬ìš©ì ì—­í•  í™•ì¸:', {
                        uid: currentUser.uid,
                        role: roleData.role,
                        isAdmin: isCurrentUserAdmin
                    });
                } else {
                    console.warn('âš ï¸ í˜„ì¬ ì‚¬ìš©ìì˜ ì—­í•  ë¬¸ì„œê°€ Firestoreì— ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (roleCheckError) {
                console.error('âŒ í˜„ì¬ ì‚¬ìš©ì ì—­í•  í™•ì¸ ì‹¤íŒ¨ (Editor ì„¤ì •):', roleCheckError);
                console.error('   ì˜¤ë¥˜ ì½”ë“œ:', roleCheckError.code);
                console.error('   ì˜¤ë¥˜ ë©”ì‹œì§€:', roleCheckError.message);
                // ì—­í•  í™•ì¸ ì‹¤íŒ¨ ì‹œ userRole ë³€ìˆ˜ í™•ì¸ (ì´ë¯¸ ë¡œë“œëœ ê²½ìš°)
                if (userRole === 'admin') {
                    console.log('ğŸ’¡ userRole ë³€ìˆ˜ì—ì„œ Admin í™•ì¸ë¨');
                    isCurrentUserAdmin = true;
                }
            }
            
            if (!isCurrentUserAdmin) {
                console.error('âŒ Editor ì—­í• ì„ ì„¤ì •í•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                const loggedInUser = firebaseAuth.currentUser;
                if (loggedInUser) {
                    console.log('   í˜„ì¬ ì‚¬ìš©ì UID:', loggedInUser.uid);
                }
                console.log('   í˜„ì¬ ì—­í• :', userRole);
                console.log('ğŸ’¡ Editor ì—­í• ì„ ì„¤ì •í•˜ë ¤ë©´ Adminìœ¼ë¡œ ë¡œê·¸ì¸í•˜ê±°ë‚˜ Adminì—ê²Œ ìš”ì²­í•˜ì„¸ìš”.');
                throw new Error('Admin ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. Adminìœ¼ë¡œ ë¡œê·¸ì¸í•˜ê±°ë‚˜ Adminì—ê²Œ Editor ì„¤ì •ì„ ìš”ì²­í•˜ì„¸ìš”.');
            }
            
            console.log('âœ… Admin ê¶Œí•œ í™•ì¸ ì™„ë£Œ - Editor ì—­í•  ì„¤ì • ì§„í–‰');
            
            if (!uid) {
                console.error('âŒ UIDë¥¼ ì œê³µí•´ì£¼ì„¸ìš”.');
                return false;
            }
            
            if (!Array.isArray(allowedProcesses) || allowedProcesses.length === 0) {
                console.error('âŒ í—ˆìš©í•  ê³µì •ì„ ìµœì†Œ 1ê°œ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return false;
            }
            
            try {
                const processesArray = allowedProcesses.map(p => parseInt(p));
                const roleData = {
                    role: 'editor',
                    allowedProcesses: processesArray,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                console.log('ğŸ“ Firestoreì— Editor ì—­í•  ì €ì¥ ì¤‘...');
                console.log('   í”„ë¡œì íŠ¸:', window.PROJECT_ID);
                console.log('   UID:', uid);
                console.log('   ì—­í•  ë°ì´í„°:', roleData);
                
                // í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ë¡œê·¸ (ì•ˆì „í•˜ê²Œ)
                const loggedInUser = firebaseAuth.currentUser;
                if (loggedInUser) {
                    console.log('   í˜„ì¬ ì‚¬ìš©ì UID:', loggedInUser.uid);
                }
                console.log('   í˜„ì¬ ì‚¬ìš©ì ì—­í• :', userRole);
                
                // ë¬¸ì„œ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ í›„ set ë˜ëŠ” update ì‚¬ìš©
                const projectRef = firebaseDb.collection('projects').doc(window.PROJECT_ID)
                    .collection('members').doc(uid);
                const existingDoc = await projectRef.get();
                if (existingDoc.exists) {
                    console.log('ğŸ“ ê¸°ì¡´ ë¬¸ì„œ ì—…ë°ì´íŠ¸ ì¤‘...');
                    await projectRef.update(roleData);
                } else {
                    console.log('ğŸ“ ìƒˆ ë¬¸ì„œ ìƒì„± ì¤‘...');
                    await projectRef.set(roleData);
                }
                
                // ì €ì¥ í™•ì¸
                const savedDoc = await projectRef.get();
                if (savedDoc.exists) {
                    const savedData = savedDoc.data();
                    console.log('âœ… Firestoreì— Editor ì—­í•  ì„¤ì • ì™„ë£Œ');
                    console.log('   ì €ì¥ëœ ë°ì´í„°:', savedData);
                    console.log('   ì—­í• :', savedData.role);
                    console.log('   í—ˆìš© ê³µì •:', savedData.allowedProcesses);
                } else {
                    console.error('âŒ Firestore ì €ì¥ í™•ì¸ ì‹¤íŒ¨: ë¬¸ì„œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
                
                // âœ… í˜„ì¬ ì‚¬ìš©ìê°€ í•´ë‹¹ UIDì¸ ê²½ìš° ì¦‰ì‹œ UI ê°±ì‹  (self-updateë¼ë„ ë°˜ë“œì‹œ ê°±ì‹ )
                const currentUser = firebaseAuth.currentUser;
                if (currentUser && currentUser.uid === uid) {
                    console.log('ğŸ”„ [ROLE] í˜„ì¬ ì‚¬ìš©ì role ë³€ê²½ ê°ì§€ - ì¦‰ì‹œ UI ê°±ì‹ ');
                    userRole = 'editor';
                    allowedProcesses = processesArray;
                    // âŒ role/UIì—ëŠ” self-update ìŠ¤í‚µ ê¸ˆì§€ - ìµœì‹  ê°’ ì „ë‹¬
                    applyRoleBasedUI('editor', processesArray);
                    renderUIByRole('editor');
                    console.log('âœ… [ROLE] Editor UI ì¦‰ì‹œ ê°±ì‹  ì™„ë£Œ:', processesArray);
                }
                
                return true;
            } catch (error) {
                console.error('âŒ Firestore ì—­í•  ì„¤ì • ì‹¤íŒ¨:', error);
                alert('ì—­í•  ì„¤ì • ì‹¤íŒ¨: ' + error.message);
                return false;
            }
        }
        
        // Firestoreì— Viewer ì—­í•  ì„¤ì •
        async function setViewerRoleInFirestore(uid) {
            if (!initFirebase()) {
                console.error('âŒ Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return false;
            }
            
            if (!uid) {
                console.error('âŒ UIDë¥¼ ì œê³µí•´ì£¼ì„¸ìš”.');
                return false;
            }
            
            try {
                await firebaseDb.collection('projects').doc(window.PROJECT_ID)
                    .collection('members').doc(uid).set({
                        role: 'viewer',
                        allowedProcesses: [],
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                
                console.log('âœ… Firestoreì— Viewer ì—­í•  ì„¤ì • ì™„ë£Œ:', uid);
                
                // í˜„ì¬ ì‚¬ìš©ìê°€ í•´ë‹¹ UIDì¸ ê²½ìš° ì—­í•  ì¬ë¡œë“œ
                const currentUser = firebaseAuth.currentUser;
                if (currentUser && currentUser.uid === uid) {
                    const roleData = await loadUserRoleFromFirebase(window.PROJECT_ID, currentUser.uid);
                    if (roleData) {
                        userRole = roleData.role;
                        allowedProcesses = roleData.allowedProcesses;
                        applyRoleBasedUI();
                    }
                }
                
                return true;
            } catch (error) {
                console.error('âŒ Firestore ì—­í•  ì„¤ì • ì‹¤íŒ¨:', error);
                alert('ì—­í•  ì„¤ì • ì‹¤íŒ¨: ' + error.message);
                return false;
            }
        }
        
        // Viewer UIDë¥¼ ì…ë ¥ë°›ì•„ì„œ Firestoreì— Viewer ì—­í•  ì„¤ì •
        async function setViewerByUID(viewerUID) {
            if (!viewerUID) {
                console.error('âŒ Viewer UIDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                console.log('ì‚¬ìš©ë²•: setViewerByUID("uid-here")');
                return false;
            }
            
            if (!initFirebase()) {
                console.error('âŒ Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return false;
            }
            
            console.log('ğŸ”§ Viewer UID ì…ë ¥:', viewerUID);
            console.log('ğŸ“ Firestoreì— Viewer ì—­í•  ì„¤ì • ì¤‘...');
            
            const success = await setViewerRoleInFirestore(viewerUID);
            
            if (success) {
                console.log('âœ… Viewer ì—­í•  ì„¤ì • ì™„ë£Œ!');
                console.log('ğŸ’¡ ì´ì œ í•´ë‹¹ UIDë¡œ ë¡œê·¸ì¸í•˜ë©´ Viewer ê¶Œí•œ(ì½ê¸° ì „ìš©)ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            }
            
            return success;
        }
        
        // Editor UIDë¥¼ ì…ë ¥ë°›ì•„ì„œ Firestoreì— Editor ì—­í•  ì„¤ì •
        async function setEditorByUID(editorUID, allowedProcesses = []) {
            if (!editorUID) {
                console.error('âŒ Editor UIDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                console.log('ì‚¬ìš©ë²•: setEditorByUID("uid-here", [1, 2, 3])');
                return false;
            }
            
            if (!Array.isArray(allowedProcesses) || allowedProcesses.length === 0) {
                console.error('âŒ í—ˆìš©í•  ê³µì •ì„ ìµœì†Œ 1ê°œ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.');
                console.log('ì‚¬ìš©ë²•: setEditorByUID("uid-here", [1, 2, 3])');
                return false;
            }
            
            if (!initFirebase()) {
                console.error('âŒ Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return false;
            }
            
            console.log('ğŸ”§ Editor UID ì…ë ¥:', editorUID);
            console.log('ğŸ“ í—ˆìš© ê³µì •:', allowedProcesses);
            console.log('ğŸ“ Firestoreì— Editor ì—­í•  ì„¤ì • ì¤‘...');
            
            const success = await setEditorRoleInFirestore(editorUID, allowedProcesses);
            
            if (success) {
                console.log('âœ… Editor ì—­í•  ì„¤ì • ì™„ë£Œ!');
                console.log('ğŸ’¡ ì´ì œ í•´ë‹¹ UIDë¡œ ë¡œê·¸ì¸í•˜ë©´ Editor ê¶Œí•œì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                console.log('ğŸ’¡ í—ˆìš©ëœ ê³µì •:', allowedProcesses.join(', '));
            }
            
            return success;
        }
        
        // Admin UIDë¥¼ ì…ë ¥ë°›ì•„ì„œ Firestoreì— Admin ì—­í•  ì„¤ì •
        async function setAdminByUID(adminUID) {
            if (!adminUID) {
                console.error('âŒ Admin UIDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                console.log('ì‚¬ìš©ë²•: setAdminByUID("42ZPnQyu0uWxjrQ62AhhoWWOseJ2")');
                return false;
            }
            
            if (!initFirebase()) {
                console.error('âŒ Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return false;
            }
            
            console.log('ğŸ”§ Admin UID ì…ë ¥:', adminUID);
            console.log('ğŸ“ Firestoreì— Admin ì—­í•  ì„¤ì • ì¤‘...');
            
            const success = await setAdminRoleInFirestore(adminUID);
            
            if (success) {
                console.log('âœ… Admin ì—­í•  ì„¤ì • ì™„ë£Œ!');
                console.log('ğŸ’¡ ì´ì œ í•´ë‹¹ UIDë¡œ ë¡œê·¸ì¸í•˜ë©´ Admin ê¶Œí•œì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                console.log('âš ï¸ ì°¸ê³ : roleì€ Firestore members ë¬¸ì„œì—ì„œë§Œ ê²°ì •ë©ë‹ˆë‹¤.');
                console.log('   localStorage ê¸°ë°˜ Admin UID ëª©ë¡ì€ ë” ì´ìƒ ì‚¬ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }
            
            return success;
        }
        
        // ê¸°ë³¸ Admin UIDë¥¼ Firestoreì— ìë™ ì„¤ì • (Adminë§Œ ì‹¤í–‰)
        async function ensureDefaultAdminInFirestore() {
            if (!initFirebase()) {
                return;
            }
            
            // ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ê²½ìš° ì‹¤í–‰í•˜ì§€ ì•ŠìŒ
            const currentUser = firebaseAuth.currentUser;
            if (!currentUser || currentUser.isAnonymous) {
                console.log('â„¹ï¸ ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ì‚¬ìš©ìëŠ” ê¸°ë³¸ Admin ì„¤ì •ì„ ê±´ë„ˆëœë‹ˆë‹¤.');
                return;
            }
            
            // í˜„ì¬ ì‚¬ìš©ìê°€ Adminì¸ì§€ í™•ì¸
            try {
                const currentUserRoleDoc = await firebaseDb.collection('projects').doc(window.PROJECT_ID)
                    .collection('members').doc(currentUser.uid).get();
                if (!currentUserRoleDoc.exists || currentUserRoleDoc.data().role !== 'admin') {
                    console.log('â„¹ï¸ Adminì´ ì•„ë‹Œ ì‚¬ìš©ìëŠ” ê¸°ë³¸ Admin ì„¤ì •ì„ ê±´ë„ˆëœë‹ˆë‹¤.');
                    return;
                }
            } catch (error) {
                console.warn('âš ï¸ í˜„ì¬ ì‚¬ìš©ì ì—­í•  í™•ì¸ ì‹¤íŒ¨ (ê¸°ë³¸ Admin ì„¤ì • ê±´ë„ˆëœ€):', error);
                return;
            }
            
            const defaultAdminUID = '42ZPnQyu0uWxjrQ62AhhoWWOseJ2';
            
            try {
                // Firestoreì—ì„œ í•´ë‹¹ UIDì˜ ì—­í•  í™•ì¸
                const userRoleDoc = await firebaseDb.collection('projects').doc(window.PROJECT_ID)
                    .collection('members').doc(defaultAdminUID).get();
                
                if (!userRoleDoc.exists || userRoleDoc.data().role !== 'admin') {
                    console.log('ğŸ”§ ê¸°ë³¸ Admin UIDë¥¼ Firestoreì— ì„¤ì • ì¤‘...');
                    await setAdminRoleInFirestore(defaultAdminUID);
                    console.log('âœ… ê¸°ë³¸ Admin UID ì„¤ì • ì™„ë£Œ:', defaultAdminUID);
                } else {
                    console.log('â„¹ï¸ ê¸°ë³¸ Admin UIDê°€ ì´ë¯¸ Firestoreì— ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                // ê¶Œí•œ ì˜¤ë¥˜ëŠ” ì¡°ìš©íˆ ì²˜ë¦¬ (Adminì´ ì•„ë‹Œ ê²½ìš° ë°œìƒí•  ìˆ˜ ìˆìŒ)
                if (error.code === 'permission-denied') {
                    console.warn('âš ï¸ ê¸°ë³¸ Admin UID ì„¤ì • ê¶Œí•œ ì˜¤ë¥˜ (Adminì´ ì•„ë‹Œ ê²½ìš° ì •ìƒ):', error.message);
                } else {
                    console.warn('âš ï¸ ê¸°ë³¸ Admin UID ì„¤ì • í™•ì¸ ì‹¤íŒ¨:', error);
                }
            }
        }
        
        // í˜„ì¬ ë¡œê·¸ì¸ëœ ì‚¬ìš©ìë¥¼ Adminìœ¼ë¡œ ì„¤ì •
        async function setCurrentUserAsAdmin() {
            if (!initFirebase()) {
                console.error('âŒ Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return false;
            }
            
            const user = firebaseAuth.currentUser;
            if (!user) {
                console.error('âŒ ë¡œê·¸ì¸ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.');
                console.log('ğŸ’¡ ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”:');
                console.log('   - ìµëª… ë¡œê·¸ì¸: (ê¸ˆì§€ë¨)');
                console.log('   - Email: firebase.auth().signInWithEmailAndPassword("email@example.com", "password").then(() => location.reload())');
                return false;
            }
            
            return await setAdminRoleInFirestore(user.uid);
        }
        
        // Firebase ë¡œê·¸ì•„ì›ƒ
        async function logoutFromFirebase() {
            if (!initFirebase()) {
                return;
            }
            
            try {
                await firebaseAuth.signOut();
                console.log('âœ… ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ');
                
                // ğŸ”’ localStorageì—ì„œ role ì½ê¸° ì œê±° - Firestoreê°€ ë‹¨ì¼ ì§„ì‹¤ ì†ŒìŠ¤
                // localStorage ì €ì¥ëœ roleì´ ë‚˜ì¤‘ì— ë®ì–´ì“°ëŠ” ì›ì¸ì´ ë  ìˆ˜ ìˆìŒ
                // ë¡œê·¸ì•„ì›ƒ ì‹œì—ëŠ” viewerë¡œ ì„¤ì •
                userRole = 'viewer';
                allowedProcesses = [];
                applyRoleBasedUI();
                renderUIByRole('viewer'); // âœ… Admin íŒ¨ë„ ìˆ¨ê¹€
            } catch (error) {
                console.error('âŒ ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', error);
            }
        }
        
        // ============================================================
        // ê°œë°œììš© ìºì‹œ ì´ˆê¸°í™” í•¨ìˆ˜
        // ============================================================
        window.clearAppCache = async function() {
            if (!confirm('ìºì‹œë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë‹¤ìŒì„ ìˆ˜í–‰í•©ë‹ˆë‹¤:\n- Firebase Auth ë¡œê·¸ì•„ì›ƒ\n- IndexedDB ì‚­ì œ (Firebase ìºì‹œ)\n- LocalStorage/SessionStorage ì´ˆê¸°í™”\n- í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨')) {
                return;
            }
            
            console.log("[CACHE] ìºì‹œ ì´ˆê¸°í™” ì‹œì‘");
            
            try {
                // Firebase Auth ë¡œê·¸ì•„ì›ƒ
                if (initFirebase() && firebaseAuth.currentUser) {
                    await firebaseAuth.signOut();
                    console.log("[CACHE] Firebase Auth ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ");
                }
                
                // IndexedDB ì‚­ì œ (Firebase ìºì‹œ í¬í•¨)
                if (indexedDB.databases) {
                    const dbs = await indexedDB.databases();
                    console.log("[CACHE] IndexedDB ë°ì´í„°ë² ì´ìŠ¤ ë°œê²¬:", dbs.length);
                    for (const db of dbs) {
                        console.log("[CACHE] IndexedDB ì‚­ì œ:", db.name);
                        indexedDB.deleteDatabase(db.name);
                    }
                }
                
                // LocalStorage / SessionStorage ì´ˆê¸°í™”
                localStorage.clear();
                sessionStorage.clear();
                console.log("[CACHE] LocalStorage/SessionStorage ì´ˆê¸°í™” ì™„ë£Œ");
                
                alert("âœ… ìºì‹œê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.");
                console.log("[CACHE] í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨");
                location.reload(true);
            } catch (error) {
                console.error("[CACHE] ìºì‹œ ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
                alert("ìºì‹œ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
            }
        };
        
        // í˜„ì¬ Firebase ì‚¬ìš©ì ì •ë³´ í™•ì¸
        function checkFirebaseUser() {
            if (!initFirebase()) {
                console.log('âŒ Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const user = firebaseAuth.currentUser;
            if (user) {
                console.log('âœ… í˜„ì¬ Firebase ì‚¬ìš©ì:');
                console.log('   UID:', user.uid);
                console.log('   Email:', user.email || '(Anonymous)');
                console.log('   Provider:', user.providerData[0]?.providerId || 'anonymous');
                console.log('   Is Anonymous:', user.isAnonymous);
                
                // Firestore ì—­í•  í™•ì¸
                loadUserRoleFromFirebase(window.PROJECT_ID, user.uid).then(roleData => {
                    if (roleData) {
                        console.log('   Role:', roleData.role);
                        console.log('   Allowed Processes:', roleData.allowedProcesses);
                    } else {
                        console.log('   Role: (ì„¤ì •ë˜ì§€ ì•ŠìŒ)');
                    }
                });
            } else {
                console.log('â„¹ï¸ ë¡œê·¸ì¸ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.');
                console.log('ğŸ’¡ ë¡œê·¸ì¸ ë°©ë²•:');
                console.log('   - Email: firebase.auth().signInWithEmailAndPassword("email@example.com", "password").then(() => location.reload())');
            }
        }
        
        // Admin ê¶Œí•œ ê²€ì¦ í•¨ìˆ˜
        async function verifyAdminRole() {
            console.log('ğŸ” Admin ê¶Œí•œ ê²€ì¦ ì‹œì‘...');
            
            if (!initFirebase()) {
                console.error('âŒ Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return false;
            }
            
            const user = firebaseAuth.currentUser;
            if (!user) {
                console.error('âŒ ë¡œê·¸ì¸ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.');
                return false;
            }
            
            if (user.isAnonymous) {
                console.error('âŒ ìµëª… ì‚¬ìš©ìëŠ” Admin ê¶Œí•œì„ ê°€ì§ˆ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return false;
            }
            
            try {
                const roleDoc = await firebaseDb.collection('projects').doc(window.PROJECT_ID)
                    .collection('members').doc(user.uid).get();
                
                if (!roleDoc.exists) {
                    console.warn('âš ï¸ Firestoreì— ì—­í•  ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.');
                    console.log('ğŸ’¡ Firestore ê²½ë¡œ: projects/' + window.PROJECT_ID + '/members/' + user.uid);
                    return false;
                }
                
                const roleData = roleDoc.data();
                const isAdmin = roleData.role === 'admin';
                
                console.log('ğŸ“‹ ì—­í•  ì •ë³´:');
                console.log('   UID:', user.uid);
                console.log('   Email:', user.email);
                console.log('   Role:', roleData.role);
                console.log('   Is Admin:', isAdmin);
                console.log('   Allowed Processes:', roleData.allowedProcesses || []);
                console.log('   Project ID:', roleData.projectId || 'N/A');
                
                if (isAdmin) {
                    console.log('âœ… Admin ê¶Œí•œ í™•ì¸ë¨!');
                    console.log('ğŸ’¡ Admin ê¶Œí•œìœ¼ë¡œ ë‹¤ìŒ ì‘ì—…ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤:');
                    console.log('   - ëª¨ë“  ê³µì • ì…ë ¥/ì‚­ì œ');
                    console.log('   - ìš´ì†¡ì°¨ìˆ˜ê³„íš ì…ë ¥');
                    console.log('   - Editor/Viewer ì—­í•  ì„¤ì •');
                    return true;
                } else {
                    console.warn('âš ï¸ Admin ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. í˜„ì¬ ì—­í• :', roleData.role);
                    return false;
                }
            } catch (error) {
                console.error('âŒ Admin ê¶Œí•œ ê²€ì¦ ì‹¤íŒ¨:', error);
                return false;
            }
        }
        
        // ë¡œê·¸ì¸ ëª¨ë‹¬ í‘œì‹œ/ìˆ¨ê¹€ í•¨ìˆ˜
        function showLoginModal() {
            const modal = document.getElementById('login-modal');
            if (modal) {
                modal.style.display = 'flex';
                modal.style.flexDirection = 'column';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                modal.style.zIndex = '10000';
                console.log('âœ… ë¡œê·¸ì¸ ëª¨ë‹¬ í‘œì‹œ');
                console.log('ğŸ’¡ ì½˜ì†”ì—ì„œ ì§ì ‘ ë¡œê·¸ì¸í•˜ë ¤ë©´: firebase.auth().signInWithEmailAndPassword("email@example.com", "password").then(() => location.reload())');
                
                // ì´ë©”ì¼ ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
                const emailInput = document.getElementById('modal-login-email');
                if (emailInput) {
                    setTimeout(() => emailInput.focus(), 100);
                }
            } else {
                console.error('âŒ ë¡œê·¸ì¸ ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                console.log('ğŸ’¡ ì½˜ì†”ì—ì„œ ì§ì ‘ ë¡œê·¸ì¸í•˜ë ¤ë©´: firebase.auth().signInWithEmailAndPassword("email@example.com", "password").then(() => location.reload())');
            }
        }
        
        function hideLoginModal() {
            const modal = document.getElementById('login-modal');
            if (modal) {
                modal.style.display = 'none';
                console.log('âœ… ë¡œê·¸ì¸ ëª¨ë‹¬ ìˆ¨ê¹€');
            }
        }
        
        // ë¹„ë°€ë²ˆí˜¸ ë³´ê¸°/ìˆ¨ê¸°ê¸° í† ê¸€ í•¨ìˆ˜
        function togglePasswordVisibility(inputId, buttonId) {
            const passwordInput = document.getElementById(inputId);
            const toggleButton = document.getElementById(buttonId);
            if (passwordInput && toggleButton) {
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    toggleButton.textContent = 'ğŸ™ˆ';
                    toggleButton.title = 'ë¹„ë°€ë²ˆí˜¸ ìˆ¨ê¸°ê¸°';
                } else {
                    passwordInput.type = 'password';
                    toggleButton.textContent = 'ğŸ‘ï¸';
                    toggleButton.title = 'ë¹„ë°€ë²ˆí˜¸ ë³´ê¸°';
                }
            }
        }
        
        // Admin UID ì…ë ¥ ì²˜ë¦¬ (UIì—ì„œ í˜¸ì¶œ)
        // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
        function showToast(message, type = 'info') {
            // ê¸°ì¡´ í† ìŠ¤íŠ¸ ì œê±°
            const existingToast = document.getElementById('admin-toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            const toast = document.createElement('div');
            toast.id = 'admin-toast';
            
            const colors = {
                'success': { bg: '#4caf50', icon: 'âœ…' },
                'error': { bg: '#f44336', icon: 'âŒ' },
                'warning': { bg: '#ff9800', icon: 'âš ï¸' },
                'info': { bg: '#2196f3', icon: 'â„¹ï¸' }
            };
            
            const color = colors[type] || colors.info;
            
            toast.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: ${color.bg};
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10001;
                font-size: 14px;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 10px;
                animation: slideIn 0.3s ease-out;
                max-width: 400px;
            `;
            
            toast.innerHTML = `
                <span style="font-size: 20px;">${color.icon}</span>
                <span>${message}</span>
            `;
            
            // ì• ë‹ˆë©”ì´ì…˜ ìŠ¤íƒ€ì¼ ì¶”ê°€
            if (!document.getElementById('toast-animations')) {
                const style = document.createElement('style');
                style.id = 'toast-animations';
                style.textContent = `
                    @keyframes slideIn {
                        from {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }
                    @keyframes slideOut {
                        from {
                            transform: translateX(0);
                            opacity: 1;
                        }
                        to {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(toast);
            
            // 3ì´ˆ í›„ ìë™ ì œê±°
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, 300);
            }, 3000);
        }
        
        async function handleAdminUIDInput() {
            const input = document.getElementById('admin-uid-input');
            const statusDiv = document.getElementById('admin-uid-status');
            
            if (!input) {
                console.error('âŒ Admin UID ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                showToast('Admin UID ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            
            // ë¡œê·¸ì¸ ì²´í¬
            if (!initFirebase() || !firebaseAuth.currentUser) {
                showToast('ë¡œê·¸ì¸ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.', 'error');
                alert('ë¡œê·¸ì¸ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € Email/Passwordë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”.\n\në¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ê±°ë‚˜ ì½˜ì†”ì—ì„œ Firebase Authë¥¼ ì§ì ‘ ì‚¬ìš©í•˜ì„¸ìš”.');
                console.error('âŒ Admin ì„¤ì • ì˜¤ë¥˜: ë¡œê·¸ì¸ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € Email/Passwordë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”.');
                console.log('ğŸ’¡ í•´ê²° ë°©ë²•:');
                console.log('   1. ë¡œê·¸ì¸ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ê±°ë‚˜');
                console.log('   2. ë¸Œë¼ìš°ì € ì½˜ì†”(F12)ì—ì„œ ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
                console.log('      firebase.auth().signInWithEmailAndPassword("your-email@example.com", "your-password").then(() => location.reload())');
                console.log('   3. ë¡œê·¸ì¸ ì„±ê³µ í›„ ë‹¤ì‹œ Admin ì„¤ì •ì„ ì‹œë„í•˜ì„¸ìš”.');
                if (statusDiv) {
                    statusDiv.textContent = 'âŒ ë¡œê·¸ì¸ í•„ìš”';
                    statusDiv.style.color = '#ffcdd2';
                }
                return;
            }
            
            const adminUID = input.value.trim();
            
            if (!adminUID) {
                showToast('UIDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                if (statusDiv) {
                    statusDiv.textContent = 'âŒ UIDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                    statusDiv.style.color = '#ffcdd2';
                }
                return;
            }
            
            // UID í˜•ì‹ ê°„ë‹¨ ê²€ì¦
            if (adminUID.length < 10) {
                showToast('UIDê°€ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤. ì˜¬ë°”ë¥¸ UIDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }
            
            showToast('Admin ì„¤ì • ì¤‘...', 'info');
            
            if (statusDiv) {
                statusDiv.textContent = 'â³ ì„¤ì • ì¤‘...';
                statusDiv.style.color = '#fff9c4';
            }
            
            try {
                const success = await setAdminByUID(adminUID);
                
                if (success) {
                    showToast(`Admin ì„¤ì • ì™„ë£Œ!\nUID: ${adminUID.substring(0, 20)}...`, 'success');
                    
                    if (statusDiv) {
                        statusDiv.textContent = 'âœ… Admin ì„¤ì • ì™„ë£Œ!';
                        statusDiv.style.color = '#c8e6c9';
                    }
                    
                    // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                    input.value = '';
                    
                    // 3ì´ˆ í›„ ìƒíƒœ ë©”ì‹œì§€ ì œê±°
                    setTimeout(() => {
                        if (statusDiv) {
                            statusDiv.textContent = '';
                        }
                    }, 3000);
                    
                    // âœ… ì—­í•  ì¬ë¡œë“œ í›„ ì¦‰ì‹œ UI ê°±ì‹  (ìµœì‹  ê°’ ì „ë‹¬)
                    await loadUserRole();
                    // âŒ role/UIì—ëŠ” self-update ìŠ¤í‚µ ê¸ˆì§€ - ìµœì‹  ê°’ ì „ë‹¬
                    applyRoleBasedUI(userRole, allowedProcesses);
                    renderUIByRole(userRole);
                } else {
                    showToast('Admin ì„¤ì • ì‹¤íŒ¨. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.', 'error');
                    if (statusDiv) {
                        statusDiv.textContent = 'âŒ ì„¤ì • ì‹¤íŒ¨. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.';
                        statusDiv.style.color = '#ffcdd2';
                    }
                }
            } catch (error) {
                console.error('âŒ Admin ì„¤ì • ì˜¤ë¥˜:', error);
                showToast(`ì„¤ì • ì˜¤ë¥˜: ${error.message}`, 'error');
                if (statusDiv) {
                    statusDiv.textContent = 'âŒ ì˜¤ë¥˜: ' + error.message;
                    statusDiv.style.color = '#ffcdd2';
                }
            }
        }
        
        // Editor UID ì…ë ¥ ì²˜ë¦¬ (UIì—ì„œ í˜¸ì¶œ)
        async function handleEditorUIDInput() {
            const input = document.getElementById('editor-uid-input');
            const statusDiv = document.getElementById('editor-uid-status');
            const checkboxes = document.querySelectorAll('.editor-process-checkbox:checked');
            
            if (!input) {
                console.error('âŒ Editor UID ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                showToast('Editor UID ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            
            const editorUID = input.value.trim();
            
            if (!editorUID) {
                showToast('UIDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                if (statusDiv) {
                    statusDiv.textContent = 'âŒ UIDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                    statusDiv.style.color = '#ffcdd2';
                }
                return;
            }
            
            // UID í˜•ì‹ ê°„ë‹¨ ê²€ì¦
            if (editorUID.length < 10) {
                showToast('UIDê°€ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤. ì˜¬ë°”ë¥¸ UIDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }
            
            // ì„ íƒëœ ê³µì • í™•ì¸
            const selectedProcesses = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            if (selectedProcesses.length === 0) {
                showToast('ìµœì†Œ 1ê°œ ì´ìƒì˜ ê³µì •ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
                if (statusDiv) {
                    statusDiv.textContent = 'âŒ ê³µì •ì„ ì„ íƒí•´ì£¼ì„¸ìš”.';
                    statusDiv.style.color = '#ffcdd2';
                }
                return;
            }
            
            showToast('Editor ì„¤ì • ì¤‘...', 'info');
            
            if (statusDiv) {
                statusDiv.textContent = 'â³ ì„¤ì • ì¤‘...';
                statusDiv.style.color = '#fff9c4';
            }
            
            try {
                const success = await setEditorByUID(editorUID, selectedProcesses);
                
                if (success) {
                    const processNames = selectedProcesses.map(p => {
                        const proc = PROCESSES.find(pr => pr.id === p);
                        return proc ? `${p}.${proc.name}` : `${p}`;
                    }).join(', ');
                    
                    showToast(`Editor ì„¤ì • ì™„ë£Œ!\nUID: ${editorUID.substring(0, 20)}...\nê³µì •: ${processNames}`, 'success');
                    
                    if (statusDiv) {
                        statusDiv.textContent = `âœ… Editor ì„¤ì • ì™„ë£Œ! (ê³µì •: ${selectedProcesses.join(', ')})`;
                        statusDiv.style.color = '#c8e6c9';
                    }
                    
                    // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                    input.value = '';
                    checkboxes.forEach(cb => cb.checked = false);
                    
                    // 3ì´ˆ í›„ ìƒíƒœ ë©”ì‹œì§€ ì œê±°
                    setTimeout(() => {
                        if (statusDiv) {
                            statusDiv.textContent = '';
                        }
                    }, 3000);
                    
                    // í˜„ì¬ ì‚¬ìš©ìê°€ ì„¤ì •í•œ UIDì¸ ê²½ìš° ì—­í•  ì¬ë¡œë“œ
                    const currentUser = firebaseAuth?.currentUser;
                    if (currentUser && currentUser.uid === editorUID) {
                        console.log('ğŸ”„ í˜„ì¬ ì‚¬ìš©ì ì—­í•  ì¬ë¡œë“œ ì¤‘...');
                        await loadUserRole();
                        applyRoleBasedUI();
                        showToast('Editor ì—­í• ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    } else {
                        console.log('â„¹ï¸ ì„¤ì •í•œ UIDì™€ í˜„ì¬ ë¡œê·¸ì¸í•œ UIDê°€ ë‹¤ë¦…ë‹ˆë‹¤.');
                        console.log('   ì„¤ì •í•œ UID:', editorUID);
                        console.log('   í˜„ì¬ ë¡œê·¸ì¸ UID:', currentUser?.uid || '(ë¡œê·¸ì¸ ì•ˆ ë¨)');
                        console.log('ğŸ’¡ í•´ë‹¹ UIDë¡œ ë¡œê·¸ì¸í•˜ë©´ Editor ê¶Œí•œì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                        
                        // ì—­í•  ì¬ë¡œë“œ (í˜„ì¬ ì‚¬ìš©ììš©)
                        await loadUserRole();
                        applyRoleBasedUI();
                    }
                } else {
                    showToast('Editor ì„¤ì • ì‹¤íŒ¨. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.', 'error');
                    if (statusDiv) {
                        statusDiv.textContent = 'âŒ ì„¤ì • ì‹¤íŒ¨. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.';
                        statusDiv.style.color = '#ffcdd2';
                    }
                }
            } catch (error) {
                console.error('âŒ Editor ì„¤ì • ì˜¤ë¥˜:', error);
                showToast(`ì„¤ì • ì˜¤ë¥˜: ${error.message}`, 'error');
                if (statusDiv) {
                    statusDiv.textContent = 'âŒ ì˜¤ë¥˜: ' + error.message;
                    statusDiv.style.color = '#ffcdd2';
                }
            }
        }
        
        // ì—¬ëŸ¬ Viewer UID ì¼ê´„ ì„¤ì •
        async function setViewersByUIDs(viewerUIDs) {
            if (!Array.isArray(viewerUIDs) || viewerUIDs.length === 0) {
                console.error('âŒ Viewer UID ë°°ì—´ì„ ì œê³µí•´ì£¼ì„¸ìš”.');
                return { success: 0, failed: 0, total: 0 };
            }
            
            if (!initFirebase()) {
                console.error('âŒ Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return { success: 0, failed: viewerUIDs.length, total: viewerUIDs.length };
            }
            
            let successCount = 0;
            let failedCount = 0;
            const failedUIDs = [];
            
            console.log(`ğŸ“ ${viewerUIDs.length}ëª…ì˜ Viewer ì„¤ì • ì‹œì‘...`);
            
            for (const uid of viewerUIDs) {
                const trimmedUID = uid.trim();
                if (!trimmedUID || trimmedUID.length < 10) {
                    failedCount++;
                    failedUIDs.push(trimmedUID || '(ë¹ˆ ê°’)');
                    continue;
                }
                
                try {
                    const success = await setViewerRoleInFirestore(trimmedUID);
                    if (success) {
                        successCount++;
                        console.log(`âœ… Viewer ì„¤ì • ì™„ë£Œ: ${trimmedUID.substring(0, 20)}...`);
                    } else {
                        failedCount++;
                        failedUIDs.push(trimmedUID);
                    }
                } catch (error) {
                    console.error(`âŒ Viewer ì„¤ì • ì‹¤íŒ¨ (${trimmedUID}):`, error);
                    failedCount++;
                    failedUIDs.push(trimmedUID);
                }
            }
            
            console.log(`âœ… Viewer ì¼ê´„ ì„¤ì • ì™„ë£Œ: ì„±ê³µ ${successCount}ëª…, ì‹¤íŒ¨ ${failedCount}ëª…`);
            if (failedUIDs.length > 0) {
                console.log('âŒ ì‹¤íŒ¨í•œ UID:', failedUIDs);
            }
            
            return { success: successCount, failed: failedCount, total: viewerUIDs.length, failedUIDs };
        }
        
        // Viewer UID ì…ë ¥ ì²˜ë¦¬ (UIì—ì„œ í˜¸ì¶œ) - ì¼ê´„ ì„¤ì • ì§€ì›
        async function handleViewerUIDInput() {
            const input = document.getElementById('viewer-uid-input');
            const statusDiv = document.getElementById('viewer-uid-status');
            
            if (!input) {
                console.error('âŒ Viewer UID ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                showToast('Viewer UID ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            
            const viewerUIDInput = input.value.trim();
            
            if (!viewerUIDInput) {
                showToast('UIDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                if (statusDiv) {
                    statusDiv.textContent = 'âŒ UIDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                    statusDiv.style.color = '#ffcdd2';
                }
                return;
            }
            
            // ì‰¼í‘œë¡œ êµ¬ë¶„ëœ ì—¬ëŸ¬ UID ì²˜ë¦¬
            const viewerUIDs = viewerUIDInput.split(',').map(uid => uid.trim()).filter(uid => uid.length > 0);
            
            if (viewerUIDs.length === 0) {
                showToast('ìœ íš¨í•œ UIDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }
            
            // UID í˜•ì‹ ê°„ë‹¨ ê²€ì¦
            const invalidUIDs = viewerUIDs.filter(uid => uid.length < 10);
            if (invalidUIDs.length > 0) {
                showToast(`ë‹¤ìŒ UIDê°€ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤: ${invalidUIDs.join(', ')}`, 'warning');
                return;
            }
            
            if (viewerUIDs.length === 1) {
                // ë‹¨ì¼ Viewer ì„¤ì •
                showToast('Viewer ì„¤ì • ì¤‘...', 'info');
                
                if (statusDiv) {
                    statusDiv.textContent = 'â³ ì„¤ì • ì¤‘...';
                    statusDiv.style.color = '#fff9c4';
                }
                
                try {
                    const success = await setViewerByUID(viewerUIDs[0]);
                    
                    if (success) {
                        showToast(`Viewer ì„¤ì • ì™„ë£Œ!\nUID: ${viewerUIDs[0].substring(0, 20)}...\nì½ê¸° ì „ìš© ê¶Œí•œ`, 'success');
                        
                        if (statusDiv) {
                            statusDiv.textContent = 'âœ… Viewer ì„¤ì • ì™„ë£Œ! (ì½ê¸° ì „ìš©)';
                            statusDiv.style.color = '#c8e6c9';
                        }
                        
                        input.value = '';
                        
                        setTimeout(() => {
                            if (statusDiv) {
                                statusDiv.textContent = '';
                            }
                        }, 3000);
                        
                        await loadUserRole();
                        applyRoleBasedUI();
                    } else {
                        showToast('Viewer ì„¤ì • ì‹¤íŒ¨. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.', 'error');
                        if (statusDiv) {
                            statusDiv.textContent = 'âŒ ì„¤ì • ì‹¤íŒ¨. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.';
                            statusDiv.style.color = '#ffcdd2';
                        }
                    }
                } catch (error) {
                    console.error('âŒ Viewer ì„¤ì • ì˜¤ë¥˜:', error);
                    showToast(`ì„¤ì • ì˜¤ë¥˜: ${error.message}`, 'error');
                    if (statusDiv) {
                        statusDiv.textContent = 'âŒ ì˜¤ë¥˜: ' + error.message;
                        statusDiv.style.color = '#ffcdd2';
                    }
                }
            } else {
                // ì—¬ëŸ¬ Viewer ì¼ê´„ ì„¤ì •
                showToast(`${viewerUIDs.length}ëª…ì˜ Viewer ì„¤ì • ì¤‘...`, 'info');
                
                if (statusDiv) {
                    statusDiv.textContent = `â³ ${viewerUIDs.length}ëª… ì„¤ì • ì¤‘...`;
                    statusDiv.style.color = '#fff9c4';
                }
                
                try {
                    const result = await setViewersByUIDs(viewerUIDs);
                    
                    if (result.success > 0) {
                        const message = result.failed > 0 
                            ? `Viewer ì¼ê´„ ì„¤ì • ì™„ë£Œ!\nì„±ê³µ: ${result.success}ëª…\nì‹¤íŒ¨: ${result.failed}ëª…`
                            : `Viewer ì¼ê´„ ì„¤ì • ì™„ë£Œ!\n${result.success}ëª… ëª¨ë‘ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                        
                        showToast(message, result.failed > 0 ? 'warning' : 'success');
                        
                        if (statusDiv) {
                            statusDiv.textContent = `âœ… ${result.success}ëª… ì„¤ì • ì™„ë£Œ${result.failed > 0 ? ` (${result.failed}ëª… ì‹¤íŒ¨)` : ''}`;
                            statusDiv.style.color = result.failed > 0 ? '#fff9c4' : '#c8e6c9';
                        }
                        
                        if (result.failedUIDs && result.failedUIDs.length > 0) {
                            console.warn('âŒ ì‹¤íŒ¨í•œ UID:', result.failedUIDs);
                        }
                        
                        input.value = '';
                        
                        setTimeout(() => {
                            if (statusDiv) {
                                statusDiv.textContent = '';
                            }
                        }, 5000);
                    } else {
                        showToast(`ëª¨ë“  Viewer ì„¤ì • ì‹¤íŒ¨ (${result.total}ëª…)`, 'error');
                        if (statusDiv) {
                            statusDiv.textContent = `âŒ ëª¨ë‘ ì‹¤íŒ¨ (${result.total}ëª…)`;
                            statusDiv.style.color = '#ffcdd2';
                        }
                    }
                } catch (error) {
                    console.error('âŒ Viewer ì¼ê´„ ì„¤ì • ì˜¤ë¥˜:', error);
                    showToast(`ì¼ê´„ ì„¤ì • ì˜¤ë¥˜: ${error.message}`, 'error');
                    if (statusDiv) {
                        statusDiv.textContent = 'âŒ ì˜¤ë¥˜: ' + error.message;
                        statusDiv.style.color = '#ffcdd2';
                    }
                }
            }
        }
        
        // ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ (ë””ë²„ê·¸ìš©)
        // âš ï¸ UID ê¸°ë°˜ Admin íŒë³„ í•¨ìˆ˜ë“¤ì€ ì œê±°ë¨ - Firestoreê°€ ë‹¨ì¼ ì§„ì‹¤ ì†ŒìŠ¤
        window.getCurrentUID = getCurrentUID;
        window.setCurrentUID = setCurrentUID;
        
        // Adminì—ì„œ Editor ê³„ì • í™•ì¸ ë° í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
        async function checkEditorAccount(editorUID) {
            if (!initFirebase()) {
                console.error('âŒ Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (!editorUID) {
                console.error('âŒ Editor UIDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                console.log('ì‚¬ìš©ë²•: checkEditorAccount("editor-uid-here")');
                return;
            }
            
            console.log('ğŸ” Editor ê³„ì • í™•ì¸ ì¤‘...');
            console.log('   UID:', editorUID);
            
            try {
                // Firestoreì—ì„œ ì—­í•  í™•ì¸
                const roleDoc = await firebaseDb.collection('projects').doc(window.PROJECT_ID)
                    .collection('members').doc(editorUID).get();
                
                if (roleDoc.exists) {
                    const roleData = roleDoc.data();
                    console.log('âœ… Firestore ì—­í•  ë¬¸ì„œ ì¡´ì¬');
                    console.log('ğŸ“‹ ì—­í•  ë°ì´í„°:', roleData);
                    console.log('   role:', roleData.role);
                    console.log('   allowedProcesses:', roleData.allowedProcesses);
                    console.log('   projectId:', roleData.projectId || 'N/A');
                    
                    if (roleData.role === 'editor') {
                        console.log('âœ… Editor ì—­í• ì´ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
                        if (roleData.allowedProcesses && roleData.allowedProcesses.length > 0) {
                            console.log('âœ… í—ˆìš© ê³µì •:', roleData.allowedProcesses);
                        } else {
                            console.warn('âš ï¸ allowedProcessesê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                        }
                    } else {
                        console.warn('âš ï¸ ì—­í• ì´ editorê°€ ì•„ë‹™ë‹ˆë‹¤. í˜„ì¬ ì—­í• :', roleData.role);
                    }
                } else {
                    console.error('âŒ Firestoreì— ì—­í•  ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.');
                    console.log('ğŸ’¡ Admin ì„¤ì • ì˜ì—­ì—ì„œ Editor ì„¤ì •ì„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.');
                }
                
                // Firebase Authenticationì—ì„œ ì‚¬ìš©ì í™•ì¸ (Admin ê¶Œí•œ í•„ìš”)
                try {
                    // ì°¸ê³ : Firebase Admin SDKê°€ ì—†ìœ¼ë¯€ë¡œ ì§ì ‘ í™•ì¸ì€ ë¶ˆê°€ëŠ¥
                    // ëŒ€ì‹  Firestore ë¬¸ì„œë§Œ í™•ì¸
                    console.log('ğŸ’¡ Firebase Authentication ì‚¬ìš©ì í™•ì¸ì€ Firebase Consoleì—ì„œ ì§ì ‘ í™•ì¸í•˜ì„¸ìš”.');
                    console.log('   Firebase Console â†’ Authentication â†’ Users');
                } catch (authError) {
                    console.warn('âš ï¸ Authentication í™•ì¸ ì‹¤íŒ¨ (ì •ìƒ):', authError.message);
                }
                
            } catch (error) {
                console.error('âŒ Editor ê³„ì • í™•ì¸ ì‹¤íŒ¨:', error);
            }
        }
        
        window.checkEditorAccount = checkEditorAccount;
        
        // Adminì—ì„œ ëª¨ë“  Editor ê³„ì • ëª©ë¡ í™•ì¸
        async function listAllEditors() {
            console.log('ğŸš€ listAllEditors í•¨ìˆ˜ ì‹œì‘');
            
            if (!initFirebase()) {
                console.error('âŒ Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const currentUser = firebaseAuth.currentUser;
            if (!currentUser) {
                console.error('âŒ ë¡œê·¸ì¸ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.');
                console.log('ğŸ’¡ ì½˜ì†”ì—ì„œ ë¡œê·¸ì¸: firebase.auth().signInWithEmailAndPassword("email@example.com", "password").then(() => location.reload())');
                return;
            }
            
            console.log('ğŸ” ëª¨ë“  Editor ê³„ì • í™•ì¸ ì¤‘...');
            console.log('   í˜„ì¬ ì‚¬ìš©ì:', currentUser.uid, currentUser.email || '');
            
            try {
                // Firestoreì—ì„œ í”„ë¡œì íŠ¸ ë©¤ë²„ ëª©ë¡ ì¡°íšŒ (projects/{projectId}/members)
                console.log('ğŸ“¡ Firestoreì—ì„œ projects/' + window.PROJECT_ID + '/members ì»¬ë ‰ì…˜ ì¡°íšŒ ì¤‘...');
                const roleDocs = await firebaseDb.collection('projects').doc(window.PROJECT_ID)
                    .collection('members').get();
                console.log('âœ… Firestore ì¡°íšŒ ì™„ë£Œ. ë¬¸ì„œ ìˆ˜:', roleDocs.size);
                
                const editors = [];
                const admins = [];
                const viewers = [];
                
                roleDocs.forEach(doc => {
                    const data = doc.data();
                    const role = data.role || 'viewer';
                    const uid = doc.id;
                    
                    if (role === 'editor') {
                        editors.push({
                            uid: uid,
                            allowedProcesses: data.allowedProcesses || [],
                            projectId: data.projectId || 'N/A',
                            updatedAt: data.updatedAt || 'N/A'
                        });
                    } else if (role === 'admin') {
                        admins.push({ uid: uid, projectId: data.projectId || 'N/A' });
                    } else if (role === 'viewer') {
                        viewers.push({ uid: uid, projectId: data.projectId || 'N/A' });
                    }
                });
                
                console.log('ğŸ“‹ Editor ê³„ì • ëª©ë¡:');
                if (editors.length > 0) {
                    editors.forEach((editor, index) => {
                        console.log(`\n${index + 1}. Editor (ê³µì • ${editor.allowedProcesses.join(', ')}):`);
                        console.log(`   UID: ${editor.uid}`);
                        console.log(`   í—ˆìš© ê³µì •: [${editor.allowedProcesses.join(', ')}]`);
                        console.log(`   í”„ë¡œì íŠ¸: ${editor.projectId}`);
                    });
                } else {
                    console.log('   Editor ê³„ì •ì´ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                console.log('\nğŸ“‹ Admin ê³„ì • ëª©ë¡:');
                if (admins.length > 0) {
                    admins.forEach((admin, index) => {
                        console.log(`${index + 1}. Admin: ${admin.uid}`);
                    });
                } else {
                    console.log('   Admin ê³„ì •ì´ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                console.log('\nğŸ“‹ Viewer ê³„ì • ëª©ë¡:');
                if (viewers.length > 0) {
                    viewers.forEach((viewer, index) => {
                        console.log(`${index + 1}. Viewer: ${viewer.uid}`);
                    });
                } else {
                    console.log('   Viewer ê³„ì •ì´ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                // Editor 3,4,5 ì°¾ê¸°
                const editor345 = editors.find(e => 
                    e.allowedProcesses.length === 3 && 
                    e.allowedProcesses.includes(3) && 
                    e.allowedProcesses.includes(4) && 
                    e.allowedProcesses.includes(5)
                );
                
                if (editor345) {
                    console.log('\nâœ… Editor 3,4,5 ë°œê²¬:');
                    console.log(`   UID: ${editor345.uid}`);
                    console.log(`   í—ˆìš© ê³µì •: [${editor345.allowedProcesses.join(', ')}]`);
                    console.log(`\nğŸ’¡ ì´ UIDë¡œ í™•ì¸í•˜ë ¤ë©´: checkEditorAccount("${editor345.uid}")`);
                } else {
                    console.log('\nâš ï¸ Editor 3,4,5ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    console.log('ğŸ’¡ Editor 3,4,5ë¥¼ ì„¤ì •í•˜ë ¤ë©´ Admin ì„¤ì • ì˜ì—­ì—ì„œ Editor ì„¤ì •ì„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.');
                }
                
            } catch (error) {
                console.error('âŒ Editor ê³„ì • ëª©ë¡ í™•ì¸ ì‹¤íŒ¨:', error);
                console.error('   ì˜¤ë¥˜ ì½”ë“œ:', error.code);
                console.error('   ì˜¤ë¥˜ ë©”ì‹œì§€:', error.message);
                
                if (error.code === 'permission-denied') {
                    console.error('âŒ Firestore ê¶Œí•œ ì˜¤ë¥˜ì…ë‹ˆë‹¤.');
                    console.log('ğŸ’¡ Firestore Rulesê°€ ì œëŒ€ë¡œ ë°°í¬ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.');
                    console.log('ğŸ’¡ í˜„ì¬ ì‚¬ìš©ìê°€ Adminì¸ì§€ í™•ì¸í•˜ì„¸ìš”.');
                }
            }
        }
        
        window.listAllEditors = listAllEditors;
        
        // Editor ì»´í“¨í„° ìƒíƒœ í™•ì¸ í•¨ìˆ˜ (Adminì—ì„œ í˜¸ì¶œ ê°€ëŠ¥)
        async function checkEditorComputerStatus() {
            console.log('ğŸ” Editor ì»´í“¨í„° ìƒíƒœ í™•ì¸ ì‹œì‘...');
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            
            // 1. localStorage í™•ì¸
            console.log('\nğŸ“¦ localStorage ìƒíƒœ:');
            const storedRole = localStorage.getItem('kcol:userRole');
            const storedProcesses = localStorage.getItem('kcol:allowedProcesses');
            const storedUid = localStorage.getItem('kcol:firebaseUid');
            const storedAdminUids = localStorage.getItem('kcol:adminUids');
            
            console.log('   userRole:', storedRole || '(ì—†ìŒ)');
            console.log('   allowedProcesses:', storedProcesses || '(ì—†ìŒ)');
            console.log('   firebaseUid:', storedUid || '(ì—†ìŒ)');
            console.log('   adminUids:', storedAdminUids || '(ì—†ìŒ)');
            
            if (storedRole === 'admin') {
                console.warn('âš ï¸ localStorageì— "admin" ì—­í• ì´ ì €ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤!');
                console.log('ğŸ’¡ ì´ëŠ” ì´ì „ ì„¸ì…˜ì˜ ë°ì´í„°ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                console.log('ğŸ’¡ Firebase ë¡œê·¸ì¸ í›„ Firebaseì˜ ì—­í• ì´ ìš°ì„  ì ìš©ë©ë‹ˆë‹¤.');
            }
            
            // 2. Firebase ì´ˆê¸°í™” ìƒíƒœ
            console.log('\nğŸ”¥ Firebase ìƒíƒœ:');
            if (!initFirebase()) {
                console.error('âŒ Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                console.log('ğŸ’¡ Firebase ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.');
            } else {
                console.log('âœ… Firebase ì´ˆê¸°í™”ë¨');
            }
            
            // 3. Firebase ë¡œê·¸ì¸ ìƒíƒœ
            console.log('\nğŸ‘¤ Firebase ë¡œê·¸ì¸ ìƒíƒœ:');
            const currentUser = firebaseAuth?.currentUser;
            if (!currentUser) {
                console.error('âŒ Firebaseì— ë¡œê·¸ì¸ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                console.log('ğŸ’¡ Email/Passwordë¡œ ë¡œê·¸ì¸í•´ì•¼ í•©ë‹ˆë‹¤.');
                console.log('ğŸ’¡ ë¡œê·¸ì¸ ë°©ë²•: firebase.auth().signInWithEmailAndPassword("email@example.com", "password").then(() => location.reload())');
            } else {
                console.log('âœ… Firebase ë¡œê·¸ì¸ë¨');
                console.log('   UID:', currentUser.uid);
                console.log('   Email:', currentUser.email || '(ì—†ìŒ)');
                console.log('   Is Anonymous:', currentUser.isAnonymous);
                
                if (currentUser.isAnonymous) {
                    console.error('âŒ ìµëª… ë¡œê·¸ì¸ì€ ì°¨ë‹¨ë©ë‹ˆë‹¤!');
                }
            }
            
            // 4. Firebase ì—­í•  í™•ì¸
            console.log('\nğŸ“‹ Firebase ì—­í•  ìƒíƒœ:');
            if (currentUser && !currentUser.isAnonymous) {
                try {
                    const roleData = await loadUserRoleFromFirebase(window.PROJECT_ID, currentUser.uid);
                    if (roleData) {
                        console.log('âœ… Firebaseì—ì„œ ì—­í•  ë¡œë“œ ì„±ê³µ');
                        console.log('   ì—­í• :', roleData.role);
                        console.log('   í—ˆìš© ê³µì •:', roleData.allowedProcesses);
                        
                        if (roleData.role === 'admin') {
                            console.warn('âš ï¸ Firebaseì—ì„œ Admin ì—­í• ì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
                            console.log('ğŸ’¡ Editor ì»´í“¨í„°ëŠ” Editor ì—­í• ì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                        } else if (roleData.role === 'editor') {
                            console.log('âœ… Editor ì—­í• ì´ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
                            if (roleData.allowedProcesses && roleData.allowedProcesses.length > 0) {
                                console.log('âœ… í—ˆìš© ê³µì •:', roleData.allowedProcesses);
                            } else {
                                console.warn('âš ï¸ í—ˆìš© ê³µì •ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                            }
                        } else if (roleData.role === 'viewer') {
                            console.warn('âš ï¸ Viewer ì—­í• ë¡œ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
                            console.log('ğŸ’¡ Editor ì—­í• ì´ í•„ìš”í•©ë‹ˆë‹¤. Adminì—ì„œ Editor ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.');
                        }
                    } else {
                        console.error('âŒ Firebaseì—ì„œ ì—­í• ì„ ë¡œë“œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                        console.log('ğŸ’¡ Firestoreì— ì—­í•  ë¬¸ì„œê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.');
                        console.log('ğŸ’¡ Firestore ê²½ë¡œ: projects/' + window.PROJECT_ID + '/members/' + currentUser.uid);
                    }
                } catch (error) {
                    console.error('âŒ Firebase ì—­í•  ë¡œë“œ ì˜¤ë¥˜:', error);
                }
            } else {
                console.warn('âš ï¸ Firebase ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            }
            
            // 5. í˜„ì¬ ì ìš©ëœ ì—­í• 
            console.log('\nğŸ¯ í˜„ì¬ ì ìš©ëœ ì—­í•  (UI):');
            console.log('   userRole ë³€ìˆ˜:', userRole || '(null)');
            console.log('   allowedProcesses ë³€ìˆ˜:', allowedProcesses || '[]');
            
            if (userRole === 'admin') {
                console.warn('âš ï¸ í˜„ì¬ UIì— Admin ì—­í• ì´ ì ìš©ë˜ì–´ ìˆìŠµë‹ˆë‹¤!');
                console.log('ğŸ’¡ Editor ì»´í“¨í„°ëŠ” Editor ì—­í• ì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
            } else if (userRole === 'editor') {
                console.log('âœ… Editor ì—­í• ì´ ì ìš©ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
            } else if (userRole === 'viewer') {
                console.warn('âš ï¸ Viewer ì—­í• ì´ ì ìš©ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
            } else {
                console.warn('âš ï¸ ì—­í• ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            }
            
            // 6. ê¶Œì¥ ì‚¬í•­
            console.log('\nğŸ’¡ ê¶Œì¥ ì‚¬í•­:');
            if (storedRole === 'admin' || userRole === 'admin') {
                console.log('   1. localStorageì—ì„œ ì´ì „ admin ë°ì´í„° ì‚­ì œ:');
                console.log('      localStorage.removeItem("kcol:userRole")');
                console.log('      localStorage.removeItem("kcol:adminUids")');
                console.log('   2. í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ (Ctrl+F5)');
                console.log('   3. Editor ê³„ì •ìœ¼ë¡œ Firebase ë¡œê·¸ì¸');
            } else if (!currentUser) {
                console.log('   1. Editor ê³„ì •ìœ¼ë¡œ Firebase ë¡œê·¸ì¸:');
                console.log('      firebase.auth().signInWithEmailAndPassword("editor-email@example.com", "password").then(() => location.reload())');
            } else if (userRole === 'viewer' || !userRole) {
                console.log('   1. Admin ì»´í“¨í„°ì—ì„œ Editor ì—­í•  ì„¤ì • í™•ì¸');
                console.log('   2. listAllEditors()ë¡œ Editor ëª©ë¡ í™•ì¸');
                console.log('   3. checkEditorAccount("editor-uid")ë¡œ ì—­í•  í™•ì¸');
            }
            
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        }
        window.checkEditorComputerStatus = checkEditorComputerStatus;
        
        // Adminì—ì„œ Editor ê³„ì •ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ ë¡œê·¸ì¸ (ì—­í•  í™•ì¸ìš©)
        async function testEditorLogin(email, password) {
            if (!initFirebase()) {
                console.error('âŒ Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (!email || !password) {
                console.error('âŒ ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                console.log('ì‚¬ìš©ë²•: testEditorLogin("editor@example.com", "password")');
                return;
            }
            
            console.log('ğŸ” Editor ê³„ì • í…ŒìŠ¤íŠ¸ ë¡œê·¸ì¸ ì¤‘...');
            console.log('   ì´ë©”ì¼:', email);
            
            try {
                // í˜„ì¬ Admin ê³„ì • ë¡œê·¸ì•„ì›ƒ (ì„ íƒì‚¬í•­)
                const currentUser = firebaseAuth.currentUser;
                if (currentUser) {
                    console.log('â„¹ï¸ í˜„ì¬ ë¡œê·¸ì¸ëœ ì‚¬ìš©ì:', currentUser.uid);
                    console.log('ğŸ’¡ í…ŒìŠ¤íŠ¸ ë¡œê·¸ì¸ì„ ìœ„í•´ í˜„ì¬ ê³„ì •ì„ ë¡œê·¸ì•„ì›ƒí• ê¹Œìš”? (ìˆ˜ë™ìœ¼ë¡œ ì§„í–‰)');
                }
                
                // Editor ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸ ì‹œë„
                const userCredential = await firebaseAuth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                console.log('âœ… Editor ê³„ì • ë¡œê·¸ì¸ ì„±ê³µ');
                console.log('   UID:', user.uid);
                console.log('   ì´ë©”ì¼:', user.email);
                
                // ì—­í•  ë¡œë“œ
                const roleData = await loadUserRoleFromFirebase(window.PROJECT_ID, user.uid);
                if (roleData) {
                    console.log('âœ… ì—­í•  ë¡œë“œ ì„±ê³µ');
                    console.log('   ì—­í• :', roleData.role);
                    console.log('   í—ˆìš© ê³µì •:', roleData.allowedProcesses);
                    
                    if (roleData.role === 'editor') {
                        console.log('âœ… Editor ì—­í• ì´ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤!');
                        if (roleData.allowedProcesses && roleData.allowedProcesses.length > 0) {
                            console.log('âœ… í—ˆìš© ê³µì •:', roleData.allowedProcesses);
                        } else {
                            console.warn('âš ï¸ allowedProcessesê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                        }
                    } else {
                        console.warn('âš ï¸ ì—­í• ì´ editorê°€ ì•„ë‹™ë‹ˆë‹¤. í˜„ì¬ ì—­í• :', roleData.role);
                    }
                } else {
                    console.error('âŒ ì—­í• ì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    console.log('ğŸ’¡ Firestoreì— ì—­í•  ë¬¸ì„œê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.');
                }
                
                // ë‹¤ì‹œ Admin ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸ (ì„ íƒì‚¬í•­)
                console.log('ğŸ’¡ í…ŒìŠ¤íŠ¸ ì™„ë£Œ. ì›ë˜ Admin ê³„ì •ìœ¼ë¡œ ë‹¤ì‹œ ë¡œê·¸ì¸í•˜ì„¸ìš”.');
                
            } catch (error) {
                console.error('âŒ Editor ê³„ì • ë¡œê·¸ì¸ ì‹¤íŒ¨:', error);
                console.error('   ì˜¤ë¥˜ ì½”ë“œ:', error.code);
                console.error('   ì˜¤ë¥˜ ë©”ì‹œì§€:', error.message);
                
                if (error.code === 'auth/user-not-found') {
                    console.log('ğŸ’¡ ì‚¬ìš©ìê°€ Firebase Authenticationì— ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                    console.log('ğŸ’¡ Firebase Console â†’ Authentication â†’ Usersì—ì„œ ì‚¬ìš©ìë¥¼ ìƒì„±í•˜ì„¸ìš”.');
                } else if (error.code === 'auth/wrong-password') {
                    console.log('ğŸ’¡ ë¹„ë°€ë²ˆí˜¸ê°€ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
            }
        }
        
        window.testEditorLogin = testEditorLogin;
        window.setAdminRoleInFirestore = setAdminRoleInFirestore;
        window.setEditorRoleInFirestore = setEditorRoleInFirestore;
        window.setViewerRoleInFirestore = setViewerRoleInFirestore;
        window.setAdminByUID = setAdminByUID;
        window.setEditorByUID = setEditorByUID;
        window.setViewerByUID = setViewerByUID;
        window.setViewersByUIDs = setViewersByUIDs;
        window.setCurrentUserAsAdmin = setCurrentUserAsAdmin;
        window.logoutFromFirebase = logoutFromFirebase;
        window.checkFirebaseUser = checkFirebaseUser;
        window.verifyAdminRole = verifyAdminRole;
        
        // Firebase ì‹¤ì‹œê°„ ì—°ê²° í™•ì¸ í•¨ìˆ˜
        function checkFirebaseRealtimeConnection() {
            console.log('ğŸ” Firebase ì‹¤ì‹œê°„ ì—°ê²° ìƒíƒœ í™•ì¸...');
            
            if (!initFirebase()) {
                console.error('âŒ Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return false;
            }
            
            const user = firebaseAuth.currentUser;
            if (!user) {
                console.error('âŒ ë¡œê·¸ì¸ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.');
                return false;
            }
            
            if (user.isAnonymous) {
                console.error('âŒ ìµëª… ì‚¬ìš©ìëŠ” ì‹¤ì‹œê°„ ì—°ê²°ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return false;
            }
            
            console.log('âœ… ë¡œê·¸ì¸ ìƒíƒœ:', user.email || user.uid);
            
            if (realtimeUnsubscribe) {
                console.log('âœ… ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ í™œì„±í™”ë¨');
                console.log('ğŸ“¡ í”„ë¡œì íŠ¸:', window.PROJECT_ID);
                console.log('ğŸ’¡ ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ë°ì´í„°ë¥¼ ë³€ê²½í•˜ë©´ ìë™ìœ¼ë¡œ í™”ë©´ì´ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.');
                return true;
            } else {
                console.warn('âš ï¸ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                console.log('ğŸ’¡ setupFirebaseRealtimeListener()ë¥¼ í˜¸ì¶œí•˜ì—¬ ì‹¤ì‹œê°„ ë™ê¸°í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”.');
                return false;
            }
        }
        
        window.checkFirebaseRealtimeConnection = checkFirebaseRealtimeConnection;
        
        // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ìˆ˜ë™ ì¬ì‹œì‘ í•¨ìˆ˜
        function restartRealtimeListener() {
            console.log('ğŸ”„ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì¬ì‹œì‘ ì‹œë„...');
            
            if (!initFirebase() || !firebaseAuth.currentUser) {
                console.error('âŒ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                return false;
            }
            
            stopProjectListener();
            stopMyMemberDocListener();
            stopRealtimeStatusCheck();
            
            // ë¦¬ìŠ¤ë„ˆ ì¬ì‹œì‘
            setupFirebaseRealtimeListener();
            
            console.log('âœ… ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì¬ì‹œì‘ ì™„ë£Œ');
            showToast('ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì¬ì‹œì‘ë¨', 'info');
            return true;
        }
        
        window.restartRealtimeListener = restartRealtimeListener;
        window.handleAdminUIDInput = handleAdminUIDInput;
        window.handleEditorUIDInput = handleEditorUIDInput;
        window.handleViewerUIDInput = handleViewerUIDInput;
        
        // ============================================================
        // í”„ë¡œì íŠ¸ ê¶Œí•œ ë³€ìˆ˜ (Project Role)
        // 
        // âš ï¸ ì¤‘ìš”: Portal Admin â‰  Project Admin
        // - Portal Admin: portal_members/{uid}.portalRole (í¬í„¸ ì „ì²´ ìš´ì˜ ê¶Œí•œ)
        // - Project Admin: projects/{projectId}/members/{uid}.role (í”„ë¡œì íŠ¸ ë‚´ë¶€ ê¶Œí•œ)
        // 
        // ì´ ë³€ìˆ˜ë“¤ì€ ì˜¤ì§ Firestore projects/{projectId}/members/{uid}.role ê°’ë§Œ ì €ì¥í•©ë‹ˆë‹¤.
        // email, portalRole, localStorage ê°’ìœ¼ë¡œëŠ” ì ˆëŒ€ ì„¤ì •í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        // 
        // ğŸ”’ ì´ˆê¸°ê°’ì€ ë¬´ì¡°ê±´ viewer (ì ê¸ˆ ìƒíƒœ)
        // Firestoreì—ì„œ roleì„ ë¡œë“œí•œ í›„ì—ë§Œ ë³€ê²½ë¨
        // ============================================================
        let userRole = 'viewer';
        let allowedProcesses = [];
        
        // ============================================================
        // ğŸ”’ Project Admin íŒ¨ë„ì„ role ê¸°ë°˜ìœ¼ë¡œ display ì œì–´í•˜ëŠ” í•¨ìˆ˜
        // 
        // âš ï¸ ì¤‘ìš”: Portal Admin â‰  Project Admin
        // - Portal Admin: portal_members/{uid}.portalRole === "admin"
        // - Project Admin: projects/{projectId}/members/{uid}.role === "admin"
        // 
        // ì´ í•¨ìˆ˜ëŠ” ì˜¤ì§ projects/{projectId}/members/{uid}.role ê°’ë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.
        // email, portalRole, localStorage ê°’ìœ¼ë¡œëŠ” ì ˆëŒ€ íŒë‹¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        // ============================================================
        // ============================================================
        // Admin Panel ë…¸ì¶œ ì¡°ê±´: role === "admin"ìœ¼ë¡œë§Œ ê³ ì •
        // 
        // âš ï¸ ì¤‘ìš”: ì´ í•¨ìˆ˜ëŠ” ì˜¤ì§ role === "admin"ì¼ ë•Œë§Œ admin-panelì„ í‘œì‹œí•©ë‹ˆë‹¤.
        // email, portalRole, localStorage ê°’ì€ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        // ============================================================
        function renderUIByRole(role) {
            // ============================================================
            // âš ï¸ ì¤‘ìš”: admin-panel display ì œì–´ëŠ” applyRoleBasedUI()ë¡œ ë‹¨ì¼í™”ë¨
            // 
            // âœ… ì¤‘ë³µ ì œì–´ ì œê±°: renderUIByRole()ì—ì„œëŠ” admin-panelì„ ì œì–´í•˜ì§€ ì•Šë„ë¡ ì •ë¦¬í•¨
            // admin-panel display ì œì–´ë¥¼ applyRoleBasedUI()ë¡œ ë‹¨ì¼í™”í•¨
            // 
            // ì´ í•¨ìˆ˜ëŠ” ë‹¤ë¥¸ UI ìš”ì†Œ ì œì–´ìš©ìœ¼ë¡œ ë‚¨ê²¨ë‘  (í•„ìš”ì‹œ í™•ì¥ ê°€ëŠ¥)
            // ============================================================
            console.log(`[renderUIByRole] í˜¸ì¶œë¨ (role: ${role})`);
            console.log(`[renderUIByRole] admin-panel ì œì–´ëŠ” applyRoleBasedUI()ì—ì„œ ì²˜ë¦¬ë¨`);
            
            // âœ… admin-panel ì œì–´ëŠ” applyRoleBasedUI()ì—ì„œë§Œ ìˆ˜í–‰
            // ì¤‘ë³µ ì œì–´ ë°©ì§€ë¥¼ ìœ„í•´ ì—¬ê¸°ì„œëŠ” ì œì–´í•˜ì§€ ì•ŠìŒ
        }
        
        // ============================================================
        // Portal Admin ê´€ë ¨ í•¨ìˆ˜ (í”„ë¡œì íŠ¸ ê¶Œí•œê³¼ ì™„ì „ ë¶„ë¦¬)
        // 
        // âš ï¸ ì¤‘ìš”: Portal Admin â‰  Project Admin
        // - Portal Admin: portal_members/{uid}.portalRole (í¬í„¸ ì „ì²´ ìš´ì˜ ê¶Œí•œ)
        // - Project Admin: projects/{projectId}/members/{uid}.role (í”„ë¡œì íŠ¸ ë‚´ë¶€ ê¶Œí•œ)
        // 
        // ì´ í•¨ìˆ˜ë“¤ì€ í”„ë¡œì íŠ¸ admin/editor/viewer UIì™€ ì™„ì „íˆ ë¶„ë¦¬ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
        // ============================================================
        
        // Portal Role ë¡œë“œ (projects/{projectId}/portal_members/{uid} ë¬¸ì„œë§Œ ì¡°íšŒ)
        // í”„ë¡œì íŠ¸ ê¶Œí•œì˜ ë‹¨ì¼ ì§„ì‹¤ ì†ŒìŠ¤ëŠ” projects/{projectId}/members/{uid}ë¡œ ìœ ì§€
        // í¬í„¸ ì—­í• ì€ ì°¸ê³ /í‘œì‹œ ìš©ë„ë¡œë§Œ ì‚¬ìš©
        async function loadPortalRole(uid) {
            if (!initFirebase() || !uid || !window.PROJECT_ID) {
                return { portalRole: "user", exists: false };
            }
            
            try {
                // projects/{projectId}/portal_members/{uid} ë¬¸ì„œë§Œ ì¡°íšŒ
                const snap = await firebaseDb.collection("projects").doc(window.PROJECT_ID)
                    .collection("portal_members").doc(uid).get();
                if (!snap.exists) {
                    return { portalRole: "user", exists: false };
                }
                
                const data = snap.data() || {};
                const portalRole = (data.portalRole || "user").toString();
                return { portalRole, exists: true };
            } catch (error) {
                // ê¶Œí•œ ì˜¤ë¥˜ëŠ” ì¡°ìš©íˆ ì²˜ë¦¬ (í¬í„¸ ì—­í•  í™•ì¸ ì‹¤íŒ¨í•´ë„ í”„ë¡œì íŠ¸ ì—­í•  ë¡œë“œëŠ” ê³„ì† ì§„í–‰)
                if (error.code === 'permission-denied') {
                    console.warn('âš ï¸ [PORTAL] Portal Role í™•ì¸ ê¶Œí•œ ì—†ìŒ (ì •ìƒì¼ ìˆ˜ ìˆìŒ)');
                    console.log('ğŸ’¡ í¬í„¸ ì—­í•  í™•ì¸ì´ ì‹¤íŒ¨í•´ë„ í”„ë¡œì íŠ¸ ì—­í• ì€ ì •ìƒì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤.');
                } else {
                    console.error('âŒ [PORTAL] Portal Role ë¡œë“œ ì‹¤íŒ¨:', error);
                }
                return { portalRole: "user", exists: false };
            }
        }
        
        // ============================================================
        // Portal UI ì œì–´ (í¬í„¸ ê´€ë¦¬ì ë²„íŠ¼ë§Œ ì œì–´)
        // 
        // âš ï¸ ì¤‘ìš”: í¬í„¸ ê´€ë¦¬ì ë²„íŠ¼ì€ portal_members.portalRoleë¡œë§Œ ì œì–´í•©ë‹ˆë‹¤.
        // í”„ë¡œì íŠ¸ admin/editor/viewer UIëŠ” ì ˆëŒ€ ê±´ë“œë¦¬ì§€ ì•ŠìŠµë‹ˆë‹¤.
        // 
        // ì´ í•¨ìˆ˜ëŠ” ì˜¤ì§ portal-admin-btn ìš”ì†Œë§Œ ì œì–´í•©ë‹ˆë‹¤.
        // projects/{projectId}/members/{uid}.roleê³¼ëŠ” ì™„ì „íˆ ë¶„ë¦¬ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
        // ============================================================
        function applyPortalUI(portalRole) {
            // í¬í„¸ ê´€ë¦¬ì ë²„íŠ¼ë§Œ ì œì–´ (í”„ë¡œì íŠ¸ admin/editor UI ì ˆëŒ€ ê±´ë“œë¦¬ì§€ ë§ ê²ƒ)
            // âš ï¸ portalRoleì€ ì˜¤ì§ portal_members/{uid}.portalRole ê°’ë§Œ ì‚¬ìš©
            const portalAdminBtn = document.getElementById("portal-admin-btn");
            if (portalAdminBtn) {
                portalAdminBtn.style.display = (portalRole === "admin") ? "inline-flex" : "none";
                console.log("[PORTAL ROLE]", portalRole, "- í¬í„¸ ê´€ë¦¬ì ë²„íŠ¼:", (portalRole === "admin") ? "í‘œì‹œ" : "ìˆ¨ê¹€");
                console.log("[PORTAL ROLE] portal-admin-btnë§Œ ì œì–´ (í”„ë¡œì íŠ¸ admin-panelê³¼ ë¬´ê´€)");
            } else {
                console.log("[PORTAL ROLE]", portalRole, "- portal-admin-btn ìš”ì†Œ ì—†ìŒ (ì •ìƒ)");
            }
        }
        
        // ============================================================
        // âœ… ì´ˆê¸° ì ê¸ˆ(ì¤‘ìš”): role ë¡œë”© ì „ì—ëŠ” ë¬´ì¡°ê±´ viewerë¡œ ì‹œì‘
        // 
        // âš ï¸ ì¤‘ìš”: ì´ˆê¸° ë Œë”ëŠ” ë¬´ì¡°ê±´ viewer ì ê¸ˆìœ¼ë¡œ ì‹œì‘í•©ë‹ˆë‹¤.
        // Firestore role ë¡œë”© ì™„ë£Œ í›„ì—ë§Œ UIê°€ ë³€ê²½ë©ë‹ˆë‹¤.
        // ============================================================
        function lockUIAsViewer() {
            window.userRole = "viewer";
            window.allowedProcesses = [];
            applyRoleBasedUI(); // ì•„ë˜ í•¨ìˆ˜ì—ì„œ viewer ê¸°ì¤€ìœ¼ë¡œ ìˆ¨ê¹€ ì²˜ë¦¬ë˜ê²Œ
            renderUIByRole("viewer"); // admin-panel ìˆ¨ê¹€
        }
        
        // ============================================================
        // Members ë¬¸ì„œ ë³€ê²½ í•¸ë“¤ëŸ¬ (role/UIëŠ” í•­ìƒ ì¬ì ìš©)
        // 
        // âš ï¸ ì¤‘ìš”: role/UI ì ìš©ê¹Œì§€ ê±´ë„ˆë›°ë©´ ì°½ë§ˆë‹¤ UIê°€ ì–´ê¸‹ë‚¨
        // âŒ ê¸ˆì§€: role/UI ì ìš©ê¹Œì§€ ê±´ë„ˆë›°ë©´ ì°½ë§ˆë‹¤ UIê°€ ì–´ê¸‹ë‚¨
        // if (isSelfUpdate) return; // âŒ ì´ëŸ° ê°€ë“œëŠ” ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ ê²ƒ
        // 
        // âœ… ì •ë‹µ: role/UIëŠ” í•­ìƒ ì¬ì ìš©
        // âš ï¸ roleì€ ì˜¤ì§ projects/{projectId}/members/{uid}.role ê°’ë§Œ ì‚¬ìš©
        // âš ï¸ portalRoleì€ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
        // ============================================================
        function onMemberDocChanged(latestRole, latestAllowedProcesses, portalRole = null) {
            // âœ… applyRole í•¨ìˆ˜ ì‚¬ìš© (admin ê°•ë“± ë°©ì§€)
            // ë‹¨ì¼ ì§„ì‹¤ ì†ŒìŠ¤: projects/{projectId}/members/{uid}.processRole (ìš°ì„ ), ì—†ìœ¼ë©´ role (í•˜ìœ„ í˜¸í™˜)
            applyRole(latestRole, latestAllowedProcesses || [], portalRole);
            
            // âœ… effectiveRole ê³„ì‚° (portalRole ì •ì±… ì ìš© í›„ ìµœì¢… ì—­í• )
            let effectiveRole = latestRole;
            if (portalRole !== null && portalRole !== "admin" && latestRole === "admin") {
                effectiveRole = "editor"; // portal editorê°€ ê³µì •í‘œ adminì´ ë˜ëŠ” ê²ƒ ë°©ì§€
            }
            
            console.log('[PROJECT ROLE UPDATED]', {
                portalRole: portalRole || "(ë¯¸ì œê³µ)",
                processRole: latestRole,
                legacyRole: "(ì‚¬ìš© ì•ˆ í•¨)",
                effectiveRole: effectiveRole,
                allowedProcesses: latestAllowedProcesses || []
            });
        }
        
        // ============================================================
        // ğŸ”’ ì´ˆê¸° ì ê¸ˆ ê·œì¹™: í˜ì´ì§€ ë¡œë“œ ì‹œ í•­ìƒ viewer(ì ê¸ˆ)ë¡œ ì‹œì‘
        // 
        // âš ï¸ ì¤‘ìš”: ì´ˆê¸° ë Œë”ëŠ” ë¬´ì¡°ê±´ viewer ì ê¸ˆìœ¼ë¡œ ì‹œì‘í•©ë‹ˆë‹¤.
        // ì´ˆê¸° ìƒíƒœëŠ” í•­ìƒ viewerë¡œ ì‹œì‘í•˜ì—¬ admin íŒ¨ë„ì´ ë³´ì´ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤.
        // Firestore role ë¡œë”© ì™„ë£Œ í›„ì—ë§Œ UIê°€ ë³€ê²½ë©ë‹ˆë‹¤.
        // ============================================================
        // âœ… ì´ˆê¸° ë Œë”ëŠ” ë¬´ì¡°ê±´ viewer ì ê¸ˆ
        lockUIAsViewer();
        renderUIByRole("viewer"); // âœ… admin-panel ìˆ¨ê¹€
        
        // ê²€ì¦ ë¡œê·¸ (ì´ˆê¸° ìƒíƒœ)
        console.log("[INIT] ì´ˆê¸° UI ì ê¸ˆ ì™„ë£Œ: viewer");
        console.log("[INIT] [PROJECT_ID]", window.PROJECT_ID);
        console.log("[INIT] [PROJECT ROLE]", window.userRole);
        console.log("[INIT] [ADMIN PANEL]", document.getElementById("admin-panel")?.style.display);
        
        // ğŸ”’ í˜ì´ì§€ ë¡œë“œ ì‹œ ì „ì²´ ì´ˆê¸°í™” ë²„íŠ¼ ë¹„í™œì„±í™” (ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ ì „ê¹Œì§€)
        document.addEventListener('DOMContentLoaded', function() {
            const resetAllDataBtn = document.getElementById('reset-all-data-btn');
            if (resetAllDataBtn) {
                resetAllDataBtn.disabled = true;
                resetAllDataBtn.style.opacity = '0.5';
                resetAllDataBtn.style.cursor = 'not-allowed';
                resetAllDataBtn.title = 'ì „ì²´ ì´ˆê¸°í™”ëŠ” ê´€ë¦¬ì(Admin)ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
            }
        });
        
        // DOMContentLoadedê°€ ì´ë¯¸ ë°œìƒí–ˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì¦‰ì‹œ ì‹¤í–‰ë„ ì‹œë„
        (function() {
            const resetAllDataBtn = document.getElementById('reset-all-data-btn');
            if (resetAllDataBtn) {
                resetAllDataBtn.disabled = true;
                resetAllDataBtn.style.opacity = '0.5';
                resetAllDataBtn.style.cursor = 'not-allowed';
                resetAllDataBtn.title = 'ì „ì²´ ì´ˆê¸°í™”ëŠ” ê´€ë¦¬ì(Admin)ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
            }
        })();
        
        // ì—­í•  ë¡œë“œ í•¨ìˆ˜ (Firebase ë¡œê·¸ì¸ í•„ìˆ˜, ìµëª… ë° ë¹„ë¡œê·¸ì¸ ì‚¬ìš©ì ì°¨ë‹¨)
        // âš ï¸ ì´ í•¨ìˆ˜ëŠ” Admin/Editor/Viewer ì„¤ì • í›„ì—ë§Œ í˜¸ì¶œë©ë‹ˆë‹¤.
        // í˜ì´ì§€ ë¡œë“œ ì‹œì—ëŠ” setupFirebaseAuthListener()ê°€ roleì„ ë¡œë“œí•©ë‹ˆë‹¤.
        async function loadUserRole() {
            console.log('ğŸ” ì—­í•  ë¡œë“œ ì‹œì‘...');
            
            // Firebase ë¡œê·¸ì¸ í™•ì¸ (í•„ìˆ˜)
            if (!initFirebase() || !firebaseAuth.currentUser) {
                console.warn('âš ï¸ ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ì‚¬ìš©ìëŠ” ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                console.log('ğŸ’¡ Email/Passwordë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”:');
                console.log('   firebase.auth().signInWithEmailAndPassword("your-email@example.com", "your-password").then(() => location.reload())');
                userRole = null;
                allowedProcesses = [];
                applyRoleBasedUI();
                return;
            }
            
            // ìµëª… ì‚¬ìš©ì ì°¨ë‹¨
            if (firebaseAuth.currentUser.isAnonymous) {
                console.warn('âš ï¸ ìµëª… ë¡œê·¸ì¸ì€ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. Email/Passwordë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”.');
                userRole = null;
                allowedProcesses = [];
                applyRoleBasedUI();
                return;
            }
            
            // âš ï¸ Firestoreì—ì„œë§Œ roleì„ ë¡œë“œí•©ë‹ˆë‹¤. localStorageë‚˜ ë‹¤ë¥¸ ì†ŒìŠ¤ëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            const firebaseRole = await loadUserRoleFromFirebase(window.PROJECT_ID, user.uid);
            if (firebaseRole) {
                // âš ï¸ Firestoreì—ì„œ ë¡œë“œí•œ roleì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤. ë‹¤ë¥¸ ë¡œì§ì´ ë®ì–´ì“°ì§€ ì•Šë„ë¡ ë³´ì¥í•©ë‹ˆë‹¤.
                userRole = firebaseRole.role;
                allowedProcesses = firebaseRole.allowedProcesses || [];
                console.log('âœ… Firebaseì—ì„œ ì—­í•  ë¡œë“œ ì™„ë£Œ:', userRole, 'í—ˆìš© ê³µì •:', allowedProcesses);
                console.log('âš ï¸ Firestoreê°€ ë‹¨ì¼ ì§„ì‹¤ ì†ŒìŠ¤ì…ë‹ˆë‹¤. ë‹¤ë¥¸ ë¡œì§ì´ ì´ roleì„ ë®ì–´ì“°ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                
                // ì—­í• ì´ ì œëŒ€ë¡œ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
                if (!userRole || userRole === 'viewer') {
                    console.warn('âš ï¸ ì—­í• ì´ viewerë¡œ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. Firestore ë¬¸ì„œë¥¼ í™•ì¸í•˜ì„¸ìš”.');
                    console.log('ğŸ’¡ í˜„ì¬ Firebase ì‚¬ìš©ì UID:', firebaseAuth.currentUser?.uid);
                    console.log('ğŸ’¡ Firestore ê²½ë¡œ: projects/' + window.PROJECT_ID + '/members/' + firebaseAuth.currentUser?.uid);
                }
                
                // setUserRole()ì„ ì‚¬ìš©í•˜ì—¬ roleì„ ì„¤ì • (localStorage ì €ì¥ ë° UI ì—…ë°ì´íŠ¸ í¬í•¨)
                if (typeof setUserRole === 'function') {
                    setUserRole(userRole, allowedProcesses);
                } else {
                    applyRoleBasedUI();
                }
                return;
            }
            
            // Firebaseì—ì„œ ì—­í• ì„ ë¡œë“œí•˜ì§€ ëª»í•œ ê²½ìš° (ì—­í•  ë¬¸ì„œê°€ ì—†ìŒ)
            // âš ï¸ ê¸°ë³¸ê°’ì„ admin/editorë¡œ ë§Œë“¤ì§€ ì•ŠìŒ - viewerë¡œ ì²˜ë¦¬í•˜ê±°ë‚˜ "ê¶Œí•œ ì—†ìŒ" ì•ˆë‚´
            console.error('âŒ Firebaseì—ì„œ ì—­í• ì„ ë¡œë“œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
            console.log('ğŸ’¡ Firestoreì— ì‚¬ìš©ì ì—­í•  ë¬¸ì„œê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.');
            console.log('ğŸ’¡ Firestore ê²½ë¡œ: projects/' + window.PROJECT_ID + '/members/' + firebaseAuth.currentUser?.uid);
            console.log('âš ï¸ members ë¬¸ì„œê°€ ì—†ìœ¼ë©´ viewerë¡œ ì²˜ë¦¬í•˜ê±°ë‚˜ ì ‘ê·¼ì´ ì°¨ë‹¨ë©ë‹ˆë‹¤.');
            
            // members ë¬¸ì„œê°€ ì—†ìœ¼ë©´ viewerë¡œ ì²˜ë¦¬ (ì½ê¸° ì „ìš©)
            userRole = 'viewer';
            allowedProcesses = [];
            console.log('ğŸ”’ members ë¬¸ì„œê°€ ì—†ì–´ viewer(ì½ê¸° ì „ìš©)ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
            if (typeof setUserRole === 'function') {
                setUserRole(userRole, allowedProcesses);
            } else {
                applyRoleBasedUI();
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ ì²´í¬ í•¨ìˆ˜
        function checkLoginOnPageLoad() {
            console.log('ğŸ” [ê°€ë“œ] í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ ì²´í¬ ì‹œì‘...');
            console.log('ğŸ” [ê°€ë“œ] í”„ë¡œì íŠ¸ ID:', window.PROJECT_ID);
            
            if (!initFirebase()) {
                console.warn('âš ï¸ [ê°€ë“œ] Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ ëª¨ë‹¬ í‘œì‹œ.');
                showLoginModal();
                return;
            }
            
            const user = firebaseAuth.currentUser;
            console.log('ğŸ‘¤ [ê°€ë“œ] í˜„ì¬ ì‚¬ìš©ì:', user ? (user.email || user.uid) : 'ì—†ìŒ');
            
            if (!user || user.isAnonymous) {
                console.warn('âš ï¸ [ê°€ë“œ] ë¡œê·¸ì¸í•˜ì§€ ì•Šì•˜ê±°ë‚˜ ìµëª… ì‚¬ìš©ìì…ë‹ˆë‹¤.');
                console.log('ğŸ”’ [ê°€ë“œ] /login ì‹œë‚˜ë¦¬ì˜¤ (ì •ì  HTMLì´ë¯€ë¡œ ë¡œê·¸ì¸ ëª¨ë‹¬ í‘œì‹œ)');
                // ë¡œê·¸ì¸ë˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ëª¨ë‹¬ í‘œì‹œ
                showLoginModal();
            } else {
                console.log('âœ… [ê°€ë“œ] ë¡œê·¸ì¸ëœ ì‚¬ìš©ì í™•ì¸:', user.uid, user.email);
                console.log('ğŸ” [ê°€ë“œ] ë©¤ë²„ í™•ì¸ ëŒ€ê¸° ì¤‘... (setupFirebaseAuthListenerì—ì„œ ì²˜ë¦¬)');
                // ë¡œê·¸ì¸ëœ ê²½ìš° ëª¨ë‹¬ ìˆ¨ê¹€
                hideLoginModal();
            }
        }
        
        // ë¡œê·¸ì¸ ëª¨ë‹¬ ì´ˆê¸°í™” í•¨ìˆ˜ (í•­ìƒ í˜¸ì¶œ)
        // ì „ì—­ ë³€ìˆ˜ë¡œ ì¤‘ë³µ ë“±ë¡ ë°©ì§€
        let loginModalInitialized = false;
        
        function initializeLoginModal() {
            if (loginModalInitialized) {
                console.log('â„¹ï¸ ë¡œê·¸ì¸ ëª¨ë‹¬ì€ ì´ë¯¸ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
                return;
            }
            
            console.log('ğŸ”§ ë¡œê·¸ì¸ ëª¨ë‹¬ ì´ˆê¸°í™” ì‹œì‘...');
            
            // ë¡œê·¸ì¸ ëª¨ë‹¬ ìš”ì†Œ í™•ì¸
            const modal = document.getElementById('login-modal');
            if (!modal) {
                console.error('âŒ ë¡œê·¸ì¸ ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                // ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„
                setTimeout(initializeLoginModal, 100);
                return;
            }
            
            // ë¡œê·¸ì¸ ëª¨ë‹¬ì€ checkLoginOnPageLoad()ì—ì„œ ìƒíƒœ í™•ì¸ í›„ í‘œì‹œ/ìˆ¨ê¹€ ì²˜ë¦¬
            // ì—¬ê¸°ì„œëŠ” ì´ˆê¸° ìƒíƒœë¥¼ ìˆ¨ê¹€ìœ¼ë¡œ ì„¤ì • (ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ í›„ í•„ìš”ì‹œ í‘œì‹œ)
            if (initFirebase() && firebaseAuth && firebaseAuth.currentUser && !firebaseAuth.currentUser.isAnonymous) {
                // ì´ë¯¸ ë¡œê·¸ì¸ëœ ê²½ìš° ëª¨ë‹¬ ìˆ¨ê¹€
                modal.style.display = 'none';
                console.log('âœ… ë¡œê·¸ì¸ ëª¨ë‹¬ ìˆ¨ê¹€ (ì´ë¯¸ ë¡œê·¸ì¸ë¨)');
            } else {
                // ë¡œê·¸ì¸ë˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ëª¨ë‹¬ í‘œì‹œ
                modal.style.display = 'flex';
                modal.style.flexDirection = 'column';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                modal.style.zIndex = '10000';
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100%';
                modal.style.height = '100%';
                modal.style.background = 'rgba(0,0,0,0.8)';
                console.log('âœ… ë¡œê·¸ì¸ ëª¨ë‹¬ í‘œì‹œë¨ (ë¡œê·¸ì¸ë˜ì§€ ì•ŠìŒ)');
            }
            
            // ë¡œê·¸ì¸ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            const modalLoginBtn = document.getElementById('modal-login-btn');
            const modalLoginEmail = document.getElementById('modal-login-email');
            const modalLoginPassword = document.getElementById('modal-login-password');
            const modalLoginStatus = document.getElementById('modal-login-status');
            
            if (modalLoginBtn && !loginModalInitialized) {
                // ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
                modalLoginBtn.onclick = async function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('ğŸ” ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ë¨');
                    
                    const email = modalLoginEmail ? modalLoginEmail.value.trim() : '';
                    const password = modalLoginPassword ? modalLoginPassword.value.trim() : '';
                    
                    console.log('ğŸ“§ ì…ë ¥ëœ ì´ë©”ì¼:', email ? email.substring(0, 10) + '...' : '(ì—†ìŒ)');
                    
                    if (!email || !password) {
                        console.warn('âš ï¸ ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                        if (modalLoginStatus) {
                            modalLoginStatus.textContent = 'âŒ ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                            modalLoginStatus.style.color = '#f44336';
                        }
                        return;
                    }
                    
                    if (modalLoginStatus) {
                        modalLoginStatus.textContent = 'â³ ë¡œê·¸ì¸ ì¤‘...';
                        modalLoginStatus.style.color = '#2196f3';
                    }
                    
                    try {
                        console.log('ğŸ”„ Firebase ë¡œê·¸ì¸ ì‹œë„ ì¤‘...');
                        const userCredential = await firebaseAuth.signInWithEmailAndPassword(email, password);
                        const user = userCredential.user;
                        console.log('âœ… ë¡œê·¸ì¸ ì„±ê³µ! UID:', user.uid);
                        
                        // Firestoreì—ì„œ ì—­í•  í™•ì¸
                        const roleData = await loadUserRoleFromFirebase(window.PROJECT_ID, user.uid);
                        if (roleData) {
                            console.log('âœ… ì—­í•  í™•ì¸ ì™„ë£Œ:', roleData.role);
                            userRole = roleData.role;
                            allowedProcesses = roleData.allowedProcesses;
                            applyRoleBasedUI();
                        }
                        
                        if (user) {
                            console.log('âœ… ë¡œê·¸ì¸ ì„±ê³µ!');
                            if (modalLoginStatus) {
                                modalLoginStatus.textContent = 'âœ… ë¡œê·¸ì¸ ì„±ê³µ!';
                                modalLoginStatus.style.color = '#4caf50';
                            }
                            
                            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                            if (modalLoginEmail) modalLoginEmail.value = '';
                            if (modalLoginPassword) modalLoginPassword.value = '';
                            
                            // ëª¨ë‹¬ ìˆ¨ê¹€
                            setTimeout(() => {
                                hideLoginModal();
                            }, 1000);
                        } else {
                            console.error('âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨: UIDê°€ nullì…ë‹ˆë‹¤.');
                            if (modalLoginStatus) {
                                modalLoginStatus.textContent = 'âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨. ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.';
                                modalLoginStatus.style.color = '#f44336';
                            }
                        }
                    } catch (error) {
                        console.error('âŒ ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
                        console.error('âŒ ì˜¤ë¥˜ ìƒì„¸:', error.code, error.message);
                        if (modalLoginStatus) {
                            let errorMsg = 'âŒ ë¡œê·¸ì¸ ì˜¤ë¥˜: ';
                            if (error.code === 'auth/user-not-found') {
                                errorMsg += 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                            } else if (error.code === 'auth/wrong-password') {
                                errorMsg += 'ë¹„ë°€ë²ˆí˜¸ê°€ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.';
                            } else if (error.code === 'auth/invalid-email') {
                                errorMsg += 'ì´ë©”ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                            } else {
                                errorMsg += error.message;
                            }
                            modalLoginStatus.textContent = errorMsg;
                            modalLoginStatus.style.color = '#f44336';
                        }
                    }
                };
                
                // Enter í‚¤ë¡œ ë¡œê·¸ì¸
                if (modalLoginPassword) {
                    modalLoginPassword.onkeypress = function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            modalLoginBtn.click();
                        }
                    };
                }
                
                // ì´ë©”ì¼ ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
                if (modalLoginEmail) {
                    setTimeout(() => modalLoginEmail.focus(), 100);
                }
                
                loginModalInitialized = true;
                console.log('âœ… ë¡œê·¸ì¸ ëª¨ë‹¬ ì´ˆê¸°í™” ì™„ë£Œ');
            } else if (!modalLoginBtn) {
                console.error('âŒ ë¡œê·¸ì¸ ëª¨ë‹¬ ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                // ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„
                setTimeout(initializeLoginModal, 100);
            }
        }
        
        // ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì¦‰ì‹œ ë¡œê·¸ì¸ ëª¨ë‹¬ ì´ˆê¸°í™” ì‹œë„
        (function() {
            if (document.readyState === 'loading') {
                // DOMì´ ë¡œë“œë˜ê¸° ì „ì´ë©´ ëŒ€ê¸°
                document.addEventListener('DOMContentLoaded', function() {
                    setTimeout(initializeLoginModal, 50);
                });
            } else {
                // DOMì´ ì´ë¯¸ ë¡œë“œë˜ì—ˆìœ¼ë©´ ì¦‰ì‹œ ì‹¤í–‰
                setTimeout(initializeLoginModal, 50);
            }
        })();
        
        // ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ (ì½˜ì†”ì—ì„œ ì‚¬ìš© ê°€ëŠ¥)
        window.initializeLoginModal = initializeLoginModal;
        window.showLoginModal = showLoginModal;
        window.hideLoginModal = hideLoginModal;
        
        // Firebase ì¸ì¦ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ë° ì´ˆê¸° ì—­í•  ë¡œë“œ
        // âš ï¸ setupFirebaseAuthListener()ê°€ ì´ë¯¸ roleì„ ë¡œë“œí•˜ë¯€ë¡œ loadUserRole() í˜¸ì¶œ ì œê±°
        // Firestoreê°€ ë‹¨ì¼ ì§„ì‹¤ ì†ŒìŠ¤ì´ë©°, setupFirebaseAuthListener()ê°€ onAuthStateChangedì—ì„œ roleì„ ë¡œë“œí•©ë‹ˆë‹¤.
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', async function() {
                // ë¨¼ì € ë¡œê·¸ì¸ ëª¨ë‹¬ ì´ˆê¸°í™” ë° í‘œì‹œ
                initializeLoginModal();
                
                // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ ì²´í¬
                checkLoginOnPageLoad();
                
                // ê¸°ë³¸ Admin UIDë¥¼ Firestoreì— ì„¤ì • (ë¹„ë™ê¸°, ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰)
                ensureDefaultAdminInFirestore().catch(err => {
                    console.warn('ê¸°ë³¸ Admin UID ì„¤ì • ì‹¤íŒ¨ (ê³„ì† ì§„í–‰):', err);
                });
                
                // âš ï¸ í˜ì´ì§€ ë¡œë“œ ì‹œ UIë¥¼ viewerë¡œ ì ê¸ˆ (Firestore role ë¡œë”© ì „)
                console.log('[í˜ì´ì§€ ë¡œë“œ] UI ì´ˆê¸°ê°’ í™•ì¸:', userRole);
                if (userRole !== 'viewer') {
                    console.warn('[í˜ì´ì§€ ë¡œë“œ] âš ï¸ ì´ˆê¸°ê°’ì´ viewerê°€ ì•„ë‹™ë‹ˆë‹¤. viewerë¡œ ì„¤ì •í•©ë‹ˆë‹¤.');
                    userRole = 'viewer';
                    allowedProcesses = [];
                }
                applyRoleBasedUI();
                console.log('[í˜ì´ì§€ ë¡œë“œ] âœ… UIë¥¼ viewerë¡œ ì ê¸ˆ (Firestore role ë¡œë”© ì „)');
                
                // setupFirebaseAuthListener()ê°€ roleì„ ë¡œë“œí•˜ë¯€ë¡œ ë³„ë„ë¡œ loadUserRole() í˜¸ì¶œí•˜ì§€ ì•ŠìŒ
                setupFirebaseAuthListener();
            });
        } else {
            // ë¨¼ì € ë¡œê·¸ì¸ ëª¨ë‹¬ ì´ˆê¸°í™” ë° í‘œì‹œ
            initializeLoginModal();
            
            // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ ì²´í¬
            checkLoginOnPageLoad();
            
            // âš ï¸ í˜ì´ì§€ ë¡œë“œ ì‹œ UIë¥¼ viewerë¡œ ì ê¸ˆ (Firestore role ë¡œë”© ì „)
            console.log('[í˜ì´ì§€ ë¡œë“œ] UI ì´ˆê¸°ê°’ í™•ì¸:', userRole);
            if (userRole !== 'viewer') {
                console.warn('[í˜ì´ì§€ ë¡œë“œ] âš ï¸ ì´ˆê¸°ê°’ì´ viewerê°€ ì•„ë‹™ë‹ˆë‹¤. viewerë¡œ ì„¤ì •í•©ë‹ˆë‹¤.');
                userRole = 'viewer';
                allowedProcesses = [];
            }
            applyRoleBasedUI();
            console.log('[í˜ì´ì§€ ë¡œë“œ] âœ… UIë¥¼ viewerë¡œ ì ê¸ˆ (Firestore role ë¡œë”© ì „)');
            
            // ê¸°ë³¸ Admin UIDë¥¼ Firestoreì— ì„¤ì • (ë¹„ë™ê¸°, ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰)
            ensureDefaultAdminInFirestore().catch(err => {
                console.warn('ê¸°ë³¸ Admin UID ì„¤ì • ì‹¤íŒ¨ (ê³„ì† ì§„í–‰):', err);
            });
            
            // setupFirebaseAuthListener()ê°€ roleì„ ë¡œë“œí•˜ë¯€ë¡œ ë³„ë„ë¡œ loadUserRole() í˜¸ì¶œí•˜ì§€ ì•ŠìŒ
            setupFirebaseAuthListener();
        }
        
        // ì—­í•  ì„¤ì • í•¨ìˆ˜ (ì½˜ì†”ì—ì„œ ì‚¬ìš© ê°€ëŠ¥)
        // Editor ì—­í•  ì˜ˆì‹œ:
        // - Editor 1: setUserRole('editor', [1])           // ê³µì • 1ë§Œ (ì£¼ê¸°ë‘¥ì»¤íŒ…)
        // - Editor 2: setUserRole('editor', [2])           // ê³µì • 2ë§Œ (ê¸°ë‘¥ì†Œë¶€ì¬ì»¤íŒ…)
        // - Editor 3: setUserRole('editor', [3, 4, 5])     // ê³µì • 3, 4, 5 (ì£¼ê¸°ë‘¥ì¡°ë¦½, ì†Œë¶€ì¬ì¡°ë¦½, í˜„ì¥ë°°ì†¡)
        // - Editor 4: setUserRole('editor', [6])           // ê³µì • 6ë§Œ (í˜„ì¥ì„¤ì¹˜)
        // âš ï¸ ì´ í•¨ìˆ˜ëŠ” Firestoreì—ì„œ ë¡œë“œí•œ roleì„ ì„¤ì •í•˜ëŠ” ë°ë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤.
        // âš ï¸ ìˆ˜ë™ìœ¼ë¡œ roleì„ ë³€ê²½í•˜ë ¤ë©´ Firestoreì—ì„œ members ë¬¸ì„œë¥¼ ìˆ˜ì •í•˜ì„¸ìš”.
        // âš ï¸ ì´ í•¨ìˆ˜ëŠ” ì˜¤ì§ Firestore members.role ê°’ë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.
        // âš ï¸ emailì´ë‚˜ localStorage ê°’ì€ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        function setUserRole(role, processes = []) {
            // âš ï¸ Firestoreê°€ ë‹¨ì¼ ì§„ì‹¤ ì†ŒìŠ¤ì´ë¯€ë¡œ, ì—¬ê¸°ì„œëŠ” ë°›ì€ roleì„ ê·¸ëŒ€ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
            // ğŸ”’ localStorage ì €ì¥ ì œê±° - Firestoreê°€ ë‹¨ì¼ ì§„ì‹¤ ì†ŒìŠ¤ì´ë¯€ë¡œ localStorageì— ì €ì¥í•˜ì§€ ì•ŠìŒ
            // localStorage ì €ì¥ì´ ë‚˜ì¤‘ì— roleì„ ë®ì–´ì“°ëŠ” ì›ì¸ì´ ë  ìˆ˜ ìˆìŒ
            // âš ï¸ roleì€ ì˜¤ì§ Firestore members.role ê°’ë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.
            userRole = role;
            allowedProcesses = processes;
            // localStorage.setItem('kcol:userRole', role); // ì œê±°: localStorage ë®ì–´ì“°ê¸° ë°©ì§€
            // localStorage.setItem('kcol:allowedProcesses', JSON.stringify(processes)); // ì œê±°: localStorage ë®ì–´ì“°ê¸° ë°©ì§€
            // âš ï¸ applyRoleBasedUIëŠ” ì˜¤ì§ Firestoreì—ì„œ ë¡œë“œí•œ roleë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.
            applyRoleBasedUI(role, processes);
            
            // âœ… role ì ìš© ì§í›„ì—ë§Œ í˜¸ì¶œ - Admin íŒ¨ë„ display ì œì–´
            renderUIByRole(role);
            
            // âœ… ì—­í•  ì„¤ì • ì™„ë£Œ ë©”ì‹œì§€ (í™”ë©´ì— í‘œì‹œë˜ëŠ” ë©”ì‹œì§€)
            console.log(`âœ… ì—­í•  ì„¤ì • ì™„ë£Œ: ${role}`, processes.length > 0 ? `(í—ˆìš© ê³µì •: ${processes.join(', ')})` : '');
            console.log(`ğŸ“‹ [ì—­í•  í™•ì¸] í˜„ì¬ ì„¤ì •ëœ ì—­í• : ${role}`);
            console.log(`ğŸ“‹ [ì—­í•  í™•ì¸] Firestore ê²½ë¡œ: projects/${window.PROJECT_ID || 'N/A'}/members/${firebaseAuth?.currentUser?.uid || '(ë¡œê·¸ì¸ ì•ˆ ë¨)'}`);
            console.log(`ğŸ’¡ Firestore ë°ì´í„°ì™€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.`);
            console.log(`ğŸ”’ localStorage ì €ì¥ ì œê±°ë¨ - Firestoreê°€ ë‹¨ì¼ ì§„ì‹¤ ì†ŒìŠ¤`);
            
            // Editor ì—­í•  ì•ˆë‚´
            if (role === 'editor' && processes.length > 0) {
                const processNames = processes.map(p => {
                    const proc = PROCESSES.find(pr => pr.id === p);
                    return proc ? `${p}.${proc.name}` : `${p}`;
                }).join(', ');
                console.log(`ğŸ“ EditorëŠ” ë‹¤ìŒ ê³µì •ë§Œ ìˆ˜ì • ê°€ëŠ¥í•©ë‹ˆë‹¤: ${processNames}`);
            }
        }
        
        // ============================================================
        // í† ìŠ¤íŠ¸ í—¬í¼ (ì•¡ì…˜ ë²„íŠ¼ í¬í•¨)
        // ============================================================
        let toastTimer = null;
        
        // ê¶Œí•œ ì•ˆë‚´ìš© ì‹¬í”Œ í† ìŠ¤íŠ¸ (ê¸°ì¡´ showToastì™€ ë³„ë„)
        function showSimpleToast(msg, ms = 2000) {
            const toast = document.getElementById("toast");
            const msgEl = document.getElementById("toast-msg");
            const btn = document.getElementById("toast-action");
            if (!toast || !msgEl) return;
            
            msgEl.textContent = msg;
            if (btn) btn.style.display = "none";
            toast.classList.add("show");
            
            clearTimeout(toastTimer);
            toastTimer = setTimeout(() => {
                toast.classList.remove("show");
            }, ms);
        }
        
        // ì•¡ì…˜ í† ìŠ¤íŠ¸ í•¨ìˆ˜ (ê¶Œí•œ ìš”ì²­ ë²„íŠ¼ í¬í•¨)
        function showActionToast(msg, {
            ms = 3000,
            actionText = null,
            onAction = null
        } = {}) {
            const toast = document.getElementById("toast");
            const msgEl = document.getElementById("toast-msg");
            const btn = document.getElementById("toast-action");
            if (!toast || !msgEl || !btn) return;

            msgEl.textContent = msg;

            // ë²„íŠ¼ ì„¤ì •
            if (actionText && typeof onAction === "function") {
                btn.textContent = actionText;
                btn.style.display = "inline-block";
                btn.onclick = () => {
                    try { onAction(); } finally { hideToast(); }
                };
            } else {
                btn.style.display = "none";
                btn.onclick = null;
            }

            toast.classList.add("show");

            clearTimeout(toastTimer);
            toastTimer = setTimeout(hideToast, ms);

            function hideToast() {
                toast.classList.remove("show");
                btn.style.display = "none";
                btn.onclick = null;
            }
        }
        
        // ============================================================
        // ê³µí†µ í—¬í¼ í•¨ìˆ˜
        // ============================================================
        
        // target ì‹ë³„ì ë§Œë“¤ê¸°(ë¡œê·¸ìš©)
        function getTargetLabel(el) {
            if (!el) return "unknown";
            const id = el.id ? `#${el.id}` : "";
            const cls = (el.className && typeof el.className === "string")
                ? "." + el.className.trim().split(/\s+/).slice(0, 3).join(".")
                : "";
            return `${el.tagName.toLowerCase()}${id}${cls}`;
        }
        
        // ê¶Œí•œ ì²´í¬ í•¨ìˆ˜
        function hasProcessPermission(processId) {
            const role = (window.userRole ?? "viewer").toString().trim().toLowerCase();
            const allowed = Array.isArray(window.allowedProcesses) 
                ? window.allowedProcesses.map(n => Number(n)).filter(n => Number.isFinite(n))
                : [];
            
            // adminì€ allowedProcesses ê²€ì‚¬ ì—†ì´ ì „ë¶€ í†µê³¼
            if (role === "admin") return true;
            
            // processIdê°€ ìˆ«ìì´ê³  allowedì— í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ í†µê³¼
            const p = Number(processId);
            return Number.isFinite(p) && allowed.includes(p);
        }
        
        // ì¿¨ë‹¤ìš´ ë©”ì»¤ë‹ˆì¦˜ (ì¤‘ë³µ ë¡œê·¸ í­ì£¼ ë°©ì§€)
        let lastDeniedAt = 0;
        function deniedCooldown(ms = 1500) {
            const now = Date.now();
            if (now - lastDeniedAt < ms) return true;
            lastDeniedAt = now;
            return false;
        }
        
        // ê¶Œí•œ ê±°ë¶€ ì²˜ë¦¬ ê³µí†µ(ë¡œê·¸ + í† ìŠ¤íŠ¸)
        function handlePermissionDenied({ processId, action, el }) {
            // ì¿¨ë‹¤ìš´ ì²´í¬
            if (deniedCooldown()) return;
            
            const projectId = window.PROJECT_ID;
            const uid = window.currentUid || firebaseAuth?.currentUser?.uid;
            const role = (window.userRole ?? "viewer").toString().trim().toLowerCase();

            // 1) ë¡œê·¸ ì €ì¥(ë¹„ë™ê¸°, ì‹¤íŒ¨í•´ë„ UXëŠ” ì§„í–‰)
            logPermissionDenied({
                projectId,
                uid,
                role,
                processId,
                action,                       // "click" | "input" | "focus" ë“±
                target: getTargetLabel(el),
                reason: el?.getAttribute("data-deny-msg") || null
            });

            // 2) ì•¡ì…˜ í† ìŠ¤íŠ¸(ê¶Œí•œ ìš”ì²­ ë²„íŠ¼)
            showActionToast(el?.getAttribute("data-deny-msg") || "í•´ë‹¹ ì‘ì—…ì— ëŒ€í•œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.", {
                ms: 3500,
                actionText: uid ? "ê¶Œí•œ ìš”ì²­" : null,
                onAction: uid ? () => requestPermissionForProcess(processId) : null
            });
        }
        
        // ============================================================
        // ë‚´ member ë¬¸ì„œ ì‹¤ì‹œê°„ ê°ì‹œ (role/allowedProcesses ë³€ê²½ ê°ì§€)
        // 
        // âœ… ê°€ì¥ ê¹”ë”í•œ ë§ˆë¬´ë¦¬:
        // - members/{uid} ë¬¸ì„œë¥¼ onSnapshotìœ¼ë¡œ êµ¬ë…
        // - ìŠ¹ì¸/ë³€ê²½ ì‹œ applyRoleBasedUI(role, allowedProcesses) ì¬í˜¸ì¶œí•˜ì—¬
        //   ì‚¬ìš©ì í™”ë©´ì—ì„œ ì¦‰ì‹œ ê¶Œí•œ ë°˜ì˜
        // ============================================================
        function watchMyMemberDoc() {
            var projectId = window.PROJECT_ID;
            var uid = firebaseAuth.currentUser ? firebaseAuth.currentUser.uid : null;
            return startMyMemberDocListener(projectId, uid);
        }
        
        // ============================================================
        // ê¶Œí•œ ìš”ì²­ ë¡œê·¸ ì €ì¥ (Firestore)
        // ============================================================
        async function logPermissionDenied({ projectId, uid, role, processId, action, target, reason }) {
            if (!initFirebase() || !projectId || !uid) {
                console.warn("[PERM] logPermissionDenied: Firebase ì´ˆê¸°í™” ì‹¤íŒ¨ ë˜ëŠ” í•„ìˆ˜ íŒŒë¼ë¯¸í„° ì—†ìŒ");
                return;
            }
            
            try {
                const ref = firebaseDb.collection("projects").doc(projectId)
                    .collection("permission_requests");
                
                const data = {
                    uid: uid,
                    role: role || "viewer",
                    processId: processId || null,
                    action: action || "click",
                    target: target || "unknown",
                    page: location.pathname + location.search,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    status: "requested"  // ë‚˜ì¤‘ì— adminì´ approved/deniedë¡œ ë°”ê¾¸ê²Œ í•  ìˆ˜ ìˆìŒ
                };
                
                // reason í•„ë“œ ì¶”ê°€ (ìˆëŠ” ê²½ìš°ë§Œ)
                if (reason) {
                    data.reason = reason;
                }
                
                await ref.add(data);
                console.log("[PERM] request logged:", { projectId, uid, processId });
            } catch (e) {
                console.warn("[PERM] log failed:", e);
            }
        }
        
        // ============================================================
        // ê¶Œí•œ ìš”ì²­ í•¨ìˆ˜
        // ============================================================
        function requestPermissionForProcess(processId) {
            const projectId = window.PROJECT_ID;
            const uid = window.currentUid || firebaseAuth?.currentUser?.uid;
            const role = (window.userRole ?? "viewer").toString();

            if (!uid) {
                showActionToast("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.", { ms: 2000 });
                return;
            }

            logPermissionDenied({
                projectId,
                uid,
                role,
                processId,
                action: "request",
                target: "toast-action"
            });

            showActionToast("ìš”ì²­ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.", { ms: 1500 });
        }
        
        // ============================================================
        // í”„ë¡œì íŠ¸ Role ê¸°ë°˜ UI ì œì–´
        // 
        // âš ï¸ ì¤‘ìš”: ì´ í•¨ìˆ˜ëŠ” ì˜¤ì§ projects/{projectId}/members/{uid}.role ê°’ë§Œ ê¸°ì¤€ìœ¼ë¡œ UIë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤.
        // email, portalRole, localStorage ê°’ì€ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        // 
        // âš ï¸ role/UIì—ëŠ” self-update ìŠ¤í‚µì„ ì ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        // í•­ìƒ ìµœì‹  role ê°’ìœ¼ë¡œ UIë¥¼ ì¬ë Œë”ë§í•©ë‹ˆë‹¤.
        // ============================================================
        // ============================================================
        // applyRoleBasedUI: ë‹¨ì¼ ì œì–´ë¡œ ìœ ì§€
        // 
        // ğŸ”’ ì¬ë°œ ë°©ì§€ ê·œì¹™ 2: admin-panelì˜ display ì œì–´ëŠ” applyRoleBasedUI í•œ ê³³ë§Œ
        // ============================================================
        function applyRoleBasedUI(latestRole = null, latestAllowedProcesses = null) {
            // ============================================================
            // âœ… role + allowedProcessesë¡œ UIë¥¼ ë‹¨ì¼ í•¨ìˆ˜ì—ì„œ í†µì œ
            // í•µì‹¬: ë³´ì´ê¸°/ìˆ¨ê¸°ê¸° + í™œì„±í™”/ë¹„í™œì„±í™”ë¥¼ í•œ ê³³ì—ì„œë§Œ
            // ============================================================
            
            const role = (latestRole ?? window.userRole ?? "viewer").toString().trim().toLowerCase();
            const allowed = Array.isArray(latestAllowedProcesses ?? window.allowedProcesses)
                ? (latestAllowedProcesses ?? window.allowedProcesses)
                : [];

            // window.userRoleê³¼ window.allowedProcesses ì—…ë°ì´íŠ¸
            window.userRole = role;
            window.allowedProcesses = allowed;
            
            // -----------------------------
            // 0) ê¸°ë³¸ ê°€ë“œ ë¡œê·¸
            // -----------------------------
            console.log("[applyRoleBasedUI] role =", role, "allowed =", allowed);

            // -----------------------------
            // 1) admin-panel: ë‹¨ì¼ ì œì–´
            // -----------------------------
            const adminPanel = document.getElementById("admin-panel");
            if (adminPanel) {
                adminPanel.style.display = "none";
                if (role === "admin") adminPanel.style.display = "block";
            }

            // -----------------------------
            // 2) role ê¸°ë°˜ í‘œì‹œ ì˜ì—­ ì²˜ë¦¬
            //    data-role-visible="admin,editor" í˜•ì‹
            // -----------------------------
            const roleVisibleEls = document.querySelectorAll("[data-role-visible]");
            roleVisibleEls.forEach((el) => {
                const allowRoles = (el.getAttribute("data-role-visible") || "")
                    .split(",")
                    .map(s => s.trim().toLowerCase())
                    .filter(Boolean);

                // ê¸°ë³¸ ìˆ¨ê¹€ â†’ í—ˆìš© roleì´ë©´ í‘œì‹œ
                el.style.display = "none";
                if (allowRoles.includes(role)) el.style.display = "";
            });

            // -----------------------------
            // 3) allowedProcesses ê¸°ë°˜ ì°¨ë‹¨/ì•ˆë‚´ (data-process)
            // 
            // âœ… ìµœì¢… ì¶”ì²œ êµ¬í˜„:
            // - data-process ê¸°ë°˜ ê¶Œí•œ ì°¨ë‹¨
            // - handlePermissionDenied()ë¡œ ë¡œê·¸ + ì•¡ì…˜ í† ìŠ¤íŠ¸ ì²˜ë¦¬
            // - click / focus / keydown / paste / beforeinput ëª¨ë‘ capture ë‹¨ê³„ì—ì„œ ì°¨ë‹¨
            // -----------------------------
            document.querySelectorAll("[data-process]").forEach((el) => {
                const p = Number(el.getAttribute("data-process"));

                // ì‹œê°ì  íŒíŠ¸(í˜„ì¬ ê¶Œí•œ ê¸°ì¤€)
                const okForStyle = hasProcessPermission(p);
                el.style.opacity = okForStyle ? "" : "0.5";
                el.style.cursor = okForStyle ? "" : "not-allowed";
                el.disabled = false; // í´ë¦­ ê°€ëŠ¥ ìœ ì§€ (ì°¨ë‹¨ì€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆì—ì„œ)

                // ì¤‘ë³µ ë°”ì¸ë”© ë°©ì§€
                if (el.__permBound) return;
                el.__permBound = true;

                // âœ… í´ë¦­ ì°¨ë‹¨ + ë¡œê·¸ + ì•¡ì…˜ í† ìŠ¤íŠ¸ (capture ë‹¨ê³„)
                el.addEventListener("click", (e) => {
                    if (hasProcessPermission(p)) return;

                    e.preventDefault();
                    e.stopPropagation();
                    handlePermissionDenied({ processId: p, action: "click", el });
                }, true); // capture=true â†’ ê¸°ì¡´ í•¸ë“¤ëŸ¬ë³´ë‹¤ ë¨¼ì € ì‹¤í–‰

                // âœ… ì…ë ¥ ì°¨ë‹¨ + ë¡œê·¸ + ì•¡ì…˜ í† ìŠ¤íŠ¸ (INPUT/TEXTAREA/SELECT)
                if (["INPUT", "TEXTAREA", "SELECT"].includes(el.tagName)) {

                    // focusì—ì„œ ì•ˆë‚´ (capture ë‹¨ê³„)
                    el.addEventListener("focus", (e) => {
                        if (hasProcessPermission(p)) return;

                        e.preventDefault();
                        e.stopPropagation();
                        handlePermissionDenied({ processId: p, action: "focus", el });
                        el.blur();
                    }, true);

                    // í‚¤ ì…ë ¥ ì‹œë„ ì°¨ë‹¨ (capture ë‹¨ê³„)
                    el.addEventListener("keydown", (e) => {
                        if (hasProcessPermission(p)) return;

                        e.preventDefault();
                        e.stopPropagation();
                        handlePermissionDenied({ processId: p, action: "input", el });
                        el.blur();
                    }, true);

                    // âœ… ë¶™ì—¬ë„£ê¸° ì‹œë„ ì°¨ë‹¨ (ë§ˆìš°ìŠ¤/ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ í¬í•¨, capture ë‹¨ê³„)
                    el.addEventListener("paste", (e) => {
                        if (hasProcessPermission(p)) return;

                        e.preventDefault();
                        e.stopPropagation();
                        handlePermissionDenied({ processId: p, action: "paste", el });
                        el.blur();
                    }, true);

                    // âœ… ëª¨ë°”ì¼/IME ë“± ë‹¤ì–‘í•œ ì…ë ¥ ì´ë²¤íŠ¸ ì°¨ë‹¨ (capture ë‹¨ê³„)
                    el.addEventListener("beforeinput", (e) => {
                        if (hasProcessPermission(p)) return;

                        e.preventDefault();
                        e.stopPropagation();
                        handlePermissionDenied({ processId: p, action: "beforeinput", el });
                        el.blur();
                    }, true);
                }
            });

            // -----------------------------
            // 4) ê¶Œí•œ ì—†ì„ ë•Œ ì•ˆë‚´ (ì„ íƒ)
            // -----------------------------
            const noPerm = document.getElementById("no-permission");
            if (noPerm) {
                // ì˜ˆ: viewerì´ê³  allowedProcessesê°€ ë¹„ì–´ìˆìœ¼ë©´ ê¶Œí•œ ì—†ìŒ í‘œì‹œ
                const showNoPerm = (role === "viewer" && allowed.length === 0);
                noPerm.style.display = showNoPerm ? "block" : "none";
            }

            // -----------------------------
            // 5) ìµœì¢… í™•ì¸ ë¡œê·¸
            // -----------------------------
            if (adminPanel) {
                console.log("[admin-panel computed display]", getComputedStyle(adminPanel).display);
            }
            
            // âœ… effectiveRoleì€ ì´ë¯¸ applyRoleBasedUIì—ì„œ ì ìš©ëœ ìµœì¢… ì—­í• 
            console.log("[PROJECT ROLE FINAL]", {
                role: role,
                allowedProcesses: allowed,
                note: "effectiveRoleì€ processRole ìš°ì„ , portalRole ì •ì±… ì ìš©ë¨"
            });
            
            // ============================================================
            // ê¸°ì¡´ ë³µì¡í•œ ë¡œì§ ìœ ì§€ (í•˜ìœ„ í˜¸í™˜ì„±)
            // ============================================================
            const currentRole = role;
            const currentAllowedProcesses = allowed;
            
            // ì—­í• ì´ ì—†ìœ¼ë©´ ëª¨ë“  ê¸°ëŠ¥ ë¹„í™œì„±í™”
            if (!currentRole) {
                const workDateInput = document.getElementById('work-date');
                const columnGridInput = document.getElementById('column-grid-input');
                const saveButton = document.querySelector('#panel-input button[onclick*="saveSelectedColumns"]');
                
                if (workDateInput) workDateInput.disabled = true;
                if (columnGridInput) {
                    columnGridInput.style.pointerEvents = 'none';
                    columnGridInput.style.opacity = '0.3';
                }
                if (saveButton) saveButton.disabled = true;
                disableProcessButtons([]);
                return;
            }
            
            const isViewer = currentRole === 'viewer';
            const isEditor = currentRole === 'editor';
            const isAdmin = currentRole === 'admin';
            
            // ì¼ì¼ì…ë ¥ íŒ¨ë„ ì œì–´
            const workDateInput = document.getElementById('work-date');
            const columnGridInput = document.getElementById('column-grid-input');
            const saveButton = document.querySelector('#panel-input button[onclick*="saveSelectedColumns"]');
            
            // Admin ì„¤ì • ì˜ì—­ ìˆ¨ê¹€ (ê¸°ë³¸ê°’, Adminì¸ ê²½ìš°ì—ë§Œ í‘œì‹œ)
            const adminRoleSettings = document.getElementById('admin-role-settings');
            if (adminRoleSettings) {
                adminRoleSettings.style.display = 'none';
            }
            
            // âœ… 2ë‹¨ê³„: Admin ë¶„ê¸° ìµœìš°ì„  ì²˜ë¦¬ (allowedProcesses ë¬´ì‹œ)
            if (isAdmin) {
                // Admin: ëª¨ë“  ê³µì • ìˆ˜ì • ê°€ëŠ¥ + ìš´ì†¡ì°¨ìˆ˜ê³„íš ì‚¬ìš© ê°€ëŠ¥
                // âœ… allowedProcesses ë¬´ì‹œí•˜ê³  ëª¨ë“  ê¸°ëŠ¥ í™œì„±í™”
                if (workDateInput) {
                    workDateInput.disabled = false;
                    workDateInput.style.opacity = '1';
                    workDateInput.title = '';
                }
                if (columnGridInput) {
                    columnGridInput.style.pointerEvents = 'auto';
                    columnGridInput.style.opacity = '1';
                }
                if (saveButton) {
                    saveButton.disabled = false;
                    saveButton.style.opacity = '1';
                    saveButton.title = '';
                }
                disableProcessButtons([]); // ë¹ˆ ë°°ì—´ = ëª¨ë“  ê³µì • í™œì„±í™”
                showRoleBadge('admin', 'ê´€ë¦¬ì - ëª¨ë“  ê¶Œí•œ');
                
                // ìš´ì†¡ì°¨ìˆ˜ê³„íš íŒ¨ë„ í™œì„±í™” (Adminë§Œ)
                enableTransportPanel(true);
                
                // Admin ì„¤ì • ì˜ì—­ í‘œì‹œ (Adminë§Œ ë³¼ ìˆ˜ ìˆìŒ)
                if (adminRoleSettings) {
                    adminRoleSettings.style.display = 'block';
                }
                return; // âœ… Admin ì²˜ë¦¬ ì™„ë£Œ í›„ ì¦‰ì‹œ return
            }
            
            if (isViewer) {
                // Viewer: ì½ê¸° ì „ìš© - ëª¨ë“  ê³µì • ì…ë ¥ì°½ ë¹„í™œì„±í™” (íë¦¿í•˜ê²Œ - opacity: 0.25)
                if (workDateInput) {
                    workDateInput.disabled = true;
                    workDateInput.style.opacity = '0.25';
                    workDateInput.title = 'ViewerëŠ” ì¼ì¼ì…ë ¥ì„ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                }
                if (columnGridInput) {
                    columnGridInput.style.pointerEvents = 'none';
                    columnGridInput.style.opacity = '0.25';
                }
                if (saveButton) {
                    saveButton.disabled = true;
                    saveButton.style.opacity = '0.25';
                    saveButton.title = 'ViewerëŠ” ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                }
                // ëª¨ë“  ê³µì • ë²„íŠ¼ ë¹„í™œì„±í™” (íë¦¿í•˜ê²Œ)
                disableProcessButtons([]);
                showRoleBadge('viewer', 'ì—´ëŒì - ì½ê¸° ì „ìš©');
            } else if (isEditor) {
                // Editor: í—ˆìš©ëœ ê³µì •ë§Œ ìˆ˜ì • ê°€ëŠ¥
                // currentProcessê°€ ì¤€ë¹„ë˜ì—ˆì„ ë•Œë§Œ ê³µì •ë³„ ê¶Œí•œ ì ìš©
                const currentProc = window.currentProcess ?? currentProcess ?? null;
                
                if (currentProc != null) {
                    // ê³µì •ì´ í™•ì •ëœ ê²½ìš°: í•´ë‹¹ ê³µì •ì— ëŒ€í•œ ê¶Œí•œ í™•ì¸
                    const canEdit = canEditProcess(currentProc);
                    
                    if (workDateInput) {
                        workDateInput.disabled = !canEdit;
                        workDateInput.style.opacity = canEdit ? '1' : '0.25';
                        workDateInput.title = canEdit ? '' : 'EditorëŠ” ì´ ê³µì •ì„ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ë³´ê¸°ë§Œ ê°€ëŠ¥)';
                    }
                    if (columnGridInput) {
                        columnGridInput.style.pointerEvents = canEdit ? 'auto' : 'none';
                        columnGridInput.style.opacity = canEdit ? '1' : '0.25';
                    }
                    if (saveButton) {
                        saveButton.disabled = !canEdit;
                        saveButton.style.opacity = canEdit ? '1' : '0.25';
                        saveButton.title = canEdit ? '' : 'EditorëŠ” ì´ ê³µì •ì„ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                    }
                } else {
                    // ê³µì •ì´ ì•„ì§ í™•ì •ë˜ì§€ ì•Šì€ ê²½ìš°: ê¸°ë³¸ í™œì„±í™” (ê³µì • ì„ íƒ í›„ ì¬ì ìš©ë¨)
                    if (workDateInput) {
                        workDateInput.disabled = false;
                        workDateInput.style.opacity = '1';
                        workDateInput.title = '';
                    }
                    if (columnGridInput) {
                        columnGridInput.style.pointerEvents = 'auto';
                        columnGridInput.style.opacity = '1';
                    }
                    if (saveButton) {
                        saveButton.disabled = false;
                        saveButton.style.opacity = '1';
                        saveButton.title = '';
                    }
                }
                
                disableProcessButtons(currentAllowedProcesses);
                
                // Excel ì—…ë¡œë“œ ë²„íŠ¼ ì œì–´ (EditorëŠ” í—ˆìš©ëœ ê³µì •ì´ ìˆì„ ë•Œë§Œ í™œì„±í™”)
                const processExcelFile = document.getElementById('process-excel-file');
                if (processExcelFile) {
                    if (currentAllowedProcesses.length > 0) {
                        processExcelFile.disabled = false;
                        processExcelFile.style.opacity = '1';
                        processExcelFile.style.pointerEvents = 'auto';
                        const allowedNames = currentAllowedProcesses.map(p => {
                            const proc = PROCESSES.find(pr => pr.id === p);
                            return proc ? `${p}.${proc.name}` : `${p}`;
                        }).join(', ');
                        processExcelFile.title = `ì—‘ì…€ íŒŒì¼ ì„ íƒ (*.xlsx)\ní—ˆìš©ëœ ê³µì •: ${allowedNames}\ní—ˆìš©ë˜ì§€ ì•Šì€ ê³µì • ë°ì´í„°ëŠ” ìë™ìœ¼ë¡œ ë¬´ì‹œë©ë‹ˆë‹¤.`;
                    } else {
                        processExcelFile.disabled = true;
                        processExcelFile.style.opacity = '0.5';
                        processExcelFile.style.pointerEvents = 'none';
                        processExcelFile.title = 'EditorëŠ” í—ˆìš©ëœ ê³µì •ì´ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.';
                    }
                }
                
                // ìš´ì†¡ë¬¼ëŸ‰ì‚°ì • Excel ì—…ë¡œë“œ ì œì–´ (EditorëŠ” ê³µì • 5ë§Œ í—ˆìš©)
                const transportVolumeFile = document.getElementById('transport-volume-file');
                if (transportVolumeFile) {
                    if (currentAllowedProcesses.includes(5)) {
                        transportVolumeFile.disabled = false;
                        transportVolumeFile.style.opacity = '1';
                        transportVolumeFile.style.pointerEvents = 'auto';
                        transportVolumeFile.title = 'ì—‘ì…€ íŒŒì¼ ì„ íƒ (*.xlsx)\ní˜„ì¥ë°°ì†¡(ê³µì • 5) ë°ì´í„°ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.';
                    } else {
                        transportVolumeFile.disabled = true;
                        transportVolumeFile.style.opacity = '0.5';
                        transportVolumeFile.style.pointerEvents = 'none';
                        transportVolumeFile.title = 'EditorëŠ” í˜„ì¥ë°°ì†¡(ê³µì • 5) ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.';
                    }
                }
                
                // ìš´ì†¡ì°¨ìˆ˜ê³„íšì€ Editor ì‚¬ìš© ë¶ˆê°€ (ì´ë¯¸ showPanelì—ì„œ ì°¨ë‹¨ë¨)
                const transportPlanFile = document.getElementById('transport-plan-file');
                if (transportPlanFile) {
                    transportPlanFile.disabled = true;
                    transportPlanFile.style.opacity = '0.5';
                    transportPlanFile.style.pointerEvents = 'none';
                    transportPlanFile.title = 'ìš´ì†¡ì°¨ìˆ˜ê³„íšì€ ê´€ë¦¬ì(Admin)ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                }
                
                const allowedNames = currentAllowedProcesses.map(p => {
                    const proc = PROCESSES.find(pr => pr.id === p);
                    return proc ? `${p}.${proc.name}` : `${p}`;
                }).join(', ');
                showRoleBadge('editor', `í¸ì§‘ì - ê³µì • ${allowedNames}ë§Œ ìˆ˜ì • ê°€ëŠ¥`);
            }
            // âœ… Admin ë¶„ê¸°ëŠ” ìœ„ì—ì„œ ì´ë¯¸ ì²˜ë¦¬ë¨ (ìµœìš°ì„  ì²˜ë¦¬, allowedProcesses ë¬´ì‹œ)
            
            // ì „ì²´ ì´ˆê¸°í™” ë²„íŠ¼ì€ data-role-visible="admin"ìœ¼ë¡œ ìë™ ì œì–´ë¨
        }
        
        // ìš´ì†¡ì°¨ìˆ˜ê³„íš íŒ¨ë„ í™œì„±í™”/ë¹„í™œì„±í™”
        function enableTransportPanel(enabled) {
            const transportPanel = document.getElementById('panel-transport');
            if (!transportPanel) return;
            
            // ëª¨ë“  ì…ë ¥ í•„ë“œì™€ ë²„íŠ¼ ì°¾ê¸°
            const fileInput = document.getElementById('transport-plan-file');
            const addButton = document.querySelector('button[onclick="addTransportTrip()"]');
            const removeButton = document.querySelector('button[onclick="removeTransportTrip()"]');
            const editButton = document.querySelector('button[onclick="editTransportTrip()"]');
            const saveButton = document.querySelector('button[onclick="saveTransportPlan()"]');
            const tripInput = document.getElementById('transport-trip-input');
            const tripEditInput = document.getElementById('transport-trip-edit-input');
            const transportGrid = document.getElementById('transport-column-grid');
            
            if (enabled) {
                // Admin: ëª¨ë“  ê¸°ëŠ¥ í™œì„±í™”
                if (fileInput) {
                    fileInput.disabled = false;
                    fileInput.style.opacity = '1';
                    fileInput.style.pointerEvents = 'auto';
                }
                if (addButton) {
                    addButton.disabled = false;
                    addButton.style.opacity = '1';
                    addButton.style.pointerEvents = 'auto';
                }
                if (removeButton) {
                    removeButton.disabled = false;
                    removeButton.style.opacity = '1';
                    removeButton.style.pointerEvents = 'auto';
                }
                if (editButton) {
                    editButton.disabled = false;
                    editButton.style.opacity = '1';
                    editButton.style.pointerEvents = 'auto';
                }
                if (saveButton) {
                    saveButton.disabled = false;
                    saveButton.style.opacity = '1';
                    saveButton.style.pointerEvents = 'auto';
                }
                if (tripInput) tripInput.disabled = false;
                if (tripEditInput) tripEditInput.disabled = false;
                if (transportGrid) {
                    transportGrid.style.pointerEvents = 'auto';
                    transportGrid.style.opacity = '1';
                }
            } else {
                // Editor/Viewer: ëª¨ë“  ê¸°ëŠ¥ ë¹„í™œì„±í™”
                if (fileInput) {
                    fileInput.disabled = true;
                    fileInput.style.opacity = '0.5';
                    fileInput.style.pointerEvents = 'none';
                    fileInput.title = 'ìš´ì†¡ì°¨ìˆ˜ê³„íšì€ ê´€ë¦¬ì(Admin)ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                }
                if (addButton) {
                    addButton.disabled = true;
                    addButton.style.opacity = '0.5';
                    addButton.style.pointerEvents = 'none';
                    addButton.title = 'ìš´ì†¡ì°¨ìˆ˜ê³„íšì€ ê´€ë¦¬ì(Admin)ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                }
                if (removeButton) {
                    removeButton.disabled = true;
                    removeButton.style.opacity = '0.5';
                    removeButton.style.pointerEvents = 'none';
                    removeButton.title = 'ìš´ì†¡ì°¨ìˆ˜ê³„íšì€ ê´€ë¦¬ì(Admin)ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                }
                if (editButton) {
                    editButton.disabled = true;
                    editButton.style.opacity = '0.5';
                    editButton.style.pointerEvents = 'none';
                    editButton.title = 'ìš´ì†¡ì°¨ìˆ˜ê³„íšì€ ê´€ë¦¬ì(Admin)ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                }
                if (saveButton) {
                    saveButton.disabled = true;
                    saveButton.style.opacity = '0.5';
                    saveButton.style.pointerEvents = 'none';
                    saveButton.title = 'ìš´ì†¡ì°¨ìˆ˜ê³„íšì€ ê´€ë¦¬ì(Admin)ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                }
                if (tripInput) {
                    tripInput.disabled = true;
                    tripInput.title = 'ìš´ì†¡ì°¨ìˆ˜ê³„íšì€ ê´€ë¦¬ì(Admin)ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                }
                if (tripEditInput) {
                    tripEditInput.disabled = true;
                    tripEditInput.title = 'ìš´ì†¡ì°¨ìˆ˜ê³„íšì€ ê´€ë¦¬ì(Admin)ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                }
                if (transportGrid) {
                    transportGrid.style.pointerEvents = 'none';
                    transportGrid.style.opacity = '0.5';
                }
            }
        }
        
        // ê³µì • ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
        // ê³µì • í¸ì§‘ ê¶Œí•œ í™•ì¸ í—¬í¼ í•¨ìˆ˜
        // âœ… Adminì€ allowedProcesses ë¬´ì‹œí•˜ê³  ë¬´ì¡°ê±´ true
        function canEditProcess(processNo) {
            if (!window.userRole) return false;

            // âœ… ADMINì€ ë¬´ì¡°ê±´ true
            if (window.userRole === 'admin') return true;

            // âŒ viewerëŠ” ì „ë¶€ ë¶ˆê°€
            if (window.userRole === 'viewer') return false;

            // editorë§Œ allowedProcesses ê²€ì‚¬
            if (window.userRole === 'editor') {
                if (!Array.isArray(window.allowedProcesses)) return false;
                const p = Number(processNo);
                return window.allowedProcesses.map(Number).includes(p);
            }

            return false;
        }
        
        function disableProcessButtons(allowedProcesses) {
            const processButtons = document.querySelectorAll('.process-btn');
            processButtons.forEach(btn => {
                const processId = parseInt(btn.dataset.process);
                const role = window.userRole || userRole || 'viewer';
                
                // âœ… Adminì€ ë¬´ì¡°ê±´ ëª¨ë“  ê³µì • í™œì„±í™” (allowedProcesses ë¬´ì‹œ)
                if (role === 'admin') {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                    btn.style.pointerEvents = 'auto';
                    btn.title = '';
                    return;
                }
                
                const canEdit = canEditProcess(processId);
                
                if (role === 'viewer') {
                    // Viewer: ëª¨ë“  ê³µì • ë²„íŠ¼ ë¹„í™œì„±í™” (íë¦¿í•˜ê²Œ - opacity: 0.25)
                    btn.disabled = true;
                    btn.style.opacity = '0.25';
                    btn.style.cursor = 'not-allowed';
                    btn.style.pointerEvents = 'none';
                    btn.title = 'ViewerëŠ” ê³µì •ì„ ì„ íƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì½ê¸° ì „ìš©)';
                } else if (role === 'editor') {
                    // Editor: í—ˆìš©ëœ ê³µì •ë§Œ í™œì„±í™”, ë‚˜ë¨¸ì§€ëŠ” ë¹„í™œì„±í™” (íë¦¿í•˜ê²Œ - opacity: 0.25)
                    if (canEdit) {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                        btn.style.cursor = 'pointer';
                        btn.style.pointerEvents = 'auto';
                        btn.title = '';
                    } else {
                        btn.disabled = true;
                        btn.style.opacity = '0.25';
                        btn.style.cursor = 'not-allowed';
                        btn.style.pointerEvents = 'none';
                        const proc = PROCESSES.find(p => p.id === processId);
                        btn.title = `EditorëŠ” ${proc ? proc.name : `ê³µì • ${processId}`}ì„ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ë³´ê¸°ë§Œ ê°€ëŠ¥)`;
                    }
                }
                // âœ… Admin ë¶„ê¸°ëŠ” ìœ„ì—ì„œ ì´ë¯¸ ì²˜ë¦¬ë¨ (ìµœìš°ì„  ì²˜ë¦¬)
            });
            
            // ê³µì •ë³„ ê°„íŠ¸ ì°¨íŠ¸ ì…€ë„ ê¶Œí•œì— ë”°ë¼ íë¦¿í•˜ê²Œ í‘œì‹œ
            applyProcessPermissionToGantt();
            
            // ê³µì •ë³„ ê¸°ë‘¥ ê·¸ë¦¬ë“œ ì…€ë„ ê¶Œí•œì— ë”°ë¼ íë¦¿í•˜ê²Œ í‘œì‹œ
            applyProcessPermissionToColumnGrid();
        }
        
        // ê°„íŠ¸ ì°¨íŠ¸ì— ê³µì •ë³„ ê¶Œí•œ ì ìš© (íë¦¿í•˜ê²Œ í‘œì‹œ)
        function applyProcessPermissionToGantt() {
            if (!userRole) return;
            
            // ê°„íŠ¸ ì°¨íŠ¸ì˜ ê³µì •ë³„ ì…€ ì°¾ê¸°
            const ganttCells = document.querySelectorAll('.gantt-cell[data-process]');
            ganttCells.forEach(cell => {
                const processId = parseInt(cell.dataset.process);
                const canEdit = canEditProcess(processId);
                
                if (userRole === 'viewer') {
                    // Viewer: ëª¨ë“  ê³µì • ì…€ íë¦¿í•˜ê²Œ (opacity: 0.25)
                    cell.style.opacity = '0.25';
                    cell.style.pointerEvents = 'none';
                } else if (userRole === 'editor') {
                    // Editor: í—ˆìš©ë˜ì§€ ì•Šì€ ê³µì • ì…€ íë¦¿í•˜ê²Œ (opacity: 0.25)
                    if (!canEdit) {
                        cell.style.opacity = '0.25';
                        cell.style.pointerEvents = 'none';
                    } else {
                        cell.style.opacity = '1';
                        cell.style.pointerEvents = 'auto';
                    }
                } else {
                    // Admin: ëª¨ë“  ê³µì • ì…€ ì •ìƒ í‘œì‹œ
                    cell.style.opacity = '1';
                    cell.style.pointerEvents = 'auto';
                }
            });
        }
        
        // ê¸°ë‘¥ ê·¸ë¦¬ë“œì— ê³µì •ë³„ ê¶Œí•œ ì ìš© (íë¦¿í•˜ê²Œ í‘œì‹œ)
        function applyProcessPermissionToColumnGrid() {
            // âœ… currentProcessê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ìŠ¤í‚µ
            if (currentProcess == null) {
                console.warn("[PERM] currentProcess not ready â†’ skip column grid permission");
                return;
            }

            // âœ… role ì¤€ë¹„ ì•ˆ ëìœ¼ë©´ ìŠ¤í‚µ
            if (!userRole) return;

            const canEdit = canEditProcess(currentProcess);
            const columnGrids = document.querySelectorAll(".column-grid");

            columnGrids.forEach((grid) => {
                if (userRole === "viewer") {
                    grid.style.opacity = "0.25";
                    grid.style.pointerEvents = "none";
                    return;
                }

                if (userRole === "editor") {
                    if (!canEdit) {
                        grid.style.opacity = "0.25";
                        grid.style.pointerEvents = "none";
                    } else {
                        grid.style.opacity = "1";
                        grid.style.pointerEvents = "auto";
                    }
                    return;
                }

                // admin
                grid.style.opacity = "1";
                grid.style.pointerEvents = "auto";
            });
        }
        
        // Firebase ì—°ê²° ìƒíƒœ í™•ì¸
        function getFirebaseConnectionStatus() {
            if (!initFirebase()) {
                return {
                    connected: false,
                    source: 'localStorage',
                    message: 'Firebase ë¯¸ì—°ê²° (localStorage ì‚¬ìš©)'
                };
            }
            
            const user = firebaseAuth.currentUser;
            if (user) {
                const firebaseUid = localStorage.getItem('kcol:firebaseUid');
                const isFromFirebase = firebaseUid === user.uid;
                
                return {
                    connected: true,
                    source: 'firebase',
                    uid: user.uid,
                    email: user.email || 'Anonymous',
                    message: isFromFirebase ? `Firebase ì—°ê²°ë¨ (${user.email || 'Anonymous'})` : 'Firebase ë¡œê·¸ì¸ë¨ (ì—­í• : localStorage)'
                };
            }
            
            return {
                connected: false,
                source: 'localStorage',
                message: 'Firebase ë¯¸ë¡œê·¸ì¸ (localStorage ì‚¬ìš©)'
            };
        }
        
        // ì—­í•  ë°°ì§€ í‘œì‹œ
        function showRoleBadge(role, label) {
            let badge = document.getElementById('user-role-badge');
            if (!badge) {
                badge = document.createElement('div');
                badge.id = 'user-role-badge';
                badge.style.cssText = 'position:fixed;top:20px;right:20px;background:#333;color:white;padding:8px 16px;border-radius:8px;font-size:12px;z-index:10000;box-shadow:0 2px 8px rgba(0,0,0,0.2);cursor:pointer;transition:all 0.2s;';
                badge.onclick = () => showRoleDetails(role);
                badge.onmouseenter = function() { this.style.transform = 'scale(1.05)'; this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)'; };
                badge.onmouseleave = function() { this.style.transform = 'scale(1)'; this.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)'; };
                document.body.appendChild(badge);
            }
            
            // âœ… ê¸€ì”¨ëŠ” í°ìƒ‰, ë°°ê²½ì€ ì£¼ë³€ê³¼ í†µì¼ (ë°°ê²½ìƒ‰ ì œê±°)
            badge.style.background = 'transparent';
            badge.style.color = '#fff';
            
            // labelì´ ì—†ìœ¼ë©´ roleì— ë§ëŠ” ê¸°ë³¸ ë¼ë²¨ ì‚¬ìš©
            if (!label || label === 'admin' || label === role) {
                const defaultLabels = {
                    'viewer': 'ì—´ëŒì - ì½ê¸° ì „ìš©',
                    'editor': 'í¸ì§‘ì',
                    'admin': 'ê´€ë¦¬ì - ëª¨ë“  ê¶Œí•œ'
                };
                label = defaultLabels[role] || label || role;
            }
            
            // Firebase ì—°ê²° ìƒíƒœ í™•ì¸ ë° í‘œì‹œ
            const firebaseStatus = getFirebaseConnectionStatus();
            let statusIcon = '';
            let statusText = '';
            
            if (firebaseStatus.connected) {
                statusIcon = 'ğŸŸ¢';
                statusText = ' (Firebase)';
            } else {
                statusIcon = 'ğŸŸ¡';
                statusText = ' (ë¡œì»¬)';
            }
            
            badge.textContent = `${label}${statusText}`;
            badge.title = `${label}\n${firebaseStatus.message}\ní´ë¦­í•˜ì—¬ ìƒì„¸ ì •ë³´ í™•ì¸`;
        }
        
        // ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ (ì½˜ì†”ì—ì„œ ì‚¬ìš© ê°€ëŠ¥)
        window.setUserRole = setUserRole;
        // userRoleê³¼ allowedProcessesë¥¼ ì§ì ‘ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ Object.defineProperty ì‚¬ìš©
        Object.defineProperty(window, 'userRole', {
            get: () => userRole,
            configurable: true
        });
        Object.defineProperty(window, 'allowedProcesses', {
            get: () => allowedProcesses,
            configurable: true
        });

        // ì—­í•  ìƒì„¸ ì •ë³´ ëª¨ë‹¬ í‘œì‹œ (ì œê±°ë¨ - Firebase ê´€ë ¨)
        function showRoleDetails(role) {
            // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
            const existingModal = document.getElementById('role-details-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // ëª¨ë‹¬ ìƒì„±
            const modal = document.createElement('div');
            modal.id = 'role-details-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10001;display:flex;align-items:center;justify-content:center;';
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            };
            
            const roleNames = {
                'viewer': 'ì—´ëŒì',
                'editor': 'í¸ì§‘ì',
                'admin': 'ê´€ë¦¬ì'
            };
            
            const roleDescriptions = {
                'viewer': 'ê³µì •í‘œ ì—´ëŒë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤. ì¼ì¼ì…ë ¥ ë° ìˆ˜ì •ì€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.',
                'editor': 'í—ˆìš©ëœ ê³µì •ì— ëŒ€í•´ì„œë§Œ ì¼ì¼ì…ë ¥ ë° ìˆ˜ì •ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.',
                'admin': 'ëª¨ë“  ê¶Œí•œì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤. ì‚¬ìš©ì ë° ê¶Œí•œ ê´€ë¦¬ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.'
            };
            
            const roleColors = {
                'viewer': '#9e9e9e',
                'editor': '#2196f3',
                'admin': '#f44336'
            };
            
            let contentHtml = `
                <div style="background:white;border-radius:12px;padding:30px;max-width:500px;width:90%;box-shadow:0 4px 20px rgba(0,0,0,0.3);">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                        <h2 style="margin:0;color:#333;display:flex;align-items:center;gap:10px;">
                            <span style="font-size:24px;">ğŸ‘¤</span>
                            <span>${roleNames[role] || role}</span>
                        </h2>
                        <button onclick="document.getElementById('role-details-modal').remove()" style="background:none;border:none;font-size:24px;cursor:pointer;color:#666;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;">&times;</button>
                    </div>
                    <div style="margin-bottom:20px;padding:15px;background:#f5f5f5;border-radius:8px;border-left:4px solid ${roleColors[role] || '#333'};">
                        <p style="margin:0;color:#666;line-height:1.6;">${roleDescriptions[role] || 'ì—­í•  ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.'}</p>
                    </div>
            `;
            
            // Firebase ì—°ê²° ìƒíƒœ í‘œì‹œ
            const firebaseStatus = getFirebaseConnectionStatus();
            if (firebaseStatus.connected) {
                contentHtml += `
                    <div style="margin-bottom:20px;padding:15px;background:#e8f5e9;border-radius:8px;border-left:4px solid #4caf50;">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                            <span style="font-size:18px;">ğŸŸ¢</span>
                            <strong style="color:#2e7d32;">Firebase ì—°ê²°ë¨</strong>
                        </div>
                        <div style="font-size:13px;color:#555;line-height:1.6;">
                            <div><strong>UID:</strong> ${firebaseStatus.uid}</div>
                            <div><strong>ì´ë©”ì¼:</strong> ${firebaseStatus.email}</div>
                            <div style="margin-top:8px;padding-top:8px;border-top:1px solid #c8e6c9;color:#2e7d32;">
                                âœ… ì—­í• ê³¼ ë°ì´í„°ê°€ Firestoreì— ì €ì¥ë©ë‹ˆë‹¤
                            </div>
                        </div>
                    </div>
                `;
            } else {
                contentHtml += `
                    <div style="margin-bottom:20px;padding:15px;background:#fff3cd;border-radius:8px;border-left:4px solid #ffc107;">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                            <span style="font-size:18px;">ğŸŸ¡</span>
                            <strong style="color:#856404;">Firebase ë¯¸ì—°ê²°</strong>
                        </div>
                        <div style="font-size:13px;color:#555;line-height:1.6;">
                            <div>${firebaseStatus.message}</div>
                            <div style="margin-top:8px;padding-top:8px;border-top:1px solid #ffe082;color:#856404;">
                                âš ï¸ ì—­í• ê³¼ ë°ì´í„°ê°€ localStorageì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤
                            </div>
                            <div style="margin-top:8px;font-size:12px;color:#856404;">
                                ğŸ’¡ Firebase ì—°ê²°: ë¡œê·¸ì¸ í˜ì´ì§€ì—ì„œ ë¡œê·¸ì¸í•˜ê±°ë‚˜ ì½˜ì†”ì—ì„œ <code style="background:#fff;padding:2px 6px;border-radius:4px;">firebase.auth().signInWithEmailAndPassword("email","password").then(() => location.reload())</code> í›„ í—¤ë”ì˜ Admin UID ì…ë ¥
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Editorì¸ ê²½ìš° í—ˆìš©ëœ ê³µì • ëª©ë¡ í‘œì‹œ
            if (role === 'editor' && allowedProcesses && allowedProcesses.length > 0) {
                contentHtml += `
                    <div style="margin-bottom:20px;">
                        <h3 style="margin:0 0 15px 0;color:#333;font-size:16px;">âœ… ì…ë ¥ ê°€ëŠ¥í•œ ê³µì •</h3>
                        <div style="display:grid;gap:10px;">
                `;
                
                allowedProcesses.forEach(processId => {
                    const proc = PROCESSES.find(p => p.id === processId);
                    if (proc) {
                        const companyNames = {
                            'yuseok': 'ìœ ì„ì² ê°•',
                            'jinhung': 'ì§„í¥ê¸°ì—…'
                        };
                        const companyName = companyNames[proc.company] || proc.company;
                        contentHtml += `
                            <div style="padding:12px;background:#e3f2fd;border-radius:8px;border-left:4px solid #2196f3;display:flex;justify-content:space-between;align-items:center;">
                                <div>
                                    <strong style="color:#1976d2;">ê³µì • ${processId}: ${proc.name}</strong>
                                    <div style="font-size:12px;color:#666;margin-top:4px;">${companyName}</div>
                                </div>
                                <span style="font-size:20px;">âœ…</span>
                            </div>
                        `;
                    }
                });
                
                // í—ˆìš©ë˜ì§€ ì•Šì€ ê³µì • ëª©ë¡ë„ í‘œì‹œ
                const allProcessIds = PROCESSES.map(p => p.id);
                const notAllowedProcesses = allProcessIds.filter(id => !allowedProcesses.includes(id));
                
                if (notAllowedProcesses.length > 0) {
                    contentHtml += `
                        </div>
                        <h3 style="margin:20px 0 15px 0;color:#333;font-size:16px;">âŒ ì…ë ¥ ë¶ˆê°€ëŠ¥í•œ ê³µì •</h3>
                        <div style="display:grid;gap:10px;">
                    `;
                    
                    notAllowedProcesses.forEach(processId => {
                        const proc = PROCESSES.find(p => p.id === processId);
                        if (proc) {
                            const companyNames = {
                                'yuseok': 'ìœ ì„ì² ê°•',
                                'jinhung': 'ì§„í¥ê¸°ì—…'
                            };
                            const companyName = companyNames[proc.company] || proc.company;
                            contentHtml += `
                                <div style="padding:12px;background:#f5f5f5;border-radius:8px;border-left:4px solid #ccc;display:flex;justify-content:space-between;align-items:center;opacity:0.6;">
                                    <div>
                                        <strong style="color:#666;">ê³µì • ${processId}: ${proc.name}</strong>
                                        <div style="font-size:12px;color:#999;margin-top:4px;">${companyName}</div>
                                    </div>
                                    <span style="font-size:20px;">âŒ</span>
                                </div>
                            `;
                        }
                    });
                }
                
                contentHtml += `
                        </div>
                    </div>
                `;
            } else if (role === 'editor') {
                contentHtml += `
                    <div style="padding:15px;background:#fff3cd;border-radius:8px;border-left:4px solid #ffc107;">
                        <p style="margin:0;color:#856404;">âš ï¸ í—ˆìš©ëœ ê³µì •ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.</p>
                    </div>
                `;
            }
            
            // ë‹¤ë¥¸ ì—­í• ì¸ ê²½ìš° ëª¨ë“  ê³µì • í‘œì‹œ
            if (role !== 'editor') {
                contentHtml += `
                    <div style="margin-bottom:20px;">
                        <h3 style="margin:0 0 15px 0;color:#333;font-size:16px;">âœ… ì ‘ê·¼ ê°€ëŠ¥í•œ ê³µì •</h3>
                        <div style="display:grid;gap:10px;">
                `;
                
                PROCESSES.forEach(proc => {
                    const companyNames = {
                        'yuseok': 'ìœ ì„ì² ê°•',
                        'jinhung': 'ì§„í¥ê¸°ì—…'
                    };
                    const companyName = companyNames[proc.company] || proc.company;
                    contentHtml += `
                        <div style="padding:12px;background:#e8f5e9;border-radius:8px;border-left:4px solid #4caf50;display:flex;justify-content:space-between;align-items:center;">
                            <div>
                                <strong style="color:#2e7d32;">ê³µì • ${proc.id}: ${proc.name}</strong>
                                <div style="font-size:12px;color:#666;margin-top:4px;">${companyName}</div>
                            </div>
                            <span style="font-size:20px;">âœ…</span>
                        </div>
                    `;
                });
                
                contentHtml += `
                        </div>
                    </div>
                `;
            }
            
            contentHtml += `
                    <div style="text-align:center;margin-top:20px;">
                        <button onclick="document.getElementById('role-details-modal').remove()" style="padding:10px 30px;background:${roleColors[role] || '#333'};color:white;border:none;border-radius:6px;cursor:pointer;font-size:14px;font-weight:600;">ë‹«ê¸°</button>
                    </div>
                </div>
            `;
            
            modal.innerHTML = contentHtml;
            document.body.appendChild(modal);
        }
        
        
        // íœ´ë¬´ì¼ ì •ì˜ (ì„¤ë‚  ì—°íœ´)
        const HOLIDAYS = {
            '2026-02-16': 'ì„¤ë‚ íœ´ë¬´',
            '2026-02-17': 'ì„¤ë‚ íœ´ë¬´',
            '2026-02-18': 'ì„¤ë‚ íœ´ë¬´'
        };
        
        const PROCESSES = [
            { id: 1, name: 'ì£¼ê¸°ë‘¥ì»¤íŒ…', company: 'yuseok' },
            { id: 2, name: 'ê¸°ë‘¥ì†Œë¶€ì¬ì»¤íŒ…', company: 'yuseok' },
            { id: 3, name: 'ì£¼ê¸°ë‘¥ì¡°ë¦½', company: 'yuseok' },
            { id: 4, name: 'ì†Œë¶€ì¬ì¡°ë¦½', company: 'yuseok' },
            { id: 5, name: 'í˜„ì¥ë°°ì†¡', company: 'yuseok' },
            { id: 6, name: 'í˜„ì¥ì„¤ì¹˜', company: 'jinhung' }
        ];

        // State
        let currentCompany = null;
        // âœ… currentProcessëŠ” ìµœìƒë‹¨ì—ì„œ varë¡œ ì „ì—­ ì„ ì–¸ë¨ (ì¬ì„ ì–¸ ê¸ˆì§€: currentProcess = ...; ë§Œ ì‚¬ìš©)
        let selectedColumn = null;
        let editMode = false; // ìˆ˜ì • ëª¨ë“œ í™œì„±í™” ì—¬ë¶€
        let deleteMode = false; // ì‚­ì œ ëª¨ë“œ í™œì„±í™” ì—¬ë¶€
        let pendingDeleteInfo = null; // ëª¨ë‹¬ì—ì„œ ì„ íƒí•  ì‚­ì œ ì •ë³´ ì €ì¥
        let coordinateSetupMode = false; // ì¢Œí‘œ ì„¤ì • ëª¨ë“œ
        let currentColumnForSetup = null; // ì¢Œí‘œ ì„¤ì • ì¤‘ì¸ ê¸°ë‘¥ ë²ˆí˜¸
        let columnCoordinates = {}; // { columnId: { left: %, top: % } } - í‰ë©´ë„ ì¢Œí‘œ
        let columnData = {}; // { columnId: { status: 0-5, date: '2025-12-26', notes: '' } }
        let dailyData = {}; // { '2025-12-26': { 1: [columnIds completed p1], 2: [...], ... } }
        let transportPlan = {}; // { tripNumber: { columns: [columnIds], date: 'YYYY-MM-DD' } } - ì˜ˆ: { 1: { columns: [1,2,3], date: '2025-01-15' }, 2: { columns: [10,11,12], date: '2025-01-20' } }
        let originalTransportPlan = {}; // ì›ë³¸ ìš´ì†¡ê³„íš ë°±ì—…
        let adjustedTransportPlan = {}; // { tripNumber: { columns: [columnIds], date: 'YYYY-MM-DD' } } - 25í†¤ ê¸°ì¤€ìœ¼ë¡œ ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš
        let isShowingAdjustedPlan = false; // í˜„ì¬ ì¡°ì •ëœ ê³„íšì„ í‘œì‹œ ì¤‘ì¸ì§€ ì—¬ë¶€
        let deliveryConfirmed = {}; // { columnId: true/false } - ë°°ì†¡í™•ì¸ëœ ê¸°ë‘¥ (ì§™ì€ ë§ˆì  íƒ€ ìƒ‰ìƒ)
        let actualDeliveryDate = {}; // { columnId: 'YYYY-MM-DD' } - ì‹¤ì œ ë°°ì†¡ ë‚ ì§œ (ìš´ì†¡ì°¨ìˆ˜ê³„íš ë‚ ì§œì™€ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ)
        let currentTransportTrip = 1; // í˜„ì¬ ì„ íƒëœ ì°¨ìˆ˜
        let duplicateColumns = {}; // { columnId: [tripNumbers] } - ì¤‘ë³µëœ ê¸°ë‘¥ ì •ë³´
        let progressChart = null;
        let companyChart = null;
        let transportVolumeData = []; // ìš´ì†¡ ë¬¼ëŸ‰ ì‚°ì •ìš© ë°ì´í„° (ì—‘ì…€ ì—…ë¡œë“œ, ìµœëŒ€ 100ê°œ)
        let selectedColumns = []; // ì£¼ê¸°ë‘¥ì»¤íŒ…ì—ì„œ ì„ íƒëœ ê¸°ë‘¥ë“¤ (ë‹¤ì¤‘ ì„ íƒ)
        let selectedSizes = []; // ê·œê²©ë³„ í•„í„°: ì„ íƒëœ ê·œê²© ëª©ë¡
        let selectedTrips = []; // ì°¨ìˆ˜ë³„ í•„í„°: ì„ íƒëœ ì°¨ìˆ˜ ëª©ë¡ (ìš´ì†¡ì°¨ìˆ˜ê³„íš 13ì°¨, ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš 12ì°¨)
        let tripCountDeltas = {}; // ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš ë¶€ì¬ìˆ˜ ì¡°ì •: { tripNum: -3..+3 }

        // Initialize
        // Status display function
        function showStatus(message, isError) {
            const statusDiv = document.createElement('div');
            statusDiv.id = 'init-status';
            statusDiv.style.cssText = 'position:fixed;top:50px;left:50%;transform:translateX(-50%);background:' + (isError ? '#f44336' : '#4caf50') + ';color:white;padding:15px 30px;border-radius:8px;font-size:16px;z-index:10001;box-shadow:0 4px 15px rgba(0,0,0,0.3);font-weight:bold;';
            statusDiv.textContent = message;
            document.body.appendChild(statusDiv);
            if (!isError) {
                setTimeout(() => statusDiv.remove(), 3000);
            }
            console.log(message);
        }

        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // ë³‘ê¸°ê³µì •í‘œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
                if (typeof updatePlanToggleButtons === 'function') {
                    updatePlanToggleButtons();
                }
                
                // ì°¨ìˆ˜ë³„ ì „ì²´ í† ê¸€ ë²„íŠ¼ ìƒíƒœ ì´ˆê¸°í™”
                if (typeof updateAllTripsToggleButtons === 'function') {
                    updateAllTripsToggleButtons();
                }
                
                // ë¡œê·¸ì¸ ëª¨ë‹¬ ì´ˆê¸°í™” (ë‹¤ë¥¸ DOMContentLoadedì—ì„œë„ í˜¸ì¶œ)
                initializeLoginModal();
                
                const badge = document.getElementById('project-badge');
                if (badge) badge.textContent = getProjectName();

                await loadFromLocalStorage(); // ë‚´ë¶€ì—ì„œ syncTransportToDailyData() í˜¸ì¶œë¨
                
                // ğŸ”’ ë°ì´í„° ë¡œë“œ í›„ í™”ë©´ ë Œë”ë§ (ë°ì´í„°ê°€ ë³´ì´ë„ë¡ ë³´ì¥)
                console.log('ğŸ“Š ë°ì´í„° ë¡œë“œ ì™„ë£Œ, í™”ë©´ ë Œë”ë§ ì‹œì‘...');
                console.log('ğŸ“Š ë¡œë“œëœ ë°ì´í„°:', {
                    columnData: Object.keys(columnData).length + 'ê°œ ê¸°ë‘¥',
                    dailyData: Object.keys(dailyData).length + 'ê°œ ë‚ ì§œ',
                    transportPlan: Object.keys(transportPlan).length + 'ê°œ ì°¨ìˆ˜'
                });
                
                // ê³µì •í‘œ ë Œë”ë§
                if (typeof renderGanttChart === 'function') {
                    renderGanttChart();
                    console.log('âœ… ê³µì •í‘œ(Gantt) ë Œë”ë§ ì™„ë£Œ');
                } else {
                    console.warn('âš ï¸ renderGanttChart í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                // ê¸°ë‘¥ ê·¸ë¦¬ë“œ ë Œë”ë§
                if (typeof renderColumnGrid === 'function') {
                    renderColumnGrid('column-grid-overview');
                    renderColumnGrid('column-grid-input');
                    console.log('âœ… ê¸°ë‘¥ ê·¸ë¦¬ë“œ ë Œë”ë§ ì™„ë£Œ');
                } else {
                    console.warn('âš ï¸ renderColumnGrid í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                // ìš´ì†¡ë¬¼ëŸ‰ì‚°ì • ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì°¨ìˆ˜ë³„ ì§‘ê³„ í…Œì´ë¸”ë„ ë Œë”ë§
                if (transportVolumeData && transportVolumeData.length > 0 && typeof renderTransportVolumeTripSummary === 'function') {
                    renderTransportVolumeTripSummary(transportVolumeData);
                    console.log('âœ… ì°¨ìˆ˜ë³„ ì§‘ê³„ í…Œì´ë¸” ë Œë”ë§ ì™„ë£Œ');
                }
                
                // ì§„í–‰ë¥  ë°” ì—…ë°ì´íŠ¸
                if (typeof updateProgressBars === 'function') {
                    updateProgressBars();
                    console.log('âœ… ì§„í–‰ë¥  ë°” ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                } else {
                    console.warn('âš ï¸ updateProgressBars í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                // Firebase ì—°ê²° ìƒíƒœ í™•ì¸ ë° í‘œì‹œ
                const firebaseStatus = getFirebaseConnectionStatus();
                if (firebaseStatus.connected) {
                    showConnectionStatus('ğŸŸ¢ Firebase ì—°ê²°ë¨ - Firestoreì— ì €ì¥ë©ë‹ˆë‹¤');
                } else {
                    showConnectionStatus('ğŸŸ¡ ë¡œì»¬ ì €ì¥ ëª¨ë“œ - localStorageì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤');
                }
                
                // Admin UID ì…ë ¥ í•„ë“œ ë° ë²„íŠ¼ ì´ë²¤íŠ¸ ì¶”ê°€
                const adminUIDInput = document.getElementById('admin-uid-input');
                // ë¡œê·¸ì¸ ë²„íŠ¼ ì´ë²¤íŠ¸
                const loginBtn = document.getElementById('login-btn');
                const logoutBtn = document.getElementById('logout-btn');
                const loginEmailInput = document.getElementById('login-email-input');
                const loginPasswordInput = document.getElementById('login-password-input');
                const loginStatus = document.getElementById('login-status');
                const userInfo = document.getElementById('user-info');
                const userEmail = document.getElementById('user-email');
                const userRoleBadge = document.getElementById('user-role-badge');
                
                if (loginBtn) {
                    loginBtn.addEventListener('click', async function() {
                        const email = loginEmailInput.value.trim();
                        const password = loginPasswordInput.value.trim();
                        
                        if (!email || !password) {
                            showToast('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                            if (loginStatus) {
                                loginStatus.textContent = 'âŒ ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                                loginStatus.style.color = '#ffcdd2';
                            }
                            return;
                        }
                        
                        if (loginStatus) {
                            loginStatus.textContent = 'â³ ë¡œê·¸ì¸ ì¤‘...';
                            loginStatus.style.color = '#fff9c4';
                        }
                        
                        try {
                            const userCredential = await firebaseAuth.signInWithEmailAndPassword(email, password);
                            const user = userCredential.user;
                            
                            // Firestoreì—ì„œ ì—­í•  í™•ì¸
                            const roleData = await loadUserRoleFromFirebase(window.PROJECT_ID, user.uid);
                            if (roleData) {
                                userRole = roleData.role;
                                allowedProcesses = roleData.allowedProcesses;
                                applyRoleBasedUI();
                            }
                            
                            if (user) {
                                showToast('ë¡œê·¸ì¸ ì„±ê³µ!', 'success');
                                if (loginStatus) {
                                    loginStatus.textContent = 'âœ… ë¡œê·¸ì¸ ì„±ê³µ';
                                    loginStatus.style.color = '#c8e6c9';
                                }
                                
                                // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                                loginEmailInput.value = '';
                                loginPasswordInput.value = '';
                                
                                // UI ì—…ë°ì´íŠ¸
                                updateLoginUI();
                            } else {
                                showToast('ë¡œê·¸ì¸ ì‹¤íŒ¨. ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.', 'error');
                                if (loginStatus) {
                                    loginStatus.textContent = 'âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨';
                                    loginStatus.style.color = '#ffcdd2';
                                }
                            }
                        } catch (error) {
                            console.error('ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
                            showToast('ë¡œê·¸ì¸ ì˜¤ë¥˜: ' + error.message, 'error');
                            if (loginStatus) {
                                loginStatus.textContent = 'âŒ ë¡œê·¸ì¸ ì˜¤ë¥˜';
                                loginStatus.style.color = '#ffcdd2';
                            }
                        }
                    });
                }
                
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', async function() {
                        try {
                            await logoutFromFirebase();
                            showToast('ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ', 'info');
                            updateLoginUI();
                        } catch (error) {
                            console.error('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
                            showToast('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜: ' + error.message, 'error');
                        }
                    });
                }
                
                // âœ… ê°œë°œììš© ìºì‹œ ì´ˆê¸°í™” ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
                const clearCacheBtn = document.getElementById('clear-cache-btn');
                if (clearCacheBtn) {
                    // ë¡œê·¸ì¸ ìƒíƒœì¼ ë•Œ í‘œì‹œ (ê°œë°œ/ìš´ì˜ ëª¨ë‘)
                    // ê°œë°œ í™˜ê²½ì—ì„œëŠ” í•­ìƒ í‘œì‹œ, ìš´ì˜ í™˜ê²½ì—ì„œëŠ” ë¡œê·¸ì¸ ì‹œì—ë§Œ í‘œì‹œ
                    const isDev = window.location.hostname === 'localhost' || 
                                 window.location.hostname === '127.0.0.1' ||
                                 window.location.hostname.includes('dev');
                    if (isDev) {
                        clearCacheBtn.style.display = 'inline-block';
                    } else {
                        // ìš´ì˜ í™˜ê²½ì—ì„œë„ ë¡œê·¸ì¸ ìƒíƒœì¼ ë•Œ í‘œì‹œ
                        if (initFirebase() && firebaseAuth.currentUser) {
                            clearCacheBtn.style.display = 'inline-block';
                        }
                    }
                }
                
                // Enter í‚¤ë¡œ ë¡œê·¸ì¸
                if (loginPasswordInput) {
                    loginPasswordInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter' && loginBtn) {
                            loginBtn.click();
                        }
                    });
                }
                
                // ë¡œê·¸ì¸ UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜
                function updateLoginUI() {
                    if (!initFirebase()) return;
                    
                    const user = firebaseAuth.currentUser;
                    if (user && !user.isAnonymous) {
                        // ë¡œê·¸ì¸ ìƒíƒœ
                        if (loginEmailInput) loginEmailInput.style.display = 'none';
                        if (loginPasswordInput) loginPasswordInput.style.display = 'none';
                        if (loginBtn) loginBtn.style.display = 'none';
                        if (logoutBtn) logoutBtn.style.display = 'inline-block';
                        // âœ… ìºì‹œ ì´ˆê¸°í™” ë²„íŠ¼ë„ ë¡œê·¸ì¸ ì‹œ í‘œì‹œ
                        const clearCacheBtn = document.getElementById('clear-cache-btn');
                        if (clearCacheBtn) clearCacheBtn.style.display = 'inline-block';
                        if (userInfo) userInfo.style.display = 'block';
                        if (userEmail) userEmail.textContent = user.email || user.uid.substring(0, 20) + '...';
                        
                        // ì—­í•  í‘œì‹œ
                        loadUserRoleFromFirebase(window.PROJECT_ID, user.uid).then(roleData => {
                            if (roleData) {
                                const roleNames = {
                                    'admin': 'ê´€ë¦¬ì - ëª¨ë“  ê¶Œí•œ',
                                    'editor': 'í¸ì§‘ì',
                                    'viewer': 'ì—´ëŒì - ì½ê¸° ì „ìš©'
                                };
                                if (userRoleBadge) {
                                    userRoleBadge.textContent = roleNames[roleData.role] || roleData.role;
                                    // âœ… ê¸€ì”¨ëŠ” í°ìƒ‰, ë°°ê²½ì€ ì£¼ë³€ê³¼ í†µì¼ (ë°°ê²½ìƒ‰ ì œê±°)
                                    userRoleBadge.style.color = '#fff';
                                    userRoleBadge.style.background = 'transparent';
                                    userRoleBadge.style.border = 'none';
                                    userRoleBadge.style.padding = '0';
                                }
                            }
                        });
                    } else {
                        // ë¡œê·¸ì•„ì›ƒ ìƒíƒœ
                        if (loginEmailInput) loginEmailInput.style.display = 'block';
                        if (loginPasswordInput) loginPasswordInput.style.display = 'block';
                        if (loginBtn) loginBtn.style.display = 'inline-block';
                        if (logoutBtn) logoutBtn.style.display = 'none';
                        // âœ… ìºì‹œ ì´ˆê¸°í™” ë²„íŠ¼ë„ ë¡œê·¸ì•„ì›ƒ ì‹œ ìˆ¨ê¹€
                        const clearCacheBtn = document.getElementById('clear-cache-btn');
                        if (clearCacheBtn) clearCacheBtn.style.display = 'none';
                        if (userInfo) userInfo.style.display = 'none';
                        if (loginStatus) {
                            loginStatus.textContent = 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.';
                            loginStatus.style.color = '#fff9c4';
                        }
                    }
                }
                
                // ì´ˆê¸° UI ì—…ë°ì´íŠ¸
                updateLoginUI();
                
                // Firebase ì¸ì¦ ìƒíƒœ ë³€ê²½ ì‹œ UI ì—…ë°ì´íŠ¸
                if (initFirebase()) {
                    firebaseAuth.onAuthStateChanged((user) => {
                        updateLoginUI();
                        if (user && !user.isAnonymous) {
                            hideLoginModal();
                        } else {
                            showLoginModal();
                        }
                    });
                }
                
                // ë¡œê·¸ì¸ ëª¨ë‹¬ ì´ˆê¸°í™”ëŠ” initializeLoginModal() í•¨ìˆ˜ì—ì„œ ì²˜ë¦¬ë¨
                // ì¤‘ë³µ ë“±ë¡ ë°©ì§€ë¥¼ ìœ„í•´ ì—¬ê¸°ì„œëŠ” í˜¸ì¶œë§Œ í•¨
                console.log('â„¹ï¸ ë¡œê·¸ì¸ ëª¨ë‹¬ ì´ˆê¸°í™”ëŠ” initializeLoginModal()ì—ì„œ ì²˜ë¦¬ë©ë‹ˆë‹¤.');
                
                const adminSetupBtn = document.getElementById('admin-setup-btn');
                
                if (adminUIDInput) {
                    // Enter í‚¤ ì´ë²¤íŠ¸
                    adminUIDInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            if (typeof handleAdminUIDInput === 'function') {
                                handleAdminUIDInput();
                            } else {
                                console.error('handleAdminUIDInput í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                            }
                        }
                    });
                }
                
                if (adminSetupBtn) {
                    // ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
                    adminSetupBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        if (typeof handleAdminUIDInput === 'function') {
                            handleAdminUIDInput();
                        } else {
                            console.error('handleAdminUIDInput í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                            alert('Admin ì„¤ì • ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
                        }
                    });
                }
                
                // Editor UID ì…ë ¥ í•„ë“œ ë° ë²„íŠ¼ ì´ë²¤íŠ¸ ì¶”ê°€
                const editorUIDInput = document.getElementById('editor-uid-input');
                const editorSetupBtn = document.getElementById('editor-setup-btn');
                
                if (editorUIDInput) {
                    // Enter í‚¤ ì´ë²¤íŠ¸
                    editorUIDInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            if (typeof handleEditorUIDInput === 'function') {
                                handleEditorUIDInput();
                            } else {
                                console.error('handleEditorUIDInput í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                            }
                        }
                    });
                }
                
                if (editorSetupBtn) {
                    // ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
                    editorSetupBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        if (typeof handleEditorUIDInput === 'function') {
                            handleEditorUIDInput();
                        } else {
                            console.error('handleEditorUIDInput í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                            alert('Editor ì„¤ì • ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
                        }
                    });
                }
                
                // Viewer UID ì…ë ¥ í•„ë“œ ë° ë²„íŠ¼ ì´ë²¤íŠ¸ ì¶”ê°€
                const viewerUIDInput = document.getElementById('viewer-uid-input');
                const viewerSetupBtn = document.getElementById('viewer-setup-btn');
                
                if (viewerUIDInput) {
                    // Enter í‚¤ ì´ë²¤íŠ¸
                    viewerUIDInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            if (typeof handleViewerUIDInput === 'function') {
                                handleViewerUIDInput();
                            } else {
                                console.error('handleViewerUIDInput í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                            }
                        }
                    });
                }
                
                if (viewerSetupBtn) {
                    // ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
                    viewerSetupBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        if (typeof handleViewerUIDInput === 'function') {
                            handleViewerUIDInput();
                        } else {
                            console.error('handleViewerUIDInput í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                            alert('Viewer ì„¤ì • ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
                        }
                    });
                }
                
                setToday();
                renderWeekdayButtons(); // ìš”ì¼ ë²„íŠ¼ ë Œë”ë§
                loadTransportPlan(); // ë‚´ë¶€ì—ì„œ syncTransportToDailyData() í˜¸ì¶œë¨
                renderColumnGrid('column-grid-overview');
                renderColumnGrid('column-grid-input');
                updateProgressBars();
                // ì´ˆê¸° ë¡œë“œ ì‹œ ê³µì •í‘œë„ ë Œë”ë§í•˜ì—¬ í˜„ì¥ë°°ì†¡ ë°ì´í„° í‘œì‹œ
                if (document.getElementById('panel-gantt')) {
                    renderGanttChart();
                }
                
                // ì—­í•  ê¸°ë°˜ UI ì ìš©
                // âš ï¸ UID ê¸°ë°˜ ì—­í•  í™•ì¸ ì œê±°ë¨ - Firestoreê°€ ë‹¨ì¼ ì§„ì‹¤ ì†ŒìŠ¤
                applyRoleBasedUI();
                
                // í˜„ì¬ UIDì™€ ì—­í•  ì •ë³´ ì½˜ì†”ì— í‘œì‹œ
                const currentUID = getCurrentUID();
                console.log('ğŸ‘¤ í˜„ì¬ ì‚¬ìš©ì UID:', currentUID);
                console.log('ğŸ”‘ í˜„ì¬ ì—­í• :', userRole, '(Firestoreì—ì„œ ë¡œë“œë¨)');
                console.log('ğŸ’¡ roleì€ Firestore members ë¬¸ì„œì—ì„œë§Œ ê²°ì •ë©ë‹ˆë‹¤.');
                console.log('   ê²½ë¡œ: projects/' + window.PROJECT_ID + '/members/' + currentUID);
                
                // URL íŒŒë¼ë¯¸í„°ë¡œ ê³µì • ì„ íƒ (ì˜ˆ: ?process=1)
                const urlParamsForProcess = new URLSearchParams(window.location.search);
                const processParam = urlParamsForProcess.get('process');
                if (processParam) {
                    const processId = parseInt(processParam);
                    if (processId >= 1 && processId <= 6) {
                        // ì•½ê°„ì˜ ì§€ì—° í›„ ê³µì • ì„ íƒ (DOMì´ ì™„ì „íˆ ë¡œë“œëœ í›„)
                        setTimeout(() => {
                            selectPreocess(processId);
                        }, 100);
                    }
                }
                
                // íƒ­ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì§ì ‘ ì¶”ê°€ (onclick ëŒ€ì‹ )
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    // ê¸°ì¡´ onclick ì†ì„± ì œê±°í•˜ê³  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                    const onclickAttr = btn.getAttribute('onclick');
                    if (onclickAttr && onclickAttr.includes('showPanel')) {
                        btn.removeAttribute('onclick');
                        btn.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            // onclick ì†ì„±ì—ì„œ panelId ì¶”ì¶œ
                            const match = onclickAttr.match(/showPanel\(['"]([^'"]+)['"]/);
                            if (match && match[1]) {
                                const panelId = match[1];
                                console.log('íƒ­ ë²„íŠ¼ í´ë¦­:', panelId, this);
                                window.showPanel(panelId, this);
                            }
                        });
                    }
                });
                
                console.log('âœ… íƒ­ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì™„ë£Œ');
            } catch (error) {
                console.error('Initialization error:', error);
                alert('ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì˜¤ë¥˜: ' + error.message);
            }
        });

        // ì—°ê²° ìƒíƒœ í‘œì‹œ
        function showConnectionStatus(message) {
            // ìƒíƒœ ì•Œë¦¼
            const statusDiv = document.createElement('div');
            statusDiv.style.cssText = 'position:fixed;bottom:20px;right:20px;background:#333;color:white;padding:10px 20px;border-radius:8px;font-size:12px;z-index:9999;';
            statusDiv.textContent = message;
            document.body.appendChild(statusDiv);
            setTimeout(() => statusDiv.remove(), 5000);
            
            // ëª¨ë“œ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ (Firebase ì—°ê²° ìƒíƒœì— ë”°ë¼)
            const modeEl = document.getElementById('current-mode');
            if (modeEl) {
                // Firebase ì—°ê²° ìƒíƒœ í™•ì¸
                const firebaseStatus = getFirebaseConnectionStatus();
                if (firebaseStatus.connected) {
                    modeEl.textContent = 'ğŸŸ¢ Firebase ì—°ê²°ë¨ (Firestore ì €ì¥)';
                    modeEl.style.color = '#4caf50';
                } else {
                    modeEl.textContent = 'ğŸŸ¡ ë¡œì»¬ ì €ì¥ ëª¨ë“œ (ê°™ì€ ë¸Œë¼ìš°ì €ì—ì„œë§Œ ê³µìœ )';
                    modeEl.style.color = '#f57c00';
                }
            }
        }

        // Firebase ê´€ë ¨ ì½”ë“œ ì œê±°ë¨ (localStorage ê¸°ë°˜ìœ¼ë¡œ ë³€ê²½)
        // selectProcessì™€ showPanel í•¨ìˆ˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ ìƒë‹¨ì— ì´ë¯¸ ì •ì˜ë¨
        
        // ëª¨ë“  ê³µì •ì—ì„œ ê¸°ë‘¥ ì„ íƒ/í•´ì œ í† ê¸€
        function toggleColumnSelection(columnId) {
            // ğŸ”’ [ê°€ë“œ] ê¶Œí•œ ì²´í¬: ViewerëŠ” ì„ íƒ ë¶ˆê°€
            if (userRole === 'viewer') {
                alert('âš ï¸ ê¶Œí•œ ì—†ìŒ\n\nViewerëŠ” ê¸°ë‘¥ì„ ì„ íƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì½ê¸° ì „ìš©)');
                return;
            }
            
            // ğŸ”’ [ê°€ë“œ] ê¶Œí•œ ì²´í¬: EditorëŠ” í—ˆìš©ëœ ê³µì •ë§Œ ì„ íƒ ê°€ëŠ¥
            if (userRole === 'editor' && currentProcess) {
                if (!canEditProcess(currentProcess)) {
                    const proc = PROCESSES.find(p => p.id === currentProcess);
                    const procName = proc ? proc.name : `ê³µì • ${currentProcess}`;
                    alert(`âš ï¸ ê¶Œí•œ ì—†ìŒ\n\nEditorëŠ” ${procName}ì—ì„œ ê¸°ë‘¥ì„ ì„ íƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\ní—ˆìš©ëœ ê³µì •: ${allowedProcesses.map(p => {
                        const pr = PROCESSES.find(pr => pr.id === p);
                        return pr ? `${p}.${pr.name}` : `${p}`;
                    }).join(', ')}\n\në³´ê¸°ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
                    return;
                }
            }
            
            // íœ´ë¬´ì¼ ì²´í¬
            const workDate = document.getElementById('work-date')?.value;
            if (workDate && isHoliday(workDate)) {
                alert(`${getHolidayName(workDate)}\n\ní•´ë‹¹ì¼ì€ íœ´ë¬´ë¡œ ì‘ì—… ì…ë ¥ì´ ë¶ˆê°€í•©ë‹ˆë‹¤.`);
                return;
            }
            
            if (!currentProcess) {
                alert('ë¨¼ì € ì…ë ¥í•  ê³µì •ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ê° ê³µì •ë³„ë¡œ ì„ íƒ ê°€ëŠ¥í•œ ìƒíƒœ í™•ì¸
            const colData = columnData[columnId] || {};
            let status = colData.status || 0;
            
            // ì¼ì¼ì…ë ¥ì°½ì˜ ê³µì • 1-4ì—ì„œ ìš´ì†¡ì°¨ìˆ˜ê³„íšì˜ í˜„ì¥ë°°ì†¡(ê³„íš)ì´ í‘œì‹œë˜ì§€ ì•Šë„ë¡
            // ì‹¤ì œ ì™„ë£Œëœ ê³µì • ìƒíƒœë§Œ ë°˜ì˜
            if (currentProcess >= 1 && currentProcess <= 4) {
                let actualStatus = 0;
                const workDate = document.getElementById('work-date')?.value;
                
                // ëª¨ë“  ë‚ ì§œì—ì„œ ì‹¤ì œ ì™„ë£Œëœ ê³µì • í™•ì¸
                for (let date in dailyData) {
                    for (let p = 1; p <= 4; p++) {
                        const dayData = dailyData[date]?.[p];
                        if (dayData && (dayData.includes(columnId) || dayData.includes(parseInt(columnId.replace('C', ''))) || dayData.includes(columnId.replace('C', '')))) {
                            actualStatus = Math.max(actualStatus, p);
                        }
                    }
                }
                status = actualStatus;
            }
            
            // ì†Œë¶€ì¬ì»¤íŒ…(process 2)ì€ ë…ë¦½ì ìœ¼ë¡œ ì„ íƒ ê°€ëŠ¥ (ì£¼ê¸°ë‘¥ì»¤íŒ… ì™„ë£Œ ì—¬ë¶€ì™€ ë¬´ê´€)
            if (currentProcess === 2) {
                // ì†Œë¶€ì¬ì»¤íŒ…ì€ í•­ìƒ ì„ íƒ ê°€ëŠ¥ (ê²€ì¦ ì—†ìŒ)
            }
            // ì£¼ê¸°ë‘¥ì¡°ë¦½(process 3)ì€ ì£¼ê¸°ë‘¥ì»¤íŒ…(process 1) ì™„ë£Œ ìƒíƒœë§Œ í™•ì¸ (ì†Œë¶€ì¬ì»¤íŒ… ì™„ë£Œ ì—¬ë¶€ì™€ ë¬´ê´€)
            else if (currentProcess === 3) {
                // ì£¼ê¸°ë‘¥ì»¤íŒ…(process 1) ì™„ë£Œ ìƒíƒœ í™•ì¸
                let hasCutting = false;
                const workDate = document.getElementById('work-date')?.value;
                
                // ëª¨ë“  ë‚ ì§œì—ì„œ ì£¼ê¸°ë‘¥ì»¤íŒ…(process 1) ì™„ë£Œ í™•ì¸
                for (let date in dailyData) {
                    if (dailyData[date] && dailyData[date][1]) {
                        const colNum = parseInt(columnId.replace('C', ''));
                        if (dailyData[date][1].includes(columnId) || 
                            dailyData[date][1].includes(colNum) || 
                            dailyData[date][1].includes(String(colNum))) {
                            hasCutting = true;
                            break;
                        }
                    }
                }
                
                // columnDataì—ì„œë„ í™•ì¸
                if (!hasCutting) {
                    const colData = columnData[columnId] || {};
                    if (colData.status >= 1) {
                        hasCutting = true;
                    }
                }
                
                if (!hasCutting) {
                    alert('ì£¼ê¸°ë‘¥ì¡°ë¦½ì„ ì…ë ¥í•˜ë ¤ë©´ ì£¼ê¸°ë‘¥ì»¤íŒ…(1ë‹¨ê³„)ì´ ì™„ë£Œëœ ê¸°ë‘¥ì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                    return;
                }
            }
            // ì†Œë¶€ì¬ì¡°ë¦½(process 4)ì€ ì£¼ê¸°ë‘¥ì»¤íŒ…(process 1), ì†Œë¶€ì¬ì»¤íŒ…(process 2), ì£¼ê¸°ë‘¥ì¡°ë¦½(process 3)ì´ ëª¨ë‘ ì™„ë£Œëœ ê¸°ë‘¥ë§Œ ê°€ëŠ¥
            else if (currentProcess === 4) {
                let hasCutting = false; // ì£¼ê¸°ë‘¥ì»¤íŒ… ì™„ë£Œ ì—¬ë¶€
                let hasSubProcessing = false; // ì†Œë¶€ì¬ì»¤íŒ… ì™„ë£Œ ì—¬ë¶€
                let hasMainAssembly = false; // ì£¼ê¸°ë‘¥ì¡°ë¦½ ì™„ë£Œ ì—¬ë¶€
                const colNum = parseInt(columnId.replace('C', ''));
                
                // ëª¨ë“  ë‚ ì§œì—ì„œ ì£¼ê¸°ë‘¥ì»¤íŒ…(process 1) ì™„ë£Œ í™•ì¸
                for (let date in dailyData) {
                    if (dailyData[date] && dailyData[date][1]) {
                        if (dailyData[date][1].includes(columnId) || 
                            dailyData[date][1].includes(colNum) || 
                            dailyData[date][1].includes(String(colNum))) {
                            hasCutting = true;
                            break;
                        }
                    }
                }
                
                // ëª¨ë“  ë‚ ì§œì—ì„œ ì†Œë¶€ì¬ì»¤íŒ…(process 2) ì™„ë£Œ í™•ì¸
                for (let date in dailyData) {
                    if (dailyData[date] && dailyData[date][2]) {
                        if (dailyData[date][2].includes(columnId) || 
                            dailyData[date][2].includes(colNum) || 
                            dailyData[date][2].includes(String(colNum))) {
                            hasSubProcessing = true;
                            break;
                        }
                    }
                }
                
                // ëª¨ë“  ë‚ ì§œì—ì„œ ì£¼ê¸°ë‘¥ì¡°ë¦½(process 3) ì™„ë£Œ í™•ì¸
                for (let date in dailyData) {
                    if (dailyData[date] && dailyData[date][3]) {
                        if (dailyData[date][3].includes(columnId) || 
                            dailyData[date][3].includes(colNum) || 
                            dailyData[date][3].includes(String(colNum))) {
                            hasMainAssembly = true;
                            break;
                        }
                    }
                }
                
                // columnDataì—ì„œë„ í™•ì¸
                const colData = columnData[columnId] || {};
                if (!hasCutting && colData.status >= 1) {
                    hasCutting = true;
                }
                if (!hasSubProcessing && colData.status >= 2) {
                    hasSubProcessing = true;
                }
                if (!hasMainAssembly && colData.status >= 3) {
                    hasMainAssembly = true;
                }
                
                // ì™„ë£Œë˜ì§€ ì•Šì€ ê³µì • í™•ì¸
                if (!hasCutting || !hasSubProcessing || !hasMainAssembly) {
                    const missing = [];
                    if (!hasCutting) missing.push('ì£¼ê¸°ë‘¥ì»¤íŒ…(1ë‹¨ê³„)');
                    if (!hasSubProcessing) missing.push('ì†Œë¶€ì¬ì»¤íŒ…(2ë‹¨ê³„)');
                    if (!hasMainAssembly) missing.push('ì£¼ê¸°ë‘¥ì¡°ë¦½(3ë‹¨ê³„)');
                    alert(`í•´ë‹¹ ê³µì •ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n\nì†Œë¶€ì¬ì¡°ë¦½ì„ ì…ë ¥í•˜ë ¤ë©´ ${missing.join(', ')}ì´ ì™„ë£Œëœ ê¸°ë‘¥ì´ì–´ì•¼ í•©ë‹ˆë‹¤.`);
                    return;
                }
            }
            // í˜„ì¥ì„¤ì¹˜(process 6)ëŠ” í˜„ì¥ë°°ì†¡(process 5)ì—ì„œ í™•ì¸ëœ ê¸°ë‘¥ë§Œ ê°€ëŠ¥
            else if (currentProcess === 6) {
                let hasConfirmedDelivery = false;
                const workDate = document.getElementById('work-date')?.value;
                
                if (workDate && dailyData[workDate] && dailyData[workDate][5]) {
                    const colNum = parseInt(columnId.replace('C', ''));
                    if (dailyData[workDate][5].includes(columnId) || 
                        dailyData[workDate][5].includes(colNum) || 
                        dailyData[workDate][5].includes(String(colNum))) {
                        hasConfirmedDelivery = true;
                    }
                }
                
                if (!hasConfirmedDelivery) {
                    for (let date in dailyData) {
                        if (dailyData[date] && dailyData[date][5]) {
                            const colNum = parseInt(columnId.replace('C', ''));
                            if (dailyData[date][5].includes(columnId) || 
                                dailyData[date][5].includes(colNum) || 
                                dailyData[date][5].includes(String(colNum))) {
                                hasConfirmedDelivery = true;
                                break;
                            }
                        }
                    }
                }
                
                if (!hasConfirmedDelivery) {
                    alert('í˜„ì¥ì„¤ì¹˜ë¥¼ ì…ë ¥í•˜ë ¤ë©´ í˜„ì¥ë°°ì†¡(5ë‹¨ê³„)ì—ì„œ í™•ì¸ëœ ê¸°ë‘¥ì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                    return;
                }
            }
            // ë‚˜ë¨¸ì§€ ê³µì •(1, 3, 4, 5)ì€ ì´ì „ ê³µì • ì™„ë£Œ ìƒíƒœ í™•ì¸
            else {
                const requiredStatus = currentProcess - 1;
                if (status !== requiredStatus) {
                    const processNames = ['ë¯¸ì°©ìˆ˜', 'ì£¼ê¸°ë‘¥ì»¤íŒ…', 'ì†Œë¶€ì¬ì»¤íŒ…', 'ì£¼ê¸°ë‘¥ì¡°ë¦½', 'ì†Œë¶€ì¬ì¡°ë¦½', 'í˜„ì¥ë°°ì†¡', 'í˜„ì¥ì„¤ì¹˜'];
                    alert(`${processNames[requiredStatus]} ì™„ë£Œ ìƒíƒœì˜ ê¸°ë‘¥ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
                    return;
                }
            }
            
            // ì„ íƒ/í•´ì œ í† ê¸€
            const index = selectedColumns.indexOf(columnId);
            if (index > -1) {
                // ì´ë¯¸ ì„ íƒëœ ê²½ìš° - í•´ì œ
                selectedColumns.splice(index, 1);
            } else {
                // ì„ íƒë˜ì§€ ì•Šì€ ê²½ìš° - ì¶”ê°€
                selectedColumns.push(columnId);
            }
            
            // UI ì—…ë°ì´íŠ¸
            renderColumnGrid('column-grid-input');
            
            // ì„ íƒëœ ê¸°ë‘¥ ìˆ˜ í‘œì‹œ
            updateSelectedColumnsInfo();
        }
        
        // ì„ íƒëœ ê¸°ë‘¥ ì •ë³´ ì—…ë°ì´íŠ¸
        function updateSelectedColumnsInfo() {
            const statsDiv = document.getElementById('guide-stats');
            if (currentProcess && currentProcess >= 1 && currentProcess <= 6 && selectedColumns.length > 0) {
                const selectedText = selectedColumns.sort((a, b) => {
                    const numA = parseInt(a.replace('C', ''));
                    const numB = parseInt(b.replace('C', ''));
                    return numA - numB;
                }).join(', ');
                statsDiv.style.display = 'block';
                statsDiv.style.background = '#e3f2fd';
                statsDiv.style.color = '#1565c0';
                statsDiv.innerHTML = 
                    `ğŸ“‹ <strong>ì„ íƒëœ ê¸°ë‘¥ (${selectedColumns.length}ê°œ):</strong> ${selectedText}`;
            }
        }
        
        // ì„ íƒëœ ëª¨ë“  ê¸°ë‘¥ì„ í•œ ë²ˆì— ì €ì¥
        function saveSelectedColumns() {
            // ì—­í•  í™•ì¸: ViewerëŠ” ì €ì¥ ë¶ˆê°€
            if (userRole === 'viewer') {
                alert('âš ï¸ ê¶Œí•œ ì—†ìŒ\n\nViewerëŠ” ì¼ì¼ì…ë ¥ì„ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\nEditor ì´ìƒì˜ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }
            
            // ğŸ”’ [ê°€ë“œ] ê¶Œí•œ ì²´í¬: EditorëŠ” í—ˆìš©ëœ ê³µì •ë§Œ ì €ì¥ ê°€ëŠ¥
            if (userRole === 'editor' && currentProcess) {
                if (!canEditProcess(currentProcess)) {
                    const proc = PROCESSES.find(p => p.id === currentProcess);
                    const procName = proc ? proc.name : `ê³µì • ${currentProcess}`;
                    alert(`âš ï¸ ê¶Œí•œ ì—†ìŒ\n\nEditorëŠ” ${procName}ì„ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\ní—ˆìš©ëœ ê³µì •: ${allowedProcesses.map(p => {
                        const pr = PROCESSES.find(pr => pr.id === p);
                        return pr ? `${p}.${pr.name}` : `${p}`;
                    }).join(', ')}`);
                    return;
                }
            }
            
            if (selectedColumns.length === 0) {
                alert('ì €ì¥í•  ê¸°ë‘¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ë‚ ì§œ í™•ì¸
            let workDate = document.getElementById('work-date')?.value;
            if (!workDate) {
                const today = new Date();
                workDate = today.toISOString().split('T')[0];
                const workDateInput = document.getElementById('work-date');
                if (workDateInput) {
                    workDateInput.value = workDate;
                }
            }
            
            // íœ´ë¬´ì¼ ì²´í¬
            if (isHoliday(workDate)) {
                alert(`${getHolidayName(workDate)}\n\ní•´ë‹¹ì¼ì€ íœ´ë¬´ë¡œ ì‘ì—… ì…ë ¥ì´ ë¶ˆê°€í•©ë‹ˆë‹¤.`);
                return;
            }
            
            if (!currentProcess) {
                alert('ê³µì •ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ì„ íƒëœ ëª¨ë“  ê¸°ë‘¥ ì €ì¥
            const savedCount = selectedColumns.length;
            const process = PROCESSES.find(p => p.id === currentProcess);
            const companyName = process?.company || 'yuseok';
            
            selectedColumns.forEach(columnId => {
                // columnData ì—…ë°ì´íŠ¸
                if (!columnData[columnId]) {
                    columnData[columnId] = {};
                }
                columnData[columnId].status = currentProcess;
                columnData[columnId].lastUpdate = workDate;
                columnData[columnId].updatedBy = companyName;
                
                // dailyData ì—…ë°ì´íŠ¸
                if (!dailyData[workDate]) {
                    dailyData[workDate] = {};
                }
                if (!dailyData[workDate][currentProcess]) {
                    dailyData[workDate][currentProcess] = [];
                }
                // ê¸°ì¡´ í•­ëª© ì œê±° í›„ ìƒˆë¡œ ì¶”ê°€ (ì¤‘ë³µ ë°©ì§€)
                dailyData[workDate][currentProcess] = dailyData[workDate][currentProcess].filter(col => col !== columnId);
                dailyData[workDate][currentProcess].push(columnId);
            });
            
            // ì €ì¥
            try {
                saveToStorage();
                showStatus(`âœ… ${savedCount}ê°œ ê¸°ë‘¥ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`, false);
            } catch (error) {
                console.error('ì €ì¥ ì˜¤ë¥˜:', error);
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                return;
            }
            
            // ì„ íƒ ì´ˆê¸°í™” ë° UI ì—…ë°ì´íŠ¸
            selectedColumns = [];
            renderColumnGrid('column-grid-input');
            renderColumnGrid('column-grid-overview');
            updateProgressBars();
        }
        
        // ê³µì •ë³„ ì…ë ¥ ì•ˆë‚´ ë©”ì‹œì§€
        function showProcessGuide(processId) {
            const guideMessages = {
                1: {
                    title: 'ğŸ”´ ì£¼ê¸°ë‘¥ì»¤íŒ… ì…ë ¥ ì•ˆë‚´',
                    company: 'ìœ ì„ì² ê°•(ì¶©ì£¼ê³µì¥)',
                    steps: [
                        'â‘  ì‘ì—…ì¼ìë¥¼ í™•ì¸/ì„ íƒí•©ë‹ˆë‹¤',
                        'â‘¡ ê¸ˆìƒ‰ í…Œë‘ë¦¬ë¡œ ê°•ì¡°ëœ ê¸°ë‘¥(ë¯¸ì°©ìˆ˜ ìƒíƒœ)ì„ í´ë¦­í•˜ì—¬ ì„ íƒí•©ë‹ˆë‹¤ (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)',
                        'â‘¢ ì„ íƒëœ ê¸°ë‘¥ë“¤ì´ íŒŒë€ìƒ‰ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤',
                        'â‘£ ì €ì¥ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì„ íƒí•œ ëª¨ë“  ê¸°ë‘¥ì„ í•œ ë²ˆì— ì €ì¥í•©ë‹ˆë‹¤'
                    ],
                    note: 'â€» ë¯¸ì°©ìˆ˜(0ë‹¨ê³„) ìƒíƒœì˜ ê¸°ë‘¥ë§Œ ì»¤íŒ… ì™„ë£Œ ì²˜ë¦¬ ê°€ëŠ¥',
                    deleteNote: 'ğŸ—‘ï¸ ì£¼ê¸°ë‘¥ì»¤íŒ… ì‚­ì œ: ì‘ì—…ì¼ì ì‚­ì œëŠ” ê³µì •í‘œ(Gantt)ì—ì„œ ë°ì´í„° ì‚­ì œê°€ëŠ¥í•©ë‹ˆë‹¤.'
                },
                2: {
                    title: 'ğŸŸ  ê¸°ë‘¥ì†Œë¶€ì¬ì»¤íŒ… ì…ë ¥ ì•ˆë‚´',
                    company: 'ìœ ì„ì² ê°•(ì˜¤ì°½ê³µì¥)',
                    steps: [
                        'â‘  ì‘ì—…ì¼ìë¥¼ í™•ì¸/ì„ íƒí•©ë‹ˆë‹¤',
                        'â‘¡ ê¸ˆìƒ‰ í…Œë‘ë¦¬ë¡œ ê°•ì¡°ëœ ê¸°ë‘¥(ì»¤íŒ…ì™„ë£Œ ìƒíƒœ)ì„ í´ë¦­í•©ë‹ˆë‹¤',
                        'â‘¢ ì €ì¥í•©ë‹ˆë‹¤'
                    ],
                    note: 'â€» ì£¼ê¸°ë‘¥ì»¤íŒ…(1ë‹¨ê³„)ì´ ì™„ë£Œëœ ê¸°ë‘¥ë§Œ ì†Œë¶€ì¬ì»¤íŒ… ì²˜ë¦¬ ê°€ëŠ¥'
                },
                3: {
                    title: 'ğŸ”µ ì£¼ê¸°ë‘¥ì¡°ë¦½ ì…ë ¥ ì•ˆë‚´',
                    company: 'ìœ ì„ì² ê°•(ìŒì„±ê³µì¥)',
                    steps: [
                        'â‘  ì‘ì—…ì¼ìë¥¼ í™•ì¸/ì„ íƒí•©ë‹ˆë‹¤',
                        'â‘¡ ê¸ˆìƒ‰ í…Œë‘ë¦¬ë¡œ ê°•ì¡°ëœ ê¸°ë‘¥(ì†Œë¶€ì¬ì»¤íŒ…ì™„ë£Œ ìƒíƒœ)ì„ í´ë¦­í•©ë‹ˆë‹¤',
                        'â‘¢ ì €ì¥í•©ë‹ˆë‹¤'
                    ],
                    note: 'â€» ê¸°ë‘¥ì†Œë¶€ì¬ì»¤íŒ…(2ë‹¨ê³„)ì´ ì™„ë£Œëœ ê¸°ë‘¥ë§Œ ì£¼ê¸°ë‘¥ì¡°ë¦½ ì²˜ë¦¬ ê°€ëŠ¥'
                },
                4: {
                    title: 'ğŸ”· ì†Œë¶€ì¬ì¡°ë¦½ ì…ë ¥ ì•ˆë‚´',
                    company: 'ìœ ì„ì² ê°•(ìŒì„±ê³µì¥)',
                    steps: [
                        'â‘  ì‘ì—…ì¼ìë¥¼ í™•ì¸/ì„ íƒí•©ë‹ˆë‹¤',
                        'â‘¡ ê¸ˆìƒ‰ í…Œë‘ë¦¬ë¡œ ê°•ì¡°ëœ ê¸°ë‘¥(ì£¼ê¸°ë‘¥ì¡°ë¦½ì™„ë£Œ ìƒíƒœ)ì„ í´ë¦­í•©ë‹ˆë‹¤',
                        'â‘¢ ì €ì¥í•©ë‹ˆë‹¤'
                    ],
                    note: 'â€» ì£¼ê¸°ë‘¥ì¡°ë¦½(3ë‹¨ê³„)ì´ ì™„ë£Œëœ ê¸°ë‘¥ë§Œ ì†Œë¶€ì¬ì¡°ë¦½ ì²˜ë¦¬ ê°€ëŠ¥'
                },
                5: {
                    title: 'ğŸŸ£ í˜„ì¥ë°°ì†¡ ì…ë ¥ ì•ˆë‚´',
                    company: 'ìœ ì„ì² ê°•(ìŒì„±ê³µì¥)',
                    steps: [
                        'â‘  ì‘ì—…ì¼ìë¥¼ í™•ì¸/ì„ íƒí•©ë‹ˆë‹¤',
                        'â‘¡ ê¸ˆìƒ‰ í…Œë‘ë¦¬ë¡œ ê°•ì¡°ëœ ê¸°ë‘¥(ì†Œì¡°ë¦½ì™„ë£Œ ìƒíƒœ)ì„ í´ë¦­í•˜ì—¬ ì„ íƒí•©ë‹ˆë‹¤ (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)',
                        'â‘¢ ì„ íƒëœ ê¸°ë‘¥ë“¤ì´ íŒŒë€ìƒ‰ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤',
                        'â‘£ ì €ì¥ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì„ íƒí•œ ëª¨ë“  ê¸°ë‘¥ì„ í•œ ë²ˆì— ì €ì¥í•©ë‹ˆë‹¤'
                    ],
                    note: 'â€» ì†Œë¶€ì¬ì¡°ë¦½(4ë‹¨ê³„)ì´ ì™„ë£Œëœ ê¸°ë‘¥ë§Œ í˜„ì¥ë°°ì†¡ ì²˜ë¦¬ ê°€ëŠ¥'
                },
                6: {
                    title: 'ğŸŸ¢ í˜„ì¥ì„¤ì¹˜ ì…ë ¥ ì•ˆë‚´',
                    company: 'ì§„í¥ê¸°ì—…',
                    steps: [
                        'â‘  ì‘ì—…ì¼ìë¥¼ í™•ì¸/ì„ íƒí•©ë‹ˆë‹¤',
                        'â‘¡ ê¸ˆìƒ‰ í…Œë‘ë¦¬ë¡œ ê°•ì¡°ëœ ê¸°ë‘¥(ë°°ì†¡ì™„ë£Œ ìƒíƒœ)ì„ í´ë¦­í•˜ì—¬ ì„ íƒí•©ë‹ˆë‹¤ (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)',
                        'â‘¢ ì„ íƒëœ ê¸°ë‘¥ë“¤ì´ íŒŒë€ìƒ‰ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤',
                        'â‘£ ì €ì¥ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì„ íƒí•œ ëª¨ë“  ê¸°ë‘¥ì„ í•œ ë²ˆì— ì €ì¥í•©ë‹ˆë‹¤'
                    ],
                    note: 'â€» í˜„ì¥ë°°ì†¡(5ë‹¨ê³„)ì—ì„œ í™•ì¸ëœ ê¸°ë‘¥ë§Œ ì„¤ì¹˜ ì²˜ë¦¬ ê°€ëŠ¥\nìš´ì†¡ì°¨ìˆ˜ê³„íšì—ì„œ "ğŸ’¾ ìš´ì†¡ì°¨ìˆ˜ê³„íš ì €ì¥" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ í™•ì¸í•œ ê¸°ë‘¥ë§Œ í˜„ì¥ì„¤ì¹˜ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.'
                }
            };
            
            const guide = guideMessages[processId];
            const guideDiv = document.getElementById('process-guide');
            
            if (!guideDiv) {
                console.warn('process-guide ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (!guide) {
                console.warn(`ê³µì • ${processId}ì— ëŒ€í•œ ì•ˆë‚´ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.`);
                return;
            }
            
            guideDiv.innerHTML = `
                <div style="margin-bottom:10px;">
                    <strong style="font-size:14px;color:#1565c0;">${guide.title}</strong>
                    <span style="margin-left:10px;padding:3px 8px;background:#e3f2fd;border-radius:4px;font-size:11px;color:#1976d2;">ë‹´ë‹¹: ${guide.company}</span>
                </div>
                <div style="margin-bottom:8px;font-size:12px;color:#555;">
                    ${guide.steps.map(step => `<div style="margin:3px 0;">${step}</div>`).join('')}
                </div>
                <div style="font-size:11px;color:#e65100;background:#fff3e0;padding:6px 10px;border-radius:4px;margin-bottom:8px;">
                    ${guide.note}
                </div>
                ${guide.deleteNote ? `<div style="font-size:11px;color:#d32f2f;background:#ffebee;padding:6px 10px;border-radius:4px;border-left:3px solid #f44336;">
                    ${guide.deleteNote}
                </div>` : ''}
            `;
        }

        // ê¸°ì¡´ í˜¸í™˜ì„±ì„ ìœ„í•œ í•¨ìˆ˜
        function selectCompany(company) {
            // ì²« ë²ˆì§¸ ê³µì •ìœ¼ë¡œ ìë™ ì„ íƒ
            if (company === 'yuseok') selectPreocess(1);
            else if (company === 'jusin') selectPreocess(4);
            else if (company === 'jinhung') selectPreocess(5);
        }

        // showPanel í•¨ìˆ˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ ìƒë‹¨ì— ì´ë¯¸ ì •ì˜ë¨

        // Set Today's Date
        function setToday() {
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            const workDateInput = document.getElementById('work-date');
            if (workDateInput) {
                workDateInput.value = dateStr;
                loadDayData();
            }
        }
        
        // Set Date by Date String
        function setDateByString(dateStr) {
            const workDateInput = document.getElementById('work-date');
            if (workDateInput) {
                workDateInput.value = dateStr;
                loadDayData();
            }
        }
        
        // Render Weekday Buttons
        function renderWeekdayButtons() {
            const weekdayButtonsContainer = document.getElementById('weekday-buttons');
            if (!weekdayButtonsContainer) return;
            
            weekdayButtonsContainer.innerHTML = '';
            
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            const todayDay = today.getDay(); // 0=ì¼ìš”ì¼, 1=ì›”ìš”ì¼, ..., 6=í† ìš”ì¼
            
            // ì´ë²ˆ ì£¼ ì›”ìš”ì¼ ê³„ì‚° (ì›”ìš”ì¼ì´ ì£¼ì˜ ì‹œì‘)
            const thisWeekMonday = new Date(today);
            const daysToMonday = todayDay === 0 ? -6 : 1 - todayDay; // ì¼ìš”ì¼ì´ë©´ -6, ì•„ë‹ˆë©´ 1-todayDay
            thisWeekMonday.setDate(today.getDate() + daysToMonday);
            
            // ì§€ë‚œì£¼ ì›”ìš”ì¼ ê³„ì‚° (ì´ë²ˆ ì£¼ ì›”ìš”ì¼ì—ì„œ 7ì¼ ë¹¼ê¸°)
            const lastWeekMonday = new Date(thisWeekMonday);
            lastWeekMonday.setDate(thisWeekMonday.getDate() - 7);
            
            const weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            
            // ì§€ë‚œì£¼ ë²„íŠ¼ ìƒì„± (ìœ„ì— í‘œì‹œ)
            for (let i = 0; i < 7; i++) {
                const date = new Date(lastWeekMonday);
                date.setDate(lastWeekMonday.getDate() + i);
                const dateStr = date.toISOString().split('T')[0];
                const weekday = weekdays[date.getDay()];
                const dayOfWeek = date.getDay(); // 0=ì¼ìš”ì¼, 6=í† ìš”ì¼
                const isSunday = dayOfWeek === 0;
                
                // ë‚ ì§œ í¬ë§·íŒ… (MM/DD)
                const month = date.getMonth() + 1;
                const day = date.getDate();
                const dateDisplay = `${month}/${day}`;
                
                // ì˜¤ëŠ˜ ë‚ ì§œì¸ì§€ í™•ì¸
                const isToday = dateStr === todayStr;
                const buttonText = isToday ? `ì˜¤ëŠ˜ ${dateDisplay}` : `${weekday} ${dateDisplay}`;
                
                const button = document.createElement('button');
                button.className = isToday ? 'action-btn primary' : 'action-btn';
                // ì¼ìš”ì¼ì€ ë¹¨ê°„ìƒ‰, ì˜¤ëŠ˜ì€ ê¸°ë³¸ ìƒ‰ìƒ, ê·¸ ì™¸ëŠ” ì§™ì€ í‘¸ë¥¸ìƒ‰
                let colorStyle = '';
                if (isToday) {
                    colorStyle = '';
                } else if (isSunday) {
                    colorStyle = 'background:#9e9e9e;color:#d32f2f;opacity:0.7;';
                } else {
                    colorStyle = 'background:#9e9e9e;color:#0d47a1;opacity:0.7;';
                }
                button.style.cssText = colorStyle + 'white-space:nowrap;min-width:80px;';
                button.textContent = buttonText;
                button.onclick = () => setDateByString(dateStr);
                
                weekdayButtonsContainer.appendChild(button);
            }
            
            // ì´ë²ˆ ì£¼ ë²„íŠ¼ ìƒì„± (ì•„ë˜ì— í‘œì‹œ)
            for (let i = 0; i < 7; i++) {
                const date = new Date(thisWeekMonday);
                date.setDate(thisWeekMonday.getDate() + i);
                const dateStr = date.toISOString().split('T')[0];
                const weekday = weekdays[date.getDay()];
                const dayOfWeek = date.getDay(); // 0=ì¼ìš”ì¼, 6=í† ìš”ì¼
                const isSunday = dayOfWeek === 0;
                
                // ë‚ ì§œ í¬ë§·íŒ… (MM/DD)
                const month = date.getMonth() + 1;
                const day = date.getDate();
                const dateDisplay = `${month}/${day}`;
                
                // ì˜¤ëŠ˜ ë‚ ì§œì¸ì§€ í™•ì¸
                const isToday = dateStr === todayStr;
                const buttonText = isToday ? `ì˜¤ëŠ˜ ${dateDisplay}` : `${weekday} ${dateDisplay}`;
                
                const button = document.createElement('button');
                button.className = isToday ? 'action-btn primary' : 'action-btn';
                // ì¼ìš”ì¼ì€ ë¹¨ê°„ìƒ‰, ì˜¤ëŠ˜ì€ ê¸°ë³¸ ìƒ‰ìƒ, ê·¸ ì™¸ëŠ” ì§™ì€ í‘¸ë¥¸ìƒ‰
                let colorStyle = '';
                if (isToday) {
                    colorStyle = '';
                } else if (isSunday) {
                    colorStyle = 'background:#9e9e9e;color:#d32f2f;';
                } else {
                    colorStyle = 'background:#9e9e9e;color:#0d47a1;';
                }
                button.style.cssText = colorStyle + 'white-space:nowrap;min-width:80px;';
                button.textContent = buttonText;
                button.onclick = () => setDateByString(dateStr);
                
                weekdayButtonsContainer.appendChild(button);
            }
        }

        // Render Column Grid
        function renderColumnGrid(containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            let availableCount = 0;
            let completedCount = 0;
            
            // íœ´ë¬´ì¼ ì²´í¬ (ì…ë ¥ íŒ¨ë„ìš©)
            const workDate = document.getElementById('work-date')?.value;
            const isHolidayToday = workDate && isHoliday(workDate);
            
            // 50ê°œ ê¸°ë‘¥ Ã— 2ê°œ ì„œë¸Œ í•­ëª© = ì´ 100ê°œ
            for (let i = 1; i <= TOTAL_COLUMNS; i++) {
                for (let sub = 1; sub <= SUB_ITEMS_PER_COLUMN; sub++) {
                    const colId = getColumnId(i, sub);
                const colData = columnData[colId] || {};
                let status = colData.status || 0;
                    const colName = colData.name || ''; // ì—‘ì…€ì—ì„œ ì½ì€ ê¸°ë‘¥ ì´ë¦„
                
                // ì¼ì¼ì…ë ¥ì°½ì˜ ê³µì • 1-4ì—ì„œ ìš´ì†¡ì°¨ìˆ˜ê³„íšì˜ í˜„ì¥ë°°ì†¡(ê³„íš)ì´ í‘œì‹œë˜ì§€ ì•Šë„ë¡
                // ì‹¤ì œ ì™„ë£Œëœ ê³µì • ìƒíƒœë§Œ ë°˜ì˜ (dailyData[date][5]ì—ë§Œ ìˆëŠ” ê²ƒì€ ì œì™¸)
                if (containerId === 'column-grid-input' && currentProcess >= 1 && currentProcess <= 4) {
                    // ì‹¤ì œ ì™„ë£Œëœ ê³µì •(1-4)ì˜ ìµœëŒ€ê°’ì„ ì°¾ìŒ
                    let actualStatus = 0;
                    const workDate = document.getElementById('work-date')?.value;
                    
                    // ëª¨ë“  ë‚ ì§œì—ì„œ ì‹¤ì œ ì™„ë£Œëœ ê³µì • í™•ì¸
                    for (let date in dailyData) {
                        for (let p = 1; p <= 4; p++) {
                            const dayData = dailyData[date]?.[p];
                            if (dayData && (dayData.includes(i) || dayData.includes(colId) || dayData.includes(String(i)))) {
                                actualStatus = Math.max(actualStatus, p);
                            }
                        }
                    }
                    
                    // ì‹¤ì œ ì™„ë£Œëœ ê³µì • ìƒíƒœë¡œ ì—…ë°ì´íŠ¸ (ìš´ì†¡ì°¨ìˆ˜ê³„íšì˜ í˜„ì¥ë°°ì†¡(ê³„íš) ì œì™¸)
                    status = actualStatus;
                }
                
                // í˜„ì¥ì„¤ì¹˜(process 6) ì…ë ¥ ì‹œ í˜„ì¥ë°°ì†¡(process 5)ì—ì„œ í™•ì¸ëœ ê¸°ë‘¥ë§Œ ê°€ëŠ¥
                if (containerId === 'column-grid-input' && currentProcess === 6 && status < 5) {
                    // dailyData[date][5]ì— í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸ (í™•ì¸ì„ ë°›ì€ ê¸°ë‘¥ë§Œ í¬í•¨ë¨)
                    const workDate = document.getElementById('work-date')?.value;
                    let hasConfirmedDelivery = false;
                    
                    if (workDate && dailyData[workDate] && dailyData[workDate][5]) {
                        if (dailyData[workDate][5].includes(colId) || 
                            dailyData[workDate][5].includes(i) || 
                            dailyData[workDate][5].includes(String(i))) {
                            hasConfirmedDelivery = true;
                        }
                    }
                    
                    // ëª¨ë“  ë‚ ì§œì˜ dailyData[date][5]ë¥¼ í™•ì¸ (ë‹¤ë¥¸ ë‚ ì§œì— ë°°ì†¡ ê³„íšì´ ìˆì„ ìˆ˜ ìˆìŒ)
                    if (!hasConfirmedDelivery) {
                        for (let date in dailyData) {
                            if (dailyData[date] && dailyData[date][5]) {
                                if (dailyData[date][5].includes(colId) || 
                                    dailyData[date][5].includes(i) || 
                                    dailyData[date][5].includes(String(i))) {
                                    hasConfirmedDelivery = true;
                                    break;
                                }
                            }
                        }
                    }
                    
                    if (hasConfirmedDelivery) {
                        // í™•ì¸ëœ ê¸°ë‘¥ì´ë©´ statusë¥¼ 5ë¡œ ì„ì‹œ í‘œì‹œí•˜ì—¬ í´ë¦­ ê°€ëŠ¥í•˜ê²Œ í•¨
                        status = 5;
                    }
                }
                
                // í˜„ì¥ë°°ì†¡(process 5)ì€ ìš´ì†¡ì°¨ìˆ˜ê³„íšì—ì„œ ë°›ì€ ë°ì´í„°ë¡œ ì‹¤ì œ ìš´ì†¡ì´ ì•„ë‹˜ì„ í‘œì‹œ
                const statusNames = ['ë¯¸ì°©ìˆ˜', 'ì»¤íŒ…', 'ì†Œë¶€ì¬', 'ì¡°ë¦½', 'ì†Œì¡°ë¦½', 'ë°°ì†¡ê³„íš', 'ì„¤ì¹˜ì™„ë£Œ'];
                const lastUpdate = colData.lastUpdate || '';
                
                // ë‚ ì§œ í¬ë§·íŒ… (YYYY-MM-DD -> MM/DD)
                let dateDisplay = '';
                if (lastUpdate && lastUpdate.trim() !== '') {
                    const dateParts = lastUpdate.split('-');
                    if (dateParts.length === 3) {
                        // ì›”/ì¼ í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (ì•ì˜ 0 ì œê±°)
                        const month = parseInt(dateParts[1], 10);
                        const day = parseInt(dateParts[2], 10);
                        dateDisplay = `${month}/${day}`;
                    } else {
                        dateDisplay = lastUpdate;
                    }
                }
                
                const div = document.createElement('div');
                div.className = `column-item status-${status}`;
                
                // ì…ë ¥ íŒ¨ë„ì—ì„œ íœ´ë¬´ì¼ì´ë©´ ì „ì²´ ë¹„í™œì„±í™”
                if (containerId === 'column-grid-input' && isHolidayToday) {
                    div.style.opacity = '0.4';
                    div.style.cursor = 'not-allowed';
                    div.style.background = '#ffcdd2';
                }
                // ì…ë ¥ íŒ¨ë„ì—ì„œ ì„ íƒ ê°€ëŠ¥í•œ ê¸°ë‘¥ ê°•ì¡° í‘œì‹œ
                else if (containerId === 'column-grid-input' && currentProcess && !editMode) {
                    // ì†Œë¶€ì¬ì»¤íŒ…(process 2)ì€ ë…ë¦½ì ìœ¼ë¡œ ì„ íƒ ê°€ëŠ¥ (ëª¨ë“  ê¸°ë‘¥ ì„ íƒ ê°€ëŠ¥)
                    // ì£¼ê¸°ë‘¥ì¡°ë¦½(process 3)ì€ ì£¼ê¸°ë‘¥ì»¤íŒ…(process 1) ì™„ë£Œ ìƒíƒœë§Œ í™•ì¸
                    let canProcess = false;
                    if (currentProcess === 2) {
                        // ì†Œë¶€ì¬ì»¤íŒ…ì€ ëª¨ë“  ê¸°ë‘¥ ì„ íƒ ê°€ëŠ¥
                        canProcess = true;
                    } else if (currentProcess === 3) {
                        // ì£¼ê¸°ë‘¥ì¡°ë¦½ì€ ì£¼ê¸°ë‘¥ì»¤íŒ…(process 1) ì™„ë£Œ ìƒíƒœ í™•ì¸
                        let hasCutting = false;
                        // ëª¨ë“  ë‚ ì§œì—ì„œ ì£¼ê¸°ë‘¥ì»¤íŒ…(process 1) ì™„ë£Œ í™•ì¸
                        for (let date in dailyData) {
                            if (dailyData[date] && dailyData[date][1]) {
                                if (dailyData[date][1].includes(colId) || 
                                    dailyData[date][1].includes(i) || 
                                    dailyData[date][1].includes(String(i))) {
                                    hasCutting = true;
                                    break;
                                }
                            }
                        }
                        // columnDataì—ì„œë„ í™•ì¸
                        if (!hasCutting) {
                            const colData = columnData[colId] || {};
                            if (colData.status >= 1) {
                                hasCutting = true;
                            }
                        }
                        canProcess = hasCutting;
                    } else if (currentProcess === 4) {
                        // ì†Œë¶€ì¬ì¡°ë¦½ì€ ì£¼ê¸°ë‘¥ì»¤íŒ…(process 1), ì†Œë¶€ì¬ì»¤íŒ…(process 2), ì£¼ê¸°ë‘¥ì¡°ë¦½(process 3)ì´ ëª¨ë‘ ì™„ë£Œëœ ìƒíƒœ í™•ì¸
                        let hasCutting = false; // ì£¼ê¸°ë‘¥ì»¤íŒ… ì™„ë£Œ ì—¬ë¶€
                        let hasSubProcessing = false; // ì†Œë¶€ì¬ì»¤íŒ… ì™„ë£Œ ì—¬ë¶€
                        let hasMainAssembly = false; // ì£¼ê¸°ë‘¥ì¡°ë¦½ ì™„ë£Œ ì—¬ë¶€
                        
                        // ëª¨ë“  ë‚ ì§œì—ì„œ ì£¼ê¸°ë‘¥ì»¤íŒ…(process 1) ì™„ë£Œ í™•ì¸
                        for (let date in dailyData) {
                            if (dailyData[date] && dailyData[date][1]) {
                                if (dailyData[date][1].includes(colId) || 
                                    dailyData[date][1].includes(i) || 
                                    dailyData[date][1].includes(String(i))) {
                                    hasCutting = true;
                                    break;
                                }
                            }
                        }
                        
                        // ëª¨ë“  ë‚ ì§œì—ì„œ ì†Œë¶€ì¬ì»¤íŒ…(process 2) ì™„ë£Œ í™•ì¸
                        for (let date in dailyData) {
                            if (dailyData[date] && dailyData[date][2]) {
                                if (dailyData[date][2].includes(colId) || 
                                    dailyData[date][2].includes(i) || 
                                    dailyData[date][2].includes(String(i))) {
                                    hasSubProcessing = true;
                                    break;
                                }
                            }
                        }
                        
                        // ëª¨ë“  ë‚ ì§œì—ì„œ ì£¼ê¸°ë‘¥ì¡°ë¦½(process 3) ì™„ë£Œ í™•ì¸
                        for (let date in dailyData) {
                            if (dailyData[date] && dailyData[date][3]) {
                                if (dailyData[date][3].includes(colId) || 
                                    dailyData[date][3].includes(i) || 
                                    dailyData[date][3].includes(String(i))) {
                                    hasMainAssembly = true;
                                    break;
                                }
                            }
                        }
                        
                        // columnDataì—ì„œë„ í™•ì¸
                        const colData = columnData[colId] || {};
                        if (!hasCutting && colData.status >= 1) {
                            hasCutting = true;
                        }
                        if (!hasSubProcessing && colData.status >= 2) {
                            hasSubProcessing = true;
                        }
                        if (!hasMainAssembly && colData.status >= 3) {
                            hasMainAssembly = true;
                        }
                        
                        canProcess = (hasCutting && hasSubProcessing && hasMainAssembly);
                    } else {
                        // ë‚˜ë¨¸ì§€ ê³µì •ì€ ì´ì „ ê³µì • ì™„ë£Œ ìƒíƒœ í™•ì¸
                        canProcess = (status === currentProcess - 1);
                    }
                    
                    // ëª¨ë“  ê³µì •ì—ì„œ ì„ íƒëœ ê¸°ë‘¥ í‘œì‹œ
                    const isSelected = selectedColumns.includes(colId);
                    if (canProcess) {
                        if (isSelected) {
                            // ì„ íƒëœ ê¸°ë‘¥ì€ íŒŒë€ìƒ‰ í…Œë‘ë¦¬
                            div.style.boxShadow = '0 0 0 3px #2196f3, 0 0 10px rgba(33,150,243,0.6)';
                            div.style.background = '#e3f2fd';
                            div.style.animation = 'none';
                        } else {
                            // ì„ íƒ ê°€ëŠ¥í•œ ê¸°ë‘¥ì€ ê¸ˆìƒ‰ í…Œë‘ë¦¬
                            div.style.boxShadow = '0 0 0 3px #ffd700, 0 0 10px rgba(255,215,0,0.5)';
                            div.style.animation = 'pulse 1.5s infinite';
                        }
                        availableCount++;
                    } else if (status >= currentProcess) {
                        div.style.opacity = '0.5';
                        completedCount++;
                    }
                }
                // ìˆ˜ì • ëª¨ë“œì¼ ë•ŒëŠ” ëª¨ë“  ê¸°ë‘¥ í´ë¦­ ê°€ëŠ¥í•˜ë„ë¡ í‘œì‹œ
                else if (containerId === 'column-grid-input' && editMode) {
                    div.style.boxShadow = '0 0 0 2px #4caf50, 0 0 8px rgba(76,175,80,0.3)';
                    div.style.cursor = 'pointer';
                }
                
                // ì¼ì¼ì…ë ¥ íŒ¨ë„ì—ì„œë§Œ ë‚ ì§œ í‘œì‹œ
                const isInputPanel = (containerId === 'column-grid-input');
                const showDate = isInputPanel && dateDisplay && dateDisplay.trim() !== '';
                
                // ë°°ì†¡í™•ì¸ëœ ê¸°ë‘¥ì˜ ê¸€ì”¨ ìƒ‰ìƒ ì„¤ì •
                const isDeliveryConfirmed = (containerId === 'column-grid-input' && currentProcess === 5 && deliveryConfirmed[colId]);
                const textColorStyle = isDeliveryConfirmed ? 'color:#000000;font-weight:bold;' : '';
                
                // í˜„ì¥ë°°ì†¡(process 5)ì—ì„œ ì†Œì¡°ë¦½ ì™„ë£Œì¼ê³¼ ìš´ì†¡ê³„íšì¼, ì‹¤ì œ ë°°ì†¡ì¼ í‘œì‹œ
                let assemblyDate = ''; // ì†Œì¡°ë¦½(process 4) ì™„ë£Œ ë‚ ì§œ
                let transportPlanDate = ''; // ë‹¹ì´ˆ ìš´ì†¡ê³„íš ë‚ ì§œ
                let actualDeliveryDateStr = ''; // ì‹¤ì œ ë°°ì†¡ ë‚ ì§œ
                
                if (containerId === 'column-grid-input' && currentProcess === 5) {
                    // ì†Œì¡°ë¦½(process 4) ì™„ë£Œ ë‚ ì§œ ì°¾ê¸°
                    for (let date in dailyData) {
                        if (dailyData[date] && dailyData[date][4]) {
                            if (dailyData[date][4].includes(colId) || 
                                dailyData[date][4].includes(i) || 
                                dailyData[date][4].includes(String(i))) {
                                const dateParts = date.split('-');
                                if (dateParts.length === 3) {
                                    const month = parseInt(dateParts[1], 10);
                                    const day = parseInt(dateParts[2], 10);
                                    assemblyDate = `${month}/${day}`;
                                }
                                break;
                            }
                        }
                    }
                    
                    // ë‹¹ì´ˆ ìš´ì†¡ê³„íš ë‚ ì§œ ì°¾ê¸° (transportPlanì—ì„œ)
                    for (let tripNum in transportPlan) {
                        const tripData = transportPlan[tripNum];
                        if (tripData && tripData.columns && tripData.date) {
                            const colNum = typeof colId === 'string' ? parseInt(colId.replace('C', '')) : colId;
                            if (tripData.columns.includes(colNum) || 
                                tripData.columns.includes(i) || 
                                tripData.columns.includes(String(i)) ||
                                tripData.columns.includes(colId)) {
                                const dateParts = tripData.date.split('-');
                                if (dateParts.length === 3) {
                                    const month = parseInt(dateParts[1], 10);
                                    const day = parseInt(dateParts[2], 10);
                                    transportPlanDate = `${month}/${day}`;
                                }
                                break;
                            }
                        }
                    }
                    
                    // ì‹¤ì œ ë°°ì†¡ ë‚ ì§œ ì°¾ê¸° (actualDeliveryDateì—ì„œ)
                    if (actualDeliveryDate[colId]) {
                        const dateParts = actualDeliveryDate[colId].split('-');
                        if (dateParts.length === 3) {
                            const month = parseInt(dateParts[1], 10);
                            const day = parseInt(dateParts[2], 10);
                            actualDeliveryDateStr = `${month}/${day}`;
                        }
                    }
                }
                
                // ë‚ ì§œ í‘œì‹œ HTML ìƒì„±
                let dateDisplayHtml = '';
                if (containerId === 'column-grid-input' && currentProcess === 5 && (assemblyDate || transportPlanDate || actualDeliveryDateStr)) {
                    // í˜„ì¥ë°°ì†¡ì—ì„œëŠ” ì†Œì¡°ë¦½ì¼, ìš´ì†¡ê³„íšì¼, ì‹¤ì œë°°ì†¡ì¼ì„ ì¤„ë°”ê¿ˆìœ¼ë¡œ í‘œì‹œ
                    let dateLines = [];
                    if (assemblyDate) dateLines.push(`ì†Œì¡°ë¦½: ${assemblyDate}`);
                    if (transportPlanDate) dateLines.push(`ìš´ì†¡: ${transportPlanDate}`);
                    if (actualDeliveryDateStr) dateLines.push(`ì‹¤ì œë°°ì†¡: ${actualDeliveryDateStr}`);
                    if (dateLines.length > 0) {
                        dateDisplayHtml = `<span style="font-size:10px;color:${isDeliveryConfirmed ? '#000000' : '#2c4a7c'};margin-top:3px;display:block;line-height:1.4;font-weight:${isDeliveryConfirmed ? 'bold' : '600'};background:rgba(44,74,124,0.1);padding:2px 4px;border-radius:3px;">${dateLines.join('<br>')}</span>`;
                    }
                } else if (showDate) {
                    // ë‹¤ë¥¸ ê³µì •ì—ì„œëŠ” ê¸°ì¡´ ë‚ ì§œ í‘œì‹œ
                    dateDisplayHtml = `<span style="font-size:11px;color:${isDeliveryConfirmed ? '#000000' : '#2c4a7c'};margin-top:3px;display:block;line-height:1.2;font-weight:${isDeliveryConfirmed ? 'bold' : '600'};background:rgba(44,74,124,0.1);padding:1px 4px;border-radius:3px;">${dateDisplay}</span>`;
                }
                
                // í˜„ì¥ë°°ì†¡(process 5)ì—ì„œëŠ” ìƒíƒœ í…ìŠ¤íŠ¸ë¥¼ í‘œì‹œí•˜ì§€ ì•ŠìŒ
                const statusText = (containerId === 'column-grid-input' && currentProcess === 5) ? '' : statusNames[status];
                
                // ê¸°ë‘¥ ì´ë¦„ í‘œì‹œ (ì—‘ì…€ì—ì„œ ì½ì€ ì´ë¦„ì´ ìˆìœ¼ë©´ í‘œì‹œ)
                const nameDisplay = colName ? `<span style="font-size:10px;color:#666;margin-top:2px;display:block;">${colName}</span>` : '';
                
                div.innerHTML = `
                    <span class="col-num" style="${textColorStyle}">${colId}</span>
                    ${nameDisplay}
                    ${dateDisplayHtml}
                    ${statusText ? `<span class="col-status" style="${textColorStyle}">${statusText}</span>` : ''}
                `;
                
                if (containerId === 'column-grid-input') {
                    // í˜„ì¥ë°°ì†¡(process 5)ì€ ë°°ì†¡í™•ì¸ ë²„íŠ¼ìœ¼ë¡œ ê´€ë¦¬
                    if (currentProcess === 5) {
                        // dailyData[date][5]ì— ìˆëŠ” ê¸°ë‘¥ì¸ì§€ í™•ì¸ (ìš´ì†¡ì°¨ìˆ˜ê³„íšì—ì„œ ë°›ì€ ë°ì´í„°)
                        let hasTransportPlan = false;
                        for (let date in dailyData) {
                            if (dailyData[date] && dailyData[date][5]) {
                                if (dailyData[date][5].includes(colId) || 
                                    dailyData[date][5].includes(i) || 
                                    dailyData[date][5].includes(String(i))) {
                                    hasTransportPlan = true;
                                    break;
                                }
                            }
                        }
                        
                        if (hasTransportPlan) {
                            // ë°°ì†¡í™•ì¸ ìƒíƒœì— ë”°ë¼ ìƒ‰ìƒ ë³€ê²½
                            if (deliveryConfirmed[colId]) {
                                div.style.background = '#9c27b0'; // ì§™ì€ ë§ˆì  íƒ€ - ë°°ì†¡í™•ì¸ë¨
                                div.style.borderColor = '#7b1fa2';
                                // ë°°ì†¡í™•ì¸ëœ ì…€ì˜ ê¸€ì”¨ ìƒ‰ìƒì„ êµµì€ ê²€ì •ìƒ‰ìœ¼ë¡œ í‘œì‹œ
                                div.style.color = '#000000';
                                div.style.fontWeight = 'bold';
                            } else {
                                div.style.background = '#fff5ff'; // ë” ì˜…ì€ ë§ˆì  íƒ€ - ë°°ì†¡ê³„íšë§Œ
                                div.style.borderColor = '#9c27b0';
                            }
                            div.style.cursor = 'pointer';
                            div.onclick = () => toggleDeliveryConfirmation(colId);
                        } else {
                            // ìš´ì†¡ì°¨ìˆ˜ê³„íšì— ì—†ëŠ” ê¸°ë‘¥ì€ ë¯¸ì°©ìˆ˜ ìƒíƒœë¡œ ì˜…ì€ íšŒìƒ‰ í‘œì‹œ
                            div.style.background = '#e0e0e0'; // ì˜…ì€ íšŒìƒ‰ - ë¯¸ì°©ìˆ˜
                            div.style.borderColor = '#bdbdbd';
                            div.style.opacity = '0.6';
                            div.style.cursor = 'not-allowed';
                        }
                    } else {
                        // ëª¨ë“  ê³µì •(1-6)ì—ì„œ ë‹¤ì¤‘ ì„ íƒ ëª¨ë“œ (í˜„ì¥ë°°ì†¡ ì œì™¸)
                        if (currentProcess && currentProcess >= 1 && currentProcess <= 6 && !editMode) {
                            div.onclick = () => toggleColumnSelection(colId);
                        } else {
                            div.onclick = () => openColumnModal(colId);
                        }
                    }
                }
                
                container.appendChild(div);
                } // ì„œë¸Œ í•­ëª© ë£¨í”„ ë‹«ê¸°
            } // ê¸°ë‘¥ ë£¨í”„ ë‹«ê¸°
            
            // ê¸°ë‘¥ ê·¸ë¦¬ë“œ ë Œë”ë§ í›„ ê³µì •ë³„ ê¶Œí•œ ì ìš©
            applyProcessPermissionToColumnGrid();
            
            // ê°€ì´ë“œ í†µê³„ ì—…ë°ì´íŠ¸
            if (containerId === 'column-grid-input') {
                const statsDiv = document.getElementById('guide-stats');
                const totalItems = TOTAL_COLUMNS * SUB_ITEMS_PER_COLUMN; // ì´ 100ê°œ
                if (isHolidayToday) {
                    // íœ´ë¬´ì¼ ë©”ì‹œì§€
                    statsDiv.style.display = 'block';
                    statsDiv.style.background = '#ffcdd2';
                    statsDiv.style.color = '#c62828';
                    statsDiv.innerHTML = `<strong>ğŸš« ${getHolidayName(workDate)}</strong> - í•´ë‹¹ì¼ì€ ì‘ì—…ì„ ì…ë ¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;
                } else if (currentProcess && currentProcess >= 1 && currentProcess <= 6 && selectedColumns.length > 0) {
                    // ëª¨ë“  ê³µì •ì—ì„œ ì„ íƒëœ ê¸°ë‘¥ì´ ìˆì„ ë•Œ
                    updateSelectedColumnsInfo();
                } else if (currentProcess) {
                    const processNames = ['', 'ì£¼ê¸°ë‘¥ì»¤íŒ…', 'ê¸°ë‘¥ì†Œë¶€ì¬ì»¤íŒ…', 'ì£¼ê¸°ë‘¥ì¡°ë¦½', 'ì†Œë¶€ì¬ì¡°ë¦½', 'í˜„ì¥ë°°ì†¡', 'í˜„ì¥ì„¤ì¹˜'];
                    statsDiv.style.display = 'block';
                    statsDiv.style.background = '#e8f5e9';
                    statsDiv.style.color = '#2e7d32';
                    statsDiv.innerHTML = 
                        `ğŸ“Š <strong>${processNames[currentProcess]}</strong> - ì…ë ¥ ê°€ëŠ¥: <strong style="color:#f57c00;">${availableCount}ê°œ</strong> / ì™„ë£Œ: <strong style="color:#4caf50;">${completedCount}ê°œ</strong> / ëŒ€ê¸°: <strong style="color:#757575;">${totalItems - availableCount - completedCount}ê°œ</strong>`;
                } else {
                    statsDiv.style.display = 'none';
                }
            }
        }

        // ìˆ˜ì • ëª¨ë“œ í™œì„±í™”/ë¹„í™œì„±í™”
        function enableEditMode() {
            // ğŸ”’ [ê°€ë“œ] ê¶Œí•œ ì²´í¬: ViewerëŠ” ìˆ˜ì • ëª¨ë“œ í™œì„±í™” ë¶ˆê°€
            if (userRole === 'viewer') {
                alert('âš ï¸ ê¶Œí•œ ì—†ìŒ\n\nViewerëŠ” ìˆ˜ì • ëª¨ë“œë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì½ê¸° ì „ìš©)');
                return;
            }
            
            // ğŸ”’ [ê°€ë“œ] ê¶Œí•œ ì²´í¬: EditorëŠ” í—ˆìš©ëœ ê³µì •ì´ ìˆì„ ë•Œë§Œ ìˆ˜ì • ëª¨ë“œ í™œì„±í™” ê°€ëŠ¥
            if (userRole === 'editor') {
                if (!Array.isArray(allowedProcesses) || allowedProcesses.length === 0) {
                    alert('âš ï¸ ê¶Œí•œ ì—†ìŒ\n\nEditorëŠ” í—ˆìš©ëœ ê³µì •ì´ ì—†ìŠµë‹ˆë‹¤.\n\nê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
                    return;
                }
            }
            
            editMode = !editMode;
            const btn = document.getElementById('edit-mode-btn');
            if (!btn) {
                console.error('ìˆ˜ì • ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            if (editMode) {
                btn.style.background = '#4caf50';
                btn.textContent = 'âœ… ìˆ˜ì •ì¤‘';
                alert('ìˆ˜ì • ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ê³µì •í‘œì—ì„œ ë‚ ì§œë¥¼ í´ë¦­í•˜ì—¬ ê¸°ë‘¥ ìƒíƒœë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            } else {
                btn.style.background = '#ff9800';
                btn.textContent = 'âœï¸ ìˆ˜ì •';
                alert('ìˆ˜ì • ëª¨ë“œê°€ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
            renderColumnGrid('column-grid-input');
            // Gantt ì°¨íŠ¸ë„ ë‹¤ì‹œ ë Œë”ë§í•˜ì—¬ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
            if (document.getElementById('panel-gantt')?.classList.contains('active')) {
                renderGanttChart();
            }
        }
        
        // ì‚­ì œ ëª¨ë“œ í™œì„±í™”/ë¹„í™œì„±í™”
        function enableDeleteMode() {
            deleteMode = !deleteMode;
            const btn = document.getElementById('delete-mode-btn');
            if (!btn) {
                console.error('ì‚­ì œ ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            if (deleteMode) {
                btn.style.background = '#d32f2f';
                btn.textContent = 'âœ… ë°ì´í„° ì‚­ì œì¤‘';
                alert('ë°ì´í„° ì‚­ì œ ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ê³µì •í‘œì—ì„œ ì‚­ì œí•  ë°ì´í„°ê°€ ìˆëŠ” ë‚ ì§œë¥¼ í´ë¦­í•˜ì—¬ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            } else {
                btn.style.background = '#f44336';
                btn.textContent = 'ğŸ—‘ï¸ ë°ì´í„° ì‚­ì œ';
                alert('ë°ì´í„° ì‚­ì œ ëª¨ë“œê°€ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
            // Gantt ì°¨íŠ¸ ë‹¤ì‹œ ë Œë”ë§í•˜ì—¬ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€/ì œê±°
            if (document.getElementById('panel-gantt')?.classList.contains('active')) {
                renderGanttChart();
            }
        }
        
        // ëª¨ë‹¬ ì œì–´ í•¨ìˆ˜ë“¤
        function showProcessSelectionModal(colId, dateStr) {
            const modal = document.getElementById('process-selection-modal');
            const message = document.getElementById('process-selection-message');
            message.textContent = `${colId}ì˜ ${dateStr}ì— ì£¼ê¸°ë‘¥ì»¤íŒ…(1)ê³¼ ì†Œë¶€ì¬ì»¤íŒ…(2)ì´ ëª¨ë‘ ìˆìŠµë‹ˆë‹¤.\n\nì‚­ì œí•  ê³µì •ì„ ì„ íƒí•˜ì„¸ìš”:`;
            modal.classList.add('active');
        }

        function hideProcessSelectionModal() {
            const modal = document.getElementById('process-selection-modal');
            modal.classList.remove('active');
            pendingDeleteInfo = null;
        }

        function selectProcessForDelete(processNum) {
            // ğŸ”’ [ê°€ë“œ] ê¶Œí•œ ì²´í¬: ViewerëŠ” ì‚­ì œ ë¶ˆê°€
            if (userRole === 'viewer') {
                alert('âš ï¸ ê¶Œí•œ ì—†ìŒ\n\nViewerëŠ” ê³µì • ë°ì´í„°ë¥¼ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì½ê¸° ì „ìš©)');
                hideProcessSelectionModal();
                return;
            }
            
            // ğŸ”’ [ê°€ë“œ] ê¶Œí•œ ì²´í¬: EditorëŠ” í—ˆìš©ëœ ê³µì •ë§Œ ì‚­ì œ ê°€ëŠ¥
            if (userRole === 'editor' && !canEditProcess(processNum)) {
                const proc = PROCESSES.find(p => p.id === processNum);
                const procName = proc ? proc.name : `ê³µì • ${processNum}`;
                alert(`âš ï¸ ê¶Œí•œ ì—†ìŒ\n\nEditorëŠ” ${procName}ì„ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\ní—ˆìš©ëœ ê³µì •: ${allowedProcesses.map(p => {
                    const pr = PROCESSES.find(pr => pr.id === p);
                    return pr ? `${p}.${pr.name}` : `${p}`;
                }).join(', ')}`);
                hideProcessSelectionModal();
                return;
            }
            
            if (!pendingDeleteInfo) {
                hideProcessSelectionModal();
                return;
            }

            const { columnNum, dateStr, processNames } = pendingDeleteInfo;
            const colId = columnNum + 'C';

            if (!confirm(`âš ï¸ ë°ì´í„° ì‚­ì œ í™•ì¸\n\n${colId}ì˜ ${dateStr}ì—ì„œ ${processNum}.${processNames[processNum]}ë§Œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n(ë‹¤ë¥¸ ê³µì •ì€ ìœ ì§€ë©ë‹ˆë‹¤)\n\nâš ï¸ ì¼ì¼ì…ë ¥ì—ì„œë„ ê°•ì œ ì‚­ì œë©ë‹ˆë‹¤.`)) {
                hideProcessSelectionModal();
                return;
            }

            hideProcessSelectionModal();
            executeProcessDelete(columnNum, dateStr, processNum);
        }

        function cancelProcessSelection() {
            hideProcessSelectionModal();
        }

        // ì‹¤ì œ ì‚­ì œ ì‹¤í–‰ í•¨ìˆ˜
        function executeProcessDelete(columnNum, dateStr, processToDelete) {
            // ğŸ”’ [ê°€ë“œ] ê¶Œí•œ ì²´í¬: ViewerëŠ” ì‚­ì œ ë¶ˆê°€
            if (userRole === 'viewer') {
                alert('âš ï¸ ê¶Œí•œ ì—†ìŒ\n\nViewerëŠ” ê³µì • ë°ì´í„°ë¥¼ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì½ê¸° ì „ìš©)');
                return;
            }
            
            // ğŸ”’ [ê°€ë“œ] ê¶Œí•œ ì²´í¬: EditorëŠ” í—ˆìš©ëœ ê³µì •ë§Œ ì‚­ì œ ê°€ëŠ¥
            if (userRole === 'editor' && !canEditProcess(processToDelete)) {
                const proc = PROCESSES.find(p => p.id === processToDelete);
                const procName = proc ? proc.name : `ê³µì • ${processToDelete}`;
                alert(`âš ï¸ ê¶Œí•œ ì—†ìŒ\n\nEditorëŠ” ${procName}ì„ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\ní—ˆìš©ëœ ê³µì •: ${allowedProcesses.map(p => {
                    const pr = PROCESSES.find(pr => pr.id === p);
                    return pr ? `${p}.${pr.name}` : `${p}`;
                }).join(', ')}`);
                return;
            }
            
            const colId = columnNum + 'C';
            const processNames = ['', 'ì£¼ê¸°ë‘¥ì»¤íŒ…', 'ì†Œë¶€ì¬ì»¤íŒ…', 'ì£¼ê¸°ë‘¥ì¡°ë¦½', 'ì†Œë¶€ì¬ì¡°ë¦½', 'í˜„ì¥ë°°ì†¡', 'í˜„ì¥ì„¤ì¹˜'];
            
            // í•´ë‹¹ ê³µì • ì‚­ì œ
            if (dailyData[dateStr] && dailyData[dateStr][processToDelete]) {
                dailyData[dateStr][processToDelete] = dailyData[dateStr][processToDelete].filter(col => {
                    if (typeof col === 'number' && col === columnNum) return false;
                    if (typeof col === 'string') {
                        if (col === colId) return false;
                        if (col === String(columnNum)) return false;
                        const colNum = parseInt(col.replace('C', ''));
                        if (!isNaN(colNum) && colNum === columnNum) return false;
                    }
                    return true;
                });
                
                if (dailyData[dateStr][processToDelete].length === 0) {
                    delete dailyData[dateStr][processToDelete];
                }
            }
            
            // columnData ì—…ë°ì´íŠ¸
            if (columnData[colId] && columnData[colId].lastUpdate === dateStr) {
                let lastUpdate = '';
                for (let date in dailyData) {
                    for (let p = 1; p <= 6; p++) {
                        const dayData = dailyData[date][p];
                        if (dayData) {
                            const hasColumn = dayData.some(col => {
                                if (typeof col === 'number' && col === columnNum) return true;
                                if (typeof col === 'string') {
                                    if (col === colId) return true;
                                    if (col === String(columnNum)) return true;
                                    const colNum = parseInt(col.replace('C', ''));
                                    if (!isNaN(colNum) && colNum === columnNum) return true;
                                }
                                return false;
                            });
                            if (hasColumn && date > lastUpdate) {
                                lastUpdate = date;
                            }
                        }
                    }
                }
                columnData[colId].lastUpdate = lastUpdate;
                columnData[colId].status = getColumnStatus(colId);
            }
            
            saveToStorage();
            renderGanttChart();
            renderColumnGrid('column-grid-input');
            updateProgressBars();
            loadDayData(dateStr);
            checkDuplicateForDate(dateStr);
        }

        // Gantt ì°¨íŠ¸ ì…€ ì‚­ì œ í•¸ë“¤ëŸ¬
        function handleGanttCellDelete(colId, dateStr) {
            // ğŸ”’ [ê°€ë“œ] ê¶Œí•œ ì²´í¬: ViewerëŠ” ì‚­ì œ ë¶ˆê°€
            if (userRole === 'viewer') {
                alert('âš ï¸ ê¶Œí•œ ì—†ìŒ\n\nViewerëŠ” ê³µì • ë°ì´í„°ë¥¼ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì½ê¸° ì „ìš©)');
                return;
            }
            
            if (!deleteMode) {
                alert('ì‚­ì œ ëª¨ë“œë¥¼ ë¨¼ì € í™œì„±í™”í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // colIdì—ì„œ ê¸°ë‘¥ ë²ˆí˜¸ ì¶”ì¶œ (1C001 -> 1, 7TC001 -> 7)
            const columnIndex = getColumnIndexFromId(colId);
            const columnNum = columnIndex || parseInt(String(colId).replace(/[^0-9]/g, ''));
            
            // í•´ë‹¹ ë‚ ì§œì— ì™„ë£Œëœ ê³µì • ì°¾ê¸°
            const completedProcesses = [];
            for (let p = 1; p <= 6; p++) {
                const dayData = dailyData[dateStr]?.[p];
                if (dayData && (dayData.includes(columnNum) || dayData.includes(colId) || dayData.includes(String(columnNum)) ||
                    dayData.includes(`${columnNum}C`) || dayData.includes(`${columnNum}TC`))) {
                    completedProcesses.push(p);
                }
            }
            
            // ğŸ”’ [ê°€ë“œ] ê¶Œí•œ ì²´í¬: EditorëŠ” í—ˆìš©ëœ ê³µì •ë§Œ ì‚­ì œ ê°€ëŠ¥
            if (userRole === 'editor') {
                const deletableProcesses = completedProcesses.filter(p => canEditProcess(p));
                if (deletableProcesses.length === 0) {
                    const processList = completedProcesses.map(p => {
                        const proc = PROCESSES.find(pr => pr.id === p);
                        return proc ? `${p}.${proc.name}` : `${p}`;
                    }).join(', ');
                    alert(`âš ï¸ ê¶Œí•œ ì—†ìŒ\n\nEditorëŠ” ë‹¤ìŒ ê³µì •ì„ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${processList}\n\ní—ˆìš©ëœ ê³µì •: ${allowedProcesses.map(p => {
                        const pr = PROCESSES.find(pr => pr.id === p);
                        return pr ? `${p}.${pr.name}` : `${p}`;
                    }).join(', ')}`);
                    return;
                }
                // ì‚­ì œ ê°€ëŠ¥í•œ ê³µì •ë§Œ ë‚¨ê¹€
                if (deletableProcesses.length < completedProcesses.length) {
                    const nonDeletable = completedProcesses.filter(p => !canEditProcess(p));
                    const nonDeletableNames = nonDeletable.map(p => {
                        const proc = PROCESSES.find(pr => pr.id === p);
                        return proc ? `${p}.${proc.name}` : `${p}`;
                    }).join(', ');
                    alert(`âš ï¸ ì¼ë¶€ ê³µì • ì‚­ì œ ë¶ˆê°€\n\në‹¤ìŒ ê³µì •ì€ ê¶Œí•œì´ ì—†ì–´ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${nonDeletableNames}\n\nì‚­ì œ ê°€ëŠ¥í•œ ê³µì •ë§Œ ì‚­ì œí•©ë‹ˆë‹¤.`);
                }
            }
            
            if (completedProcesses.length === 0) {
                alert(`${colId}ëŠ” ${dateStr}ì— ì™„ë£Œëœ ê³µì •ì´ ì—†ìŠµë‹ˆë‹¤.`);
                return;
            }
            
            const processNames = ['', 'ì£¼ê¸°ë‘¥ì»¤íŒ…', 'ì†Œë¶€ì¬ì»¤íŒ…', 'ì£¼ê¸°ë‘¥ì¡°ë¦½', 'ì†Œë¶€ì¬ì¡°ë¦½', 'í˜„ì¥ë°°ì†¡', 'í˜„ì¥ì„¤ì¹˜'];
            
            // ì¤‘ë³µëœ ë°ì´í„°ì¸ ê²½ìš°
            if (completedProcesses.length > 1) {
                // ì£¼ê¸°ë‘¥ì»¤íŒ…(1)ê³¼ ì†Œë¶€ì¬ì»¤íŒ…(2)ì´ ëª¨ë‘ ìˆëŠ” ê²½ìš° íŠ¹ë³„ ì²˜ë¦¬
                const hasP1 = completedProcesses.includes(1);
                const hasP2 = completedProcesses.includes(2);
                
                // ë””ë²„ê¹…: completedProcesses í™•ì¸
                console.log('ì‚­ì œ ìš”ì²­ - completedProcesses:', completedProcesses, 'hasP1:', hasP1, 'hasP2:', hasP2);
                
                if (hasP1 && hasP2) {
                    // ì£¼ê¸°ë‘¥ì»¤íŒ…(1)ê³¼ ì†Œë¶€ì¬ì»¤íŒ…(2)ì´ ëª¨ë‘ ìˆëŠ” ê²½ìš° ëª¨ë‹¬ í‘œì‹œ
                    pendingDeleteInfo = { columnNum: colId, dateStr, processNames };
                    showProcessSelectionModal(colId, dateStr);
                    return;
                } else {
                    // ë‹¤ë¥¸ ì¤‘ë³µ ê³µì •ì¸ ê²½ìš° ê¸°ì¡´ ë¡œì§ ì‚¬ìš© (ê°€ì¥ ë†’ì€ ê³µì •ì„ ë‚¨ê¸°ê³  ë‚˜ë¨¸ì§€ ì‚­ì œ)
                    const processList = completedProcesses.map(p => `${p}.${processNames[p]}`).join(', ');
                    const maxProcess = Math.max(...completedProcesses);
                    let processesToDelete = completedProcesses.filter(p => p !== maxProcess);
                    
                    // ğŸ”’ [ê°€ë“œ] EditorëŠ” í—ˆìš©ëœ ê³µì •ë§Œ ì‚­ì œ ê°€ëŠ¥
                    if (userRole === 'editor') {
                        processesToDelete = processesToDelete.filter(p => canEditProcess(p));
                        if (processesToDelete.length === 0) {
                            alert(`âš ï¸ ê¶Œí•œ ì—†ìŒ\n\nEditorëŠ” ì‚­ì œí•  ìˆ˜ ìˆëŠ” ê³µì •ì´ ì—†ìŠµë‹ˆë‹¤.\n\ní—ˆìš©ëœ ê³µì •: ${allowedProcesses.map(p => {
                                const pr = PROCESSES.find(pr => pr.id === p);
                                return pr ? `${p}.${pr.name}` : `${p}`;
                            }).join(', ')}`);
                            return;
                        }
                    }
                    
                    if (confirm(`âš ï¸ ì¤‘ë³µëœ ë°ì´í„° ì‚­ì œ\n\n${colId}ì˜ ${dateStr}ì— ì¤‘ë³µ ì…ë ¥ëœ ê³µì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nìœ ì§€í•  ê³µì •: ${maxProcess}.${processNames[maxProcess]}\nì‚­ì œí•  ê³µì •: ${processesToDelete.map(p => `${p}.${processNames[p]}`).join(', ')}\n\nâš ï¸ ì¼ì¼ì…ë ¥ì—ì„œë„ ê°•ì œ ì‚­ì œë©ë‹ˆë‹¤.`)) {
                        // ê¸°ì¡´ ë¡œì§: ì—¬ëŸ¬ ê³µì • ì‚­ì œ
                        for (let p of processesToDelete) {
                            if (dailyData[dateStr] && dailyData[dateStr][p]) {
                                // ëª¨ë“  í˜•ì‹ì˜ ê¸°ë‘¥ ë²ˆí˜¸ ì œê±° (ìˆ«ì, "1C001" í˜•ì‹, "7TC001" í˜•ì‹, ë¬¸ìì—´ ë“±)
                                dailyData[dateStr][p] = dailyData[dateStr][p].filter(col => {
                                    // ìˆ«ì í˜•ì‹ ë¹„êµ
                                    if (typeof col === 'number' && col === columnNum) return false;
                                    // ë¬¸ìì—´ í˜•ì‹ ë¹„êµ
                                    if (typeof col === 'string') {
                                        if (col === colId) return false;
                                        if (col === String(columnNum)) return false;
                                        // "1C001", "7TC001" í˜•ì‹ì—ì„œ ìˆ«ìë§Œ ì¶”ì¶œí•˜ì—¬ ë¹„êµ
                                        const colNum = parseInt(col.replace(/[^0-9]/g, ''));
                                        if (!isNaN(colNum) && colNum === columnNum) return false;
                                        // colId í˜•ì‹ê³¼ ì§ì ‘ ë¹„êµ
                                        const colIdFromCol = getColumnIndexFromId(col);
                                        if (colIdFromCol === columnIndex) return false;
                                    }
                                    return true;
                                });
                                // ë¹ˆ ë°°ì—´ì´ë©´ ì‚­ì œ
                                if (dailyData[dateStr][p].length === 0) {
                                    delete dailyData[dateStr][p];
                                }
                            }
                        }
                        
                        // í™”ë©´ ì—…ë°ì´íŠ¸ ë° ì €ì¥ (ê¸°ì¡´ ë¡œì§)
                        // columnDataì˜ lastUpdateë„ í™•ì¸í•˜ì—¬ ì—…ë°ì´íŠ¸
                        if (columnData[colId] && columnData[colId].lastUpdate === dateStr) {
                            // ë‹¤ë¥¸ ë‚ ì§œì˜ ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì°¾ê¸°
                            let lastUpdate = '';
                            for (let date in dailyData) {
                                for (let p = 1; p <= 6; p++) {
                                    const dayData = dailyData[date][p];
                                    if (dayData) {
                                        // ëª¨ë“  í˜•ì‹ì˜ ê¸°ë‘¥ ë²ˆí˜¸ í™•ì¸
                                        const hasColumn = dayData.some(col => {
                                            if (typeof col === 'number' && col === columnNum) return true;
                                            if (typeof col === 'string') {
                                                if (col === colId) return true;
                                                if (col === String(columnNum)) return true;
                                                const colNum = parseInt(col.replace('C', ''));
                                                if (!isNaN(colNum) && colNum === columnNum) return true;
                                            }
                                            return false;
                                        });
                                        if (hasColumn) {
                                            if (!lastUpdate || date > lastUpdate) {
                                                lastUpdate = date;
                                            }
                                        }
                                    }
                                }
                            }
                            columnData[colId].lastUpdate = lastUpdate;
                            // ìƒíƒœë„ ì—…ë°ì´íŠ¸ (ë§ˆì§€ë§‰ ì™„ë£Œëœ ê³µì • ê¸°ì¤€)
                            if (lastUpdate) {
                                let maxStatus = 0;
                                for (let p = 1; p <= 6; p++) {
                                    const dayData = dailyData[lastUpdate]?.[p];
                                    if (dayData) {
                                        const hasColumn = dayData.some(col => {
                                            if (typeof col === 'number' && col === columnNum) return true;
                                            if (typeof col === 'string') {
                                                if (col === colId) return true;
                                                if (col === String(columnNum)) return true;
                                                const colNum = parseInt(col.replace('C', ''));
                                                if (!isNaN(colNum) && colNum === columnNum) return true;
                                            }
                                            return false;
                                        });
                                        if (hasColumn) {
                                            maxStatus = Math.max(maxStatus, p);
                                        }
                                    }
                                }
                                columnData[colId].status = maxStatus;
                            } else {
                                columnData[colId].status = 0;
                            }
                        }
                        
                        // ì €ì¥ (ê°•ì œ ì‚­ì œ ë°˜ì˜) - ë°˜ë“œì‹œ ì €ì¥
                        saveToStorage();
                        
                        // í™”ë©´ ì—…ë°ì´íŠ¸
                        renderGanttChart();
                        renderColumnGrid('column-grid-overview');
                        updateProgressBars();
                        
                        // ì¼ì¼ì…ë ¥ íŒ¨ë„ ê°•ì œ ì—…ë°ì´íŠ¸ (ë°˜ë“œì‹œ ì‚­ì œ ë°˜ì˜)
                        renderColumnGrid('column-grid-input');
                        
                        // 2ë‹¨ê³„: ì¼ì¼ì…ë ¥ íŒ¨ë„ì´ í•´ë‹¹ ë‚ ì§œë¥¼ ë³´ê³  ìˆìœ¼ë©´ loadDayData í˜¸ì¶œ
                        const workDateInput = document.getElementById('work-date');
                        if (workDateInput && workDateInput.value === dateStr) {
                            // loadDayData í•¨ìˆ˜ í˜¸ì¶œí•˜ì—¬ ì¼ì¼ì…ë ¥ ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ (ë°˜ë“œì‹œ ì‚­ì œ ë°˜ì˜)
                            loadDayData();
                            // ì¤‘ë³µ ì²´í¬ë„ ì—…ë°ì´íŠ¸
                            if (typeof checkDuplicateForDate === 'function') {
                                checkDuplicateForDate(dateStr);
                            }
                        }
                        
                        // 3ë‹¨ê³„: ì•½ê°„ì˜ ì§€ì—° í›„ ë‹¤ì‹œ í•œ ë²ˆ í™•ì¸í•˜ì—¬ í™•ì‹¤íˆ ë°˜ì˜
                        setTimeout(() => {
                            // ë‹¤ì‹œ ì €ì¥í•˜ì—¬ í™•ì‹¤íˆ ë°˜ì˜
                            saveToStorage();
                            // ì¼ì¼ì…ë ¥ ê·¸ë¦¬ë“œ ë‹¤ì‹œ ë Œë”ë§
                            renderColumnGrid('column-grid-input');
                            // ì¼ì¼ì…ë ¥ íŒ¨ë„ì´ í•´ë‹¹ ë‚ ì§œë¥¼ ë³´ê³  ìˆìœ¼ë©´ ë‹¤ì‹œ ë¡œë“œ
                            if (workDateInput && workDateInput.value === dateStr) {
                                loadDayData();
                                if (typeof checkDuplicateForDate === 'function') {
                                    checkDuplicateForDate(dateStr);
                                }
                            }
                        }, 200);
                        
                        // 4ë‹¨ê³„: ì¶”ê°€ í™•ì¸ (ë” ê¸´ ì§€ì—° í›„)
                        setTimeout(() => {
                            renderColumnGrid('column-grid-input');
                        }, 500);
                        
                        alert(`âœ… ${colId}ì˜ ${dateStr} ê³µì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.\n\nì¼ì¼ì…ë ¥ì—ì„œë„ ë°˜ë“œì‹œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                        return;
                    } else {
                        return;
                    }
                }
                
                // ì£¼ê¸°ë‘¥ì»¤íŒ…(1) ë˜ëŠ” ì†Œë¶€ì¬ì»¤íŒ…(2) ì¤‘ ì„ íƒí•œ ê²ƒë§Œ ì‚­ì œ
                if (processToDelete !== null) {
                    // ì„ íƒí•œ ê³µì •ë§Œ ì‚­ì œ
                    if (dailyData[dateStr] && dailyData[dateStr][processToDelete]) {
                        // ëª¨ë“  í˜•ì‹ì˜ ê¸°ë‘¥ ë²ˆí˜¸ ì œê±° (ìˆ«ì, "1C" í˜•ì‹, ë¬¸ìì—´ ë“±)
                        dailyData[dateStr][processToDelete] = dailyData[dateStr][processToDelete].filter(col => {
                            // ìˆ«ì í˜•ì‹ ë¹„êµ
                            if (typeof col === 'number' && col === columnNum) return false;
                            // ë¬¸ìì—´ í˜•ì‹ ë¹„êµ
                            if (typeof col === 'string') {
                                if (col === colId) return false;
                                if (col === String(columnNum)) return false;
                                // "1C" í˜•ì‹ì—ì„œ ìˆ«ìë§Œ ì¶”ì¶œí•˜ì—¬ ë¹„êµ
                                const colNum = parseInt(col.replace('C', ''));
                                if (!isNaN(colNum) && colNum === columnNum) return false;
                            }
                            return true;
                        });
                        // ë¹ˆ ë°°ì—´ì´ë©´ ì‚­ì œ
                        if (dailyData[dateStr][processToDelete].length === 0) {
                            delete dailyData[dateStr][processToDelete];
                        }
                    }
                    
                    // columnDataì˜ lastUpdateë„ í™•ì¸í•˜ì—¬ ì—…ë°ì´íŠ¸
                if (columnData[colId] && columnData[colId].lastUpdate === dateStr) {
                    // ë‹¤ë¥¸ ë‚ ì§œì˜ ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì°¾ê¸°
                    let lastUpdate = '';
                    for (let date in dailyData) {
                        for (let p = 1; p <= 6; p++) {
                            const dayData = dailyData[date][p];
                            if (dayData) {
                                // ëª¨ë“  í˜•ì‹ì˜ ê¸°ë‘¥ ë²ˆí˜¸ í™•ì¸
                                const hasColumn = dayData.some(col => {
                                    if (typeof col === 'number' && col === columnNum) return true;
                                    if (typeof col === 'string') {
                                        if (col === colId) return true;
                                        if (col === String(columnNum)) return true;
                                        const colNum = parseInt(col.replace('C', ''));
                                        if (!isNaN(colNum) && colNum === columnNum) return true;
                                    }
                                    return false;
                                });
                                if (hasColumn) {
                                    if (!lastUpdate || date > lastUpdate) {
                                        lastUpdate = date;
                                    }
                                }
                            }
                        }
                    }
                    columnData[colId].lastUpdate = lastUpdate;
                    // ìƒíƒœë„ ì—…ë°ì´íŠ¸ (ë§ˆì§€ë§‰ ì™„ë£Œëœ ê³µì • ê¸°ì¤€)
                    if (lastUpdate) {
                        let maxStatus = 0;
                        for (let p = 1; p <= 6; p++) {
                            const dayData = dailyData[lastUpdate]?.[p];
                            if (dayData) {
                                const hasColumn = dayData.some(col => {
                                    if (typeof col === 'number' && col === columnNum) return true;
                                    if (typeof col === 'string') {
                                        if (col === colId) return true;
                                        if (col === String(columnNum)) return true;
                                        const colNum = parseInt(col.replace('C', ''));
                                        if (!isNaN(colNum) && colNum === columnNum) return true;
                                    }
                                    return false;
                                });
                                if (hasColumn) {
                                    maxStatus = Math.max(maxStatus, p);
                                }
                            }
                        }
                        columnData[colId].status = maxStatus;
                    } else {
                        columnData[colId].status = 0;
                    }
                }
                
                // ì €ì¥ (ê°•ì œ ì‚­ì œ ë°˜ì˜) - ë°˜ë“œì‹œ ì €ì¥
                saveToStorage();
                
                // í™”ë©´ ì—…ë°ì´íŠ¸
                renderGanttChart();
                renderColumnGrid('column-grid-overview');
                updateProgressBars();
                
                // ì¼ì¼ì…ë ¥ íŒ¨ë„ ê°•ì œ ì—…ë°ì´íŠ¸ (ë°˜ë“œì‹œ ì‚­ì œ ë°˜ì˜)
                renderColumnGrid('column-grid-input');
                
                // 2ë‹¨ê³„: ì¼ì¼ì…ë ¥ íŒ¨ë„ì´ í•´ë‹¹ ë‚ ì§œë¥¼ ë³´ê³  ìˆìœ¼ë©´ loadDayData í˜¸ì¶œ
                const workDateInput = document.getElementById('work-date');
                if (workDateInput && workDateInput.value === dateStr) {
                    // loadDayData í•¨ìˆ˜ í˜¸ì¶œí•˜ì—¬ ì¼ì¼ì…ë ¥ ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ (ë°˜ë“œì‹œ ì‚­ì œ ë°˜ì˜)
                    loadDayData();
                    // ì¤‘ë³µ ì²´í¬ë„ ì—…ë°ì´íŠ¸
                    if (typeof checkDuplicateForDate === 'function') {
                        checkDuplicateForDate(dateStr);
                    }
                }
                
                // 3ë‹¨ê³„: ì•½ê°„ì˜ ì§€ì—° í›„ ë‹¤ì‹œ í•œ ë²ˆ í™•ì¸í•˜ì—¬ í™•ì‹¤íˆ ë°˜ì˜
                setTimeout(() => {
                    // ë‹¤ì‹œ ì €ì¥í•˜ì—¬ í™•ì‹¤íˆ ë°˜ì˜
                    saveToStorage();
                    // ì¼ì¼ì…ë ¥ ê·¸ë¦¬ë“œ ë‹¤ì‹œ ë Œë”ë§
                    renderColumnGrid('column-grid-input');
                    // ì¼ì¼ì…ë ¥ íŒ¨ë„ì´ í•´ë‹¹ ë‚ ì§œë¥¼ ë³´ê³  ìˆìœ¼ë©´ ë‹¤ì‹œ ë¡œë“œ
                    if (workDateInput && workDateInput.value === dateStr) {
                        loadDayData();
                        if (typeof checkDuplicateForDate === 'function') {
                            checkDuplicateForDate(dateStr);
                        }
                    }
                }, 200);
                
                // 4ë‹¨ê³„: ì¶”ê°€ í™•ì¸ (ë” ê¸´ ì§€ì—° í›„)
                setTimeout(() => {
                    renderColumnGrid('column-grid-input');
                }, 500);
                
                alert(`âœ… ${colId}ì˜ ${dateStr} ê³µì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.\n\nì¼ì¼ì…ë ¥ì—ì„œë„ ë°˜ë“œì‹œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                }
            } else {
                // ë‹¨ì¼ ê³µì •ì¸ ê²½ìš° ê°•ì œ ì‚­ì œ
                const processNum = completedProcesses[0];
                const processName = processNames[processNum];
                
                // ğŸ”’ [ê°€ë“œ] ê¶Œí•œ ì²´í¬: EditorëŠ” í—ˆìš©ëœ ê³µì •ë§Œ ì‚­ì œ ê°€ëŠ¥
                if (userRole === 'editor' && !canEditProcess(processNum)) {
                    const proc = PROCESSES.find(p => p.id === processNum);
                    const procName = proc ? proc.name : `ê³µì • ${processNum}`;
                    alert(`âš ï¸ ê¶Œí•œ ì—†ìŒ\n\nEditorëŠ” ${procName}ì„ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\ní—ˆìš©ëœ ê³µì •: ${allowedProcesses.map(p => {
                        const pr = PROCESSES.find(pr => pr.id === p);
                        return pr ? `${p}.${pr.name}` : `${p}`;
                    }).join(', ')}`);
                    return;
                }
                
                if (confirm(`âš ï¸ ë°ì´í„° ì‚­ì œ\n\n${colId}ì˜ ${dateStr}ì— ì™„ë£Œëœ ${processNum}.${processName} ê³µì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì¼ì¼ì…ë ¥ì—ì„œë„ ê°•ì œ ì‚­ì œë©ë‹ˆë‹¤.`)) {
                    // í•´ë‹¹ ê³µì • ì‚­ì œ
                    if (dailyData[dateStr] && dailyData[dateStr][processNum]) {
                        dailyData[dateStr][processNum] = dailyData[dateStr][processNum].filter(col => {
                            if (typeof col === 'number' && col === columnNum) return false;
                            if (typeof col === 'string') {
                                if (col === colId) return false;
                                if (col === String(columnNum)) return false;
                                const colNum = parseInt(col.replace('C', ''));
                                if (!isNaN(colNum) && colNum === columnNum) return false;
                            }
                            return true;
                        });
                        
                        if (dailyData[dateStr][processNum].length === 0) {
                            delete dailyData[dateStr][processNum];
                        }
                        
                        if (dailyData[dateStr] && Object.keys(dailyData[dateStr]).length === 0) {
                            delete dailyData[dateStr];
                        }
                    }
                    
                    // columnData ìƒíƒœ ì—…ë°ì´íŠ¸
                    const remainingProcesses = [];
                    for (let date in dailyData) {
                        if (date !== dateStr) {
                            for (let p = 1; p <= 6; p++) {
                                const dayData = dailyData[date]?.[p];
                                if (dayData && (dayData.includes(columnNum) || dayData.includes(colId) || dayData.includes(String(columnNum)))) {
                                    remainingProcesses.push(p);
                                }
                            }
                        }
                    }
                    
                    if (columnData[colId]) {
                        if (remainingProcesses.length > 0) {
                            columnData[colId].status = Math.max(...remainingProcesses);
                            // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ë‚ ì§œ ì°¾ê¸°
                            let lastUpdate = '';
                            for (let date in dailyData) {
                                for (let p = 1; p <= 6; p++) {
                                    const dayData = dailyData[date]?.[p];
                                    if (dayData && (dayData.includes(columnNum) || dayData.includes(colId) || dayData.includes(String(columnNum)))) {
                                        if (!lastUpdate || date > lastUpdate) {
                                            lastUpdate = date;
                                        }
                                    }
                                }
                            }
                            columnData[colId].lastUpdate = lastUpdate;
                        } else {
                            columnData[colId].status = 0;
                            columnData[colId].lastUpdate = '';
                        }
                    }
                    
                    // ì €ì¥ ë° í™”ë©´ ì—…ë°ì´íŠ¸
                    saveToStorage();
                    renderGanttChart();
                    renderColumnGrid('column-grid-overview');
                    renderColumnGrid('column-grid-input');
                    updateProgressBars();
                    
                    const workDateInput = document.getElementById('work-date');
                    if (workDateInput && workDateInput.value === dateStr) {
                        loadDayData();
                        if (typeof checkDuplicateForDate === 'function') {
                            checkDuplicateForDate(dateStr);
                        }
                    }
                    
                    alert(`âœ… ${colId}ì˜ ${dateStr} ${processName} ê³µì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.\n\nì¼ì¼ì…ë ¥ì—ì„œë„ ë°˜ë“œì‹œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                }
            }
        }

        // Open Column Modal
        function openColumnModal(columnId) {
            // ğŸ”’ [ê°€ë“œ] ê¶Œí•œ ì²´í¬: ViewerëŠ” ëª¨ë‹¬ ì—´ê¸° ë¶ˆê°€
            if (userRole === 'viewer') {
                alert('âš ï¸ ê¶Œí•œ ì—†ìŒ\n\nViewerëŠ” ê¸°ë‘¥ ì •ë³´ë¥¼ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì½ê¸° ì „ìš©)');
                return;
            }
            
            // ğŸ”’ [ê°€ë“œ] ê¶Œí•œ ì²´í¬: EditorëŠ” í—ˆìš©ëœ ê³µì •ë§Œ ëª¨ë‹¬ ì—´ê¸° ê°€ëŠ¥
            if (userRole === 'editor' && currentProcess) {
                if (!canEditProcess(currentProcess)) {
                    const proc = PROCESSES.find(p => p.id === currentProcess);
                    const procName = proc ? proc.name : `ê³µì • ${currentProcess}`;
                    alert(`âš ï¸ ê¶Œí•œ ì—†ìŒ\n\nEditorëŠ” ${procName}ì—ì„œ ê¸°ë‘¥ ì •ë³´ë¥¼ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\ní—ˆìš©ëœ ê³µì •: ${allowedProcesses.map(p => {
                        const pr = PROCESSES.find(pr => pr.id === p);
                        return pr ? `${p}.${pr.name}` : `${p}`;
                    }).join(', ')}\n\në³´ê¸°ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
                    return;
                }
            }
            
            // í˜„ì¥ë°°ì†¡(process 5)ì€ ìš´ì†¡ì°¨ìˆ˜ê³„íšì—ì„œ ê´€ë¦¬ë˜ë¯€ë¡œ ëª¨ë‹¬ ì—´ê¸° ë¹„í™œì„±í™”
            if (currentProcess === 5 && !editMode) {
                alert('í˜„ì¥ë°°ì†¡ì€ ìš´ì†¡ì°¨ìˆ˜ê³„íšì—ì„œ ì´ë¯¸ ì„¤ì •ë˜ì—ˆìœ¼ë¯€ë¡œ ë³„ë„ ì…ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.\n\nìš´ì†¡ì°¨ìˆ˜ê³„íš íƒ­ì—ì„œ ë°°ì†¡ ì¼ì •ì„ í™•ì¸í•˜ì„¸ìš”.');
                return;
            }
            
            // íœ´ë¬´ì¼ ì²´í¬ (ìˆ˜ì • ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ)
            if (!editMode) {
                const workDate = document.getElementById('work-date').value;
                if (isHoliday(workDate)) {
                    alert(`${getHolidayName(workDate)}\n\ní•´ë‹¹ì¼ì€ íœ´ë¬´ë¡œ ì‘ì—… ì…ë ¥ì´ ë¶ˆê°€í•©ë‹ˆë‹¤.`);
                    return;
                }
            }
            
            const currentStatus = columnData[columnId]?.status || 0;
            
            selectedColumn = columnId;
            document.getElementById('modal-column-num').textContent = columnId;
            
            // ìˆ˜ì • ëª¨ë“œì¼ ë•ŒëŠ” ê³µì • ì„ íƒ ê°€ëŠ¥ (EditorëŠ” í—ˆìš©ëœ ê³µì •ë§Œ)
            if (editMode) {
                const processNames = ['ë¯¸ì°©ìˆ˜', 'ì£¼ê¸°ë‘¥ì»¤íŒ…', 'ê¸°ë‘¥ì†Œë¶€ì¬ì»¤íŒ…', 'ì£¼ê¸°ë‘¥ì¡°ë¦½', 'ì†Œë¶€ì¬ì¡°ë¦½', 'í˜„ì¥ë°°ì†¡', 'í˜„ì¥ì„¤ì¹˜'];
                let optionsHtml = '';
                for (let i = 0; i <= 6; i++) {
                    const selected = (i === currentStatus) ? 'selected' : '';
                    // Editorì˜ ê²½ìš° í—ˆìš©ëœ ê³µì •ë§Œ ì„ íƒ ê°€ëŠ¥
                    let disabled = '';
                    if (userRole === 'editor' && i > 0 && !allowedProcesses.includes(i)) {
                        disabled = 'disabled';
                    }
                    optionsHtml += `<option value="${i}" ${selected} ${disabled}>${i}. ${processNames[i]}${disabled ? ' (ê¶Œí•œ ì—†ìŒ)' : ''}</option>`;
                }
                document.getElementById('modal-process-select').innerHTML = optionsHtml;
                document.getElementById('modal-process-select').value = currentStatus;
            } else {
                // ì¼ë°˜ ëª¨ë“œ: í˜„ì¬ ì„ íƒëœ ê³µì •ë§Œ í‘œì‹œ
                if (!currentProcess) {
                    alert('ë¨¼ì € ì…ë ¥í•  ê³µì •ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                // ì„ íƒí•œ ê³µì •ì´ í˜„ì¬ ê¸°ë‘¥ì— ì ìš© ê°€ëŠ¥í•œì§€ í™•ì¸
                if (currentProcess > 1 && currentStatus < currentProcess - 1) {
                    // í˜„ì¥ì„¤ì¹˜(process 6)ì˜ ê²½ìš° í˜„ì¥ë°°ì†¡(process 5)ì—ì„œ í™•ì¸ëœ ê¸°ë‘¥ë§Œ ê°€ëŠ¥
                    if (currentProcess === 6) {
                        // dailyData[date][5]ì— í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸ (í™•ì¸ì„ ë°›ì€ ê¸°ë‘¥ë§Œ í¬í•¨ë¨)
                        const workDate = document.getElementById('work-date')?.value;
                        let hasConfirmedDelivery = false;
                        
                        if (workDate && dailyData[workDate] && dailyData[workDate][5]) {
                            // dailyData[date][5]ì— í•´ë‹¹ ê¸°ë‘¥ì´ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
                            const colNum = typeof columnId === 'string' ? parseInt(columnId.replace('C', '')) : columnId;
                            if (dailyData[workDate][5].includes(columnId) || 
                                dailyData[workDate][5].includes(colNum) || 
                                dailyData[workDate][5].includes(String(colNum))) {
                                hasConfirmedDelivery = true;
                            }
                        }
                        
                        // ëª¨ë“  ë‚ ì§œì˜ dailyData[date][5]ë¥¼ í™•ì¸ (ë‹¤ë¥¸ ë‚ ì§œì— ë°°ì†¡ ê³„íšì´ ìˆì„ ìˆ˜ ìˆìŒ)
                        if (!hasConfirmedDelivery) {
                            for (let date in dailyData) {
                                if (dailyData[date] && dailyData[date][5]) {
                                    const colNum = typeof columnId === 'string' ? parseInt(columnId.replace('C', '')) : columnId;
                                    if (dailyData[date][5].includes(columnId) || 
                                        dailyData[date][5].includes(colNum) || 
                                        dailyData[date][5].includes(String(colNum))) {
                                        hasConfirmedDelivery = true;
                                        break;
                                    }
                                }
                            }
                        }
                        
                        // statusê°€ 5 ì´ìƒì´ê±°ë‚˜ dailyData[date][5]ì— í¬í•¨ë˜ì–´ ìˆì–´ì•¼ í•¨
                        if (!hasConfirmedDelivery && (columnData[columnId]?.status || 0) < 5) {
                            alert('í˜„ì¥ì„¤ì¹˜ë¥¼ ì…ë ¥í•˜ë ¤ë©´ í˜„ì¥ë°°ì†¡(5ë‹¨ê³„)ì—ì„œ í™•ì¸ëœ ê¸°ë‘¥ì´ì–´ì•¼ í•©ë‹ˆë‹¤.\n\nìš´ì†¡ì°¨ìˆ˜ê³„íš íƒ­ì—ì„œ í•´ë‹¹ ê¸°ë‘¥ì˜ ë°°ì†¡ ì¼ì •ì„ ì„¤ì •í•˜ê³  "ğŸ’¾ ìš´ì†¡ì°¨ìˆ˜ê³„íš ì €ì¥" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ í™•ì¸í•´ì£¼ì„¸ìš”.');
                            return;
                        }
                    } else {
                        alert(`ì´ì „ ê³µì •(${currentProcess - 1}ë‹¨ê³„)ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.`);
                        return;
                    }
                }
                
                // ì´ë¯¸ í•´ë‹¹ ê³µì • ì´ìƒì´ ì™„ë£Œëœ ê²½ìš°
                if (currentStatus >= currentProcess) {
                    alert(`ì´ ê¸°ë‘¥ì€ ì´ë¯¸ ${currentProcess}ë‹¨ê³„ ì´ìƒ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    return;
                }
                
                const processNames = ['ë¯¸ì°©ìˆ˜', 'ì£¼ê¸°ë‘¥ì»¤íŒ…', 'ê¸°ë‘¥ì†Œë¶€ì¬ì»¤íŒ…', 'ì£¼ê¸°ë‘¥ì¡°ë¦½', 'ì†Œë¶€ì¬ì¡°ë¦½', 'í˜„ì¥ë°°ì†¡', 'í˜„ì¥ì„¤ì¹˜'];
                document.getElementById('modal-process-select').innerHTML = `
                    <option value="${currentProcess}">${currentProcess}. ${processNames[currentProcess]} ì™„ë£Œ</option>
                `;
                document.getElementById('modal-process-select').value = currentProcess;
            }
            
            // ë¹„ê³  í•„ë“œì— ê¸°ì¡´ ë‚´ìš© í‘œì‹œ
            const existingNote = columnData[columnId]?.note || '';
            document.getElementById('modal-note').value = existingNote;
            
            // ë‚ ì§œ í•„ë“œì— ê¸°ì¡´ ë‚ ì§œ í‘œì‹œ (ì—†ìœ¼ë©´ í˜„ì¬ ì‘ì—…ì¼ì)
            const existingDate = columnData[columnId]?.lastUpdate || workDate || '';
            const modalDateInput = document.getElementById('modal-work-date');
            const modalDateGroup = document.getElementById('modal-date-group');
            
            // ë‚ ì§œ í•„ë“œ ê°•ì œ í‘œì‹œ
            if (modalDateGroup) {
                modalDateGroup.style.display = 'block';
                modalDateGroup.style.visibility = 'visible';
                modalDateGroup.style.marginBottom = '15px';
            }
            
            if (modalDateInput) {
                modalDateInput.value = existingDate || workDate || '';
                // ëª…ì‹œì ìœ¼ë¡œ í‘œì‹œ
                modalDateInput.style.display = 'block';
                modalDateInput.style.visibility = 'visible';
                modalDateInput.style.width = '100%';
                modalDateInput.style.padding = '10px';
                modalDateInput.style.border = '2px solid #ddd';
                modalDateInput.style.borderRadius = '8px';
                modalDateInput.style.fontSize = '14px';
            }
            
            document.getElementById('column-modal').classList.add('active');
        }

        // Close Modal
        function closeModal() {
            document.getElementById('column-modal').classList.remove('active');
            selectedColumn = null;
        }

        // Save Column Status
        function saveColumnStatus() {
            // ì—­í•  í™•ì¸: ViewerëŠ” ì €ì¥ ë¶ˆê°€
            if (userRole === 'viewer') {
                alert('âš ï¸ ê¶Œí•œ ì—†ìŒ\n\nViewerëŠ” ë°ì´í„°ë¥¼ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\nEditor ì´ìƒì˜ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }
            
            // Adminì€ ëª¨ë“  ê³µì •ì—ì„œ ì…ë ¥ ê°€ëŠ¥
            // Editorì˜ ê²½ìš° í—ˆìš©ëœ ê³µì •ë§Œ ì €ì¥ ê°€ëŠ¥
            const selectedStatus = parseInt(document.getElementById('modal-process-select').value);
            const newStatus = editMode ? selectedStatus : (currentProcess || selectedStatus);
            
            // ğŸ”’ [ê°€ë“œ] ê¶Œí•œ ì²´í¬: EditorëŠ” í—ˆìš©ëœ ê³µì •ë§Œ ì €ì¥ ê°€ëŠ¥
            if (userRole === 'editor' && newStatus > 0) {
                if (!canEditProcess(newStatus)) {
                    const proc = PROCESSES.find(p => p.id === newStatus);
                    const procName = proc ? proc.name : `ê³µì • ${newStatus}`;
                    alert(`âš ï¸ ê¶Œí•œ ì—†ìŒ\n\nEditorëŠ” ${procName}ì„ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\ní—ˆìš©ëœ ê³µì •: ${allowedProcesses.map(p => {
                        const pr = PROCESSES.find(pr => pr.id === p);
                        return pr ? `${p}.${pr.name}` : `${p}`;
                    }).join(', ')}`);
                    return;
                }
            }
            if (!selectedColumn) {
                alert('ê¸°ë‘¥ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ëª¨ë‹¬ì—ì„œ ë‚ ì§œ ê°€ì ¸ì˜¤ê¸° (ë‚ ì§œ ìˆ˜ì • ê°€ëŠ¥)
            let workDate = document.getElementById('modal-work-date')?.value;
            if (!workDate) {
                // ëª¨ë‹¬ ë‚ ì§œê°€ ì—†ìœ¼ë©´ í˜„ì¬ ì‘ì—…ì¼ì ì‚¬ìš©
                workDate = document.getElementById('work-date')?.value;
                if (!workDate) {
                    const today = new Date();
                    workDate = today.toISOString().split('T')[0];
                }
            }
            
            // selectedStatusì™€ newStatusëŠ” ìœ„ì—ì„œ ì´ë¯¸ ì„ ì–¸ë˜ì—ˆìœ¼ë¯€ë¡œ ì¬ì‚¬ìš©
            
            if (newStatus === undefined || newStatus === null) {
                alert('ê³µì • ìƒíƒœë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ê¸°ì¡´ ë‚ ì§œì™€ ê³µì • ìƒíƒœ í™•ì¸ (ë‚ ì§œ ë³€ê²½ ì‹œ ê¸°ì¡´ ë°ì´í„° ì œê±°ìš©)
            const oldDate = columnData[selectedColumn]?.lastUpdate || '';
            const oldStatus = columnData[selectedColumn]?.status || 0;
            
            // í˜„ì¥ì„¤ì¹˜(process 6) ì…ë ¥ ì‹œ í˜„ì¥ë°°ì†¡(process 5)ì—ì„œ í™•ì¸ëœ ê¸°ë‘¥ë§Œ ê°€ëŠ¥
            if (newStatus === 6) {
                const currentStatus = columnData[selectedColumn]?.status || 0;
                
                // dailyData[date][5]ì— í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸ (í™•ì¸ì„ ë°›ì€ ê¸°ë‘¥ë§Œ í¬í•¨ë¨)
                let hasConfirmedDelivery = false;
                
                // í˜„ì¬ ì‘ì—…ì¼ìì˜ dailyData[date][5] í™•ì¸
                if (workDate && dailyData[workDate] && dailyData[workDate][5]) {
                    const colNum = typeof selectedColumn === 'string' ? parseInt(selectedColumn.replace('C', '')) : selectedColumn;
                    if (dailyData[workDate][5].includes(selectedColumn) || 
                        dailyData[workDate][5].includes(colNum) || 
                        dailyData[workDate][5].includes(String(colNum))) {
                        hasConfirmedDelivery = true;
                    }
                }
                
                // ëª¨ë“  ë‚ ì§œì˜ dailyData[date][5]ë¥¼ í™•ì¸ (ë‹¤ë¥¸ ë‚ ì§œì— ë°°ì†¡ ê³„íšì´ ìˆì„ ìˆ˜ ìˆìŒ)
                if (!hasConfirmedDelivery) {
                    for (let date in dailyData) {
                        if (dailyData[date] && dailyData[date][5]) {
                            const colNum = typeof selectedColumn === 'string' ? parseInt(selectedColumn.replace('C', '')) : selectedColumn;
                            if (dailyData[date][5].includes(selectedColumn) || 
                                dailyData[date][5].includes(colNum) || 
                                dailyData[date][5].includes(String(colNum))) {
                                hasConfirmedDelivery = true;
                                break;
                            }
                        }
                    }
                }
                
                // statusê°€ 5 ë¯¸ë§Œì´ê³  dailyData[date][5]ì—ë„ ì—†ìœ¼ë©´ ì˜¤ë¥˜
                if (currentStatus < 5 && !hasConfirmedDelivery) {
                    alert('í˜„ì¥ì„¤ì¹˜ë¥¼ ì…ë ¥í•˜ë ¤ë©´ í˜„ì¥ë°°ì†¡(5ë‹¨ê³„)ì—ì„œ í™•ì¸ëœ ê¸°ë‘¥ì´ì–´ì•¼ í•©ë‹ˆë‹¤.\n\nìš´ì†¡ì°¨ìˆ˜ê³„íš íƒ­ì—ì„œ í•´ë‹¹ ê¸°ë‘¥ì˜ ë°°ì†¡ ì¼ì •ì„ ì„¤ì •í•˜ê³  "ğŸ’¾ ìš´ì†¡ì°¨ìˆ˜ê³„íš ì €ì¥" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ í™•ì¸í•´ì£¼ì„¸ìš”.');
                    return;
                }
            }
            
            const note = document.getElementById('modal-note').value;
            
            // ê¸°ì¡´ ë‚ ì§œì˜ ë°ì´í„° ì œê±° (ë‚ ì§œê°€ ë³€ê²½ëœ ê²½ìš°)
            if (oldDate && oldDate !== workDate && oldStatus > 0) {
                // ê¸°ì¡´ ë‚ ì§œì˜ í•´ë‹¹ ê³µì •ì—ì„œ ê¸°ë‘¥ ì œê±°
                if (dailyData[oldDate] && dailyData[oldDate][oldStatus]) {
                    dailyData[oldDate][oldStatus] = dailyData[oldDate][oldStatus].filter(
                        col => col !== selectedColumn && 
                        col !== parseInt(selectedColumn.replace('C', '')) && 
                        col !== selectedColumn.replace('C', '')
                    );
                    // ë¹ˆ ë°°ì—´ì´ë©´ ì œê±°
                    if (dailyData[oldDate][oldStatus].length === 0) {
                        delete dailyData[oldDate][oldStatus];
                    }
                    // ë‚ ì§œì— ë‹¤ë¥¸ ê³µì • ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë‚ ì§œ ìì²´ ì œê±°
                    if (Object.keys(dailyData[oldDate]).length === 0) {
                        delete dailyData[oldDate];
                    }
                }
            } else if (oldDate === workDate && oldStatus > 0 && oldStatus !== newStatus) {
                // ê°™ì€ ë‚ ì§œì´ì§€ë§Œ ê³µì •ì´ ë³€ê²½ëœ ê²½ìš° ê¸°ì¡´ ê³µì •ì—ì„œ ì œê±°
                if (dailyData[oldDate] && dailyData[oldDate][oldStatus]) {
                    dailyData[oldDate][oldStatus] = dailyData[oldDate][oldStatus].filter(
                        col => col !== selectedColumn && 
                        col !== parseInt(selectedColumn.replace('C', '')) && 
                        col !== selectedColumn.replace('C', '')
                    );
                    if (dailyData[oldDate][oldStatus].length === 0) {
                        delete dailyData[oldDate][oldStatus];
                    }
                }
            }
            
            // Save data
            if (!columnData[selectedColumn]) {
                columnData[selectedColumn] = {};
            }
            columnData[selectedColumn].status = newStatus;
            columnData[selectedColumn].note = note;
            columnData[selectedColumn].lastUpdate = workDate;
            columnData[selectedColumn].updatedBy = PROCESSES.find(p => p.id === newStatus)?.company;
            
            // Track daily progress (ìƒˆ ë‚ ì§œì— ì¶”ê°€)
            if (!dailyData[workDate]) {
                dailyData[workDate] = {};
            }
            if (!dailyData[workDate][newStatus]) {
                dailyData[workDate][newStatus] = [];
            }
            // ê¸°ì¡´ í•­ëª© ì œê±° í›„ ìƒˆë¡œ ì¶”ê°€ (ì¤‘ë³µ ë°©ì§€)
            dailyData[workDate][newStatus] = dailyData[workDate][newStatus].filter(
                col => col !== selectedColumn && 
                col !== parseInt(selectedColumn.replace('C', '')) && 
                col !== selectedColumn.replace('C', '')
            );
            dailyData[workDate][newStatus].push(selectedColumn);
            
            // ì¤‘ë³µ ì…ë ¥ í™•ì¸: ê°™ì€ ë‚ ì§œì— ê°™ì€ ê¸°ë‘¥ì— ì—¬ëŸ¬ ê³µì •ì´ ìˆëŠ”ì§€ í™•ì¸
            const duplicateProcesses = [];
            for (let p = 1; p <= 6; p++) {
                if (p !== newStatus && dailyData[workDate][p] && 
                    (dailyData[workDate][p].includes(selectedColumn) || dailyData[workDate][p].includes(parseInt(selectedColumn)))) {
                    duplicateProcesses.push(p);
                }
            }
            
            // ì¤‘ë³µì´ ìˆìœ¼ë©´ ê²½ê³  í‘œì‹œ
            if (duplicateProcesses.length > 0) {
                const processNames = ['', 'ì£¼ê¸°ë‘¥ì»¤íŒ…', 'ì†Œë¶€ì¬ì»¤íŒ…', 'ì£¼ê¸°ë‘¥ì¡°ë¦½', 'ì†Œë¶€ì¬ì¡°ë¦½', 'í˜„ì¥ë°°ì†¡', 'í˜„ì¥ì„¤ì¹˜'];
                const duplicateNames = duplicateProcesses.map(p => `${p}.${processNames[p]}`).join(', ');
                showConnectionStatus(`âš ï¸ ì¤‘ë³µì…ë ¥ ê²½ê³ : ${selectedColumn}ëŠ” ${workDate}ì— ${duplicateNames}ì™€ í•¨ê»˜ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                
                // ì¼ì¼ì…ë ¥ì°½ì— ì¤‘ë³µ ê²½ê³  í‘œì‹œ
                const duplicateWarning = document.getElementById('duplicate-warning');
                const duplicateWarningContent = document.getElementById('duplicate-warning-content');
                if (duplicateWarning && duplicateWarningContent) {
                    duplicateWarning.style.display = 'block';
                    duplicateWarningContent.innerHTML = `âš ï¸ <strong>ì¤‘ë³µì…ë ¥</strong>: ${selectedColumn}ëŠ” ${workDate}ì— ${duplicateNames}ì™€ í•¨ê»˜ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                }
            } else {
                // ì¤‘ë³µì´ ì—†ìœ¼ë©´ ê²½ê³  ìˆ¨ê¸°ê¸°
                const duplicateWarning = document.getElementById('duplicate-warning');
                if (duplicateWarning) {
                    duplicateWarning.style.display = 'none';
                }
            }
            
            // ì‘ì—…ì¼ì ë³€ê²½ ì‹œ ì¤‘ë³µ í™•ì¸
            checkDuplicateForDate(workDate);
            
            // ì‘ì—…ì¼ì ë³€ê²½ ì‹œ ì¤‘ë³µ í™•ì¸
            checkDuplicateForDate(workDate);
            
            // Save to storage immediately
            try {
                saveToStorage();
            } catch (error) {
                console.error('ì €ì¥ ì˜¤ë¥˜:', error);
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                return;
            }
            
            // Close modal
            closeModal();
            
            // Update UI immediately - ì „ì²´ í˜„í™© í¬í•¨
            renderColumnGrid('column-grid-input');
            renderColumnGrid('column-grid-overview');
            updateProgressBars();
            
            // ì „ì²´ í˜„í™© íŒ¨ë„ì´ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ê°•ì œë¡œ ìƒˆë¡œê³ ì¹¨
            const overviewPanel = document.getElementById('panel-overview');
            if (overviewPanel && overviewPanel.classList.contains('active')) {
                // ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ê³  ë‹¤ì‹œ ë Œë”ë§í•˜ì—¬ í™•ì‹¤íˆ ì—…ë°ì´íŠ¸
                setTimeout(() => {
                    renderColumnGrid('column-grid-overview');
                    updateProgressBars();
                }, 100);
            }
            
            // Gantt ì°¨íŠ¸ íŒ¨ë„ì´ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸
            const ganttPanel = document.getElementById('panel-gantt');
            if (ganttPanel && ganttPanel.classList.contains('active')) {
                // ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ê³  ì—…ë°ì´íŠ¸í•˜ì—¬ ë°ì´í„°ê°€ ì™„ì „íˆ ì €ì¥ëœ í›„ ë Œë”ë§
                setTimeout(() => {
                    renderGanttChart();
                }, 100);
            }
            
            // ë””ë²„ê¹…: ì €ì¥ëœ ë°ì´í„° í™•ì¸
            console.log('ì €ì¥ëœ dailyData:', JSON.stringify(dailyData, null, 2));
            console.log('ì €ì¥ëœ columnData:', JSON.stringify(columnData, null, 2));
            
            // Show success message with date
            const processNames = ['ë¯¸ì°©ìˆ˜', 'ì£¼ê¸°ë‘¥ì»¤íŒ…', 'ê¸°ë‘¥ì†Œë¶€ì¬ì»¤íŒ…', 'ì£¼ê¸°ë‘¥ì¡°ë¦½', 'ì†Œë¶€ì¬ì¡°ë¦½', 'í˜„ì¥ë°°ì†¡', 'í˜„ì¥ì„¤ì¹˜'];
            const dateParts = workDate.split('-');
            const dateDisplay = dateParts.length === 3 ? `${dateParts[1]}/${dateParts[2]}` : workDate;
            
            // ì €ì¥ ì™„ë£Œ ë©”ì‹œì§€ í‘œì‹œ
            alert('ì €ì¥í•˜ì˜€ìŠµë‹ˆë‹¤.');
            showConnectionStatus(`âœ… ${selectedColumn} - ${processNames[newStatus]} ì™„ë£Œ! (${dateDisplay})`);
        }

        // Update Progress Bars (ì§„í–‰ë¥ : ì£¼ê¸°ë‘¥ì»¤íŒ…Â·ì†Œë¶€ì¬ì»¤íŒ…Â·ì£¼ê¸°ë‘¥ì¡°ë¦½Â·ì†Œë¶€ì¬ì¡°ë¦½Â·í˜„ì¥ë°°ì†¡Â·í˜„ì¥ì„¤ì¹˜ í¬í•¨)
        // dailyData ê¸°ì¤€ ì§‘ê³„, ê³µì •í‘œì™€ ë™ì¼í•˜ê²Œ ì„œë¸Œ 100ê°œ ê¸°ì¤€(47% = 47/100)
        function updateProgressBars() {
            const totalItems = TOTAL_PROGRESS_ITEMS; // ì „ì²´ ê¸°ë‘¥ìˆ˜ 100ê°œ (100ê°œ ì™„ë£Œ = 100%)
            const progressProcesses = [1, 2, 3, 4, 5, 6]; // ì†Œë¶€ì¬ì¡°ë¦½(4) í¬í•¨
            for (const p of progressProcesses) {
                const completedSet = new Set(); // í•´ë‹¹ ê³µì • p ì´ìƒ ì™„ë£Œí•œ ì„œë¸Œ ì‹ë³„ì(ê³µì •í‘œì™€ ë™ì¼)
                for (let date in dailyData) {
                    if (!dailyData[date]) continue;
                    for (let q = p; q <= 6; q++) {
                        const arr = dailyData[date][q];
                        if (!arr || !Array.isArray(arr)) continue;
                        arr.forEach(col => {
                            if (typeof col === 'number') {
                                completedSet.add(getColumnId(col, 1));
                                completedSet.add(getColumnId(col, 2));
                            } else {
                                completedSet.add(String(col));
                            }
                        });
                    }
                }
                const count = completedSet.size;
                const percent = totalItems > 0 ? Math.round((count / totalItems) * 100) : 0;
                const el = document.getElementById(`progress-p${p}`);
                const elText = document.getElementById(`progress-p${p}-text`);
                if (el) el.style.width = percent + '%';
                if (el) el.textContent = percent + '%';
                if (elText) elText.textContent = `${count} / ${totalItems}`;
            }
            // ì†Œë¶€ì¬ì¡°ë¦½(process 4) ì¹´ë“œ í‘œì‹œ
            const p4Card = document.getElementById('progress-p4')?.closest('.progress-card');
            if (p4Card) p4Card.style.display = '';
        }

        // Render Gantt Chart
        // íœ´ë¬´ì¼ ì²´í¬ í—¬í¼ í•¨ìˆ˜
        function isHoliday(dateStr) {
            return HOLIDAYS.hasOwnProperty(dateStr);
        }
        
        function getHolidayName(dateStr) {
            return HOLIDAYS[dateStr] || '';
        }

        function renderGanttChart() {
            const table = document.getElementById('gantt-table');
            
            // ì¡°ì •ê³µì •í‘œ í‘œì‹œ ì¤‘ì´ë©´ adjustedTransportPlan ì‚¬ìš©, ì•„ë‹ˆë©´ transportPlan ì‚¬ìš©
            let currentTransportPlan = transportPlan;
            if (isShowingAdjustedPlan && adjustedTransportPlan && Object.keys(adjustedTransportPlan).length > 0) {
                // ì¡°ì •ê³µì •í‘œ: adjustedTransportPlan ì‚¬ìš© (13ì°¨ê¹Œì§€)
                currentTransportPlan = {};
                for (let tripNum in adjustedTransportPlan) {
                    const tripNumInt = parseInt(tripNum);
                    if (tripNumInt <= 13) {
                        currentTransportPlan[tripNum] = JSON.parse(JSON.stringify(adjustedTransportPlan[tripNum]));
                    }
                }
            } else {
                // ì›ê³µì •í‘œ: transportPlan ì‚¬ìš©
            if (!transportPlan || Object.keys(transportPlan).length === 0) {
                loadTransportPlan();
                    currentTransportPlan = transportPlan;
                }
            }
            
            // ë””ë²„ê¹…: currentTransportPlanê³¼ dailyData í™•ì¸
            console.log('ê³µì •í‘œ ë Œë”ë§ ì‹œì‘');
            console.log('isShowingAdjustedPlan:', isShowingAdjustedPlan);
            console.log('í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ transportPlan ì°¨ìˆ˜ ëª©ë¡:', Object.keys(currentTransportPlan).map(k => parseInt(k)).sort((a, b) => a - b));
            console.log('í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ transportPlan:', currentTransportPlan);
            console.log('dailyData:', dailyData);
            let process5Count = 0;
            for (let date in dailyData) {
                if (dailyData[date] && dailyData[date][5]) {
                    process5Count += dailyData[date][5].length;
                    console.log(`ë‚ ì§œ ${date}: process 5ì— ${dailyData[date][5].length}ê°œ ê¸°ë‘¥`, dailyData[date][5]);
                }
            }
            console.log(`ì´ process 5 ê¸°ë‘¥ ìˆ˜: ${process5Count}`);
            
            // Generate date range
            const dates = [];
            let currentDate = new Date(START_DATE);
            while (currentDate <= END_DATE) {
                dates.push(new Date(currentDate));
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // Build header
            let headerHtml = '<thead><tr><th class="col-header">ê¸°ë‘¥ë²ˆí˜¸</th>';
            dates.forEach(date => {
                const dayOfWeek = date.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                const dateStrFull = date.toISOString().split('T')[0];
                const isHolidayDate = isHoliday(dateStrFull);
                const dateStr = `${date.getMonth()+1}/${date.getDate()}`;
                
                let headerClass = 'date-header';
                if (isHolidayDate) {
                    headerClass += ' holiday-header';
                } else if (isWeekend) {
                    headerClass += ' weekend';
                }
                
                headerHtml += `<th class="${headerClass}" title="${isHolidayDate ? getHolidayName(dateStrFull) : ''}">${dateStr}</th>`;
            });
            headerHtml += '</tr></thead>';
            
            // Build body
            let bodyHtml = '<tbody>';
            // 50ê°œ ê¸°ë‘¥ Ã— 2ê°œ ì„œë¸Œ í•­ëª© = ì´ 100ê°œ
            for (let c = 1; c <= TOTAL_COLUMNS; c++) {
                for (let sub = 1; sub <= SUB_ITEMS_PER_COLUMN; sub++) {
                    const colId = getColumnId(c, sub);
                    bodyHtml += `<tr><td class="col-name">${colId}</td>`;
                
                dates.forEach(date => {
                    const dateStr = date.toISOString().split('T')[0];
                    const dayOfWeek = date.getDay();
                    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                    const isHolidayDate = isHoliday(dateStr);
                    
                    // íœ´ë¬´ì¼ì¸ ê²½ìš°
                    if (isHolidayDate) {
                        bodyHtml += `<td class="holiday" title="${getHolidayName(dateStr)}">`;
                            if (c === 1 && sub === 1) {
                            // ì²« ë²ˆì§¸ í–‰ì—ë§Œ íœ´ë¬´ ë¼ë²¨ í‘œì‹œ
                        }
                        bodyHtml += '</td>';
                    } else {
                        // Find which process was completed on this date for this column
                        let cellClass = '';
                        
                        // dailyDataì—ì„œ ì™„ë£Œëœ ê³µì • í™•ì¸
                        const completedProcesses = [];
                        for (let p = 1; p <= 6; p++) {
                            const dayData = dailyData[dateStr]?.[p];
                            if (dayData && Array.isArray(dayData)) {
                                // colId í˜•ì‹ìœ¼ë¡œ ì •í™•íˆ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸ (1C001, 7TC001 ë“±)
                                const found = dayData.some(d => {
                                    const dStr = String(d).trim();
                                    // ì •í™•í•œ colId í˜•ì‹ ë¹„êµ
                                    if (dStr === colId) {
                                        return true;
                                    }
                                    // ë ˆê±°ì‹œ í˜•ì‹ ì§€ì›
                                    if (dStr === String(c) || dStr === `${c}C` || dStr === `${c}TC`) {
                                        return true;
                                    }
                                    // ë¶€ë¶„ ë§¤ì¹­: colIdì—ì„œ ìˆ«ì ë¶€ë¶„ ì¶”ì¶œí•˜ì—¬ ë¹„êµ
                                    const colIdMatch = colId.match(/^(\d+)(?:TC|C)(\d+)$/i);
                                    const dStrMatch = dStr.match(/^(\d+)(?:TC|C)(\d+)$/i);
                                    if (colIdMatch && dStrMatch) {
                                        // ë©”ì¸ ê¸°ë‘¥ ë²ˆí˜¸ì™€ ì„œë¸Œ ì¸ë±ìŠ¤ ëª¨ë‘ ì¼ì¹˜í•´ì•¼ í•¨
                                        return colIdMatch[1] === dStrMatch[1] && colIdMatch[2] === dStrMatch[2];
                                    }
                                    return false;
                                });
                                if (found) {
                                    completedProcesses.push(p);
                                    if (p === 5 && c <= 5 && sub === 1) { // ì²˜ìŒ 5ê°œ ê¸°ë‘¥ë§Œ ë¡œê·¸
                                        console.log(`ê¸°ë‘¥ ${colId}ê°€ ë‚ ì§œ ${dateStr}ì— process 5ë¡œ ë°œê²¬ë¨`);
                                    }
                                }
                            }
                        }
                        
                        // ì¤‘ë³µ í™•ì¸: ê°™ì€ ë‚ ì§œì— ì—¬ëŸ¬ ê³µì •ì´ ì™„ë£Œëœ ê²½ìš°
                        // ë‹¨, ì£¼ê¸°ë‘¥ì»¤íŒ…(1)ê³¼ ì†Œë¶€ì¬ì»¤íŒ…(2)ì€ ì¤‘ë³µ í—ˆìš©
                        let isAllowedDuplicate = false;
                        let hasP1P2Both = false; // ì£¼ê¸°ë‘¥ì»¤íŒ…(1)ê³¼ ì†Œë¶€ì¬ì»¤íŒ…(2)ì´ ëª¨ë‘ ìˆëŠ”ì§€
                        
                        // ì£¼ê¸°ë‘¥ì»¤íŒ…(1)ê³¼ ì†Œë¶€ì¬ì»¤íŒ…(2)ì´ ëª¨ë‘ ìˆëŠ”ì§€ í™•ì¸
                        const hasP1 = completedProcesses.includes(1);
                        const hasP2 = completedProcesses.includes(2);
                        if (hasP1 && hasP2) {
                            isAllowedDuplicate = true;
                            hasP1P2Both = true;
                        }
                        
                        // ì£¼ê¸°ë‘¥ì»¤íŒ…(1)ê³¼ ì†Œë¶€ì¬ì»¤íŒ…(2)ì´ ëª¨ë‘ ìˆëŠ” ê²½ìš°ë¥¼ ë¨¼ì € ì²˜ë¦¬
                        if (hasP1P2Both) {
                            // ì£¼ê¸°ë‘¥ì»¤íŒ…(1)ê³¼ ì†Œë¶€ì¬ì»¤íŒ…(2)ì´ ëª¨ë‘ ìˆëŠ” ê²½ìš° íŠ¹ë³„ ì²˜ë¦¬
                            // cellClassëŠ” ë‚˜ì¤‘ì— ë‘ ê°œì˜ divë¡œ ë Œë”ë§í•˜ë¯€ë¡œ 'both'ë¡œ ì„¤ì •
                            cellClass = 'gantt-cell both';
                        } else if (completedProcesses.length > 1 && !isAllowedDuplicate) {
                            cellClass = 'gantt-cell duplicate';
                        } else if (completedProcesses.length === 1) {
                            const processNum = completedProcesses[0];
                            if (processNum === 5) {
                                // í˜„ì¥ë°°ì†¡(process 5): ì‹¤ì œ ë°°ì†¡ ë‚ ì§œì¸ì§€ í™•ì¸
                                if (actualDeliveryDate[colId] && actualDeliveryDate[colId] === dateStr) {
                                    cellClass = 'gantt-cell p5 confirmed'; // ì§™ì€ ë§ˆì  íƒ€ - ì‹¤ì œ ë°°ì†¡ì¼
                                } else {
                                    cellClass = 'gantt-cell p5'; // ì§„í•œ ë§ˆì  íƒ€ - ìš´ì†¡ê³„íšì¼
                                }
                            } else if (processNum === 6) {
                                // 6. í˜„ì¥ì„¤ì¹˜(process 6): dailyDataì— ì €ì¥ëœ ë‚ ì§œì— í‘œì‹œ
                                cellClass = 'gantt-cell p6';
                            } else {
                                cellClass = `gantt-cell p${processNum}`;
                            }
                        }
                        
                        // ì‹¤ì œ ë°°ì†¡ ë‚ ì§œê°€ ìˆëŠ” ê²½ìš° í•´ë‹¹ ë‚ ì§œì— ì§™ì€ ë§ˆì  íƒ€ë¡œ í‘œì‹œ
                        if (!cellClass && actualDeliveryDate[colId] && actualDeliveryDate[colId] === dateStr) {
                            cellClass = 'gantt-cell p5 confirmed'; // ì§™ì€ ë§ˆì  íƒ€ - ì‹¤ì œ ë°°ì†¡ì¼
                        }
                        
                        // ìš´ì†¡ì°¨ìˆ˜ì¼ì •ì´ ìˆëŠ” ê²½ìš° í˜„ì¥ë°°ì†¡(p5)ìœ¼ë¡œ ë§ˆí¬ (ì‹¤ì œ ë°°ì†¡ì¼ì´ ì•„ë‹Œ ê²½ìš°ë§Œ)
                        // dailyDataì— ê¸°ë¡ì´ ì—†ê³  ì‹¤ì œ ë°°ì†¡ì¼ë„ ì•„ë‹ ë•Œë§Œ ìš´ì†¡ê³„íš í™•ì¸
                        let tripNumber = null; // ì°¨ìˆ˜ë²ˆí˜¸ ì €ì¥ ë³€ìˆ˜
                        if (!cellClass) {
                            // currentTransportPlanì—ì„œ í•´ë‹¹ ê¸°ë‘¥ì˜ ìš´ì†¡ë‚ ì§œ í™•ì¸ (12ì°¨ê¹Œì§€ë§Œ)
                            if (currentTransportPlan && typeof currentTransportPlan === 'object' && Object.keys(currentTransportPlan).length > 0) {
                                for (let tripNum in currentTransportPlan) {
                                    const tripNumInt = parseInt(tripNum);
                                    // 14ì°¨ ì´ìƒì€ ì œì™¸
                                    if (tripNumInt > 13) {
                                        continue;
                                    }
                                    const tripData = currentTransportPlan[tripNum];
                                    if (tripData && typeof tripData === 'object') {
                                        const columns = tripData.columns;
                                        let date = tripData.date;
                                        
                                        // ë‚ ì§œ í˜•ì‹ ì •ê·œí™” (YYYY-MM-DD)
                                        if (date && typeof date === 'string') {
                                            date = date.trim();
                                            // ë‚ ì§œ í˜•ì‹ ë³€í™˜ ì‹œë„
                                            const dateObj = new Date(date);
                                            if (!isNaN(dateObj.getTime())) {
                                                const year = dateObj.getFullYear();
                                                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                                                const day = String(dateObj.getDate()).padStart(2, '0');
                                                date = `${year}-${month}-${day}`;
                                            }
                                        }
                                        
                                        // ê¸°ë‘¥ì´ í•´ë‹¹ ì°¨ìˆ˜ì— í¬í•¨ë˜ì–´ ìˆê³ , ë‚ ì§œê°€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
                                        if (columns && Array.isArray(columns) && date && date === dateStr) {
                                            // columns ë°°ì—´ì— colIdê°€ ì •í™•íˆ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸ (1C001, 7TC001 í˜•ì‹)
                                            const columnIndex = columns.findIndex(col => {
                                                const colStr = String(col).trim();
                                                // ì •í™•í•œ colId í˜•ì‹ ë¹„êµ (1C001, 7TC001 ë“±)
                                                if (colStr === colId) {
                                                    return true;
                                                }
                                                // ìˆ«ì í˜•ì‹ì¸ ê²½ìš° (ë ˆê±°ì‹œ ì§€ì›)
                                                if (typeof col === 'number') {
                                                    return col === c;
                                                }
                                                // ë¶€ë¶„ ë§¤ì¹­: colIdì—ì„œ ìˆ«ì ë¶€ë¶„ ì¶”ì¶œí•˜ì—¬ ë¹„êµ
                                                const colIdMatch = colId.match(/^(\d+)(?:TC|C)(\d+)$/i);
                                                const colStrMatch = colStr.match(/^(\d+)(?:TC|C)(\d+)$/i);
                                                if (colIdMatch && colStrMatch) {
                                                    // ë©”ì¸ ê¸°ë‘¥ ë²ˆí˜¸ì™€ ì„œë¸Œ ì¸ë±ìŠ¤ ëª¨ë‘ ì¼ì¹˜í•´ì•¼ í•¨
                                                    return colIdMatch[1] === colStrMatch[1] && colIdMatch[2] === colStrMatch[2];
                                                }
                                                // ë ˆê±°ì‹œ í˜•ì‹ ì§€ì› (1C, 7TC ë“±)
                                                const colNum = parseInt(colStr.replace(/[^0-9]/g, ''));
                                                return colNum === c || colStr === `${c}C` || colStr === `${c}TC`;
                                            });
                                            if (columnIndex !== -1) {
                                                // ì‹¤ì œ ë°°ì†¡ ë‚ ì§œê°€ ì•„ë‹ˆë©´ ì˜…ì€ ë§ˆì  íƒ€ë¡œ í‘œì‹œ (ìš´ì†¡ê³„íšì¼)
                                                cellClass = 'gantt-cell p5'; // ì˜…ì€ ë§ˆì  íƒ€ - ìš´ì†¡ê³„íšì¼
                                                tripNumber = tripNum; // ì°¨ìˆ˜ë²ˆí˜¸ ì €ì¥
                                                if (c <= 5 && sub === 1) { // ì²˜ìŒ 5ê°œ ê¸°ë‘¥ë§Œ ë¡œê·¸
                                                    console.log(`ê¸°ë‘¥ ${colId}ê°€ transportPlanì—ì„œ ë‚ ì§œ ${dateStr}ì— ë°œê²¬ë¨, ì°¨ìˆ˜: ${tripNum}`);
                                                }
                                                break;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        
                        // dailyDataì— process 5ê°€ ìˆëŠ” ê²½ìš°ì—ë„ ì°¨ìˆ˜ë²ˆí˜¸ í™•ì¸
                        if (cellClass && cellClass.includes('p5') && !tripNumber) {
                            // dailyDataì—ì„œ process 5ê°€ ìˆëŠ” ê²½ìš° transportPlanì—ì„œ ì°¨ìˆ˜ë²ˆí˜¸ ì°¾ê¸°
                            const dayData = dailyData[dateStr]?.[5];
                            if (dayData && Array.isArray(dayData)) {
                                // colId í˜•ì‹ìœ¼ë¡œ ì •í™•íˆ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
                                const isInDailyData = dayData.some(d => {
                                    const dStr = String(d).trim();
                                    // ì •í™•í•œ colId í˜•ì‹ ë¹„êµ
                                    if (dStr === colId) {
                                        return true;
                                    }
                                    // ë ˆê±°ì‹œ í˜•ì‹ ì§€ì›
                                    if (dStr === String(c) || dStr === `${c}C` || dStr === `${c}TC`) {
                                        return true;
                                    }
                                    // ë¶€ë¶„ ë§¤ì¹­: colIdì—ì„œ ìˆ«ì ë¶€ë¶„ ì¶”ì¶œí•˜ì—¬ ë¹„êµ
                                    const colIdMatch = colId.match(/^(\d+)(?:TC|C)(\d+)$/i);
                                    const dStrMatch = dStr.match(/^(\d+)(?:TC|C)(\d+)$/i);
                                    if (colIdMatch && dStrMatch) {
                                        // ë©”ì¸ ê¸°ë‘¥ ë²ˆí˜¸ì™€ ì„œë¸Œ ì¸ë±ìŠ¤ ëª¨ë‘ ì¼ì¹˜í•´ì•¼ í•¨
                                        return colIdMatch[1] === dStrMatch[1] && colIdMatch[2] === dStrMatch[2];
                                    }
                                    return false;
                                });
                                
                                if (isInDailyData && currentTransportPlan && typeof currentTransportPlan === 'object' && Object.keys(currentTransportPlan).length > 0) {
                                    for (let tripNum in currentTransportPlan) {
                                        const tripNumInt = parseInt(tripNum);
                                        // 14ì°¨ ì´ìƒì€ ì œì™¸
                                        if (tripNumInt > 13) {
                                            continue;
                                        }
                                        
                                        const tripData = currentTransportPlan[tripNum];
                                        if (tripData && typeof tripData === 'object') {
                                            const columns = tripData.columns;
                                            let date = tripData.date;
                                            
                                            // ë‚ ì§œ í˜•ì‹ ì •ê·œí™” (YYYY-MM-DD)
                                            if (date && typeof date === 'string') {
                                                date = date.trim();
                                                // ë‚ ì§œ í˜•ì‹ ë³€í™˜ ì‹œë„
                                                const dateObj = new Date(date);
                                                if (!isNaN(dateObj.getTime())) {
                                                    const year = dateObj.getFullYear();
                                                    const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                                                    const day = String(dateObj.getDate()).padStart(2, '0');
                                                    date = `${year}-${month}-${day}`;
                                                }
                                            }
                                            
                                            // ë‚ ì§œê°€ ì¼ì¹˜í•˜ê³  ê¸°ë‘¥ì´ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
                                            if (date && date === dateStr && columns && Array.isArray(columns)) {
                                                const columnIndex = columns.findIndex(col => {
                                                    const colStr = String(col).trim();
                                                    // ì •í™•í•œ colId í˜•ì‹ ë¹„êµ (1C001, 7TC001 ë“±)
                                                    if (colStr === colId) {
                                                        return true;
                                                    }
                                                    // ìˆ«ì í˜•ì‹ì¸ ê²½ìš° (ë ˆê±°ì‹œ ì§€ì›)
                                                    if (typeof col === 'number') {
                                                        return col === c;
                                                    }
                                                    // ë¶€ë¶„ ë§¤ì¹­: colIdì—ì„œ ìˆ«ì ë¶€ë¶„ ì¶”ì¶œí•˜ì—¬ ë¹„êµ
                                                    const colIdMatch = colId.match(/^(\d+)(?:TC|C)(\d+)$/i);
                                                    const colStrMatch = colStr.match(/^(\d+)(?:TC|C)(\d+)$/i);
                                                    if (colIdMatch && colStrMatch) {
                                                        // ë©”ì¸ ê¸°ë‘¥ ë²ˆí˜¸ì™€ ì„œë¸Œ ì¸ë±ìŠ¤ ëª¨ë‘ ì¼ì¹˜í•´ì•¼ í•¨
                                                        return colIdMatch[1] === colStrMatch[1] && colIdMatch[2] === colStrMatch[2];
                                                    }
                                                    // ë ˆê±°ì‹œ í˜•ì‹ ì§€ì› (1C, 7TC ë“±)
                                                    const colNum = parseInt(colStr.replace(/[^0-9]/g, ''));
                                                    return colNum === c || colStr === `${c}C` || colStr === `${c}TC`;
                                                });
                                                if (columnIndex !== -1) {
                                                    tripNumber = tripNum;
                                                    if (c <= 5 && sub === 1) { // ì²˜ìŒ 5ê°œ ê¸°ë‘¥ë§Œ ë¡œê·¸
                                                        console.log(`ê¸°ë‘¥ ${colId}ê°€ dailyDataì—ì„œ ë‚ ì§œ ${dateStr}ì— ë°œê²¬ë¨, transportPlanì—ì„œ ì°¨ìˆ˜ ${tripNum} ì°¾ìŒ`);
                                                    }
                                                    break;
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        
                        // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
                        const currentProcessNum = cellClass ? cellClass.match(/p(\d)/)?.[1] || '0' : '0';
                        let clickHandler = '';
                        let cursorStyle = '';
                        let hoverStyle = '';
                        
                        if (deleteMode) {
                            // ì‚­ì œ ëª¨ë“œ: ì‚­ì œ í•¸ë“¤ëŸ¬
                            clickHandler = `onclick="handleGanttCellDelete('${colId}', '${dateStr}')"`;
                            cursorStyle = 'cursor:pointer;';
                            hoverStyle = 'transition:background-color 0.2s;';
                        } else if (cellClass && cellClass !== 'gantt-cell duplicate') {
                            // ì¼ë°˜ ëª¨ë“œ: ê³µì • ì…€ í´ë¦­ ì‹œ í•´ë‹¹ ê³µì •ìœ¼ë¡œ ì´ë™
                            if (cellClass === 'gantt-cell both') {
                                // both ì…€ì€ ê° divì— ê°œë³„ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
                                cursorStyle = 'cursor:pointer;';
                            } else {
                                // ë‹¨ì¼ ê³µì • ì…€: í•´ë‹¹ ê³µì •ìœ¼ë¡œ ì´ë™
                                const processNum = parseInt(currentProcessNum);
                                if (processNum >= 1 && processNum <= 6) {
                                    clickHandler = `onclick="onCurrentProcessReady(${processNum}); selectPreocess(${processNum}); showPanel('input', null);"`;
                                    cursorStyle = 'cursor:pointer;';
                                    hoverStyle = 'transition:opacity 0.2s;';
                                }
                            }
                        }
                        
                        bodyHtml += `<td class="${isWeekend ? 'weekend' : ''}" ${clickHandler} style="${cursorStyle}${hoverStyle}" onmouseover="${deleteMode ? 'this.style.backgroundColor=\'#ffebee\'' : (cellClass && cellClass !== 'gantt-cell duplicate' ? 'this.style.opacity=\'0.8\'' : '')}" onmouseout="${deleteMode ? 'this.style.backgroundColor=\'\'' : (cellClass && cellClass !== 'gantt-cell duplicate' ? 'this.style.opacity=\'1\'' : '')}">`;
                        if (cellClass) {
                            // ì£¼ê¸°ë‘¥ì»¤íŒ…(1)ê³¼ ì†Œë¶€ì¬ì»¤íŒ…(2)ì´ ëª¨ë‘ ìˆëŠ” ê²½ìš° ë‘ ê°œì˜ divë¡œ ë¶„í•  í‘œì‹œ
                            if (cellClass === 'gantt-cell both') {
                                bodyHtml += `<div style="display:flex;width:100%;height:20px;border-radius:0;">`;
                                bodyHtml += `<div class="gantt-cell p1" data-process="1" style="flex:1;height:20px;min-width:0;cursor:pointer;" onclick="onCurrentProcessReady(1); selectPreocess(1); showPanel('input', null);" onmouseover="this.style.opacity='0.8';" onmouseout="this.style.opacity='1';"></div>`;
                                bodyHtml += `<div class="gantt-cell p2" data-process="2" style="flex:1;height:20px;min-width:0;cursor:pointer;" onclick="onCurrentProcessReady(2); selectPreocess(2); showPanel('input', null);" onmouseover="this.style.opacity='0.8';" onmouseout="this.style.opacity='1';"></div>`;
                                bodyHtml += `</div>`;
                            } else {
                                // process 5 (í˜„ì¥ë°°ì†¡)ì¸ ê²½ìš° ì°¨ìˆ˜ë²ˆí˜¸ ë˜ëŠ” "O" í‘œì‹œ
                                const isP5 = cellClass.includes('p5');
                                const isActualDelivery = cellClass === 'gantt-cell p5 confirmed';
                                
                                // ì¡°ì •ê³µì •í‘œ í‘œì‹œ ì¤‘ì´ê³  ì°¨ìˆ˜ë²ˆí˜¸ê°€ ì—†ìœ¼ë©´ ì…€ì„ í‘œì‹œí•˜ì§€ ì•ŠìŒ
                                if (isP5 && isShowingAdjustedPlan && !isActualDelivery && !tripNumber) {
                                    // ì°¨ìˆ˜ë²ˆí˜¸ê°€ ì—†ëŠ” ë¹ˆ ì…€ì€ í‘œì‹œí•˜ì§€ ì•ŠìŒ
                                    cellClass = null;
                                } else if (isP5 && isShowingAdjustedPlan && !isActualDelivery) {
                                    // ì¡°ì •ëœ ê³µì •í‘œ í‘œì‹œ ì¤‘ì´ê³  ì°¨ìˆ˜ë²ˆí˜¸ê°€ ìˆìœ¼ë©´ p5ì— adjusted í´ë˜ìŠ¤ ì¶”ê°€
                                    cellClass = cellClass.replace('p5', 'p5 adjusted');
                                }
                                
                                let cellText = '';
                                let cellStyle = '';
                                
                                if (isP5 && cellClass) {
                                    if (isActualDelivery) {
                                        // ì‹¤ì œ ë°°ì†¡ ë‚ ì§œì¸ ê²½ìš° "O" í‘œì‹œ
                                        cellText = 'O';
                                        cellStyle = 'display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:bold;color:#fff;';
                                    } else if (tripNumber) {
                                        // ìš´ì†¡ê³„íšì¼ì¸ ê²½ìš° ì°¨ìˆ˜ë²ˆí˜¸ í‘œì‹œ
                                        cellText = tripNumber;
                                        cellStyle = 'display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:bold;color:#000;';
                                    }
                                }
                                
                                // cellClassê°€ nullì´ë©´ ì…€ì„ ë Œë”ë§í•˜ì§€ ì•ŠìŒ
                                if (cellClass) {
                                // ê³µì • ë²ˆí˜¸ ì¶”ì¶œ (p1, p2, p3, p4, p5, p6)
                                let processNo = null;
                                if (cellClass.includes('p1')) processNo = 1;
                                else if (cellClass.includes('p2')) processNo = 2;
                                else if (cellClass.includes('p3')) processNo = 3;
                                else if (cellClass.includes('p4')) processNo = 4;
                                else if (cellClass.includes('p5')) processNo = 5;
                                else if (cellClass.includes('p6')) processNo = 6;
                                
                                const dataProcessAttr = processNo ? `data-process="${processNo}"` : '';
                                bodyHtml += `<div class="${cellClass}" ${dataProcessAttr} style="${cellStyle}">${cellText}</div>`;
                                }
                            }
                        }
                        bodyHtml += '</td>';
                    }
                });
                
                bodyHtml += '</tr>';
                } // ì„œë¸Œ í•­ëª© ë£¨í”„ ë‹«ê¸°
            } // ê¸°ë‘¥ ë£¨í”„ ë‹«ê¸°
            bodyHtml += '</tbody>';
            
            // Build footer with dates (same as header)
            let footerHtml = '<tfoot><tr><th class="col-header">ê¸°ë‘¥ë²ˆí˜¸</th>';
            dates.forEach(date => {
                const dayOfWeek = date.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                const dateStrFull = date.toISOString().split('T')[0];
                const isHolidayDate = isHoliday(dateStrFull);
                const dateStr = `${date.getMonth()+1}/${date.getDate()}`;
                
                let footerClass = 'date-header';
                if (isHolidayDate) {
                    footerClass += ' holiday-header';
                } else if (isWeekend) {
                    footerClass += ' weekend';
                }
                
                footerHtml += `<th class="${footerClass}" title="${isHolidayDate ? getHolidayName(dateStrFull) : ''}">${dateStr}</th>`;
            });
            footerHtml += '</tr></tfoot>';
            
            table.innerHTML = headerHtml + bodyHtml + footerHtml;
            
            // ê°„íŠ¸ ì°¨íŠ¸ ë Œë”ë§ í›„ ê³µì •ë³„ ê¶Œí•œ ì ìš©
            applyProcessPermissionToGantt();
        }

        // Render Charts
        function renderCharts() {
            renderProgressChart();
            renderCompanyChart();
        }

        function renderProgressChart() {
            const ctx = document.getElementById('progressChart').getContext('2d');
            
            // Generate date labels and data
            const dates = [];
            const datasets = [];
            const processNames = { 1: 'ì£¼ê¸°ë‘¥ì»¤íŒ…', 2: 'ì†Œë¶€ì¬ì»¤íŒ…', 3: 'ì£¼ê¸°ë‘¥ì¡°ë¦½', 4: 'ì†Œë¶€ì¬ì¡°ë¦½', 5: 'í˜„ì¥ë°°ì†¡', 6: 'í˜„ì¥ì„¤ì¹˜' };
            const progressProcesses = [1, 2, 3, 4, 5, 6]; // ì†Œë¶€ì¬ì¡°ë¦½(4) í¬í•¨
            const colors = ['#e74c3c', '#ff9800', '#2196f3', '#00bcd4', '#9c27b0', '#4caf50'];
            
            let currentDate = new Date(START_DATE);
            while (currentDate <= new Date()) {
                dates.push(currentDate.toISOString().split('T')[0]);
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // ì¼ë³„ ë°°ì—´ì˜ ìœ íš¨ ê°œìˆ˜: ìˆ«ì(ì—´ë²ˆí˜¸)ëŠ” 1ì—´=2ì„œë¸Œì´ë¯€ë¡œ 2ë¡œ ê³„ì‚°
            function effectiveDailyCount(arr) {
                if (!arr || !Array.isArray(arr)) return 0;
                return arr.reduce((sum, col) => sum + (typeof col === 'number' ? 2 : 1), 0);
            }
            // Calculate cumulative data for each process (ì†Œë¶€ì¬ì¡°ë¦½ í¬í•¨, 100ê°œ=100%)
            for (let i = 0; i < progressProcesses.length; i++) {
                const p = progressProcesses[i];
                const data = [];
                let cumulative = 0;
                
                dates.forEach(dateStr => {
                    if (dailyData[dateStr]?.[p]) {
                        cumulative += effectiveDailyCount(dailyData[dateStr][p]);
                    }
                    data.push(cumulative);
                });
                
                datasets.push({
                    label: processNames[p],
                    data: data,
                    borderColor: colors[i],
                    backgroundColor: colors[i] + '20',
                    fill: true,
                    tension: 0.3
                });
            }
            
            if (progressChart) progressChart.destroy();
            
            progressChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates.map(d => d.substring(5)),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: TOTAL_PROGRESS_ITEMS, // ì „ì²´ ê¸°ë‘¥ìˆ˜ 100ê°œ
                            title: {
                                display: true,
                                text: 'ì™„ë£Œ ê¸°ë‘¥ ìˆ˜'
                            }
                        }
                    }
                }
            });
        }

        // ì¡°ì •ê³µì •í‘œë¡œ ë®ì–´ì“°ê¸° í•¨ìˆ˜
        function overwriteWithAdjustedPlan() {
            // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
            if (userRole !== 'admin') {
                alert('âš ï¸ ê¶Œí•œ ì—†ìŒ\n\nì¡°ì •ê³µì •í‘œë¡œ ë®ì–´ì“°ê¸°ëŠ” ê´€ë¦¬ìë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\nê´€ë¦¬ìì—ê²Œ ë¬¸ì˜ë°”ëë‹ˆë‹¤.');
                return;
            }
            
            // 1ë‹¨ê³„: ì¡°ì •ê³µì •í‘œ í‘œì‹œ ì¤‘ì¸ì§€ í™•ì¸ (isShowingAdjustedPlan === true)
            if (!isShowingAdjustedPlan) {
                alert('âš ï¸ ì¡°ì •ê³µì •í‘œëŠ” ìš´ì†¡ë¬¼ëŸ‰ì‚°ì •ì—ì„œ ì°¨ìˆ˜ì¡°ì •ì´ ì™„ë£Œëœ ìƒíƒœì—ì„œ ì‘ë™ë©ë‹ˆë‹¤.\n\nì¡°ì •ê³µì •í‘œì‘ì—…ì„ ì™„ë£Œí•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.');
                return;
            }
            
            // 2ë‹¨ê³„: ì¡°ì •ê³µì •í‘œê°€ ìˆê³  ì—‘ì…€ì´ ë°›ì•„ë“¤ì—¬ì§„ ìƒíƒœì¸ì§€ í™•ì¸
            if (!adjustedTransportPlan || Object.keys(adjustedTransportPlan).length === 0) {
                alert('âš ï¸ ì¡°ì •ê³µì •í‘œëŠ” ìš´ì†¡ë¬¼ëŸ‰ì‚°ì •ì—ì„œ ì°¨ìˆ˜ì¡°ì •ì´ ì™„ë£Œëœ ìƒíƒœì—ì„œ ì‘ë™ë©ë‹ˆë‹¤.\n\nì¡°ì •ê³µì •í‘œì‘ì—…ì„ ì™„ë£Œí•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.');
                return;
            }
            
            // 3ë‹¨ê³„: í™•ì¸ ë©”ì‹œì§€
            const message = 'ì¡°ì •ê³µì •í‘œë¡œ ë®ì–´ì“°ê¸° í•˜ì‹œë©´ ì´í›„ ëª¨ë“  ê³µì •í‘œëŠ” ì¡°ì •ê³µì •í‘œë¡œë§Œ í‘œì‹œë©ë‹ˆë‹¤.\n\nì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
            if (!confirm(message)) {
                return;
            }
            
            try {
                // 1ë‹¨ê³„: ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš(13ì°¨ê¹Œì§€)ì„ transportPlanìœ¼ë¡œ ì˜êµ¬ ì €ì¥
                const cleanedAdjustedPlan = {};
                for (let tripNum in adjustedTransportPlan) {
                    const tripNumInt = parseInt(tripNum);
                    if (tripNumInt <= 13) {
                        cleanedAdjustedPlan[tripNum] = JSON.parse(JSON.stringify(adjustedTransportPlan[tripNum]));
                    }
                }
                
                transportPlan = cleanedAdjustedPlan;
                
                // localStorageì— ì €ì¥
                localStorage.setItem(kcolKey('transportPlan'), JSON.stringify(transportPlan));
                
                // 2ë‹¨ê³„: originalTransportPlanë„ ì¡°ì •ëœ ê³„íšìœ¼ë¡œ ì—…ë°ì´íŠ¸ (ë°±ì—…ë„ ì—…ë°ì´íŠ¸)
                originalTransportPlan = JSON.parse(JSON.stringify(transportPlan));
                localStorage.setItem(kcolKey('originalTransportPlan'), JSON.stringify(originalTransportPlan));
                
                // 3ë‹¨ê³„: isShowingAdjustedPlanì„ falseë¡œ ì„¤ì • (ì´ì œ transportPlanì´ ì¡°ì •ëœ ê³„íš)
                isShowingAdjustedPlan = false;
                
                // 4ë‹¨ê³„: dailyData ë™ê¸°í™”
                if (typeof syncTransportToDailyData === 'function') {
                    console.log('ì¡°ì •ê³µì •í‘œë¡œ ë®ì–´ì“°ê¸°: dailyData ë™ê¸°í™” ì‹œì‘');
                    syncTransportToDailyData(false);
                    console.log('ì¡°ì •ê³µì •í‘œë¡œ ë®ì–´ì“°ê¸°: dailyData ë™ê¸°í™” ì™„ë£Œ');
                }
                
                // 5ë‹¨ê³„: ê³µì •í‘œ ì—…ë°ì´íŠ¸
                if (typeof renderGanttChart === 'function') {
                    console.log('ì¡°ì •ê³µì •í‘œë¡œ ë®ì–´ì“°ê¸°: ê³µì •í‘œ ë Œë”ë§ ì‹œì‘');
                    renderGanttChart();
                    console.log('ì¡°ì •ê³µì •í‘œë¡œ ë®ì–´ì“°ê¸°: ê³µì •í‘œ ë Œë”ë§ ì™„ë£Œ');
                }
                
                // 6ë‹¨ê³„: ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
                if (typeof updatePlanToggleButtons === 'function') {
                    updatePlanToggleButtons();
                }
                
                // 7ë‹¨ê³„: ìš´ì†¡ì°¨ìˆ˜ê³„íš íŒ¨ë„ ì—…ë°ì´íŠ¸
                if (typeof renderTransportColumnGrid === 'function') {
                    renderTransportColumnGrid();
                }
                if (typeof renderTransportTrips === 'function') {
                    renderTransportTrips();
                }
                
                alert('âœ… ì¡°ì •ê³µì •í‘œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nì›ê³µì •í‘œëŠ” ì‚­ì œë˜ì—ˆê³ , ì¡°ì •ê³µì •í‘œê°€ ê¸°ë³¸ ê³µì •í‘œë¡œ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                console.error('ì¡°ì •ê³µì •í‘œë¡œ ë®ì–´ì“°ê¸° ì˜¤ë¥˜:', error);
                alert('âŒ ì¡°ì •ê³µì •í‘œ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n' + error.message);
            }
        }
        
        // ë¬¸ì˜í•˜ê¸° íŒ¨ë„ í‘œì‹œ í•¨ìˆ˜
        function showInquiryPanel() {
            const inquiryInfo = 'ğŸ“§ ë¬¸ì˜í•˜ê¸°\n\n' +
                'ì´ë©”ì¼: sbd_pmo@naver.com\n' +
                'ì›¹ì‚¬ì´íŠ¸: https://kcol.kr\n\n' +
                'ì¡°ì •ê³µì •í‘œ ê´€ë ¨ ë¬¸ì˜ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ìœ„ ì—°ë½ì²˜ë¡œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.';
            
            alert(inquiryInfo);
        }

        // ê³µì •í‘œ ì—‘ì…€ ì¶œë ¥ í•¨ìˆ˜
        async function exportGanttToExcel() {
            try {
                // XLSX ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸
                let XLSXLib;
                try {
                    XLSXLib = await ensureXLSXLoaded();
                } catch (error) {
                    alert('ì—‘ì…€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    console.error('XLSX ë¡œë“œ ì‹¤íŒ¨:', error);
                    return;
                }

                // ë‚ ì§œ ë²”ìœ„ ìƒì„±
                const dates = [];
                let currentDate = new Date(START_DATE);
                while (currentDate <= END_DATE) {
                    dates.push(new Date(currentDate));
                    currentDate.setDate(currentDate.getDate() + 1);
                }

                // ê³µì •ëª… ë§¤í•‘
                const processNames = {
                    1: 'ì£¼ê¸°ë‘¥ì»¤íŒ…',
                    2: 'ì†Œë¶€ì¬ì»¤íŒ…',
                    3: 'ì£¼ê¸°ë‘¥ì¡°ë¦½',
                    4: 'ì†Œë¶€ì¬ì¡°ë¦½',
                    5: 'í˜„ì¥ë°°ì†¡',
                    6: 'í˜„ì¥ì„¤ì¹˜'
                };

                // ì—‘ì…€ ë°ì´í„° ë°°ì—´ ìƒì„±
                const wsData = [];

                // ìš”ì¼ ë°°ì—´
                const weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];

                // í—¤ë” í–‰ ìƒì„± (ë‚ ì§œì™€ ìš”ì¼)
                const headerRow = ['ê¸°ë‘¥ë²ˆí˜¸', 'ìš´ì†¡ì°¨ìˆ˜'];
                dates.forEach(date => {
                    const dateStr = date.toISOString().split('T')[0];
                    const month = date.getMonth() + 1;
                    const day = date.getDate();
                    const dayOfWeek = date.getDay(); // 0=ì¼ìš”ì¼, 6=í† ìš”ì¼
                    const weekday = weekdays[dayOfWeek];
                    // ë‚ ì§œ í˜•ì‹: "12/26 (ëª©)"
                    const dateDisplay = `${month}/${day} (${weekday})`;
                    headerRow.push(dateDisplay);
                });
                wsData.push(headerRow);
                
                // ë””ë²„ê¹…: ì²« ë²ˆì§¸ ë‚ ì§œ í—¤ë” í™•ì¸
                console.log('ì—‘ì…€ í—¤ë” ì²« ë²ˆì§¸ ë‚ ì§œ:', headerRow[2]);

                // ê° ê¸°ë‘¥ë³„ ë°ì´í„° í–‰ ìƒì„±
                for (let c = 1; c <= TOTAL_COLUMNS; c++) {
                    const colId = c + 'C';
                    
                    // í•´ë‹¹ ê¸°ë‘¥ì´ ì†í•œ ìš´ì†¡ì°¨ìˆ˜ ì°¾ê¸°
                    const tripNumbers = [];
                    if (transportPlan && Object.keys(transportPlan).length > 0) {
                        for (let tripNum in transportPlan) {
                            const tripData = transportPlan[tripNum];
                            if (tripData && tripData.columns && Array.isArray(tripData.columns)) {
                                const found = tripData.columns.some(col => {
                                    const colNum = typeof col === 'number' ? col : parseInt(String(col).replace(/[^0-9]/g, ''));
                                    return colNum === c;
                                });
                                if (found) {
                                    tripNumbers.push(parseInt(tripNum));
                                }
                            }
                        }
                    }
                    // ì°¨ìˆ˜ ë²ˆí˜¸ë¥¼ ì˜¤ë¦„ì°¨ìˆœìœ¼ë¡œ ì •ë ¬
                    tripNumbers.sort((a, b) => a - b);
                    const tripDisplay = tripNumbers.length > 0 ? tripNumbers.map(t => `${t}ì°¨ìˆ˜`).join(', ') : '';
                    
                    const row = [colId, tripDisplay];

                    dates.forEach(date => {
                        const dateStr = date.toISOString().split('T')[0];
                        
                        // í•´ë‹¹ ë‚ ì§œì— ì™„ë£Œëœ ê³µì • ì°¾ê¸°
                        const completedProcesses = [];
                        for (let p = 1; p <= 6; p++) {
                            const dayData = dailyData[dateStr]?.[p];
                            if (dayData && Array.isArray(dayData)) {
                                const found = dayData.includes(c) || dayData.includes(colId) || dayData.includes(String(c));
                                if (found) {
                                    completedProcesses.push(p);
                                }
                            }
                        }

                        // ìš´ì†¡ê³„íš í™•ì¸ (process 5) - ì°¨ìˆ˜ ë²ˆí˜¸ ì°¾ê¸°
                        let tripNumberForDate = null;
                        if (transportPlan && Object.keys(transportPlan).length > 0) {
                            for (let tripNum in transportPlan) {
                                const tripData = transportPlan[tripNum];
                                if (tripData && tripData.columns && tripData.date) {
                                    let tripDate = tripData.date;
                                    if (typeof tripDate === 'string') {
                                        const dateObj = new Date(tripDate);
                                        if (!isNaN(dateObj.getTime())) {
                                            const year = dateObj.getFullYear();
                                            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                                            const day = String(dateObj.getDate()).padStart(2, '0');
                                            tripDate = `${year}-${month}-${day}`;
                                        }
                                    }
                                    
                                    if (tripDate === dateStr) {
                                        const columns = tripData.columns;
                                        const columnIndex = columns.findIndex(col => {
                                            const colNum = typeof col === 'number' ? col : parseInt(String(col).replace(/[^0-9]/g, ''));
                                            return colNum === c;
                                        });
                                        if (columnIndex !== -1) {
                                            tripNumberForDate = parseInt(tripNum);
                                            if (!completedProcesses.includes(5)) {
                                                completedProcesses.push(5);
                                            }
                                        }
                                    }
                                }
                            }
                        }

                        // ê³µì • í‘œì‹œ (ì—¬ëŸ¬ ê³µì •ì´ ìˆìœ¼ë©´ ëª¨ë‘ í‘œì‹œ)
                        if (completedProcesses.length > 0) {
                            // ì£¼ê¸°ë‘¥ì»¤íŒ…(1)ê³¼ ì†Œë¶€ì¬ì»¤íŒ…(2)ì´ ëª¨ë‘ ìˆëŠ” ê²½ìš°
                            if (completedProcesses.includes(1) && completedProcesses.includes(2)) {
                                row.push('1+2');
                            } else {
                                // ê³µì • ë²ˆí˜¸ë¥¼ ì‰¼í‘œë¡œ êµ¬ë¶„í•˜ì—¬ í‘œì‹œ
                                // process 5 (í˜„ì¥ë°°ì†¡)ëŠ” ì°¨ìˆ˜ ë²ˆí˜¸ë¡œ í‘œì‹œ
                                const processText = completedProcesses.map(p => {
                                    if (p === 5 && tripNumberForDate !== null) {
                                        return `${tripNumberForDate}ì°¨ìˆ˜`;
                                    }
                                    return processNames[p] || `P${p}`;
                                }).join(', ');
                                row.push(processText);
                            }
                        } else {
                            row.push('');
                        }
                    });

                    wsData.push(row);
                }

                // ì›Œí¬ì‹œíŠ¸ ìƒì„±
                const ws = XLSXLib.utils.aoa_to_sheet(wsData);

                // ì—´ ë„ˆë¹„ ì„¤ì •
                const colWidths = [{ wch: 12 }, { wch: 15 }]; // ê¸°ë‘¥ë²ˆí˜¸ ì—´, ìš´ì†¡ì°¨ìˆ˜ ì—´
                dates.forEach(() => {
                    colWidths.push({ wch: 15 }); // ë‚ ì§œ ì—´
                });
                ws['!cols'] = colWidths;

                // ì›Œí¬ë¶ ìƒì„±
                const wb = XLSXLib.utils.book_new();
                XLSXLib.utils.book_append_sheet(wb, ws, 'ê³µì •í‘œ');

                // íŒŒì¼ëª… ìƒì„± (í”„ë¡œì íŠ¸ëª…ê³¼ í˜„ì¬ ë‚ ì§œ í¬í•¨)
                const dateStr = new Date().toISOString().split('T')[0].replace(/-/g, '');
                const projectName = PROJECT_NAMES[window.PROJECT_ID] || window.PROJECT_ID;
                const fileName = `ê³µì •í‘œ_${projectName}_${dateStr}.xlsx`;

                // Blob ë°©ì‹ìœ¼ë¡œ ì—‘ì…€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                try {
                    const wbout = XLSXLib.write(wb, { bookType: 'xlsx', type: 'array', cellStyles: false });
                    const blob = new Blob([wbout], { 
                        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                    });
                    
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileName;
                    a.style.display = 'none';
                    document.body.appendChild(a);
                    a.click();
                    
                    setTimeout(() => {
                        try {
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                        } catch (e) {
                            console.warn('ì •ë¦¬ ì¤‘ ì˜¤ë¥˜:', e);
                        }
                    }, 100);

                    alert('ê³µì •í‘œê°€ ì—‘ì…€ íŒŒì¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } catch (error) {
                    console.error('ì—‘ì…€ íŒŒì¼ ìƒì„± ì‹¤íŒ¨:', error);
                    // XLSX.writeFileë¡œ í´ë°± ì‹œë„
                    try {
                        XLSXLib.writeFile(wb, fileName);
                        alert('ê³µì •í‘œê°€ ì—‘ì…€ íŒŒì¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    } catch (fallbackError) {
                        console.error('í´ë°± ì—‘ì…€ ì €ì¥ ì‹¤íŒ¨:', fallbackError);
                        alert('ì—‘ì…€ íŒŒì¼ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                    }
                }
            } catch (error) {
                console.error('ê³µì •í‘œ ì—‘ì…€ ì¶œë ¥ ì˜¤ë¥˜:', error);
                alert('ê³µì •í‘œ ì—‘ì…€ ì¶œë ¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        function renderCompanyChart() {
            const ctx = document.getElementById('companyChart').getContext('2d');
            
            // Calculate company progress from dailyData (ì†Œë¶€ì¬ì¡°ë¦½(4) í¬í•¨)
            const countByProcess = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0 };
            for (let p = 1; p <= 6; p++) {
                const set = new Set();
                for (let date in dailyData) {
                    if (!dailyData[date]) continue;
                    for (let q = p; q <= 6; q++) {
                        const arr = dailyData[date][q];
                        if (!arr || !Array.isArray(arr)) continue;
                        arr.forEach(col => {
                            if (typeof col === 'number') {
                                set.add(getColumnId(col, 1));
                                set.add(getColumnId(col, 2));
                            } else {
                                set.add(String(col));
                            }
                        });
                    }
                }
                countByProcess[p] = set.size;
            }
            const companyProgress = {
                'yuseok': { p1: countByProcess[1], p2: countByProcess[2], p3: countByProcess[3], p4: countByProcess[4], p5: countByProcess[5] },
                'jinhung': { p6: countByProcess[6] }
            };
            
            if (companyChart) companyChart.destroy();
            
            companyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['ìœ ì„ì² ê°•(ì¶©ì£¼)\n(ì»¤íŒ…)', 'ìœ ì„ì² ê°•(ì˜¤ì°½)\n(ì†Œë¶€ì¬)', 'ìœ ì„ì² ê°•(ìŒì„±)\n(ì£¼ê¸°ë‘¥ì¡°ë¦½)', 'ìœ ì„ì² ê°•(ìŒì„±)\n(ì†Œë¶€ì¬ì¡°ë¦½)', 'ìœ ì„ì² ê°•(ìŒì„±)\n(ë°°ì†¡)', 'ì§„í¥ê¸°ì—…\n(ì„¤ì¹˜)'],
                    datasets: [{
                        label: 'ì™„ë£Œ ê¸°ë‘¥ ìˆ˜',
                        data: [
                            companyProgress.yuseok.p1,
                            companyProgress.yuseok.p2,
                            companyProgress.yuseok.p3,
                            companyProgress.yuseok.p4,
                            companyProgress.yuseok.p5,
                            companyProgress.jinhung.p6
                        ],
                        backgroundColor: ['#e74c3c', '#ff9800', '#2196f3', '#00bcd4', '#9c27b0', '#4caf50']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: TOTAL_PROGRESS_ITEMS, // ì „ì²´ ê¸°ë‘¥ìˆ˜ 100ê°œ
                            title: {
                                display: true,
                                text: 'ì™„ë£Œ ê¸°ë‘¥ ìˆ˜'
                            }
                        }
                    }
                }
            });
        }

        // Save/Load Data
        async function saveData() {
            // ì—­í•  í™•ì¸: ViewerëŠ” ì €ì¥ ë¶ˆê°€
            if (userRole === 'viewer') {
                alert('âš ï¸ ê¶Œí•œ ì—†ìŒ\n\nViewerëŠ” ë°ì´í„°ë¥¼ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\nEditor ì´ìƒì˜ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }
            // ëª¨ë“  ê³µì •(1-6)ì—ì„œ ì„ íƒëœ ê¸°ë‘¥ë“¤ì„ í•œ ë²ˆì— ì €ì¥
            if (currentProcess && currentProcess >= 1 && currentProcess <= 6 && selectedColumns.length > 0) {
                saveSelectedColumns();
            } else {
                // í˜„ì¬ ê³µì •í‘œ ë°ì´í„°ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì €ì¥
                console.log('ğŸ’¾ ê³µì •í‘œ ë°ì´í„° ì €ì¥ ì‹œì‘...');
                console.log('ğŸ“Š ì €ì¥í•  ë°ì´í„°:', {
                    columnData: Object.keys(columnData).length + 'ê°œ ê¸°ë‘¥',
                    dailyData: Object.keys(dailyData).length + 'ê°œ ë‚ ì§œ',
                    transportPlan: Object.keys(transportPlan).length + 'ê°œ ì°¨ìˆ˜'
                });
                
                await saveToStorage();
                
                // ì €ì¥ ì™„ë£Œ í™•ì¸
                console.log('âœ… ê³µì •í‘œ ë°ì´í„° ì €ì¥ ì™„ë£Œ');
                showToast('âœ… ê³µì •í‘œ ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìŒì— ê³µì •í‘œë¥¼ ì—´ë©´ ë°ì´í„°ê°€ í‘œì‹œë©ë‹ˆë‹¤.', 'success');
            }
        }

        // âœ… ì“°ê¸° ê¶Œí•œ ì²´í¬ í—¬í¼ í•¨ìˆ˜
        function canWrite() {
            return userRole === 'admin' || userRole === 'editor';
        }
        
        // ===============================
        // ğŸ”’ ì•ˆì „í•œ í”„ë¡œì íŠ¸ ë°ì´í„° ì €ì¥ (ìµœì¢…ë³¸)
        // ===============================
        
        // â‘¡ ë¹ˆ ê°ì²´ í•„ë“œ ì œê±° í—¬í¼
        function omitEmptyObjects(obj) {
            const out = { ...obj };

            const isPlainObject = (v) =>
                v !== null && typeof v === "object" && !Array.isArray(v);

            const isEmptyPlainObject = (v) =>
                isPlainObject(v) && Object.keys(v).length === 0;

            if (!out.columnData || isEmptyPlainObject(out.columnData)) delete out.columnData;
            if (!out.dailyData  || isEmptyPlainObject(out.dailyData))  delete out.dailyData;
            if (!out.transportPlan || isEmptyPlainObject(out.transportPlan)) delete out.transportPlan;

            return out;
        }
        
        // projectRef + ì‹¤ì‹œê°„ êµ¬ë… ì´ˆê¸°í™” (PROJECT_ID í™•ë³´ í›„ 1íšŒ í˜¸ì¶œ)
        function initProjectRealtime(projectId) {
            if (!projectId) throw new Error("projectId missing");

            // projectRef ì„¤ì •
            projectRef = firebaseDb.collection("projects").doc(projectId);

            // ì´ˆê¸° ìƒíƒœ ë¦¬ì…‹
            isInitialLoad = true;
            isApplyingRemoteData = false;

            // ì‹¤ì‹œê°„ ìˆ˜ì‹  (ì§€ìˆ˜ ë°±ì˜¤í”„ ì¬ì‹œë„ í¬í•¨)
            startProjectListener(projectRef, function(docSnapshot) {
                    // ì›ê²© ë°ì´í„° ì ìš© ì‹œì‘
                    isApplyingRemoteData = true;

                    // âœ… ìµœì´ˆ ìŠ¤ëƒ…ìƒ· ìˆ˜ì‹  ì‹œì ë¶€í„° ì €ì¥ í—ˆìš©
                    if (isInitialLoad) {
                        isInitialLoad = false;
                        console.log("âœ… ì´ˆê¸° ë¡œë”© ì™„ë£Œ - ì €ì¥ ê°€ëŠ¥ ìƒíƒœë¡œ ì „í™˜");
                    }

                    // ì‹¤ì‹œê°„ ì—°ê²° í™œì„± ìƒíƒœ í‘œì‹œ (ë°ì´í„° ìˆ˜ì‹  ì‹œë§ˆë‹¤)
                    if (typeof lastRealtimeUpdateTime !== 'undefined') {
                        lastRealtimeUpdateTime = Date.now();
                    }
                    if (typeof updateRealtimeConnectionStatus === 'function') {
                        updateRealtimeConnectionStatus(true);
                    }
                    console.log('ğŸ“¡ Firebase ì‹¤ì‹œê°„ ë°ì´í„° ìˆ˜ì‹ :', projectId, 'exists:', docSnapshot.exists);

                    // ì²« ë°ì´í„° ìˆ˜ì‹  ì‹œ ìƒíƒœ ì²´í¬ ì‹œì‘
                    if (typeof startRealtimeStatusCheck === 'function') {
                        if (typeof realtimeStatusCheckInterval === 'undefined' || !realtimeStatusCheckInterval) {
                            startRealtimeStatusCheck();
                        }
                    }

                    // ì—­í•  í™•ì¸ (í´ë¼ì´ì–¸íŠ¸ ì¸¡ ë³´ì•ˆ)
                    if (typeof userRole === 'undefined' || !userRole) {
                        console.warn('âš ï¸ ì‚¬ìš©ì ì—­í• ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë°ì´í„° ì ‘ê·¼ì„ ì œí•œí•©ë‹ˆë‹¤.');
                        isApplyingRemoteData = false;
                        return;
                    }

                    if (docSnapshot.exists) {
                        const projectData = docSnapshot.data();
                        console.log('ğŸ“¡ Firebase ì‹¤ì‹œê°„ ë°ì´í„° ìˆ˜ì‹ :', projectId);

                        // ============================================================
                        // âš ï¸ ì¤‘ìš”: "ìê¸° ì—…ë°ì´íŠ¸ ìŠ¤í‚µ" ë¡œì§ì€ ë°ì´í„° ë Œë” ìµœì í™”ì—ë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤.
                        // role/UI ê°±ì‹ ì—ëŠ” ì ˆëŒ€ ì ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                        // ============================================================
                        const updatedBy = projectData.updatedBy;
                        const currentUser = (typeof firebaseAuth !== 'undefined' && firebaseAuth) ? firebaseAuth.currentUser : null;

                        if (updatedBy && currentUser && updatedBy === currentUser.uid) {
                            console.log('â„¹ï¸ [ë°ì´í„° ë Œë”] ìì‹ ì´ ì—…ë°ì´íŠ¸í•œ í”„ë¡œì íŠ¸ ë°ì´í„°ì´ë¯€ë¡œ UI ì—…ë°ì´íŠ¸ ê±´ë„ˆëœ€ (ìµœì í™”)');
                            console.log('ğŸ’¡ [role/UI] role/UIëŠ” ë³„ë„ members ë¦¬ìŠ¤ë„ˆì—ì„œ í•­ìƒ ì¬ì ìš©ë©ë‹ˆë‹¤.');
                            isApplyingRemoteData = false;
                            return; // âœ… ë°ì´í„° ë Œë”ë§ë§Œ ìŠ¤í‚µ (role/UIëŠ” ë³„ë„ ì²˜ë¦¬)
                        }

                        // âœ… ì—¬ê¸°ì„œ docSnapshot.data()ë¥¼ UI/stateì— ë°˜ì˜
                        const newColumnData = projectData.columnData || {};
                        const newDailyData = projectData.dailyData || {};
                        const newColumnCoordinates = projectData.columnCoordinates || {};
                        const newDeliveryConfirmed = projectData.deliveryConfirmed || {};
                        const newActualDeliveryDate = projectData.actualDeliveryDate || {};
                        const newTransportPlan = projectData.transportPlan || {};

                        // ë°ì´í„°ê°€ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸ (ì „ì—­ ë³€ìˆ˜ê°€ ì •ì˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸)
                        const currentColumnData = (typeof columnData !== 'undefined') ? columnData : {};
                        const currentDailyData = (typeof dailyData !== 'undefined') ? dailyData : {};
                        const currentColumnCoordinates = (typeof columnCoordinates !== 'undefined') ? columnCoordinates : {};
                        const currentDeliveryConfirmed = (typeof deliveryConfirmed !== 'undefined') ? deliveryConfirmed : {};
                        const currentActualDeliveryDate = (typeof actualDeliveryDate !== 'undefined') ? actualDeliveryDate : {};
                        const currentTransportPlan = (typeof transportPlan !== 'undefined') ? transportPlan : {};
                        
                        const dataChanged = 
                            JSON.stringify(currentColumnData) !== JSON.stringify(newColumnData) ||
                            JSON.stringify(currentDailyData) !== JSON.stringify(newDailyData) ||
                            JSON.stringify(currentColumnCoordinates) !== JSON.stringify(newColumnCoordinates) ||
                            JSON.stringify(currentDeliveryConfirmed) !== JSON.stringify(newDeliveryConfirmed) ||
                            JSON.stringify(currentActualDeliveryDate) !== JSON.stringify(newActualDeliveryDate) ||
                            JSON.stringify(currentTransportPlan) !== JSON.stringify(newTransportPlan);

                        if (dataChanged) {
                            console.log('ğŸ”„ ì‹¤ì‹œê°„ ë°ì´í„° ë³€ê²½ ê°ì§€ - UI ì—…ë°ì´íŠ¸ ì¤‘...');

                            // ë°ì´í„° ì—…ë°ì´íŠ¸ (ì „ì—­ ë³€ìˆ˜ê°€ ì •ì˜ë˜ì–´ ìˆëŠ” ê²½ìš°ì—ë§Œ)
                            if (typeof columnData !== 'undefined') columnData = newColumnData;
                            if (typeof dailyData !== 'undefined') dailyData = newDailyData;
                            if (typeof columnCoordinates !== 'undefined') columnCoordinates = newColumnCoordinates;
                            if (typeof deliveryConfirmed !== 'undefined') deliveryConfirmed = newDeliveryConfirmed;
                            if (typeof actualDeliveryDate !== 'undefined') actualDeliveryDate = newActualDeliveryDate;
                            if (typeof transportPlan !== 'undefined') transportPlan = newTransportPlan;
                            
                            // ì „ì—­ ë³€ìˆ˜ê°€ ì—†ìœ¼ë©´ window ê°ì²´ì— í• ë‹¹
                            if (typeof columnData === 'undefined') window.columnData = newColumnData;
                            if (typeof dailyData === 'undefined') window.dailyData = newDailyData;
                            if (typeof columnCoordinates === 'undefined') window.columnCoordinates = newColumnCoordinates;
                            if (typeof deliveryConfirmed === 'undefined') window.deliveryConfirmed = newDeliveryConfirmed;
                            if (typeof actualDeliveryDate === 'undefined') window.actualDeliveryDate = newActualDeliveryDate;
                            if (typeof transportPlan === 'undefined') window.transportPlan = newTransportPlan;
                            
                            // ì°¸ì¡° ì—…ë°ì´íŠ¸
                            const finalColumnData = (typeof columnData !== 'undefined') ? columnData : window.columnData;
                            const finalDailyData = (typeof dailyData !== 'undefined') ? dailyData : window.dailyData;
                            const finalColumnCoordinates = (typeof columnCoordinates !== 'undefined') ? columnCoordinates : window.columnCoordinates;
                            const finalDeliveryConfirmed = (typeof deliveryConfirmed !== 'undefined') ? deliveryConfirmed : window.deliveryConfirmed;
                            const finalActualDeliveryDate = (typeof actualDeliveryDate !== 'undefined') ? actualDeliveryDate : window.actualDeliveryDate;
                            const finalTransportPlan = (typeof transportPlan !== 'undefined') ? transportPlan : window.transportPlan;

                            // localStorageì—ë„ ë™ê¸°í™” (ë°±ì—…)
                            if (typeof kcolKey === 'function') {
                                localStorage.setItem(kcolKey('steelColumnData'), JSON.stringify(finalColumnData));
                                localStorage.setItem(kcolKey('steelColumnDaily'), JSON.stringify(finalDailyData));
                                localStorage.setItem(kcolKey('columnCoordinates'), JSON.stringify(finalColumnCoordinates));
                                localStorage.setItem(kcolKey('deliveryConfirmed'), JSON.stringify(finalDeliveryConfirmed));
                                localStorage.setItem(kcolKey('actualDeliveryDate'), JSON.stringify(finalActualDeliveryDate));
                                localStorage.setItem(kcolKey('transportPlan'), JSON.stringify(finalTransportPlan));
                            }

                            // UI ì—…ë°ì´íŠ¸
                            if (typeof syncTransportToDailyData === 'function') {
                                syncTransportToDailyData(false);
                            }
                            if (typeof renderColumnGrid === 'function') {
                                renderColumnGrid('column-grid-overview');
                                renderColumnGrid('column-grid-input');
                            }
                            if (typeof renderGanttChart === 'function') {
                                renderGanttChart();
                            }
                            if (typeof updateProgressBars === 'function') {
                                updateProgressBars();
                            }

                            // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì•Œë¦¼
                            if (typeof showToast === 'function') {
                                showToast('ğŸ”„ ì‹¤ì‹œê°„ ë°ì´í„° ì—…ë°ì´íŠ¸ë¨', 'info');
                            }

                            console.log('âœ… ì‹¤ì‹œê°„ ë°ì´í„° ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                        }
                    } else {
                        console.log('â„¹ï¸ Firestore ë¬¸ì„œê°€ ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                    }

                    // ì›ê²© ë°ì´í„° ì ìš© ì¢…ë£Œ
                    isApplyingRemoteData = false;
                }, 'PROJECT');
        }
        
        // â‘¢â‘£(+ë£¨í”„ì°¨ë‹¨) ìµœì¢… ì €ì¥ í•¨ìˆ˜: ë°˜ë“œì‹œ ì´ê²ƒìœ¼ë¡œë§Œ ì €ì¥
        async function saveProjectData(projectData) {
            // projectRef ì¤€ë¹„ ì „ ì €ì¥ ê¸ˆì§€
            if (!projectRef) {
                console.warn("â›” projectRef not ready â†’ save blocked");
                return;
            }

            // â‘  ì²« ìŠ¤ëƒ…ìƒ· ì „ ì €ì¥ ê¸ˆì§€
            if (isInitialLoad) {
                console.warn("â¸ initial load â†’ save blocked");
                return;
            }

            // + ì›ê²© ìŠ¤ëƒ…ìƒ· ë°˜ì˜ ì¤‘ ì €ì¥ ê¸ˆì§€ (ì €ì¥ ë£¨í”„ ì°¨ë‹¨ í•µì‹¬)
            if (isApplyingRemoteData) {
                console.warn("â¸ remote snapshot applying â†’ save blocked");
                return;
            }

            // â‘¡ ë¹ˆ ê°ì²´ ì œê±°
            const safePayload = omitEmptyObjects(projectData);

            // â‘¢ payload ìì²´ê°€ ë¹„ì–´ ìˆìœ¼ë©´ ì €ì¥ ì•ˆ í•¨
            if (Object.keys(safePayload).length === 0) {
                console.warn("â›” empty payload â†’ save skipped");
                return;
            }

            // â‘£ ë®ì–´ì“°ê¸° ë°©ì§€ merge ì €ì¥
            await projectRef.set(safePayload, { merge: true });
        }
        
        // 3ï¸âƒ£ ì•ˆì „ ì €ì¥ í•¨ìˆ˜ (ë¹ˆ ë°ì´í„° ì™„ì „ ì°¨ë‹¨ + merge ì €ì¥)
        async function saveToStorage() {
            // âœ… ì›ê²© ë°ì´í„° ì ìš© ì¤‘ ì €ì¥ ì°¨ë‹¨ (ìµœìš°ì„  ì²´í¬)
            if (isApplyingRemoteData) {
                console.warn("â¸ remote snapshot ì ìš© ì¤‘ â†’ ì €ì¥ ì°¨ë‹¨");
                return;
            }
            
            // 1ï¸âƒ£ ì´ˆê¸° ë¡œë”© ì¤‘ ì €ì¥ ì°¨ë‹¨
            if (isInitialLoad) {
                console.warn("â¸ ì´ˆê¸° ë¡œë”© ì¤‘ ì €ì¥ ì°¨ë‹¨");
                return;
            }
            
            // âœ… [ê°€ë“œ 1] permission-denied í”Œë˜ê·¸ ì²´í¬ (ì¬ì‹œë„ ë°©ì§€)
            if (window.__writeBlocked) {
                console.warn('[WRITE BLOCKED] ì´ì „ permission-denied ì˜¤ë¥˜ë¡œ ì¸í•´ ì“°ê¸°ê°€ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.');
                return;
            }
            
            // âœ… [ê°€ë“œ 2] ê¶Œí•œ ì²´í¬: Admin/Editorë§Œ ì €ì¥ ê°€ëŠ¥
            if (!canWrite()) {
                console.warn('[WRITE BLOCKED] role=', userRole, '- ì €ì¥ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ğŸ”’ [ê°€ë“œ 3] ê¶Œí•œ ì²´í¬: EditorëŠ” í—ˆìš©ëœ ê³µì •ë§Œ ì €ì¥ ê°€ëŠ¥
            if (userRole === 'editor' && currentProcess) {
                if (!canEditProcess(currentProcess)) {
                    console.warn(`âš ï¸ [ê°€ë“œ] EditorëŠ” ê³µì • ${currentProcess}ì„ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                    alert(`âš ï¸ ê¶Œí•œ ì—†ìŒ\n\nEditorëŠ” í˜„ì¬ ê³µì •ì„ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\ní—ˆìš©ëœ ê³µì •: ${allowedProcesses.map(p => {
                        const pr = PROCESSES.find(pr => pr.id === p);
                        return pr ? `${p}.${pr.name}` : `${p}`;
                    }).join(', ')}`);
                    return;
                }
            }
            
            try {
                // í•­ìƒ localStorageì— ë¨¼ì € ì €ì¥ (ë°±ì—…)
                localStorage.setItem(kcolKey('steelColumnData'), JSON.stringify(columnData));
                localStorage.setItem(kcolKey('steelColumnDaily'), JSON.stringify(dailyData));
                localStorage.setItem(kcolKey('columnCoordinates'), JSON.stringify(columnCoordinates));
                localStorage.setItem(kcolKey('deliveryConfirmed'), JSON.stringify(deliveryConfirmed));
                localStorage.setItem(kcolKey('actualDeliveryDate'), JSON.stringify(actualDeliveryDate));
                localStorage.setItem(kcolKey('transportVolumeData'), JSON.stringify(transportVolumeData));
                console.log('âœ… localStorage ì €ì¥ ì™„ë£Œ');
                
                // Firebase Firestoreì—ë„ ì €ì¥ ì‹œë„ (ì¸ì¦ëœ ì‚¬ìš©ìë§Œ, ìµëª… ì‚¬ìš©ì ì°¨ë‹¨)
                if (initFirebase() && firebaseAuth.currentUser) {
                    // ìµëª… ì‚¬ìš©ì ì°¨ë‹¨
                    if (firebaseAuth.currentUser.isAnonymous) {
                        console.warn('âš ï¸ ìµëª… ë¡œê·¸ì¸ ìƒíƒœì—ì„œëŠ” Firebaseì— ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. localStorageì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.');
                        const modeEl = document.getElementById('current-mode');
                        if (modeEl) {
                            modeEl.textContent = 'ğŸ”´ ìµëª… ë¡œê·¸ì¸ (Firebase ì €ì¥ ë¶ˆê°€)';
                            modeEl.style.color = '#f44336';
                        }
                        return; // Firebase ì €ì¥ ê±´ë„ˆë›°ê¸°
                    }
                    
                    try {
                        // âœ… Firestore ì“°ê¸° ì „ ê¶Œí•œ ì¬í™•ì¸ (ì¶”ê°€ ì•ˆì „ì¥ì¹˜)
                        if (userRole === 'viewer') {
                            console.warn('âš ï¸ [ê°€ë“œ] ViewerëŠ” Firestoreì— ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. localStorageì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.');
                            return; // Firestore ì €ì¥ ê±´ë„ˆë›°ê¸°
                        }
                        
                        if (userRole === 'editor' && currentProcess) {
                            if (!canEditProcess(currentProcess)) {
                                console.warn(`âš ï¸ [ê°€ë“œ] EditorëŠ” ê³µì • ${currentProcess}ì„ Firestoreì— ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. localStorageì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.`);
                                return; // Firestore ì €ì¥ ê±´ë„ˆë›°ê¸°
                            }
                        }
                        
                        // âœ… projectRefê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì´ˆê¸°í™”
                        if (!projectRef) {
                            projectRef = firebaseDb.collection('projects').doc(window.PROJECT_ID);
                        }
                        
                        const writePath = `projects/${window.PROJECT_ID}`;
                        
                        // âœ… ì“°ê¸° ê²½ë¡œ ë¡œê·¸ (ê¶Œí•œ ì˜¤ë¥˜ ì§„ë‹¨ìš©)
                        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                        console.log('[WRITE PATH]', writePath);
                        console.log('[ROLE]', userRole, '[UID]', firebaseAuth.currentUser.uid);
                        console.log('[PROJECT_ID]', window.PROJECT_ID);
                        console.log('[CURRENT_PROCESS]', currentProcess);
                        console.log('[ALLOWED_PROCESSES]', allowedProcesses || []);
                        console.log('ğŸ’¡ ì´ ê²½ë¡œì˜ write ê¶Œí•œì´ Firestore Security Rulesì—ì„œ í—ˆìš©ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.');
                        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                        
                        // âœ… ì•ˆì „í•œ ê¸°ë³¸ê°’ìœ¼ë¡œ projectData ìƒì„±
                        const projectData = {
                            columnData: columnData || {},
                            dailyData: dailyData || {},
                            columnCoordinates: columnCoordinates || {},
                            deliveryConfirmed: deliveryConfirmed ?? false,
                            actualDeliveryDate: actualDeliveryDate ?? null,
                            transportPlan: transportPlan || {},
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedBy: firebaseAuth.currentUser?.uid || null
                        };

                        // âœ… saveProjectData í•¨ìˆ˜ë¡œ í†µì¼ëœ ì €ì¥
                        await saveProjectData(projectData);
                        console.log('âœ… ì €ì¥ëœ ë°ì´í„° í¬ê¸°:', {
                            columnData: Object.keys(columnData || {}).length,
                            dailyData: Object.keys(dailyData || {}).length,
                            transportPlan: Object.keys(transportPlan || {}).length
                        });
                        
                        // ì €ì¥ í™•ì¸: ì €ì¥ ì§í›„ ë‹¤ì‹œ ì½ì–´ì„œ í™•ì¸
                        const verifyDoc = await projectRef.get();
                        if (verifyDoc.exists) {
                            const verifyData = verifyDoc.data();
                            const verifyColumnData = verifyData.columnData || {};
                            const verifyDailyData = verifyData.dailyData || {};
                            console.log('âœ… Firestore ì €ì¥ í™•ì¸:', {
                                columnDataKeys: Object.keys(verifyColumnData).length,
                                dailyDataKeys: Object.keys(verifyDailyData).length,
                                matches: Object.keys(columnData).length === Object.keys(verifyColumnData).length
                            });
                            
                            if (Object.keys(columnData).length > 0 && Object.keys(verifyColumnData).length === 0) {
                                console.error('âŒ ì €ì¥ í™•ì¸ ì‹¤íŒ¨: ë°ì´í„°ê°€ ì €ì¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!');
                                showToast('âš ï¸ ì €ì¥ í™•ì¸ ì‹¤íŒ¨: ë°ì´í„°ê°€ ì €ì¥ë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
                            }
                        } else {
                            console.error('âŒ ì €ì¥ í™•ì¸ ì‹¤íŒ¨: ë¬¸ì„œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!');
                            showToast('âš ï¸ ì €ì¥ í™•ì¸ ì‹¤íŒ¨: ë¬¸ì„œê°€ ì €ì¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
                        }
                        
                        // ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
                        const modeEl = document.getElementById('current-mode');
                        if (modeEl) {
                            modeEl.textContent = 'ğŸŸ¢ Firebase ì—°ê²°ë¨ (Firestore ì €ì¥)';
                            modeEl.style.color = '#4caf50';
                        }
                    } catch (firebaseError) {
                        // âœ… ìƒì„¸ ì—ëŸ¬ ë¡œê·¸ (ê¶Œí•œ ì˜¤ë¥˜ ì§„ë‹¨ìš©)
                        console.error('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                        console.error('[SAVE ERROR]', firebaseError.code, firebaseError.message);
                        console.error('[WRITE PATH]', `projects/${window.PROJECT_ID}`);
                        console.error('[ROLE]', userRole, '[UID]', firebaseAuth.currentUser?.uid);
                        console.error('[PROJECT_ID]', window.PROJECT_ID);
                        console.error('[CURRENT_PROCESS]', currentProcess);
                        console.error('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                        
                        if (firebaseError.code === 'permission-denied') {
                            // âœ… permission-deniedë©´ ì´í›„ ì¬ì‹œë„ ê¸ˆì§€ í”Œë˜ê·¸ ì„¤ì •
                            window.__writeBlocked = true;
                            console.error('âŒ Firestore ê¶Œí•œ ì˜¤ë¥˜: ë¡œê·¸ì¸ ìƒíƒœì™€ ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.');
                            console.error('ğŸ’¡ ìœ„ì˜ [WRITE PATH]ì™€ [ROLE] ì •ë³´ë¥¼ í™•ì¸í•˜ì—¬ Firestore Security Rulesë¥¼ ì ê²€í•˜ì„¸ìš”.');
                            console.error('ğŸ’¡ Viewerë‚˜ í—ˆìš©ë˜ì§€ ì•Šì€ EditorëŠ” ì“°ê¸°ê°€ ì°¨ë‹¨ë©ë‹ˆë‹¤. localStorageì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.');
                            console.error('ğŸš« [WRITE BLOCKED] ì´í›„ ì“°ê¸° ì‹œë„ê°€ ìë™ìœ¼ë¡œ ì°¨ë‹¨ë©ë‹ˆë‹¤.');
                            // permission-deniedëŠ” ì •ìƒì ì¸ ë™ì‘ì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ alertëŠ” í‘œì‹œí•˜ì§€ ì•ŠìŒ
                        } else {
                            console.warn('âš ï¸ Firestore ì €ì¥ ì‹¤íŒ¨ (localStorageëŠ” ì €ì¥ë¨):', firebaseError);
                        }
                    }
                } else {
                    // Firebaseê°€ ì—°ê²°ë˜ì§€ ì•Šì€ ê²½ìš° ìƒíƒœ ì—…ë°ì´íŠ¸
                    const modeEl = document.getElementById('current-mode');
                    if (modeEl) {
                        modeEl.textContent = 'ğŸŸ¡ ë¡œì»¬ ì €ì¥ ëª¨ë“œ (ê°™ì€ ë¸Œë¼ìš°ì €ì—ì„œë§Œ ê³µìœ )';
                        modeEl.style.color = '#f57c00';
                    }
                }
            } catch (error) {
                console.error('ì €ì¥ ì˜¤ë¥˜:', error);
                alert('ë°ì´í„° ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }
        
        // ì¢Œí‘œ ì„¤ì • ëª¨ë“œ í† ê¸€
        function toggleCoordinateSetup() {
            try {
                coordinateSetupMode = !coordinateSetupMode;
                const btn = document.getElementById('coordinate-setup-btn');
                const hint = document.getElementById('coordinate-setup-hint');
                const guide = document.getElementById('coordinate-guide');
                
                if (!btn) {
                    console.error('ì¢Œí‘œ ì„¤ì • ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    alert('ì¢Œí‘œ ì„¤ì • ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                console.log('ì¢Œí‘œ ì„¤ì • ëª¨ë“œ:', coordinateSetupMode);
                
                if (coordinateSetupMode) {
                    btn.classList.remove('inactive');
                    btn.classList.add('active');
                    // ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ì˜ background ì œê±°í•˜ì—¬ í´ë˜ìŠ¤ê°€ ì ìš©ë˜ë„ë¡
                    btn.style.background = '';
                    btn.style.backgroundColor = '';
                    btn.textContent = 'âœ… ì¢Œí‘œ ì„¤ì • ëª¨ë“œ (í™œì„±)';
                    if (hint) hint.style.display = 'inline';
                    if (guide) guide.style.display = 'block';
                    currentColumnForSetup = null;
                    console.log('ì¢Œí‘œ ì„¤ì • ëª¨ë“œ í™œì„±í™”ë¨', btn.className);
                } else {
                    btn.classList.remove('active');
                    btn.classList.add('inactive');
                    // ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ì˜ background ì œê±°í•˜ì—¬ í´ë˜ìŠ¤ê°€ ì ìš©ë˜ë„ë¡
                    btn.style.background = '';
                    btn.style.backgroundColor = '';
                    btn.textContent = 'ğŸ“ ì¢Œí‘œ ì„¤ì • ëª¨ë“œ';
                    if (hint) hint.style.display = 'none';
                    if (guide) guide.style.display = 'none';
                    currentColumnForSetup = null;
                    console.log('ì¢Œí‘œ ì„¤ì • ëª¨ë“œ ë¹„í™œì„±í™”ë¨', btn.className);
                }
                
                // í™”ë©´ ì—…ë°ì´íŠ¸
                renderInstallationStatus();
            } catch (error) {
                console.error('ì¢Œí‘œ ì„¤ì • ëª¨ë“œ í† ê¸€ ì˜¤ë¥˜:', error);
                alert('ì¢Œí‘œ ì„¤ì • ëª¨ë“œ ì „í™˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }
        
        // ë°°ì†¡í™•ì¸ í† ê¸€ í•¨ìˆ˜
        function toggleDeliveryConfirmation(columnId) {
            // ğŸ”’ [ê°€ë“œ] ê¶Œí•œ ì²´í¬: Adminë§Œ ë°°ì†¡í™•ì¸ ê°€ëŠ¥
            if (userRole !== 'admin') {
                alert('âš ï¸ ê¶Œí•œ ì—†ìŒ\n\në°°ì†¡í™•ì¸ì€ ê´€ë¦¬ì(Admin)ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }
            
            // ìš´ì†¡ì°¨ìˆ˜ê³„íšì— ìˆëŠ” ê¸°ë‘¥ë§Œ ë°°ì†¡í™•ì¸ ê°€ëŠ¥
            let hasTransportPlan = false;
            for (let date in dailyData) {
                if (dailyData[date] && dailyData[date][5]) {
                    const colNum = typeof columnId === 'string' ? parseInt(columnId.replace('C', '')) : columnId;
                    if (dailyData[date][5].includes(columnId) || 
                        dailyData[date][5].includes(colNum) || 
                        dailyData[date][5].includes(String(colNum))) {
                        hasTransportPlan = true;
                        break;
                    }
                }
            }
            
            if (!hasTransportPlan) {
                alert('ìš´ì†¡ì°¨ìˆ˜ê³„íšì— ë“±ë¡ëœ ê¸°ë‘¥ë§Œ ë°°ì†¡í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ë°°ì†¡í™•ì¸ ìƒíƒœ í† ê¸€ ë° ì‹¤ì œ ë°°ì†¡ ë‚ ì§œ ì €ì¥
            if (deliveryConfirmed[columnId]) {
                delete deliveryConfirmed[columnId];
                delete actualDeliveryDate[columnId];
                alert(`${columnId} ë°°ì†¡í™•ì¸ì„ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.`);
                // í™”ë©´ ì—…ë°ì´íŠ¸ (ìš´ì†¡ ë‚ ì§œ ì œê±°ë¥¼ ìœ„í•´)
                renderColumnGrid('column-grid-input');
                saveToStorage();
            } else {
                // ì‹¤ì œ ë°°ì†¡ ë‚ ì§œ ì…ë ¥ ë°›ê¸°
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                const workDate = document.getElementById('work-date')?.value || todayStr;
                
                const deliveryDate = prompt(`${columnId}ì˜ ì‹¤ì œ ë°°ì†¡ ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš”.\n(YYYY-MM-DD í˜•ì‹, ê¸°ë³¸ê°’: ${workDate})`, workDate);
                
                if (deliveryDate && deliveryDate.trim() !== '') {
                    // ë‚ ì§œ í˜•ì‹ ê²€ì¦
                    const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
                    if (dateRegex.test(deliveryDate.trim())) {
                        deliveryConfirmed[columnId] = true;
                        actualDeliveryDate[columnId] = deliveryDate.trim();
                        alert(`${columnId} ë°°ì†¡í™•ì¸ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.\nì‹¤ì œ ë°°ì†¡ì¼: ${deliveryDate.trim()}`);
                    } else {
                        alert('ë‚ ì§œ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (YYYY-MM-DD í˜•ì‹)');
                        return;
                    }
                } else {
                    // ì·¨ì†Œí•œ ê²½ìš°
                    return;
                }
            }
            
            // ì €ì¥ ë° í™”ë©´ ì—…ë°ì´íŠ¸
            saveToStorage();
            renderColumnGrid('column-grid-input');
            renderGanttChart();
        }
        
        // í‰ë©´ë„ ì´ë¯¸ì§€ í´ë¦­ í•¸ë“¤ëŸ¬
        function handleFloorPlanClick(event) {
            if (!coordinateSetupMode) return;
            
            const floorPlanImage = document.getElementById('installation-floor-plan-image');
            if (!floorPlanImage) return;
            
            const rect = floorPlanImage.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            const leftPercent = (x / rect.width) * 100;
            const topPercent = (y / rect.height) * 100;
            
            // ê¸°ë‘¥ ë²ˆí˜¸ ëª©ë¡ì—ì„œ ì„ íƒëœ ê¸°ë‘¥ì´ ì—†ìœ¼ë©´ ì•ˆë‚´
            if (!currentColumnForSetup) {
                alert('ë¨¼ì € ì˜¤ë¥¸ìª½ ê¸°ë‘¥ ë²ˆí˜¸ ëª©ë¡ì—ì„œ ì¢Œí‘œë¥¼ ì„¤ì •í•  ê¸°ë‘¥ì„ í´ë¦­í•˜ì„¸ìš”.');
                return;
            }
            
            // ê¸°ì¡´ ì¢Œí‘œ í™•ì¸
            const existingCoord = columnCoordinates[currentColumnForSetup];
            const newCoord = {
                left: leftPercent,
                top: topPercent
            };
            
            // ì¢Œí‘œê°€ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸ (ì†Œìˆ˜ì  1ìë¦¬ê¹Œì§€ ë¹„êµ)
            const isChanged = !existingCoord || 
                Math.abs(existingCoord.left - newCoord.left) > 0.1 || 
                Math.abs(existingCoord.top - newCoord.top) > 0.1;
            
            if (isChanged) {
                // ì¢Œí‘œ ì €ì¥
                columnCoordinates[currentColumnForSetup] = newCoord;
                
                // localStorageì— ì €ì¥
                localStorage.setItem(kcolKey('columnCoordinates'), JSON.stringify(columnCoordinates));
                
                alert(`${currentColumnForSetup}ì˜ ì¢Œí‘œê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤. (${leftPercent.toFixed(1)}%, ${topPercent.toFixed(1)}%)`);
                
                // í™”ë©´ ì—…ë°ì´íŠ¸
                renderInstallationStatus();
            } else {
                alert(`${currentColumnForSetup}ì˜ ì¢Œí‘œê°€ ë³€ê²½ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (${leftPercent.toFixed(1)}%, ${topPercent.toFixed(1)}%)`);
            }
            
            // ë‹¤ìŒ ê¸°ë‘¥ ì„ íƒ ëŒ€ê¸°
            currentColumnForSetup = null;
        }

        async function loadFromLocalStorage() {
            // ğŸ”’ í˜„ì¬ ë©”ëª¨ë¦¬ì— ìˆëŠ” ë°ì´í„° ë°±ì—… (ë°ì´í„° ì†ì‹¤ ë°©ì§€)
            const backupColumnData = JSON.parse(JSON.stringify(columnData || {}));
            const backupDailyData = JSON.parse(JSON.stringify(dailyData || {}));
            const backupTransportPlan = JSON.parse(JSON.stringify(transportPlan || {}));
            
            console.log('ğŸ“¦ ë°ì´í„° ë¡œë“œ ì‹œì‘ (í˜„ì¬ ë©”ëª¨ë¦¬ ë°ì´í„° ë°±ì—… ì™„ë£Œ)');
            console.log('ğŸ“Š ë°±ì—…ëœ ë°ì´í„° í¬ê¸°:', {
                columnData: Object.keys(backupColumnData).length,
                dailyData: Object.keys(backupDailyData).length,
                transportPlan: Object.keys(backupTransportPlan).length
            });
            
            // Firebase Firestoreì—ì„œ ë¨¼ì € ë¡œë“œ ì‹œë„ (ì¸ì¦ëœ ì‚¬ìš©ìë§Œ, ìµëª… ì‚¬ìš©ì ì°¨ë‹¨)
            if (initFirebase() && firebaseAuth.currentUser) {
                // ìµëª… ì‚¬ìš©ì ì°¨ë‹¨
                if (firebaseAuth.currentUser.isAnonymous) {
                    console.warn('âš ï¸ ìµëª… ë¡œê·¸ì¸ ìƒíƒœì—ì„œëŠ” Firestoreì—ì„œ ë°ì´í„°ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. localStorageë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.');
                    // localStorage ë¡œë“œë¡œ ê³„ì† ì§„í–‰
                } else {
                    try {
                        const projectDoc = await firebaseDb.collection('projects').doc(window.PROJECT_ID).get();
                        
                        if (projectDoc.exists) {
                            const projectData = projectDoc.data();
                            console.log('âœ… Firestoreì—ì„œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', window.PROJECT_ID);
                            console.log('ğŸ“Š ë¡œë“œëœ ë°ì´í„° í¬ê¸°:', {
                                columnData: Object.keys(projectData.columnData || {}).length,
                                dailyData: Object.keys(projectData.dailyData || {}).length,
                                transportPlan: Object.keys(projectData.transportPlan || {}).length
                            });
                            
                            // Firestore ë°ì´í„° ë¡œë“œ
                            const firestoreColumnData = projectData.columnData || {};
                            const firestoreDailyData = projectData.dailyData || {};
                            const firestoreColumnCoordinates = projectData.columnCoordinates || {};
                            const firestoreDeliveryConfirmed = projectData.deliveryConfirmed || {};
                            const firestoreActualDeliveryDate = projectData.actualDeliveryDate || {};
                            const firestoreTransportPlan = projectData.transportPlan || {};
                            
                            // localStorage ë°ì´í„°ë„ í™•ì¸ (ë³‘í•©ì„ ìœ„í•´)
                            const localColumnData = localStorage.getItem(kcolKey('steelColumnData'));
                            const localDailyData = localStorage.getItem(kcolKey('steelColumnDaily'));
                            
                            // ğŸ”’ ë°ì´í„° ë³‘í•© ì „ëµ: ê°€ì¥ ë§ì€ ë°ì´í„°ë¥¼ ê°€ì§„ ì†ŒìŠ¤ë¥¼ ìš°ì„  ì‚¬ìš©
                            // 1. Firestore ë°ì´í„° í¬ê¸° í™•ì¸
                            const firestoreColumnDataSize = Object.keys(firestoreColumnData).length;
                            const firestoreDailyDataSize = Object.keys(firestoreDailyData).length;
                            
                            // 2. localStorage ë°ì´í„° í¬ê¸° í™•ì¸
                            let localColumnDataSize = 0;
                            let localDailyDataSize = 0;
                            let parsedLocalColumnData = {};
                            let parsedLocalDailyData = {};
                            
                            if (localColumnData) {
                                try {
                                    parsedLocalColumnData = JSON.parse(localColumnData);
                                    localColumnDataSize = Object.keys(parsedLocalColumnData).length;
                                } catch (e) {
                                    console.error('âŒ localStorage columnData íŒŒì‹± ì‹¤íŒ¨:', e);
                                }
                            }
                            
                            if (localDailyData) {
                                try {
                                    parsedLocalDailyData = JSON.parse(localDailyData);
                                    localDailyDataSize = Object.keys(parsedLocalDailyData).length;
                                } catch (e) {
                                    console.error('âŒ localStorage dailyData íŒŒì‹± ì‹¤íŒ¨:', e);
                                }
                            }
                            
                            // 3. ë°±ì—… ë°ì´í„° í¬ê¸° í™•ì¸
                            const backupColumnDataSize = Object.keys(backupColumnData).length;
                            const backupDailyDataSize = Object.keys(backupDailyData).length;
                            
                            // 4. ê°€ì¥ ë§ì€ ë°ì´í„°ë¥¼ ê°€ì§„ ì†ŒìŠ¤ ì„ íƒ (ë°ì´í„° ì†ì‹¤ ë°©ì§€)
                            if (firestoreColumnDataSize > 0 || firestoreDailyDataSize > 0) {
                                // Firestore ë°ì´í„°ê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©
                                columnData = firestoreColumnData;
                                dailyData = firestoreDailyData;
                                
                                // localStorageë‚˜ ë°±ì—… ë°ì´í„°ì— ë” ë§ì€ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ë³‘í•©
                                if (localColumnDataSize > firestoreColumnDataSize) {
                                    console.log('âš ï¸ localStorageì— ë” ë§ì€ columnDataê°€ ìˆìŠµë‹ˆë‹¤. ë³‘í•©í•©ë‹ˆë‹¤.');
                                    columnData = { ...firestoreColumnData, ...parsedLocalColumnData };
                                }
                                if (backupColumnDataSize > Object.keys(columnData).length) {
                                    console.log('âš ï¸ ë°±ì—… ë°ì´í„°ì— ë” ë§ì€ columnDataê°€ ìˆìŠµë‹ˆë‹¤. ë³‘í•©í•©ë‹ˆë‹¤.');
                                    columnData = { ...columnData, ...backupColumnData };
                                }
                                
                                if (localDailyDataSize > firestoreDailyDataSize) {
                                    console.log('âš ï¸ localStorageì— ë” ë§ì€ dailyDataê°€ ìˆìŠµë‹ˆë‹¤. ë³‘í•©í•©ë‹ˆë‹¤.');
                                    dailyData = { ...firestoreDailyData, ...parsedLocalDailyData };
                                }
                                if (backupDailyDataSize > Object.keys(dailyData).length) {
                                    console.log('âš ï¸ ë°±ì—… ë°ì´í„°ì— ë” ë§ì€ dailyDataê°€ ìˆìŠµë‹ˆë‹¤. ë³‘í•©í•©ë‹ˆë‹¤.');
                                    dailyData = { ...dailyData, ...backupDailyData };
                                }
                                
                                console.log('âœ… Firestore ë°ì´í„° ì‚¬ìš© (ë³‘í•© ì™„ë£Œ)');
                            } else if (localColumnDataSize > 0 || localDailyDataSize > 0) {
                                // Firestore ë°ì´í„°ê°€ ì—†ê³  localStorageì— ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì‚¬ìš©
                                console.warn('âš ï¸ Firestore ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. localStorage ë°ì´í„°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.');
                                
                                columnData = parsedLocalColumnData;
                                dailyData = parsedLocalDailyData;
                                
                                // ë°±ì—… ë°ì´í„°ì™€ ë³‘í•©
                                if (backupColumnDataSize > 0) {
                                    columnData = { ...columnData, ...backupColumnData };
                                }
                                if (backupDailyDataSize > 0) {
                                    dailyData = { ...dailyData, ...backupDailyData };
                                }
                                
                                console.log('âœ… localStorage ë°ì´í„° ì‚¬ìš© (ë³‘í•© ì™„ë£Œ)');
                                
                                // ë³‘í•©ëœ ë°ì´í„°ë¥¼ Firestoreì— ë‹¤ì‹œ ì €ì¥ ì‹œë„
                                console.log('ğŸ’¡ ë³‘í•©ëœ ë°ì´í„°ë¥¼ Firestoreì— ë‹¤ì‹œ ì €ì¥ ì‹œë„...');
                                setTimeout(() => {
                                    if (userRole === 'admin' || userRole === 'editor') {
                                        saveToStorage();
                                    }
                                }, 1000);
                            } else if (backupColumnDataSize > 0 || backupDailyDataSize > 0) {
                                // ë°±ì—… ë°ì´í„° ì‚¬ìš©
                                console.warn('âš ï¸ Firestoreì™€ localStorage ëª¨ë‘ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë°±ì—… ë°ì´í„°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.');
                                
                                columnData = backupColumnData;
                                dailyData = backupDailyData;
                                transportPlan = backupTransportPlan;
                                
                                console.log('âœ… ë°±ì—… ë°ì´í„° ì‚¬ìš©');
                            } else {
                                // ëª¨ë‘ ì—†ìœ¼ë©´ ë¹ˆ ë°ì´í„° ì‚¬ìš©
                                columnData = firestoreColumnData;
                                dailyData = firestoreDailyData;
                                console.warn('âš ï¸ ëª¨ë“  ì†ŒìŠ¤ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                            }
                            
                            // ë‚˜ë¨¸ì§€ ë°ì´í„°ëŠ” Firestore ìš°ì„ , ì—†ìœ¼ë©´ ë°±ì—… ì‚¬ìš©
                            columnCoordinates = firestoreColumnCoordinates || columnCoordinates || {};
                            deliveryConfirmed = firestoreDeliveryConfirmed || deliveryConfirmed || {};
                            actualDeliveryDate = firestoreActualDeliveryDate || actualDeliveryDate || {};
                            transportPlan = firestoreTransportPlan || transportPlan || {};
                            
                            // ğŸ”’ ìµœì¢… ë°ì´í„° ê²€ì¦: ë°ì´í„°ê°€ ì†ì‹¤ë˜ì§€ ì•Šì•˜ëŠ”ì§€ í™•ì¸
                            const finalColumnDataSize = Object.keys(columnData).length;
                            const finalDailyDataSize = Object.keys(dailyData).length;
                            
                            console.log('ğŸ“Š ìµœì¢… ë¡œë“œëœ ë°ì´í„° í¬ê¸°:', {
                                columnData: finalColumnDataSize,
                                dailyData: finalDailyDataSize,
                                transportPlan: Object.keys(transportPlan).length
                            });
                            
                            // ë°ì´í„° ì†ì‹¤ ê²½ê³ 
                            if (backupColumnDataSize > 0 && finalColumnDataSize < backupColumnDataSize) {
                                console.warn('âš ï¸ ê²½ê³ : columnDataê°€ ì¼ë¶€ ì†ì‹¤ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤!', {
                                    ë°±ì—…: backupColumnDataSize,
                                    ìµœì¢…: finalColumnDataSize
                                });
                            }
                            if (backupDailyDataSize > 0 && finalDailyDataSize < backupDailyDataSize) {
                                console.warn('âš ï¸ ê²½ê³ : dailyDataê°€ ì¼ë¶€ ì†ì‹¤ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤!', {
                                    ë°±ì—…: backupDailyDataSize,
                                    ìµœì¢…: finalDailyDataSize
                                });
                            }
                            
                            // localStorageì—ë„ ë™ê¸°í™” (ë°±ì—…)
                            localStorage.setItem(kcolKey('steelColumnData'), JSON.stringify(columnData));
                            localStorage.setItem(kcolKey('steelColumnDaily'), JSON.stringify(dailyData));
                            localStorage.setItem(kcolKey('columnCoordinates'), JSON.stringify(columnCoordinates));
                            localStorage.setItem(kcolKey('deliveryConfirmed'), JSON.stringify(deliveryConfirmed));
                            localStorage.setItem(kcolKey('actualDeliveryDate'), JSON.stringify(actualDeliveryDate));
                            localStorage.setItem(kcolKey('transportPlan'), JSON.stringify(transportPlan));
                            
                            // Firebase ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
                            const modeEl = document.getElementById('current-mode');
                            if (modeEl) {
                                modeEl.textContent = 'ğŸŸ¢ Firebase ì—°ê²°ë¨ (Firestore ì €ì¥)';
                                modeEl.style.color = '#4caf50';
                            }
                            
                            syncTransportToDailyData(false);
                            return;
                        } else {
                            console.warn('âš ï¸ Firestoreì— í”„ë¡œì íŠ¸ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤:', window.PROJECT_ID);
                            console.log('ğŸ’¡ localStorageì—ì„œ ë°ì´í„°ë¥¼ ë¡œë“œí•©ë‹ˆë‹¤.');
                        }
                    } catch (firebaseError) {
                        console.warn('âš ï¸ Firestore ë¡œë“œ ì‹¤íŒ¨, localStorage ì‚¬ìš©:', firebaseError);
                        if (firebaseError.code === 'permission-denied') {
                            console.error('âŒ Firestore ê¶Œí•œ ì˜¤ë¥˜: ë¡œê·¸ì¸ ìƒíƒœì™€ ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.');
                            console.error('ğŸ’¡ ê²½ë¡œ: projects/' + window.PROJECT_ID);
                        }
                    }
                }
            }
            
            // Firebaseê°€ ì—†ê±°ë‚˜ ì‹¤íŒ¨í•œ ê²½ìš° localStorageì—ì„œ ë¡œë“œ
            // ğŸ”’ í˜„ì¬ ë©”ëª¨ë¦¬ ë°ì´í„°ì™€ ë³‘í•©í•˜ì—¬ ë°ì´í„° ì†ì‹¤ ë°©ì§€
            const savedColumnData = localStorage.getItem(kcolKey('steelColumnData'));
            const savedDailyData = localStorage.getItem(kcolKey('steelColumnDaily'));
            const savedTransportPlan = localStorage.getItem(kcolKey('transportPlan'));
            const savedCoordinates = localStorage.getItem(kcolKey('columnCoordinates'));
            const savedDeliveryConfirmed = localStorage.getItem(kcolKey('deliveryConfirmed'));
            const savedActualDeliveryDate = localStorage.getItem(kcolKey('actualDeliveryDate'));
            const savedTransportVolumeData = localStorage.getItem(kcolKey('transportVolumeData'));
            
            // localStorage ë°ì´í„° íŒŒì‹± ë° ë³‘í•©
            if (savedColumnData) {
                try {
                    const parsedColumnData = JSON.parse(savedColumnData);
                    // í˜„ì¬ ë©”ëª¨ë¦¬ ë°ì´í„°ì™€ ë³‘í•© (ë‘˜ ë‹¤ ë³´ì¡´)
                    columnData = { ...columnData, ...parsedColumnData };
                    console.log('âœ… localStorage columnData ë¡œë“œ ë° ë³‘í•© ì™„ë£Œ');
                } catch (e) {
                    console.error('âŒ localStorage columnData íŒŒì‹± ì‹¤íŒ¨:', e);
                }
            }
            
            if (savedDailyData) {
                try {
                    const parsedDailyData = JSON.parse(savedDailyData);
                    // í˜„ì¬ ë©”ëª¨ë¦¬ ë°ì´í„°ì™€ ë³‘í•© (ë‘˜ ë‹¤ ë³´ì¡´)
                    dailyData = { ...dailyData, ...parsedDailyData };
                    console.log('âœ… localStorage dailyData ë¡œë“œ ë° ë³‘í•© ì™„ë£Œ');
                } catch (e) {
                    console.error('âŒ localStorage dailyData íŒŒì‹± ì‹¤íŒ¨:', e);
                }
            }
            
            if (savedTransportPlan) {
                try {
                    const parsedTransportPlan = JSON.parse(savedTransportPlan);
                    // í˜„ì¬ ë©”ëª¨ë¦¬ ë°ì´í„°ì™€ ë³‘í•©
                    transportPlan = { ...transportPlan, ...parsedTransportPlan };
                    console.log('âœ… localStorage transportPlan ë¡œë“œ ë° ë³‘í•© ì™„ë£Œ');
                } catch (e) {
                    console.error('âŒ localStorage transportPlan íŒŒì‹± ì‹¤íŒ¨:', e);
                    transportPlan = transportPlan || {};
                }
            } else {
                transportPlan = transportPlan || {};
            }
            
            // ì›ë³¸ ìš´ì†¡ê³„íš ë°±ì—… (ì²˜ìŒ í•œ ë²ˆë§Œ)
            if (!originalTransportPlan || Object.keys(originalTransportPlan).length === 0) {
                originalTransportPlan = JSON.parse(JSON.stringify(transportPlan)); // ê¹Šì€ ë³µì‚¬
                console.log('âœ… ì›ë³¸ ìš´ì†¡ê³„íš ë°±ì—… ì™„ë£Œ');
            }
            
            // ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš ë¡œë“œ
            const savedAdjustedTransportPlan = localStorage.getItem(kcolKey('adjustedTransportPlan'));
            if (savedAdjustedTransportPlan) {
                try {
                    const parsedAdjustedTransportPlan = JSON.parse(savedAdjustedTransportPlan);
                    adjustedTransportPlan = parsedAdjustedTransportPlan;
                    console.log('âœ… localStorage adjustedTransportPlan ë¡œë“œ ì™„ë£Œ');
                } catch (e) {
                    console.error('âŒ localStorage adjustedTransportPlan íŒŒì‹± ì‹¤íŒ¨:', e);
                    adjustedTransportPlan = adjustedTransportPlan || {};
                }
            } else {
                adjustedTransportPlan = adjustedTransportPlan || {};
            }
            
            // ë¨¼ì € ê¸°ë³¸ê°’ì´ ìˆìœ¼ë©´ ê¸°ë³¸ê°’ ë¡œë“œ ì‹œë„
            const defaultLoaded = loadDefaultTransportVolumeData();
            
            // ê¸°ë³¸ê°’ì´ ì—†ê±°ë‚˜ ë¡œë“œ ì‹¤íŒ¨í•œ ê²½ìš°, ì¼ë°˜ ì €ì¥ëœ ë°ì´í„° ë¡œë“œ
            if (!defaultLoaded) {
                if (savedTransportVolumeData) {
                    try {
                        const parsedTransportVolumeData = JSON.parse(savedTransportVolumeData);
                        transportVolumeData = parsedTransportVolumeData;
                        console.log('âœ… localStorage transportVolumeData ë¡œë“œ ì™„ë£Œ:', transportVolumeData.length, 'ê°œ');
                        
                        // ì €ì¥ëœ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì°¨ìˆ˜ë³„ ì§‘ê³„ í…Œì´ë¸”ë„ ë Œë”ë§
                        if (transportVolumeData.length > 0 && typeof renderTransportVolumeTripSummary === 'function') {
                            renderTransportVolumeTripSummary(transportVolumeData);
                        }
                        // ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš í…Œì´ë¸”ë„ ë Œë”ë§
                        renderAdjustedTripSummarySafe();
                    } catch (e) {
                        console.error('âŒ localStorage transportVolumeData íŒŒì‹± ì‹¤íŒ¨:', e);
                        transportVolumeData = transportVolumeData || [];
                    }
                }
            } else {
                // ê¸°ë³¸ê°’ì´ ë¡œë“œëœ ê²½ìš°ì—ë„ í…Œì´ë¸” ë Œë”ë§
                if (transportVolumeData.length > 0 && typeof renderTransportVolumeTripSummary === 'function') {
                    renderTransportVolumeTripSummary(transportVolumeData);
                }
                renderAdjustedTripSummarySafe();
            }
            
            // ê·œê²©ë³„ í•„í„° ì„ íƒ ìƒíƒœ ë¡œë“œ
            const savedSelectedSizes = localStorage.getItem(kcolKey('selectedSizes'));
            if (savedSelectedSizes) {
                try {
                    selectedSizes = JSON.parse(savedSelectedSizes);
                    console.log('âœ… ê·œê²©ë³„ í•„í„° ì„ íƒ ìƒíƒœ ë¡œë“œ ì™„ë£Œ:', selectedSizes);
                } catch (e) {
                    console.error('âŒ selectedSizes íŒŒì‹± ì‹¤íŒ¨:', e);
                    selectedSizes = [];
                }
            }
            
            // ì°¨ìˆ˜ë³„ í•„í„° ì„ íƒ ìƒíƒœ ë¡œë“œ (ì´ˆê¸° load ì‹œ ì›13ì°¨ìˆ˜ëŠ” í•­ìƒ ON - ì „ì²´ ì„ íƒ)
            const savedSelectedTrips = localStorage.getItem(kcolKey('selectedTrips'));
            if (savedSelectedTrips) {
                try {
                    selectedTrips = JSON.parse(savedSelectedTrips);
                    console.log('âœ… ì°¨ìˆ˜ë³„ í•„í„° ì„ íƒ ìƒíƒœ ë¡œë“œ ì™„ë£Œ:', selectedTrips);
                } catch (e) {
                    console.error('âŒ selectedTrips íŒŒì‹± ì‹¤íŒ¨:', e);
                    selectedTrips = [];
                }
            }
            if (!selectedTrips || selectedTrips.length === 0) {
                selectedTrips = [];
                if (transportPlan && Object.keys(transportPlan).length > 0) {
                    Object.keys(transportPlan).forEach(tripNum => {
                        const n = parseInt(tripNum);
                        if (n >= 1 && n <= 13) selectedTrips.push('original_' + n);
                    });
                }
                if (adjustedTransportPlan && Object.keys(adjustedTransportPlan).length > 0) {
                    Object.keys(adjustedTransportPlan).forEach(tripNum => {
                        const n = parseInt(tripNum);
                        if (n >= 1 && n <= 13) selectedTrips.push('adjusted_' + n);
                    });
                }
                if (selectedTrips.length > 0) {
                    localStorage.setItem(kcolKey('selectedTrips'), JSON.stringify(selectedTrips));
                }
            }
            
            // ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš ë¶€ì¬ìˆ˜ ì¡°ì •ê°’ ë¡œë“œ
            const savedTripCountDeltas = localStorage.getItem(kcolKey('tripCountDeltas'));
            if (savedTripCountDeltas) {
                try {
                    tripCountDeltas = JSON.parse(savedTripCountDeltas);
                } catch (e) {
                    tripCountDeltas = {};
                }
            }
            
            if (savedCoordinates) {
                try {
                    const parsedCoordinates = JSON.parse(savedCoordinates);
                    columnCoordinates = { ...columnCoordinates, ...parsedCoordinates };
                    console.log('âœ… localStorage columnCoordinates ë¡œë“œ ë° ë³‘í•© ì™„ë£Œ');
                } catch (e) {
                    console.error('âŒ localStorage columnCoordinates íŒŒì‹± ì‹¤íŒ¨:', e);
                    columnCoordinates = columnCoordinates || {};
                }
            } else {
                columnCoordinates = columnCoordinates || {};
            }
            
            if (savedDeliveryConfirmed) {
                try {
                    const parsedDeliveryConfirmed = JSON.parse(savedDeliveryConfirmed);
                    deliveryConfirmed = { ...deliveryConfirmed, ...parsedDeliveryConfirmed };
                    console.log('âœ… localStorage deliveryConfirmed ë¡œë“œ ë° ë³‘í•© ì™„ë£Œ');
                } catch (e) {
                    console.error('âŒ localStorage deliveryConfirmed íŒŒì‹± ì‹¤íŒ¨:', e);
                    deliveryConfirmed = deliveryConfirmed || {};
                }
            } else {
                deliveryConfirmed = deliveryConfirmed || {};
            }
            
            if (savedActualDeliveryDate) {
                try {
                    const parsedActualDeliveryDate = JSON.parse(savedActualDeliveryDate);
                    actualDeliveryDate = { ...actualDeliveryDate, ...parsedActualDeliveryDate };
                    console.log('âœ… localStorage actualDeliveryDate ë¡œë“œ ë° ë³‘í•© ì™„ë£Œ');
                } catch (e) {
                    console.error('âŒ localStorage actualDeliveryDate íŒŒì‹± ì‹¤íŒ¨:', e);
                    actualDeliveryDate = actualDeliveryDate || {};
                }
            } else {
                actualDeliveryDate = actualDeliveryDate || {};
            }
            
            // ğŸ”’ ìµœì¢… ë°ì´í„° ê²€ì¦
            console.log('ğŸ“Š ìµœì¢… ë¡œë“œëœ ë°ì´í„° í¬ê¸°:', {
                columnData: Object.keys(columnData).length,
                dailyData: Object.keys(dailyData).length,
                transportPlan: Object.keys(transportPlan).length,
                columnCoordinates: Object.keys(columnCoordinates).length
            });
            
            // ìš´ì†¡ì°¨ìˆ˜ê³„íšì„ dailyDataì˜ í˜„ì¥ë°°ì†¡(process 5)ì— ë™ê¸°í™”
            // ì´ˆê¸° ë¡œë“œì´ë¯€ë¡œ í™•ì¸ ì—†ì´ ìë™ ë™ê¸°í™”
            syncTransportToDailyData(false);
        }

        function exportData() {
            const exportObj = {
                columnData: columnData,
                dailyData: dailyData,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(exportObj, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `kcolumn-data-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
        }

        // JSON íŒŒì¼ ê°€ì ¸ì˜¤ê¸°
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    columnData = data.columnData || {};
                    dailyData = data.dailyData || {};
                    saveToStorage();
                    renderColumnGrid('column-grid-overview');
                    renderColumnGrid('column-grid-input');
                    updateProgressBars();
                    alert('ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.');
                } catch (error) {
                    alert('íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
            };
            reader.readAsText(file);
        }

        function loadDayData() {
            const workDate = document.getElementById('work-date').value;
            
            // íœ´ë¬´ì¼ ì²´í¬
            if (isHoliday(workDate)) {
                const holidayName = getHolidayName(workDate);
                showConnectionStatus(`ğŸ”´ ${workDate}: ${holidayName} - ì‘ì—… ì…ë ¥ ë¶ˆê°€`);
            }
            
            // ì¤‘ë³µ í™•ì¸
            checkDuplicateForDate(workDate);
            
            renderColumnGrid('column-grid-input');
        }
        
        // íŠ¹ì • ë‚ ì§œì˜ ì¤‘ë³µ ì…ë ¥ í™•ì¸
        function checkDuplicateForDate(dateStr) {
            if (!dateStr || !dailyData[dateStr]) {
                const duplicateWarning = document.getElementById('duplicate-warning');
                if (duplicateWarning) {
                    duplicateWarning.style.display = 'none';
                }
                return;
            }
            
            const duplicates = [];
            const processNames = ['', 'ì£¼ê¸°ë‘¥ì»¤íŒ…', 'ì†Œë¶€ì¬ì»¤íŒ…', 'ì£¼ê¸°ë‘¥ì¡°ë¦½', 'ì†Œë¶€ì¬ì¡°ë¦½', 'í˜„ì¥ë°°ì†¡', 'í˜„ì¥ì„¤ì¹˜'];
            
            // ëª¨ë“  ê¸°ë‘¥ì— ëŒ€í•´ ì¤‘ë³µ í™•ì¸
            for (let i = 1; i <= TOTAL_COLUMNS; i++) {
                const colId = i + 'C';
                const completedProcesses = [];
                
                for (let p = 1; p <= 6; p++) {
                    const dayData = dailyData[dateStr][p];
                    if (dayData && (dayData.includes(i) || dayData.includes(colId))) {
                        completedProcesses.push(p);
                    }
                }
                
                // ê°™ì€ ë‚ ì§œì— ì—¬ëŸ¬ ê³µì •ì´ ì™„ë£Œëœ ê²½ìš°
                // ë‹¨, ì£¼ê¸°ë‘¥ì»¤íŒ…(1)ê³¼ ì†Œë¶€ì¬ì»¤íŒ…(2)ì€ ì¤‘ë³µ í—ˆìš©
                const isAllowedDuplicate = completedProcesses.length === 2 && 
                    completedProcesses.includes(1) && 
                    completedProcesses.includes(2);
                
                if (completedProcesses.length > 1 && !isAllowedDuplicate) {
                    const processList = completedProcesses.map(p => `${p}.${processNames[p]}`).join(', ');
                    duplicates.push(`${colId}: ${processList}`);
                }
            }
            
            // ì¤‘ë³µì´ ìˆìœ¼ë©´ ê²½ê³  í‘œì‹œ
            const duplicateWarning = document.getElementById('duplicate-warning');
            const duplicateWarningContent = document.getElementById('duplicate-warning-content');
            if (duplicateWarning && duplicateWarningContent) {
                if (duplicates.length > 0) {
                    duplicateWarning.style.display = 'block';
                    duplicateWarningContent.innerHTML = `âš ï¸ <strong>ì¤‘ë³µì…ë ¥</strong>: ${dateStr}<br>${duplicates.join('<br>')}`;
                } else {
                    duplicateWarning.style.display = 'none';
                }
            }
        }
        
        // ì¤‘ë³µëœ í•­ëª© ëª¨ë‘ ì‚­ì œ
        function deleteAllDuplicates() {
            const workDate = document.getElementById('work-date')?.value;
            if (!workDate) {
                alert('ì‘ì—…ì¼ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (!dailyData[workDate]) {
                alert('í•´ë‹¹ ë‚ ì§œì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ì¤‘ë³µëœ í•­ëª© ì°¾ê¸°
            const duplicates = [];
            const processNames = ['', 'ì£¼ê¸°ë‘¥ì»¤íŒ…', 'ì†Œë¶€ì¬ì»¤íŒ…', 'ì£¼ê¸°ë‘¥ì¡°ë¦½', 'ì†Œë¶€ì¬ì¡°ë¦½', 'í˜„ì¥ë°°ì†¡', 'í˜„ì¥ì„¤ì¹˜'];
            
            for (let i = 1; i <= TOTAL_COLUMNS; i++) {
                const colId = i + 'C';
                const completedProcesses = [];
                
                for (let p = 1; p <= 6; p++) {
                    const dayData = dailyData[workDate][p];
                    if (dayData && (dayData.includes(i) || dayData.includes(colId))) {
                        completedProcesses.push(p);
                    }
                }
                
                // ê°™ì€ ë‚ ì§œì— ì—¬ëŸ¬ ê³µì •ì´ ì™„ë£Œëœ ê²½ìš°
                if (completedProcesses.length > 1) {
                    duplicates.push({
                        columnId: colId,
                        columnNum: i,
                        processes: completedProcesses
                    });
                }
            }
            
            if (duplicates.length === 0) {
                alert('ì¤‘ë³µëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const processList = duplicates.map(d => {
                const processNames = ['', 'ì£¼ê¸°ë‘¥ì»¤íŒ…', 'ì†Œë¶€ì¬ì»¤íŒ…', 'ì£¼ê¸°ë‘¥ì¡°ë¦½', 'ì†Œë¶€ì¬ì¡°ë¦½', 'í˜„ì¥ë°°ì†¡', 'í˜„ì¥ì„¤ì¹˜'];
                const processList = d.processes.map(p => `${p}.${processNames[p]}`).join(', ');
                return `${d.columnId}: ${processList}`;
            }).join('\n');
            
            if (confirm(`ë‹¤ìŒ ì¤‘ë³µ í•­ëª©ë“¤ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n${processList}\n\nâš ï¸ ì£¼ì˜: ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                // ì¤‘ë³µëœ í•­ëª© ì‚­ì œ (ê°€ì¥ ë†’ì€ ê³µì •ë§Œ ë‚¨ê¸°ê³  ë‚˜ë¨¸ì§€ ì‚­ì œ)
                duplicates.forEach(dup => {
                    // ê°€ì¥ ë†’ì€ ê³µì • ë²ˆí˜¸ ì°¾ê¸°
                    const maxProcess = Math.max(...dup.processes);
                    
                    // ê°€ì¥ ë†’ì€ ê³µì •ì„ ì œì™¸í•œ ë‚˜ë¨¸ì§€ ì‚­ì œ
                    dup.processes.forEach(p => {
                        if (p !== maxProcess) {
                            if (dailyData[workDate][p]) {
                                dailyData[workDate][p] = dailyData[workDate][p].filter(col => 
                                    col !== dup.columnId && col !== dup.columnNum
                                );
                                // ë¹ˆ ë°°ì—´ì´ë©´ ì‚­ì œ
                                if (dailyData[workDate][p].length === 0) {
                                    delete dailyData[workDate][p];
                                }
                            }
                        }
                    });
                    
                    // columnData ì—…ë°ì´íŠ¸
                    if (columnData[dup.columnId]) {
                        columnData[dup.columnId].status = maxProcess;
                        columnData[dup.columnId].lastUpdate = workDate;
                    }
                });
                
                // ì €ì¥
                saveToStorage();
                
                // í™”ë©´ ì—…ë°ì´íŠ¸
                renderGanttChart();
                renderColumnGrid('column-grid-overview');
                renderColumnGrid('column-grid-input');
                updateProgressBars();
                
                // ì¤‘ë³µ í™•ì¸ ë‹¤ì‹œ ì‹¤í–‰
                checkDuplicateForDate(workDate);
                
                alert(`${duplicates.length}ê°œì˜ ì¤‘ë³µ í•­ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. (ê°€ì¥ ë†’ì€ ê³µì •ë§Œ ìœ ì§€)`);
            }
        }

        // ========== ìš´ì†¡ì°¨ìˆ˜ê³„íš ê´€ë ¨ í•¨ìˆ˜ ==========
        
        // ìš´ì†¡ê³„íš ë¡œë“œ
        function loadTransportPlan() {
            const saved = localStorage.getItem(kcolKey('transportPlan')) || localStorage.getItem('transportPlan');
            if (saved) {
                const data = JSON.parse(saved);
                // ê¸°ì¡´ í˜•ì‹ ë§ˆì´ê·¸ë ˆì´ì…˜ (ë°°ì—´ í˜•ì‹ -> ê°ì²´ í˜•ì‹)
                transportPlan = {};
                for (let tripNum in data) {
                    if (Array.isArray(data[tripNum])) {
                        // ê¸°ì¡´ í˜•ì‹: { 1: [1,2,3] }
                        transportPlan[tripNum] = {
                            columns: data[tripNum],
                            date: ''
                        };
                    } else {
                        // ìƒˆ í˜•ì‹: { 1: { columns: [1,2,3], date: '2025-01-15' } }
                        transportPlan[tripNum] = data[tripNum];
                    }
                }
            } else {
                transportPlan = {};
            }
            
            // ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš ë¡œë“œ
            const savedAdjusted = localStorage.getItem(kcolKey('adjustedTransportPlan'));
            if (savedAdjusted) {
                try {
                    const data = JSON.parse(savedAdjusted);
                    adjustedTransportPlan = {};
                    for (let tripNum in data) {
                        if (Array.isArray(data[tripNum])) {
                            adjustedTransportPlan[tripNum] = {
                                columns: data[tripNum],
                                date: ''
                            };
                        } else {
                            adjustedTransportPlan[tripNum] = data[tripNum];
                        }
                    }
                } catch (e) {
                    console.error('âŒ adjustedTransportPlan íŒŒì‹± ì‹¤íŒ¨:', e);
                    adjustedTransportPlan = {};
                }
            } else {
                adjustedTransportPlan = {};
            }
            
            // ìš´ì†¡ì°¨ìˆ˜ê³„íšì„ dailyDataì˜ í˜„ì¥ë°°ì†¡(process 5)ì— ë™ê¸°í™”
            // ì´ˆê¸° ë¡œë“œì´ë¯€ë¡œ í™•ì¸ ì—†ì´ ìë™ ë™ê¸°í™”
            syncTransportToDailyData(false);
        }

        // ì°¨ìˆ˜ ë²„íŠ¼ ë Œë”ë§
        function renderTransportTrips() {
            const container = document.getElementById('transport-trips-list');
            container.innerHTML = '';
            
            const trips = Object.keys(transportPlan).map(Number).sort((a, b) => a - b);
            if (trips.length === 0) {
                trips.push(1);
                transportPlan[1] = { columns: [], date: '' };
            }
            
            trips.forEach(tripNum => {
                const btn = document.createElement('button');
                btn.className = 'action-btn' + (currentTransportTrip === tripNum ? ' primary' : ' secondary');
                const tripData = transportPlan[tripNum] || { columns: [], date: '' };
                const columnCount = tripData.columns?.length || 0;
                
                // ì°¨ìˆ˜ë³„ ì´ ë¬¼ëŸ‰ ê³„ì‚°
                let totalWeight = 0;
                if (tripData.columns && tripData.columns.length > 0) {
                    tripData.columns.forEach(columnId => {
                        totalWeight += calculateColumnWeight(columnId);
                    });
                }
                const weightStr = totalWeight > 0 ? `${totalWeight.toFixed(2)}í†¤` : '0í†¤';
                
                const dateStr = tripData.date ? tripData.date : '';
                btn.textContent = `${tripNum}ì°¨ìˆ˜ (${columnCount}ê°œ, ${weightStr}, ${dateStr})`;
                btn.type = 'button'; // í¼ ì œì¶œ ë°©ì§€
                btn.style.cursor = 'pointer';
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    selectTransportTrip(tripNum);
                });
                container.appendChild(btn);
            });
            
            if (currentTransportTrip && !transportPlan[currentTransportTrip]) {
                transportPlan[currentTransportTrip] = { columns: [], date: '' };
            }
            
            updateTransportTripInfo();
        }

        // ì°¨ìˆ˜ ì¶”ê°€
        function addTransportTrip() {
            // ê¶Œí•œ ì²´í¬: ìš´ì†¡ì°¨ìˆ˜ê³„íšì€ Adminë§Œ ì‚¬ìš© ê°€ëŠ¥
            if (userRole !== 'admin') {
                alert('âš ï¸ ê¶Œí•œ ì—†ìŒ\n\nìš´ì†¡ì°¨ìˆ˜ê³„íšì€ ê´€ë¦¬ì(Admin)ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }
            
            const input = document.getElementById('transport-trip-input');
            const tripNum = parseInt(input.value) || 1;
            
            if (!transportPlan[tripNum]) {
                transportPlan[tripNum] = { columns: [], date: '' };
                selectTransportTrip(tripNum);
                renderTransportTrips();
                // ìš´ì†¡ì°¨ìˆ˜ê³„íš ë³€ê²½ ì‹œ í˜„ì¥ë°°ì†¡(process 5)ì— ë™ê¸°í™”
                // í™•ì¸ ì—†ì´ ìë™ ë™ê¸°í™” (ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œì—ë§Œ í™•ì¸)
                syncTransportToDailyData(false);
                saveTransportPlan();
            } else {
                alert(`${tripNum}ì°¨ìˆ˜ëŠ” ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.`);
            }
        }

        // ì°¨ìˆ˜ ì‚­ì œ
        function removeTransportTrip() {
            // ê¶Œí•œ ì²´í¬: ìš´ì†¡ì°¨ìˆ˜ê³„íšì€ Adminë§Œ ì‚¬ìš© ê°€ëŠ¥
            if (userRole !== 'admin') {
                alert('âš ï¸ ê¶Œí•œ ì—†ìŒ\n\nìš´ì†¡ì°¨ìˆ˜ê³„íšì€ ê´€ë¦¬ì(Admin)ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }
            
            const trips = Object.keys(transportPlan).map(Number).sort((a, b) => a - b);
            if (trips.length <= 1) {
                alert('ìµœì†Œ 1ê°œì˜ ì°¨ìˆ˜ëŠ” ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }
            
            if (confirm(`${currentTransportTrip}ì°¨ìˆ˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\ní•´ë‹¹ ì°¨ìˆ˜ì˜ í˜„ì¥ë°°ì†¡ ë°ì´í„°ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.`)) {
                delete transportPlan[currentTransportTrip];
                
                // ë‹¤ë¥¸ ì°¨ìˆ˜ ì„ íƒ
                const remaining = Object.keys(transportPlan).map(Number).sort((a, b) => a - b);
                currentTransportTrip = remaining[0];
                
                renderTransportTrips();
                renderTransportColumnGrid();
                // ìš´ì†¡ì°¨ìˆ˜ê³„íš ë³€ê²½ ì‹œ í˜„ì¥ë°°ì†¡(process 5)ì— ë™ê¸°í™” (ì‚­ì œëœ ì°¨ìˆ˜ì˜ ê¸°ë‘¥ë“¤ë„ ì œê±°ë¨)
                // í™•ì¸ ì—†ì´ ìë™ ë™ê¸°í™” (ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œì—ë§Œ í™•ì¸)
                syncTransportToDailyData(false);
                // í™”ë©´ ì—…ë°ì´íŠ¸
                renderGanttChart();
                renderColumnGrid('column-grid-overview');
                renderColumnGrid('column-grid-input');
                updateProgressBars();
                saveTransportPlan();
            }
        }

        // ì°¨ìˆ˜ ì„ íƒ
        function selectTransportTrip(tripNum) {
            try {
                currentTransportTrip = parseInt(tripNum) || 1;
                if (!transportPlan[currentTransportTrip]) {
                    transportPlan[currentTransportTrip] = { columns: [], date: '' };
                }
                // ì°¨ìˆ˜ ìˆ˜ì • ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸
                const editInput = document.getElementById('transport-trip-edit-input');
                if (editInput) {
                    editInput.value = currentTransportTrip;
                }
                renderTransportTrips();
                renderTransportColumnGrid();
                updateTransportTripInfo();
                // ì°¨ìˆ˜ ì„ íƒì€ ë°ì´í„° ë³€ê²½ì´ ì•„ë‹ˆë¯€ë¡œ ë™ê¸°í™” ë¶ˆí•„ìš”, ì €ì¥ë§Œ ìˆ˜í–‰
                saveTransportPlan(); // ìƒíƒœ ì €ì¥
            } catch (error) {
                console.error('Error in selectTransportTrip:', error);
                alert('ì°¨ìˆ˜ ì„ íƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ì°¨ìˆ˜ ë²ˆí˜¸ ìˆ˜ì •
        function editTransportTrip() {
            // ê¶Œí•œ ì²´í¬: ìš´ì†¡ì°¨ìˆ˜ê³„íšì€ Adminë§Œ ì‚¬ìš© ê°€ëŠ¥
            if (userRole !== 'admin') {
                alert('âš ï¸ ê¶Œí•œ ì—†ìŒ\n\nìš´ì†¡ì°¨ìˆ˜ê³„íšì€ ê´€ë¦¬ì(Admin)ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }
            
            const editInput = document.getElementById('transport-trip-edit-input');
            const newTripNum = parseInt(editInput.value) || 1;
            const oldTripNum = currentTransportTrip;
            
            if (newTripNum === oldTripNum) {
                alert('ë™ì¼í•œ ì°¨ìˆ˜ ë²ˆí˜¸ì…ë‹ˆë‹¤.');
                return;
            }
            
            if (newTripNum < 1) {
                alert('ì°¨ìˆ˜ ë²ˆí˜¸ëŠ” 1 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }
            
            // ìƒˆ ì°¨ìˆ˜ ë²ˆí˜¸ê°€ ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
            if (transportPlan[newTripNum]) {
                if (!confirm(`${newTripNum}ì°¨ìˆ˜ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤. ê¸°ì¡´ ë°ì´í„°ë¥¼ ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    return;
                }
            }
            
            // ê¸°ì¡´ ì°¨ìˆ˜ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const oldTripData = transportPlan[oldTripNum] || { columns: [], date: '' };
            
            // ìƒˆ ì°¨ìˆ˜ ë²ˆí˜¸ë¡œ ë°ì´í„° ì´ë™
            transportPlan[newTripNum] = {
                columns: [...(oldTripData.columns || [])],
                date: oldTripData.date || ''
            };
            
            // ê¸°ì¡´ ì°¨ìˆ˜ ì‚­ì œ
            delete transportPlan[oldTripNum];
            
            // ìƒˆ ì°¨ìˆ˜ ì„ íƒ
            currentTransportTrip = newTripNum;
            
            // UI ì—…ë°ì´íŠ¸
            renderTransportTrips();
            renderTransportColumnGrid();
            updateTransportTripInfo();
            
            // ìš´ì†¡ì°¨ìˆ˜ê³„íš ë³€ê²½ ì‹œ í˜„ì¥ë°°ì†¡(process 5)ì— ë™ê¸°í™” (ì°¨ìˆ˜ ë²ˆí˜¸ ë³€ê²½ ë°˜ì˜)
            // í™•ì¸ ì—†ì´ ìë™ ë™ê¸°í™” (ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œì—ë§Œ í™•ì¸)
            syncTransportToDailyData(false);
            // í™”ë©´ ì—…ë°ì´íŠ¸
            renderGanttChart();
            renderColumnGrid('column-grid-overview');
            renderColumnGrid('column-grid-input');
            updateProgressBars();
            
            saveTransportPlan();
            
            alert(`âœ… ${oldTripNum}ì°¨ìˆ˜ê°€ ${newTripNum}ì°¨ìˆ˜ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.\n\ní˜„ì¥ë°°ì†¡ ë°ì´í„°ë„ ë™ì¼í•˜ê²Œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        }

        // ì°¨ìˆ˜ ì •ë³´ ì—…ë°ì´íŠ¸
        function updateTransportTripInfo() {
            document.getElementById('current-trip-number').textContent = currentTransportTrip;
            const tripData = transportPlan[currentTransportTrip] || { columns: [], date: '' };
            const count = tripData.columns?.length || 0;
            document.getElementById('selected-columns-count').textContent = count;
            
            // ì´ ë¬¼ëŸ‰ ê³„ì‚°
            let totalWeight = 0;
            if (tripData.columns && tripData.columns.length > 0) {
                tripData.columns.forEach(columnId => {
                    totalWeight += calculateColumnWeight(columnId);
                });
            }
            const weightEl = document.getElementById('selected-columns-weight');
            if (weightEl) {
                weightEl.textContent = totalWeight > 0 ? `${totalWeight.toFixed(2)}í†¤` : '0í†¤';
            }
            
            // ë‚ ì§œ ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸
            const dateInput = document.getElementById('transport-trip-date');
            if (dateInput) {
                dateInput.value = tripData.date || '';
            }
        }

        // ì°¨ìˆ˜ ìš´ì†¡ë‚ ì§œ ì—…ë°ì´íŠ¸
        function updateTransportTripDate() {
            const dateInput = document.getElementById('transport-trip-date');
            const date = dateInput.value;
            
            if (!transportPlan[currentTransportTrip]) {
                transportPlan[currentTransportTrip] = { columns: [], date: '' };
            }
            
            transportPlan[currentTransportTrip].date = date;
            renderTransportTrips(); // ë²„íŠ¼ì— ë‚ ì§œ í‘œì‹œ ì—…ë°ì´íŠ¸
            renderTransportColumnGrid(); // ê¸°ë‘¥ cellì— ë‚ ì§œ í‘œì‹œ ì—…ë°ì´íŠ¸
            
            // ìš´ì†¡ë‚ ì§œ ë³€ê²½ ì‹œ ìë™ìœ¼ë¡œ í˜„ì¥ë°°ì†¡(process 5)ì— ë™ê¸°í™”
            // í™•ì¸ ì—†ì´ ìë™ ë™ê¸°í™” (ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œì—ë§Œ í™•ì¸)
            if (date && date.trim() !== '') {
                syncTransportToDailyData(false);
                // í™”ë©´ ì—…ë°ì´íŠ¸
                renderGanttChart();
                renderColumnGrid('column-grid-overview');
                renderColumnGrid('column-grid-input');
                updateProgressBars();
            }
            
            saveTransportPlan();
        }

        // ê¸°ë‘¥ ë¬¼ëŸ‰ ê³„ì‚° í•¨ìˆ˜ (í†¤) - ì—‘ì…€ ì—…ë¡œë“œ ì‹œ ì‹¤ì œ ì¤‘ëŸ‰(kg) ì‚¬ìš©, ì—†ìœ¼ë©´ ê·¼ì‚¬ì¹˜
        function calculateColumnWeight(columnId) {
            if (!transportVolumeData || transportVolumeData.length === 0) {
                return 0;
            }
            
            // columnIdì™€ ë§¤ì¹­ë˜ëŠ” ëª¨ë“  ë¶€ì¬ì˜ ì¤‘ëŸ‰ í•©ì‚° (ë™ì¼ ê¸°ë‘¥ì— ìƒë¶€/í•˜ë¶€ ë“± ì—¬ëŸ¬ í–‰ ìˆì„ ìˆ˜ ìˆìŒ)
            const matched = transportVolumeData.filter(item => {
                const itemNo = item.no != null ? String(item.no).trim() : '';
                if (!itemNo) return false;
                if (typeof columnsMatch === 'function') {
                    return columnsMatch(columnId, itemNo);
                }
                const colStr = typeof columnId === 'number' ? getColumnId(columnId, 1) : String(columnId).trim();
                const colIdx = getColumnIndexFromId(colStr);
                const itemIdx = getColumnIndexFromId(itemNo);
                if (colIdx != null && itemIdx != null && colIdx === itemIdx) {
                    const colSub = getSubIndexFromId(colStr);
                    const itemSub = getSubIndexFromId(itemNo);
                    return (colSub == null && itemSub == null) || colSub === itemSub;
                }
                return colStr === itemNo;
            });
            
            // ì—‘ì…€ì˜ ì‹¤ì œ ì¤‘ëŸ‰(kg) í•©ì‚° í›„ í†¤ìœ¼ë¡œ ë³€í™˜
            let totalKg = 0;
            for (let i = 0; i < matched.length; i++) {
                const item = matched[i];
                const w = item.weight != null ? parseFloat(String(item.weight).replace(/,/g, '')) : NaN;
                if (!isNaN(w) && w > 0) {
                    totalKg += w;
                }
            }
            if (totalKg > 0) {
                return totalKg / 1000; // kg â†’ í†¤
            }
            
            // ë§¤ì¹­ëœ í–‰ì€ ìˆìœ¼ë‚˜ weightê°€ ì—†ì„ ë•Œ: ì²« í–‰ ê¸°ì¤€ ê·¼ì‚¬ì¹˜
            const colData = matched[0];
            if (!colData) {
                return 0;
            }
            
            if (colData.sub && !isNaN(parseFloat(colData.sub))) {
                return parseFloat(colData.sub) / 1000;
            }
            
            const length = parseFloat(colData.length) || 0;
            if (length === 0) return 0;
            
            const sizeStr = String(colData.size || '').toUpperCase();
            let unitWeight = 0;
            const hMatch = sizeStr.match(/H(\d+)/);
            if (hMatch) {
                const hValue = parseInt(hMatch[1]);
                if (hValue <= 400) unitWeight = 66;
                else if (hValue <= 450) unitWeight = 76;
                else if (hValue <= 500) unitWeight = 89;
                else if (hValue <= 600) unitWeight = 106;
                else if (hValue <= 700) unitWeight = 125;
                else unitWeight = 150;
            }
            if (unitWeight === 0) return 0;
            const lengthM = length / 1000;
            return (unitWeight * lengthM) / 1000;
        }

        // ìš´ì†¡ìš© ê¸°ë‘¥ ê·¸ë¦¬ë“œ ë Œë”ë§
        function renderTransportColumnGrid() {
            const container = document.getElementById('column-grid-transport');
            container.innerHTML = '';
            
            const tripData = transportPlan[currentTransportTrip] || { columns: [], date: '' };
            const selectedColumns = tripData.columns || [];
            
            // ê° ê¸°ë‘¥ì´ ì–´ëŠ ì°¨ìˆ˜ì— ì €ì¥ë˜ì–´ ìˆëŠ”ì§€ ì°¾ê¸°
            const columnToTripMap = {}; // { colId: tripNum }
            for (let tripNum in transportPlan) {
                const trip = transportPlan[tripNum];
                if (trip && trip.columns && Array.isArray(trip.columns)) {
                    trip.columns.forEach(col => {
                        // ìˆ«ì, "1C001", "7TC001", "1C" ë“± ëª¨ë“  í˜•ì‹ ì§€ì›
                        let colId = null;
                        if (typeof col === 'number') {
                            // ìˆ«ìë§Œ ìˆëŠ” ê²½ìš° ê¸°ë³¸ ì„œë¸Œ í•­ëª©(001)ìœ¼ë¡œ ë³€í™˜
                            colId = getColumnId(col, 1);
                        } else {
                            const colStr = String(col);
                            // ì´ë¯¸ colId í˜•ì‹ì¸ì§€ í™•ì¸
                            if (colStr.match(/^\d+(?:TC|C)\d+$/i)) {
                                colId = colStr;
                            } else {
                                // "1C" í˜•ì‹ì¸ ê²½ìš° ê¸°ë³¸ ì„œë¸Œ í•­ëª©(001)ìœ¼ë¡œ ë³€í™˜
                                const colNum = parseInt(colStr.replace(/[^0-9]/g, ''));
                                if (colNum) {
                                    colId = getColumnId(colNum, 1);
                                }
                            }
                        }
                        if (colId && !columnToTripMap[colId]) {
                            columnToTripMap[colId] = parseInt(tripNum);
                        }
                    });
                }
            }
            
            // 50ê°œ ê¸°ë‘¥ Ã— 2ê°œ ì„œë¸Œ í•­ëª© = ì´ 100ê°œ
            for (let i = 1; i <= TOTAL_COLUMNS; i++) {
                for (let sub = 1; sub <= SUB_ITEMS_PER_COLUMN; sub++) {
                    const colId = getColumnId(i, sub);
                const div = document.createElement('div');
                div.className = 'column-item';
                
                    // selectedColumnsì—ì„œ colId í˜•ì‹ìœ¼ë¡œ ì°¾ê¸° (ê¸°ì¡´ ìˆ«ì í˜•ì‹ë„ ì§€ì›)
                    const isSelected = selectedColumns.includes(colId) || 
                                      selectedColumns.includes(i) || 
                                      selectedColumns.includes(String(i)) ||
                                      selectedColumns.some(col => {
                                          if (typeof col === 'number') return col === i;
                                          const colStr = String(col);
                                          const colNum = parseInt(colStr.replace(/[^0-9]/g, ''));
                                          return colNum === i;
                                      });
                    
                    const isDuplicate = duplicateColumns[colId] && duplicateColumns[colId].length > 1;
                    const savedInOtherTrip = columnToTripMap[colId] && columnToTripMap[colId] !== currentTransportTrip;
                    const savedTripNum = columnToTripMap[colId];
                
                // ê¸°ë‘¥ ë²ˆí˜¸ì™€ ìš´ì†¡ì¼ì í‘œì‹œ
                const columnLabel = document.createElement('div');
                    columnLabel.textContent = colId;
                columnLabel.style.fontWeight = 'bold';
                columnLabel.style.fontSize = '14px';
                div.appendChild(columnLabel);
                
                // ì„ íƒëœ ê¸°ë‘¥ì¸ ê²½ìš° ìš´ì†¡ì¼ìì™€ ë¬¼ëŸ‰ í‘œì‹œ
                if (isSelected) {
                    // ìš´ì†¡ì¼ì í‘œì‹œ
                    if (tripData.date) {
                        const dateLabel = document.createElement('div');
                        const dateObj = new Date(tripData.date);
                        const formattedDate = `${dateObj.getMonth() + 1}/${dateObj.getDate()}`;
                        dateLabel.textContent = formattedDate;
                        dateLabel.style.fontSize = '11px';
                        dateLabel.style.marginTop = '4px';
                        dateLabel.style.opacity = '0.9';
                        div.appendChild(dateLabel);
                    }
                    
                    // ë¬¼ëŸ‰(í†¤) í‘œì‹œ
                        const weight = calculateColumnWeight(colId);
                    const weightLabel = document.createElement('div');
                    weightLabel.textContent = weight > 0 ? `${weight.toFixed(2)}í†¤` : '0í†¤';
                    weightLabel.style.fontSize = '11px';
                    weightLabel.style.marginTop = '2px';
                    weightLabel.style.opacity = '0.85';
                    weightLabel.style.fontWeight = '600';
                    div.appendChild(weightLabel);
                } else if (savedInOtherTrip) {
                    // ë‹¤ë¥¸ ì°¨ìˆ˜ì— ì €ì¥ëœ ê¸°ë‘¥: ì°¨ìˆ˜ ë²ˆí˜¸ í‘œì‹œ
                    const tripLabel = document.createElement('div');
                    tripLabel.textContent = `${savedTripNum}ì°¨ìˆ˜`;
                    tripLabel.style.fontSize = '12px';
                    tripLabel.style.marginTop = '4px';
                    tripLabel.style.fontWeight = '600';
                    tripLabel.style.color = '#666';
                    div.appendChild(tripLabel);
                }
                
                if (isDuplicate) {
                    // ì¤‘ë³µëœ ê¸°ë‘¥: ë¹¨ê°„ìƒ‰ í…Œë‘ë¦¬ì™€ ë°°ê²½
                    div.style.background = '#ffcdd2';
                    div.style.color = '#c62828';
                    div.style.boxShadow = '0 0 0 3px #f44336, 0 0 15px rgba(244,67,54,0.6)';
                    div.style.fontWeight = 'bold';
                    div.style.border = '2px solid #d32f2f';
                    div.style.display = 'flex';
                    div.style.flexDirection = 'column';
                    div.style.alignItems = 'center';
                    div.style.justifyContent = 'center';
                        div.title = `ì¤‘ë³µ: ${duplicateColumns[colId].map(t => t + 'ì°¨ìˆ˜').join(', ')}ì— í¬í•¨ë¨`;
                } else if (isSelected) {
                    div.style.background = '#4caf50';
                    div.style.color = 'white';
                    div.style.boxShadow = '0 0 0 3px #66bb6a, 0 0 10px rgba(76,175,80,0.5)';
                    div.style.fontWeight = 'bold';
                    div.style.border = 'none';
                    div.style.display = 'flex';
                    div.style.flexDirection = 'column';
                    div.style.alignItems = 'center';
                    div.style.justifyContent = 'center';
                } else if (savedInOtherTrip) {
                    // ë‹¤ë¥¸ ì°¨ìˆ˜ì— ì €ì¥ëœ ê¸°ë‘¥: íšŒìƒ‰ ë°°ê²½, íˆ¬ëª…ë„ 50%
                    div.style.background = 'rgba(158, 158, 158, 0.5)';
                    div.style.color = '#666';
                    div.style.boxShadow = 'none';
                    div.style.border = '1px solid rgba(158, 158, 158, 0.7)';
                    div.style.display = 'flex';
                    div.style.flexDirection = 'column';
                    div.style.alignItems = 'center';
                    div.style.justifyContent = 'center';
                    div.title = `${savedTripNum}ì°¨ìˆ˜ì— ì €ì¥ëœ ê¸°ë‘¥`;
                } else {
                    div.style.background = '#f5f5f5';
                    div.style.color = '#666';
                    div.style.boxShadow = 'none';
                    div.style.border = 'none';
                    div.style.display = 'flex';
                    div.style.alignItems = 'center';
                    div.style.justifyContent = 'center';
                }
                
                div.style.cursor = 'pointer';
                div.style.transition = 'all 0.2s';
                
                div.onmouseenter = function() {
                    if (!isSelected && !savedInOtherTrip) {
                        this.style.background = '#e8f5e9';
                        this.style.transform = 'scale(1.05)';
                    } else if (savedInOtherTrip) {
                        this.style.background = 'rgba(158, 158, 158, 0.7)';
                        this.style.transform = 'scale(1.05)';
                    }
                };
                
                div.onmouseleave = function() {
                    if (!isSelected && !savedInOtherTrip) {
                        this.style.background = '#f5f5f5';
                        this.style.transform = 'scale(1)';
                    } else if (savedInOtherTrip) {
                        this.style.background = 'rgba(158, 158, 158, 0.5)';
                        this.style.transform = 'scale(1)';
                    }
                };
                
                    div.onclick = () => toggleColumnForTransport(colId);
                
                container.appendChild(div);
                }
            }
        }

        // ê¸°ë‘¥ ì„ íƒ/í•´ì œ
        function toggleColumnForTransport(columnId) {
            // ê¶Œí•œ ì²´í¬: ìš´ì†¡ì°¨ìˆ˜ê³„íšì€ Adminë§Œ ì‚¬ìš© ê°€ëŠ¥
            if (userRole !== 'admin') {
                alert('âš ï¸ ê¶Œí•œ ì—†ìŒ\n\nìš´ì†¡ì°¨ìˆ˜ê³„íšì€ ê´€ë¦¬ì(Admin)ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (!transportPlan[currentTransportTrip]) {
                transportPlan[currentTransportTrip] = { columns: [], date: '' };
            }
            
            const tripData = transportPlan[currentTransportTrip];
            if (!tripData.columns) {
                tripData.columns = [];
            }
            if (!tripData.date) {
                tripData.date = '';
            }
            
            const index = tripData.columns.indexOf(columnId);
            
            if (index > -1) {
                // ì´ë¯¸ ì„ íƒëœ ê²½ìš° - ë‹¤ë¥¸ ì°¨ìˆ˜ì— ìˆëŠ”ì§€ í™•ì¸
                let inOtherTrip = false;
                for (let trip in transportPlan) {
                    const otherTripData = transportPlan[trip];
                    if (parseInt(trip) !== currentTransportTrip && otherTripData?.columns?.includes(columnId)) {
                        inOtherTrip = true;
                        break;
                    }
                }
                
                if (!inOtherTrip || confirm('ë‹¤ë¥¸ ì°¨ìˆ˜ì—ë„ í¬í•¨ëœ ê¸°ë‘¥ì…ë‹ˆë‹¤. ì´ ì°¨ìˆ˜ì—ì„œë§Œ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    tripData.columns.splice(index, 1);
                }
            } else {
                // ì„ íƒë˜ì§€ ì•Šì€ ê²½ìš° - ë‹¤ë¥¸ ì°¨ìˆ˜ì— ìˆëŠ”ì§€ í™•ì¸
                let inOtherTrip = false;
                let otherTripNum = null;
                for (let trip in transportPlan) {
                    const otherTripData = transportPlan[trip];
                    if (parseInt(trip) !== currentTransportTrip && otherTripData?.columns?.includes(columnId)) {
                        inOtherTrip = true;
                        otherTripNum = trip;
                        break;
                    }
                }
                
                if (inOtherTrip) {
                    if (confirm(`${otherTripNum}ì°¨ìˆ˜ì— ì´ë¯¸ í¬í•¨ëœ ê¸°ë‘¥ì…ë‹ˆë‹¤. ì´ ì°¨ìˆ˜ì—ë„ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                        tripData.columns.push(columnId);
                    }
                } else {
                    tripData.columns.push(columnId);
                }
            }
            
            // colId í˜•ì‹ìœ¼ë¡œ ì •ë ¬ (ìˆ«ì ë¶€ë¶„ ê¸°ì¤€)
            tripData.columns.sort((a, b) => {
                const numA = getColumnIndexFromId(String(a)) || parseInt(String(a).replace(/[^0-9]/g, '')) || 0;
                const numB = getColumnIndexFromId(String(b)) || parseInt(String(b).replace(/[^0-9]/g, '')) || 0;
                if (numA !== numB) return numA - numB;
                // ê°™ì€ ê¸°ë‘¥ ë²ˆí˜¸ë©´ ì„œë¸Œ ì¸ë±ìŠ¤ë¡œ ì •ë ¬
                const subA = getSubIndexFromId(String(a)) || 1;
                const subB = getSubIndexFromId(String(b)) || 1;
                return subA - subB;
            });
            // ì¤‘ë³µ ì²´í¬ ê²°ê³¼ ì´ˆê¸°í™” (ì„ íƒ ë³€ê²½ ì‹œ)
            duplicateColumns = {};
            document.getElementById('duplicate-check-result').style.display = 'none';
            renderTransportColumnGrid();
            renderTransportTrips();
            updateTransportTripInfo();
            
            // ìš´ì†¡ì°¨ìˆ˜ê³„íš ë³€ê²½ ì‹œ ìë™ìœ¼ë¡œ í˜„ì¥ë°°ì†¡(process 5)ì— ë™ê¸°í™”
            // ê¸°ë‘¥ ì„ íƒ/í•´ì œ ì‹œ í•­ìƒ ë™ê¸°í™” (ë‚ ì§œê°€ ì—†ì–´ë„ ë™ê¸°í™”í•˜ì—¬ ê¸°ì¡´ ë°ì´í„° ì •ë¦¬)
            // í™•ì¸ ì—†ì´ ìë™ ë™ê¸°í™” (ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œì—ë§Œ í™•ì¸)
            syncTransportToDailyData(false);
            // í™”ë©´ ì—…ë°ì´íŠ¸
            renderGanttChart();
            renderColumnGrid('column-grid-overview');
            renderColumnGrid('column-grid-input');
            updateProgressBars();
            
            // ìë™ ì €ì¥ (í™•ì¸ ì—†ì´)
            saveTransportPlan();
        }

        // ìš´ì†¡ë¬¼ëŸ‰ì‚°ì •: í˜„ì¬ ê°’ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì €ì¥
        function setDefaultTransportVolumeData() {
            if (!transportVolumeData || transportVolumeData.length === 0) {
                alert('âš ï¸ ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.\n\në¨¼ì € ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            try {
                // í˜„ì¬ transportVolumeDataë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì €ì¥
                const defaultData = JSON.parse(JSON.stringify(transportVolumeData));
                localStorage.setItem(kcolKey('defaultTransportVolumeData'), JSON.stringify(defaultData));
                
                // adjustedTransportPlanë„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì €ì¥
                if (adjustedTransportPlan && Object.keys(adjustedTransportPlan).length > 0) {
                    const defaultAdjustedPlan = JSON.parse(JSON.stringify(adjustedTransportPlan));
                    localStorage.setItem(kcolKey('defaultAdjustedTransportPlan'), JSON.stringify(defaultAdjustedPlan));
                }
                
                // ì°¨ìˆ˜/ê·œê²© í•„í„° ì´ˆê¸°í™”í•˜ì—¬ ì „ì²´ ë°ì´í„° í‘œì‹œ
                selectedTrips = [];
                selectedSizes = [];
                localStorage.setItem(kcolKey('selectedTrips'), JSON.stringify(selectedTrips));
                localStorage.setItem(kcolKey('selectedSizes'), JSON.stringify(selectedSizes));
                
                // í…Œì´ë¸”Â·í•„í„° í† ê¸€ ë‹¤ì‹œ ë Œë”ë§
                if (typeof renderTransportVolumeTable === 'function') renderTransportVolumeTable();
                if (typeof renderTripFilterToggles === 'function') renderTripFilterToggles();
                if (typeof renderSizeFilterToggles === 'function') renderSizeFilterToggles();
                if (typeof updateAllTripsToggleButtons === 'function') updateAllTripsToggleButtons();
                renderAdjustedTripSummarySafe();
                
                alert('âœ… í˜„ì¬ ë¬¼ëŸ‰ì‚°ì • ê°’ì´ ê¸°ë³¸ê°’ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nì „ì²´ ë°ì´í„°ê°€ í‘œì‹œë©ë‹ˆë‹¤.');
                console.log('âœ… ê¸°ë³¸ê°’ ì €ì¥ ì™„ë£Œ:', defaultData.length, 'ê°œ ë¶€ì¬');
            } catch (error) {
                console.error('ê¸°ë³¸ê°’ ì €ì¥ ì˜¤ë¥˜:', error);
                alert('âŒ ê¸°ë³¸ê°’ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n' + error.message);
            }
        }
        
        // ìš´ì†¡ë¬¼ëŸ‰ì‚°ì •: ê¸°ë³¸ê°’ ë¡œë“œ
        function loadDefaultTransportVolumeData() {
            try {
                const savedDefaultData = localStorage.getItem(kcolKey('defaultTransportVolumeData'));
                if (savedDefaultData) {
                    const parsedData = JSON.parse(savedDefaultData);
                    if (parsedData && parsedData.length > 0) {
                        transportVolumeData = parsedData;
                        localStorage.setItem(kcolKey('transportVolumeData'), JSON.stringify(transportVolumeData));
                        console.log('âœ… ê¸°ë³¸ê°’ ë¡œë“œ ì™„ë£Œ:', transportVolumeData.length, 'ê°œ ë¶€ì¬');
                        
                        // ì°¨ìˆ˜/ê·œê²© í•„í„° ì´ˆê¸°í™”í•˜ì—¬ ì „ì²´ ë°ì´í„° í‘œì‹œ
                        selectedTrips = [];
                        selectedSizes = [];
                        localStorage.setItem(kcolKey('selectedTrips'), JSON.stringify(selectedTrips));
                        localStorage.setItem(kcolKey('selectedSizes'), JSON.stringify(selectedSizes));
                        
                        // ê¸°ë³¸ ì¡°ì •ëœ ì°¨ìˆ˜ê³„íšë„ ë¡œë“œ
                        const savedDefaultAdjustedPlan = localStorage.getItem(kcolKey('defaultAdjustedTransportPlan'));
                        if (savedDefaultAdjustedPlan) {
                            const parsedAdjustedPlan = JSON.parse(savedDefaultAdjustedPlan);
                            if (parsedAdjustedPlan && Object.keys(parsedAdjustedPlan).length > 0) {
                                adjustedTransportPlan = parsedAdjustedPlan;
                                localStorage.setItem(kcolKey('adjustedTransportPlan'), JSON.stringify(adjustedTransportPlan));
                                tripCountDeltas = {}; // ê¸°ë³¸ê°’ ë¡œë“œ ì‹œ ë¶€ì¬ìˆ˜ ì¡°ì • ì´ˆê¸°í™”
                                localStorage.setItem(kcolKey('tripCountDeltas'), JSON.stringify(tripCountDeltas));
                                console.log('âœ… ê¸°ë³¸ ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš ë¡œë“œ ì™„ë£Œ');
                            }
                        }
                        
                        // í…Œì´ë¸” ë Œë”ë§
                        if (typeof renderTransportVolumeTable === 'function') {
                            renderTransportVolumeTable();
                        }
                        renderAdjustedTripSummarySafe();
                        
                        return true;
                    }
                }
            } catch (error) {
                console.error('ê¸°ë³¸ê°’ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
            return false;
        }

        // PDF ì¶œë ¥ íŒ¨ë„: ì„ íƒ ìœ í˜•ë³„ ë¯¸ë¦¬ë³´ê¸° ê°±ì‹ 
        function refreshPdfExportPreview(type) {
            const preview = document.getElementById('pdf-export-preview');
            if (!preview) return;
            type = type || (document.querySelector('input[name="pdfExportType"]:checked')?.value || 'transportVolume');
            preview.innerHTML = '';
            preview.style.position = 'relative';

            if (type === 'gantt') {
                const ganttContainer = document.querySelector('.gantt-container');
                if (ganttContainer) {
                    const title = document.createElement('h4');
                    title.textContent = 'ğŸ“… ê³µì •í‘œ (Gantt)';
                    title.style.cssText = 'margin-bottom:12px;color:#2c4a7c;font-size:16px;';
                    preview.appendChild(title);
                    preview.appendChild(ganttContainer.cloneNode(true));
                } else {
                    preview.innerHTML = '<p style="color:#888;">ê³µì •í‘œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¨ ë’¤ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.</p>';
                }
            } else if (type === 'transportVolume') {
                const tableWrapper = document.getElementById('transport-volume-table-wrapper');
                const stats = document.getElementById('transport-volume-stats');
                const tripSummary = document.getElementById('transport-volume-trip-summary-tbody')?.closest('table')?.parentElement;
                const adjustedSection = document.getElementById('adjusted-transport-volume-trip-summary-tbody')?.closest('table')?.parentElement?.parentElement;
                const title = document.createElement('h4');
                title.textContent = 'ğŸ“¦ ìš´ì†¡ë¬¼ëŸ‰ì‚°ì •';
                title.style.cssText = 'margin-bottom:12px;color:#2c4a7c;font-size:16px;';
                preview.appendChild(title);
                if (tableWrapper) preview.appendChild(tableWrapper.cloneNode(true));
                if (stats) { const st = stats.cloneNode(true); st.style.marginTop = '16px'; preview.appendChild(st); }
                var subTitle = document.createElement('h4');
                subTitle.textContent = 'í˜„ì¬ ìš´ì†¡ì°¨ìˆ˜ê³„íš (13ì°¨)';
                subTitle.style.cssText = 'margin-top:20px;margin-bottom:16px;color:#2c4a7c;font-size:16px;font-weight:600;';
                preview.appendChild(subTitle);
                if (tripSummary) { const ts = tripSummary.cloneNode(true); ts.style.marginTop = '16px'; preview.appendChild(ts); }
                if (adjustedSection) { const adj = adjustedSection.cloneNode(true); adj.style.marginTop = '20px'; preview.appendChild(adj); }
            } else if (type === 'chart') {
                const chartPanel = document.getElementById('panel-chart');
                if (chartPanel) {
                    const clone = chartPanel.cloneNode(true);
                    clone.querySelectorAll('canvas').forEach(c => {
                        const ctx = c.getContext('2d');
                        if (ctx && c.id === 'progressChart' && typeof progressChart !== 'undefined' && progressChart) {
                            try { progressChart.resize(c.offsetWidth, c.offsetHeight); } catch (e) {}
                        }
                    });
                    preview.appendChild(clone);
                } else {
                    preview.innerHTML = '<p style="color:#888;">ì§„í–‰ë¥  ì°¨íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¨ ë’¤ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.</p>';
                }
            } else if (type === 'installation') {
                const progressSummary = document.getElementById('installation-progress-summary');
                const floorPlan = document.getElementById('installation-floor-plan-image');
                const columnList = document.getElementById('installation-column-list');
                const title = document.createElement('h4');
                title.textContent = 'ğŸ—ï¸ í˜„ì¥ì„¤ì¹˜í˜„í™©ë„';
                title.style.cssText = 'margin-bottom:12px;color:#2c4a7c;font-size:16px;';
                preview.appendChild(title);
                if (progressSummary) { const ps = progressSummary.cloneNode(true); ps.style.marginBottom = '16px'; preview.appendChild(ps); }
                if (floorPlan) preview.appendChild(floorPlan.cloneNode(true));
                if (columnList) { const cl = columnList.cloneNode(true); cl.style.marginTop = '16px'; preview.appendChild(cl); }
            }
        }

        function refreshTransportVolumePdfPreview() {
            refreshPdfExportPreview('transportVolume');
        }

        // ì„ íƒí•œ í•­ëª© í•˜ë‚˜ë§Œ PDFë¡œ ì¶œë ¥ (ì¢Œí•˜ë‹¨ ì†¡ë„íŒŒíŠ¸ë„ˆìŠ¤ ë¡œê³ , ìš°ì¸¡í•˜ë‹¨ ì§„í¥ê¸°ì—… ë¡œê³  + ì¶œë ¥ì‹œê°„)
        const PDF_EXPORT_NAMES = { gantt: 'ê³µì •í‘œ', transportVolume: 'ìš´ì†¡ë¬¼ëŸ‰ì‚°ì •', chart: 'ì§„í–‰ë¥ ì°¨íŠ¸', installation: 'í˜„ì¥ì„¤ì¹˜í˜„í™©ë„' };
        const SONGDO_LOGO_PATH = '../../assets/images/ì†¡ë„íŒŒíŠ¸ë„ˆìŠ¤ ë¡œê³  ë””ìì¸.png';
        const JINHUNG_LOGO_PATH = '../../assets/images/ì§„í¥ê¸°ì—….png';

        // ---------- 0x0 ìº¡ì²˜ ë°©ì§€ + ìŠ¬ë¼ì´ìŠ¤(í˜ì´ì§€ë¶„í• ) + í—¤ë”/í‘¸í„° ë°˜ë³µ ----------
        function sleepFrame(times) {
            times = times || 2;
            return new Promise(function(resolve) {
                function step() {
                    if (times-- <= 0) return resolve();
                    requestAnimationFrame(step);
                }
                step();
            });
        }
        function isVisible(el) {
            if (!el) return false;
            var s = window.getComputedStyle(el);
            if (s.display === 'none' || s.visibility === 'hidden' || s.opacity === '0') return false;
            var r = el.getBoundingClientRect();
            return r.width > 0 && r.height > 0;
        }
        function pickVisibleContainer(selectors) {
            for (var i = 0; i < selectors.length; i++) {
                var el = document.querySelector(selectors[i]);
                if (isVisible(el)) return el;
            }
            return null;
        }
        async function ensureTransportVolumePanelVisible() {
            if (typeof showPanel === 'function') showPanel('transportVolume');
            await sleepFrame(2);
        }
        async function ensurePdfPanelVisible(type) {
            if (typeof showPanel === 'function' && type) showPanel(type);
            await sleepFrame(2);
        }

        function canvasCrop(src, y, h) {
            var c = document.createElement('canvas');
            c.width = src.width;
            c.height = h;
            c.getContext('2d').drawImage(src, 0, y, src.width, h, 0, 0, src.width, h);
            return c;
        }
        function canvasToSlices(srcCanvas, sliceHpx) {
            var out = [];
            var y = 0;
            while (y < srcCanvas.height) {
                var h = Math.min(sliceHpx, srcCanvas.height - y);
                if (h < 1) h = 1;
                var c = document.createElement('canvas');
                c.width = srcCanvas.width;
                c.height = h;
                c.getContext('2d').drawImage(srcCanvas, 0, y, srcCanvas.width, h, 0, 0, srcCanvas.width, h);
                out.push(c);
                y += h;
            }
            return out;
        }
        function canvasToSlicesFrom(srcCanvas, startY, sliceHpx) {
            var out = [];
            var y = startY;
            while (y < srcCanvas.height) {
                var h = Math.min(sliceHpx, srcCanvas.height - y);
                if (h < 1) h = 1;
                var c = document.createElement('canvas');
                c.width = srcCanvas.width;
                c.height = h;
                c.getContext('2d').drawImage(srcCanvas, 0, y, srcCanvas.width, h, 0, 0, srcCanvas.width, h);
                out.push(c);
                y += h;
            }
            return out;
        }
        function forceShowForCapture(el) {
            var prev = { display: el.style.display, visibility: el.style.visibility, position: el.style.position, left: el.style.left, top: el.style.top, zIndex: el.style.zIndex, transform: el.style.transform };
            el.style.display = 'block';
            el.style.visibility = 'visible';
            el.style.position = 'fixed';
            el.style.left = '-100000px';
            el.style.top = '0';
            el.style.zIndex = '999999';
            el.style.transform = 'none';
            return function() {
                el.style.display = prev.display;
                el.style.visibility = prev.visibility;
                el.style.position = prev.position;
                el.style.left = prev.left;
                el.style.top = prev.top;
                el.style.zIndex = prev.zIndex;
                el.style.transform = prev.transform;
            };
        }
        // í° ìº”ë²„ìŠ¤ëŠ” PNG ì‹œ "Incomplete or corrupt PNG file" ë°œìƒ â†’ ìŠ¬ë¼ì´ìŠ¤/í—¤ë”ëŠ” JPEG ì‚¬ìš©
        function canvasToPdfDataUrl(canvas) {
            if (!canvas || !canvas.width || !canvas.height) return { dataUrl: '', format: 'JPEG' };
            var pixels = canvas.width * canvas.height;
            var useJpeg = pixels > 150000;
            if (useJpeg) {
                try {
                    var jpeg = canvas.toDataURL('image/jpeg', 0.92);
                    if (jpeg && jpeg.indexOf('data:image/jpeg') === 0) return { dataUrl: jpeg, format: 'JPEG' };
                } catch (e) { /* ignore */ }
            }
            try {
                var png = canvas.toDataURL('image/png');
                if (png && png.indexOf('data:image/png') === 0 && png.length > 200) return { dataUrl: png, format: 'PNG' };
            } catch (e2) { /* ignore */ }
            try {
                var jpeg2 = canvas.toDataURL('image/jpeg', 0.92);
                if (jpeg2 && jpeg2.indexOf('data:image/jpeg') === 0) return { dataUrl: jpeg2, format: 'JPEG' };
            } catch (e3) { /* ignore */ }
            return { dataUrl: '', format: 'JPEG' };
        }

        function findAdjustmentContainer() {
            var needle = 'ì°¨ìˆ˜ì¡°ì •';
            var all = document.querySelectorAll('h1,h2,h3,h4,div,span,td,th');
            for (var i = 0; i < all.length; i++) {
                var text = (all[i].textContent || '').replace(/\s+/g, '');
                if (text.indexOf(needle) !== -1) return (all[i].closest && all[i].closest('section, article, .panel, .panel-content, .content, div')) || all[i];
            }
            return null;
        }

        function drawPdfLogoHeader(pdf, opts) {
            if (!opts.headerDataUrl) return;
            var logoHeaderH = opts.logoHeaderH != null ? opts.logoHeaderH : (opts.headerH || 20);
            pdf.setFillColor(255, 255, 255);
            pdf.rect(0, 0, opts.pageW, opts.topMargin + logoHeaderH, 'F');
            pdf.addImage(opts.headerDataUrl, 'PNG', opts.margin, opts.topMargin, opts.headerW || 80, opts.headerImgH || 18);
        }

        function getJsPDF() {
            if (typeof window === 'undefined') return null;
            return (window.jspdf && window.jspdf.jsPDF) || window.jsPDF || null;
        }

        function loadScript(src) {
            return new Promise(function(resolve, reject) {
                if (document.querySelector('script[src="' + src + '"]')) {
                    resolve();
                    return;
                }
                var s = document.createElement('script');
                s.src = src;
                s.onload = function() { resolve(); };
                s.onerror = function() { reject(new Error('ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨: ' + src)); };
                document.head.appendChild(s);
            });
        }

        async function ensureJsPDFLoaded() {
            if (getJsPDF()) return getJsPDF();
            var jspdfUrl = 'https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js';
            var autotableUrl = 'https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js';
            try {
                await loadScript(jspdfUrl);
                await new Promise(function(r) { setTimeout(r, 50); });
                await loadScript(autotableUrl);
                await new Promise(function(r) { setTimeout(r, 50); });
            } catch (e) {
                console.warn('jsPDF ë™ì  ë¡œë“œ ì‹¤íŒ¨:', e);
            }
            return getJsPDF();
        }

        function getHtml2Canvas() {
            if (typeof window === 'undefined') return null;
            return (typeof window.html2canvas === 'function') ? window.html2canvas : (typeof html2canvas === 'function' ? html2canvas : null);
        }

        async function ensureHtml2CanvasLoaded() {
            if (getHtml2Canvas()) return getHtml2Canvas();
            var urls = [
                'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js',
                'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js'
            ];
            for (var i = 0; i < urls.length; i++) {
                try {
                    await loadScript(urls[i]);
                    await new Promise(function(r) { setTimeout(r, 80); });
                    if (getHtml2Canvas()) return getHtml2Canvas();
                } catch (e) { console.warn('html2canvas CDN ë¡œë“œ ì‹¤íŒ¨:', urls[i], e); }
            }
            return getHtml2Canvas();
        }

        // ---------- PDF ìƒì„±: ì›¹í—¤ë” ë°˜ë³µ + ìŠ¬ë¼ì´ìŠ¤ + ì°¨ìˆ˜ì¡°ì •(ìˆ¨ê¹€ ì‹œ ê°•ì œ í‘œì‹œ í›„ ìº¡ì²˜) ----------
        async function exportPdf(container, fileName, opts) {
            console.log('[PDF] exportPdf CALLED');
            await ensureHtml2CanvasLoaded();
            var h2c = getHtml2Canvas();
            if (!h2c) throw new Error('html2canvasê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•œ ë’¤ ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
            opts = opts || {};
            opts.margin = opts.margin != null ? opts.margin : 10;
            opts.topMargin = opts.topMargin != null ? opts.topMargin : 5;
            opts.headerH = opts.headerH != null ? opts.headerH : 20;
            opts.headerImgH = opts.headerImgH != null ? opts.headerImgH : 18;
            opts.logoHeaderH = opts.logoHeaderH != null ? opts.logoHeaderH : opts.headerH;
            if (!opts.footer && opts.footerInfo === undefined) opts.footer = {};

            await sleepFrame(2);
            var rect = container.getBoundingClientRect();
            var w = Math.ceil(rect.width);
            var h = Math.ceil(container.scrollHeight || rect.height);
            if (!w || !h) throw new Error('ìº¡ì²˜ëœ ì˜ì—­ í¬ê¸°ê°€ 0ì…ë‹ˆë‹¤. íŒ¨ë„ì´ ë³´ì´ëŠ” ìƒíƒœì—ì„œ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');

            var html2canvasOpts = { scale: 2, useCORS: true, allowTaint: true, logging: false, backgroundColor: '#ffffff', width: w, height: h };
            try { html2canvasOpts.windowWidth = w; html2canvasOpts.windowHeight = h; html2canvasOpts.scrollY = -window.scrollY; } catch (e) {}
            var mainCanvas = await h2c(container, html2canvasOpts);
            if (!mainCanvas.width || !mainCanvas.height) throw new Error('html2canvas ê²°ê³¼ê°€ 0ì…ë‹ˆë‹¤.');

            await ensureJsPDFLoaded();
            var jsPDF = getJsPDF();
            if (!jsPDF) throw new Error('jsPDFê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•œ ë’¤ ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
            var pdf = new jsPDF('p', 'mm', 'a4');
            opts.pageW = pdf.internal.pageSize.getWidth();
            opts.pageH = pdf.internal.pageSize.getHeight();
            opts.contentW = opts.pageW - opts.margin * 2;

            var repeatWebHeaderPx = opts.repeatWebHeaderPx != null ? opts.repeatWebHeaderPx : 240;
            var webHeaderPx = Math.min(repeatWebHeaderPx, mainCanvas.height);
            var webHeaderCanvas = canvasCrop(mainCanvas, 0, webHeaderPx);
            var webHeaderOut = canvasToPdfDataUrl(webHeaderCanvas);
            var webHeaderImg = webHeaderOut.dataUrl;
            var webHeaderFormat = webHeaderOut.format || 'JPEG';
            var webHeaderH_mm = (webHeaderCanvas.height * opts.contentW) / webHeaderCanvas.width;
            var startY = webHeaderPx;

            var footerH_mm = 22;
            var gap_mm = 2;
            var bodyTop_mm = opts.topMargin + webHeaderH_mm + gap_mm;
            var usableH_mm = opts.pageH - bodyTop_mm - footerH_mm;
            var sliceH_px = Math.max(1, Math.floor((usableH_mm * mainCanvas.width) / opts.contentW));
            var slices = canvasToSlicesFrom(mainCanvas, startY, sliceH_px);

            var adjustCanvas = null;
            var adjustEl = null;
            if (!opts.skipAdjustment) {
                adjustEl = opts.adjustSelector ? document.querySelector(opts.adjustSelector) : null;
                if (!adjustEl) adjustEl = document.getElementById('panel-transportVolumePdf') || findAdjustmentContainer();
            }
            if (adjustEl) {
                var restore = null;
                if (!isVisible(adjustEl)) restore = forceShowForCapture(adjustEl);
                await sleepFrame(2);
                await new Promise(function(r) { setTimeout(r, 150); });
                var ar = adjustEl.getBoundingClientRect();
                var aw = Math.ceil(ar.width);
                var ah = Math.ceil(adjustEl.scrollHeight || ar.height);
                if (aw > 0 && ah > 0) {
                    var adjScale = opts.adjustScale != null ? opts.adjustScale : 1.3;
                    var adjOpts = { scale: adjScale, useCORS: true, allowTaint: true, logging: false, backgroundColor: '#ffffff', width: aw, height: ah };
                    try { adjOpts.windowWidth = aw; adjOpts.windowHeight = ah; adjOpts.scrollY = -window.scrollY; } catch (e2) {}
                    adjustCanvas = await h2c(adjustEl, adjOpts);
                }
                if (restore) restore();
            }
            if (adjustCanvas && (!adjustCanvas.width || !adjustCanvas.height)) adjustCanvas = null;

            var adjOut = null;
            if (adjustCanvas) {
                adjOut = canvasToPdfDataUrl(adjustCanvas);
                if (!adjOut.dataUrl) {
                    console.warn('[PDF] ì°¨ìˆ˜ì¡°ì • ì´ë¯¸ì§€ ë³€í™˜ ì‹¤íŒ¨ - ì°¨ìˆ˜ì¡°ì • í˜ì´ì§€ ì—†ì´ PDF ì €ì¥í•©ë‹ˆë‹¤.');
                    adjOut = null;
                }
            }
            var totalPages = slices.length + (adjOut ? 1 : 0);

            for (var i = 0; i < slices.length; i++) {
                if (i > 0) pdf.addPage();
                drawPdfLogoHeader(pdf, opts);
                if (webHeaderH_mm > 0 && webHeaderImg) pdf.addImage(webHeaderImg, webHeaderFormat, opts.margin, opts.topMargin, opts.contentW, webHeaderH_mm);
                var sliceCanvas = slices[i];
                var sliceOut = canvasToPdfDataUrl(sliceCanvas);
                if (!sliceOut.dataUrl) throw new Error('ìŠ¬ë¼ì´ìŠ¤ ì´ë¯¸ì§€ ë³€í™˜ ì‹¤íŒ¨ (í˜ì´ì§€ ' + (i + 1) + ')');
                var imgH_mm = (sliceCanvas.height * opts.contentW) / sliceCanvas.width;
                pdf.addImage(sliceOut.dataUrl, sliceOut.format || 'JPEG', opts.margin, bodyTop_mm, opts.contentW, imgH_mm);
                drawPageFooter(pdf, opts, i + 1, totalPages);
            }

            if (adjOut) {
                pdf.addPage();
                drawPdfLogoHeader(pdf, opts);
                if (webHeaderH_mm > 0 && webHeaderImg) pdf.addImage(webHeaderImg, webHeaderFormat, opts.margin, opts.topMargin, opts.contentW, webHeaderH_mm);
                var adjH_mm = (adjustCanvas.height * opts.contentW) / adjustCanvas.width;
                pdf.addImage(adjOut.dataUrl, adjOut.format || 'JPEG', opts.margin, bodyTop_mm, opts.contentW, adjH_mm);
                drawPageFooter(pdf, opts, slices.length + 1, totalPages);
            }
            pdf.save(fileName);
        }

        function drawPageHeader(pdf, opts) {
            if (!opts.headerDataUrl) return;
            var top = (opts.topMargin || 5) + (opts.headerH || 20);
            pdf.setFillColor(255, 255, 255);
            pdf.rect(0, 0, opts.pageW, top, 'F');
            pdf.addImage(opts.headerDataUrl, 'PNG', opts.margin, opts.topMargin, opts.headerW || 80, opts.headerImgH || 18);
        }

        // ---------- 3í˜ì´ì§€ PDF (LIST + ì°¨ìˆ˜ìš”ì•½), ë§¤ í˜ì´ì§€ ë™ì¼ í—¤ë” ----------
        var _transportCaptureRestore = null;
        async function showForCapture(arg) {
            if (arg === true) {
                var listEl = document.getElementById('transport-volume-table-wrapper');
                var sectionEl = document.getElementById('transport-volume-adjustment-section');
                var restores = [];
                if (listEl) {
                    var p1 = { display: listEl.style.display, visibility: listEl.style.visibility };
                    listEl.style.display = 'block';
                    listEl.style.visibility = 'visible';
                    restores.push(function() { listEl.style.display = p1.display; listEl.style.visibility = p1.visibility; });
                }
                if (sectionEl) {
                    var p2 = { display: sectionEl.style.display, visibility: sectionEl.style.visibility };
                    sectionEl.style.display = 'block';
                    sectionEl.style.visibility = 'visible';
                    restores.push(function() { sectionEl.style.display = p2.display; sectionEl.style.visibility = p2.visibility; });
                }
                _transportCaptureRestore = function() { restores.forEach(function(r) { r(); }); _transportCaptureRestore = null; };
                await new Promise(function(r) { requestAnimationFrame(function() { requestAnimationFrame(r); }); });
                return _transportCaptureRestore;
            }
            if (arg === false) {
                if (_transportCaptureRestore) { _transportCaptureRestore(); }
                return;
            }
            if (!arg) throw new Error('ìº¡ì²˜ ëŒ€ìƒ ì—˜ë¦¬ë¨¼íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
            var el = arg;
            var prev = { display: el.style.display, visibility: el.style.visibility, position: el.style.position, left: el.style.left, top: el.style.top };
            var cs = getComputedStyle(el);
            if (cs.display === 'none') el.style.display = 'block';
            el.style.visibility = 'visible';
            el.style.position = 'fixed';
            el.style.left = '0px';
            el.style.top = '0px';
            await new Promise(function(r) { requestAnimationFrame(function() { requestAnimationFrame(r); }); });
            return function() { el.style.display = prev.display; el.style.visibility = prev.visibility; el.style.position = prev.position; el.style.left = prev.left; el.style.top = prev.top; };
        }
        async function captureElAsJpeg(el) {
            await ensureHtml2CanvasLoaded();
            var h2c = getHtml2Canvas();
            if (!h2c) throw new Error('html2canvasê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            var restore = await showForCapture(el);
            var canvas = await h2c(el, { scale: 2.5, useCORS: true, allowTaint: true, logging: false, backgroundColor: '#ffffff' });
            restore();
            if (!canvas || canvas.width === 0 || canvas.height === 0) throw new Error('ìº¡ì²˜ 0ì‚¬ì´ì¦ˆ');
            return { img: canvas.toDataURL('image/jpeg', 0.95), w: canvas.width, h: canvas.height };
        }
        async function captureElAsPng(el, scale) {
            await ensureHtml2CanvasLoaded();
            var h2c = getHtml2Canvas();
            if (!h2c) return '';
            if (scale == null) scale = 2;
            var canvas = await h2c(el, { backgroundColor: null, scale: scale, useCORS: true });
            return canvas ? canvas.toDataURL('image/png') : '';
        }
        function hideHeaderUiForCapture(headerEl) {
            if (!headerEl) return function() {};
            var targets = headerEl.querySelectorAll('button, a, .login, .auth, .header-actions, .home, .logout, select, input');
            var prev = [];
            targets.forEach(function(el) {
                prev.push([el, el.style.display, el.style.visibility]);
                el.style.display = 'none';
                el.style.visibility = 'hidden';
            });
            return function() {
                prev.forEach(function(p) {
                    p[0].style.display = p[1];
                    p[0].style.visibility = p[2];
                });
            };
        }
        async function tryDrawBannerOnPage3(doc) {
            var pageW = doc.internal.pageSize.getWidth();
            var pageH = doc.internal.pageSize.getHeight();
            var bottomMargin = 10;
            var minBannerH = 18;
            var lastY = (doc.lastAutoTable && doc.lastAutoTable.finalY) ? doc.lastAutoTable.finalY : 42;
            var freeH = (pageH - bottomMargin) - lastY;
            if (freeH < minBannerH) return;
            var headerEl = document.querySelector('.header');
            if (!headerEl) return;
            var restore = hideHeaderUiForCapture(headerEl);
            try {
                var img = await captureElAsPng(headerEl, 2);
                if (!img) return;
                var imgProps = await new Promise(function(resolve) {
                    var i = new Image();
                    i.onload = function() { resolve({ width: i.naturalWidth || i.width, height: i.naturalHeight || i.height }); };
                    i.onerror = function() { resolve({ width: 0, height: 0 }); };
                    i.src = img;
                });
                if (!imgProps.width || !imgProps.height) return;
                var targetW = pageW - 20;
                var targetH = targetW * (imgProps.height / imgProps.width);
                if (targetH > freeH) targetH = freeH;
                var finalW = targetH * (imgProps.width / imgProps.height);
                var x = (pageW - finalW) / 2;
                var y = pageH - bottomMargin - targetH;
                doc.addImage(img, 'PNG', x, y, finalW, targetH);
            } finally {
                restore();
            }
        }
        function drawPageHeader3Page(pdf, headerDataUrl, opt) {
            var pageW = pdf.internal.pageSize.getWidth();
            var margin = opt.margin != null ? opt.margin : 10;
            var topMargin = opt.topMargin != null ? opt.topMargin : 6;
            var headerH = opt.headerH != null ? opt.headerH : 18;
            var headerImgH = opt.headerImgH != null ? opt.headerImgH : 12;
            pdf.setFillColor(255, 255, 255);
            pdf.rect(0, 0, pageW, topMargin + headerH, 'F');
            var headerW = pageW - margin * 2;
            pdf.addImage(headerDataUrl, 'PNG', margin, topMargin, headerW, headerImgH);
            pdf.setDrawColor(220);
            pdf.line(margin, topMargin + headerH, pageW - margin, topMargin + headerH);
            return topMargin + headerH + 3;
        }
        function drawBody3Page(pdf, bodyObj, startY, opt) {
            var pageW = pdf.internal.pageSize.getWidth();
            var pageH = pdf.internal.pageSize.getHeight();
            var margin = opt.margin != null ? opt.margin : 10;
            var contentW = pageW - margin * 2;
            var bottomMargin = opt.bottomMargin != null ? opt.bottomMargin : 8;
            var availH = pageH - startY - bottomMargin;
            var imgH = (bodyObj.h * contentW) / bodyObj.w;
            var drawH = imgH > availH ? availH : imgH;
            pdf.addImage(bodyObj.img, 'JPEG', margin, startY, contentW, drawH);
            return startY + drawH;
        }
        function ensureTransportSummaryWrap() {
            var wrap = document.getElementById('transport-summary-wrap');
            if (wrap) return wrap;
            var section = document.getElementById('transport-volume-adjustment-section');
            if (section) return section;
            return null;
        }

        function arrayBufferToBase64(buf) {
            var bytes = new Uint8Array(buf);
            var binary = '';
            for (var i = 0; i < bytes.length; i++) binary += String.fromCharCode(bytes[i]);
            return btoa(binary);
        }

        /** DOM í…Œì´ë¸” â†’ autoTableìš© { head, body } (thead/th â†’ head, tbody/td â†’ body) */
        function tableDomToAutoTable(tableEl) {
            if (!tableEl) return { head: [], body: [] };
            var head = [];
            var body = [];
            var ths = tableEl.querySelectorAll('thead tr th');
            if (ths.length) head.push(Array.prototype.slice.call(ths).map(function(th) { return (th.innerText || '').trim(); }));
            var trs = tableEl.querySelectorAll('tbody tr');
            trs.forEach(function(tr) {
                var tds = tr.querySelectorAll('td');
                body.push(Array.prototype.slice.call(tds).map(function(td) {
                    var span = td.querySelector('span');
                    var spanText = span ? (span.innerText || '').trim() : '';
                    if (spanText) return spanText;
                    var select = td.querySelector('select');
                    if (select) {
                        var clone = td.cloneNode(true);
                        clone.querySelectorAll('select').forEach(function(s) { s.remove(); });
                        var mainText = (clone.innerText || '').trim();
                        if (mainText) return mainText;
                    }
                    return (td.innerText || '').trim();
                }));
            });
            return { head: head, body: body };
        }

        /** í•œê¸€ í°íŠ¸ ë¡œë“œ: /assets/fonts/NotoSansKR-Regular.ttf (ë¡œì»¬ í•„ìˆ˜, base64 â†’ VFS ë“±ë¡ í›„ PDFëŠ” ì™¸ë¶€ ë„¤íŠ¸ì›Œí¬ ë¯¸ì˜ì¡´) */
        async function loadNotoSansFont(doc) {
            var LOCAL = '/assets/fonts/NotoSansKR-Regular.ttf';
            var res = await fetch(LOCAL);
            if (!res.ok) {
                alert([
                    'âŒ NotoSansKR í°íŠ¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
                    'í•„ìˆ˜ ê²½ë¡œ: ' + LOCAL,
                    '',
                    'í•´ê²°:',
                    '1) í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— assets/fonts/ í´ë” ìƒì„±',
                    '2) NotoSansKR-Regular.ttfë¥¼ ê·¸ í´ë”ì— ì¶”ê°€',
                    '3) ë¡œì»¬ ì„œë²„ ì¬ì‹œì‘ í›„ ìœ„ URLì´ ì—´ë¦¬ëŠ”ì§€ í™•ì¸'
                ].join('\n'));
                throw new Error('Font not found: ' + LOCAL + ' (' + res.status + ')');
            }
            var buf = await res.arrayBuffer();
            var b64 = arrayBufferToBase64(buf);
            doc.addFileToVFS('NotoSansKR-Regular.ttf', b64);
            doc.addFont('NotoSansKR-Regular.ttf', 'NotoSansKR', 'normal');
        }

        async function exportTransport_3PagesPDF(fileName, assets, opts) {
            await ensureHtml2CanvasLoaded();
            await ensureJsPDFLoaded();
            var jsPDF = getJsPDF();
            if (!jsPDF) throw new Error('jsPDFê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•œ ë’¤ ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
            var doc = new jsPDF('p', 'mm', 'a4');
            try {
                await loadNotoSansFont(doc);
            } catch (e) {
                alert('í•œê¸€ í°íŠ¸ ë¡œë“œ ì‹¤íŒ¨: ' + (e.message || e) + '\n/assets/fonts/NotoSansKR-Regular.ttf íŒŒì¼ì„ ë„£ì–´ ì£¼ì„¸ìš”.');
                return;
            }
            doc.setFont('NotoSansKR', 'normal');

            if (typeof doc.autoTable !== 'function') {
                alert('jspdf-autotableì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. CDN ìŠ¤í¬ë¦½íŠ¸ í¬í•¨ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
                return;
            }

            var pageW = doc.internal.pageSize.getWidth();
            var pageH = doc.internal.pageSize.getHeight();

            assets = assets || (typeof buildPdfAssets === 'function' ? await buildPdfAssets() : {});
            var logoSongdo = assets.songdoDataUrl || null;
            var logoJinhung = assets.jinhungDataUrl || null;
            var songdoSize = assets.songdoSize || { w: 28, h: 11 };
            var jinhungSize = assets.jinhungSize || { w: 28, h: 11 };

            var header = function(pageNo) {
                if (logoSongdo) doc.addImage(logoSongdo, 'PNG', 12, 8, songdoSize.w, songdoSize.h);
                if (logoJinhung) doc.addImage(logoJinhung, 'PNG', pageW - 12 - jinhungSize.w, 8, jinhungSize.w, jinhungSize.h);
                doc.setFont('NotoSansKR', 'normal');
                doc.setFontSize(14);
                doc.text('ìš´ì†¡ë¬¼ëŸ‰ ë¦¬ìŠ¤íŠ¸', pageW / 2, 14, { align: 'center' });
                doc.setDrawColor(200);
                doc.line(12, 20, pageW - 12, 20);
                doc.setFontSize(9);
                doc.text(String(pageNo), pageW - 12, pageH - 6, { align: 'right' });
            };
            var footer = function() {
                var printed = new Date();
                var txt = 'Printed: ' + printed.getFullYear() + '-' + String(printed.getMonth() + 1).padStart(2, '0') + '-' + String(printed.getDate()).padStart(2, '0') + ' ' + String(printed.getHours()).padStart(2, '0') + ':' + String(printed.getMinutes()).padStart(2, '0');
                doc.setFont('NotoSansKR', 'normal');
                doc.setFontSize(9);
                doc.text(txt, 12, pageH - 6);
            };

            var listTableOpts = {
                startY: 22,
                margin: { left: 10, right: 10, top: 14, bottom: 8 },
                styles: {
                    font: 'NotoSansKR',
                    fontSize: 7,
                    cellPadding: 0.5,
                    overflow: 'ellipsize',
                    lineWidth: 0.1
                },
                headStyles: {
                    font: 'NotoSansKR',
                    fontSize: 7,
                    cellPadding: 0.5
                },
                columnStyles: { 4: { halign: 'right' }, 5: { halign: 'right' } },
                didDrawPage: function() { footer(); }
            };

            if (typeof ensureTransportVolumePanelVisible === 'function') await ensureTransportVolumePanelVisible();
            await new Promise(function(r) { setTimeout(r, 100); });
            if (typeof renderTransportVolumeTripSummary === 'function') renderTransportVolumeTripSummary();
            if (typeof renderAdjustedTripSummarySafe === 'function') renderAdjustedTripSummarySafe();
            renderTransportVolumeTable();
            await new Promise(function(r) { setTimeout(r, 150); });

            renderTransportVolumeTable({ startIndex: 0, endIndex: 55 });
            await new Promise(function(r) { requestAnimationFrame(function() { requestAnimationFrame(r); }); });
            var tableEl = document.querySelector('#transport-volume-table-wrapper table');
            var t1 = tableDomToAutoTable(tableEl);
            header(1);
            doc.autoTable({
                head: t1.head,
                body: t1.body,
                startY: listTableOpts.startY,
                margin: listTableOpts.margin,
                styles: listTableOpts.styles,
                headStyles: listTableOpts.headStyles,
                columnStyles: listTableOpts.columnStyles,
                didDrawPage: listTableOpts.didDrawPage
            });

            doc.addPage();
            renderTransportVolumeTable({ startIndex: 55, endIndex: 100 });
            await new Promise(function(r) { requestAnimationFrame(function() { requestAnimationFrame(r); }); });
            var t2 = tableDomToAutoTable(document.querySelector('#transport-volume-table-wrapper table'));
            header(2);
            doc.autoTable({
                head: t2.head,
                body: t2.body,
                startY: listTableOpts.startY,
                margin: listTableOpts.margin,
                styles: listTableOpts.styles,
                headStyles: listTableOpts.headStyles,
                columnStyles: listTableOpts.columnStyles,
                didDrawPage: listTableOpts.didDrawPage
            });

            var statsY = (doc.lastAutoTable && doc.lastAutoTable.finalY) ? doc.lastAutoTable.finalY + 6 : 200;
            var totalWeightEl = document.getElementById('total-weight');
            var totalCountEl = document.getElementById('total-count');
            var averageWeightEl = document.getElementById('average-weight');
            var totalWeightStr = totalWeightEl ? (totalWeightEl.innerText || '').trim() : '0 kg';
            var totalCountStr = totalCountEl ? (totalCountEl.innerText || '').trim() : '0 ê°œ';
            var averageWeightStr = averageWeightEl ? (averageWeightEl.innerText || '').trim() : '0 kg';
            doc.setFont('NotoSansKR', 'normal');
            doc.setFontSize(9);
            doc.text('ì „ì²´í•©ì‚°ì¤‘ëŸ‰: ' + totalWeightStr, 12, statsY);
            doc.text('ì´ë¶€ì¬ìˆ˜: ' + totalCountStr, 12, statsY + 5);
            doc.text('ë¶€ì¬ 1ê°œë‹¹ í‰ê· ì¤‘ëŸ‰: ' + averageWeightStr, 12, statsY + 10);

            doc.addPage();
            header(3);
            doc.setFont('NotoSansKR', 'normal');
            doc.setFontSize(12);
            doc.text('ìš´ì†¡ì°¨ìˆ˜ê³„íš(13ì°¨)', 12, 28);
            doc.setFontSize(10);
            doc.text('ìµœëŒ€ìš´ì†¡ 25í†¤ ì´ˆê³¼ ì‹œ ì°¨ìˆ˜ ì¡°ì • í•„ìš”', 12, 36);

            var summaryTables = document.querySelectorAll('#transport-volume-adjustment-section table');
            var startY = 42;
            for (var i = 0; i < summaryTables.length; i++) {
                var s = tableDomToAutoTable(summaryTables[i]);
                if (s.body.length || (s.head && s.head[0] && s.head[0].length)) {
                    doc.autoTable({
                        head: s.head,
                        body: s.body,
                        startY: startY,
                        margin: { left: 10, right: 10, top: 18, bottom: 10 },
                        styles: { font: 'NotoSansKR', fontSize: 7.5, cellPadding: 1, overflow: 'ellipsize', lineWidth: 0.1 },
                        headStyles: { font: 'NotoSansKR', fontSize: 7.5, cellPadding: 1 }
                    });
                    startY = doc.lastAutoTable.finalY + 6;
                }
            }
            await tryDrawBannerOnPage3(doc);
            footer();

            renderTransportVolumeTable();

            var name = fileName || 'ìš´ì†¡ë¬¼ëŸ‰_ë¦¬ìŠ¤íŠ¸_50-50_ìš”ì•½.pdf';
            doc.save(name);
            try {
                var blob = doc.output('blob');
                var url = URL.createObjectURL(blob);
                window.open(url, '_blank');
                setTimeout(function() { URL.revokeObjectURL(url); }, 30000);
            } catch (e) { console.warn('PDF ìƒˆ íƒ­ ì—´ê¸°:', e); }
        }

        function drawPageFooter(pdf, opts, pageIndex, totalPages) {
            var footer = opts.footerInfo || opts.footer || {};
            pdf.setFontSize(10);
            pdf.setTextColor(60, 60, 60);
            pdf.text('PAGE ' + pageIndex + ' of ' + totalPages, opts.pageW - opts.margin, 10, { align: 'right' });
            if (footer.timeStr) {
                pdf.setFontSize(9);
                pdf.setTextColor(80, 80, 80);
                pdf.text('Printed: ' + footer.timeStr, opts.pageW / 2, opts.pageH - 10, { align: 'center' });
            }
            if (footer.songdoDataUrl && footer.songdoSize) {
                pdf.addImage(footer.songdoDataUrl, 'PNG', opts.margin, opts.pageH - 18, footer.songdoSize.w, footer.songdoSize.h);
            }
            if (footer.jinhungDataUrl && footer.jinhungSize) {
                pdf.addImage(footer.jinhungDataUrl, 'PNG', opts.pageW - opts.margin - footer.jinhungSize.w, opts.pageH - 18, footer.jinhungSize.w, footer.jinhungSize.h);
            }
        }

        function makePdfFileName(type) {
            var now = new Date();
            var dateStr = now.toISOString().split('T')[0].replace(/-/g, '');
            return (PDF_EXPORT_NAMES[type] || type) + '_' + dateStr + '.pdf';
        }

        function getPdfContainerForType(type) {
            if (type === 'gantt') return document.getElementById('panel-gantt');
            if (type === 'transportVolume') return document.getElementById('panel-transportVolume');
            if (type === 'chart') return document.getElementById('panel-chart');
            if (type === 'installation') return document.getElementById('panel-installation');
            return null;
        }

        async function buildPdfAssets() {
            await ensureHtml2CanvasLoaded();
            var now = new Date();
            var timeStr = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0') + ' ' + String(now.getHours()).padStart(2, '0') + ':' + String(now.getMinutes()).padStart(2, '0');
            var headerDataUrl = '';
            try {
                var headerDiv = document.createElement('div');
                headerDiv.style.cssText = 'position:fixed;left:-9999px;top:0;width:400px;padding:8px 12px;background:#fff;color:#000;font-family:Malgun Gothic,Apple SD Gothic Neo,sans-serif;';
                // PDF í—¤ë”: ì§€ë•/ìœ ì„/ì£¼ì‹  í¬í•¨ (ë˜ëŒë¦¼ ìœ ì§€)
                headerDiv.innerHTML = '<div style="font-size:16px;font-weight:bold;margin-bottom:4px;">K-COLUMN ê³µì •ê´€ë¦¬ ì‹œìŠ¤í…œ</div><div style="font-size:11px;margin-bottom:2px;">K-COLUMN 100ê°œ (ìƒë¶€ 50)+(í•˜ë¶€ 50) ì œì‘ ë° ì„¤ì¹˜ ê³µì •</div><div style="font-size:10px;">ìë£Œí˜‘ì¡° : (ì£¼) ì§€ë•ì´ì—”ì§€ / (ì£¼) ìœ ì„ì² ê°•ì‚°ì—… / (ì£¼) ì£¼ì‹ ì‚°ì—…</div>';
                document.body.appendChild(headerDiv);
                var h2c = getHtml2Canvas();
                var headerCanvas = h2c ? await h2c(headerDiv, { scale: 2, useCORS: true, logging: false, backgroundColor: '#ffffff' }) : null;
                if (headerCanvas) headerDataUrl = headerCanvas.toDataURL('image/png');
                document.body.removeChild(headerDiv);
            } catch (e) { console.warn('PDF header image:', e); }
            var logo = new Image();
            var jinhungLogo = new Image();
            logo.src = SONGDO_LOGO_PATH;
            jinhungLogo.src = JINHUNG_LOGO_PATH;
            await Promise.all([
                new Promise(function(r) { logo.onload = r; logo.onerror = r; if (logo.complete) r(); }),
                new Promise(function(r) { jinhungLogo.onload = r; jinhungLogo.onerror = r; if (jinhungLogo.complete) r(); })
            ]);
            function imgToDataUrl(img) {
                var c = document.createElement('canvas');
                c.width = img.naturalWidth || img.width;
                c.height = img.naturalHeight || img.height;
                if (c.width && c.height) {
                    var ctx = c.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    return c.toDataURL('image/png');
                }
                return '';
            }
            function sizeToFitMm(nw, nh, maxH) {
                if (!nw || !nh) return { w: 28, h: 11 };
                var aspect = nw / nh;
                var h = maxH;
                var w = h * aspect;
                if (w > 50) { w = 50; h = w / aspect; }
                return { w: Math.round(w * 10) / 10, h: Math.round(h * 10) / 10 };
            }
            var songdoDataUrl = imgToDataUrl(logo);
            var jinhungDataUrl = imgToDataUrl(jinhungLogo);
            var songdoSize = sizeToFitMm(logo.naturalWidth, logo.naturalHeight, 14);
            var jinhungSize = sizeToFitMm(jinhungLogo.naturalWidth, jinhungLogo.naturalHeight, 12);
            return { headerDataUrl: headerDataUrl, songdoDataUrl: songdoDataUrl, jinhungDataUrl: jinhungDataUrl, timeStr: timeStr, songdoSize: songdoSize, jinhungSize: jinhungSize };
        }

        // PDF 1í˜ì´ì§€ìš© containerë¥¼ ë™ê¸°ì ìœ¼ë¡œë§Œ êµ¬ì„±í•˜ì—¬ HTML ë¬¸ìì—´ ë°˜í™˜ (ë³´ê¸°/ë³µì‚¬ìš©)
        function buildPdfExportContainerSync(type) {
            type = type || (document.querySelector('input[name="pdfExportType"]:checked')?.value || 'transportVolume');
            var container = document.createElement('div');
            container.id = 'pdf-export-source';
            container.style.cssText = 'position:fixed;left:-9999px;top:0;width:1120px;padding:30px;padding-bottom:140px;background:#fff;font-family:Malgun Gothic,Segoe UI,Arial,sans-serif;';

            if (type === 'gantt') {
                var ganttContainer = document.querySelector('.gantt-container');
                if (!ganttContainer) return null;
                var h = document.createElement('h3');
                h.textContent = 'ğŸ“… ê³µì •í‘œ (Gantt)';
                h.style.cssText = 'margin-bottom:16px;color:#2c4a7c;font-size:18px;';
                container.appendChild(h);
                container.appendChild(ganttContainer.cloneNode(true));
            } else if (type === 'transportVolume') {
                var tableWrapper = document.getElementById('transport-volume-table-wrapper');
                var stats = document.getElementById('transport-volume-stats');
                if (!tableWrapper || !stats) return null;
                function replaceSelectsWithTextForPdf(node) {
                    if (!node) return;
                    node.querySelectorAll('select.trip-select-no-scrollbar').forEach(function(sel) {
                        var span = document.createElement('span');
                        var opt = sel.options[sel.selectedIndex];
                        span.textContent = opt ? opt.text : 'ï¼';
                        span.style.cssText = 'font-size:10px;';
                        sel.parentNode.replaceChild(span, sel);
                    });
                    node.querySelectorAll('select[onchange*="adjustAdjustedTripCount"]').forEach(function(sel) {
                        var span = document.createElement('span');
                        span.textContent = sel.value ? sel.value : '';
                        span.style.cssText = 'font-size:10px;';
                        sel.parentNode.replaceChild(span, sel);
                    });
                }
                var h = document.createElement('h3');
                h.textContent = 'ğŸ“¦ ìš´ì†¡ë¬¼ëŸ‰ì‚°ì •';
                h.style.cssText = 'margin-bottom:16px;color:#2c4a7c;font-size:18px;';
                container.appendChild(h);
                var tbl = tableWrapper.cloneNode(true);
                replaceSelectsWithTextForPdf(tbl);
                tbl.style.marginBottom = '20px';
                container.appendChild(tbl);
                container.appendChild(stats.cloneNode(true));
            } else if (type === 'chart') {
                var progressChartEl = document.getElementById('progressChart');
                var companyChartEl = document.getElementById('companyChart');
                if (!progressChartEl || !companyChartEl) return null;
                var h = document.createElement('h3');
                h.textContent = 'ğŸ“ˆ ì§„í–‰ë¥  ì°¨íŠ¸';
                h.style.cssText = 'margin-bottom:16px;color:#2c4a7c;font-size:18px;';
                container.appendChild(h);
                var wrap = document.createElement('div');
                wrap.style.cssText = 'display:flex;flex-direction:column;gap:20px;';
                function copyCanvas(src, dest) {
                    dest.width = src.width; dest.height = src.height;
                    var ctx = dest.getContext('2d');
                    if (ctx) ctx.drawImage(src, 0, 0);
                }
                var div1 = document.createElement('div');
                div1.className = progressChartEl.parentElement ? progressChartEl.parentElement.className : '';
                div1.style.cssText = progressChartEl.parentElement ? (progressChartEl.parentElement.getAttribute('style') || '') : '';
                var cap1 = progressChartEl.cloneNode(false);
                copyCanvas(progressChartEl, cap1);
                div1.appendChild(cap1);
                wrap.appendChild(div1);
                var div2 = document.createElement('div');
                div2.className = companyChartEl.parentElement ? companyChartEl.parentElement.className : '';
                div2.style.cssText = companyChartEl.parentElement ? (companyChartEl.parentElement.getAttribute('style') || '') : '';
                var cap2 = companyChartEl.cloneNode(false);
                copyCanvas(companyChartEl, cap2);
                div2.appendChild(cap2);
                wrap.appendChild(div2);
                container.appendChild(wrap);
            } else if (type === 'installation') {
                var progressSummary = document.getElementById('installation-progress-summary');
                var floorPlan = document.getElementById('installation-floor-plan-image');
                var columnList = document.getElementById('installation-column-list');
                if (!floorPlan) return null;
                var h = document.createElement('h3');
                h.textContent = 'ğŸ—ï¸ í˜„ì¥ì„¤ì¹˜í˜„í™©ë„';
                h.style.cssText = 'margin-bottom:16px;color:#2c4a7c;font-size:18px;';
                container.appendChild(h);
                if (progressSummary) container.appendChild(progressSummary.cloneNode(true));
                container.appendChild(floorPlan.cloneNode(true));
                if (columnList) { var cl = columnList.cloneNode(true); cl.style.marginTop = '16px'; container.appendChild(cl); }
            } else {
                return null;
            }
            return container;
        }

        function showPdfExportHtml() {
            var type = document.querySelector('input[name="pdfExportType"]:checked')?.value || 'transportVolume';
            var container = buildPdfExportContainerSync(type);
            var wrap = document.getElementById('pdf-export-html-wrap');
            var ta = document.getElementById('pdf-export-html-textarea');
            if (!wrap || !ta) return;
            if (!container) {
                alert('ì„ íƒí•œ í•­ëª©ì˜ ë‚´ìš©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í•´ë‹¹ íŒ¨ë„ì„ ë¨¼ì € ì—´ì–´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¨ ë’¤ ì‹œë„í•˜ì„¸ìš”.');
                return;
            }
            ta.value = container.innerHTML;
            wrap.style.display = 'block';
            ta.focus();
        }

        function copyPdfExportHtmlToClipboard() {
            var ta = document.getElementById('pdf-export-html-textarea');
            if (!ta || !ta.value) return;
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(ta.value).then(function() {
                    if (typeof showToast === 'function') showToast('HTMLì„ í´ë¦½ë³´ë“œì— ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.');
                    else alert('í´ë¦½ë³´ë“œì— ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.');
                }).catch(function() {
                    fallbackCopy(ta);
                });
            } else {
                fallbackCopy(ta);
            }
        }
        function fallbackCopy(ta) {
            ta.select();
            try {
                document.execCommand('copy');
                if (typeof showToast === 'function') showToast('HTMLì„ í´ë¦½ë³´ë“œì— ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.');
                else alert('í´ë¦½ë³´ë“œì— ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.');
            } catch (e) {
                alert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìœ„ í…ìŠ¤íŠ¸ë¥¼ ì§ì ‘ ì„ íƒí•´ ë³µì‚¬í•˜ì„¸ìš”.');
            }
        }

        async function exportSelectedPdf() {
            var type = document.querySelector('input[name="pdfExportType"]:checked')?.value || 'transportVolume';
            await ensureHtml2CanvasLoaded();
            if (!getHtml2Canvas()) {
                alert('html2canvasê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•œ ë’¤ ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
                return;
            }
            await ensurePdfPanelVisible(type);
            var panelId = (type === 'transportVolume') ? 'transportVolume' : type;
            var container = pickVisibleContainer(['#panel-' + panelId]) || getPdfContainerForType(type);
            if (!container) {
                alert('ì„ íƒí•œ í•­ëª©ì˜ íŒ¨ë„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í•´ë‹¹ íƒ­ì„ ë¨¼ì € ì—´ì–´ ì£¼ì„¸ìš”.');
                return;
            }
            if (!isVisible(container) && type === 'transportVolume') await ensureTransportVolumePanelVisible();
            var fileName = makePdfFileName(type);
            var assets = await buildPdfAssets();
            var opts = {
                headerDataUrl: assets.headerDataUrl,
                headerW: 80,
                headerImgH: 18,
                footer: {
                    songdoDataUrl: assets.songdoDataUrl,
                    jinhungDataUrl: assets.jinhungDataUrl,
                    timeStr: assets.timeStr,
                    songdoSize: assets.songdoSize,
                    jinhungSize: assets.jinhungSize
                }
            };
            try {
                await (typeof ensureJsPDFLoaded === 'function' ? ensureJsPDFLoaded() : Promise.resolve());
                if (!getJsPDF()) throw new Error('jsPDFê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•œ ë’¤ ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
                if (type === 'transportVolume') {
                    await exportTransport_3PagesPDF(fileName, assets, opts);
                } else {
                    opts.skipAdjustment = true;
                    await exportPdf(container, fileName, opts);
                }
                if (typeof savePdfExportLog === 'function') savePdfExportLog(type, fileName, assets.timeStr);
                var historyWrap = document.getElementById('pdf-export-history-wrap');
                if (historyWrap && historyWrap.style.display !== 'none' && typeof loadPdfExportHistory === 'function') loadPdfExportHistory();
            } catch (e) {
                console.error('PDF ìƒì„± ì˜¤ë¥˜:', e);
                alert('PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (e.message || e));
            }
        }

        async function savePdfExportLog(type, fileName, timeStr) {
            if (!window.PROJECT_ID || !initFirebase() || !firebaseAuth?.currentUser) return;
            try {
                const uid = firebaseAuth.currentUser.uid;
                const email = firebaseAuth.currentUser.email || '';
                await firebaseDb.collection('projects').doc(window.PROJECT_ID).collection('pdfLogs').add({
                    type: type,
                    typeName: PDF_EXPORT_NAMES[type] || type,
                    fileName: fileName,
                    outputTime: timeStr,
                    userId: uid,
                    userEmail: email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (e) {
                console.warn('PDF ì¶œë ¥ ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨:', e);
            }
        }

        async function loadPdfExportHistory() {
            const listEl = document.getElementById('pdf-export-history-list');
            if (!listEl || !window.PROJECT_ID || !initFirebase()) return;
            try {
                const snap = await firebaseDb.collection('projects').doc(window.PROJECT_ID).collection('pdfLogs')
                    .orderBy('createdAt', 'desc').limit(50).get();
                if (snap.empty) {
                    listEl.innerHTML = '<p style="color:#888;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }
                let html = '<table style="width:100%;border-collapse:collapse;font-size:11px;"><thead><tr><th style="text-align:left;padding:4px;border-bottom:1px solid #ccc;">Printed</th><th style="text-align:left;padding:4px;border-bottom:1px solid #ccc;">í•­ëª©</th><th style="text-align:left;padding:4px;border-bottom:1px solid #ccc;">íŒŒì¼ëª…</th><th style="text-align:left;padding:4px;border-bottom:1px solid #ccc;">ì‚¬ìš©ì</th></tr></thead><tbody>';
                snap.docs.forEach(d => {
                    const d_ = d.data();
                    const time = d_.outputTime || (d_.createdAt && d_.createdAt.toDate ? d_.createdAt.toDate().toLocaleString('ko-KR') : '-');
                    html += '<tr><td style="padding:4px;border-bottom:1px solid #eee;">' + (time || '-') + '</td><td style="padding:4px;border-bottom:1px solid #eee;">' + (d_.typeName || d_.type || '') + '</td><td style="padding:4px;border-bottom:1px solid #eee;">' + (d_.fileName || '') + '</td><td style="padding:4px;border-bottom:1px solid #eee;">' + (d_.userEmail || d_.userId || '-') + '</td></tr>';
                });
                html += '</tbody></table>';
                listEl.innerHTML = html;
            } catch (e) {
                console.warn('PDF ì¶œë ¥ ê¸°ë¡ ë¡œë“œ ì‹¤íŒ¨:', e);
                listEl.innerHTML = '<p style="color:#c00;">ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
        }

        async function printTransportVolumeToPdf() {
            document.querySelector('input[name="pdfExportType"][value="transportVolume"]')?.click();
            await exportSelectedPdf();
        }

        async function exportTransportVolumePanelPdf() {
            var panel = document.getElementById('panel-transportVolume');
            if (!panel || !panel.offsetParent) {
                alert('ìš´ì†¡ë¬¼ëŸ‰ì‚°ì • íŒ¨ë„ì´ ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤. í•´ë‹¹ íƒ­ì„ ë¨¼ì € ì—´ì–´ ì£¼ì„¸ìš”.');
                return;
            }
            try {
                await ensureHtml2CanvasLoaded();
                var h2c = getHtml2Canvas();
                if (!h2c) {
                    alert('html2canvasê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•œ ë’¤ ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
                    return;
                }
                await ensureJsPDFLoaded();
                var jsPDF = getJsPDF();
                if (!jsPDF) {
                    alert('jsPDFê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•œ ë’¤ ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
                    return;
                }
                var canvas = await h2c(panel, { scale: 2, useCORS: true, allowTaint: true, logging: false, backgroundColor: '#ffffff' });
                if (!canvas || !canvas.width || !canvas.height) {
                    alert('í™”ë©´ ìº¡ì²˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    return;
                }
                var imgData = canvas.toDataURL('image/jpeg', 0.9);
                var w = canvas.width;
                var h = canvas.height;
                var pdf = new jsPDF('p', 'mm', 'a4');
                var pageW = pdf.internal.pageSize.getWidth();
                var pageH = pdf.internal.pageSize.getHeight();
                var margin = 10;
                var contentW = pageW - margin * 2;
                var contentH = pageH - margin * 2;
                var imgW = contentW;
                var imgH = (h / w) * imgW;
                if (imgH > contentH) {
                    imgH = contentH;
                    imgW = (w / h) * imgH;
                }
                pdf.addImage(imgData, 'JPEG', margin, margin, imgW, imgH);
                var dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                var fileName = 'ìš´ì†¡ë¬¼ëŸ‰ì‚°ì •_ì´í™”ë©´_' + dateStr + '.pdf';
                pdf.save(fileName);
            } catch (e) {
                alert('PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (e.message || e));
            }
        }

        // ìš´ì†¡ë¬¼ëŸ‰ì‚°ì •: í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ
        function downloadTransportVolumeTemplate() {
            const headers = ['ê³µì¢…', 'ë„ë©´ë²ˆí˜¸', 'ê¸°ë‘¥ë²ˆí˜¸', 'ê·œê²©', 'ê¸¸ì´(mm)', 'ì¤‘ëŸ‰(kg)', 'ìš´ì†¡ì°¨ìˆ˜ê³„íš(13ì°¨)', 'ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš(12ì°¨)'];
            const sample = [
                ['ê¸°ë‘¥', 'DWG-001', '1C001', 'H-400x200x8x13', '12000', '850', '13', '12'],
                ['ê¸°ë‘¥', 'DWG-002', '1C002', 'H-350x175x7x11', '11500', '720', '13', '12']
            ];
            const csv = [headers.join(','), ...sample.map(r => r.join(','))].join('\n');
            const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            const dateStr = new Date().toISOString().split('T')[0].replace(/-/g, '');
            link.download = `ìš´ì†¡ë¬¼ëŸ‰ì‚°ì •_í…œí”Œë¦¿_${dateStr}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        
        // 25í†¤ìœ¼ë¡œ ì¡°ì • í•¨ìˆ˜
        function adjustTo25Ton() {
            if (!transportVolumeData || transportVolumeData.length === 0) {
                alert('âš ï¸ ìš´ì†¡ë¬¼ëŸ‰ì‚°ì • ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.\n\në¨¼ì € ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // í•­ìƒ ì—‘ì…€ ìˆœì„œëŒ€ë¡œ ì¤‘ëŸ‰ì„ í•©ì‚°í•˜ì—¬ 25í†¤ ê¸°ì¤€ìœ¼ë¡œ ì°¨ìˆ˜ ë°°ì¹˜
            // ê° ì°¨ìˆ˜ë³„ë¡œ 25í†¤ì— ë§ê²Œ ê¸°ë‘¥ ì¬ë°°ì¹˜ (ìˆœì„œëŒ€ë¡œ í•©ì‚°)
            const adjustedPlan = {}; // { tripNum: { columns: [], date: '', totalWeight: 0 } }
            const allColumns = []; // ëª¨ë“  ê¸°ë‘¥ê³¼ ì¤‘ëŸ‰ ì •ë³´ (ìˆœì„œëŒ€ë¡œ)
            
            // ì—‘ì…€ ì›ë³¸ ìˆœì„œ ìœ ì§€ (ì—‘ì…€ìˆœì„œ í•„ë“œë¡œ ì •ë ¬)
            const sortedData = [...transportVolumeData].sort((a, b) => {
                const orderA = a.ì—‘ì…€ìˆœì„œ !== undefined ? a.ì—‘ì…€ìˆœì„œ : 999999;
                const orderB = b.ì—‘ì…€ìˆœì„œ !== undefined ? b.ì—‘ì…€ìˆœì„œ : 999999;
                return orderA - orderB;
            });
            
            // ëª¨ë“  ê¸°ë‘¥ì˜ ì¤‘ëŸ‰ ì •ë³´ ìˆ˜ì§‘ (ì—‘ì…€ ìˆœì„œëŒ€ë¡œ)
            sortedData.forEach(item => {
                const colId = item.no || '';
                if (!colId) return;
                
                const weight = parseFloat(String(item.weight).replace(/,/g, '')) || 0; // kg (ì²œ ë‹¨ìœ„ êµ¬ë¶„ ê¸°í˜¸ ì œê±°)
                if (weight <= 0) return;
                
                allColumns.push({
                    colId: colId,
                    weightKg: weight // kg ë‹¨ìœ„ë¡œ ì €ì¥
                });
            });
            
            // ìˆœì„œëŒ€ë¡œ í•©ì‚°í•˜ì—¬ 25í†¤(25,000kg) ê¸°ì¤€ìœ¼ë¡œ ì°¨ìˆ˜ ë°°ì¹˜ (1ì°¨ë¶€í„° ì‹œì‘)
            let currentTripNum = 1;
            const MAX_WEIGHT_KG = 25000; // 25í†¤ = 25,000kg
            
            allColumns.forEach(col => {
                // í˜„ì¬ ì°¨ìˆ˜ê°€ ì—†ìœ¼ë©´ ìƒì„±
                if (!adjustedPlan[currentTripNum]) {
                    adjustedPlan[currentTripNum] = {
                        columns: [],
                        date: transportPlan[currentTripNum]?.date || '',
                        totalWeight: 0 // kg ë‹¨ìœ„
                    };
                }
                
                // í˜„ì¬ ì°¨ìˆ˜ì— ì¶”ê°€í•´ë„ 25í†¤ ì´í•˜ì¸ì§€ í™•ì¸
                if (adjustedPlan[currentTripNum].totalWeight + col.weightKg <= MAX_WEIGHT_KG) {
                    // 25í†¤ ì´í•˜ì´ë©´ í˜„ì¬ ì°¨ìˆ˜ì— ì¶”ê°€
                    adjustedPlan[currentTripNum].columns.push(col.colId);
                    adjustedPlan[currentTripNum].totalWeight += col.weightKg;
                } else {
                    // 25í†¤ì„ ë„˜ìœ¼ë©´ ë‹¤ìŒ ì°¨ìˆ˜ë¡œ ì´ë™
                    currentTripNum++;
                    adjustedPlan[currentTripNum] = {
                        columns: [col.colId],
                        date: transportPlan[currentTripNum]?.date || '',
                        totalWeight: col.weightKg
                    };
                }
            });
            
            // ì¡°ì • ê²°ê³¼ í™•ì¸ (25í†¤ = 25,000kg, MAX_WEIGHT_KGëŠ” ìœ„ì—ì„œ ì´ë¯¸ ì„ ì–¸ë¨)
            let over25Count = 0;
            for (let tripNum in adjustedPlan) {
                if (adjustedPlan[tripNum].totalWeight > MAX_WEIGHT_KG) {
                    over25Count++;
                }
            }
            
            if (over25Count > 0) {
                alert(`âš ï¸ ì£¼ì˜: ${over25Count}ê°œ ì°¨ìˆ˜ê°€ 25í†¤ì„ ì´ˆê³¼í•©ë‹ˆë‹¤.\n\nê°œë³„ ê¸°ë‘¥ì˜ ì¤‘ëŸ‰ì´ 25í†¤ì„ ì´ˆê³¼í•˜ëŠ” ê²½ìš° ìë™ ì¡°ì •ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.`);
            }
            
            // ì¡°ì •ëœ ê³„íš ì ìš©
            if (confirm(`25í†¤ ê¸°ì¤€ìœ¼ë¡œ ì°¨ìˆ˜ë¥¼ ì¬ì¡°ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì¡°ì •ëœ ì°¨ìˆ˜ê³„íšì´ ë³„ë„ë¡œ ì €ì¥ë©ë‹ˆë‹¤.\nê¸°ì¡´ ìš´ì†¡ì°¨ìˆ˜ê³„íšì€ ë³€ê²½ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`)) {
                // adjustedTransportPlanì— ì¡°ì •ëœ ê³„íš ì €ì¥ (ê¸°ì¡´ transportPlanì€ ìœ ì§€)
                adjustedTransportPlan = {};
                tripCountDeltas = {}; // ë¶€ì¬ìˆ˜ ì¡°ì •ê°’ ì´ˆê¸°í™”
                for (let tripNum in adjustedPlan) {
                    adjustedTransportPlan[tripNum] = {
                        columns: adjustedPlan[tripNum].columns,
                        date: adjustedPlan[tripNum].date
                    };
                }
                console.log('plan keys:', Object.keys(adjustedTransportPlan || {}));
                console.log('first trip columns:', adjustedTransportPlan?.[Object.keys(adjustedTransportPlan || {})[0]]?.columns);

                // ì°¨ìˆ˜ë³„ ê¸°ë‘¥ ê°œìˆ˜ í™•ì¸ ë° ì¶œë ¥
                console.log('=== ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš ìƒì„± ì™„ë£Œ - ì°¨ìˆ˜ë³„ ê¸°ë‘¥ ê°œìˆ˜ ===');
                const sortedTripNums = Object.keys(adjustedTransportPlan)
                    .map(k => parseInt(k))
                    .sort((a, b) => a - b);
                
                let totalCount = 0;
                sortedTripNums.forEach(tripNum => {
                    const tripData = adjustedTransportPlan[tripNum];
                    const count = tripData && tripData.columns ? tripData.columns.length : 0;
                    totalCount += count;
                    console.log(`${tripNum}ì°¨ìˆ˜: ${count}ê°œ`);
                });
                console.log(`ì „ì²´: ${totalCount}ê°œ`);
                console.log('==========================================');
                
                // localStorageì— ì €ì¥
                localStorage.setItem(kcolKey('adjustedTransportPlan'), JSON.stringify(adjustedTransportPlan));
                
                // í™”ë©´ ì—…ë°ì´íŠ¸
                if (typeof renderTransportVolumeTable === 'function') {
                    renderTransportVolumeTable();
                }
                renderAdjustedTripSummarySafe();
                
                // ì¡°ì • ê²°ê³¼ íŒ¨ë„ í‘œì‹œ
                const adjustmentPanel = document.getElementById('transport-volume-adjustment-panel');
                const adjustmentInfo = document.getElementById('transport-volume-adjustment-info');
                if (adjustmentPanel && adjustmentInfo) {
                    const totalTrips = Object.keys(adjustedPlan).length;
                    const totalColumns = Object.values(adjustedPlan).reduce((sum, trip) => sum + (trip.columns?.length || 0), 0);
                    const avgWeightPerTrip = totalTrips > 0 ? (Object.values(adjustedPlan).reduce((sum, trip) => sum + (trip.totalWeight || 0), 0) / totalTrips / 1000).toFixed(2) : 0;
                    
                    adjustmentInfo.innerHTML = `
                        <div style="margin-bottom:4px;"><strong>ì´ ì°¨ìˆ˜:</strong> ${totalTrips}ê°œ</div>
                        <div style="margin-bottom:4px;"><strong>ì´ ë¶€ì¬ìˆ˜:</strong> ${totalColumns.toLocaleString('ko-KR')}ê°œ</div>
                        <div style="margin-bottom:4px;"><strong>ì°¨ìˆ˜ë‹¹ í‰ê·  ì¤‘ëŸ‰:</strong> ${avgWeightPerTrip}í†¤</div>
                        ${over25Count > 0 ? `<div style="color:#f44336;font-weight:bold;">âš ï¸ ${over25Count}ê°œ ì°¨ìˆ˜ê°€ 25í†¤ ì´ˆê³¼</div>` : '<div style="color:#4caf50;">âœ… ëª¨ë“  ì°¨ìˆ˜ê°€ 25í†¤ ì´í•˜</div>'}
                    `;
                    adjustmentPanel.style.display = 'block';
                }
                
                alert('âœ… 25í†¤ ê¸°ì¤€ìœ¼ë¡œ ì°¨ìˆ˜ê°€ ì¬ì¡°ì •ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nì¡°ì •ëœ ì°¨ìˆ˜ê³„íšì´ "ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš" ì»¬ëŸ¼ì— í‘œì‹œë©ë‹ˆë‹¤.');
            }
        }

        // XLSX ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ í™•ì¸ ë° ëŒ€ê¸°
        async function ensureXLSXLoaded() {
            if (typeof XLSX !== 'undefined' && window.XLSX && window.XLSX.utils) {
                return window.XLSX;
            }
            
            // ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹œë„
            return new Promise((resolve, reject) => {
                const cdnUrls = [
                    'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js',
                    'https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js',
                    'https://cdn.sheetjs.com/xlsx-0.18.5/package/dist/xlsx.full.min.js'
                ];
                
                let currentIndex = 0;
                
                function tryLoad() {
                    if (currentIndex >= cdnUrls.length) {
                        reject(new Error('ëª¨ë“  CDNì—ì„œ XLSX ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'));
                        return;
                    }
                    
                    const script = document.createElement('script');
                    script.src = cdnUrls[currentIndex];
                    script.async = false;
                    
                    script.onload = function() {
                        if (typeof XLSX !== 'undefined' && window.XLSX && window.XLSX.utils) {
                            window.XLSX = window.XLSX || XLSX;
                            resolve(window.XLSX);
                        } else {
                            currentIndex++;
                            tryLoad();
                        }
                    };
                    
                    script.onerror = function() {
                        currentIndex++;
                        tryLoad();
                    };
                    
                    document.head.appendChild(script);
                }
                
                tryLoad();
            });
        }

        // í†µí•© í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ (ê³µì • 1-6 ëª¨ë‘ í¬í•¨)
        async function downloadAllProcessTemplate() {
            let XLSXLib;
            try {
                XLSXLib = await ensureXLSXLoaded();
            } catch (err) {
                alert('ì—‘ì…€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\ní•´ê²° ë°©ë²•:\n1. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”\n2. ë¸Œë¼ìš°ì € ìºì‹œë¥¼ ì‚­ì œí•˜ê³  í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš” (Ctrl+Shift+R)\n3. ë¸Œë¼ìš°ì € ì½˜ì†”(F12)ì—ì„œ ìì„¸í•œ ì˜¤ë¥˜ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”\n4. ë°©í™”ë²½ì´ë‚˜ ë³´ì•ˆ í”„ë¡œê·¸ë¨ì´ CDN ì ‘ê·¼ì„ ì°¨ë‹¨í•˜ì§€ ì•ŠëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”');
                return;
            }
            
            try {
                // 100ê°œ ê¸°ë‘¥ ë°ì´í„° ìƒì„± (50ê°œ ê¸°ë‘¥ Ã— 2ê°œ ì„œë¸Œ í•­ëª©)
                const generateColumnData = () => {
                    const data = [];
                    const formatDate = (d) => {
                        const year = d.getFullYear();
                        const month = String(d.getMonth() + 1).padStart(2, '0');
                        const day = String(d.getDate()).padStart(2, '0');
                        return `${year}-${month}-${day}`;
                    };
                    
                    for (let i = 1; i <= TOTAL_COLUMNS; i++) {
                        for (let sub = 1; sub <= SUB_ITEMS_PER_COLUMN; sub++) {
                            const colId = getColumnId(i, sub);
                            // ìƒ˜í”Œ ë‚ ì§œ ìƒì„± (ê°„ë‹¨í•œ ì˜ˆì‹œ)
                            const baseDate = new Date('2026-01-15');
                            const dayOffset = Math.floor((i - 1) / 5); // 5ê°œì”© ê·¸ë£¹í™”
                            const date1 = new Date(baseDate);
                            date1.setDate(date1.getDate() + dayOffset);
                            const date2 = new Date(date1);
                            date2.setDate(date2.getDate() + 1);
                            const date3 = new Date(date2);
                            date3.setDate(date3.getDate() + 4);
                            const date4 = new Date(date3);
                            date4.setDate(date4.getDate() + 1);
                            const date5 = new Date(date4);
                            date5.setDate(date5.getDate() + 4);
                            const date6 = new Date(date5);
                            date6.setDate(date6.getDate() + 5);
                            
                            data.push([
                                colId,
                                '', // ê¸°ë‘¥ì´ë¦„ (ì‚¬ìš©ìê°€ ì…ë ¥)
                                formatDate(date1), // ì£¼ê¸°ë‘¥ì»¤íŒ…ë‚ ì§œ
                                formatDate(date2), // ì†Œë¶€ì¬ì»¤íŒ…ë‚ ì§œ
                                formatDate(date3), // ì£¼ê¸°ë‘¥ì¡°ë¦½ë‚ ì§œ
                                formatDate(date4), // ì†Œë¶€ì¬ì¡°ë¦½ë‚ ì§œ
                                formatDate(date5), // í˜„ì¥ë°°ì†¡ë‚ ì§œ
                                formatDate(date6)  // í˜„ì¥ì„¤ì¹˜ë‚ ì§œ
                            ]);
                        }
                    }
                    return data;
                };
                
                const headers = ['ê¸°ë‘¥ë²ˆí˜¸', 'ê¸°ë‘¥ì´ë¦„', 'ì£¼ê¸°ë‘¥ì»¤íŒ…ë‚ ì§œ', 'ì†Œë¶€ì¬ì»¤íŒ…ë‚ ì§œ', 'ì£¼ê¸°ë‘¥ì¡°ë¦½ë‚ ì§œ', 'ì†Œë¶€ì¬ì¡°ë¦½ë‚ ì§œ', 'í˜„ì¥ë°°ì†¡ë‚ ì§œ', 'í˜„ì¥ì„¤ì¹˜ë‚ ì§œ'];
                const sample = generateColumnData(); // 100ê°œ ê¸°ë‘¥ ë°ì´í„°
                
                // ë°ì´í„° ë°°ì—´ ìƒì„± (í—¤ë” + ìƒ˜í”Œ ë°ì´í„°)
                const wsData = [headers, ...sample];
                
                // ì›Œí¬ì‹œíŠ¸ ìƒì„±
                const ws = XLSXLib.utils.aoa_to_sheet(wsData);
                
                // ì»¬ëŸ¼ ë„ˆë¹„ ì„¤ì •
                ws['!cols'] = [
                    { wch: 12 }, // ê¸°ë‘¥ë²ˆí˜¸
                    { wch: 20 }, // ê¸°ë‘¥ì´ë¦„
                    { wch: 18 }, // ì£¼ê¸°ë‘¥ì»¤íŒ…ë‚ ì§œ
                    { wch: 18 }, // ì†Œë¶€ì¬ì»¤íŒ…ë‚ ì§œ
                    { wch: 18 }, // ì£¼ê¸°ë‘¥ì¡°ë¦½ë‚ ì§œ
                    { wch: 18 }, // ì†Œë¶€ì¬ì¡°ë¦½ë‚ ì§œ
                    { wch: 18 }, // í˜„ì¥ë°°ì†¡ë‚ ì§œ
                    { wch: 18 }  // í˜„ì¥ì„¤ì¹˜ë‚ ì§œ
                ];
                
                // ì›Œí¬ë¶ ìƒì„±
                const wb = XLSXLib.utils.book_new();
                XLSXLib.utils.book_append_sheet(wb, ws, 'ê³µì •ì…ë ¥');
                
                // íŒŒì¼ëª… ìƒì„± (í˜„ì¬ ë‚ ì§œ í¬í•¨)
                const dateStr = new Date().toISOString().split('T')[0].replace(/-/g, '');
                const fileName = `ê³µì •1-6ì…ë ¥_í†µí•©í…œí”Œë¦¿_${dateStr}.xlsx`;
                
                // Blob ë°©ì‹ìœ¼ë¡œ ì—‘ì…€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ (ë” ì•ˆì •ì )
                try {
                    const wbout = XLSXLib.write(wb, { bookType: 'xlsx', type: 'array', cellStyles: false });
                    const blob = new Blob([wbout], { 
                        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                    });
                    
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileName;
                    a.style.display = 'none';
                    document.body.appendChild(a);
                    a.click();
                    
                    setTimeout(() => {
                        try {
                            document.body.removeChild(a);
                        } catch (e) {}
                        setTimeout(() => URL.revokeObjectURL(url), 1000);
                    }, 100);
                } catch (writeErr) {
                    console.error('íŒŒì¼ ì“°ê¸° ì˜¤ë¥˜:', writeErr);
                    // XLSX.writeFileë¡œ í´ë°± ì‹œë„
                    try {
                        XLSX.writeFile(wb, fileName);
                    } catch (fallbackErr) {
                        throw new Error('ì—‘ì…€ íŒŒì¼ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (writeErr.message || String(writeErr)));
                    }
                }
                
            } catch (err) {
                console.error('í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', err);
                alert('í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\nì˜¤ë¥˜: ' + (err.message || String(err)) + '\n\ní•´ê²° ë°©ë²•:\n1. ë¸Œë¼ìš°ì €ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš” (Ctrl+Shift+R)\n2. ë¸Œë¼ìš°ì € ì½˜ì†”(F12)ì—ì„œ ìì„¸í•œ ì˜¤ë¥˜ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”');
            }
        }

        // ê³µì •ë³„ í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ (ì—‘ì…€ í˜•ì‹)
        // processNum: 1=ì£¼ê¸°ë‘¥ì»¤íŒ…, 2=ì†Œë¶€ì¬ì»¤íŒ…, 3=ì£¼ê¸°ë‘¥ì¡°ë¦½, 4=ì†Œë¶€ì¬ì¡°ë¦½, 5=í˜„ì¥ë°°ì†¡, 6=í˜„ì¥ì„¤ì¹˜
        async function downloadProcessTemplate(processNum) {
            let XLSXLib;
            try {
                XLSXLib = await ensureXLSXLoaded();
            } catch (err) {
                alert('ì—‘ì…€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\ní•´ê²° ë°©ë²•:\n1. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”\n2. ë¸Œë¼ìš°ì € ìºì‹œë¥¼ ì‚­ì œí•˜ê³  í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš” (Ctrl+Shift+R)\n3. ë¸Œë¼ìš°ì € ì½˜ì†”(F12)ì—ì„œ ìì„¸í•œ ì˜¤ë¥˜ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”\n4. ë°©í™”ë²½ì´ë‚˜ ë³´ì•ˆ í”„ë¡œê·¸ë¨ì´ CDN ì ‘ê·¼ì„ ì°¨ë‹¨í•˜ì§€ ì•ŠëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”');
                return;
            }
            
            try {
                const processNames = {
                    1: { name: 'ì£¼ê¸°ë‘¥ì»¤íŒ…', header: 'ì£¼ê¸°ë‘¥ì»¤íŒ…ë‚ ì§œ', color: '#e74c3c' },
                    2: { name: 'ì†Œë¶€ì¬ì»¤íŒ…', header: 'ì†Œë¶€ì¬ì»¤íŒ…ë‚ ì§œ', color: '#ff9800' },
                    3: { name: 'ì£¼ê¸°ë‘¥ì¡°ë¦½', header: 'ì£¼ê¸°ë‘¥ì¡°ë¦½ë‚ ì§œ', color: '#2196f3' },
                    4: { name: 'ì†Œë¶€ì¬ì¡°ë¦½', header: 'ì†Œë¶€ì¬ì¡°ë¦½ë‚ ì§œ', color: '#00bcd4' },
                    5: { name: 'í˜„ì¥ë°°ì†¡', header: 'ìš´ì†¡ë‚ ì§œ', color: '#9c27b0' },
                    6: { name: 'í˜„ì¥ì„¤ì¹˜', header: 'í˜„ì¥ì„¤ì¹˜ë‚ ì§œ', color: '#4caf50' }
                };
                
                const processInfo = processNames[processNum];
                if (!processInfo) {
                    alert('ìœ íš¨í•˜ì§€ ì•Šì€ ê³µì • ë²ˆí˜¸ì…ë‹ˆë‹¤.');
                    return;
                }
                
                let headers, sample, sheetName;
                
                // 100ê°œ ê¸°ë‘¥ ë°ì´í„° ìƒì„± (50ê°œ ê¸°ë‘¥ Ã— 2ê°œ ì„œë¸Œ í•­ëª©)
                const generateColumnData = () => {
                    const data = [];
                    for (let i = 1; i <= TOTAL_COLUMNS; i++) {
                        for (let sub = 1; sub <= SUB_ITEMS_PER_COLUMN; sub++) {
                            const colId = getColumnId(i, sub);
                            data.push(colId);
                        }
                    }
                    return data;
                };
                
                const allColumns = generateColumnData(); // 100ê°œ ê¸°ë‘¥ ë²ˆí˜¸ ë°°ì—´
                
                if (processNum === 5) {
                    // í˜„ì¥ë°°ì†¡: ê¸°ë‘¥ë²ˆí˜¸, ê¸°ë‘¥ì´ë¦„, ì°¨ìˆ˜, ìš´ì†¡ë‚ ì§œ
                    headers = ['ê¸°ë‘¥ë²ˆí˜¸', 'ê¸°ë‘¥ì´ë¦„', 'ì°¨ìˆ˜', 'ìš´ì†¡ë‚ ì§œ'];
                    sample = allColumns.map((colId, idx) => {
                        const tripNum = Math.floor(idx / 10) + 1; // 10ê°œì”© ì°¨ìˆ˜ ê·¸ë£¹í™”
                        const date = `2026-0${Math.floor(tripNum / 2) + 1}-${(tripNum % 2) * 15 + 1}`;
                        return [colId, '', tripNum.toString(), date];
                    });
                    sheetName = 'ìš´ì†¡ì°¨ìˆ˜ê³„íš';
                } else if (processNum === 6) {
                    // í˜„ì¥ì„¤ì¹˜: ê¸°ë‘¥ë²ˆí˜¸, ê¸°ë‘¥ì´ë¦„, í˜„ì¥ì„¤ì¹˜ë‚ ì§œ
                    headers = ['ê¸°ë‘¥ë²ˆí˜¸', 'ê¸°ë‘¥ì´ë¦„', 'í˜„ì¥ì„¤ì¹˜ë‚ ì§œ'];
                    sample = allColumns.map((colId, idx) => {
                        const date = `2026-0${Math.floor(idx / 20) + 1}-${(idx % 20) + 1}`;
                        return [colId, '', date];
                    });
                    sheetName = 'í˜„ì¥ì„¤ì¹˜';
                } else {
                    // ê³µì • 1-4: ê¸°ë‘¥ë²ˆí˜¸, ê¸°ë‘¥ì´ë¦„, í•´ë‹¹ ê³µì • ë‚ ì§œ
                    headers = ['ê¸°ë‘¥ë²ˆí˜¸', 'ê¸°ë‘¥ì´ë¦„', processInfo.header];
                    sample = allColumns.map((colId, idx) => {
                        const date = `2026-0${Math.floor(idx / 20) + 1}-${(idx % 20) + 1}`;
                        return [colId, '', date];
                    });
                    sheetName = processInfo.name;
                }
                
                // ë°ì´í„° ë°°ì—´ ìƒì„± (í—¤ë” + ìƒ˜í”Œ ë°ì´í„°)
                const wsData = [headers, ...sample];
                
                // ì›Œí¬ì‹œíŠ¸ ìƒì„±
                const ws = XLSXLib.utils.aoa_to_sheet(wsData);
                
                // ì»¬ëŸ¼ ë„ˆë¹„ ì„¤ì •
                const colWidths = processNum === 5 ? 
                    [{ wch: 12 }, { wch: 20 }, { wch: 8 }, { wch: 15 }] : 
                    [{ wch: 12 }, { wch: 20 }, { wch: 18 }];
                ws['!cols'] = colWidths;
                
                // ì›Œí¬ë¶ ìƒì„±
                const wb = XLSXLib.utils.book_new();
                XLSXLib.utils.book_append_sheet(wb, ws, sheetName);
                
                // íŒŒì¼ëª… ìƒì„± (í˜„ì¬ ë‚ ì§œ í¬í•¨)
                const dateStr = new Date().toISOString().split('T')[0].replace(/-/g, '');
                const fileName = `${processInfo.name}_í…œí”Œë¦¿_${dateStr}.xlsx`;
                
                // Blob ë°©ì‹ìœ¼ë¡œ ì—‘ì…€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ (ë” ì•ˆì •ì )
                try {
                    const wbout = XLSXLib.write(wb, { bookType: 'xlsx', type: 'array', cellStyles: false });
                    const blob = new Blob([wbout], { 
                        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                    });
                    
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileName;
                    a.style.display = 'none';
                    document.body.appendChild(a);
                    a.click();
                    
                    setTimeout(() => {
                        try {
                            document.body.removeChild(a);
                        } catch (e) {}
                        setTimeout(() => URL.revokeObjectURL(url), 1000);
                    }, 100);
                } catch (writeErr) {
                    console.error('íŒŒì¼ ì“°ê¸° ì˜¤ë¥˜:', writeErr);
                    // XLSX.writeFileë¡œ í´ë°± ì‹œë„
                    try {
                        XLSX.writeFile(wb, fileName);
                    } catch (fallbackErr) {
                        throw new Error('ì—‘ì…€ íŒŒì¼ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (writeErr.message || String(writeErr)));
                    }
                }
                
            } catch (err) {
                console.error('í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', err);
                alert('í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\nì˜¤ë¥˜: ' + (err.message || String(err)) + '\n\ní•´ê²° ë°©ë²•:\n1. ë¸Œë¼ìš°ì €ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš” (Ctrl+Shift+R)\n2. ë¸Œë¼ìš°ì € ì½˜ì†”(F12)ì—ì„œ ìì„¸í•œ ì˜¤ë¥˜ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”');
            }
        }

        // ê³µì • 1-4: ì—‘ì…€ ì—…ë¡œë“œ ì²˜ë¦¬
        async function handleProcessExcelFile(event) {
            const file = event.target.files[0];
            const statusEl = document.getElementById('process-excel-status');
            
            if (!file) {
                if (statusEl) statusEl.textContent = 'íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.';
                return;
            }
            
            // ê¶Œí•œ ì²´í¬: ViewerëŠ” ì—…ë¡œë“œ ë¶ˆê°€, Adminì€ ëª¨ë“  ê³µì • ê°€ëŠ¥
            if (userRole === 'viewer') {
                alert('âš ï¸ ê¶Œí•œ ì—†ìŒ\n\nViewerëŠ” ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                if (statusEl) statusEl.textContent = 'âš ï¸ ê¶Œí•œ ì—†ìŒ';
                return;
            }
            
            // EditorëŠ” í—ˆìš©ëœ ê³µì •ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥, Adminì€ ëª¨ë“  ê³µì • ê°€ëŠ¥
            if (userRole === 'editor') {
                // EditorëŠ” í—ˆìš©ëœ ê³µì •ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥
                // ì—‘ì…€ íŒŒì¼ì„ ì½ì–´ì„œ ì–´ë–¤ ê³µì • ë°ì´í„°ê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ì•¼ í•˜ì§€ë§Œ,
                // íŒŒì¼ì„ ì½ê¸° ì „ì— ë¯¸ë¦¬ ê²½ê³ ë§Œ í‘œì‹œ
                const allowedNames = allowedProcesses.map(p => {
                    const proc = PROCESSES.find(pr => pr.id === p);
                    return proc ? `${p}.${proc.name}` : `${p}`;
                }).join(', ');
                if (allowedProcesses.length === 0) {
                    alert('âš ï¸ ê¶Œí•œ ì—†ìŒ\n\nEditorëŠ” í—ˆìš©ëœ ê³µì •ì´ ì—†ìŠµë‹ˆë‹¤.\n\nê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
                    if (statusEl) statusEl.textContent = 'âš ï¸ ê¶Œí•œ ì—†ìŒ';
                    return;
                }
            }
            
            let XLSXLib;
            try {
                XLSXLib = await ensureXLSXLoaded();
            } catch (err) {
                alert('ì—‘ì…€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\ní•´ê²° ë°©ë²•:\n1. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”\n2. ë¸Œë¼ìš°ì € ìºì‹œë¥¼ ì‚­ì œí•˜ê³  í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš” (Ctrl+Shift+R)\n3. ë¸Œë¼ìš°ì € ì½˜ì†”(F12)ì—ì„œ ìì„¸í•œ ì˜¤ë¥˜ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”\n4. ë°©í™”ë²½ì´ë‚˜ ë³´ì•ˆ í”„ë¡œê·¸ë¨ì´ CDN ì ‘ê·¼ì„ ì°¨ë‹¨í•˜ì§€ ì•ŠëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”');
                if (statusEl) statusEl.textContent = 'âš ï¸ ì—‘ì…€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨';
                return;
            }
            
            if (statusEl) statusEl.textContent = 'íŒŒì¼ì„ ì½ëŠ” ì¤‘...';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSXLib.read(data, { type: 'array', cellDates: true, cellNF: false, cellText: false });
                    const firstSheet = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[firstSheet];
                    const rows = XLSXLib.utils.sheet_to_json(sheet, { defval: '', raw: false, dateNF: 'yyyy-mm-dd' });
                    
                    if (rows.length === 0) {
                        alert('ì—‘ì…€ íŒŒì¼ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                        if (statusEl) statusEl.textContent = 'âš ï¸ íŒŒì¼ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
                        return;
                    }
                    
                    // ì—‘ì…€ íŒŒì¼ì˜ í—¤ë”ì—ì„œ í¬í•¨ëœ ê³µì • í™•ì¸
                    const processDates = [
                        { name: 'ì£¼ê¸°ë‘¥ì»¤íŒ…ë‚ ì§œ', process: 1, keys: ['ì£¼ê¸°ë‘¥ì»¤íŒ…ë‚ ì§œ', 'ì£¼ê¸°ë‘¥ì»¤íŒ…', 'ì»¤íŒ…ë‚ ì§œ', 'process1', 'p1'] },
                        { name: 'ì†Œë¶€ì¬ì»¤íŒ…ë‚ ì§œ', process: 2, keys: ['ì†Œë¶€ì¬ì»¤íŒ…ë‚ ì§œ', 'ì†Œë¶€ì¬ì»¤íŒ…', 'ê°€ê³µë‚ ì§œ', 'process2', 'p2'] },
                        { name: 'ì£¼ê¸°ë‘¥ì¡°ë¦½ë‚ ì§œ', process: 3, keys: ['ì£¼ê¸°ë‘¥ì¡°ë¦½ë‚ ì§œ', 'ì£¼ê¸°ë‘¥ì¡°ë¦½', 'ì¡°ë¦½ë‚ ì§œ', 'process3', 'p3'] },
                        { name: 'ì†Œë¶€ì¬ì¡°ë¦½ë‚ ì§œ', process: 4, keys: ['ì†Œë¶€ì¬ì¡°ë¦½ë‚ ì§œ', 'ì†Œë¶€ì¬ì¡°ë¦½', 'ì†Œì¡°ë¦½ë‚ ì§œ', 'process4', 'p4'] },
                        { name: 'í˜„ì¥ë°°ì†¡ë‚ ì§œ', process: 5, keys: ['í˜„ì¥ë°°ì†¡ë‚ ì§œ', 'í˜„ì¥ë°°ì†¡', 'ë°°ì†¡ë‚ ì§œ', 'ìš´ì†¡ë‚ ì§œ', 'process5', 'p5'] },
                        { name: 'í˜„ì¥ì„¤ì¹˜ë‚ ì§œ', process: 6, keys: ['í˜„ì¥ì„¤ì¹˜ë‚ ì§œ', 'í˜„ì¥ì„¤ì¹˜', 'ì„¤ì¹˜ë‚ ì§œ', 'process6', 'p6'] }
                    ];
                    
                    // ì—‘ì…€ í—¤ë”ì—ì„œ í¬í•¨ëœ ê³µì • ì°¾ê¸°
                    const headerKeys = Object.keys(rows[0] || {});
                    const normalizedHeaderKeys = headerKeys.map(k => k.trim().toLowerCase());
                    const includedProcesses = new Set();
                    
                    processDates.forEach(({ process, keys }) => {
                        for (let key of keys) {
                            if (headerKeys.includes(key) || normalizedHeaderKeys.includes(key.toLowerCase())) {
                                includedProcesses.add(process);
                                break;
                            }
                        }
                    });
                    
                    // ê¸°ì¡´ ë°ì´í„° ë®ì–´ì“¸ì§€ í™•ì¸
                    const shouldOverwrite = confirm('ê¸°ì¡´ ê³µì • ë°ì´í„°ë¥¼ ì—‘ì…€ ë°ì´í„°ë¡œ ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì·¨ì†Œë¥¼ ì„ íƒí•˜ë©´ ê¸°ì¡´ ë°ì´í„°ì— ì¶”ê°€ë©ë‹ˆë‹¤.');
                    
                    if (shouldOverwrite) {
                        // ì—‘ì…€ íŒŒì¼ì— í¬í•¨ëœ ê³µì •ë§Œ ì´ˆê¸°í™” (ë‹¤ë¥¸ ê³µì • ë°ì´í„°ëŠ” ë³´ì¡´)
                        for (let date in dailyData) {
                            if (dailyData[date]) {
                                includedProcesses.forEach(process => {
                                    if (dailyData[date][process]) {
                                        dailyData[date][process] = [];
                                    }
                                });
                            }
                        }
                        console.log(`[ì—‘ì…€ ì—…ë¡œë“œ] í¬í•¨ëœ ê³µì •ë§Œ ì´ˆê¸°í™”: ${Array.from(includedProcesses).join(', ')}`);
                    }
                    
                    let successCount = 0;
                    let errorCount = 0;
                    let skippedCount = 0; // Editor ê¶Œí•œìœ¼ë¡œ ìŠ¤í‚µëœ ê³µì • ìˆ˜
                    const errors = [];
                    const skippedProcesses = new Set(); // ìŠ¤í‚µëœ ê³µì • ëª©ë¡
                    
                    // ì—‘ì…€ ë°ì´í„° íŒŒì‹±
                    rows.forEach((row, idx) => {
                        try {
                            // ì»¬ëŸ¼ëª… ì •ê·œí™”
                            const normalizedRow = {};
                            Object.keys(row).forEach(k => {
                                normalizedRow[k.trim().toLowerCase()] = row[k];
                            });
                            
                            // ê¸°ë‘¥ë²ˆí˜¸ ì°¾ê¸° (1C001, 1C002 í˜•ì‹ ë˜ëŠ” 1, 2 í˜•ì‹ ì§€ì›)
                            const colNo = row['ê¸°ë‘¥ë²ˆí˜¸'] || row['ê¸°ë‘¥'] || row['ë²ˆí˜¸'] || row['Column'] || row['No'] || 
                                         normalizedRow['ê¸°ë‘¥ë²ˆí˜¸'] || normalizedRow['ê¸°ë‘¥'] || normalizedRow['ë²ˆí˜¸'] || 
                                         normalizedRow['column'] || normalizedRow['no'];
                            
                            if (!colNo) {
                                errorCount++;
                                errors.push(`í–‰ ${idx + 2}: ê¸°ë‘¥ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤.`);
                                return;
                            }
                            
                            // ê¸°ë‘¥ ì´ë¦„ ì°¾ê¸°
                            let colName = row['ê¸°ë‘¥ì´ë¦„'] || row['ì´ë¦„'] || row['Name'] || row['ê¸°ë‘¥ëª…'] || 
                                         normalizedRow['ê¸°ë‘¥ì´ë¦„'] || normalizedRow['ì´ë¦„'] || normalizedRow['name'] || 
                                         normalizedRow['ê¸°ë‘¥ëª…'] || '';
                            
                            // ê¸°ë‘¥ë²ˆí˜¸ íŒŒì‹± (1C001, 43TC001 í˜•ì‹ ë˜ëŠ” 1 í˜•ì‹ ì§€ì›)
                            let columnId = null;
                            let subIndex = 1; // ê¸°ë³¸ê°’
                            let originalColNo = String(colNo).trim(); // ì›ë³¸ ê¸°ë‘¥ë²ˆí˜¸ ì €ì¥
                            
                            const colNoStr = originalColNo;
                            
                            // 1C001 ë˜ëŠ” 43TC001 í˜•ì‹ì¸ì§€ í™•ì¸ (C ë˜ëŠ” TC í¬í•¨, ì„œë¸Œ ë²ˆí˜¸ëŠ” 1-3ìë¦¬)
                            const matchFull = colNoStr.match(/^(\d+)(?:TC|C)(\d{1,3})$/i);
                            if (matchFull) {
                                columnId = parseInt(matchFull[1]);
                                const parsedSub = parseInt(matchFull[2]);
                                // ì„œë¸Œ ë²ˆí˜¸ê°€ 1-2 ë²”ìœ„ì¸ì§€ í™•ì¸
                                if (parsedSub >= 1 && parsedSub <= SUB_ITEMS_PER_COLUMN) {
                                    subIndex = parsedSub;
                                } else {
                                    // ì„œë¸Œ ë²ˆí˜¸ê°€ ë²”ìœ„ë¥¼ ë²—ì–´ë‚˜ë©´ ê¸°ë³¸ê°’ 1 ì‚¬ìš© (ì˜¤ë¥˜ ì—†ì´ ì²˜ë¦¬)
                                    subIndex = 1;
                                }
                            } else {
                                // ìˆ«ìë§Œ ì¶”ì¶œ (ê¸°ì¡´ í˜•ì‹ ì§€ì›)
                                const numbers = colNoStr.match(/\d+/g);
                                if (numbers && numbers.length > 0) {
                                    columnId = parseInt(numbers[0]);
                                    if (numbers.length > 1) {
                                        const parsedSub = parseInt(numbers[1]);
                                        // ì„œë¸Œ ë²ˆí˜¸ê°€ 1-2 ë²”ìœ„ì¸ì§€ í™•ì¸
                                        if (parsedSub >= 1 && parsedSub <= SUB_ITEMS_PER_COLUMN) {
                                            subIndex = parsedSub;
                                        } else {
                                            // ì„œë¸Œ ë²ˆí˜¸ê°€ ë²”ìœ„ë¥¼ ë²—ì–´ë‚˜ë©´ ê¸°ë³¸ê°’ 1 ì‚¬ìš© (ì˜¤ë¥˜ ì—†ì´ ì²˜ë¦¬)
                                            subIndex = 1;
                                        }
                                    }
                                }
                            }
                            
                            if (!columnId || columnId < 1 || columnId > TOTAL_COLUMNS) {
                                errorCount++;
                                errors.push(`í–‰ ${idx + 2}: ìœ íš¨í•˜ì§€ ì•Šì€ ê¸°ë‘¥ë²ˆí˜¸ì…ë‹ˆë‹¤ (${colNo}). 1-${TOTAL_COLUMNS} ë²”ìœ„ì—¬ì•¼ í•©ë‹ˆë‹¤.`);
                                return;
                            }
                            
                            // subIndexëŠ” ì´ë¯¸ 1-2 ë²”ìœ„ë¡œ ê²€ì¦ë˜ì—ˆìœ¼ë¯€ë¡œ ì¶”ê°€ ê²€ì¦ ë¶ˆí•„ìš”
                            const colId = getColumnId(columnId, subIndex);
                            
                            // ê¸°ë‘¥ì´ë¦„ì´ ì—†ìœ¼ë©´ ê¸°ë‘¥ë²ˆí˜¸ë¥¼ ê¸°ë‘¥ì´ë¦„ìœ¼ë¡œ ì‚¬ìš©
                            if (!colName || colName.trim() === '') {
                                colName = originalColNo; // ì›ë³¸ ê¸°ë‘¥ë²ˆí˜¸ë¥¼ ê¸°ë‘¥ì´ë¦„ìœ¼ë¡œ ì‚¬ìš©
                            }
                            
                            // ê° ê³µì •ë³„ ë‚ ì§œ ì²˜ë¦¬ (ê³µì • 1-6)
                            const processDates = [
                                { name: 'ì£¼ê¸°ë‘¥ì»¤íŒ…ë‚ ì§œ', process: 1, keys: ['ì£¼ê¸°ë‘¥ì»¤íŒ…ë‚ ì§œ', 'ì£¼ê¸°ë‘¥ì»¤íŒ…', 'ì»¤íŒ…ë‚ ì§œ', 'process1', 'p1'] },
                                { name: 'ì†Œë¶€ì¬ì»¤íŒ…ë‚ ì§œ', process: 2, keys: ['ì†Œë¶€ì¬ì»¤íŒ…ë‚ ì§œ', 'ì†Œë¶€ì¬ì»¤íŒ…', 'ê°€ê³µë‚ ì§œ', 'process2', 'p2'] },
                                { name: 'ì£¼ê¸°ë‘¥ì¡°ë¦½ë‚ ì§œ', process: 3, keys: ['ì£¼ê¸°ë‘¥ì¡°ë¦½ë‚ ì§œ', 'ì£¼ê¸°ë‘¥ì¡°ë¦½', 'ì¡°ë¦½ë‚ ì§œ', 'process3', 'p3'] },
                                { name: 'ì†Œë¶€ì¬ì¡°ë¦½ë‚ ì§œ', process: 4, keys: ['ì†Œë¶€ì¬ì¡°ë¦½ë‚ ì§œ', 'ì†Œë¶€ì¬ì¡°ë¦½', 'ì†Œì¡°ë¦½ë‚ ì§œ', 'process4', 'p4'] },
                                { name: 'í˜„ì¥ë°°ì†¡ë‚ ì§œ', process: 5, keys: ['í˜„ì¥ë°°ì†¡ë‚ ì§œ', 'í˜„ì¥ë°°ì†¡', 'ë°°ì†¡ë‚ ì§œ', 'ìš´ì†¡ë‚ ì§œ', 'process5', 'p5'] },
                                { name: 'í˜„ì¥ì„¤ì¹˜ë‚ ì§œ', process: 6, keys: ['í˜„ì¥ì„¤ì¹˜ë‚ ì§œ', 'í˜„ì¥ì„¤ì¹˜', 'ì„¤ì¹˜ë‚ ì§œ', 'process6', 'p6'] }
                            ];
                            
                            processDates.forEach(({ name, process, keys }) => {
                                // ğŸ”’ [ê°€ë“œ] ê¶Œí•œ ì²´í¬: EditorëŠ” í—ˆìš©ëœ ê³µì •ë§Œ ì²˜ë¦¬, Adminì€ ëª¨ë“  ê³µì • ì²˜ë¦¬
                                if (!canEditProcess(process)) {
                                    skippedProcesses.add(process);
                                    skippedCount++;
                                    return; // í—ˆìš©ë˜ì§€ ì•Šì€ ê³µì •ì€ ìŠ¤í‚µ
                                }
                                
                                // ë‚ ì§œ ì°¾ê¸°
                                let date = null;
                                for (let key of keys) {
                                    date = row[key] || normalizedRow[key.toLowerCase()];
                                    if (date) break;
                                }
                                
                                if (!date) return; // ë‚ ì§œê°€ ì—†ìœ¼ë©´ ìŠ¤í‚µ
                                
                                // ë‚ ì§œ ì •ê·œí™”
                                let formattedDate = '';
                                if (date instanceof Date) {
                                    const year = date.getFullYear();
                                    const month = String(date.getMonth() + 1).padStart(2, '0');
                                    const day = String(date.getDate()).padStart(2, '0');
                                    formattedDate = `${year}-${month}-${day}`;
                                } else {
                                    const dateStr = String(date).trim();
                                    if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                                        formattedDate = dateStr;
                                    } else if (dateStr.match(/^\d{4}\/\d{2}\/\d{2}$/)) {
                                        formattedDate = dateStr.replace(/\//g, '-');
                                    } else if (/^\d+\.?\d*$/.test(dateStr) && parseFloat(dateStr) > 0 && parseFloat(dateStr) < 1000000) {
                                        // Excel serial number
                                        const excelEpoch = new Date(1899, 11, 30);
                                        const serialNumber = parseFloat(dateStr);
                                        const dateObj = new Date(excelEpoch.getTime() + serialNumber * 24 * 60 * 60 * 1000);
                                        if (!isNaN(dateObj.getTime())) {
                                            const year = dateObj.getFullYear();
                                            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                                            const day = String(dateObj.getDate()).padStart(2, '0');
                                            formattedDate = `${year}-${month}-${day}`;
                                        }
                                    } else {
                                        const dateObj = new Date(dateStr);
                                        if (!isNaN(dateObj.getTime()) && dateObj.getFullYear() > 1900) {
                                            const year = dateObj.getFullYear();
                                            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                                            const day = String(dateObj.getDate()).padStart(2, '0');
                                            formattedDate = `${year}-${month}-${day}`;
                                        }
                                    }
                                }
                                
                                if (formattedDate) {
                                    // dailyData ì´ˆê¸°í™”
                                    if (!dailyData[formattedDate]) {
                                        dailyData[formattedDate] = {};
                                    }
                                    if (!dailyData[formattedDate][process]) {
                                        dailyData[formattedDate][process] = [];
                                    }
                                    
                                    // ê¸°ë‘¥ ì¶”ê°€ (ì¤‘ë³µ ì œê±°)
                                    if (!dailyData[formattedDate][process].includes(colId) && 
                                        !dailyData[formattedDate][process].includes(columnId) &&
                                        !dailyData[formattedDate][process].includes(String(columnId))) {
                                        dailyData[formattedDate][process].push(colId);
                                    }
                                    
                                    // columnData ì—…ë°ì´íŠ¸
                                    if (!columnData[colId]) {
                                        columnData[colId] = { status: 0, lastUpdate: '', name: '' };
                                    }
                                    // ê¸°ë‘¥ ì´ë¦„ ì €ì¥ (ì—‘ì…€ì—ì„œ ì½ì€ ì´ë¦„)
                                    if (colName && colName.trim()) {
                                        columnData[colId].name = colName.trim();
                                    }
                                    if (process === 6) {
                                        // í˜„ì¥ì„¤ì¹˜ëŠ” statusë¥¼ 6ìœ¼ë¡œ ì—…ë°ì´íŠ¸
                                        columnData[colId].status = 6;
                                        columnData[colId].lastUpdate = formattedDate;
                                    } else if (process === 5) {
                                        // í˜„ì¥ë°°ì†¡ì€ statusë¥¼ ì—…ë°ì´íŠ¸í•˜ì§€ ì•ŠìŒ (ìš´ì†¡ì°¨ìˆ˜ê³„íšê³¼ ë™ì¼í•˜ê²Œ ì²˜ë¦¬)
                                        // dailyDataì—ë§Œ ì €ì¥
                                    } else if (columnData[colId].status < process) {
                                        // ê³µì • 1-4ëŠ” status ì—…ë°ì´íŠ¸
                                        columnData[colId].status = process;
                                        columnData[colId].lastUpdate = formattedDate;
                                    }
                                }
                            });
                            
                            successCount++;
                        } catch (err) {
                            errorCount++;
                            errors.push(`í–‰ ${idx + 2}: ${err.message || 'ì²˜ë¦¬ ì˜¤ë¥˜'}`);
                        }
                    });
                    
                    // ë¹ˆ ë°°ì—´ ì •ë¦¬
                    for (let date in dailyData) {
                        if (dailyData[date]) {
                            for (let p = 1; p <= 6; p++) {
                                if (dailyData[date][p] && dailyData[date][p].length === 0) {
                                    delete dailyData[date][p];
                                }
                            }
                            if (Object.keys(dailyData[date]).length === 0) {
                                delete dailyData[date];
                            }
                        }
                    }
                    
                    // ì €ì¥
                    saveToStorage();
                    
                    // í™”ë©´ ì—…ë°ì´íŠ¸
                    renderColumnGrid('column-grid-overview');
                    renderColumnGrid('column-grid-input');
                    updateProgressBars();
                    renderGanttChart();
                    
                    // ê²°ê³¼ ë©”ì‹œì§€
                    let message = `âœ… ì—…ë¡œë“œ ì™„ë£Œ: ${successCount}ê°œ ê¸°ë‘¥ ì²˜ë¦¬ë¨`;
                    if (errorCount > 0) {
                        message += `\nâš ï¸ ì˜¤ë¥˜: ${errorCount}ê°œ í–‰ ì²˜ë¦¬ ì‹¤íŒ¨`;
                        if (errors.length > 0 && errors.length <= 10) {
                            message += '\n\nì˜¤ë¥˜ ìƒì„¸:\n' + errors.slice(0, 10).join('\n');
                        }
                    }
                    if (userRole === 'editor' && skippedCount > 0) {
                        const skippedNames = Array.from(skippedProcesses).map(p => {
                            const proc = PROCESSES.find(pr => pr.id === p);
                            return proc ? `${p}.${proc.name}` : `${p}`;
                        }).join(', ');
                        message += `\n\nâš ï¸ ê¶Œí•œ ì—†ìŒ: ${skippedCount}ê°œ ê³µì • ë°ì´í„°ê°€ ë¬´ì‹œë˜ì—ˆìŠµë‹ˆë‹¤.\ní—ˆìš©ë˜ì§€ ì•Šì€ ê³µì •: ${skippedNames}\ní—ˆìš©ëœ ê³µì •ë§Œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`;
                    }
                    
                    alert(message);
                    
                    if (statusEl) {
                        statusEl.textContent = `ì—…ë¡œë“œ ì™„ë£Œ: ${successCount}ê°œ ê¸°ë‘¥ ì²˜ë¦¬ë¨`;
                    }
                    
                } catch (err) {
                    console.error('ê³µì • ì—‘ì…€ ì²˜ë¦¬ ì˜¤ë¥˜:', err);
                    alert('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í…œí”Œë¦¿ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.\n\nì˜¤ë¥˜: ' + err.message);
                    if (statusEl) statusEl.textContent = 'âš ï¸ íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // ê³µì • 5-6 (í˜„ì¥ë°°ì†¡, í˜„ì¥ì„¤ì¹˜): ì—‘ì…€ ì—…ë¡œë“œ ì²˜ë¦¬
        function handleProcess56ExcelFile(event) {
            const file = event.target.files[0];
            const statusEl = document.getElementById('process-56-excel-status');
            
            if (!file) {
                if (statusEl) statusEl.textContent = 'íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.';
                return;
            }
            
            if (typeof XLSX === 'undefined') {
                alert('ì—‘ì…€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (statusEl) statusEl.textContent = 'íŒŒì¼ì„ ì½ëŠ” ì¤‘...';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true, cellNF: false, cellText: false });
                    const firstSheet = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[firstSheet];
                    const rows = XLSX.utils.sheet_to_json(sheet, { defval: '', raw: false, dateNF: 'yyyy-mm-dd' });
                    
                    if (rows.length === 0) {
                        alert('ì—‘ì…€ íŒŒì¼ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                        if (statusEl) statusEl.textContent = 'âš ï¸ íŒŒì¼ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
                        return;
                    }
                    
                    // ê³µì • ì„ íƒ (í˜„ì¥ë°°ì†¡ ë˜ëŠ” í˜„ì¥ì„¤ì¹˜)
                    const processChoice = confirm('ì–´ë–¤ ê³µì •ì„ ì—…ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\ní™•ì¸ = í˜„ì¥ë°°ì†¡ (ê³µì • 5)\nì·¨ì†Œ = í˜„ì¥ì„¤ì¹˜ (ê³µì • 6)');
                    const processNum = processChoice ? 5 : 6;
                    const processName = processChoice ? 'í˜„ì¥ë°°ì†¡' : 'í˜„ì¥ì„¤ì¹˜';
                    
                    // ê¸°ì¡´ ë°ì´í„° ë®ì–´ì“¸ì§€ í™•ì¸
                    const shouldOverwrite = confirm(`ê¸°ì¡´ ${processName} ë°ì´í„°ë¥¼ ì—‘ì…€ ë°ì´í„°ë¡œ ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì·¨ì†Œë¥¼ ì„ íƒí•˜ë©´ ê¸°ì¡´ ë°ì´í„°ì— ì¶”ê°€ë©ë‹ˆë‹¤.`);
                    
                    if (shouldOverwrite) {
                        // ê¸°ì¡´ dailyDataì˜ í•´ë‹¹ ê³µì •ë§Œ ì´ˆê¸°í™”
                        for (let date in dailyData) {
                            if (dailyData[date] && dailyData[date][processNum]) {
                                dailyData[date][processNum] = [];
                            }
                        }
                    }
                    
                    let successCount = 0;
                    let errorCount = 0;
                    const errors = [];
                    
                    // ì—‘ì…€ ë°ì´í„° íŒŒì‹±
                    rows.forEach((row, idx) => {
                        try {
                            // ì»¬ëŸ¼ëª… ì •ê·œí™”
                            const normalizedRow = {};
                            Object.keys(row).forEach(k => {
                                normalizedRow[k.trim().toLowerCase()] = row[k];
                            });
                            
                            // ê¸°ë‘¥ë²ˆí˜¸ ì°¾ê¸°
                            const colNo = row['ê¸°ë‘¥ë²ˆí˜¸'] || row['ê¸°ë‘¥'] || row['ë²ˆí˜¸'] || row['Column'] || row['No'] || 
                                         normalizedRow['ê¸°ë‘¥ë²ˆí˜¸'] || normalizedRow['ê¸°ë‘¥'] || normalizedRow['ë²ˆí˜¸'] || 
                                         normalizedRow['column'] || normalizedRow['no'];
                            
                            if (!colNo) {
                                errorCount++;
                                errors.push(`í–‰ ${idx + 2}: ê¸°ë‘¥ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤.`);
                                return;
                            }
                            
                            // ê¸°ë‘¥ ì´ë¦„ ì°¾ê¸°
                            let colName = row['ê¸°ë‘¥ì´ë¦„'] || row['ì´ë¦„'] || row['Name'] || row['ê¸°ë‘¥ëª…'] || 
                                         normalizedRow['ê¸°ë‘¥ì´ë¦„'] || normalizedRow['ì´ë¦„'] || normalizedRow['name'] || 
                                         normalizedRow['ê¸°ë‘¥ëª…'] || '';
                            
                            // ê¸°ë‘¥ë²ˆí˜¸ íŒŒì‹± (1C001, 43TC001 í˜•ì‹ ë˜ëŠ” 1 í˜•ì‹ ì§€ì›)
                            let columnId = null;
                            let subIndex = 1; // ê¸°ë³¸ê°’
                            let originalColNo = String(colNo).trim(); // ì›ë³¸ ê¸°ë‘¥ë²ˆí˜¸ ì €ì¥
                            
                            const colNoStr = originalColNo;
                            
                            // 1C001 ë˜ëŠ” 43TC001 í˜•ì‹ì¸ì§€ í™•ì¸ (C ë˜ëŠ” TC í¬í•¨, ì„œë¸Œ ë²ˆí˜¸ëŠ” 1-3ìë¦¬)
                            const matchFull = colNoStr.match(/^(\d+)(?:TC|C)(\d{1,3})$/i);
                            if (matchFull) {
                                columnId = parseInt(matchFull[1]);
                                const parsedSub = parseInt(matchFull[2]);
                                // ì„œë¸Œ ë²ˆí˜¸ê°€ 1-2 ë²”ìœ„ì¸ì§€ í™•ì¸
                                if (parsedSub >= 1 && parsedSub <= SUB_ITEMS_PER_COLUMN) {
                                    subIndex = parsedSub;
                                } else {
                                    // ì„œë¸Œ ë²ˆí˜¸ê°€ ë²”ìœ„ë¥¼ ë²—ì–´ë‚˜ë©´ ê¸°ë³¸ê°’ 1 ì‚¬ìš© (ì˜¤ë¥˜ ì—†ì´ ì²˜ë¦¬)
                                    subIndex = 1;
                                }
                            } else {
                                // ìˆ«ìë§Œ ì¶”ì¶œ (ê¸°ì¡´ í˜•ì‹ ì§€ì›)
                                const numbers = colNoStr.match(/\d+/g);
                                if (numbers && numbers.length > 0) {
                                    columnId = parseInt(numbers[0]);
                                    if (numbers.length > 1) {
                                        const parsedSub = parseInt(numbers[1]);
                                        // ì„œë¸Œ ë²ˆí˜¸ê°€ 1-2 ë²”ìœ„ì¸ì§€ í™•ì¸
                                        if (parsedSub >= 1 && parsedSub <= SUB_ITEMS_PER_COLUMN) {
                                            subIndex = parsedSub;
                                        } else {
                                            // ì„œë¸Œ ë²ˆí˜¸ê°€ ë²”ìœ„ë¥¼ ë²—ì–´ë‚˜ë©´ ê¸°ë³¸ê°’ 1 ì‚¬ìš© (ì˜¤ë¥˜ ì—†ì´ ì²˜ë¦¬)
                                            subIndex = 1;
                                        }
                                    }
                                }
                            }
                            
                            if (!columnId || columnId < 1 || columnId > TOTAL_COLUMNS) {
                                errorCount++;
                                errors.push(`í–‰ ${idx + 2}: ìœ íš¨í•˜ì§€ ì•Šì€ ê¸°ë‘¥ë²ˆí˜¸ì…ë‹ˆë‹¤ (${colNo}). 1-${TOTAL_COLUMNS} ë²”ìœ„ì—¬ì•¼ í•©ë‹ˆë‹¤.`);
                                return;
                            }
                            
                            // subIndexëŠ” ì´ë¯¸ 1-2 ë²”ìœ„ë¡œ ê²€ì¦ë˜ì—ˆìœ¼ë¯€ë¡œ ì¶”ê°€ ê²€ì¦ ë¶ˆí•„ìš”
                            const colId = getColumnId(columnId, subIndex);
                            
                            // ê¸°ë‘¥ì´ë¦„ì´ ì—†ìœ¼ë©´ ê¸°ë‘¥ë²ˆí˜¸ë¥¼ ê¸°ë‘¥ì´ë¦„ìœ¼ë¡œ ì‚¬ìš©
                            if (!colName || colName.trim() === '') {
                                colName = originalColNo; // ì›ë³¸ ê¸°ë‘¥ë²ˆí˜¸ë¥¼ ê¸°ë‘¥ì´ë¦„ìœ¼ë¡œ ì‚¬ìš©
                            }
                            
                            // ë‚ ì§œ ì°¾ê¸° (ê³µì •ë³„ë¡œ ë‹¤ë¥¸ í‚¤ ì‚¬ìš©)
                            let date = null;
                            if (processNum === 5) {
                                // í˜„ì¥ë°°ì†¡
                                date = row['í˜„ì¥ë°°ì†¡ë‚ ì§œ'] || row['ë°°ì†¡ë‚ ì§œ'] || row['ìš´ì†¡ë‚ ì§œ'] || row['ë‚ ì§œ'] || row['Date'] || 
                                       normalizedRow['í˜„ì¥ë°°ì†¡ë‚ ì§œ'] || normalizedRow['ë°°ì†¡ë‚ ì§œ'] || normalizedRow['ìš´ì†¡ë‚ ì§œ'] || 
                                       normalizedRow['ë‚ ì§œ'] || normalizedRow['date'];
                            } else {
                                // í˜„ì¥ì„¤ì¹˜
                                date = row['í˜„ì¥ì„¤ì¹˜ë‚ ì§œ'] || row['ì„¤ì¹˜ë‚ ì§œ'] || row['ë‚ ì§œ'] || row['Date'] || 
                                       normalizedRow['í˜„ì¥ì„¤ì¹˜ë‚ ì§œ'] || normalizedRow['ì„¤ì¹˜ë‚ ì§œ'] || normalizedRow['ë‚ ì§œ'] || 
                                       normalizedRow['date'];
                            }
                            
                            if (!date) {
                                errorCount++;
                                errors.push(`í–‰ ${idx + 2}: ë‚ ì§œê°€ ì—†ìŠµë‹ˆë‹¤.`);
                                return;
                            }
                            
                            // ë‚ ì§œ ì •ê·œí™”
                            let formattedDate = '';
                            if (date instanceof Date) {
                                const year = date.getFullYear();
                                const month = String(date.getMonth() + 1).padStart(2, '0');
                                const day = String(date.getDate()).padStart(2, '0');
                                formattedDate = `${year}-${month}-${day}`;
                            } else {
                                const dateStr = String(date).trim();
                                if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                                    formattedDate = dateStr;
                                } else if (dateStr.match(/^\d{4}\/\d{2}\/\d{2}$/)) {
                                    formattedDate = dateStr.replace(/\//g, '-');
                                } else if (/^\d+\.?\d*$/.test(dateStr) && parseFloat(dateStr) > 0 && parseFloat(dateStr) < 1000000) {
                                    // Excel serial number
                                    const excelEpoch = new Date(1899, 11, 30);
                                    const serialNumber = parseFloat(dateStr);
                                    const dateObj = new Date(excelEpoch.getTime() + serialNumber * 24 * 60 * 60 * 1000);
                                    if (!isNaN(dateObj.getTime())) {
                                        const year = dateObj.getFullYear();
                                        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                                        const day = String(dateObj.getDate()).padStart(2, '0');
                                        formattedDate = `${year}-${month}-${day}`;
                                    }
                                } else {
                                    const dateObj = new Date(dateStr);
                                    if (!isNaN(dateObj.getTime()) && dateObj.getFullYear() > 1900) {
                                        const year = dateObj.getFullYear();
                                        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                                        const day = String(dateObj.getDate()).padStart(2, '0');
                                        formattedDate = `${year}-${month}-${day}`;
                                    }
                                }
                            }
                            
                            if (!formattedDate) {
                                errorCount++;
                                errors.push(`í–‰ ${idx + 2}: ìœ íš¨í•˜ì§€ ì•Šì€ ë‚ ì§œ í˜•ì‹ì…ë‹ˆë‹¤.`);
                                return;
                            }
                            
                            // dailyData ì´ˆê¸°í™”
                            if (!dailyData[formattedDate]) {
                                dailyData[formattedDate] = {};
                            }
                            if (!dailyData[formattedDate][processNum]) {
                                dailyData[formattedDate][processNum] = [];
                            }
                            
                            // ê¸°ë‘¥ ì¶”ê°€ (ì¤‘ë³µ ì œê±°)
                            if (!dailyData[formattedDate][processNum].includes(colId) && 
                                !dailyData[formattedDate][processNum].includes(columnId) &&
                                !dailyData[formattedDate][processNum].includes(String(columnId))) {
                                dailyData[formattedDate][processNum].push(colId);
                            }
                            
                            // columnData ì—…ë°ì´íŠ¸
                            if (!columnData[colId]) {
                                columnData[colId] = { status: 0, lastUpdate: '', name: '' };
                            }
                            // ê¸°ë‘¥ ì´ë¦„ ì €ì¥ (ì—‘ì…€ì—ì„œ ì½ì€ ì´ë¦„)
                            if (colName && colName.trim()) {
                                columnData[colId].name = colName.trim();
                            }
                            if (processNum === 6) {
                                // í˜„ì¥ì„¤ì¹˜ëŠ” statusë¥¼ 6ìœ¼ë¡œ ì—…ë°ì´íŠ¸
                                columnData[colId].status = 6;
                                columnData[colId].lastUpdate = formattedDate;
                            } else if (processNum === 5) {
                                // í˜„ì¥ë°°ì†¡ì€ statusë¥¼ ì—…ë°ì´íŠ¸í•˜ì§€ ì•ŠìŒ (ìš´ì†¡ì°¨ìˆ˜ê³„íšê³¼ ë™ì¼í•˜ê²Œ ì²˜ë¦¬)
                                // dailyDataì—ë§Œ ì €ì¥
                            }
                            
                            successCount++;
                        } catch (err) {
                            errorCount++;
                            errors.push(`í–‰ ${idx + 2}: ${err.message || 'ì²˜ë¦¬ ì˜¤ë¥˜'}`);
                        }
                    });
                    
                    // ë¹ˆ ë°°ì—´ ì •ë¦¬
                    for (let date in dailyData) {
                        if (dailyData[date]) {
                            if (dailyData[date][processNum] && dailyData[date][processNum].length === 0) {
                                delete dailyData[date][processNum];
                            }
                            if (Object.keys(dailyData[date]).length === 0) {
                                delete dailyData[date];
                            }
                        }
                    }
                    
                    // ì €ì¥
                    saveToStorage();
                    
                    // í™”ë©´ ì—…ë°ì´íŠ¸
                    renderColumnGrid('column-grid-overview');
                    renderColumnGrid('column-grid-input');
                    updateProgressBars();
                    renderGanttChart();
                    
                    // ê²°ê³¼ ë©”ì‹œì§€
                    let message = `âœ… ${processName} ì—…ë¡œë“œ ì™„ë£Œ: ${successCount}ê°œ ê¸°ë‘¥ ì²˜ë¦¬ë¨`;
                    if (errorCount > 0) {
                        message += `\nâš ï¸ ì˜¤ë¥˜: ${errorCount}ê°œ í–‰ ì²˜ë¦¬ ì‹¤íŒ¨`;
                        if (errors.length > 0 && errors.length <= 10) {
                            message += '\n\nì˜¤ë¥˜ ìƒì„¸:\n' + errors.slice(0, 10).join('\n');
                        }
                    }
                    
                    alert(message);
                    
                    if (statusEl) {
                        statusEl.textContent = `${processName} ì—…ë¡œë“œ ì™„ë£Œ: ${successCount}ê°œ ê¸°ë‘¥ ì²˜ë¦¬ë¨`;
                    }
                    
                } catch (err) {
                    console.error('ê³µì • 5-6 ì—‘ì…€ ì²˜ë¦¬ ì˜¤ë¥˜:', err);
                    alert('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í…œí”Œë¦¿ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.\n\nì˜¤ë¥˜: ' + err.message);
                    if (statusEl) statusEl.textContent = 'âš ï¸ íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // ìš´ì†¡ì°¨ìˆ˜ê³„íš: í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ (ì—‘ì…€ í˜•ì‹) - í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€
        function downloadTransportPlanTemplate() {
            downloadProcessTemplate(5);
        }

        // ìš´ì†¡ì°¨ìˆ˜ê³„íš: ì—‘ì…€ ì—…ë¡œë“œ ì²˜ë¦¬
        function handleTransportPlanFile(event) {
            const file = event.target.files[0];
            const statusEl = document.getElementById('transport-plan-status');
            
            if (!file) {
                if (statusEl) statusEl.textContent = 'íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.';
                return;
            }
            
            // ê¶Œí•œ ì²´í¬: ìš´ì†¡ì°¨ìˆ˜ê³„íšì€ Adminë§Œ ì‚¬ìš© ê°€ëŠ¥
            if (userRole !== 'admin') {
                alert('âš ï¸ ê¶Œí•œ ì—†ìŒ\n\nìš´ì†¡ì°¨ìˆ˜ê³„íšì€ ê´€ë¦¬ì(Admin)ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                if (statusEl) statusEl.textContent = 'âš ï¸ ê¶Œí•œ ì—†ìŒ';
                return;
            }
            
            if (typeof XLSX === 'undefined') {
                alert('ì—‘ì…€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (statusEl) statusEl.textContent = 'íŒŒì¼ì„ ì½ëŠ” ì¤‘...';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true, cellNF: false, cellText: false });
                    const firstSheet = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[firstSheet];
                    const rows = XLSX.utils.sheet_to_json(sheet, { defval: '', raw: false, dateNF: 'yyyy-mm-dd' });
                    
                    if (rows.length === 0) {
                        alert('ì—‘ì…€ íŒŒì¼ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                        if (statusEl) statusEl.textContent = 'âš ï¸ íŒŒì¼ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
                        return;
                    }
                    
                    // ê¸°ì¡´ ìš´ì†¡ì°¨ìˆ˜ê³„íš ë°±ì—… (ì„ íƒì‚¬í•­: ë®ì–´ì“¸ì§€ í™•ì¸)
                    const shouldOverwrite = confirm('ê¸°ì¡´ ìš´ì†¡ì°¨ìˆ˜ê³„íšì„ ì—‘ì…€ ë°ì´í„°ë¡œ ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì·¨ì†Œë¥¼ ì„ íƒí•˜ë©´ ê¸°ì¡´ ë°ì´í„°ì— ì¶”ê°€ë©ë‹ˆë‹¤.');
                    
                    if (shouldOverwrite) {
                        transportPlan = {};
                    }
                    
                    let successCount = 0;
                    let errorCount = 0;
                    const errors = [];
                    
                    // ì—‘ì…€ ë°ì´í„° íŒŒì‹±
                    rows.forEach((row, idx) => {
                        try {
                            // í—¤ë” í˜•ì‹ í™•ì¸: "ê¸°ë‘¥ë²ˆí˜¸, ì°¨ìˆ˜, ìš´ì†¡ë‚ ì§œ" ë˜ëŠ” "ìš´ì†¡ì°¨ìˆ˜ê³„íš(XXì°¨)" í˜•ì‹ ì§€ì›
                            const colNo = row['ê¸°ë‘¥ë²ˆí˜¸'] || row['ê¸°ë‘¥ë²ˆí˜¸'] || '';
                            
                            // ì°¨ìˆ˜ ì¶”ì¶œ: "ì°¨ìˆ˜" ì»¬ëŸ¼ ë˜ëŠ” "ìš´ì†¡ì°¨ìˆ˜ê³„íš(XXì°¨)" í˜•ì‹
                            let tripNum = null;
                            let date = '';
                            
                            // 1. "ì°¨ìˆ˜" ì»¬ëŸ¼ì—ì„œ ì§ì ‘ ì¶”ì¶œ (ìƒˆ í˜•ì‹)
                            if (row['ì°¨ìˆ˜']) {
                                const tripStr = String(row['ì°¨ìˆ˜']).trim();
                                const tripMatch = tripStr.match(/(\d+)/);
                                if (tripMatch) {
                                    tripNum = tripMatch[1];
                                }
                            }
                            
                            // 2. "ìš´ì†¡ë‚ ì§œ" ì»¬ëŸ¼ì—ì„œ ë‚ ì§œ ì¶”ì¶œ (ìƒˆ í˜•ì‹)
                            // ë‹¤ì–‘í•œ í—¤ë”ëª… ì§€ì› (ëŒ€ì†Œë¬¸ì, ê³µë°± ë¬´ì‹œ)
                            const dateKeys = ['ìš´ì†¡ë‚ ì§œ', 'ìš´ì†¡ ë‚ ì§œ', 'ë‚ ì§œ', 'date', 'Date', 'DATE', 'ìš´ì†¡ì¼', 'ìš´ì†¡ ì¼'];
                            for (const key of dateKeys) {
                                if (row[key]) {
                                    date = String(row[key]).trim();
                                    break;
                                }
                            }
                            
                            // í—¤ë”ëª…ì— "ë‚ ì§œ" ë˜ëŠ” "date"ê°€ í¬í•¨ëœ ê²½ìš°ë„ ì°¾ê¸°
                            if (!date) {
                                const dateKey = Object.keys(row).find(key => {
                                    const normalized = key.trim().toLowerCase();
                                    return normalized.includes('ë‚ ì§œ') || normalized.includes('date');
                                });
                                if (dateKey) {
                                    date = String(row[dateKey]).trim();
                                }
                            }
                            
                            // 3. "ìš´ì†¡ì°¨ìˆ˜ê³„íš(XXì°¨)" í˜•ì‹ì—ì„œ ì°¨ìˆ˜ ì¶”ì¶œ (ê¸°ì¡´ í˜•ì‹ í˜¸í™˜)
                            if (!tripNum) {
                                const transportPlanKey = Object.keys(row).find(key => 
                                    key.includes('ìš´ì†¡ì°¨ìˆ˜ê³„íš') && key.includes('ì°¨')
                                );
                                if (transportPlanKey) {
                                    const match = transportPlanKey.match(/\((\d+)ì°¨\)/);
                                    if (match) {
                                        tripNum = match[1];
                                    }
                                }
                            }
                            
                            // 4. "ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš(12ì°¨)" í˜•ì‹ë„ í™•ì¸ (ìš°ì„ ìˆœìœ„ ë‚®ìŒ)
                            if (!tripNum) {
                                const adjustedPlanKey = Object.keys(row).find(key => 
                                    key.includes('ì¡°ì •ëœ') && key.includes('ì°¨ìˆ˜ê³„íš') && key.includes('ì°¨')
                                );
                                if (adjustedPlanKey) {
                                    const match = adjustedPlanKey.match(/\((\d+)ì°¨\)/);
                                    if (match) {
                                        tripNum = match[1];
                                    }
                                }
                            }
                            
                            if (!colNo) {
                                errorCount++;
                                errors.push(`í–‰ ${idx + 2}: ê¸°ë‘¥ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤.`);
                                return;
                            }
                            
                            // ê¸°ë‘¥ë²ˆí˜¸ íŒŒì‹± (1C001, 43TC001 í˜•ì‹ ë˜ëŠ” 1 í˜•ì‹ ì§€ì›)
                            let columnId = null;
                            let subIndex = 1; // ê¸°ë³¸ê°’
                            let originalColNo = String(colNo).trim(); // ì›ë³¸ ê¸°ë‘¥ë²ˆí˜¸ ì €ì¥
                            
                            const colNoStr = originalColNo;
                            
                            // 1C001 ë˜ëŠ” 43TC001 í˜•ì‹ì¸ì§€ í™•ì¸ (C ë˜ëŠ” TC í¬í•¨, ì„œë¸Œ ë²ˆí˜¸ëŠ” 1-3ìë¦¬)
                            const matchFull = colNoStr.match(/^(\d+)(?:TC|C)(\d{1,3})$/i);
                            if (matchFull) {
                                columnId = parseInt(matchFull[1]);
                                const parsedSub = parseInt(matchFull[2]);
                                // ì„œë¸Œ ë²ˆí˜¸ê°€ 1-2 ë²”ìœ„ì¸ì§€ í™•ì¸
                                if (parsedSub >= 1 && parsedSub <= SUB_ITEMS_PER_COLUMN) {
                                    subIndex = parsedSub;
                                } else {
                                    // ì„œë¸Œ ë²ˆí˜¸ê°€ ë²”ìœ„ë¥¼ ë²—ì–´ë‚˜ë©´ ê¸°ë³¸ê°’ 1 ì‚¬ìš© (ì˜¤ë¥˜ ì—†ì´ ì²˜ë¦¬)
                                    subIndex = 1;
                                }
                            } else {
                                // ìˆ«ìë§Œ ì¶”ì¶œ (ê¸°ì¡´ í˜•ì‹ ì§€ì›)
                                const numbers = colNoStr.match(/\d+/g);
                                if (numbers && numbers.length > 0) {
                                    columnId = parseInt(numbers[0]);
                                    if (numbers.length > 1) {
                                        const parsedSub = parseInt(numbers[1]);
                                        // ì„œë¸Œ ë²ˆí˜¸ê°€ 1-2 ë²”ìœ„ì¸ì§€ í™•ì¸
                                        if (parsedSub >= 1 && parsedSub <= SUB_ITEMS_PER_COLUMN) {
                                            subIndex = parsedSub;
                                        } else {
                                            // ì„œë¸Œ ë²ˆí˜¸ê°€ ë²”ìœ„ë¥¼ ë²—ì–´ë‚˜ë©´ ê¸°ë³¸ê°’ 1 ì‚¬ìš© (ì˜¤ë¥˜ ì—†ì´ ì²˜ë¦¬)
                                            subIndex = 1;
                                        }
                                    }
                                }
                            }
                            
                            if (!columnId || columnId < 1 || columnId > TOTAL_COLUMNS) {
                                errorCount++;
                                errors.push(`í–‰ ${idx + 2}: ìœ íš¨í•˜ì§€ ì•Šì€ ê¸°ë‘¥ë²ˆí˜¸ì…ë‹ˆë‹¤ (${colNo}). 1-${TOTAL_COLUMNS} ë²”ìœ„ì—¬ì•¼ í•©ë‹ˆë‹¤.`);
                                return;
                            }
                            
                            // colId ìƒì„± (ìš´ì†¡ì°¨ìˆ˜ê³„íšì—ì„œëŠ” ê¸°ë³¸ ì„œë¸Œ í•­ëª©(001) ì‚¬ìš©)
                            const colId = getColumnId(columnId, subIndex);
                            
                            // ì°¨ìˆ˜ ì •ê·œí™”
                            const tripNumber = parseInt(String(tripNum).replace(/[^0-9]/g, '')) || 1;
                            
                            // ë‚ ì§œ ì •ê·œí™” (YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ë³€í™˜)
                            let formattedDate = '';
                            if (date) {
                                let dateStr = String(date).trim();
                                
                                // ë¹ˆ ë¬¸ìì—´ ì²´í¬
                                if (!dateStr || dateStr === '' || dateStr === 'undefined' || dateStr === 'null') {
                                    formattedDate = '';
                                } else {
                                    // Date ê°ì²´ì¸ ê²½ìš°
                                    if (date instanceof Date) {
                                        const year = date.getFullYear();
                                        const month = String(date.getMonth() + 1).padStart(2, '0');
                                        const day = String(date.getDate()).padStart(2, '0');
                                        formattedDate = `${year}-${month}-${day}`;
                                    }
                                    // YYYY-MM-DD í˜•ì‹
                                    else if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                                        formattedDate = dateStr;
                                    }
                                    // YYYY/MM/DD í˜•ì‹
                                    else if (dateStr.match(/^\d{4}\/\d{2}\/\d{2}$/)) {
                                        formattedDate = dateStr.replace(/\//g, '-');
                                    }
                                    // Excel serial number í˜•ì‹ (ì˜ˆ: 44927)
                                    else if (/^\d+\.?\d*$/.test(dateStr) && parseFloat(dateStr) > 0 && parseFloat(dateStr) < 1000000) {
                                        // Excel serial numberë¥¼ ë‚ ì§œë¡œ ë³€í™˜ (1900-01-01 ê¸°ì¤€)
                                        const excelEpoch = new Date(1899, 11, 30); // Excel epoch: 1899-12-30
                                        const serialNumber = parseFloat(dateStr);
                                        const dateObj = new Date(excelEpoch.getTime() + serialNumber * 24 * 60 * 60 * 1000);
                                        if (!isNaN(dateObj.getTime())) {
                                            const year = dateObj.getFullYear();
                                            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                                            const day = String(dateObj.getDate()).padStart(2, '0');
                                            formattedDate = `${year}-${month}-${day}`;
                                        }
                                    }
                                    // ì¼ë°˜ ë‚ ì§œ ë¬¸ìì—´ íŒŒì‹±
                                    else {
                                        const dateObj = new Date(dateStr);
                                        if (!isNaN(dateObj.getTime()) && dateObj.getFullYear() > 1900) {
                                            const year = dateObj.getFullYear();
                                            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                                            const day = String(dateObj.getDate()).padStart(2, '0');
                                            formattedDate = `${year}-${month}-${day}`;
                                        }
                                    }
                                }
                            }
                            
                            // ì°¨ìˆ˜ ë°ì´í„° ì´ˆê¸°í™”
                            if (!transportPlan[tripNumber]) {
                                transportPlan[tripNumber] = { columns: [], date: '' };
                            }
                            
                            // ê¸°ë‘¥ ì¶”ê°€ (ì¤‘ë³µ ì œê±°) - colId í˜•ì‹ìœ¼ë¡œ ì €ì¥
                            if (!transportPlan[tripNumber].columns.includes(colId)) {
                                transportPlan[tripNumber].columns.push(colId);
                            }
                            
                            // ë‚ ì§œê°€ ìˆìœ¼ë©´ ì°¨ìˆ˜ì˜ ë‚ ì§œë¡œ ì„¤ì • (ê°™ì€ ì°¨ìˆ˜ ë‚´ì—ì„œ ì²« ë²ˆì§¸ ìœ íš¨í•œ ë‚ ì§œ ì‚¬ìš©, ì—†ìœ¼ë©´ ë§ˆì§€ë§‰ ë‚ ì§œë¡œ ì—…ë°ì´íŠ¸)
                            if (formattedDate) {
                                // ì°¨ìˆ˜ì— ë‚ ì§œê°€ ì—†ê±°ë‚˜, í˜„ì¬ ë‚ ì§œê°€ ë” ì´ì „ ë‚ ì§œì¸ ê²½ìš° ì—…ë°ì´íŠ¸ (ì²« ë²ˆì§¸ ë‚ ì§œ ìš°ì„ )
                                if (!transportPlan[tripNumber].date || formattedDate < transportPlan[tripNumber].date) {
                                transportPlan[tripNumber].date = formattedDate;
                                }
                            }
                            
                            // ë””ë²„ê¹…: ì²« ë²ˆì§¸ í–‰ê³¼ ë§ˆì§€ë§‰ í–‰ì˜ ë‚ ì§œ ì •ë³´ ì¶œë ¥
                            if (idx === 0 || idx === rows.length - 1) {
                                console.log(`í–‰ ${idx + 2}: ì°¨ìˆ˜=${tripNumber}, ì›ë³¸ë‚ ì§œ="${date}", ë³€í™˜ëœë‚ ì§œ="${formattedDate}", ê¸°ë‘¥ë²ˆí˜¸="${colNo}"`);
                            }
                            
                            successCount++;
                        } catch (err) {
                            errorCount++;
                            errors.push(`í–‰ ${idx + 2}: ${err.message || 'ì²˜ë¦¬ ì˜¤ë¥˜'}`);
                        }
                    });
                    
                    // ì°¨ìˆ˜ë³„ë¡œ ê¸°ë‘¥ ì •ë ¬ (colId í˜•ì‹ ê¸°ì¤€)
                    for (let tripNum in transportPlan) {
                        if (transportPlan[tripNum].columns) {
                            transportPlan[tripNum].columns.sort((a, b) => {
                                const numA = getColumnIndexFromId(String(a)) || parseInt(String(a).replace(/[^0-9]/g, '')) || 0;
                                const numB = getColumnIndexFromId(String(b)) || parseInt(String(b).replace(/[^0-9]/g, '')) || 0;
                                if (numA !== numB) return numA - numB;
                                // ê°™ì€ ê¸°ë‘¥ ë²ˆí˜¸ë©´ ì„œë¸Œ ì¸ë±ìŠ¤ë¡œ ì •ë ¬
                                const subA = getSubIndexFromId(String(a)) || 1;
                                const subB = getSubIndexFromId(String(b)) || 1;
                                return subA - subB;
                            });
                        }
                    }
                    
                    // ë””ë²„ê¹…: ìµœì¢… ì €ì¥ëœ ì°¨ìˆ˜ë³„ ë‚ ì§œ ì •ë³´ ì¶œë ¥
                    console.log('ğŸ“… ì—‘ì…€ ì—…ë¡œë“œ í›„ ì°¨ìˆ˜ë³„ ë‚ ì§œ ì •ë³´:');
                    const sortedTrips = Object.keys(transportPlan).map(Number).sort((a, b) => a - b);
                    sortedTrips.forEach(tripNum => {
                        const tripData = transportPlan[tripNum];
                        console.log(`  ${tripNum}ì°¨: ${tripData.date || '(ë‚ ì§œ ì—†ìŒ)'}, ê¸°ë‘¥ ${tripData.columns?.length || 0}ê°œ`);
                    });
                    
                    // í™”ë©´ ì—…ë°ì´íŠ¸
                    renderTransportTrips();
                    renderTransportColumnGrid();
                    updateTransportTripInfo();
                    
                    // ê²°ê³¼ ë©”ì‹œì§€
                    let message = `âœ… ì—…ë¡œë“œ ì™„ë£Œ: ${successCount}ê°œ ê¸°ë‘¥ ì²˜ë¦¬ë¨`;
                    if (errorCount > 0) {
                        message += `\nâš ï¸ ì˜¤ë¥˜: ${errorCount}ê°œ í–‰ ì²˜ë¦¬ ì‹¤íŒ¨`;
                        if (errors.length > 0 && errors.length <= 10) {
                            message += '\n\nì˜¤ë¥˜ ìƒì„¸:\n' + errors.slice(0, 10).join('\n');
                        }
                    }
                    
                    alert(message);
                    
                    if (statusEl) {
                        statusEl.textContent = `ì—…ë¡œë“œ ì™„ë£Œ: ${successCount}ê°œ ê¸°ë‘¥, ${Object.keys(transportPlan).length}ê°œ ì°¨ìˆ˜`;
                    }
                    
                    // ìë™ ì €ì¥ ë° ë™ê¸°í™” (ê³µì •í‘œì— ë°˜ì˜)
                    // localStorageì— ì €ì¥
                    localStorage.setItem(kcolKey('transportPlan'), JSON.stringify(transportPlan));
                    
                    // dailyDataì— ë™ê¸°í™” (í™•ì¸ ì—†ì´ ìë™ ë™ê¸°í™”)
                    const syncResult = syncTransportToDailyData(false);
                    if (syncResult) {
                        // í™”ë©´ ì—…ë°ì´íŠ¸
                        renderGanttChart();
                        renderColumnGrid('column-grid-overview');
                        renderColumnGrid('column-grid-input');
                        updateProgressBars();
                    }
                    
                    
                } catch (err) {
                    console.error('ìš´ì†¡ì°¨ìˆ˜ê³„íš ì—‘ì…€ ì²˜ë¦¬ ì˜¤ë¥˜:', err);
                    alert('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í…œí”Œë¦¿ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.\n\nì˜¤ë¥˜: ' + err.message);
                    if (statusEl) statusEl.textContent = 'âš ï¸ íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // ìš´ì†¡ë¬¼ëŸ‰ì‚°ì •: í‘œ ë Œë”ë§
        // opts: ì—†ìŒ | ë°°ì—´(data) | { startIndex, endIndex } (PDFìš© í•´ë‹¹ ë²”ìœ„ë§Œ tbody ë Œë”, thead ìœ ì§€)
        function renderTransportVolumeTable(dataOrOpts) {
            const tbody = document.getElementById('transport-volume-tbody');
            if (!tbody) return;

            const isPdfSlice = dataOrOpts && typeof dataOrOpts === 'object' && 'startIndex' in dataOrOpts && 'endIndex' in dataOrOpts;
            let dataSlice;
            let data;
            let filteredData;
            if (isPdfSlice) {
                data = transportVolumeData.slice(dataOrOpts.startIndex, dataOrOpts.endIndex);
                dataSlice = data;
            } else {
                data = (dataOrOpts != null && Array.isArray(dataOrOpts)) ? dataOrOpts : transportVolumeData;
                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#888;padding:16px;">ì—‘ì…€ì„ ì—…ë¡œë“œí•˜ë©´ ì—¬ê¸°ì—ì„œ 100ê°œ ê¸°ë‘¥ ë°ì´í„°ê°€ í‘œì‹œë©ë‹ˆë‹¤.</td></tr>';
                    return;
                }
                // ê·œê²©ë³„ í•„í„° ì ìš©
                filteredData = data;
                if (selectedSizes && selectedSizes.length > 0) {
                    filteredData = filteredData.filter(item => {
                        const size = String(item.size || '').trim();
                        return selectedSizes.includes(size);
                    });
                }
                // ì°¨ìˆ˜ë³„ í•„í„° ì ìš©
                if (selectedTrips && selectedTrips.length > 0) {
                    filteredData = filteredData.filter(item => {
                        const colNo = item.no || item.colNo || '';
                        if (!colNo) return false;
                        let foundOriginalTrip = null;
                        if (transportPlan && Object.keys(transportPlan).length > 0) {
                            for (let tripNum in transportPlan) {
                                const tripData = transportPlan[tripNum];
                                if (tripData && tripData.columns) {
                                    const found = tripData.columns.some(col => {
                                        const colStr = String(col);
                                        const colNoStr = String(colNo);
                                        if (colStr === colNoStr) return true;
                                        const colNum = parseInt(colStr.replace(/[^0-9]/g, ''));
                                        const colNoNum = parseInt(colNoStr.replace(/[^0-9]/g, ''));
                                        if (colNum && colNoNum && colNum === colNoNum) return true;
                                        return false;
                                    });
                                    if (found) { foundOriginalTrip = parseInt(tripNum); break; }
                                }
                            }
                        }
                        let foundAdjustedTrip = null;
                        if (adjustedTransportPlan && Object.keys(adjustedTransportPlan).length > 0) {
                            for (let tripNum in adjustedTransportPlan) {
                                const tripData = adjustedTransportPlan[tripNum];
                                if (tripData && tripData.columns) {
                                    const found = tripData.columns.some(col => {
                                        const colStr = String(col);
                                        const colNoStr = String(colNo);
                                        if (colStr === colNoStr) return true;
                                        const colNum = parseInt(colStr.replace(/[^0-9]/g, ''));
                                        const colNoNum = parseInt(colNoStr.replace(/[^0-9]/g, ''));
                                        if (colNum && colNoNum && colNum === colNoNum) return true;
                                        return false;
                                    });
                                    if (found) { foundAdjustedTrip = parseInt(tripNum); break; }
                                }
                            }
                        }
                        const originalTripKey = foundOriginalTrip ? `original_${foundOriginalTrip}` : null;
                        const adjustedTripKey = foundAdjustedTrip ? `adjusted_${foundAdjustedTrip}` : null;
                        return (originalTripKey && selectedTrips.includes(originalTripKey)) || (adjustedTripKey && selectedTrips.includes(adjustedTripKey));
                    });
                }
                dataSlice = filteredData.slice(0, 100);
            }

            if (dataSlice.length === 0 && !isPdfSlice) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#888;padding:16px;">ì—‘ì…€ì„ ì—…ë¡œë“œí•˜ë©´ ì—¬ê¸°ì—ì„œ 100ê°œ ê¸°ë‘¥ ë°ì´í„°ê°€ í‘œì‹œë©ë‹ˆë‹¤.</td></tr>';
                return;
            }
            if (dataSlice.length === 0 && isPdfSlice) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#888;padding:12px;">í•´ë‹¹ êµ¬ê°„ ë°ì´í„° ì—†ìŒ</td></tr>';
                return;
            }
            const rows = dataSlice.map((item, itemIdx) => {
                const isLastRow = itemIdx === dataSlice.length - 1;
                const nextItem = itemIdx < dataSlice.length - 1 ? dataSlice[itemIdx + 1] : null;
                // ì •ê·œí™”ëœ í•„ë“œëª…ìœ¼ë¡œ ë¨¼ì € ì ‘ê·¼, ì—†ìœ¼ë©´ ì›ë³¸ ë°ì´í„°ì—ì„œ ì°¾ê¸°
                const workType = item.workType || '';
                const drawingNo = item.drawingNo || '';
                const colNo = item.no || '';
                const size = item.size || '';
                const length = item.length || '';
                const weight = item.weight || '';
                
                // ìˆ«ì í¬ë§·íŒ… (ì²œ ë‹¨ìœ„ êµ¬ë¶„ ê¸°í˜¸)
                const formatNumber = (val) => {
                    if (!val || val === '') return '';
                    const num = parseFloat(String(val).replace(/,/g, ''));
                    if (isNaN(num)) return val;
                    return num.toLocaleString('ko-KR');
                };
                
                const formattedLength = formatNumber(length);
                const formattedWeight = formatNumber(weight);
                // ê¸°ë‘¥ë²ˆí˜¸ì™€ ì¼ì¹˜í•˜ëŠ” ìš´ì†¡ì°¨ìˆ˜ê³„íšì˜ ì°¨ìˆ˜ ì°¾ê¸°
                let actualTransportPlanTrip = null;
                let transportPlanDate = '';
                let isInTransportPlan = false;
                let transportPlanStatus = '';
                
                if (colNo) {
                    // ì „ì—­ transportPlan ë³€ìˆ˜ì—ì„œ í•´ë‹¹ ê¸°ë‘¥ì´ ì†í•œ ì°¨ìˆ˜ ì°¾ê¸°
                    const colId = colNo;
                    const colIndex = getColumnIndexFromId(colId);
                    const colSubIndex = getSubIndexFromId(colId);
                    
                    // ëª¨ë“  ì°¨ìˆ˜ë¥¼ ìˆœíšŒí•˜ë©° í•´ë‹¹ ê¸°ë‘¥ ì°¾ê¸°
                    for (let tripNum in transportPlan) {
                        const tripData = transportPlan[tripNum];
                        if (tripData && tripData.columns && tripData.columns.length > 0) {
                            const found = tripData.columns.some(col => {
                                if (col === colId) return true; // ì •í™•íˆ ì¼ì¹˜
                                
                                const colStr = String(col);
                                if (colStr === colId) return true; // ë¬¸ìì—´ë¡œ ì¼ì¹˜
                                
                                // colId í˜•ì‹ ë¹„êµ
                                const storedColIndex = getColumnIndexFromId(colStr);
                                const storedColSubIndex = getSubIndexFromId(colStr);
                                if (colIndex && storedColIndex && colIndex === storedColIndex) {
                                    // ì„œë¸Œ ì¸ë±ìŠ¤ë„ ë¹„êµ (ë‘˜ ë‹¤ ìˆìœ¼ë©´)
                                    if (colSubIndex && storedColSubIndex) {
                                        return colSubIndex === storedColSubIndex;
                                    }
                                    // ì„œë¸Œ ì¸ë±ìŠ¤ê°€ ì—†ìœ¼ë©´ ê¸°ë‘¥ ë²ˆí˜¸ë§Œ ì¼ì¹˜í•˜ë©´ OK
                                    return true;
                                }
                                
                                // ìˆ«ìë§Œ ì¶”ì¶œí•˜ì—¬ ë¹„êµ
                                const colNum = parseInt(colStr.replace(/[^0-9]/g, ''));
                                const colIdNum = parseInt(colId.replace(/[^0-9]/g, ''));
                                if (colNum && colIdNum && colNum === colIdNum) return true;
                                
                                return false;
                            });
                            
                            if (found) {
                                actualTransportPlanTrip = parseInt(tripNum);
                                transportPlanDate = tripData.date || '';
                                isInTransportPlan = true;
                                break;
                            }
                        }
                    }
                    
                    if (isInTransportPlan) {
                        transportPlanStatus = '';
                    } else {
                        transportPlanStatus = '';
                    }
                }
                
                // ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš í™•ì¸ (adjustedTransportPlanì—ì„œ ì°¾ê¸°)
                let actualAdjustedPlanTrip = null;
                let adjustedPlanDate = '';
                let isInAdjustedPlan = false;
                let adjustedPlanStatus = '';
                
                // ì¡°ì •ëœ ì°¨ìˆ˜ê³„íšì€ adjustedTransportPlanì—ì„œ ì°¾ê¸°
                if (colNo && adjustedTransportPlan && Object.keys(adjustedTransportPlan).length > 0) {
                    const colId = colNo;
                    const colIndex = getColumnIndexFromId(colId);
                    const colSubIndex = getSubIndexFromId(colId);
                    
                    // ëª¨ë“  ì°¨ìˆ˜ë¥¼ ìˆœíšŒí•˜ë©° í•´ë‹¹ ê¸°ë‘¥ ì°¾ê¸°
                    for (let tripNum in adjustedTransportPlan) {
                        const tripData = adjustedTransportPlan[tripNum];
                        if (tripData && tripData.columns && tripData.columns.length > 0) {
                            const found = tripData.columns.some(col => {
                                if (col === colId) return true;
                                const colStr = String(col);
                                if (colStr === colId) return true;
                                const storedColIndex = getColumnIndexFromId(colStr);
                                const storedColSubIndex = getSubIndexFromId(colStr);
                                if (colIndex && storedColIndex && colIndex === storedColIndex) {
                                    if (colSubIndex && storedColSubIndex) {
                                        return colSubIndex === storedColSubIndex;
                                    }
                                    return true;
                                }
                                const colNum = parseInt(colStr.replace(/[^0-9]/g, ''));
                                const colIdNum = parseInt(colId.replace(/[^0-9]/g, ''));
                                if (colNum && colIdNum && colNum === colIdNum) return true;
                                return false;
                            });
                            
                            if (found) {
                                actualAdjustedPlanTrip = parseInt(tripNum);
                                adjustedPlanDate = tripData.date || tripData.ìš´ì†¡ë‚ ì§œ || '';
                                isInAdjustedPlan = true;
                                break;
                            }
                        }
                    }
                    
                    if (isInAdjustedPlan) {
                        adjustedPlanStatus = '';
                    } else {
                        adjustedPlanStatus = '';
                    }
                }
                const tp = transportPlan && (transportPlan[actualAdjustedPlanTrip] || transportPlan[String(actualAdjustedPlanTrip)]);
                const adjustedPlanDateDisplay = adjustedPlanDate || (tp && (tp.date || tp.ìš´ì†¡ë‚ ì§œ || '')) || '';
                const adjustedPlanCellText = actualAdjustedPlanTrip ? (actualAdjustedPlanTrip + 'ì°¨' + (adjustedPlanDateDisplay ? ' ' + adjustedPlanDateDisplay : '')) : 'ï¼';
                
                // ë‹¤ìŒ í–‰ì˜ ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš í™•ì¸ (ì°¨ìˆ˜ ë³€ê²½ ê°ì§€ìš©)
                let nextAdjustedPlanTrip = null;
                if (nextItem && adjustedTransportPlan && Object.keys(adjustedTransportPlan).length > 0) {
                    const nextColNo = nextItem.no || '';
                    if (nextColNo) {
                        const nextColId = nextColNo;
                        const nextColIndex = getColumnIndexFromId(nextColId);
                        const nextColSubIndex = getSubIndexFromId(nextColId);
                        
                        for (let tripNum in adjustedTransportPlan) {
                            const tripData = adjustedTransportPlan[tripNum];
                            if (tripData && tripData.columns && tripData.columns.length > 0) {
                                const found = tripData.columns.some(col => {
                                    if (col === nextColId) return true;
                                    const colStr = String(col);
                                    if (colStr === nextColId) return true;
                                    const storedColIndex = getColumnIndexFromId(colStr);
                                    const storedColSubIndex = getSubIndexFromId(colStr);
                                    if (nextColIndex && storedColIndex && nextColIndex === storedColIndex) {
                                        if (nextColSubIndex && storedColSubIndex) {
                                            return nextColSubIndex === storedColSubIndex;
                                        }
                                        return true;
                                    }
                                    const colNum = parseInt(colStr.replace(/[^0-9]/g, ''));
                                    const colIdNum = parseInt(nextColId.replace(/[^0-9]/g, ''));
                                    if (colNum && colIdNum && colNum === colIdNum) return true;
                                    return false;
                                });
                                
                                if (found) {
                                    nextAdjustedPlanTrip = parseInt(tripNum);
                                    break;
                                }
                            }
                        }
                    }
                }
                
                return `
                    <tr>
                        <td style="text-align:center;">${workType || ''}</td>
                        <td style="text-align:center;">${drawingNo || ''}</td>
                        <td style="text-align:center;">${colNo || ''}</td>
                        <td>${size || ''}</td>
                        <td style="text-align:right;">${formattedLength || ''}</td>
                        <td style="text-align:right;">${formattedWeight || ''}</td>
                        <td style="text-align:center;${actualTransportPlanTrip && [2, 4, 6, 8, 10, 12].includes(actualTransportPlanTrip) ? 'background:#d0d0d0;' : ''}${!actualTransportPlanTrip ? 'color:#999;' : ''}" title="${actualTransportPlanTrip ? (isInTransportPlan ? `${actualTransportPlanTrip}ì°¨ìˆ˜ì— ì„ íƒë¨` : `${actualTransportPlanTrip}ì°¨ìˆ˜ì— ì„ íƒë˜ì§€ ì•ŠìŒ`) : 'ì°¨ìˆ˜ ì •ë³´ ì—†ìŒ'}">
                            ${actualTransportPlanTrip ? `${actualTransportPlanTrip}${transportPlanDate ? ' - ' + transportPlanDate : ''}` : 'ï¼'}
                        </td>
                        <td style="text-align:center;${actualAdjustedPlanTrip && [2, 4, 6, 8, 10, 12].includes(actualAdjustedPlanTrip) ? 'background:#d0d0d0;' : ''}${!actualAdjustedPlanTrip ? 'color:#999;' : ''}" title="ì¡°ì •ëœ ì°¨ìˆ˜ ì„ íƒ">
                            <span style="display:inline-block;margin-right:6px;">${adjustedPlanCellText}</span>
                            <select onchange="updateAdjustedPlanTripForColumn('${String(colNo || '').replace(/'/g, "\\'")}', this.value)" class="trip-select-no-scrollbar" style="width:auto;border:1px solid #ddd;border-radius:4px;background:#fff;cursor:pointer;vertical-align:middle;scrollbar-width:none;-ms-overflow-style:none;" title="1~12ì°¨ ì„ íƒ">
                                <option value="">ï¼</option>
                                ${[1,2,3,4,5,6,7,8,9,10,11,12].map(t => {
                                    const sel = actualAdjustedPlanTrip === t ? ' selected' : '';
                                    return `<option value="${t}"${sel}>${t}ì°¨</option>`;
                                }).join('')}
                            </select>
                        </td>
                    </tr>
                `;
            });
            tbody.innerHTML = rows.join('');

            // filteredData ì •ì˜ (ì „ì—­ ë³€ìˆ˜ ì‚¬ìš© ê¸ˆì§€) â€” !isPdfSliceì¼ ë•ŒëŠ” í•¨ìˆ˜ ìƒë‹¨ let filteredData, else ë¸”ë¡ì—ì„œ í•„í„° ì ìš© í›„ í• ë‹¹ë¨
            if (!isPdfSlice) {
                // ê·œê²©ë³„ í† ê¸€ ë²„íŠ¼ ìƒì„±
                renderSizeFilterToggles(data);
                // ì°¨ìˆ˜ë³„ í† ê¸€ ë²„íŠ¼ ìƒì„±
                renderTripFilterToggles(data);
                // í†µê³„ ì •ë³´ ì—…ë°ì´íŠ¸ (í•„í„°ë§ëœ ë°ì´í„° ê¸°ì¤€)
                updateTransportVolumeStats(filteredData);
                // ì°¨ìˆ˜ë³„ ì§‘ê³„ í…Œì´ë¸” ì—…ë°ì´íŠ¸
                renderTransportVolumeTripSummary(filteredData);
                renderAdjustedTripSummarySafe();
            }
        }
        
        // ê·œê²©ë³„ í•„í„° í† ê¸€ ë²„íŠ¼ ë Œë”ë§
        function renderSizeFilterToggles(data = transportVolumeData) {
            const togglesContainer = document.getElementById('transport-volume-size-toggles');
            if (!togglesContainer) return;
            
            if (!data || data.length === 0) {
                togglesContainer.innerHTML = '<div style="font-size:12px;color:#888;">ì—‘ì…€ì„ ì—…ë¡œë“œí•˜ë©´ ê·œê²©ë³„ í•„í„°ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>';
                return;
            }
            
            // ê³ ìœ í•œ ê·œê²© ì¶”ì¶œ
            const uniqueSizes = [];
            const sizeMap = new Map();
            
            data.forEach(item => {
                const size = String(item.size || '').trim();
                if (size && !sizeMap.has(size)) {
                    sizeMap.set(size, true);
                    uniqueSizes.push(size);
                }
            });
            
            // ê·œê²©ë³„ ê°œìˆ˜ ê³„ì‚°
            const sizeCounts = {};
            data.forEach(item => {
                const size = String(item.size || '').trim();
                if (size) {
                    sizeCounts[size] = (sizeCounts[size] || 0) + 1;
                }
            });
            
            // ìƒìœ„ 4ê°œ ê·œê²©ë§Œ í‘œì‹œ (ê°œìˆ˜ê°€ ë§ì€ ìˆœì„œë¡œ)
            const sortedSizes = uniqueSizes
                .sort((a, b) => (sizeCounts[b] || 0) - (sizeCounts[a] || 0))
                .slice(0, 4);
            
            if (sortedSizes.length === 0) {
                togglesContainer.innerHTML = '<div style="font-size:12px;color:#888;">ê·œê²© ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            // í† ê¸€ ë²„íŠ¼ ìƒì„±
            const toggles = sortedSizes.map(size => {
                const isSelected = selectedSizes && selectedSizes.includes(size);
                const count = sizeCounts[size] || 0;
                // íŠ¹ìˆ˜ë¬¸ì ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
                const escapedSize = size.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/\n/g, ' ').replace(/\r/g, '');
                return `
                    <button 
                        class="size-toggle-btn" 
                        data-size="${escapedSize}"
                        onclick="toggleSizeFilter('${escapedSize}')"
                        style="padding:6px 12px;border:2px solid ${isSelected ? '#2196f3' : '#ddd'};border-radius:6px;background:${isSelected ? '#e3f2fd' : '#fff'};color:${isSelected ? '#2196f3' : '#666'};cursor:pointer;font-size:12px;font-weight:${isSelected ? '600' : '400'};transition:all 0.2s;white-space:nowrap;"
                        onmouseover="this.style.borderColor='#2196f3';this.style.background='${isSelected ? '#e3f2fd' : '#f5f5f5'}';"
                        onmouseout="this.style.borderColor='${isSelected ? '#2196f3' : '#ddd'}';this.style.background='${isSelected ? '#e3f2fd' : '#fff'}';">
                        ${size} (${count})
                    </button>
                `;
            }).join('');
            
            togglesContainer.innerHTML = toggles;
        }
        
        // ê·œê²©ë³„ í•„í„° í† ê¸€ í•¨ìˆ˜
        function toggleSizeFilter(size) {
            if (!selectedSizes) {
                selectedSizes = [];
            }
            
            const index = selectedSizes.indexOf(size);
            if (index > -1) {
                // ì´ë¯¸ ì„ íƒëœ ê²½ìš° ì œê±°
                selectedSizes.splice(index, 1);
            } else {
                // ì„ íƒë˜ì§€ ì•Šì€ ê²½ìš° ì¶”ê°€
                selectedSizes.push(size);
            }
            
            // localStorageì— ì €ì¥
            localStorage.setItem(kcolKey('selectedSizes'), JSON.stringify(selectedSizes));
            
            // í…Œì´ë¸” ë‹¤ì‹œ ë Œë”ë§
            if (typeof renderTransportVolumeTable === 'function') {
                renderTransportVolumeTable();
            }
        }
        
        // ì°¨ìˆ˜ë³„ í•„í„° í† ê¸€ ë²„íŠ¼ ë Œë”ë§
        function renderTripFilterToggles(data = transportVolumeData) {
            const originalTogglesContainer = document.getElementById('transport-volume-trip-toggles-original');
            const adjustedTogglesContainer = document.getElementById('transport-volume-trip-toggles-adjusted');
            
            if (!originalTogglesContainer || !adjustedTogglesContainer) {
                console.warn('âš ï¸ ì°¨ìˆ˜ë³„ í•„í„° í† ê¸€ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ìš´ì†¡ì°¨ìˆ˜ê³„íš(13ì°¨)ê³¼ ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš(12ì°¨)ì˜ ì°¨ìˆ˜ ì¶”ì¶œ
            const originalTrips = new Set(); // ìš´ì†¡ì°¨ìˆ˜ê³„íš(13ì°¨)
            const adjustedTrips = new Set(); // ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš(12ì°¨)
            
            // transportPlanì—ì„œ ì°¨ìˆ˜ ì¶”ì¶œ (ìš´ì†¡ì°¨ìˆ˜ê³„íš 13ì°¨)
            if (transportPlan && Object.keys(transportPlan).length > 0) {
                Object.keys(transportPlan).forEach(tripNum => {
                    const tripNumInt = parseInt(tripNum);
                    if (tripNumInt > 0 && tripNumInt <= 13) {
                        originalTrips.add(tripNumInt);
                    }
                });
            }
            
            // adjustedTransportPlanì—ì„œ ì°¨ìˆ˜ ì¶”ì¶œ (ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš 12ì°¨)
            if (adjustedTransportPlan && Object.keys(adjustedTransportPlan).length > 0) {
                Object.keys(adjustedTransportPlan).forEach(tripNum => {
                    const tripNumInt = parseInt(tripNum);
                    if (tripNumInt > 0 && tripNumInt <= 13) {
                        adjustedTrips.add(tripNumInt);
                    }
                });
            }
            
            // ì°¨ìˆ˜ë³„ ê°œìˆ˜ ê³„ì‚° (ë°ì´í„°ì—ì„œ ì‹¤ì œë¡œ í•´ë‹¹ ì°¨ìˆ˜ì— ì†í•œ ê¸°ë‘¥ ê°œìˆ˜ ê³„ì‚°)
            const tripCounts = {};
            
            // ìš´ì†¡ì°¨ìˆ˜ê³„íš(13ì°¨) ê°œìˆ˜ ê³„ì‚°
            if (transportPlan && Object.keys(transportPlan).length > 0) {
                Object.keys(transportPlan).forEach(tripNum => {
                    const tripNumInt = parseInt(tripNum);
                    if (tripNumInt > 0 && tripNumInt <= 13) {
                        const tripData = transportPlan[tripNum];
                        if (tripData && tripData.columns) {
                            const tripKey = `original_${tripNumInt}`;
                            tripCounts[tripKey] = tripData.columns.length;
                        }
                    }
                });
            }
            
            // ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš(12ì°¨) ê°œìˆ˜ ê³„ì‚°
            if (adjustedTransportPlan && Object.keys(adjustedTransportPlan).length > 0) {
                Object.keys(adjustedTransportPlan).forEach(tripNum => {
                    const tripNumInt = parseInt(tripNum);
                    if (tripNumInt > 0 && tripNumInt <= 13) {
                        const tripData = adjustedTransportPlan[tripNum];
                        if (tripData && tripData.columns) {
                            const tripKey = `adjusted_${tripNumInt}`;
                            tripCounts[tripKey] = tripData.columns.length;
                        }
                    }
                });
            }
            
            // ìš´ì†¡ì°¨ìˆ˜ê³„íš(13ì°¨) í† ê¸€ ë²„íŠ¼ ìƒì„±
            const originalTripButtons = Array.from(originalTrips)
                .sort((a, b) => a - b)
                .map(tripNum => {
                    const tripKey = `original_${tripNum}`;
                    const count = tripCounts[tripKey] || 0;
                    const isSelected = selectedTrips && selectedTrips.includes(`original_${tripNum}`);
                    return `
                        <button 
                            class="trip-toggle-btn" 
                            data-trip="original_${tripNum}"
                            onclick="toggleTripFilter('original_${tripNum}')"
                            style="padding:6px 12px;border:2px solid ${isSelected ? '#2196f3' : '#ddd'};border-radius:6px;background:${isSelected ? '#e3f2fd' : '#fff'};color:${isSelected ? '#2196f3' : '#666'};cursor:pointer;font-size:12px;font-weight:${isSelected ? '600' : '400'};transition:all 0.2s;white-space:nowrap;"
                            onmouseover="this.style.borderColor='#2196f3';this.style.background='${isSelected ? '#e3f2fd' : '#f5f5f5'}';"
                            onmouseout="this.style.borderColor='${isSelected ? '#2196f3' : '#ddd'}';this.style.background='${isSelected ? '#e3f2fd' : '#fff'}';">
                            ${tripNum}ì°¨(${count})
                        </button>
                    `;
                }).join('');
            
            // ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš(12ì°¨) í† ê¸€ ë²„íŠ¼ ìƒì„±
            const adjustedTripButtons = Array.from(adjustedTrips)
                .sort((a, b) => a - b)
                .map(tripNum => {
                    const tripKey = `adjusted_${tripNum}`;
                    const count = tripCounts[tripKey] || 0;
                    const isSelected = selectedTrips && selectedTrips.includes(`adjusted_${tripNum}`);
                    return `
                        <button 
                            class="trip-toggle-btn" 
                            data-trip="adjusted_${tripNum}"
                            onclick="toggleTripFilter('adjusted_${tripNum}')"
                            style="padding:6px 12px;border:2px solid ${isSelected ? '#ff9800' : '#ddd'};border-radius:6px;background:${isSelected ? '#fff3e0' : '#fff'};color:${isSelected ? '#ff9800' : '#666'};cursor:pointer;font-size:12px;font-weight:${isSelected ? '600' : '400'};transition:all 0.2s;white-space:nowrap;"
                            onmouseover="this.style.borderColor='#ff9800';this.style.background='${isSelected ? '#fff3e0' : '#f5f5f5'}';"
                            onmouseout="this.style.borderColor='${isSelected ? '#ff9800' : '#ddd'}';this.style.background='${isSelected ? '#fff3e0' : '#fff'}';">
                            ${tripNum}ì°¨(${count})
                        </button>
                    `;
                }).join('');
            
            // ìš´ì†¡ì°¨ìˆ˜ê³„íš(13ì°¨) í† ê¸€ ë²„íŠ¼ í‘œì‹œ
            if (originalTrips.size === 0) {
                originalTogglesContainer.innerHTML = '<div style="font-size:12px;color:#888;">ìš´ì†¡ì°¨ìˆ˜ê³„íš ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            } else {
                originalTogglesContainer.innerHTML = originalTripButtons;
            }
            
            // ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš(12ì°¨) í† ê¸€ ë²„íŠ¼ í‘œì‹œ
            if (adjustedTrips.size === 0) {
                adjustedTogglesContainer.innerHTML = '<div style="font-size:12px;color:#888;">ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            } else {
                adjustedTogglesContainer.innerHTML = adjustedTripButtons;
            }
            
            // ì „ì²´ í† ê¸€ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateAllTripsToggleButtons();
        }
        
        // ì°¨ìˆ˜ë³„ í•„í„° í† ê¸€ í•¨ìˆ˜
        function toggleTripFilter(tripKey) {
            if (!selectedTrips) {
                selectedTrips = [];
            }
            
            const index = selectedTrips.indexOf(tripKey);
            if (index > -1) {
                // ì´ë¯¸ ì„ íƒëœ ê²½ìš° ì œê±°
                selectedTrips.splice(index, 1);
            } else {
                // ì„ íƒë˜ì§€ ì•Šì€ ê²½ìš° ì¶”ê°€
                selectedTrips.push(tripKey);
            }
            
            // localStorageì— ì €ì¥
            localStorage.setItem(kcolKey('selectedTrips'), JSON.stringify(selectedTrips));
            
            // ì „ì²´ í† ê¸€ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateAllTripsToggleButtons();
            
            // ì°¨ìˆ˜ë³„ í† ê¸€ ë²„íŠ¼ ë‹¤ì‹œ ë Œë”ë§
            if (typeof renderTripFilterToggles === 'function') {
                renderTripFilterToggles();
            }
            
            // í…Œì´ë¸” ë‹¤ì‹œ ë Œë”ë§
            if (typeof renderTransportVolumeTable === 'function') {
                renderTransportVolumeTable();
            }
        }
        
        // ì „ì²´ ì°¨ìˆ˜ í† ê¸€ í•¨ìˆ˜ (ì›13ì°¨ìˆ˜ ë˜ëŠ” ì¡°ì •12ì°¨ìˆ˜)
        function toggleAllTrips(type) {
            if (!selectedTrips) {
                selectedTrips = [];
            }
            
            // í•´ë‹¹ íƒ€ì…ì˜ ëª¨ë“  ì°¨ìˆ˜ ì°¾ê¸°
            const allTrips = [];
            if (type === 'original') {
                // ìš´ì†¡ì°¨ìˆ˜ê³„íš(13ì°¨)ì˜ ëª¨ë“  ì°¨ìˆ˜
                if (transportPlan && Object.keys(transportPlan).length > 0) {
                    Object.keys(transportPlan).forEach(tripNum => {
                        const tripNumInt = parseInt(tripNum);
                        if (tripNumInt > 0 && tripNumInt <= 13) {
                            allTrips.push(`original_${tripNumInt}`);
                        }
                    });
                }
            } else if (type === 'adjusted') {
                // ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš(12ì°¨)ì˜ ëª¨ë“  ì°¨ìˆ˜
                if (adjustedTransportPlan && Object.keys(adjustedTransportPlan).length > 0) {
                    Object.keys(adjustedTransportPlan).forEach(tripNum => {
                        const tripNumInt = parseInt(tripNum);
                        if (tripNumInt > 0 && tripNumInt <= 13) {
                            allTrips.push(`adjusted_${tripNumInt}`);
                        }
                    });
                }
            }
            
            if (allTrips.length === 0) return;
            
            // í˜„ì¬ ë²„íŠ¼ ìƒíƒœ í™•ì¸
            const toggleBtn = type === 'original' 
                ? document.getElementById('toggle-all-original')
                : document.getElementById('toggle-all-adjusted');
            
            if (!toggleBtn) return;
            
            const isCurrentlyOn = toggleBtn.textContent === 'ON';
            
            if (isCurrentlyOn) {
                // ON ìƒíƒœ â†’ OFFë¡œ ë³€ê²½ (ëª¨ë“  ì°¨ìˆ˜ í•´ì œ)
                allTrips.forEach(tripKey => {
                    const index = selectedTrips.indexOf(tripKey);
                    if (index > -1) {
                        selectedTrips.splice(index, 1);
                    }
                });
            } else {
                // OFF ìƒíƒœ â†’ ONìœ¼ë¡œ ë³€ê²½ (ëª¨ë“  ì°¨ìˆ˜ ì„ íƒ)
                allTrips.forEach(tripKey => {
                    if (!selectedTrips.includes(tripKey)) {
                        selectedTrips.push(tripKey);
                    }
                });
            }
            
            // localStorageì— ì €ì¥
            localStorage.setItem(kcolKey('selectedTrips'), JSON.stringify(selectedTrips));
            
            // ì „ì²´ í† ê¸€ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateAllTripsToggleButtons();
            
            // ì°¨ìˆ˜ë³„ í† ê¸€ ë²„íŠ¼ ë‹¤ì‹œ ë Œë”ë§
            if (typeof renderTripFilterToggles === 'function') {
                renderTripFilterToggles();
            }
            
            // í…Œì´ë¸” ë‹¤ì‹œ ë Œë”ë§
            if (typeof renderTransportVolumeTable === 'function') {
                renderTransportVolumeTable();
            }
        }
        
        // ì „ì²´ í† ê¸€ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateAllTripsToggleButtons() {
            // ì›13ì°¨ìˆ˜ ì „ì²´ í† ê¸€ ë²„íŠ¼
            const toggleAllOriginalBtn = document.getElementById('toggle-all-original');
            if (toggleAllOriginalBtn && transportPlan && Object.keys(transportPlan).length > 0) {
                const originalTrips = [];
                Object.keys(transportPlan).forEach(tripNum => {
                    const tripNumInt = parseInt(tripNum);
                    if (tripNumInt > 0 && tripNumInt <= 13) {
                        originalTrips.push(`original_${tripNumInt}`);
                    }
                });
                
                const allOriginalSelected = originalTrips.length > 0 && originalTrips.every(tripKey => selectedTrips && selectedTrips.includes(tripKey));
                
                if (allOriginalSelected) {
                    toggleAllOriginalBtn.textContent = 'ON';
                    toggleAllOriginalBtn.style.background = '#e3f2fd';
                    toggleAllOriginalBtn.style.borderColor = '#2196f3';
                    toggleAllOriginalBtn.style.color = '#2196f3';
                } else {
                    toggleAllOriginalBtn.textContent = 'OFF';
                    toggleAllOriginalBtn.style.background = '#fff';
                    toggleAllOriginalBtn.style.borderColor = '#2196f3';
                    toggleAllOriginalBtn.style.color = '#2196f3';
                }
            }
            
            // ì¡°ì •12ì°¨ìˆ˜ ì „ì²´ í† ê¸€ ë²„íŠ¼
            const toggleAllAdjustedBtn = document.getElementById('toggle-all-adjusted');
            if (toggleAllAdjustedBtn && adjustedTransportPlan && Object.keys(adjustedTransportPlan).length > 0) {
                const adjustedTrips = [];
                Object.keys(adjustedTransportPlan).forEach(tripNum => {
                    const tripNumInt = parseInt(tripNum);
                    if (tripNumInt > 0 && tripNumInt <= 13) {
                        adjustedTrips.push(`adjusted_${tripNumInt}`);
                    }
                });
                
                const allAdjustedSelected = adjustedTrips.length > 0 && adjustedTrips.every(tripKey => selectedTrips && selectedTrips.includes(tripKey));
                
                if (allAdjustedSelected) {
                    toggleAllAdjustedBtn.textContent = 'ON';
                    toggleAllAdjustedBtn.style.background = '#fff3e0';
                    toggleAllAdjustedBtn.style.borderColor = '#ff9800';
                    toggleAllAdjustedBtn.style.color = '#ff9800';
                } else {
                    toggleAllAdjustedBtn.textContent = 'OFF';
                    toggleAllAdjustedBtn.style.background = '#fff';
                    toggleAllAdjustedBtn.style.borderColor = '#ff9800';
                    toggleAllAdjustedBtn.style.color = '#ff9800';
                }
            }
        }
        
        // ì›ê³µì •í‘œ í‘œì‹œ í•¨ìˆ˜
        function showOriginalPlan() {
            if (!isShowingAdjustedPlan) {
                // ì´ë¯¸ ì›ê³µì •í‘œ í‘œì‹œ ì¤‘ì´ë©´ ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ
                return;
            }
            
            // ì¡°ì •ëœ ê³„íš í‘œì‹œ ì¤‘ â†’ ì›ë˜ ê³„íšìœ¼ë¡œ ë³µì›
            if (originalTransportPlan && Object.keys(originalTransportPlan).length > 0) {
                transportPlan = JSON.parse(JSON.stringify(originalTransportPlan)); // ê¹Šì€ ë³µì‚¬
                isShowingAdjustedPlan = false;
                console.log('âœ… ì›ë˜ ì°¨ìˆ˜ê³„íšìœ¼ë¡œ ë³µì›');
                console.log('ì›ë˜ ì°¨ìˆ˜ê³„íš ì°¨ìˆ˜ ëª©ë¡:', Object.keys(transportPlan).map(k => parseInt(k)).sort((a, b) => a - b));
            } else {
                alert('âš ï¸ ì›ë³¸ ì°¨ìˆ˜ê³„íš ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            updatePlanToggleButtons();
            
            // dailyData ë™ê¸°í™”
            if (typeof syncTransportToDailyData === 'function') {
                console.log('dailyData ë™ê¸°í™” ì‹œì‘, transportPlan:', transportPlan);
                syncTransportToDailyData(false);
                console.log('dailyData ë™ê¸°í™” ì™„ë£Œ');
            }
            
            // ê³µì •í‘œ ì—…ë°ì´íŠ¸
            if (typeof renderGanttChart === 'function') {
                console.log('ê³µì •í‘œ ë Œë”ë§ ì‹œì‘, í˜„ì¬ transportPlan:', transportPlan);
                renderGanttChart();
                console.log('ê³µì •í‘œ ë Œë”ë§ ì™„ë£Œ');
            }
            
            // ìš´ì†¡ì°¨ìˆ˜ê³„íš íŒ¨ë„ë„ ì—…ë°ì´íŠ¸
            if (typeof renderTransportColumnGrid === 'function') {
                renderTransportColumnGrid();
            }
            if (typeof renderTransportTrips === 'function') {
                renderTransportTrips();
            }
            
            // ìš´ì†¡ë¬¼ëŸ‰ì‚°ì • í…Œì´ë¸”ë„ ì—…ë°ì´íŠ¸
            if (typeof renderTransportVolumeTable === 'function') {
                renderTransportVolumeTable();
            }
            renderAdjustedTripSummarySafe();
        }
        
        // ì¡°ì •ê³µì •í‘œ í‘œì‹œ í•¨ìˆ˜
        function showAdjustedPlan() {
            // ì¡°ì •ê³µì •í‘œ í´ë¦­ ì‹œ: ê¸°ì¡´ ìš´ì†¡ì°¨ìˆ˜ê³„íš ì‚­ì œ í›„ ìƒˆë¡œìš´ ì—‘ì…€ì—ì„œ ì¡°ì •ëœ ìš´ì†¡ì°¨ìˆ˜ê³„íš ë¶ˆëŸ¬ì˜¤ê¸°
            
            // ë©”ì‹œì§€ í‘œì‹œ
            alert('ì¡°ì •ê³µì •í‘œ(ì—‘ì…€)ë¥¼ í´ë¦­í•©ë‹ˆë‹¤.');
            
            // í•­ìƒ ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë„ë¡ ìš”ì²­ (ê¸°ì¡´ ë°ì´í„° ë¬´ì‹œ)
            const message = 'ì¡°ì •ê³µì •í‘œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.\n\nê¸°ì¡´ ê³µì •í‘œì˜ ìš´ì†¡ì°¨ìˆ˜ê³„íšì€ ì‚­ì œë˜ê³ , ì—‘ì…€ íŒŒì¼ì—ì„œ ë¶ˆëŸ¬ì˜¨ ì¡°ì •ëœ ìš´ì†¡ì°¨ìˆ˜ê³„íšì´ ì¡°ì •ê³µì •í‘œì— í‘œì‹œë©ë‹ˆë‹¤.';
            if (!confirm(message + '\n\nì¡°ì •ì°¨ìˆ˜ê³„íš ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            
            // íŒŒì¼ ì…ë ¥ ìš”ì†Œ ìƒì„± ë° í´ë¦­
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.xlsx,.xls,.csv';
            fileInput.style.display = 'none';
            fileInput.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1, defval: '' });
                        
                        if (rows.length < 2) {
                            alert('âŒ ì—‘ì…€ íŒŒì¼ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                            return;
                        }
                        
                        // í—¤ë” í™•ì¸
                        const headers = rows[0].map(h => String(h).trim().toLowerCase());
                        const colNoIdx = headers.findIndex(h => h.includes('ê¸°ë‘¥ë²ˆí˜¸') || h.includes('ê¸°ë‘¥') || h === 'colno' || h === 'no');
                        const tripIdx = headers.findIndex(h => h.includes('ì°¨ìˆ˜') || h === 'trip' || h === 'ì°¨ìˆ˜ë²ˆí˜¸');
                        const dateIdx = headers.findIndex(h => h.includes('ë‚ ì§œ') || h.includes('ìš´ì†¡ë‚ ì§œ') || h === 'date' || h.includes('date'));
                        
                        if (colNoIdx === -1 || tripIdx === -1 || dateIdx === -1) {
                            alert('âŒ ì—‘ì…€ íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.\n\ní—¤ë”: ê¸°ë‘¥ë²ˆí˜¸, ì°¨ìˆ˜, ìš´ì†¡ë‚ ì§œ');
                            return;
                        }
                        
                        // ì—‘ì…€ ë°ì´í„° íŒŒì‹±í•˜ì—¬ adjustedTransportPlan ìƒì„±
                        const excelAdjustedPlan = {};
                        for (let i = 1; i < rows.length; i++) {
                            const row = rows[i];
                            if (!row || row.length === 0) continue;
                            
                            const colNo = String(row[colNoIdx] || '').trim();
                            const tripNum = parseInt(String(row[tripIdx] || '').trim());
                            let date = String(row[dateIdx] || '').trim();
                            
                            if (!colNo || isNaN(tripNum) || tripNum < 1 || tripNum > 12) continue;
                            
                            // ë‚ ì§œ íŒŒì‹± (ë‹¤ì–‘í•œ í˜•ì‹ ì§€ì›)
                            if (date) {
                                // Excel ë‚ ì§œ í˜•ì‹ ì²˜ë¦¬
                                if (typeof date === 'number') {
                                    // Excel serial date
                                    const excelEpoch = new Date(1899, 11, 30);
                                    const excelDate = new Date(excelEpoch.getTime() + date * 24 * 60 * 60 * 1000);
                                    date = excelDate.toISOString().split('T')[0];
                                } else if (date instanceof Date) {
                                    date = date.toISOString().split('T')[0];
                                } else {
                                    // ë¬¸ìì—´ ë‚ ì§œ ì •ê·œí™” (YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ)
                                    const dateMatch = date.match(/(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})/);
                                    if (dateMatch) {
                                        const year = dateMatch[1];
                                        const month = String(dateMatch[2]).padStart(2, '0');
                                        const day = String(dateMatch[3]).padStart(2, '0');
                                        date = `${year}-${month}-${day}`;
                                    }
                                }
                            }
                            
                            if (!excelAdjustedPlan[tripNum]) {
                                excelAdjustedPlan[tripNum] = { columns: [], date: date || '' };
                            }
                            
                            if (!excelAdjustedPlan[tripNum].columns.includes(colNo)) {
                                excelAdjustedPlan[tripNum].columns.push(colNo);
                            }
                            
                            // ë‚ ì§œëŠ” ì²« ë²ˆì§¸ë¡œ ë°œê²¬ëœ ë‚ ì§œ ì‚¬ìš© (ê°™ì€ ì°¨ìˆ˜ë©´ ë™ì¼í•´ì•¼ í•¨)
                            if (!excelAdjustedPlan[tripNum].date && date) {
                                excelAdjustedPlan[tripNum].date = date;
                            }
                        }
                        
                        // ì›ë³¸ ë°±ì—… (ì²˜ìŒ í•œ ë²ˆë§Œ)
                        if (!originalTransportPlan || Object.keys(originalTransportPlan).length === 0) {
                            originalTransportPlan = JSON.parse(JSON.stringify(transportPlan)); // ê¹Šì€ ë³µì‚¬
                            console.log('âœ… ì›ë³¸ ì°¨ìˆ˜ê³„íš ë°±ì—… ì™„ë£Œ');
                        }
                        
                        // 1ë‹¨ê³„: ê¸°ì¡´ ê³µì •í‘œì—ì„œ ì‘ì„±ëœ ìš´ì†¡ì°¨ìˆ˜ê³„íš ë°ì´í„° ì‚­ì œ (dailyDataì—ì„œ process 5 ë°ì´í„° ëª¨ë‘ ì œê±°)
                        // ì¡°ì •ê³µì •í‘œë¥¼ ìƒì„±í•˜ê¸° ìœ„í•´ ê¸°ì¡´ process 5 ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œ
                        console.log('ğŸ—‘ï¸ ê¸°ì¡´ ê³µì •í‘œì˜ ìš´ì†¡ì°¨ìˆ˜ê³„íš ë°ì´í„° ì‚­ì œ ì‹œì‘');
                        for (let date in dailyData) {
                            if (dailyData[date] && dailyData[date][5]) {
                                dailyData[date][5] = [];
                                console.log(`  ë‚ ì§œ ${date}ì˜ process 5 ë°ì´í„° ì‚­ì œ`);
                            }
                        }
                        console.log('âœ… ê¸°ì¡´ ìš´ì†¡ì°¨ìˆ˜ê³„íš ë°ì´í„° ì‚­ì œ ì™„ë£Œ');
                        
                        // 2ë‹¨ê³„: ì—‘ì…€ì—ì„œ ì½ì€ ë°ì´í„°ë¥¼ adjustedTransportPlanì— ì €ì¥
                        adjustedTransportPlan = excelAdjustedPlan;
                        
                        // localStorageì— ì €ì¥
                        localStorage.setItem(kcolKey('adjustedTransportPlan'), JSON.stringify(adjustedTransportPlan));
                        
                        // 3ë‹¨ê³„: transportPlan ì—…ë°ì´íŠ¸ (13ì°¨ê¹Œì§€)
                        const cleanedAdjustedPlan = {};
                        for (let tripNum in adjustedTransportPlan) {
                            const tripNumInt = parseInt(tripNum);
                            if (tripNumInt <= 13) { // 13ì°¨ê¹Œì§€ í¬í•¨
                                cleanedAdjustedPlan[tripNum] = JSON.parse(JSON.stringify(adjustedTransportPlan[tripNum]));
                            }
                        }
                        
                        transportPlan = cleanedAdjustedPlan;
                        isShowingAdjustedPlan = true;
                        
                        console.log('âœ… ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš ì—‘ì…€ íŒŒì¼ì—ì„œ ë¡œë“œ ì™„ë£Œ (ìƒˆë¡œìš´ ì¡°ì •ê³µì •í‘œ ìƒì„±)');
                        console.log('ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš ì°¨ìˆ˜ ëª©ë¡:', Object.keys(transportPlan).map(k => parseInt(k)).sort((a, b) => a - b));
                        console.log('ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš ìƒì„¸:', transportPlan);
                        
                        // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
                        updatePlanToggleButtons();
                        
                        // 4ë‹¨ê³„: ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš ë°ì´í„°ë¥¼ dailyDataì— ë™ê¸°í™” (ìƒˆë¡œìš´ ê³µì •í‘œ2 ìƒì„±)
                        if (typeof syncTransportToDailyData === 'function') {
                            console.log('dailyData ë™ê¸°í™” ì‹œì‘, transportPlan:', transportPlan);
                            syncTransportToDailyData(false);
                            console.log('dailyData ë™ê¸°í™” ì™„ë£Œ (ì¡°ì •ê³µì •í‘œ ë°ì´í„° ì…ë ¥)');
                        }
                        
                        // 5ë‹¨ê³„: ê³µì •í‘œ ì—…ë°ì´íŠ¸
                        if (typeof renderGanttChart === 'function') {
                            console.log('ê³µì •í‘œ ë Œë”ë§ ì‹œì‘, í˜„ì¬ transportPlan:', transportPlan);
                            renderGanttChart();
                            console.log('ê³µì •í‘œ ë Œë”ë§ ì™„ë£Œ (ì¡°ì •ê³µì •í‘œ í‘œì‹œ)');
                        }
                        
                        // ìš´ì†¡ì°¨ìˆ˜ê³„íš íŒ¨ë„ë„ ì—…ë°ì´íŠ¸
                        if (typeof renderTransportColumnGrid === 'function') {
                            renderTransportColumnGrid();
                        }
                        if (typeof renderTransportTrips === 'function') {
                            renderTransportTrips();
                        }
                        
                        // ìš´ì†¡ë¬¼ëŸ‰ì‚°ì • í…Œì´ë¸”ë„ ì—…ë°ì´íŠ¸
                        if (typeof renderTransportVolumeTable === 'function') {
                            renderTransportVolumeTable();
                        }
                        renderAdjustedTripSummarySafe();
                        
                        alert('âœ… ì¡°ì •ì°¨ìˆ˜ê³„íš ì—‘ì…€ íŒŒì¼ì„ ì‚¬ìš©í•˜ì—¬ ì¡°ì •ê³µì •í‘œê°€ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    } catch (error) {
                        console.error('ì—‘ì…€ íŒŒì¼ ì½ê¸° ì˜¤ë¥˜:', error);
                        alert('âŒ ì—‘ì…€ íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n' + error.message);
                    }
                };
                reader.readAsArrayBuffer(file);
            };
            document.body.appendChild(fileInput);
            fileInput.click();
            document.body.removeChild(fileInput);
        }
        
        // ë³‘ê¸°ê³µì •í‘œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updatePlanToggleButtons() {
            const originalBtn = document.getElementById('original-plan-btn');
            const adjustedBtn = document.getElementById('adjusted-plan-btn');
            
            if (originalBtn && adjustedBtn) {
                if (isShowingAdjustedPlan) {
                    // ì¡°ì •ê³µì •í‘œ í‘œì‹œ ì¤‘
                    originalBtn.style.background = '#fff';
                    originalBtn.style.borderColor = '#ddd';
                    originalBtn.style.color = '#666';
                    adjustedBtn.style.background = '#e3f2fd';
                    adjustedBtn.style.borderColor = '#2196f3';
                    adjustedBtn.style.color = '#2196f3';
                } else {
                    // ì›ê³µì •í‘œ í‘œì‹œ ì¤‘
                    originalBtn.style.background = '#e3f2fd';
                    originalBtn.style.borderColor = '#2196f3';
                    originalBtn.style.color = '#2196f3';
                    adjustedBtn.style.background = '#fff';
                    adjustedBtn.style.borderColor = '#ddd';
                    adjustedBtn.style.color = '#666';
                }
            }
        }
        
        // ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš í† ê¸€ í•¨ìˆ˜ (ë ˆê±°ì‹œ í˜¸í™˜ì„± ìœ ì§€)
        function toggleAdjustedPlan() {
            if (isShowingAdjustedPlan) {
                // ì¡°ì •ëœ ê³„íš í‘œì‹œ ì¤‘ â†’ ì›ë˜ ê³„íšìœ¼ë¡œ ë³µì›
                if (originalTransportPlan && Object.keys(originalTransportPlan).length > 0) {
                    transportPlan = JSON.parse(JSON.stringify(originalTransportPlan)); // ê¹Šì€ ë³µì‚¬
                    isShowingAdjustedPlan = false;
                    console.log('âœ… ì›ë˜ ì°¨ìˆ˜ê³„íšìœ¼ë¡œ ë³µì›');
                    console.log('ì›ë˜ ì°¨ìˆ˜ê³„íš ì°¨ìˆ˜ ëª©ë¡:', Object.keys(transportPlan).map(k => parseInt(k)).sort((a, b) => a - b));
                } else {
                    alert('âš ï¸ ì›ë³¸ ì°¨ìˆ˜ê³„íš ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
            } else {
                // ì›ë˜ ê³„íš í‘œì‹œ ì¤‘ â†’ ì¡°ì •ëœ ê³„íšìœ¼ë¡œ ì „í™˜
                // ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ
                if (!confirm('âš ï¸ ì¡°ì •ì „ ìš´ì†¡ì°¨ìˆ˜ê³„íš, 13ì°¨ ë°ì´í„°ëŠ” ì‚¬ë¼ì§‘ë‹ˆë‹¤.\n\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    return;
                }
                
                // adjustedTransportPlanì´ ì´ë¯¸ ìˆìœ¼ë©´ ë°”ë¡œ ì‚¬ìš©, ì—†ìœ¼ë©´ ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ ìš”ì²­
                if (adjustedTransportPlan && Object.keys(adjustedTransportPlan).length > 0) {
                    // ì´ë¯¸ ì¡°ì •ëœ ì°¨ìˆ˜ê³„íšì´ ìˆìœ¼ë©´ ë°”ë¡œ ì‚¬ìš©
                    // ì›ë³¸ ë°±ì—… (ì²˜ìŒ í•œ ë²ˆë§Œ)
                    if (!originalTransportPlan || Object.keys(originalTransportPlan).length === 0) {
                        originalTransportPlan = JSON.parse(JSON.stringify(transportPlan)); // ê¹Šì€ ë³µì‚¬
                        console.log('âœ… ì›ë³¸ ì°¨ìˆ˜ê³„íš ë°±ì—… ì™„ë£Œ');
                    }
                    
                    // 1ë‹¨ê³„: ì¡°ì • ì „ ìš´ì†¡ì°¨ìˆ˜ê³„íš ë°ì´í„° ì‚­ì œ (dailyDataì—ì„œ process 5 ë°ì´í„° ëª¨ë‘ ì œê±°)
                    console.log('ğŸ—‘ï¸ ì¡°ì • ì „ ìš´ì†¡ì°¨ìˆ˜ê³„íš ë°ì´í„° ì‚­ì œ ì‹œì‘');
                    for (let date in dailyData) {
                        if (dailyData[date] && dailyData[date][5]) {
                            dailyData[date][5] = [];
                            console.log(`  ë‚ ì§œ ${date}ì˜ process 5 ë°ì´í„° ì‚­ì œ`);
                        }
                    }
                    console.log('âœ… ì¡°ì • ì „ ìš´ì†¡ì°¨ìˆ˜ê³„íš ë°ì´í„° ì‚­ì œ ì™„ë£Œ');
                    
                    // 2ë‹¨ê³„: transportPlan ì—…ë°ì´íŠ¸ (12ì°¨ê¹Œì§€ë§Œ)
                    const cleanedAdjustedPlan = {};
                    for (let tripNum in adjustedTransportPlan) {
                        const tripNumInt = parseInt(tripNum);
                        if (tripNumInt <= 13) { // 13ì°¨ê¹Œì§€ í¬í•¨
                            cleanedAdjustedPlan[tripNum] = JSON.parse(JSON.stringify(adjustedTransportPlan[tripNum]));
                        }
                    }
                    
                    transportPlan = cleanedAdjustedPlan;
                    isShowingAdjustedPlan = true;
                    
                    console.log('âœ… ì¡°ì •ëœ ì°¨ìˆ˜ê³„íšìœ¼ë¡œ ì „í™˜ (ê¸°ì¡´ ë°ì´í„° ì‚¬ìš©)');
                    console.log('ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš ì°¨ìˆ˜ ëª©ë¡:', Object.keys(transportPlan).map(k => parseInt(k)).sort((a, b) => a - b));
                    console.log('ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš ìƒì„¸:', transportPlan);
                    
                    // ìƒíƒœ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
                    const statusEl = document.getElementById('adjusted-plan-status');
                    if (statusEl) {
                        statusEl.textContent = 'ì¡°ì •ê³µì •í‘œ í‘œì‹œ ì¤‘';
                        statusEl.style.color = '#2196f3';
                    }
                    
                    // 3ë‹¨ê³„: ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš ë°ì´í„°ë¥¼ dailyDataì— ë™ê¸°í™”
                    if (typeof syncTransportToDailyData === 'function') {
                        console.log('dailyData ë™ê¸°í™” ì‹œì‘, transportPlan:', transportPlan);
                        syncTransportToDailyData(false);
                        console.log('dailyData ë™ê¸°í™” ì™„ë£Œ');
                    }
                    
                    // 4ë‹¨ê³„: ê³µì •í‘œ ì—…ë°ì´íŠ¸
                    if (typeof renderGanttChart === 'function') {
                        console.log('ê³µì •í‘œ ë Œë”ë§ ì‹œì‘, í˜„ì¬ transportPlan:', transportPlan);
                        renderGanttChart();
                        console.log('ê³µì •í‘œ ë Œë”ë§ ì™„ë£Œ');
                    }
                    
                    // ìš´ì†¡ì°¨ìˆ˜ê³„íš íŒ¨ë„ë„ ì—…ë°ì´íŠ¸
                    if (typeof renderTransportColumnGrid === 'function') {
                        renderTransportColumnGrid();
                    }
                    if (typeof renderTransportTrips === 'function') {
                        renderTransportTrips();
                    }
                    
                    // ìš´ì†¡ë¬¼ëŸ‰ì‚°ì • í…Œì´ë¸”ë„ ì—…ë°ì´íŠ¸
                    if (typeof renderTransportVolumeTable === 'function') {
                        renderTransportVolumeTable();
                    }
                    renderAdjustedTripSummarySafe();
                    
                    return;
                }
                
                // adjustedTransportPlanì´ ì—†ìœ¼ë©´ ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ ìš”ì²­
                const message = 'ì¡°ì •ê³µì •í‘œëŠ” ë°©ê¸ˆì „ì— ë‹¤ìš´ë°›ì€ ì¡°ì •ì°¨ìˆ˜ê³„íš ì—‘ì…€ì„ ì‚¬ìš©í•˜ì—¬ ê³µì •í‘œì— ìƒˆë¡œì´ í‘œì‹œí•©ë‹ˆë‹¤.';
                if (!confirm(message + '\n\nì¡°ì •ì°¨ìˆ˜ê³„íš ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    return;
                }
                
                // íŒŒì¼ ì…ë ¥ ìš”ì†Œ ìƒì„± ë° í´ë¦­
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.xlsx,.xls,.csv';
                fileInput.style.display = 'none';
                fileInput.onchange = function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                            const rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1, defval: '' });
                            
                            if (rows.length < 2) {
                                alert('âŒ ì—‘ì…€ íŒŒì¼ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                                return;
                            }
                            
                            // í—¤ë” í™•ì¸
                            const headers = rows[0].map(h => String(h).trim().toLowerCase());
                            const colNoIdx = headers.findIndex(h => h.includes('ê¸°ë‘¥ë²ˆí˜¸') || h.includes('ê¸°ë‘¥') || h === 'colno' || h === 'no');
                            const tripIdx = headers.findIndex(h => h.includes('ì°¨ìˆ˜') || h === 'trip' || h === 'ì°¨ìˆ˜ë²ˆí˜¸');
                            const dateIdx = headers.findIndex(h => h.includes('ë‚ ì§œ') || h.includes('ìš´ì†¡ë‚ ì§œ') || h === 'date' || h.includes('date'));
                            
                            if (colNoIdx === -1 || tripIdx === -1 || dateIdx === -1) {
                                alert('âŒ ì—‘ì…€ íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.\n\ní—¤ë”: ê¸°ë‘¥ë²ˆí˜¸, ì°¨ìˆ˜, ìš´ì†¡ë‚ ì§œ');
                                return;
                            }
                            
                            // ì—‘ì…€ ë°ì´í„° íŒŒì‹±í•˜ì—¬ adjustedTransportPlan ìƒì„±
                            const excelAdjustedPlan = {};
                            for (let i = 1; i < rows.length; i++) {
                                const row = rows[i];
                                if (!row || row.length === 0) continue;
                                
                                const colNo = String(row[colNoIdx] || '').trim();
                                const tripNum = parseInt(String(row[tripIdx] || '').trim());
                                let date = String(row[dateIdx] || '').trim();
                                
                                if (!colNo || isNaN(tripNum) || tripNum < 1 || tripNum > 12) continue;
                                
                                // ë‚ ì§œ íŒŒì‹± (ë‹¤ì–‘í•œ í˜•ì‹ ì§€ì›)
                                if (date) {
                                    // Excel ë‚ ì§œ í˜•ì‹ ì²˜ë¦¬
                                    if (typeof date === 'number') {
                                        // Excel serial date
                                        const excelEpoch = new Date(1899, 11, 30);
                                        const excelDate = new Date(excelEpoch.getTime() + date * 24 * 60 * 60 * 1000);
                                        date = excelDate.toISOString().split('T')[0];
                                    } else if (date instanceof Date) {
                                        date = date.toISOString().split('T')[0];
                                    } else {
                                        // ë¬¸ìì—´ ë‚ ì§œ ì •ê·œí™” (YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ)
                                        const dateMatch = date.match(/(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})/);
                                        if (dateMatch) {
                                            const year = dateMatch[1];
                                            const month = String(dateMatch[2]).padStart(2, '0');
                                            const day = String(dateMatch[3]).padStart(2, '0');
                                            date = `${year}-${month}-${day}`;
                                        }
                                    }
                                }
                                
                                if (!excelAdjustedPlan[tripNum]) {
                                    excelAdjustedPlan[tripNum] = { columns: [], date: date || '' };
                                }
                                
                                if (!excelAdjustedPlan[tripNum].columns.includes(colNo)) {
                                    excelAdjustedPlan[tripNum].columns.push(colNo);
                                }
                                
                                // ë‚ ì§œëŠ” ì²« ë²ˆì§¸ë¡œ ë°œê²¬ëœ ë‚ ì§œ ì‚¬ìš© (ê°™ì€ ì°¨ìˆ˜ë©´ ë™ì¼í•´ì•¼ í•¨)
                                if (!excelAdjustedPlan[tripNum].date && date) {
                                    excelAdjustedPlan[tripNum].date = date;
                                }
                            }
                            
                            // ì›ë³¸ ë°±ì—… (ì²˜ìŒ í•œ ë²ˆë§Œ)
                            if (!originalTransportPlan || Object.keys(originalTransportPlan).length === 0) {
                                originalTransportPlan = JSON.parse(JSON.stringify(transportPlan)); // ê¹Šì€ ë³µì‚¬
                                console.log('âœ… ì›ë³¸ ì°¨ìˆ˜ê³„íš ë°±ì—… ì™„ë£Œ');
                            }
                            
                            // 1ë‹¨ê³„: ì¡°ì • ì „ ìš´ì†¡ì°¨ìˆ˜ê³„íš ë°ì´í„° ì‚­ì œ (dailyDataì—ì„œ process 5 ë°ì´í„° ëª¨ë‘ ì œê±°)
                            console.log('ğŸ—‘ï¸ ì¡°ì • ì „ ìš´ì†¡ì°¨ìˆ˜ê³„íš ë°ì´í„° ì‚­ì œ ì‹œì‘');
                            for (let date in dailyData) {
                                if (dailyData[date] && dailyData[date][5]) {
                                    dailyData[date][5] = [];
                                    console.log(`  ë‚ ì§œ ${date}ì˜ process 5 ë°ì´í„° ì‚­ì œ`);
                                }
                            }
                            console.log('âœ… ì¡°ì • ì „ ìš´ì†¡ì°¨ìˆ˜ê³„íš ë°ì´í„° ì‚­ì œ ì™„ë£Œ');
                            
                            // 2ë‹¨ê³„: ì—‘ì…€ì—ì„œ ì½ì€ ë°ì´í„°ë¥¼ adjustedTransportPlanì— ì €ì¥
                            adjustedTransportPlan = excelAdjustedPlan;
                            
                            // localStorageì— ì €ì¥
                            localStorage.setItem(kcolKey('adjustedTransportPlan'), JSON.stringify(adjustedTransportPlan));
                            
                            // 3ë‹¨ê³„: transportPlan ì—…ë°ì´íŠ¸ (12ì°¨ê¹Œì§€ë§Œ)
                            const cleanedAdjustedPlan = {};
                            for (let tripNum in adjustedTransportPlan) {
                                const tripNumInt = parseInt(tripNum);
                                if (tripNumInt <= 13) { // 13ì°¨ê¹Œì§€ í¬í•¨
                                    cleanedAdjustedPlan[tripNum] = JSON.parse(JSON.stringify(adjustedTransportPlan[tripNum]));
                                }
                            }
                            
                            transportPlan = cleanedAdjustedPlan;
                            isShowingAdjustedPlan = true;
                            
                            console.log('âœ… ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš ì—‘ì…€ íŒŒì¼ì—ì„œ ë¡œë“œ ì™„ë£Œ');
                            console.log('ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš ì°¨ìˆ˜ ëª©ë¡:', Object.keys(transportPlan).map(k => parseInt(k)).sort((a, b) => a - b));
                            console.log('ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš ìƒì„¸:', transportPlan);
                            
                            // ìƒíƒœ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
                            const statusEl = document.getElementById('adjusted-plan-status');
                            if (statusEl) {
                                statusEl.textContent = 'ì¡°ì •ê³µì •í‘œ í‘œì‹œ ì¤‘';
                                statusEl.style.color = '#2196f3';
                            }
                            
                            // dailyData ë™ê¸°í™”
                            if (typeof syncTransportToDailyData === 'function') {
                                console.log('dailyData ë™ê¸°í™” ì‹œì‘, transportPlan:', transportPlan);
                                syncTransportToDailyData(false);
                                console.log('dailyData ë™ê¸°í™” ì™„ë£Œ');
                            }
                            
                            // ê³µì •í‘œ ì—…ë°ì´íŠ¸
                            if (typeof renderGanttChart === 'function') {
                                console.log('ê³µì •í‘œ ë Œë”ë§ ì‹œì‘, í˜„ì¬ transportPlan:', transportPlan);
                                renderGanttChart();
                                console.log('ê³µì •í‘œ ë Œë”ë§ ì™„ë£Œ');
                            }
                            
                            // ìš´ì†¡ì°¨ìˆ˜ê³„íš íŒ¨ë„ë„ ì—…ë°ì´íŠ¸
                            if (typeof renderTransportColumnGrid === 'function') {
                                renderTransportColumnGrid();
                            }
                            if (typeof renderTransportTrips === 'function') {
                                renderTransportTrips();
                            }
                            
                            // ìš´ì†¡ë¬¼ëŸ‰ì‚°ì • í…Œì´ë¸”ë„ ì—…ë°ì´íŠ¸
                            if (typeof renderTransportVolumeTable === 'function') {
                                renderTransportVolumeTable();
                            }
                            renderAdjustedTripSummarySafe();
                            
                            alert('âœ… ì¡°ì •ì°¨ìˆ˜ê³„íš ì—‘ì…€ íŒŒì¼ì„ ì‚¬ìš©í•˜ì—¬ ì¡°ì •ê³µì •í‘œê°€ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.');
                        } catch (error) {
                            console.error('ì—‘ì…€ íŒŒì¼ ì½ê¸° ì˜¤ë¥˜:', error);
                            alert('âŒ ì—‘ì…€ íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n' + error.message);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                };
                document.body.appendChild(fileInput);
                fileInput.click();
                document.body.removeChild(fileInput);
                return;
            }
            
            // ìƒíƒœ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            const statusEl = document.getElementById('adjusted-plan-status');
            if (statusEl) {
                statusEl.textContent = isShowingAdjustedPlan ? 'ì¡°ì •ê³µì •í‘œ í‘œì‹œ ì¤‘' : 'ì›ê³µì •í‘œ í‘œì‹œ ì¤‘';
                statusEl.style.color = isShowingAdjustedPlan ? '#2196f3' : '#666';
            }
            
            // dailyData ë™ê¸°í™”
            if (typeof syncTransportToDailyData === 'function') {
                console.log('dailyData ë™ê¸°í™” ì‹œì‘, transportPlan:', transportPlan);
                syncTransportToDailyData(false);
                console.log('dailyData ë™ê¸°í™” ì™„ë£Œ');
            }
            
            // ì°¨ìˆ˜ë³„ ê¸°ë‘¥ ê°œìˆ˜ í™•ì¸ ë° ì¶œë ¥
            if (isShowingAdjustedPlan) {
                console.log('=== ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš ì°¨ìˆ˜ë³„ ê¸°ë‘¥ ê°œìˆ˜ í™•ì¸ ===');
                const sortedTripNums = Object.keys(transportPlan)
                    .map(k => parseInt(k))
                    .sort((a, b) => a - b);
                
                let totalCount = 0;
                sortedTripNums.forEach(tripNum => {
                    const tripData = transportPlan[tripNum];
                    const count = tripData && tripData.columns ? tripData.columns.length : 0;
                    totalCount += count;
                    console.log(`${tripNum}ì°¨ìˆ˜: ${count}ê°œ`);
                });
                console.log(`ì „ì²´: ${totalCount}ê°œ`);
                console.log('==========================================');
            }
            
            // ê³µì •í‘œ ì—…ë°ì´íŠ¸
            if (typeof renderGanttChart === 'function') {
                console.log('ê³µì •í‘œ ë Œë”ë§ ì‹œì‘, í˜„ì¬ transportPlan:', transportPlan);
                renderGanttChart();
                console.log('ê³µì •í‘œ ë Œë”ë§ ì™„ë£Œ');
            }
            
            // ìš´ì†¡ì°¨ìˆ˜ê³„íš íŒ¨ë„ë„ ì—…ë°ì´íŠ¸
            if (typeof renderTransportColumnGrid === 'function') {
                renderTransportColumnGrid();
            }
            if (typeof renderTransportTrips === 'function') {
                renderTransportTrips();
            }
        }
        
        // ì¡°ì •ëœ ì°¨ìˆ˜ë³„ ê¸°ë‘¥ ê°œìˆ˜ì™€ ìš´ì†¡ë‚ ì§œ í™•ì¸ í•¨ìˆ˜
        function showAdjustedPlanSummary() {
            if (!adjustedTransportPlan || Object.keys(adjustedTransportPlan).length === 0) {
                alert('âš ï¸ ì¡°ì •ëœ ì°¨ìˆ˜ê³„íšì´ ì—†ìŠµë‹ˆë‹¤.\n\në¨¼ì € "ìµœëŒ€ìš´ì†¡25í†¤" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì¡°ì •ëœ ê³„íšì„ ìƒì„±í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ì°¨ìˆ˜ë³„ ì •ë³´ ìˆ˜ì§‘
            const sortedTripNums = Object.keys(adjustedTransportPlan)
                .map(k => parseInt(k))
                .sort((a, b) => a - b);
            
            let summaryText = 'ğŸ“Š ì¡°ì •ëœ ì°¨ìˆ˜ë³„ ê¸°ë‘¥ ê°œìˆ˜ ë° ìš´ì†¡ë‚ ì§œ\n\n';
            let totalCount = 0;
            
            sortedTripNums.forEach(tripNum => {
                const tripData = adjustedTransportPlan[tripNum];
                if (tripData && tripData.columns) {
                    const count = tripData.columns.length;
                    const date = tripData.date || '(ë‚ ì§œ ì—†ìŒ)';
                    totalCount += count;
                    summaryText += `${tripNum}ì°¨ìˆ˜: ${count}ê°œ ê¸°ë‘¥, ìš´ì†¡ë‚ ì§œ: ${date}\n`;
                }
            });
            
            summaryText += `\nì´ ê¸°ë‘¥ ìˆ˜: ${totalCount}ê°œ`;
            summaryText += `\nì´ ì°¨ìˆ˜: ${sortedTripNums.length}ê°œ`;
            
            // ì½˜ì†”ì—ë„ ì¶œë ¥
            console.log('=== ì¡°ì •ëœ ì°¨ìˆ˜ë³„ ê¸°ë‘¥ ê°œìˆ˜ ë° ìš´ì†¡ë‚ ì§œ ===');
            sortedTripNums.forEach(tripNum => {
                const tripData = adjustedTransportPlan[tripNum];
                if (tripData && tripData.columns) {
                    const count = tripData.columns.length;
                    const date = tripData.date || '(ë‚ ì§œ ì—†ìŒ)';
                    const columns = tripData.columns.map(c => String(c)).join(', ');
                    console.log(`${tripNum}ì°¨ìˆ˜: ${count}ê°œ ê¸°ë‘¥, ìš´ì†¡ë‚ ì§œ: ${date}`);
                    console.log(`  ê¸°ë‘¥ë²ˆí˜¸: ${columns}`);
                }
            });
            console.log(`ì´ ê¸°ë‘¥ ìˆ˜: ${totalCount}ê°œ`);
            console.log(`ì´ ì°¨ìˆ˜: ${sortedTripNums.length}ê°œ`);
            console.log('==========================================');
            
            alert(summaryText);
        }
        
        // íŠ¹ì • ì°¨ìˆ˜ì˜ ê¸°ë‘¥ë²ˆí˜¸ ìƒì„¸ í™•ì¸ í•¨ìˆ˜
        function showTripDetails(tripNum) {
            if (!adjustedTransportPlan || Object.keys(adjustedTransportPlan).length === 0) {
                console.log('âš ï¸ ì¡°ì •ëœ ì°¨ìˆ˜ê³„íšì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const tripData = adjustedTransportPlan[tripNum];
            if (!tripData || !tripData.columns) {
                console.log(`âš ï¸ ${tripNum}ì°¨ìˆ˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`);
                return;
            }
            
            const columns = tripData.columns.map(c => String(c));
            const date = tripData.date || '(ë‚ ì§œ ì—†ìŒ)';
            const count = columns.length;
            
            console.log(`=== ${tripNum}ì°¨ìˆ˜ ìƒì„¸ ì •ë³´ ===`);
            console.log(`ìš´ì†¡ë‚ ì§œ: ${date}`);
            console.log(`ê¸°ë‘¥ ê°œìˆ˜: ${count}ê°œ`);
            console.log(`ê¸°ë‘¥ë²ˆí˜¸ ëª©ë¡:`, columns);
            console.log(`ê¸°ë‘¥ë²ˆí˜¸ (ì‰¼í‘œ êµ¬ë¶„): ${columns.join(', ')}`);
            console.log('==========================================');
            
            return {
                tripNum: tripNum,
                date: date,
                count: count,
                columns: columns
            };
        }
        
        // ì¡°ì •ëœ ì°¨ìˆ˜ê³„íšì„ ì—‘ì…€ íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ
        function exportAdjustedPlanToExcel() {
            // adjustedTransportPlanì´ ì—†ìœ¼ë©´ ê²½ê³ 
            if (!adjustedTransportPlan || Object.keys(adjustedTransportPlan).length === 0) {
                alert('âš ï¸ ì¡°ì •ëœ ì°¨ìˆ˜ê³„íšì´ ì—†ìŠµë‹ˆë‹¤.\n\në¨¼ì € "ìµœëŒ€ìš´ì†¡25í†¤" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì¡°ì •ëœ ê³„íšì„ ìƒì„±í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            try {
                // ì—‘ì…€ ë°ì´í„° ì¤€ë¹„
                const rows = [];
                
                // í—¤ë” ì¶”ê°€
                rows.push(['ê¸°ë‘¥ë²ˆí˜¸', 'ì°¨ìˆ˜', 'ìš´ì†¡ë‚ ì§œ']);
                
                // ê° ì°¨ìˆ˜ë³„ë¡œ ë°ì´í„° ì¶”ê°€
                const sortedTripNums = Object.keys(adjustedTransportPlan)
                    .map(k => parseInt(k))
                    .sort((a, b) => a - b);
                
                sortedTripNums.forEach(tripNum => {
                    const tripData = adjustedTransportPlan[tripNum];
                    if (tripData && tripData.columns && Array.isArray(tripData.columns) && tripData.columns.length > 0) {
                        const date = tripData.date || '';
                        
                        tripData.columns.forEach(colId => {
                            // colIdë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜ (1C001, 7TC001 ë“±)
                            const colIdStr = String(colId);
                            rows.push([colIdStr, tripNum, date]);
                        });
                    }
                });
                
                // ì›Œí¬ë¶ ìƒì„±
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(rows);
                
                // ì»¬ëŸ¼ ë„ˆë¹„ ì„¤ì •
                ws['!cols'] = [
                    { wch: 15 }, // ê¸°ë‘¥ë²ˆí˜¸
                    { wch: 10 }, // ì°¨ìˆ˜
                    { wch: 15 }  // ìš´ì†¡ë‚ ì§œ
                ];
                
                // ì›Œí¬ì‹œíŠ¸ë¥¼ ì›Œí¬ë¶ì— ì¶”ê°€
                XLSX.utils.book_append_sheet(wb, ws, 'ì¡°ì •ëœì°¨ìˆ˜ê³„íš');
                
                // íŒŒì¼ëª… ìƒì„± (í˜„ì¬ ë‚ ì§œ í¬í•¨)
                const dateStr = new Date().toISOString().split('T')[0].replace(/-/g, '');
                const fileName = `ì¡°ì •ëœì°¨ìˆ˜ê³„íš_${dateStr}.xlsx`;
                
                // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                XLSX.writeFile(wb, fileName);
                
                alert(`âœ… ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš ì—‘ì…€ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.\n\níŒŒì¼ëª…: ${fileName}\nì´ ${rows.length - 1}ê°œ ê¸°ë‘¥`);
            } catch (error) {
                console.error('ì—‘ì…€ íŒŒì¼ ìƒì„± ì˜¤ë¥˜:', error);
                alert('âŒ ì—‘ì…€ íŒŒì¼ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n' + error.message);
            }
        }
        
        // í•„í„°ë§ëœ ë°ì´í„°ë¥¼ ì—‘ì…€ íŒŒì¼ë¡œ ì €ì¥
        function exportFilteredDataToExcel() {
            if (!transportVolumeData || transportVolumeData.length === 0) {
                alert('âš ï¸ ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.\n\në¨¼ì € ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            try {
                // í•„í„°ë§ëœ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (renderTransportVolumeTableê³¼ ë™ì¼í•œ ë¡œì§)
                let filteredData = transportVolumeData;
                
                // ê·œê²©ë³„ í•„í„° ì ìš©
                if (selectedSizes && selectedSizes.length > 0) {
                    filteredData = filteredData.filter(item => {
                        const size = String(item.size || '').trim();
                        return selectedSizes.includes(size);
                    });
                }
                
                // ì°¨ìˆ˜ë³„ í•„í„° ì ìš©
                if (selectedTrips && selectedTrips.length > 0) {
                    filteredData = filteredData.filter(item => {
                        const colNo = item.no || item.colNo || '';
                        if (!colNo) return false;
                        
                        // ìš´ì†¡ì°¨ìˆ˜ê³„íš(13ì°¨)ì—ì„œ ì°¨ìˆ˜ ì°¾ê¸°
                        let foundOriginalTrip = null;
                        if (transportPlan && Object.keys(transportPlan).length > 0) {
                            for (let tripNum in transportPlan) {
                                const tripData = transportPlan[tripNum];
                                if (tripData && tripData.columns) {
                                    const found = tripData.columns.some(col => {
                                        const colStr = String(col);
                                        const colNoStr = String(colNo);
                                        if (colStr === colNoStr) return true;
                                        
                                        // ìˆ«ìë§Œ ì¶”ì¶œí•˜ì—¬ ë¹„êµ
                                        const colNum = parseInt(colStr.replace(/[^0-9]/g, ''));
                                        const colNoNum = parseInt(colNoStr.replace(/[^0-9]/g, ''));
                                        if (colNum && colNoNum && colNum === colNoNum) return true;
                                        return false;
                                    });
                                    
                                    if (found) {
                                        foundOriginalTrip = parseInt(tripNum);
                                        break;
                                    }
                                }
                            }
                        }
                        
                        // ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš(12ì°¨)ì—ì„œ ì°¨ìˆ˜ ì°¾ê¸°
                        let foundAdjustedTrip = null;
                        if (adjustedTransportPlan && Object.keys(adjustedTransportPlan).length > 0) {
                            for (let tripNum in adjustedTransportPlan) {
                                const tripData = adjustedTransportPlan[tripNum];
                                if (tripData && tripData.columns) {
                                    const found = tripData.columns.some(col => {
                                        const colStr = String(col);
                                        const colNoStr = String(colNo);
                                        if (colStr === colNoStr) return true;
                                        
                                        // ìˆ«ìë§Œ ì¶”ì¶œí•˜ì—¬ ë¹„êµ
                                        const colNum = parseInt(colStr.replace(/[^0-9]/g, ''));
                                        const colNoNum = parseInt(colNoStr.replace(/[^0-9]/g, ''));
                                        if (colNum && colNoNum && colNum === colNoNum) return true;
                                        return false;
                                    });
                                    
                                    if (found) {
                                        foundAdjustedTrip = parseInt(tripNum);
                                        break;
                                    }
                                }
                            }
                        }
                        
                        // ì„ íƒëœ ì°¨ìˆ˜ì™€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
                        const originalTripKey = foundOriginalTrip ? `original_${foundOriginalTrip}` : null;
                        const adjustedTripKey = foundAdjustedTrip ? `adjusted_${foundAdjustedTrip}` : null;
                        
                        return (originalTripKey && selectedTrips.includes(originalTripKey)) || 
                               (adjustedTripKey && selectedTrips.includes(adjustedTripKey));
                    });
                }
                
                if (filteredData.length === 0) {
                    alert('âš ï¸ í•„í„°ë§ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.\n\në‹¤ë¥¸ í•„í„° ì¡°ê±´ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                // ë¶€ì¬ê°œìˆ˜Â·í•©ì‚°ì¤‘ëŸ‰ ê³„ì‚° (í•„í„°ëœ ë°ì´í„° ê¸°ì¤€)
                const memberCount = filteredData.length;
                let totalWeightKg = 0;
                filteredData.forEach(item => {
                    const w = parseFloat(String(item.weight || '').replace(/,/g, '')) || 0;
                    totalWeightKg += w;
                });
                
                // ì—‘ì…€ ë°ì´í„° ì¤€ë¹„
                const rows = [];
                
                // ìš”ì•½ í–‰ ì¶”ê°€ (ë¶€ì¬ê°œìˆ˜, í•©ì‚°ì¤‘ëŸ‰)
                rows.push(['ë¶€ì¬ê°œìˆ˜', memberCount, 'ê°œ']);
                rows.push(['í•©ì‚°ì¤‘ëŸ‰(kg)', totalWeightKg.toLocaleString('ko-KR', { maximumFractionDigits: 0 }), 'kg']);
                rows.push([]); // ë¹ˆ í–‰
                
                // í—¤ë” ì¶”ê°€
                rows.push(['ê³µì¢…', 'ë„ë©´ë²ˆí˜¸', 'ê¸°ë‘¥ë²ˆí˜¸', 'ê·œê²©', 'ê¸¸ì´(mm)', 'ì¤‘ëŸ‰(kg)', 'ìš´ì†¡ì°¨ìˆ˜ê³„íš(13ì°¨)', 'ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš(12ì°¨)']);
                
                // í•„í„°ë§ëœ ë°ì´í„° ì¶”ê°€
                filteredData.forEach(item => {
                    const workType = item.workType || '';
                    const drawingNo = item.drawingNo || '';
                    const colNo = item.no || '';
                    const size = item.size || '';
                    const length = item.length || '';
                    const weight = item.weight || '';
                    
                    // ìš´ì†¡ì°¨ìˆ˜ê³„íš(13ì°¨) ì°¨ìˆ˜ ì°¾ê¸°
                    let transportPlanTrip = '';
                    if (transportPlan && Object.keys(transportPlan).length > 0) {
                        for (let tripNum in transportPlan) {
                            const tripData = transportPlan[tripNum];
                            if (tripData && tripData.columns) {
                                const found = tripData.columns.some(col => {
                                    const colStr = String(col);
                                    const colNoStr = String(colNo);
                                    if (colStr === colNoStr) return true;
                                    const colNum = parseInt(colStr.replace(/[^0-9]/g, ''));
                                    const colNoNum = parseInt(colNoStr.replace(/[^0-9]/g, ''));
                                    if (colNum && colNoNum && colNum === colNoNum) return true;
                                    return false;
                                });
                                if (found) {
                                    transportPlanTrip = tripNum;
                                    break;
                                }
                            }
                        }
                    }
                    
                    // ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš(12ì°¨) ì°¨ìˆ˜ ì°¾ê¸°
                    let adjustedPlanTrip = '';
                    if (adjustedTransportPlan && Object.keys(adjustedTransportPlan).length > 0) {
                        for (let tripNum in adjustedTransportPlan) {
                            const tripData = adjustedTransportPlan[tripNum];
                            if (tripData && tripData.columns) {
                                const found = tripData.columns.some(col => {
                                    const colStr = String(col);
                                    const colNoStr = String(colNo);
                                    if (colStr === colNoStr) return true;
                                    const colNum = parseInt(colStr.replace(/[^0-9]/g, ''));
                                    const colNoNum = parseInt(colNoStr.replace(/[^0-9]/g, ''));
                                    if (colNum && colNoNum && colNum === colNoNum) return true;
                                    return false;
                                });
                                if (found) {
                                    adjustedPlanTrip = tripNum;
                                    break;
                                }
                            }
                        }
                    }
                    
                    rows.push([
                        workType,
                        drawingNo,
                        colNo,
                        size,
                        length,
                        weight,
                        transportPlanTrip || '',
                        adjustedPlanTrip || ''
                    ]);
                });
                
                // ì›Œí¬ë¶ ìƒì„±
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(rows);
                
                // ì»¬ëŸ¼ ë„ˆë¹„ ì„¤ì •
                ws['!cols'] = [
                    { wch: 10 }, // ê³µì¢…
                    { wch: 15 }, // ë„ë©´ë²ˆí˜¸
                    { wch: 15 }, // ê¸°ë‘¥ë²ˆí˜¸
                    { wch: 20 }, // ê·œê²©
                    { wch: 12 }, // ê¸¸ì´(mm)
                    { wch: 12 }, // ì¤‘ëŸ‰(kg)
                    { wch: 20 }, // ìš´ì†¡ì°¨ìˆ˜ê³„íš(13ì°¨)
                    { wch: 20 }  // ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš(12ì°¨)
                ];
                
                // ì›Œí¬ì‹œíŠ¸ë¥¼ ì›Œí¬ë¶ì— ì¶”ê°€
                XLSX.utils.book_append_sheet(wb, ws, 'í•„í„°ëœë°ì´í„°');
                
                // íŒŒì¼ëª… ìƒì„± (í˜„ì¬ ë‚ ì§œ í¬í•¨)
                const dateStr = new Date().toISOString().split('T')[0].replace(/-/g, '');
                const fileName = `í•„í„°ëœë°ì´í„°_${dateStr}.xlsx`;
                
                // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                XLSX.writeFile(wb, fileName);
                
                alert(`âœ… í•„í„°ë§ëœ ë°ì´í„°ê°€ ì—‘ì…€ íŒŒì¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\n\níŒŒì¼ëª…: ${fileName}\në¶€ì¬ê°œìˆ˜: ${memberCount}ê°œ\ní•©ì‚°ì¤‘ëŸ‰: ${totalWeightKg.toLocaleString('ko-KR', { maximumFractionDigits: 0 })} kg`);
            } catch (error) {
                console.error('ì—‘ì…€ íŒŒì¼ ìƒì„± ì˜¤ë¥˜:', error);
                alert('âŒ ì—‘ì…€ íŒŒì¼ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n' + error.message);
            }
        }
        
        // ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš ì—‘ì…€ íŒŒì¼ê³¼ í˜„ì¬ ì¡°ì •ëœ ê³µì •í‘œ ì¼ì¹˜ ì—¬ë¶€ í™•ì¸
        function verifyAdjustedPlanFromExcel(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const resultEl = document.getElementById('adjusted-plan-verify-result');
            if (!resultEl) return;
            
            resultEl.style.display = 'block';
            resultEl.innerHTML = '<div style="color:#666;">ì—‘ì…€ íŒŒì¼ì„ ì½ëŠ” ì¤‘...</div>';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1, defval: '' });
                    
                    if (rows.length < 2) {
                        resultEl.innerHTML = '<div style="color:#f44336;">âŒ ì—‘ì…€ íŒŒì¼ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                        return;
                    }
                    
                    // í—¤ë” í™•ì¸
                    const headers = rows[0].map(h => String(h).trim().toLowerCase());
                    const colNoIdx = headers.findIndex(h => h.includes('ê¸°ë‘¥ë²ˆí˜¸') || h.includes('ê¸°ë‘¥') || h === 'colno' || h === 'no');
                    const tripIdx = headers.findIndex(h => h.includes('ì°¨ìˆ˜') || h === 'trip' || h === 'ì°¨ìˆ˜ë²ˆí˜¸');
                    const dateIdx = headers.findIndex(h => h.includes('ë‚ ì§œ') || h.includes('ìš´ì†¡ë‚ ì§œ') || h === 'date' || h.includes('date'));
                    
                    if (colNoIdx === -1 || tripIdx === -1 || dateIdx === -1) {
                        resultEl.innerHTML = '<div style="color:#f44336;">âŒ ì—‘ì…€ íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.<br>í—¤ë”: ê¸°ë‘¥ë²ˆí˜¸, ì°¨ìˆ˜, ìš´ì†¡ë‚ ì§œ</div>';
                        return;
                    }
                    
                    // ì—‘ì…€ ë°ì´í„° íŒŒì‹±
                    const excelData = {};
                    for (let i = 1; i < rows.length; i++) {
                        const row = rows[i];
                        if (!row || row.length === 0) continue;
                        
                        const colNo = String(row[colNoIdx] || '').trim();
                        const tripNum = parseInt(String(row[tripIdx] || '').trim());
                        const date = String(row[dateIdx] || '').trim();
                        
                        if (!colNo || isNaN(tripNum) || !date) continue;
                        
                        if (!excelData[tripNum]) {
                            excelData[tripNum] = { columns: [], date: date };
                        }
                        
                        if (!excelData[tripNum].columns.includes(colNo)) {
                            excelData[tripNum].columns.push(colNo);
                        }
                        
                        // ë‚ ì§œëŠ” ì²« ë²ˆì§¸ë¡œ ë°œê²¬ëœ ë‚ ì§œ ì‚¬ìš© (ê°™ì€ ì°¨ìˆ˜ë©´ ë™ì¼í•´ì•¼ í•¨)
                        if (!excelData[tripNum].date) {
                            excelData[tripNum].date = date;
                        }
                    }
                    
                    // í˜„ì¬ adjustedTransportPlanê³¼ ë¹„êµ
                    if (!adjustedTransportPlan || Object.keys(adjustedTransportPlan).length === 0) {
                        resultEl.innerHTML = '<div style="color:#f44336;">âŒ ì¡°ì •ëœ ì°¨ìˆ˜ê³„íšì´ ì—†ìŠµë‹ˆë‹¤.<br>ë¨¼ì € "ìµœëŒ€ìš´ì†¡25í†¤" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</div>';
                        return;
                    }
                    
                    // ë¹„êµ ê²°ê³¼
                    const differences = [];
                    const missingInExcel = [];
                    const missingInPlan = [];
                    const dateMismatches = [];
                    
                    // adjustedTransportPlanì— ìˆëŠ” ì°¨ìˆ˜ í™•ì¸
                    for (let tripNum in adjustedTransportPlan) {
                        const tripData = adjustedTransportPlan[tripNum];
                        const excelTripData = excelData[tripNum];
                        
                        if (!excelTripData) {
                            missingInExcel.push(tripNum);
                            continue;
                        }
                        
                        // ë‚ ì§œ ë¹„êµ
                        if (tripData.date !== excelTripData.date) {
                            dateMismatches.push({
                                tripNum: tripNum,
                                planDate: tripData.date || '(ì—†ìŒ)',
                                excelDate: excelTripData.date
                            });
                        }
                        
                        // ê¸°ë‘¥ ë¹„êµ
                        const planColumns = (tripData.columns || []).map(c => String(c).trim()).sort();
                        const excelColumns = (excelTripData.columns || []).map(c => String(c).trim()).sort();
                        
                        const planSet = new Set(planColumns);
                        const excelSet = new Set(excelColumns);
                        
                        // ì—‘ì…€ì— ì—†ëŠ” ê¸°ë‘¥
                        planColumns.forEach(col => {
                            if (!excelSet.has(col)) {
                                missingInPlan.push({ tripNum: tripNum, colNo: col });
                            }
                        });
                        
                        // ê³„íšì— ì—†ëŠ” ê¸°ë‘¥
                        excelColumns.forEach(col => {
                            if (!planSet.has(col)) {
                                differences.push({ tripNum: tripNum, colNo: col, type: 'ì—‘ì…€ì—ë§Œ ìˆìŒ' });
                            }
                        });
                    }
                    
                    // ì—‘ì…€ì—ë§Œ ìˆëŠ” ì°¨ìˆ˜
                    for (let tripNum in excelData) {
                        if (!adjustedTransportPlan[tripNum]) {
                            differences.push({ tripNum: tripNum, type: 'ì—‘ì…€ì—ë§Œ ìˆëŠ” ì°¨ìˆ˜' });
                        }
                    }
                    
                    // ê²°ê³¼ í‘œì‹œ ë° ì™„ì „ ì¼ì¹˜ ì‹œ ë‚ ì§œ ì—…ë°ì´íŠ¸
                    let resultHtml = '';
                    if (differences.length === 0 && missingInExcel.length === 0 && missingInPlan.length === 0 && dateMismatches.length === 0) {
                        // ì™„ì „ ì¼ì¹˜: ì—‘ì…€ íŒŒì¼ì˜ ë‚ ì§œë¡œ adjustedTransportPlan ì—…ë°ì´íŠ¸
                        for (let tripNum in excelData) {
                            if (adjustedTransportPlan[tripNum]) {
                                adjustedTransportPlan[tripNum].date = excelData[tripNum].date;
                            }
                        }
                        
                        // localStorageì— ì €ì¥
                        localStorage.setItem(kcolKey('adjustedTransportPlan'), JSON.stringify(adjustedTransportPlan));
                        
                        // ì¡°ì •ëœ ê³µì •í‘œê°€ í‘œì‹œ ì¤‘ì´ë©´ transportPlanë„ ì—…ë°ì´íŠ¸í•˜ê³  ê³µì •í‘œ ë‹¤ì‹œ ë Œë”ë§
                        if (isShowingAdjustedPlan) {
                            transportPlan = JSON.parse(JSON.stringify(adjustedTransportPlan));
                            
                            // dailyData ë™ê¸°í™”
                            if (typeof syncTransportToDailyData === 'function') {
                                syncTransportToDailyData(false);
                            }
                            
                            // ê³µì •í‘œ ì—…ë°ì´íŠ¸
                            if (typeof renderGanttChart === 'function') {
                                renderGanttChart();
                            }
                        }
                        
                        resultHtml = '<div style="color:#4caf50;font-weight:600;">âœ… ì™„ì „ ì¼ì¹˜</div>';
                        resultHtml += `<div style="margin-top:4px;color:#666;">ì´ ${Object.keys(adjustedTransportPlan).length}ê°œ ì°¨ìˆ˜, ëª¨ë“  ê¸°ë‘¥ê³¼ ë‚ ì§œê°€ ì¼ì¹˜í•©ë‹ˆë‹¤.</div>`;
                        resultHtml += `<div style="margin-top:4px;color:#4caf50;font-size:10px;">ì—‘ì…€ íŒŒì¼ì˜ ë‚ ì§œë¡œ ì¡°ì •ëœ ì°¨ìˆ˜ê³„íšì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.</div>`;
                    } else {
                        resultHtml = '<div style="color:#ff9800;font-weight:600;">âš ï¸ ì¼ë¶€ ë¶ˆì¼ì¹˜ ë°œê²¬</div>';
                        
                        if (missingInExcel.length > 0) {
                            resultHtml += `<div style="margin-top:4px;color:#f44336;">ì—‘ì…€ì— ì—†ëŠ” ì°¨ìˆ˜: ${missingInExcel.sort((a,b)=>a-b).join(', ')}ì°¨</div>`;
                        }
                        
                        if (dateMismatches.length > 0) {
                            resultHtml += `<div style="margin-top:4px;color:#f44336;">ë‚ ì§œ ë¶ˆì¼ì¹˜:</div>`;
                            dateMismatches.forEach(m => {
                                resultHtml += `<div style="margin-left:8px;font-size:10px;">${m.tripNum}ì°¨: ê³„íš(${m.planDate}) vs ì—‘ì…€(${m.excelDate})</div>`;
                            });
                        }
                        
                        if (missingInPlan.length > 0) {
                            resultHtml += `<div style="margin-top:4px;color:#f44336;">ê³„íšì— ì—†ëŠ” ê¸°ë‘¥: ${missingInPlan.length}ê°œ</div>`;
                            const grouped = {};
                            missingInPlan.forEach(m => {
                                if (!grouped[m.tripNum]) grouped[m.tripNum] = [];
                                grouped[m.tripNum].push(m.colNo);
                            });
                            Object.keys(grouped).forEach(tripNum => {
                                resultHtml += `<div style="margin-left:8px;font-size:10px;">${tripNum}ì°¨: ${grouped[tripNum].join(', ')}</div>`;
                            });
                        }
                        
                        if (differences.length > 0) {
                            resultHtml += `<div style="margin-top:4px;color:#f44336;">ì—‘ì…€ì—ë§Œ ìˆëŠ” í•­ëª©: ${differences.length}ê°œ</div>`;
                        }
                    }
                    
                    resultEl.innerHTML = resultHtml;
                    
                } catch (error) {
                    console.error('ì—‘ì…€ íŒŒì¼ ì½ê¸° ì˜¤ë¥˜:', error);
                    resultEl.innerHTML = '<div style="color:#f44336;">âŒ ì—‘ì…€ íŒŒì¼ ì½ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br>' + error.message + '</div>';
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // ìš´ì†¡ë¬¼ëŸ‰ì‚°ì • í†µê³„ ì •ë³´ ì—…ë°ì´íŠ¸
        function updateTransportVolumeStats(data = transportVolumeData) {
            const totalWeightEl = document.getElementById('total-weight');
            const totalCountEl = document.getElementById('total-count');
            const averageWeightEl = document.getElementById('average-weight');
            
            if (!totalWeightEl || !totalCountEl || !averageWeightEl) return;
            
            if (!data || data.length === 0) {
                totalWeightEl.textContent = '0 kg';
                totalCountEl.textContent = '0 ê°œ';
                averageWeightEl.textContent = '0 kg';
                return;
            }
            
            // ì „ì²´ í•©ì‚° ì¤‘ëŸ‰ ê³„ì‚° (kg)
            let totalWeight = 0;
            let validCount = 0;
            
            data.forEach(item => {
                // weight í•„ë“œê°€ ë¬¸ìì—´ì¸ ê²½ìš° ìˆ«ìë¡œ ë³€í™˜ (ì‰¼í‘œ ì œê±°)
                let weight = 0;
                if (item.weight) {
                    const weightStr = String(item.weight).replace(/,/g, '').trim();
                    weight = parseFloat(weightStr) || 0;
                } else if (item['ì¤‘ëŸ‰(kg)']) {
                    const weightStr = String(item['ì¤‘ëŸ‰(kg)']).replace(/,/g, '').trim();
                    weight = parseFloat(weightStr) || 0;
                }
                
                if (weight > 0) {
                    totalWeight += weight;
                    validCount++;
                }
            });
            
            // ì´ ë¶€ì¬ìˆ˜ (ì¤‘ëŸ‰ì´ ìˆëŠ” í•­ëª©ë§Œ)
            const totalCount = validCount;
            
            // ë¶€ì¬ 1ê°œë‹¹ í‰ê·  ì¤‘ëŸ‰
            const averageWeight = totalCount > 0 ? totalWeight / totalCount : 0;
            
            // í‘œì‹œ (ì†Œìˆ˜ì  2ìë¦¬ê¹Œì§€, ì²œ ë‹¨ìœ„ êµ¬ë¶„ ê¸°í˜¸ ì ìš©)
            totalWeightEl.textContent = totalWeight.toLocaleString('ko-KR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' kg';
            totalCountEl.textContent = totalCount.toLocaleString('ko-KR') + ' ê°œ';
            averageWeightEl.textContent = averageWeight.toLocaleString('ko-KR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' kg';
        }
        
        // ì¡°ì •ë¶€ì¬ ì¶œë ¥ í˜•ì‹: ì¡°ì •ë¶€ì¬ìˆ˜(ì¦ê°) e.g. 9(+1), 8(+0), 3(-5)
        function formatAdjustedCount(adjusted, original) {
            const a = Number(adjusted ?? 0);
            const o = Number(original ?? 0);
            const diff = a - o;
            const sign = diff >= 0 ? "+" : "";
            return `${a}(${sign}${diff})`;
        }

        // ì°¨ìˆ˜ë³„ ì§‘ê³„ í…Œì´ë¸” ë Œë”ë§
        function renderTransportVolumeTripSummary(data = transportVolumeData) {
            const tbody = document.getElementById('transport-volume-trip-summary-tbody');
            if (!tbody) return;
            
            if (!data || data.length === 0 || !transportPlan || Object.keys(transportPlan).length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#888;padding:16px;">ì—‘ì…€ì„ ì—…ë¡œë“œí•˜ë©´ ì°¨ìˆ˜ë³„ ì§‘ê³„ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</td></tr>';
                return;
            }
            
            // ì°¨ìˆ˜ë³„ ì§‘ê³„ ë°ì´í„° ìƒì„±
            const tripSummary = {}; // { tripNum: { count: 0, totalWeight: 0, date: '' } }
            
            // transportPlanì˜ ëª¨ë“  ì°¨ìˆ˜ì— ëŒ€í•´ ì§‘ê³„
            for (let tripNum in transportPlan) {
                const tripData = transportPlan[tripNum];
                if (tripData && tripData.columns) {
                    tripSummary[tripNum] = {
                        count: 0,
                        totalWeight: 0, // ton ë‹¨ìœ„
                        date: tripData.date || ''
                    };
                    
                    // í•´ë‹¹ ì°¨ìˆ˜ì— ì†í•œ ê¸°ë‘¥ë“¤ì˜ ì¤‘ëŸ‰ í•©ì‚°
                    tripData.columns.forEach(col => {
                        // colId í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                        let colId = null;
                        if (typeof col === 'number') {
                            colId = getColumnId(col, 1);
                        } else {
                            const colStr = String(col);
                            if (colStr.match(/^\d+(?:TC|C)\d+$/i)) {
                                colId = colStr;
                            } else {
                                const colNum = parseInt(colStr.replace(/[^0-9]/g, ''));
                                if (colNum) {
                                    colId = getColumnId(colNum, 1);
                                }
                            }
                        }
                        
                        // transportVolumeDataì—ì„œ í•´ë‹¹ ê¸°ë‘¥ ì°¾ê¸°
                        if (colId) {
                            const item = data.find(d => {
                                const itemColId = d.no || '';
                                return itemColId === colId || 
                                       getColumnIndexFromId(itemColId) === getColumnIndexFromId(colId);
                            });
                            
                            if (item) {
                                const weight = parseFloat(item.weight) || 0; // kg
                                if (weight > 0) {
                                    tripSummary[tripNum].count++;
                                    tripSummary[tripNum].totalWeight += weight / 1000; // tonìœ¼ë¡œ ë³€í™˜
                                }
                            }
                        }
                    });
                }
            }
            
            // ì°¨ìˆ˜ ë²ˆí˜¸ë¡œ ì •ë ¬ (0ì°¨ ì œì™¸)
            const sortedTrips = Object.keys(tripSummary)
                .map(Number)
                .filter(t => t > 0)
                .sort((a, b) => a - b);
            
            if (sortedTrips.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#888;padding:16px;">ì°¨ìˆ˜ë³„ ì§‘ê³„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }
            
            // í…Œì´ë¸” í–‰ ìƒì„±
            const rows = sortedTrips.map(tripNum => {
                const summary = tripSummary[tripNum];
                const totalWeightTon = summary.totalWeight;
                const isOver25Ton = totalWeightTon > 25;
                const marginWeight = 25 - totalWeightTon; // 25í†¤ - ì°¨ìˆ˜í•©ì‚°ì¤‘ëŸ‰ (ì´ˆê³¼ì‹œ ë§ˆì´ë„ˆìŠ¤)
                
                return `
                    <tr>
                        <td style="text-align:center;font-weight:bold;">${tripNum}</td>
                        <td style="text-align:center;">${summary.count.toLocaleString('ko-KR')} ê°œ</td>
                        <td style="text-align:right;">${totalWeightTon.toLocaleString('ko-KR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ton</td>
                        <td style="text-align:center;${isOver25Ton ? 'color:#f44336;font-weight:bold;' : 'color:#000;'}">${isOver25Ton ? 'ì´ˆê³¼' : 'ì •ìƒ'}</td>
                        <td style="text-align:right;${marginWeight < 0 ? 'color:#f44336;font-weight:bold;' : 'color:#000;'}">${marginWeight.toLocaleString('ko-KR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ton</td>
                        <td style="text-align:center;">${summary.date || ''}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = rows.join('');
            // âœ… ì›ë³¸ ì°¨ìˆ˜í‘œ ê¸°ì¤€ ì €ì¥ (ì—¬ê¸° í•œ ë²ˆë§Œ!)
            window.originalTripCounts = {};
            for (const tripNum in tripSummary) {
                window.originalTripCounts[tripNum] = Number(tripSummary[tripNum]?.count ?? 0);
            }
        }
        
        // ìµœëŒ€ìš´ì†¡ 25í†¤ì‹œ ì°¨ìˆ˜ ì¡°ì • í…Œì´ë¸” ë Œë”ë§
        function renderAdjustedTransportVolumeTripSummary() {
            const tbody = document.getElementById('adjusted-transport-volume-trip-summary-tbody');
            if (!tbody) return;

            if (!Array.isArray(transportVolumeData) || transportVolumeData.length === 0) {
                console.warn('[AdjustedTripSummary] transportVolumeData empty -> summary will be 0 (data not loaded yet)');
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#888;padding:16px;">"ìµœëŒ€ìš´ì†¡25í†¤" ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ì¡°ì •ëœ ì°¨ìˆ˜ê³„íšì´ í‘œì‹œë©ë‹ˆë‹¤.</td></tr>';
                return;
            }
            if (!adjustedTransportPlan || typeof adjustedTransportPlan !== 'object') {
                console.warn('[AdjustedTripSummary] adjustedTransportPlan missing');
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#888;padding:16px;">"ìµœëŒ€ìš´ì†¡25í†¤" ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ì¡°ì •ëœ ì°¨ìˆ˜ê³„íšì´ í‘œì‹œë©ë‹ˆë‹¤.</td></tr>';
                return;
            }

            // ---- ë‚´ë¶€ ìœ í‹¸(ì¶©ëŒ/ì¤‘ë³µ ë°©ì§€) ----
            const normalizeColValue = (col) => {
                if (col == null) return '';
                if (typeof col === 'string' || typeof col === 'number') return String(col).trim();
                return String(col.colId ?? col.columnId ?? col.id ?? col.col ?? col.no ?? col.dno ?? col.column ?? col.name ?? '').trim();
            };
            const getTransportColNo = (d) => {
                if (!d) return '';
                if (d.no != null && String(d.no).trim() !== '') return String(d.no).trim();
                const directKeys = ['dno','DNO','col','COL','column','COLUMN','colNo','COLNO','columnNo','COLUMNNO','D.NO','d.no'];
                for (const k of directKeys) {
                    if (d[k] != null && String(d[k]).trim() !== '') return String(d[k]).trim();
                }
                for (const k of Object.keys(d)) {
                    const lk = k.toLowerCase();
                    if (lk === 'weight') continue;
                    if (lk.includes('no') || lk.includes('col') || lk.includes('column')) {
                        const v = d[k];
                        if (v != null && String(v).trim() !== '') return String(v).trim();
                    }
                }
                return '';
            };
            const getColIndex = (v) => {
                const s = String(v ?? '').trim();
                const idx = getColumnIndexFromId(s);
                if (idx != null) return idx;
                const fallback = parseInt(s.replace(/[^0-9]/g, ''), 10);
                return Number.isFinite(fallback) ? fallback : null;
            };
            const getSubIndex = (v) => {
                if (typeof getSubIndexFromId === 'function') {
                    const s = String(v ?? '').trim();
                    return getSubIndexFromId(s);
                }
                return null;
            };
            const columnsMatchStrict = (aRaw, bRaw) => {
                const a = normalizeColValue(aRaw);
                const b = String(bRaw ?? '').trim();
                if (!a || !b) return false;
                if (a === b) return true;
                const ai = getColIndex(a);
                const bi = getColIndex(b);
                if (ai == null || bi == null) return false;
                if (ai !== bi) return false;
                const as = getSubIndex(a);
                const bs = getSubIndex(b);
                if (as != null && bs != null) return as === bs;
                return true;
            };
            // ---- ìœ í‹¸ ë ----

            const tripSummary = {};
            for (const tripNum in adjustedTransportPlan) {
                const tripData = adjustedTransportPlan[tripNum];
                tripSummary[tripNum] = { count: 0, totalWeight: 0, date: tripData?.date || '' };
                const cols = tripData?.columns;
                if (!Array.isArray(cols) || cols.length === 0) continue;
                for (const rawCol of cols) {
                    const item = transportVolumeData.find(d => {
                        const dCol = getTransportColNo(d);
                        return columnsMatchStrict(rawCol, dCol);
                    });
                    if (item) {
                        tripSummary[tripNum].count++;
                        const weightKg = parseFloat(String(item.weight ?? '').replace(/,/g, '')) || 0;
                        if (weightKg > 0) tripSummary[tripNum].totalWeight += weightKg / 1000;
                    }
                }
            }

            // ì°¨ìˆ˜ ë²ˆí˜¸ë¡œ ì •ë ¬ (0ì°¨ ì œì™¸)
            const sortedTrips = Object.keys(tripSummary)
                .map(Number)
                .filter(t => t > 0)
                .sort((a, b) => a - b);
            
            if (sortedTrips.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#888;padding:16px;">ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }
            
            // ì¡°ì • ì°¨ìˆ˜ë³„ ë¶€ì¬ìˆ˜ ì €ì¥ (PDF/í”„ë¦°íŠ¸ ì¶œë ¥ìš©)
            window.adjustedTripCounts = {};
            for (const tripNum in tripSummary) {
                if (tripNum > 0) window.adjustedTripCounts[tripNum] = Number(tripSummary[tripNum]?.count ?? 0);
            }
            
            // ê¸°ì¡´ ìš´ì†¡ì°¨ìˆ˜ê³„íš í…Œì´ë¸”ì˜ ë¶€ì¬ìˆ˜ ê³„ì‚° (ë¹„êµìš©)
            const originalTripCounts = {}; // { tripNum: count }
            if (transportPlan && Object.keys(transportPlan).length > 0 && transportVolumeData && transportVolumeData.length > 0) {
                for (let tripNum in transportPlan) {
                    const tripData = transportPlan[tripNum];
                    if (tripData && tripData.columns) {
                        let count = 0;
                        tripData.columns.forEach(col => {
                            let colId = null;
                            if (typeof col === 'number') {
                                colId = getColumnId(col, 1);
                            } else {
                                const colStr = String(col);
                                if (colStr.match(/^\d+(?:TC|C)\d+$/i)) {
                                    colId = colStr;
                                } else {
                                    const colNum = parseInt(colStr.replace(/[^0-9]/g, ''));
                                    if (colNum) {
                                        colId = getColumnId(colNum, 1);
                                    }
                                }
                            }
                            
                            if (colId) {
                                const item = transportVolumeData.find(d => {
                                    const itemColId = d.no || '';
                                    return itemColId === colId || 
                                           getColumnIndexFromId(itemColId) === getColumnIndexFromId(colId);
                                });
                                if (item) {
                                    const weight = parseFloat(String(item.weight).replace(/,/g, '')) || 0;
                                    if (weight > 0) {
                                        count++;
                                    }
                                }
                            }
                        });
                        originalTripCounts[tripNum] = count;
                    }
                }
            }
            
            // í…Œì´ë¸” í–‰ ìƒì„±
            const rows = sortedTrips.map((tripNum, idx) => {
                const summary = tripSummary[tripNum];
                const totalWeightTon = summary.totalWeight;
                const isOver25Ton = totalWeightTon > 25;
                const marginWeight = 25 - totalWeightTon; // 25í†¤ - ì°¨ìˆ˜í•©ì‚°ì¤‘ëŸ‰ (ì´ˆê³¼ì‹œ ë§ˆì´ë„ˆìŠ¤)
                
                const isLastTrip = idx === sortedTrips.length - 1;
                const currentDelta = tripCountDeltas[tripNum] ?? 0;
                const deltaOpts = isLastTrip ? [-10,-9,-8,-7,-6,-5,-4,-3,-2,-1,0] : [-10,-9,-8,-7,-6,-5,-4,-3,-2,-1,0,1,2,3,4,5,6,7,8,9,10];
                const selVal = deltaOpts.includes(currentDelta) ? currentDelta : 0;
                const deltaSelectHtml = `
                    <select onchange="adjustAdjustedTripCount(${tripNum}, this.value)" style="margin-left:6px;width:auto;min-width:48px;padding:2px 4px;font-size:11px;border:1px solid #ddd;border-radius:4px;background:#fff;cursor:pointer;" title="ë¶€ì¬ìˆ˜ ì¡°ì •">
                        ${deltaOpts.map(d => `<option value="${d}"${selVal === d ? ' selected' : ''}>${d >= 0 ? '+' : ''}${d}</option>`).join('')}
                    </select>
                `;
                const original = Number((window.originalTripCounts && window.originalTripCounts[tripNum]) ?? originalTripCounts?.[tripNum] ?? 0);
                const adjusted = Number((window.adjustedTripCounts && window.adjustedTripCounts[tripNum]) ?? tripSummary[tripNum]?.count ?? 0);
                const text = formatAdjustedCount(adjusted, original);
                
                return `
                    <tr>
                        <td style="text-align:center;font-weight:bold;">${tripNum}</td>
                        <td style="text-align:center;">${text}${deltaSelectHtml}</td>
                        <td style="text-align:right;">${totalWeightTon.toLocaleString('ko-KR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ton</td>
                        <td style="text-align:center;${isOver25Ton ? 'color:#f44336;font-weight:bold;' : 'color:#000;'}">${isOver25Ton ? 'ì´ˆê³¼' : 'ì •ìƒ'}</td>
                        <td style="text-align:right;${marginWeight < 0 ? 'color:#f44336;font-weight:bold;' : 'color:#000;'}">${marginWeight.toLocaleString('ko-KR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ton</td>
                        <td style="text-align:center;">${summary.date || ''}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = rows.join('');
        }

        function renderAdjustedTripSummarySafe() {
            const readyVolume =
                Array.isArray(transportVolumeData) &&
                transportVolumeData.length > 0;

            const readyPlan =
                adjustedTransportPlan &&
                typeof adjustedTransportPlan === 'object' &&
                Object.keys(adjustedTransportPlan).length > 0;

            if (!readyVolume || !readyPlan) return;

            renderAdjustedTransportVolumeTripSummary();
        }

        // í˜„ì¥ì„¤ì¹˜í˜„í™©: ì„¤ì¹˜ ìƒíƒœ ë Œë”ë§
        function renderInstallationStatus() {
            const columnList = document.getElementById('installation-column-list');
            const floorPlanImage = document.getElementById('installation-floor-plan-image');
            const progressSummary = document.getElementById('installation-progress-summary');
            
            if (!columnList || !floorPlanImage) return;
            
            // ê³µì •ìœ¨ ê³„ì‚° ë° í‘œì‹œ (ì†Œë¶€ì¬ì¡°ë¦½(process 4) í¬í•¨)
            if (progressSummary) {
                const processNames = { 1: 'ì£¼ê¸°ë‘¥ì»¤íŒ…', 2: 'ì†Œë¶€ì¬ì»¤íŒ…', 3: 'ì£¼ê¸°ë‘¥ì¡°ë¦½', 4: 'ì†Œë¶€ì¬ì¡°ë¦½', 5: 'í˜„ì¥ë°°ì†¡', 6: 'í˜„ì¥ì„¤ì¹˜' };
                const processColors = { 1: '#e74c3c', 2: '#ff9800', 3: '#2196f3', 4: '#00bcd4', 5: '#9c27b0', 6: '#4caf50' };
                const TOTAL_COLUMNS_FOR_PROGRESS = 100; // ê³µì •ìœ¨ ê³„ì‚° ê¸°ì¤€: ê¸°ë‘¥ ê°œìˆ˜ 100ê°œ
                let progressHtml = '';
                const progressProcesses = [1, 2, 3, 4, 5, 6]; // ì†Œë¶€ì¬ì¡°ë¦½(4) í¬í•¨
                for (const p of progressProcesses) {
                    let completedCount = 0;
                    
                    if (p === 5) {
                        // í˜„ì¥ë°°ì†¡(process 5): ì‹¤ì œ ë°°ì†¡ì´ ì§„í–‰ëœ ë¶€ì¬ë§Œ í•©ì‚° (actualDeliveryDateì— ê¸°ë¡ëœ ê²ƒë§Œ)
                        if (typeof actualDeliveryDate !== 'undefined' && actualDeliveryDate) {
                            completedCount = Object.keys(actualDeliveryDate).length;
                        }
                    } else {
                        // ë‹¤ë¥¸ ê³µì •: dailyDataì—ì„œ ì™„ë£Œëœ ê¸°ë‘¥ ìˆ˜ ê³„ì‚° (ì¤‘ë³µ ì œê±°)
                    const uniqueColumns = new Set();
                    for (let date in dailyData) {
                        if (dailyData[date] && dailyData[date][p]) {
                            dailyData[date][p].forEach(col => {
                                const colId = typeof col === 'string' ? col : (col + 'C');
                                uniqueColumns.add(colId);
                            });
                        }
                    }
                        completedCount = uniqueColumns.size;
                    }
                    
                    const percentage = TOTAL_COLUMNS_FOR_PROGRESS > 0 ? Math.round((completedCount / TOTAL_COLUMNS_FOR_PROGRESS) * 100) : 0;
                    
                    progressHtml += `
                        <div style="text-align:center;padding:8px;background:#f8f9fa;border-radius:6px;border:1px solid #e0e0e0;">
                            <div style="font-size:11px;color:#666;margin-bottom:4px;">${processNames[p]}</div>
                            <div style="font-size:18px;font-weight:bold;color:${processColors[p]};margin-bottom:4px;">${percentage}%</div>
                            <div style="font-size:10px;color:#999;">${completedCount}/${TOTAL_COLUMNS_FOR_PROGRESS}</div>
                            <div style="margin-top:6px;height:4px;background:#e0e0e0;border-radius:2px;overflow:hidden;">
                                <div style="height:100%;background:${processColors[p]};width:${percentage}%;transition:width 0.3s;"></div>
                            </div>
                        </div>
                    `;
                }
                
                progressSummary.innerHTML = progressHtml;
            }
            
            // ê¸°ë‘¥ ë²ˆí˜¸ ëª©ë¡ ìƒì„± (ë©”ì¸ ê¸°ë‘¥ ë²ˆí˜¸ë§Œ: 1C~50C)
            let html = '';
            const installedColumns = [];
            
            // 50ê°œ ê¸°ë‘¥ (ë©”ì¸ ê¸°ë‘¥ ë²ˆí˜¸ë§Œ í‘œì‹œ)
            for (let i = 1; i <= TOTAL_COLUMNS; i++) {
                // ë©”ì¸ ê¸°ë‘¥ ë²ˆí˜¸ (1C, 2C, ..., 50C ë˜ëŠ” 7TC, 8TC ë“±)
                const prefix = TC_COLUMN_INDICES.includes(i) ? 'TC' : 'C';
                const mainColId = `${i}${prefix}`;
                
                // ë‘ ì„œë¸Œ í•­ëª©ì˜ ìƒíƒœ ì¤‘ ë” ë†’ì€ ìƒíƒœë¥¼ ì‚¬ìš©
                let maxStatus = 0;
                let hasInstalled = false;
                let hasDelivered = false;
                let hasInProgress = false;
                
                for (let sub = 1; sub <= SUB_ITEMS_PER_COLUMN; sub++) {
                    const colId = getColumnId(i, sub);
                const colData = columnData[colId] || {};
                const status = colData.status || 0;
                    maxStatus = Math.max(maxStatus, status);
                    
                    if (status === 6) hasInstalled = true;
                    if (status === 5) hasDelivered = true;
                    if (status > 0 && status < 5) hasInProgress = true;
                }
                
                // dailyDataì—ì„œ process 6 ì™„ë£Œ ì—¬ë¶€ í™•ì¸
                if (!hasInstalled) {
                    for (let date in dailyData) {
                        if (dailyData[date] && dailyData[date][6]) {
                            for (let sub = 1; sub <= SUB_ITEMS_PER_COLUMN; sub++) {
                                const colId = getColumnId(i, sub);
                                if (dailyData[date][6].includes(colId) || 
                                    dailyData[date][6].includes(i) || 
                                    dailyData[date][6].includes(String(i)) ||
                                    dailyData[date][6].includes(mainColId)) {
                                    hasInstalled = true;
                                    break;
                                }
                            }
                            if (hasInstalled) break;
                        }
                    }
                }
                
                // ìƒ‰ìƒ ê²°ì • (ìš°ì„ ìˆœìœ„: ì„¤ì¹˜ì™„ë£Œ > ë°°ì†¡ì™„ë£Œ > ì§„í–‰ì¤‘ > ë¯¸ì°©ìˆ˜)
                let bgColor = '#f5f5f5'; // ê¸°ë³¸ (ë¯¸ì°©ìˆ˜)
                let textColor = '#666';
                let statusText = 'ë¯¸ì°©ìˆ˜';
                
                if (hasInstalled) {
                    bgColor = '#4caf50'; // ì´ˆë¡ìƒ‰ (ì„¤ì¹˜ì™„ë£Œ)
                    textColor = '#fff';
                    statusText = 'ì„¤ì¹˜ì™„ë£Œ';
                    installedColumns.push({ id: mainColId, num: i });
                } else if (hasDelivered) {
                    bgColor = '#fff5ff'; // ì˜…ì€ ë§ˆì  íƒ€ (ë°°ì†¡ê³„íš - ì‹¤ì œ ìš´ì†¡ì´ ì•„ë‹˜)
                    textColor = '#fff';
                    statusText = 'ë°°ì†¡ê³„íš';
                } else if (hasInProgress) {
                    bgColor = '#ff9800'; // ì£¼í™©ìƒ‰ (ì§„í–‰ì¤‘)
                    textColor = '#fff';
                    statusText = 'ì§„í–‰ì¤‘';
                }
                
                // ì¢Œí‘œ ì„¤ì • ëª¨ë“œì¼ ë•Œ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
                const clickHandler = coordinateSetupMode ? `onclick="currentColumnForSetup='${mainColId}'; alert('${mainColId}ì˜ ì¢Œí‘œë¥¼ ì„¤ì •í•©ë‹ˆë‹¤. í‰ë©´ë„ ì´ë¯¸ì§€ë¥¼ í´ë¦­í•˜ì„¸ìš”.');"` : '';
                const cursorStyle = coordinateSetupMode ? 'cursor:pointer;' : '';
                const borderStyle = coordinateSetupMode ? 'border:2px solid #ff9800;' : '';
                
                html += `
                    <div ${clickHandler} style="padding:8px;background:${bgColor};color:${textColor};border-radius:6px;text-align:center;font-size:13px;font-weight:600;min-height:50px;display:flex;flex-direction:column;justify-content:center;${cursorStyle}${borderStyle}">
                        <div>${mainColId}</div>
                        <div style="font-size:11px;margin-top:4px;opacity:0.9;">${statusText}</div>
                    </div>
                `;
            }
            
            columnList.innerHTML = html;
            
            // í‰ë©´ë„ ì´ë¯¸ì§€ì— ì„¤ì¹˜ëœ ê¸°ë‘¥ ë§ˆì»¤ í‘œì‹œ
            floorPlanImage.innerHTML = '';
            
            // ì¢Œí‘œ ì„¤ì • ëª¨ë“œì¼ ë•Œ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
            if (coordinateSetupMode) {
                floorPlanImage.style.cursor = 'crosshair';
                floorPlanImage.onclick = handleFloorPlanClick;
            } else {
                floorPlanImage.style.cursor = 'default';
                floorPlanImage.onclick = null;
            }
            
            // ëª¨ë“  ê¸°ë‘¥ì— ëŒ€í•œ ë§ˆì»¤ í‘œì‹œ (ë©”ì¸ ê¸°ë‘¥ ë²ˆí˜¸ë§Œ: 1C~50C)
            for (let i = 1; i <= TOTAL_COLUMNS; i++) {
                // ë©”ì¸ ê¸°ë‘¥ ë²ˆí˜¸ (1C, 2C, ..., 50C ë˜ëŠ” 7TC, 8TC ë“±)
                const prefix = TC_COLUMN_INDICES.includes(i) ? 'TC' : 'C';
                const mainColId = `${i}${prefix}`;
                
                // ë‘ ì„œë¸Œ í•­ëª©ì˜ ìƒíƒœ ì¤‘ ë” ë†’ì€ ìƒíƒœë¥¼ ì‚¬ìš©
                let maxStatus = 0;
                let isInstalled = false;
                
                for (let sub = 1; sub <= SUB_ITEMS_PER_COLUMN; sub++) {
                    const colId = getColumnId(i, sub);
                const colData = columnData[colId] || {};
                const status = colData.status || 0;
                    maxStatus = Math.max(maxStatus, status);
                    if (status === 6) isInstalled = true;
                }
                
                // dailyDataì—ì„œ process 6 ì™„ë£Œ ì—¬ë¶€ í™•ì¸ (ëª¨ë“  ë‚ ì§œ í™•ì¸)
                if (!isInstalled) {
                    for (let date in dailyData) {
                        if (dailyData[date] && dailyData[date][6]) {
                            for (let sub = 1; sub <= SUB_ITEMS_PER_COLUMN; sub++) {
                                const colId = getColumnId(i, sub);
                            if (dailyData[date][6].includes(colId) || 
                                dailyData[date][6].includes(i) || 
                                dailyData[date][6].includes(String(i)) ||
                                    dailyData[date][6].includes(mainColId)) {
                                isInstalled = true;
                                break;
                            }
                            }
                            if (isInstalled) break;
                        }
                    }
                }
                
                // ì¢Œí‘œ í™•ì¸ (ë©”ì¸ ê¸°ë‘¥ ë²ˆí˜¸ë¡œ ì €ì¥ëœ ì¢Œí‘œ í™•ì¸)
                let coord = columnCoordinates[mainColId];
                // ì„œë¸Œ í•­ëª© ì¢Œí‘œë„ í™•ì¸ (í•˜ìœ„ í˜¸í™˜ì„±)
                if (!coord) {
                    for (let sub = 1; sub <= SUB_ITEMS_PER_COLUMN; sub++) {
                        const colId = getColumnId(i, sub);
                        if (columnCoordinates[colId]) {
                            coord = columnCoordinates[colId];
                            break;
                        }
                    }
                }
                
                // ì¢Œí‘œê°€ ìˆê±°ë‚˜ ì„¤ì¹˜ ì™„ë£Œëœ ê²½ìš°ì—ë§Œ í‘œì‹œ
                if (coord || isInstalled) {
                    const pos = coord || { left: 50, top: 50 }; // ê¸°ë³¸ ìœ„ì¹˜
                    
                    const marker = document.createElement('div');
                    marker.style.cssText = `
                        position: absolute;
                        width: ${isInstalled ? '24px' : '20px'};
                        height: ${isInstalled ? '24px' : '20px'};
                        background: ${isInstalled ? '#4caf50' : '#ff9800'};
                        border: 3px solid #fff;
                        border-radius: 50%;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.4);
                        cursor: ${coordinateSetupMode ? 'pointer' : 'default'};
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: ${isInstalled ? '11px' : '10px'};
                        font-weight: bold;
                        color: white;
                        z-index: 10;
                        transform: translate(-50%, -50%);
                    `;
                    marker.textContent = mainColId;
                    marker.title = `${mainColId} ${isInstalled ? 'ì„¤ì¹˜ì™„ë£Œ' : 'ì¢Œí‘œì„¤ì •ë¨'}`;
                    
                    // ì‹¤ì œ ì¢Œí‘œì— ë§ì¶° ë°°ì¹˜
                    marker.style.left = pos.left + '%';
                    marker.style.top = pos.top + '%';
                    
                    // ì¢Œí‘œ ì„¤ì • ëª¨ë“œì¼ ë•Œ ë§ˆì»¤ í´ë¦­ìœ¼ë¡œ í•´ë‹¹ ê¸°ë‘¥ ì„ íƒ
                    if (coordinateSetupMode) {
                        marker.onclick = (e) => {
                            e.stopPropagation();
                            currentColumnForSetup = mainColId;
                            alert(`${mainColId}ì˜ ì¢Œí‘œë¥¼ ë³€ê²½í•˜ë ¤ë©´ í‰ë©´ë„ ì´ë¯¸ì§€ë¥¼ í´ë¦­í•˜ì„¸ìš”.`);
                        };
                    }
                    
                    floorPlanImage.appendChild(marker);
                }
            }
            
            if (installedColumns.length === 0 && Object.keys(columnCoordinates).length === 0) {
                floorPlanImage.innerHTML = '<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#999;font-size:14px;">ì„¤ì¹˜ ì™„ë£Œëœ ê¸°ë‘¥ì´ ì—†ìŠµë‹ˆë‹¤.<br>ì¢Œí‘œ ì„¤ì • ëª¨ë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ê¸°ë‘¥ ìœ„ì¹˜ë¥¼ ì„¤ì •í•˜ì„¸ìš”.</div>';
            }
        }

        // ìš´ì†¡ë¬¼ëŸ‰ì‚°ì •: ì—‘ì…€ ì—…ë¡œë“œ ì²˜ë¦¬
        function handleTransportVolumeFile(event) {
            const file = event.target.files[0];
            
            if (!file) {
                return;
            }
            
            // ê¶Œí•œ ì²´í¬: ViewerëŠ” ì—…ë¡œë“œ ë¶ˆê°€, EditorëŠ” ê³µì • 5ë§Œ í—ˆìš©, Adminì€ ëª¨ë“  ê³µì • ê°€ëŠ¥
            if (userRole === 'viewer') {
                alert('âš ï¸ ê¶Œí•œ ì—†ìŒ\n\nViewerëŠ” ìš´ì†¡ë¬¼ëŸ‰ì‚°ì • íŒŒì¼ì„ ì—…ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // EditorëŠ” ê³µì • 5ë§Œ í—ˆìš©, Adminì€ ëª¨ë“  ê³µì • ê°€ëŠ¥
            if (userRole === 'editor' && !allowedProcesses.includes(5)) {
                alert('âš ï¸ ê¶Œí•œ ì—†ìŒ\n\nEditorëŠ” í˜„ì¥ë°°ì†¡(ê³µì • 5) íŒŒì¼ì„ ì—…ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\ní—ˆìš©ëœ ê³µì •: ' + allowedProcesses.map(p => {
                    const proc = PROCESSES.find(pr => pr.id === p);
                    return proc ? `${p}.${proc.name}` : `${p}`;
                }).join(', '));
                return;
            }
            if (typeof XLSX === 'undefined') {
                alert('ì—‘ì…€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[firstSheet];
                    const rows = XLSX.utils.sheet_to_json(sheet, { defval: '' });
                    
                    // ë””ë²„ê¹…: ì²« ë²ˆì§¸ í–‰ì˜ í‚¤ í™•ì¸
                    if (rows.length > 0) {
                        console.log('ì—‘ì…€ ì²« ë²ˆì§¸ í–‰ í‚¤:', Object.keys(rows[0]));
                        console.log('ì—‘ì…€ ì²« ë²ˆì§¸ í–‰ ë°ì´í„°:', rows[0]);
                    }
                    
                    transportVolumeData = rows.slice(0, 100).map((row, idx) => {
                        // ì›ë³¸ rowì˜ ëª¨ë“  í‚¤ë¥¼ í™•ì¸í•˜ì—¬ ë°ì´í„° ì¶”ì¶œ
                        const rowKeys = Object.keys(row);
                        
                        // í—¤ë” ë§¤ì¹­ í•¨ìˆ˜ (ëŒ€ì†Œë¬¸ì, ê³µë°± ë¬´ì‹œ, ê³µë°± ì œê±° í›„ ë¹„êµ)
                        const findKey = (patterns) => {
                            for (let pattern of patterns) {
                                const found = rowKeys.find(key => {
                                    // í‚¤ì™€ íŒ¨í„´ ëª¨ë‘ ê³µë°± ì œê±° í›„ ì†Œë¬¸ìë¡œ ë³€í™˜í•˜ì—¬ ë¹„êµ
                                    const normalizedKey = key.trim().replace(/\s+/g, '').toLowerCase();
                                    const normalizedPattern = pattern.trim().replace(/\s+/g, '').toLowerCase();
                                    return normalizedKey === normalizedPattern || 
                                           normalizedKey.includes(normalizedPattern);
                                });
                                if (found) {
                                    const value = row[found];
                                    // ê°’ì´ ìˆ«ìë©´ ê·¸ëŒ€ë¡œ, ë¬¸ìì—´ì´ë©´ trim
                                    return typeof value === 'string' ? value.trim() : value;
                                }
                            }
                            return '';
                        };
                        
                        // ìƒˆë¡œìš´ í—¤ë” í˜•ì‹: ê³µì¢…, ë„ë©´ë²ˆí˜¸, ê¸°ë‘¥ë²ˆí˜¸, ê·œê²©, ê¸¸ì´(mm), ì¤‘ëŸ‰(kg), ìš´ì†¡ì°¨ìˆ˜ê³„íš(13ì°¨), ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš(12ì°¨)
                        const workType = findKey(['ê³µì¢…']) || '';
                        const drawingNo = findKey(['ë„ë©´ë²ˆí˜¸']) || '';
                        // ê¸°ë‘¥ë²ˆí˜¸ê°€ ë¹„ì–´ìˆìœ¼ë©´ ë„ë©´ë²ˆí˜¸ë¥¼ ê¸°ë‘¥ë²ˆí˜¸ë¡œ ì‚¬ìš©
                        let colNo = findKey(['ê¸°ë‘¥ë²ˆí˜¸', 'ê¸°ë‘¥', 'ë²ˆí˜¸', 'Column', 'No']) || '';
                        if (!colNo && drawingNo) {
                            colNo = drawingNo; // ë„ë©´ë²ˆí˜¸ë¥¼ ê¸°ë‘¥ë²ˆí˜¸ë¡œ ì‚¬ìš©
                        }
                        const size = findKey(['ê·œê²©', 'ì‚¬ì´ì¦ˆ', 'size']) || '';
                        const lengthVal = findKey(['ê¸¸ì´(mm)', 'ê¸¸ì´', 'length', 'len']) || '';
                        const weight = findKey(['ì¤‘ëŸ‰(kg)', 'ì¤‘ëŸ‰', 'weight']) || '';
                        
                        // ìš´ì†¡ì°¨ìˆ˜ê³„íš(13ì°¨) í˜•ì‹ì—ì„œ ì°¨ìˆ˜ ì¶”ì¶œ
                        let transportPlan = '';
                        const transportPlanKey = rowKeys.find(key => {
                            const normalized = key.trim().toLowerCase();
                            return normalized.includes('ìš´ì†¡ì°¨ìˆ˜ê³„íš') && normalized.includes('ì°¨');
                        });
                        if (transportPlanKey) {
                            const match = transportPlanKey.match(/\((\d+)ì°¨\)/);
                            if (match) {
                                transportPlan = match[1];
                            } else {
                                transportPlan = String(row[transportPlanKey] || '').trim();
                            }
                        }
                        
                        // ì¡°ì •ëœ ì°¨ìˆ˜ê³„íš(12ì°¨) ë˜ëŠ” ì¡°ì •ëœ ìš´ì†¡ì°¨ìˆ˜(12ì°¨) í˜•ì‹ì—ì„œ ì°¨ìˆ˜ ì¶”ì¶œ
                        let adjustedPlan = '';
                        const adjustedPlanKey = rowKeys.find(key => {
                            const normalized = key.trim().toLowerCase();
                            return (normalized.includes('ì¡°ì •ëœ') && (normalized.includes('ì°¨ìˆ˜ê³„íš') || normalized.includes('ìš´ì†¡ì°¨ìˆ˜')) && normalized.includes('ì°¨'));
                        });
                        if (adjustedPlanKey) {
                            const match = adjustedPlanKey.match(/\((\d+)ì°¨\)/);
                            if (match) {
                                adjustedPlan = match[1];
                            } else {
                                adjustedPlan = String(row[adjustedPlanKey] || '').trim();
                            }
                        }
                        
                        return {
                            workType: workType || '',
                            drawingNo: drawingNo || '',
                            no: colNo || (idx + 1),
                            size: size || '',
                            length: lengthVal || '',
                            weight: weight || '',
                            transportPlan: transportPlan || '',
                            adjustedPlan: adjustedPlan || '',
                            // ì›ë³¸ ë°ì´í„°ë„ ì €ì¥ (ì›ë³¸ í—¤ë”ëª…ìœ¼ë¡œ ì ‘ê·¼ ê°€ëŠ¥)
                            ì›ë³¸: row,
                            // ì—‘ì…€ ì›ë³¸ ìˆœì„œ ìœ ì§€ (ì¸ë±ìŠ¤)
                            ì—‘ì…€ìˆœì„œ: idx
                        };
                    });
                    
                    // ë””ë²„ê¹…: ë³€í™˜ëœ ì²« ë²ˆì§¸ ë°ì´í„° í™•ì¸
                    if (transportVolumeData.length > 0) {
                        console.log('ë³€í™˜ëœ ì²« ë²ˆì§¸ ë°ì´í„°:', transportVolumeData[0]);
                        console.log('ë³€í™˜ëœ ë°ì´í„° ê°œìˆ˜:', transportVolumeData.length);
                        console.log('ë³€í™˜ëœ ë°ì´í„° ìƒ˜í”Œ (ì²˜ìŒ 3ê°œ):', transportVolumeData.slice(0, 3));
                    }
                    
                    // localStorageì— ì €ì¥
                    localStorage.setItem(kcolKey('transportVolumeData'), JSON.stringify(transportVolumeData));
                    console.log('âœ… ìš´ì†¡ë¬¼ëŸ‰ì‚°ì • ë°ì´í„° localStorage ì €ì¥ ì™„ë£Œ');
                    
                    renderTransportVolumeTable();
                    console.log('í…Œì´ë¸” ë Œë”ë§ ì™„ë£Œ');
                } catch (err) {
                    console.error('ìš´ì†¡ë¬¼ëŸ‰ ì—‘ì…€ ì²˜ë¦¬ ì˜¤ë¥˜:', err);
                    alert('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í…œí”Œë¦¿ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // ì¤‘ë³µ ê¸°ë‘¥ ì²´í¬ í•¨ìˆ˜
        function checkDuplicateColumns() {
            duplicateColumns = {}; // ì´ˆê¸°í™”
            
            // ëª¨ë“  ì°¨ìˆ˜ì—ì„œ ê¸°ë‘¥ ì‚¬ìš© íšŸìˆ˜ ê³„ì‚°
            const columnUsage = {}; // { columnId: [tripNumbers] }
            
            for (let tripNum in transportPlan) {
                const tripData = transportPlan[tripNum] || { columns: [], date: '' };
                const columns = tripData.columns || [];
                columns.forEach(columnId => {
                    if (!columnUsage[columnId]) {
                        columnUsage[columnId] = [];
                    }
                    columnUsage[columnId].push(parseInt(tripNum));
                });
            }
            
            // ì¤‘ë³µëœ ê¸°ë‘¥ ì°¾ê¸° (2ê°œ ì´ìƒ ì°¨ìˆ˜ì— í¬í•¨ëœ ê¸°ë‘¥)
            for (let columnId in columnUsage) {
                if (columnUsage[columnId].length > 1) {
                    duplicateColumns[columnId] = columnUsage[columnId];
                }
            }
            
            // ê²°ê³¼ í‘œì‹œ
            const resultDiv = document.getElementById('duplicate-check-result');
            const infoDiv = document.getElementById('duplicate-info');
            
            if (Object.keys(duplicateColumns).length === 0) {
                // ì¤‘ë³µ ì—†ìŒ
                resultDiv.style.display = 'none';
                alert('âœ… ì¤‘ë³µëœ ê¸°ë‘¥ì´ ì—†ìŠµë‹ˆë‹¤.');
            } else {
                // ì¤‘ë³µ ìˆìŒ
                resultDiv.style.display = 'block';
                resultDiv.style.background = '#ffebee';
                resultDiv.style.borderLeft = '4px solid #f44336';
                
                let infoHtml = '<div style="margin-bottom:8px;"><strong>ë‹¤ìŒ ê¸°ë‘¥ì´ ì—¬ëŸ¬ ì°¨ìˆ˜ì— ì¤‘ë³µ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤:</strong></div>';
                infoHtml += '<ul style="margin:0;padding-left:20px;">';
                
                // colId í˜•ì‹ìœ¼ë¡œ ì •ë ¬ (ê¸°ë‘¥ ë²ˆí˜¸ ê¸°ì¤€)
                const duplicateList = Object.keys(duplicateColumns).sort((a, b) => {
                    const numA = getColumnIndexFromId(String(a)) || parseInt(String(a).replace(/[^0-9]/g, '')) || 0;
                    const numB = getColumnIndexFromId(String(b)) || parseInt(String(b).replace(/[^0-9]/g, '')) || 0;
                    if (numA !== numB) return numA - numB;
                    // ê°™ì€ ê¸°ë‘¥ ë²ˆí˜¸ë©´ ì„œë¸Œ ì¸ë±ìŠ¤ë¡œ ì •ë ¬
                    const subA = getSubIndexFromId(String(a)) || 1;
                    const subB = getSubIndexFromId(String(b)) || 1;
                    return subA - subB;
                });
                duplicateList.forEach(columnId => {
                    const trips = duplicateColumns[columnId].sort((a, b) => a - b);
                    infoHtml += `<li style="margin:5px 0;">${columnId}: ${trips.map(t => t + 'ì°¨ìˆ˜').join(', ')}ì— í¬í•¨</li>`;
                });
                
                infoHtml += '</ul>';
                infoDiv.innerHTML = infoHtml;
                
                alert(`âš ï¸ ${duplicateList.length}ê°œì˜ ê¸°ë‘¥ì´ ì¤‘ë³µë˜ì—ˆìŠµë‹ˆë‹¤. í™”ë©´ì—ì„œ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.`);
            }
            
            // ê·¸ë¦¬ë“œ ë‹¤ì‹œ ë Œë”ë§í•˜ì—¬ ì¤‘ë³µ í‘œì‹œ
            renderTransportColumnGrid();
        }

        // ìš´ì†¡ê³„íš ì €ì¥
        // ìš´ì†¡ì°¨ìˆ˜ê³„íšì„ dailyDataì˜ í˜„ì¥ë°°ì†¡(process 5)ì— ë™ê¸°í™”
        function syncTransportToDailyData(needConfirm = false) {
            // ğŸ”’ [ê°€ë“œ] ê¶Œí•œ ì²´í¬: ViewerëŠ” ì €ì¥ ë¶ˆê°€
            if (userRole === 'viewer') {
                console.warn('âš ï¸ [ê°€ë“œ] ViewerëŠ” ìš´ì†¡ê³„íšì„ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return false;
            }
            
            // ğŸ”’ [ê°€ë“œ] ê¶Œí•œ ì²´í¬: EditorëŠ” í—ˆìš©ëœ ê³µì •ë§Œ ì €ì¥ ê°€ëŠ¥
            // ìš´ì†¡ê³„íšì€ process 5 (í˜„ì¥ë°°ì†¡)ì— ë™ê¸°í™”ë˜ë¯€ë¡œ, process 5ê°€ í—ˆìš©ë˜ì–´ì•¼ í•¨
            if (userRole === 'editor') {
                const process5Allowed = canEditProcess('5');
                if (!process5Allowed) {
                    console.warn('âš ï¸ [ê°€ë“œ] EditorëŠ” í˜„ì¥ë°°ì†¡(process 5)ì„ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return false;
                }
            }
            
            console.log('syncTransportToDailyData ì‹œì‘, transportPlan:', transportPlan);
            
            // í˜„ì¥ë°°ì†¡ ìƒíƒœë¡œ ë³€ê²½ë  ê¸°ë‘¥ ëª©ë¡ ìˆ˜ì§‘
            const columnsToUpdate = [];
            for (let tripNum in transportPlan) {
                const tripData = transportPlan[tripNum];
                console.log(`ì°¨ìˆ˜ ${tripNum} í™•ì¸:`, tripData);
                
                if (!tripData || !tripData.date || !tripData.columns || tripData.columns.length === 0) {
                    console.log(`ì°¨ìˆ˜ ${tripNum} ìŠ¤í‚µ: ë‚ ì§œ ë˜ëŠ” ê¸°ë‘¥ì´ ì—†ìŒ`);
                    continue;
                }
                
                const date = tripData.date.trim();
                if (!date) {
                    console.log(`ì°¨ìˆ˜ ${tripNum} ìŠ¤í‚µ: ë‚ ì§œê°€ ë¹„ì–´ìˆìŒ`);
                    continue;
                }
                
                console.log(`ì°¨ìˆ˜ ${tripNum} ì²˜ë¦¬: ë‚ ì§œ=${date}, ê¸°ë‘¥=${tripData.columns.length}ê°œ`);
                
                for (let col of tripData.columns) {
                    let colId;
                    if (typeof col === 'number') {
                        // ìˆ«ìë§Œ ìˆëŠ” ê²½ìš° ê¸°ë³¸ ì„œë¸Œ í•­ëª©(001)ìœ¼ë¡œ ë³€í™˜
                        colId = getColumnId(col, 1);
                    } else if (typeof col === 'string') {
                        // ì´ë¯¸ colId í˜•ì‹("1C001", "7TC001")ì¸ì§€ í™•ì¸
                        if (col.match(/^\d+(?:TC|C)\d+$/i)) {
                            colId = col;
                        } else if (col.endsWith('C') || col.endsWith('TC')) {
                            // "1C", "7TC" í˜•ì‹ì¸ ê²½ìš° ê¸°ë³¸ ì„œë¸Œ í•­ëª©(001)ìœ¼ë¡œ ë³€í™˜
                            const colNum = parseInt(col.replace(/[^0-9]/g, ''));
                            if (colNum) {
                                colId = getColumnId(colNum, 1);
                        } else {
                                colId = col;
                        }
                    } else {
                            // ìˆ«ì ë¬¸ìì—´ì¸ ê²½ìš° ê¸°ë³¸ ì„œë¸Œ í•­ëª©(001)ìœ¼ë¡œ ë³€í™˜
                            const colNum = parseInt(col.replace(/[^0-9]/g, ''));
                            if (colNum) {
                                colId = getColumnId(colNum, 1);
                            } else {
                                colId = col;
                            }
                        }
                    } else {
                        // ê¸°íƒ€ í˜•ì‹
                        const colNum = parseInt(String(col).replace(/[^0-9]/g, ''));
                        if (colNum) {
                            colId = getColumnId(colNum, 1);
                        } else {
                            colId = String(col);
                        }
                    }
                    
                    const currentStatus = columnData[colId]?.status || 0;
                    if (currentStatus < 5) {
                        columnsToUpdate.push({ colId, date, tripNum });
                    }
                }
            }
            
            // í˜„ì¥ë°°ì†¡ ìƒíƒœë¡œ ë³€ê²½ë  ê¸°ë‘¥ì´ ìˆê³  í™•ì¸ì´ í•„ìš”í•˜ë©´ í™•ì¸ ë©”ì‹œì§€ í‘œì‹œ
            if (needConfirm && columnsToUpdate.length > 0) {
                const columnList = columnsToUpdate.map(c => c.colId).join(', ');
                const message = `ë‹¤ìŒ ê¸°ë‘¥ë“¤ì„ í˜„ì¥ë°°ì†¡ ìƒíƒœë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nê¸°ë‘¥: ${columnList}\n\nâ€» ìš´ì†¡ì°¨ìˆ˜ê³„íšì—ì„œ ë°›ì€ ë°ì´í„°ë¡œ ì‹¤ì œ ìš´ì†¡ì´ ì•„ë‹Œ ë°°ì†¡ ê³„íšì…ë‹ˆë‹¤.`;
                if (!confirm(message)) {
                    return false; // ì‚¬ìš©ìê°€ ì·¨ì†Œí•˜ë©´ ë™ê¸°í™”í•˜ì§€ ì•ŠìŒ
                }
            }
            
            // 1ë‹¨ê³„: ê¸°ì¡´ dailyData[date][5]ì—ì„œ ëª¨ë“  ê¸°ë‘¥ ì œê±° (ìš´ì†¡ì°¨ìˆ˜ê³„íšì— ì—†ëŠ” ê¸°ë‘¥ ì œê±°ë¥¼ ìœ„í•´)
            for (let date in dailyData) {
                if (dailyData[date] && dailyData[date][5]) {
                    dailyData[date][5] = [];
                }
            }
            
            // 2ë‹¨ê³„: transportPlanì˜ ê° ì°¨ìˆ˜ë¥¼ dailyDataì— ë™ê¸°í™” (13ì°¨ê¹Œì§€, ë™ì¼í•œ ì¼ì •ìœ¼ë¡œ ë³µì‚¬)
            for (let tripNum in transportPlan) {
                const tripNumInt = parseInt(tripNum);
                // 14ì°¨ ì´ìƒì€ ì œì™¸ (ì¡°ì •ëœ ì°¨ìˆ˜ê³„íšì€ 13ì°¨ê¹Œì§€)
                if (tripNumInt > 13) {
                    console.log(`âš ï¸ ì°¨ìˆ˜ ${tripNum}ëŠ” 13ì°¨ë¥¼ ì´ˆê³¼í•˜ë¯€ë¡œ ì œì™¸ë©ë‹ˆë‹¤.`);
                    continue;
                }
                
                const tripData = transportPlan[tripNum];
                if (!tripData || !tripData.date || !tripData.columns || tripData.columns.length === 0) {
                    continue;
                }
                
                const date = tripData.date.trim();
                if (!date) {
                    continue; // ë‚ ì§œê°€ ì—†ìœ¼ë©´ ìŠ¤í‚µ
                }
                
                const columns = tripData.columns;
                console.log(`ì°¨ìˆ˜ ${tripNum} ë™ê¸°í™”: ë‚ ì§œ=${date}, ê¸°ë‘¥=${columns.length}ê°œ`);
                
                // dailyData ì´ˆê¸°í™”
                if (!dailyData[date]) {
                    dailyData[date] = {};
                }
                // í•´ë‹¹ ë‚ ì§œì˜ í˜„ì¥ë°°ì†¡(process 5) ë°°ì—´ ì´ˆê¸°í™”
                dailyData[date][5] = [];
                
                // ê¸°ë‘¥ ë²ˆí˜¸ë¥¼ colId í˜•ì‹("1C001", "7TC001")ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ì¶”ê°€ (ë™ì¼í•œ ì¼ì •ìœ¼ë¡œ ë³µì‚¬)
                for (let col of columns) {
                    // ê¸°ë‘¥ ë²ˆí˜¸ í˜•ì‹ ì •ê·œí™”: ìˆ«ì, "1C001", "7TC001", "1C" ë“± ëª¨ë“  í˜•ì‹ ì§€ì›
                    let colId;
                    if (typeof col === 'number') {
                        // ìˆ«ìë§Œ ìˆëŠ” ê²½ìš° ê¸°ë³¸ ì„œë¸Œ í•­ëª©(001)ìœ¼ë¡œ ë³€í™˜
                        colId = getColumnId(col, 1);
                    } else if (typeof col === 'string') {
                        // ì´ë¯¸ colId í˜•ì‹("1C001", "7TC001")ì¸ì§€ í™•ì¸
                        if (col.match(/^\d+(?:TC|C)\d+$/i)) {
                            colId = col;
                        } else if (col.endsWith('C') || col.endsWith('TC')) {
                            // "1C", "7TC" í˜•ì‹ì¸ ê²½ìš° ê¸°ë³¸ ì„œë¸Œ í•­ëª©(001)ìœ¼ë¡œ ë³€í™˜
                            const colNum = parseInt(col.replace(/[^0-9]/g, ''));
                            if (colNum) {
                                colId = getColumnId(colNum, 1);
                        } else {
                                colId = col;
                        }
                    } else {
                            // ìˆ«ì ë¬¸ìì—´ì¸ ê²½ìš° ê¸°ë³¸ ì„œë¸Œ í•­ëª©(001)ìœ¼ë¡œ ë³€í™˜
                            const colNum = parseInt(col.replace(/[^0-9]/g, ''));
                            if (colNum) {
                                colId = getColumnId(colNum, 1);
                            } else {
                                colId = col;
                            }
                        }
                    } else {
                        // ê¸°íƒ€ í˜•ì‹
                        const colNum = parseInt(String(col).replace(/[^0-9]/g, ''));
                        if (colNum) {
                            colId = getColumnId(colNum, 1);
                        } else {
                            colId = String(col);
                        }
                    }
                    
                    // ì¤‘ë³µ ë°©ì§€: ì´ë¯¸ ì¶”ê°€ë˜ì§€ ì•Šì€ ê²½ìš°ë§Œ ì¶”ê°€
                    if (!dailyData[date][5].includes(colId)) {
                        dailyData[date][5].push(colId);
                        console.log(`  ê¸°ë‘¥ ${colId} ì¶”ê°€ë¨`);
                    }
                }
                
                console.log(`ë‚ ì§œ ${date}ì— ${dailyData[date][5].length}ê°œ ê¸°ë‘¥ ì €ì¥ë¨:`, dailyData[date][5]);
                
                // 3ë‹¨ê³„: columnDataì˜ statusì™€ lastUpdate ì—…ë°ì´íŠ¸
                for (let col of columns) {
                    // ê¸°ë‘¥ ë²ˆí˜¸ í˜•ì‹ ì •ê·œí™”
                    let colId;
                    if (typeof col === 'number') {
                        colId = col + 'C';
                    } else if (typeof col === 'string') {
                        if (col.endsWith('C')) {
                            colId = col;
                        } else {
                            colId = col + 'C';
                        }
                    } else {
                        colId = String(col) + 'C';
                    }
                    
                    if (!columnData[colId]) {
                        columnData[colId] = { status: 0, lastUpdate: '' };
                    }
                    
                    // í˜„ì¥ë°°ì†¡(5)ì€ ìš´ì†¡ì°¨ìˆ˜ê³„íšì—ì„œ ë°›ì€ ë°ì´í„°ë¡œ ì‹¤ì œ ìš´ì†¡ì´ ì•„ë‹˜
                    // ë”°ë¼ì„œ columnData.statusë¥¼ 5ë¡œ ì—…ë°ì´íŠ¸í•˜ì§€ ì•ŠìŒ
                    // (ì¼ì¼ì…ë ¥ì°½ì˜ ê³µì • 1-4ì—ì„œ "ë°°ì†¡ì™„ë£Œ"ë¡œ í‘œì‹œë˜ì§€ ì•Šë„ë¡)
                    // dailyData[date][5]ì—ë§Œ ì €ì¥í•˜ì—¬ í˜„ì¥ì„¤ì¹˜(process 6)ì—ì„œ í™•ì¸ ê°€ëŠ¥í•˜ë„ë¡ í•¨
                    
                    // lastUpdateë„ ì—…ë°ì´íŠ¸í•˜ì§€ ì•ŠìŒ (ì‹¤ì œ ì™„ë£Œëœ ê³µì •ì˜ ë‚ ì§œë§Œ ìœ ì§€)
                }
            }
            
            // 4ë‹¨ê³„: ë¹ˆ ë°°ì—´ ì •ë¦¬
            for (let date in dailyData) {
                if (dailyData[date] && dailyData[date][5] && dailyData[date][5].length === 0) {
                    delete dailyData[date][5];
                }
                if (dailyData[date] && Object.keys(dailyData[date]).length === 0) {
                    delete dailyData[date];
                }
            }
            
            // 5ë‹¨ê³„: ì €ì¥
            saveToStorage();
            return true;
        }
        
        function saveTransportPlan() {
            // ê¶Œí•œ ì²´í¬: ìš´ì†¡ì°¨ìˆ˜ê³„íšì€ Adminë§Œ ì‚¬ìš© ê°€ëŠ¥
            if (userRole !== 'admin') {
                alert('âš ï¸ ê¶Œí•œ ì—†ìŒ\n\nìš´ì†¡ì°¨ìˆ˜ê³„íšì€ ê´€ë¦¬ì(Admin)ë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }
            
            localStorage.setItem(kcolKey('transportPlan'), JSON.stringify(transportPlan));
            
            // ìš´ì†¡ì°¨ìˆ˜ê³„íšì„ dailyDataì˜ í˜„ì¥ë°°ì†¡(process 5)ì— ë™ê¸°í™” (í™•ì¸ ì—†ì´ ìë™ ë™ê¸°í™”)
            const syncResult = syncTransportToDailyData(false);
            
            // ë””ë²„ê¹…: ë™ê¸°í™” ê²°ê³¼ í™•ì¸
            console.log('ìš´ì†¡ì°¨ìˆ˜ê³„íš ë™ê¸°í™” ê²°ê³¼:', syncResult);
            console.log('transportPlan:', transportPlan);
            
            // dailyData í™•ì¸
            let totalColumnsInDailyData = 0;
            for (let date in dailyData) {
                if (dailyData[date] && dailyData[date][5]) {
                    totalColumnsInDailyData += dailyData[date][5].length;
                    console.log(`ë‚ ì§œ ${date}: ${dailyData[date][5].length}ê°œ ê¸°ë‘¥`, dailyData[date][5]);
                }
            }
            console.log('dailyData ì´ ê¸°ë‘¥ ìˆ˜:', totalColumnsInDailyData);
            
            alert('âœ… ìš´ì†¡ì°¨ìˆ˜ê³„íšì´ ë¡œì»¬ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (í˜„ì¥ë°°ì†¡ ë°ì´í„° ìë™ ë™ê¸°í™” ì™„ë£Œ)');
            // í™”ë©´ ì—…ë°ì´íŠ¸
            renderGanttChart();
            renderColumnGrid('column-grid-overview');
            renderColumnGrid('column-grid-input');
            updateProgressBars();
            // ìš´ì†¡ë¬¼ëŸ‰ì‚°ì • í‘œì˜ ìš´ì†¡ì°¨ìˆ˜ê³„íš(13ì°¨) ì—´ë„ transportPlanì—ì„œ ìë™ ë°˜ì˜
            if (typeof renderTransportVolumeTable === 'function') {
                renderTransportVolumeTable();
            }
        }

        // ê³µì •í‘œ ê°•ì œ ë™ê¸°í™”
        function forceSyncToGantt() {
            console.log('ê³µì •í‘œ ê°•ì œ ë™ê¸°í™” ì‹œì‘');
            console.log('í˜„ì¬ transportPlan:', transportPlan);
            
            // transportPlan í™•ì¸
            let totalColumns = 0;
            for (let tripNum in transportPlan) {
                const tripData = transportPlan[tripNum];
                if (tripData && tripData.columns && tripData.date) {
                    totalColumns += tripData.columns.length;
                    console.log(`ì°¨ìˆ˜ ${tripNum}: ë‚ ì§œ=${tripData.date}, ê¸°ë‘¥=${tripData.columns.length}ê°œ`);
                }
            }
            console.log(`ì´ ${totalColumns}ê°œ ê¸°ë‘¥ì´ transportPlanì— ìˆìŒ`);
            
            // ë™ê¸°í™” ì‹¤í–‰
            const syncResult = syncTransportToDailyData(false);
            console.log('ë™ê¸°í™” ê²°ê³¼:', syncResult);
            
            // dailyData í™•ì¸
            let process5Count = 0;
            for (let date in dailyData) {
                if (dailyData[date] && dailyData[date][5]) {
                    process5Count += dailyData[date][5].length;
                    console.log(`ë‚ ì§œ ${date}: ${dailyData[date][5].length}ê°œ ê¸°ë‘¥`, dailyData[date][5]);
                }
            }
            console.log(`dailyDataì— ì´ ${process5Count}ê°œ ê¸°ë‘¥ì´ process 5ë¡œ ì €ì¥ë¨`);
            
            // ê³µì •í‘œ ë‹¤ì‹œ ë Œë”ë§
            renderGanttChart();
            
            alert(`âœ… ë™ê¸°í™” ì™„ë£Œ!\n\n- transportPlan: ${totalColumns}ê°œ ê¸°ë‘¥\n- dailyData process 5: ${process5Count}ê°œ ê¸°ë‘¥\n\nê³µì •í‘œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.`);
        }

        // ì„ íƒ ì´ˆê¸°í™”
        function clearTransportSelection() {
            if (confirm(`í˜„ì¬ ì„ íƒëœ ${currentTransportTrip}ì°¨ìˆ˜ì˜ ëª¨ë“  ê¸°ë‘¥ ì„ íƒì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                if (!transportPlan[currentTransportTrip]) {
                    transportPlan[currentTransportTrip] = { columns: [], date: '' };
                }
                transportPlan[currentTransportTrip].columns = [];
                renderTransportColumnGrid();
                renderTransportTrips();
                updateTransportTripInfo();
                saveTransportPlan();
            }
        }
        
        // ì „ì²´ ë°ì´í„° ì´ˆê¸°í™”
        async function resetAllData() {
            // ğŸ”’ [ê°€ë“œ] ê´€ë¦¬ì ê¶Œí•œ ì²´í¬
            if (userRole !== 'admin') {
                console.warn('âš ï¸ [ê°€ë“œ] ì „ì²´ ì´ˆê¸°í™”ëŠ” ê´€ë¦¬ì(Admin)ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                alert('âš ï¸ ê¶Œí•œ ì—†ìŒ\n\nì „ì²´ ì´ˆê¸°í™”ëŠ” ê´€ë¦¬ì(Admin)ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\ní˜„ì¬ ì—­í• : ' + (userRole || 'ë¡œê·¸ì¸ ì•ˆ ë¨'));
                return;
            }
            
            if (!confirm('âš ï¸ ì „ì²´ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ˆê¸°í™”í•  ë°ì´í„°:\n- ëª¨ë“  ê¸°ë‘¥ì˜ ê³µì • ìƒíƒœ\n- ëª¨ë“  ì¼ì¼ ì…ë ¥ ë°ì´í„°\n- ìš´ì†¡ì°¨ìˆ˜ê³„íš\n- í˜„ì¥ë°°ì†¡ ë°ì´í„°\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                return;
            }
            
            // ì¶”ê°€ í™•ì¸
            if (!confirm('ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nëª¨ë“  ê³µì • ì§„í–‰ ìƒí™©ì´ ì‚­ì œë©ë‹ˆë‹¤.')) {
                return;
            }
            
            // ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”
            columnData = {};
            dailyData = {};
            transportPlan = {};
            deliveryConfirmed = {}; // í˜„ì¥ë°°ì†¡ í™•ì¸ ë°ì´í„° ì´ˆê¸°í™”
            actualDeliveryDate = {}; // ì‹¤ì œ ë°°ì†¡ ë‚ ì§œ ë°ì´í„° ì´ˆê¸°í™”
            // columnCoordinatesëŠ” ìœ ì§€ (í˜„ì¥ì„¤ì¹˜í˜„í™©ë„ ì¢Œí‘œê°’ ë³´ì¡´)
            
            // ì´ˆê¸° ìƒíƒœë¡œ columnData ì„¤ì • (ëª¨ë“  ê¸°ë‘¥ì„ ë¯¸ì°©ìˆ˜ ìƒíƒœë¡œ)
            for (let i = 1; i <= TOTAL_COLUMNS; i++) {
                const colId = i + 'C';
                columnData[colId] = {
                    status: 0,
                    lastUpdate: '',
                    note: '',
                    updatedBy: ''
                };
            }
            
            // ìš´ì†¡ì°¨ìˆ˜ê³„íš ì´ˆê¸°í™” (1ì°¨ìˆ˜ë§Œ ë‚¨ê¸°ê³  ë¹ˆ ìƒíƒœë¡œ)
            transportPlan = {
                1: { columns: [], date: '' }
            };
            currentTransportTrip = 1;
            
            console.log('ğŸ”„ ì „ì²´ ë°ì´í„° ì´ˆê¸°í™” ì™„ë£Œ');
            console.log('ğŸ“Š ì´ˆê¸°í™”ëœ ë°ì´í„°:', {
                columnData: Object.keys(columnData).length + 'ê°œ ê¸°ë‘¥',
                dailyData: Object.keys(dailyData).length + 'ê°œ ë‚ ì§œ',
                transportPlan: Object.keys(transportPlan).length + 'ê°œ ì°¨ìˆ˜'
            });
            
            // ì €ì¥ (Firestoreì™€ localStorage ëª¨ë‘)
            try {
                await saveToStorage();
                console.log('âœ… ë°ì´í„° ì €ì¥ ì™„ë£Œ (Firestore + localStorage)');
            } catch (error) {
                console.error('âŒ ì €ì¥ ì˜¤ë¥˜:', error);
                alert('âš ï¸ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
            
            // ìš´ì†¡ì°¨ìˆ˜ê³„íšë„ ì €ì¥
            localStorage.setItem(kcolKey('transportPlan'), JSON.stringify(transportPlan));
            
            alert('âœ… ì „ì²´ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nì´ˆê¸°í™”ëœ ë°ì´í„°:\n- ëª¨ë“  ê¸°ë‘¥ì˜ ê³µì • ìƒíƒœ\n- ëª¨ë“  ì¼ì¼ ì…ë ¥ ë°ì´í„°\n- ìš´ì†¡ì°¨ìˆ˜ê³„íš\n- í˜„ì¥ë°°ì†¡ ë°ì´í„°\n\në°ì´í„°ê°€ Firestoreì™€ localStorageì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            
            // í™”ë©´ ì—…ë°ì´íŠ¸
            renderColumnGrid('column-grid-overview');
            renderColumnGrid('column-grid-input');
            renderGanttChart();
            updateProgressBars();
            renderTransportTrips();
            renderTransportColumnGrid();
            updateTransportTripInfo();
        }

        // Close modal on outside click
        document.getElementById('column-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // ì „ì—­ í•¨ìˆ˜ ìµœì¢… í™•ì¸ ë° ë…¸ì¶œ (ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ í›„)
        // í•¨ìˆ˜ê°€ ì •ì˜ë˜ì–´ ìˆìœ¼ë©´ ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ
        try {
            if (typeof setCurrentUID !== 'undefined') {
                window.setCurrentUID = setCurrentUID;
            }
            if (typeof getCurrentUID !== 'undefined') {
                window.getCurrentUID = getCurrentUID;
            }
            if (typeof setUserRole !== 'undefined') {
                window.setUserRole = setUserRole;
            }
        } catch (e) {
            console.error('ì „ì—­ í•¨ìˆ˜ ë…¸ì¶œ ì˜¤ë¥˜:', e);
        }
        
        // ì½˜ì†”ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ í•¨ìˆ˜ ëª©ë¡ í‘œì‹œ
        setTimeout(() => {
            console.log('ğŸ”§ ì‚¬ìš© ê°€ëŠ¥í•œ í•¨ìˆ˜:', {
                'setCurrentUID': typeof window.setCurrentUID,
                'getCurrentUID': typeof window.getCurrentUID,
                'setUserRole': typeof window.setUserRole
            });
            
            // ì—­í•  ì„¤ì • ì•ˆë‚´
            const currentUID = typeof window.getCurrentUID === 'function' ? window.getCurrentUID() : 'í™•ì¸ ë¶ˆê°€';
            console.log('ğŸ‘¤ í˜„ì¬ ì‚¬ìš©ì UID:', currentUID);
            console.log('ğŸ’¡ ì—­í• ì€ Firestore members ë¬¸ì„œì—ì„œë§Œ ê²°ì •ë©ë‹ˆë‹¤.');
            console.log('   ê²½ë¡œ: projects/' + window.PROJECT_ID + '/members/' + currentUID);
        }, 100);

    </script>

    <!-- Process Selection Modal -->
    <div id="process-selection-modal" class="process-selection-modal">
        <div class="process-selection-content">
            <h3>âš ï¸ ì‚­ì œí•  ê³µì • ì„ íƒ</h3>
            <p id="process-selection-message"></p>
            <div class="process-selection-buttons">
                <button class="process-select-btn p1" onclick="selectProcessForDelete(1)">
                    1. ì£¼ê¸°ë‘¥ì»¤íŒ… ì‚­ì œ
                </button>
                <button class="process-select-btn p2" onclick="selectProcessForDelete(2)">
                    2. ì†Œë¶€ì¬ì»¤íŒ… ì‚­ì œ
                </button>
                <button class="process-select-btn cancel" onclick="cancelProcessSelection()">
                    ì·¨ì†Œ
                </button>
            </div>
        </div>
    </div>
    
    <!-- Initialize process selection modal after DOM is loaded -->
    <script>
        // Close process selection modal on outside click
        // This runs after the modal element is in the DOM
        const processModal = document.getElementById('process-selection-modal');
        if (processModal) {
            processModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    cancelProcessSelection();
                }
            });
        }
    </script>
    
    <!-- ì „ì—­ í•¨ìˆ˜ ëª…ì‹œì  ë…¸ì¶œ (ì½˜ì†”ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•˜ë„ë¡) -->
    <script>
        // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ ì „ì—­ í•¨ìˆ˜ ë…¸ì¶œ í™•ì¸
        (function() {
            // í•¨ìˆ˜ê°€ ì •ì˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ
            const scriptTag = document.currentScript || document.scripts[document.scripts.length - 1];
            const parentScript = scriptTag.previousElementSibling;
            
            // ì´ì „ ìŠ¤í¬ë¦½íŠ¸ íƒœê·¸ì—ì„œ í•¨ìˆ˜ë¥¼ ì°¾ì•„ì„œ ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ
            // âš ï¸ UID ê¸°ë°˜ Admin íŒë³„ í•¨ìˆ˜ë“¤ì€ ì œê±°ë¨ - Firestoreê°€ ë‹¨ì¼ ì§„ì‹¤ ì†ŒìŠ¤
            if (typeof setCurrentUID === 'function') {
                window.setCurrentUID = setCurrentUID;
            }
            if (typeof getCurrentUID === 'function') {
                window.getCurrentUID = getCurrentUID;
            }
            if (typeof setUserRole === 'function') {
                window.setUserRole = setUserRole;
            }
            
            // ì§ì ‘ í•¨ìˆ˜ ì •ì˜ (ë°±ì—…, role ë³€ê²½ ì•ˆ í•¨)
            if (!window.setCurrentUID) {
                window.setCurrentUID = function(uid) {
                    if (!uid) {
                        console.error('âŒ UIDë¥¼ ì œê³µí•´ì£¼ì„¸ìš”.');
                        console.log('ì‚¬ìš©ë²•: setCurrentUID("your-uid-here")');
                        return;
                    }
                    localStorage.setItem('kcol:currentUid', uid);
                    console.log(`âœ… í˜„ì¬ ì‚¬ìš©ì UID ì„¤ì • ì™„ë£Œ: ${uid}`);
                    console.log('âš ï¸ ì°¸ê³ : roleì€ Firestore members ë¬¸ì„œì—ì„œë§Œ ê²°ì •ë©ë‹ˆë‹¤.');
                    console.log('   roleì„ ë³€ê²½í•˜ë ¤ë©´ Firestoreì—ì„œ members ë¬¸ì„œë¥¼ ìˆ˜ì •í•˜ì„¸ìš”.');
                };
            }
            
            if (!window.getCurrentUID) {
                window.getCurrentUID = function() {
                    let uid = localStorage.getItem('kcol:currentUid');
                    if (!uid) {
                        uid = 'uid_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                        localStorage.setItem('kcol:currentUid', uid);
                    }
                    return uid;
                };
            }
            
            console.log('âœ… ì „ì—­ í•¨ìˆ˜ ë…¸ì¶œ ì™„ë£Œ');
            console.log('ğŸ’¡ ì—­í• ì€ Firestore members ë¬¸ì„œì—ì„œë§Œ ê²°ì •ë©ë‹ˆë‹¤.');
            console.log('   ê²½ë¡œ: projects/' + window.PROJECT_ID + '/members/{uid}');
        })();
    </script>
    
    <!-- Firebase Configuration -->
    <script src="../../js/firebase-config.js"></script>
    
    <script src="../../js/auth-config.js"></script>
    <script src="../../js/auth.js"></script>
    <script src="../../js/auth-guard.js"></script>
    
    <script>
        // ============================================================
        // âœ… STEP 1: ê³µì •í‘œ íƒ­ ì ê·¸ê¸° í•¨ìˆ˜
        // ============================================================
        function lockScheduleTabs(message) {
            const msg = message || "âš ï¸ ê³µì •í‘œ ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.\nê´€ë¦¬ìê°€ ì‚¬ì „ë“±ë¡í•´ì•¼ í•©ë‹ˆë‹¤.";

            const selectors = [
                ".process-btn",                // ê³µì • 1~6 ë²„íŠ¼
                "[onclick*=\"selectProcess\"]",
                "[onclick*=\"selectPreocess\"]", // selectPreocessë„ í¬í•¨
                "[onclick*=\"showPanel('input'\"]",
                "[onclick*=\"showPanel('gantt'\"]"
            ];

            document.querySelectorAll(selectors.join(",")).forEach(el => {
                if (el.tagName === "BUTTON") el.disabled = true;

                el.style.opacity = "0.4";
                el.style.cursor = "not-allowed";

                el.onclick = (e) => {
                    e.preventDefault();
                    alert(msg);
                    return false;
                };
            });

            console.warn("[LOCK] ê³µì •í‘œ íƒ­ ì ê¸ˆ ìƒíƒœ");
        }
    </script>
    
</body>
</html>
