<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Composite Beam Design ( H형강 )</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .calculator-wrapper {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3a5f, #2d5a87);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .header a {
            color: rgba(255,255,255,0.9);
            text-decoration: none;
            font-size: 14px;
            padding: 8px 16px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            transition: all 0.2s;
        }

        .header a:hover {
            background: rgba(255,255,255,0.1);
        }

        .main-content {
            display: grid;
            grid-template-columns: 450px 1fr;
            gap: 0;
        }

        .left-section {
            background: #f8fafc;
            padding: 25px;
            border-right: 1px solid #e2e8f0;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px 20px;
            align-content: start;
        }

        .section-title {
            font-size: 16px;
            font-weight: 700;
            color: #1e3a5f;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #3b82f6;
            grid-column: 1 / -1;
        }

        .input-group {
            margin-bottom: 0;
        }

        .input-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #475569;
            margin-bottom: 6px;
        }

        .input-unit {
            color: #94a3b8;
            font-weight: 400;
            font-size: 11px;
        }

        .input-field {
            width: 100%;
            padding: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .info-box {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 12px;
            color: #1e40af;
        }

        .calc-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
            margin-top: 20px;
            grid-column: 1 / -1;
        }

        .calc-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
        }

        .right-section {
            padding: 25px;
            background: white;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }

        .results-container {
            display: none;
        }

        .results-container.active {
            display: block;
        }

        .result-section {
            margin-bottom: 25px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
        }

        .result-section-title {
            font-size: 18px;
            font-weight: 700;
            color: #1e3a5f;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3b82f6;
        }

        .result-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .result-table th {
            background: #1e3a5f;
            color: white;
            padding: 10px;
            text-align: left;
            font-weight: 600;
        }

        .result-table td {
            padding: 10px;
            border-bottom: 1px solid #e2e8f0;
        }

        .result-table tr:hover {
            background: #f1f5f9;
        }

        .result-value {
            font-weight: 600;
            color: #1e3a5f;
            text-align: right;
        }

        .status-ok {
            color: #10b981;
            font-weight: 700;
        }

        .status-ng {
            color: #ef4444;
            font-weight: 700;
        }

        .warning-box {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            border-radius: 6px;
            padding: 12px;
            margin-top: 15px;
            font-size: 12px;
            color: #92400e;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .left-section {
                border-right: none;
                border-bottom: 1px solid #e2e8f0;
            }
        }
    </style>
</head>
<body>
    <div class="calculator-wrapper">
        <div class="header">
            <h1>Composite Beam Design ( H형강 )</h1>
            <a href="/index.html">← 홈으로</a>
        </div>

        <div class="main-content">
            <!-- Left: Input Section -->
            <div class="left-section">
                <!-- Beam Information -->
                <div class="section-title">보 정보</div>
                
                <!-- Beam Diagram -->
                <div class="input-group" style="grid-column: 1 / -1; margin-bottom: 20px;">
                    <div style="background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; padding: 20px; text-align: center;">
                        <div style="font-size: 12px; font-weight: 600; color: #1e3a5f; margin-bottom: 15px;">보 구조도</div>
                        <div style="position: relative; width: 100%; height: 150px; margin: 10px 0;">
                            <!-- H-beam cross section representation (1:2 ratio) - placed at top -->
                            <div style="position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 40px; height: 80px;">
                                <svg width="40" height="80" viewBox="0 0 40 80" style="border: 1px solid #cbd5e1; background: #ffffff; border-radius: 2px;">
                                    <!-- H-beam shape (vertical orientation for 1:2 ratio) -->
                                    <!-- Top flange -->
                                    <rect x="8" y="5" width="24" height="6" fill="#3b82f6" stroke="#1e40af" stroke-width="0.5"/>
                                    <!-- Bottom flange -->
                                    <rect x="8" y="69" width="24" height="6" fill="#3b82f6" stroke="#1e40af" stroke-width="0.5"/>
                                    <!-- Web (vertical) -->
                                    <rect x="17" y="11" width="6" height="58" fill="#3b82f6" stroke="#1e40af" stroke-width="0.5"/>
                                </svg>
                            </div>
                            
                            <!-- Selected section label - placed to the right of H-beam SVG -->
                            <div id="beamSectionLabel" style="position: absolute; top: 35px; left: calc(50% + 25px); font-size: 10px; font-weight: 600; color: #1e3a5f; white-space: nowrap; text-align: left;">
                                직접 입력
                            </div>
                            
                            <!-- Pin Support Left -->
                            <div style="position: absolute; left: 0; bottom: 0; width: 30px; height: 30px;">
                                <svg width="30" height="30" viewBox="0 0 30 30" style="position: absolute; bottom: 0;">
                                    <!-- Triangle for pin support -->
                                    <polygon points="15,0 0,20 30,20" fill="#3b82f6" stroke="#1e40af" stroke-width="2"/>
                                    <circle cx="15" cy="20" r="3" fill="#1e40af"/>
                                </svg>
                            </div>
                            
                            <!-- Beam span line - aligned with pin support triangle edges -->
                            <div style="position: absolute; left: 25px; right: 30px; bottom: 25px; height: 4px;">
                                <div style="height: 4px; background: linear-gradient(90deg, #1e3a5f 0%, #3b82f6 50%, #1e3a5f 100%); border-radius: 2px; position: relative; width: 100%;">
                                    <!-- Span length label -->
                                    <div id="beamSpanLabel" style="position: absolute; top: -25px; left: 50%; transform: translateX(-50%); font-size: 11px; font-weight: 600; color: #1e3a5f; white-space: nowrap;">
                                        L = <span id="beamSpanValue">13.5</span> m
                                    </div>
                                    <!-- Dimension arrows -->
                                    <div style="position: absolute; top: -20px; left: 0; width: 100%;">
                                        <svg width="100%" height="20" style="position: absolute; top: 0;">
                                            <line x1="0%" y1="15" x2="0%" y2="5" stroke="#64748b" stroke-width="1.5" marker-end="url(#arrowhead)"/>
                                            <line x1="100%" y1="15" x2="100%" y2="5" stroke="#64748b" stroke-width="1.5" marker-end="url(#arrowhead)"/>
                                            <line x1="0%" y1="10" x2="100%" y2="10" stroke="#64748b" stroke-width="1" stroke-dasharray="2,2"/>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Pin Support Right -->
                            <div style="position: absolute; right: 25px; bottom: 0; width: 30px; height: 30px;">
                                <svg width="30" height="30" viewBox="0 0 30 30" style="position: absolute; bottom: 0;">
                                    <!-- Triangle for pin support -->
                                    <polygon points="15,0 0,20 30,20" fill="#3b82f6" stroke="#1e40af" stroke-width="2"/>
                                    <circle cx="15" cy="20" r="3" fill="#1e40af"/>
                                </svg>
                            </div>
                            
                            <!-- Arrow markers definition -->
                            <svg width="0" height="0" style="position: absolute;">
                                <defs>
                                    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="5" refY="3" orient="auto">
                                        <polygon points="0 0, 10 3, 0 6" fill="#64748b"/>
                                    </marker>
                                </defs>
                            </svg>
                        </div>
                        <div style="font-size: 10px; color: #64748b; margin-top: 10px;">
                            양쪽 끝: Pin 지지 (회전 자유, 수평 이동 자유, 수직 이동 구속)
                        </div>
                    </div>
                </div>
                
                <div class="input-group">
                    <label class="input-label">보 스팬 (L) <span class="input-unit">m</span></label>
                    <input type="number" id="beamSpan" class="input-field" value="13.5" step="0.1" min="1" max="50">
                </div>
                <div class="input-group">
                    <label class="input-label">하중 폭 (B) <span class="input-unit">m</span></label>
                    <input type="number" id="loadWidth" class="input-field" value="3" step="0.1" min="0.5" max="20">
                    <div style="font-size: 11px; color: #94a3b8; margin-top: 4px;">※ 하중이 작용하는 폭 (Tributary Width)</div>
                </div>

                <!-- Loading Conditions -->
                <div class="section-title">하중 조건</div>
                <div class="input-group">
                    <label class="input-label">Live Load (wL) <span class="input-unit">kN/m²</span></label>
                    <input type="number" id="liveLoad" class="input-field" value="3.5" step="0.1" min="0">
                </div>
                <div class="input-group">
                    <label class="input-label">Super Imposed Dead Load (wD) <span class="input-unit">kN/m²</span></label>
                    <input type="number" id="deadLoad" class="input-field" value="0.8" step="0.1" min="0">
                    <div style="font-size: 11px; color: #94a3b8; margin-top: 4px;">※ 슬래브자중제외, 철골보자중제외</div>
                </div>
                <div class="input-group">
                    <label class="input-label">철골보 단중을 하중폭으로 나눈값 (자동계산) <span class="input-unit">kN/m²</span></label>
                    <input type="text" id="selfWeight" class="input-field" readonly style="background: #f1f5f9;">
                </div>
                <div class="input-group">
                    <label class="input-label">시공하중 <span class="input-unit">kN/m²</span></label>
                    <input type="number" id="constructionLoad" class="input-field" value="1.2" step="0.1" min="0">
                </div>
                <div class="input-group">
                    <label class="input-label">슬래브 자중 (자동계산) <span class="input-unit">kN/m²</span></label>
                    <input type="text" id="slabWeight" class="input-field" readonly style="background: #f1f5f9;">
                </div>

                <!-- Steel Section Properties -->
                <div class="section-title">철골보 단면</div>
                <div class="input-group" style="grid-column: 1 / -1;">
                    <label class="input-label">KS 단면 선택</label>
                    <select id="ksSection" class="input-field" style="height: 40px;">
                        <option value="">직접 입력</option>
                    </select>
                    <div style="font-size: 11px; color: #94a3b8; margin-top: 4px;">※ KS 단면 선택 시 아래 값이 자동 입력됩니다</div>
                </div>
                <div class="input-group">
                    <label class="input-label">보 높이 (d) <span class="input-unit">mm</span></label>
                    <input type="number" id="beamDepth" class="input-field" value="500" step="10" min="200" max="2000">
                </div>
                <div class="input-group">
                    <label class="input-label">플랜지 폭 (bf) <span class="input-unit">mm</span></label>
                    <input type="number" id="flangeWidth" class="input-field" value="200" step="5" min="100" max="1000">
                </div>
                <div class="input-group">
                    <label class="input-label">플랜지 두께 (tf) <span class="input-unit">mm</span></label>
                    <input type="number" id="flangeThickness" class="input-field" value="16" step="1" min="6" max="50">
                </div>
                <div class="input-group">
                    <label class="input-label">웹 두께 (tw) <span class="input-unit">mm</span></label>
                    <input type="number" id="webThickness" class="input-field" value="10" step="1" min="4" max="30">
                </div>
                <div class="input-group">
                    <label class="input-label">필렛 반경 (r) <span class="input-unit">mm</span></label>
                    <input type="number" id="filletRadius" class="input-field" value="18" step="1" min="0" max="50">
                    <div style="font-size: 11px; color: #94a3b8; margin-top: 4px;">※ 일반적으로 18mm (KS 표준)</div>
                </div>

                <!-- Composite Section Properties -->
                <div class="section-title">합성보 정보</div>
                <div class="input-group">
                    <label class="input-label">슬래브 두께 (ts) <span class="input-unit">mm</span></label>
                    <input type="number" id="slabThickness" class="input-field" value="135" step="10" min="100" max="500">
                </div>
                <div class="input-group">
                    <label class="input-label">슬래브 유효폭 (beff) <span class="input-unit">m</span></label>
                    <input type="number" id="effectiveWidth" class="input-field" value="3" step="0.1" min="0.5" max="10">
                    <div style="font-size: 11px; color: #94a3b8; margin-top: 4px;">※ AISC I3.1: min(L/4, 보간격, b0+16ts)</div>
                </div>
                <div class="input-group">
                    <label class="input-label">콘크리트 압축강도 (f'c) <span class="input-unit">MPa</span></label>
                    <input type="number" id="concreteStrength" class="input-field" value="24" step="1" min="20" max="50">
                </div>
                <div class="input-group">
                    <label class="input-label">강종 <span class="input-unit">-</span></label>
                    <select id="steelGrade" class="input-field" style="height: 40px;">
                        <option value="SM355">SM355 (Fy = 355 MPa)</option>
                        <option value="SM275" selected>SM275 (Fy = 275 MPa)</option>
                    </select>
                </div>

                <!-- Material Properties -->
                <div class="section-title">재료 특성</div>
                <div class="info-box" id="materialInfoBox" style="grid-column: 1 / -1;">
                    <strong>강종:</strong> SM355 (Fy = 355 MPa)<br>
                    <strong>탄성계수:</strong> Es = 210,000 MPa<br>
                    <strong>단위중량:</strong> γ = 78.5 kN/m³
                </div>

                <!-- Boundary Condition -->
                <div class="info-box" style="grid-column: 1 / -1;">
                    <strong>Boundary Condition:</strong> 양단 Pin (Simply Supported Beam)
                </div>

                <!-- Calculate Button -->
                <button class="calc-btn" onclick="calculateBeam()">계산하기</button>
            </div>

            <!-- Right: Results Section -->
            <div class="right-section">
                <div class="results-container" id="resultsContainer">
                    <!-- Results will be displayed here -->
                </div>
                <div id="noResults" style="text-align: center; padding: 60px 20px; color: #94a3b8;">
                    <p style="font-size: 16px; margin-bottom: 10px;">계산 결과가 여기에 표시됩니다</p>
                    <p style="font-size: 12px;">좌측 입력값을 입력하고 "계산하기" 버튼을 클릭하세요</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Material constants
        const Es = 210000; // MPa
        const gamma = 78.5; // kN/m³
        const nu = 0.3; // Poisson's ratio
        
        // Steel grade yield strength (MPa)
        const steelGrades = {
            'SM355': 355,
            'SM275': 275
        };
        
        // Get current steel grade Fy
        function getFy() {
            const steelGradeSelect = document.getElementById('steelGrade');
            if (steelGradeSelect) {
                return steelGrades[steelGradeSelect.value] || 355;
            }
            return 355; // Default to SM355
        }

        // KS H-beam section database (H×B×tw×tf) - 직사각형 H형강
        // 단중(kg/m) 계산 함수
        function calculateUnitWeight(d, bf, tw, tf) {
            const hw = d - 2 * tf;
            const area = bf * tf * 2 + hw * tw; // mm²
            const unitWeight = (area / 1000000) * 7850; // kg/m (강재 밀도 7850 kg/m³)
            return unitWeight;
        }

        const ksSections = {
            'H150x75x5x7': { d: 150, bf: 75, tw: 5, tf: 7, r: 8 },
            'H198x99x4.5x7': { d: 198, bf: 99, tw: 4.5, tf: 7, r: 8 },
            'H200x100x5.5x8': { d: 200, bf: 100, tw: 5.5, tf: 8, r: 8 },
            'H250x125x6x9': { d: 250, bf: 125, tw: 6, tf: 9, r: 10 },
            'H294x200x8x12': { d: 294, bf: 200, tw: 8, tf: 12, r: 13 },
            'H298x149x6.5x9': { d: 298, bf: 149, tw: 6.5, tf: 9, r: 13 },
            'H300x150x6.5x9': { d: 300, bf: 150, tw: 6.5, tf: 9, r: 13 },
            'H346x174x6x9': { d: 346, bf: 174, tw: 6, tf: 9, r: 13 },
            'H350x175x7x11': { d: 350, bf: 175, tw: 7, tf: 11, r: 13 },
            'H340x250x9x14': { d: 340, bf: 250, tw: 9, tf: 14, r: 13 },
            'H390x300x10x16': { d: 390, bf: 300, tw: 10, tf: 16, r: 18 },
            'H396x199x7x11': { d: 396, bf: 199, tw: 7, tf: 11, r: 13 },
            'H400x200x8x13': { d: 400, bf: 200, tw: 8, tf: 13, r: 13 },
            'H446x199x8x12': { d: 446, bf: 199, tw: 8, tf: 12, r: 13 },
            'H450x200x9x14': { d: 450, bf: 200, tw: 9, tf: 14, r: 18 },
            'H482x300x11x15': { d: 482, bf: 300, tw: 11, tf: 15, r: 18 },
            'H488x300x11x16': { d: 488, bf: 300, tw: 11, tf: 16, r: 18 },
            'H496x199x9x14': { d: 496, bf: 199, tw: 9, tf: 14, r: 18 },
            'H500x200x10x16': { d: 500, bf: 200, tw: 10, tf: 16, r: 18 },
            'H506x201x11x19': { d: 506, bf: 201, tw: 11, tf: 19, r: 18 },
            'H582x300x12x17': { d: 582, bf: 300, tw: 12, tf: 17, r: 18 },
            'H588x300x12x18': { d: 588, bf: 300, tw: 12, tf: 18, r: 18 },
            'H594x302x14x23': { d: 594, bf: 302, tw: 14, tf: 23, r: 22 },
            'H596x199x10x15': { d: 596, bf: 199, tw: 10, tf: 15, r: 18 },
            'H600x200x11x17': { d: 600, bf: 200, tw: 11, tf: 17, r: 18 },
            'H606x201x12x20': { d: 606, bf: 201, tw: 12, tf: 20, r: 18 },
            'H692x300x13x20': { d: 692, bf: 300, tw: 13, tf: 20, r: 22 },
            'H700x300x13x24': { d: 700, bf: 300, tw: 13, tf: 24, r: 22 },
            'H792x300x14x22': { d: 792, bf: 300, tw: 14, tf: 22, r: 22 },
            'H800x300x14x26': { d: 800, bf: 300, tw: 14, tf: 26, r: 22 },
            'H890x299x15x23': { d: 890, bf: 299, tw: 15, tf: 23, r: 22 },
            'H900x300x16x28': { d: 900, bf: 300, tw: 16, tf: 28, r: 22 },
            'H912x302x18x34': { d: 912, bf: 302, tw: 18, tf: 34, r: 22 }
        };

        // 각 단면의 단중 계산 및 저장
        Object.keys(ksSections).forEach(key => {
            const section = ksSections[key];
            section.unitWeight = calculateUnitWeight(section.d, section.bf, section.tw, section.tf);
        });

        // KS 단면 옵션 생성 함수 (별도 함수로 분리)
        function populateKsSectionOptions() {
            try {
                const ksSectionSelect = document.getElementById('ksSection');
                if (!ksSectionSelect) {
                    console.log('[DEBUG] populateKsSectionOptions: ksSection select element not found');
                    return false;
                }
                
                if (typeof ksSections === 'undefined' || !ksSections) {
                    console.error('[ERROR] populateKsSectionOptions: ksSections is not defined, type:', typeof ksSections);
                    return false;
                }
                
                const sectionsCount = Object.keys(ksSections).length;
                console.log('[DEBUG] populateKsSectionOptions: Starting, ksSections count:', sectionsCount);
                
                if (sectionsCount === 0) {
                    console.error('[ERROR] populateKsSectionOptions: ksSections is empty');
                    return false;
                }
                
                // 모든 옵션 제거 후 직접 입력 옵션만 다시 추가
                ksSectionSelect.innerHTML = '<option value="">직접 입력</option>';
                
                // 높이(d) 순으로 정렬
                const sortedKeys = Object.keys(ksSections).sort((a, b) => {
                    const dA = ksSections[a].d;
                    const dB = ksSections[b].d;
                    if (dA !== dB) return dA - dB;
                    // 높이가 같으면 폭(bf) 순으로 정렬
                    return ksSections[a].bf - ksSections[b].bf;
                });
                
                console.log('[DEBUG] populateKsSectionOptions: Sorted', sortedKeys.length, 'keys, first few:', sortedKeys.slice(0, 5));
                
                let optionsCreated = 0;
                sortedKeys.forEach(key => {
                    try {
                        const section = ksSections[key];
                        if (!section) {
                            console.warn('[WARN] Section not found for key:', key);
                            return;
                        }
                        const option = document.createElement('option');
                        option.value = key;
                        
                        // 단면명 추출 (예: "H500x200x10x16" -> "H 500×200")
                        const match = key.match(/H(\d+)x(\d+)/);
                        if (match) {
                            const sectionName = `H ${match[1]}×${match[2]}`;
                            const unitWeight = section.unitWeight || calculateUnitWeight(section.d, section.bf, section.tw, section.tf);
                            option.textContent = `${sectionName} (${unitWeight.toFixed(1)} kg/m)`;
                        } else {
                            option.textContent = key;
                        }
                        
                        // 기본 선택값 설정
                        if (key === 'H500x200x10x16') {
                            option.selected = true;
                        }
                        
                        ksSectionSelect.appendChild(option);
                        optionsCreated++;
                    } catch (e) {
                        console.error('[ERROR] Error creating option for key:', key, e);
                    }
                });
                
                const finalCount = ksSectionSelect.options.length;
                console.log('[DEBUG] populateKsSectionOptions: Created', optionsCreated, 'options, total:', finalCount);
                
                // Verify options were actually added
                if (finalCount <= 1) {
                    console.error('[ERROR] populateKsSectionOptions: Only', finalCount, 'options found, expected more');
                    return false;
                }
                
                return true;
            } catch (e) {
                console.error('[ERROR] populateKsSectionOptions: Exception:', e);
                return false;
            }
        }

        // 즉시 옵션 생성 시도 (ksSections 정의 직후) - 더 직접적인 방법
        (function initKsSectionOptionsImmediately() {
            console.log('[DEBUG] initKsSectionOptionsImmediately: Starting, ksSections available:', typeof ksSections !== 'undefined');
            
            // DOM이 준비될 때까지 대기하는 함수
            function tryInit(retryCount = 0) {
                const maxRetries = 20;
                const ksSectionSelect = document.getElementById('ksSection');
                
                console.log('[DEBUG] tryInit attempt', retryCount + 1, 'of', maxRetries, {
                    hasSelect: !!ksSectionSelect,
                    hasKsSections: typeof ksSections !== 'undefined',
                    ksSectionsCount: typeof ksSections !== 'undefined' ? Object.keys(ksSections).length : 0,
                    readyState: document.readyState
                });
                
                if (ksSectionSelect && typeof ksSections !== 'undefined' && Object.keys(ksSections).length > 0) {
                    console.log('[DEBUG] initKsSectionOptionsImmediately: DOM and ksSections ready, populating options');
                    const result = populateKsSectionOptions();
                    if (result) {
                        console.log('[DEBUG] initKsSectionOptionsImmediately: Successfully populated options');
                    } else {
                        console.error('[ERROR] initKsSectionOptionsImmediately: Failed to populate options');
                    }
                    return;
                }
                
                if (retryCount < maxRetries) {
                    if (document.readyState === 'loading') {
                        // DOM이 아직 로딩 중이면 DOMContentLoaded 대기
                        if (retryCount === 0) {
                            document.addEventListener('DOMContentLoaded', () => tryInit(retryCount + 1));
                        }
                    }
                    // 짧은 지연 후 재시도
                    setTimeout(() => tryInit(retryCount + 1), 100);
                } else {
                    console.error('[ERROR] initKsSectionOptionsImmediately: Max retries reached, giving up');
                }
            }
            
            // 즉시 시도
            tryInit();
            
            // DOMContentLoaded 이벤트에도 리스너 추가
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    console.log('[DEBUG] DOMContentLoaded fired, retrying option population');
                    tryInit();
                });
            }
            
            // window.load 이벤트에도 리스너 추가 (백업)
            window.addEventListener('load', () => {
                console.log('[DEBUG] window.load fired, retrying option population');
                tryInit();
            });
        })();

        // Update material info box with selected steel grade
        function updateMaterialInfoBox() {
            const steelGradeSelect = document.getElementById('steelGrade');
            const materialInfoBox = document.getElementById('materialInfoBox');
            if (steelGradeSelect && materialInfoBox) {
                const selectedGrade = steelGradeSelect.value;
                const Fy = steelGrades[selectedGrade] || 355;
                materialInfoBox.innerHTML = `
                    <strong>강종:</strong> ${selectedGrade} (Fy = ${Fy} MPa)<br>
                    <strong>탄성계수:</strong> Es = 210,000 MPa<br>
                    <strong>단위중량:</strong> γ = 78.5 kN/m³
                `;
            }
        }

        // KS section selection handler
        // Function to initialize page (can be called immediately or on DOMContentLoaded)
        function initializePage() {
            // #region agent log
            console.log('[DEBUG] initializePage called, readyState:', document.readyState);
            fetch('http://127.0.0.1:7242/ingest/f6b33b86-5eb3-41dd-83f7-9e0a0382507b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'ex-slim-beam-calculator.html:459',message:'initializePage called',data:{readyState:document.readyState,timestamp:Date.now()},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'Z'})}).catch(()=>{});
            // #endregion
            
            const ksSectionSelect = document.getElementById('ksSection');
            const beamDepthInput = document.getElementById('beamDepth');
            const flangeWidthInput = document.getElementById('flangeWidth');
            const webThicknessInput = document.getElementById('webThickness');
            const flangeThicknessInput = document.getElementById('flangeThickness');
            const filletRadiusInput = document.getElementById('filletRadius');
            const steelGradeSelect = document.getElementById('steelGrade');
            
            // #region agent log
            console.log('[DEBUG] DOM elements retrieved:', {hasKsSection:!!ksSectionSelect,hasBeamDepth:!!beamDepthInput,hasSteelGrade:!!steelGradeSelect});
            fetch('http://127.0.0.1:7242/ingest/f6b33b86-5eb3-41dd-83f7-9e0a0382507b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'ex-slim-beam-calculator.html:472',message:'DOM elements retrieved',data:{hasKsSection:!!ksSectionSelect,hasBeamDepth:!!beamDepthInput,hasSteelGrade:!!steelGradeSelect},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'Z1'})}).catch(()=>{});
            // #endregion
            
            if (!ksSectionSelect || !beamDepthInput) {
                // #region agent log
                console.log('[DEBUG] DOM elements not ready, will retry');
                fetch('http://127.0.0.1:7242/ingest/f6b33b86-5eb3-41dd-83f7-9e0a0382507b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'ex-slim-beam-calculator.html:476',message:'DOM elements not ready, will retry',data:{},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'Z2'})}).catch(()=>{});
                // #endregion
                return; // Elements not ready yet
            }

            // KS 단면 옵션 동적 생성 (별도 함수 호출)
            if (ksSectionSelect) {
                console.log('[DEBUG] initializePage: Calling populateKsSectionOptions');
                populateKsSectionOptions();
                
                // 기본 선택값은 localStorage 복원 후에 설정됨
                // 여기서는 옵션만 생성
            }
            
            // Update material info box on steel grade change
            if (steelGradeSelect) {
                updateMaterialInfoBox(); // Initial update
                steelGradeSelect.addEventListener('change', updateMaterialInfoBox);
            }
            
            // Update beam diagram when span changes
            function updateBeamDiagram() {
                const beamSpanInput = document.getElementById('beamSpan');
                const beamSpanValue = document.getElementById('beamSpanValue');
                if (beamSpanInput && beamSpanValue) {
                    const spanValue = parseFloat(beamSpanInput.value) || 0;
                    beamSpanValue.textContent = spanValue.toFixed(1);
                }
            }
            
            // Update beam section label in diagram
            function updateBeamSectionLabel() {
                const ksSectionSelect = document.getElementById('ksSection');
                const beamSectionLabel = document.getElementById('beamSectionLabel');
                if (ksSectionSelect && beamSectionLabel) {
                    const selectedValue = ksSectionSelect.value;
                    if (selectedValue && ksSections[selectedValue]) {
                        // Extract section name (e.g., "H500x200x10x16" -> "H 500×200")
                        const match = selectedValue.match(/H(\d+)x(\d+)/);
                        if (match) {
                            beamSectionLabel.textContent = `H ${match[1]}×${match[2]}`;
                        } else {
                            beamSectionLabel.textContent = selectedValue;
                        }
                    } else {
                        // Check if manual input values exist
                        const d = parseFloat(document.getElementById('beamDepth').value) || 0;
                        const bf = parseFloat(document.getElementById('flangeWidth').value) || 0;
                        if (d > 0 && bf > 0) {
                            beamSectionLabel.textContent = `H ${d}×${bf}`;
                        } else {
                            beamSectionLabel.textContent = '직접 입력';
                        }
                    }
                }
            }
            
            // Add event listener for beam span input
            const beamSpanInput = document.getElementById('beamSpan');
            if (beamSpanInput) {
                updateBeamDiagram(); // Initial update
                beamSpanInput.addEventListener('input', updateBeamDiagram);
                beamSpanInput.addEventListener('change', updateBeamDiagram);
            }
            
            function updateInputFields(enable) {
                beamDepthInput.disabled = !enable;
                flangeWidthInput.disabled = !enable;
                webThicknessInput.disabled = !enable;
                flangeThicknessInput.disabled = !enable;
                
                if (enable) {
                    beamDepthInput.style.background = '';
                    flangeWidthInput.style.background = '';
                    webThicknessInput.style.background = '';
                    flangeThicknessInput.style.background = '';
                } else {
                    beamDepthInput.style.background = '#f1f5f9';
                    flangeWidthInput.style.background = '#f1f5f9';
                    webThicknessInput.style.background = '#f1f5f9';
                    flangeThicknessInput.style.background = '#f1f5f9';
                }
            }
            
            if (ksSectionSelect) {
                // Initial state: if default section is selected, disable manual input
                if (ksSectionSelect.value && ksSectionSelect.value !== '') {
                    updateInputFields(false);
                }
                
                ksSectionSelect.addEventListener('change', function() {
                    const selectedValue = this.value;
                    if (selectedValue && ksSections[selectedValue]) {
                        const section = ksSections[selectedValue];
                        beamDepthInput.value = section.d;
                        flangeWidthInput.value = section.bf;
                        webThicknessInput.value = section.tw;
                        flangeThicknessInput.value = section.tf;
                        if (section.r !== undefined && filletRadiusInput) {
                            filletRadiusInput.value = section.r;
                        }
                        // Disable manual input when KS section is selected
                        updateInputFields(false);
                        // Trigger self weight update
                        updateSelfWeight();
                        // Update beam section label in diagram
                        updateBeamSectionLabel();
                    } else {
                        // Enable manual input when "직접 입력" is selected
                        updateInputFields(true);
                        // Update beam section label in diagram
                        updateBeamSectionLabel();
                    }
                });
                
                // Also update when manual input values change
                if (beamDepthInput && flangeWidthInput) {
                    const updateLabelOnInput = function() {
                        setTimeout(updateBeamSectionLabel, 100);
                    };
                    beamDepthInput.addEventListener('input', updateLabelOnInput);
                    beamDepthInput.addEventListener('change', updateLabelOnInput);
                    flangeWidthInput.addEventListener('input', updateLabelOnInput);
                    flangeWidthInput.addEventListener('change', updateLabelOnInput);
                }
                
                // Initial update of beam section label
                updateBeamSectionLabel();
            }
            
            // Restore saved inputs and results from localStorage
            try {
                const savedInputs = localStorage.getItem('exSlimBeamInputs');
                const savedResults = localStorage.getItem('exSlimBeamResults');
                
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/f6b33b86-5eb3-41dd-83f7-9e0a0382507b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'ex-slim-beam-calculator.html:570',message:'Checking localStorage for saved data',data:{hasSavedInputs:!!savedInputs,hasSavedResults:!!savedResults},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'P'})}).catch(()=>{});
                // #endregion
                
                if (savedInputs) {
                    try {
                        const inputs = JSON.parse(savedInputs);
                        
                        // #region agent log
                        fetch('http://127.0.0.1:7242/ingest/f6b33b86-5eb3-41dd-83f7-9e0a0382507b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'ex-slim-beam-calculator.html:580',message:'Parsing saved inputs',data:{hasKsSection:inputs.ksSection!==undefined,ksSectionValue:inputs.ksSection,hasL:inputs.L!==undefined,hasB:inputs.B!==undefined},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'V'})}).catch(()=>{});
                        // #endregion
                        
                        // Restore ksSection first (affects other input fields)
                        // KS 단면 옵션이 이미 생성된 후이므로 값을 설정할 수 있음
                        if (inputs.ksSection !== undefined && ksSectionSelect) {
                            // Select 옵션이 존재하는지 확인
                            const optionExists = Array.from(ksSectionSelect.options).some(opt => opt.value === inputs.ksSection);
                            
                            // #region agent log
                            fetch('http://127.0.0.1:7242/ingest/f6b33b86-5eb3-41dd-83f7-9e0a0382507b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'ex-slim-beam-calculator.html:590',message:'Restoring ksSection',data:{ksSectionValue:inputs.ksSection,optionExists:optionExists,selectOptionsCount:ksSectionSelect.options.length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'W'})}).catch(()=>{});
                            // #endregion
                            
                            if (optionExists || inputs.ksSection === '') {
                                // 옵션이 존재하거나 직접 입력 모드인 경우
                                ksSectionSelect.value = inputs.ksSection;
                                
                                if (inputs.ksSection && ksSections[inputs.ksSection]) {
                                    // KS section selected - use section values
                                    const section = ksSections[inputs.ksSection];
                                    beamDepthInput.value = section.d;
                                    flangeWidthInput.value = section.bf;
                                    webThicknessInput.value = section.tw;
                                    flangeThicknessInput.value = section.tf;
                                    if (section.r !== undefined && filletRadiusInput) {
                                        filletRadiusInput.value = section.r;
                                    }
                                    updateInputFields(false);
                                } else if (inputs.ksSection === '') {
                                    // Direct input mode - restore manual values
                                    updateInputFields(true);
                                    if (inputs.d) beamDepthInput.value = inputs.d;
                                    if (inputs.bf) flangeWidthInput.value = inputs.bf;
                                    if (inputs.tf) flangeThicknessInput.value = inputs.tf;
                                    if (inputs.tw) webThicknessInput.value = inputs.tw;
                                    if (inputs.r !== undefined && filletRadiusInput) {
                                        filletRadiusInput.value = inputs.r;
                                    }
                                }
                                
                                // #region agent log
                                fetch('http://127.0.0.1:7242/ingest/f6b33b86-5eb3-41dd-83f7-9e0a0382507b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'ex-slim-beam-calculator.html:620',message:'ksSection restored',data:{ksSectionValue:inputs.ksSection,selectValue:ksSectionSelect.value,beamDepth:beamDepthInput.value},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'W1'})}).catch(()=>{});
                                // #endregion
                            } else {
                                // 옵션이 존재하지 않는 경우 - 직접 입력 모드로 설정
                                // #region agent log
                                fetch('http://127.0.0.1:7242/ingest/f6b33b86-5eb3-41dd-83f7-9e0a0382507b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'ex-slim-beam-calculator.html:625',message:'ksSection option not found, using direct input',data:{ksSectionValue:inputs.ksSection},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'W2'})}).catch(()=>{});
                                // #endregion
                                ksSectionSelect.value = '';
                                updateInputFields(true);
                                if (inputs.d) beamDepthInput.value = inputs.d;
                                if (inputs.bf) flangeWidthInput.value = inputs.bf;
                                if (inputs.tf) flangeThicknessInput.value = inputs.tf;
                                if (inputs.tw) webThicknessInput.value = inputs.tw;
                                if (inputs.r !== undefined && filletRadiusInput) {
                                    filletRadiusInput.value = inputs.r;
                                }
                            }
                        }
                        
                        // Restore other input values
                        if (inputs.L) document.getElementById('beamSpan').value = inputs.L;
                        if (inputs.B) document.getElementById('loadWidth').value = inputs.B;
                        if (inputs.wL) document.getElementById('liveLoad').value = inputs.wL;
                        if (inputs.wD) document.getElementById('deadLoad').value = inputs.wD;
                        if (inputs.wConst) document.getElementById('constructionLoad').value = inputs.wConst;
                        if (inputs.ts !== undefined) document.getElementById('slabThickness').value = inputs.ts;
                        if (inputs.fc) document.getElementById('concreteStrength').value = inputs.fc;
                        if (inputs.studDiameter) document.getElementById('studDiameter').value = inputs.studDiameter;
                        if (inputs.studLength) document.getElementById('studLength').value = inputs.studLength;
                        
                        if (inputs.steelGrade && steelGradeSelect) {
                            steelGradeSelect.value = inputs.steelGrade;
                        }
                        
                        // Update dependent fields (selfWeight and slabWeight are calculated, not directly restored)
                        // These functions will recalculate based on restored input values
                        // Use setTimeout to ensure all inputs are restored first
                        setTimeout(function() {
                            updateSelfWeight();
                            updateSlabWeight();
                            if (steelGradeSelect) {
                                updateMaterialInfoBox();
                            }
                            
                            // #region agent log
                            fetch('http://127.0.0.1:7242/ingest/f6b33b86-5eb3-41dd-83f7-9e0a0382507b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'ex-slim-beam-calculator.html:635',message:'Inputs restored from localStorage and dependent fields updated',data:{L:inputs.L,B:inputs.B,ksSection:inputs.ksSection,selfWeight:document.getElementById('selfWeight').value,slabWeight:document.getElementById('slabWeight').value},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'Q'})}).catch(()=>{});
                            // #endregion
                        }, 50);
                        
                        // #region agent log
                        fetch('http://127.0.0.1:7242/ingest/f6b33b86-5eb3-41dd-83f7-9e0a0382507b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'ex-slim-beam-calculator.html:642',message:'Inputs restored from localStorage (before dependent fields update)',data:{L:inputs.L,B:inputs.B,ksSection:inputs.ksSection,d:inputs.d,bf:inputs.bf,tf:inputs.tf,tw:inputs.tw,ts:inputs.ts},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'X'})}).catch(()=>{});
                        // #endregion
                    } catch (e) {
                        // #region agent log
                        fetch('http://127.0.0.1:7242/ingest/f6b33b86-5eb3-41dd-83f7-9e0a0382507b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'ex-slim-beam-calculator.html:614',message:'Failed to restore inputs from localStorage',data:{error:e.message},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'R'})}).catch(()=>{});
                        // #endregion
                    }
                }
                
                // Restore saved results
                if (savedResults) {
                    try {
                        const results = JSON.parse(savedResults);
                        // #region agent log
                        fetch('http://127.0.0.1:7242/ingest/f6b33b86-5eb3-41dd-83f7-9e0a0382507b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'ex-slim-beam-calculator.html:662',message:'Restoring results from localStorage',data:{resultsKeys:Object.keys(results||{})},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'S'})}).catch(()=>{});
                        // #endregion
                        // Use setTimeout to ensure inputs are restored first
                        setTimeout(function() {
                            displayResults(results);
                        }, 150);
                    } catch (e) {
                        // #region agent log
                        fetch('http://127.0.0.1:7242/ingest/f6b33b86-5eb3-41dd-83f7-9e0a0382507b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'ex-slim-beam-calculator.html:668',message:'Failed to restore results from localStorage',data:{error:e.message},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'T'})}).catch(()=>{});
                        // #endregion
                    }
                } else {
                    // No saved results - call update functions for initial calculation
                    setTimeout(function() {
                        updateSelfWeight();
                        updateSlabWeight();
                        // #region agent log
                        fetch('http://127.0.0.1:7242/ingest/f6b33b86-5eb3-41dd-83f7-9e0a0382507b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'ex-slim-beam-calculator.html:675',message:'No saved results, calling initial update functions',data:{},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'Y'})}).catch(()=>{});
                        // #endregion
                    }, 100);
                }
            } catch (e) {
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/f6b33b86-5eb3-41dd-83f7-9e0a0382507b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'ex-slim-beam-calculator.html:700',message:'Error checking localStorage',data:{error:e.message},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'U'})}).catch(()=>{});
                // #endregion
            }
            
            // Always call update functions at the end of initialization to ensure values are calculated
            // Use multiple timeouts to ensure all DOM elements and input values are ready
            // First call after a short delay
            setTimeout(function() {
                console.log('[DEBUG] First call: updateSelfWeight and updateSlabWeight');
                updateSelfWeight();
                updateSlabWeight();
            }, 100);
            
            // Second call after a longer delay to ensure values persist
            setTimeout(function() {
                console.log('[DEBUG] Second call: updateSelfWeight and updateSlabWeight');
                updateSelfWeight();
                updateSlabWeight();
                
                // Verify values are set
                const selfWeightEl = document.getElementById('selfWeight');
                const slabWeightEl = document.getElementById('slabWeight');
                const selfWeightValue = selfWeightEl?.value || '';
                const slabWeightValue = slabWeightEl?.value || '';
                
                // #region agent log
                console.log('[DEBUG] Final verification:', {selfWeightValue, slabWeightValue});
                fetch('http://127.0.0.1:7242/ingest/f6b33b86-5eb3-41dd-83f7-9e0a0382507b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'ex-slim-beam-calculator.html:975',message:'Final updateSelfWeight and updateSlabWeight call with verification',data:{selfWeight:selfWeightValue,slabWeight:slabWeightValue,beamDepth:document.getElementById('beamDepth')?.value,loadWidth:document.getElementById('loadWidth')?.value,slabThickness:document.getElementById('slabThickness')?.value,hasSelfWeightEl:!!selfWeightEl,hasSlabWeightEl:!!slabWeightEl},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'V'})}).catch(()=>{});
                // #endregion
            }, 300);
            
            // Third call after even longer delay as a safety net
            setTimeout(function() {
                console.log('[DEBUG] Third call (safety net): updateSelfWeight and updateSlabWeight');
                updateSelfWeight();
                updateSlabWeight();
            }, 500);
        }
        
        // Call initializePage when DOM is ready
        // #region agent log
        console.log('[DEBUG] Script execution point - readyState:', document.readyState, 'initializePage exists:', typeof initializePage !== 'undefined');
        fetch('http://127.0.0.1:7242/ingest/f6b33b86-5eb3-41dd-83f7-9e0a0382507b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'ex-slim-beam-calculator.html:755',message:'Script execution point - checking readyState',data:{readyState:document.readyState,hasInitializePage:typeof initializePage !== 'undefined'},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'AD'})}).catch(()=>{});
        // #endregion
        
        // Multiple initialization strategies to ensure it runs
        function ensureInitialization() {
            console.log('[DEBUG] ensureInitialization called, ksSection element:', document.getElementById('ksSection'));
            if (document.getElementById('ksSection')) {
                initializePage();
            } else {
                console.log('[DEBUG] ksSection not found, retrying in 100ms');
                setTimeout(ensureInitialization, 100);
            }
        }
        
        // Also try to populate options immediately if DOM is ready
        function tryPopulateOptionsNow() {
            const ksSectionSelect = document.getElementById('ksSection');
            if (ksSectionSelect && typeof populateKsSectionOptions === 'function' && typeof ksSections !== 'undefined') {
                console.log('[DEBUG] tryPopulateOptionsNow: DOM ready, calling populateKsSectionOptions');
                const result = populateKsSectionOptions();
                if (result) {
                    console.log('[DEBUG] tryPopulateOptionsNow: Successfully populated options');
                } else {
                    console.warn('[WARN] tryPopulateOptionsNow: Failed to populate options');
                }
                return result;
            } else {
                console.log('[DEBUG] tryPopulateOptionsNow: Not ready yet', {
                    hasSelect: !!ksSectionSelect,
                    hasFunction: typeof populateKsSectionOptions === 'function',
                    hasKsSections: typeof ksSections !== 'undefined'
                });
                return false;
            }
        }
        
        // Force populate options with retry mechanism
        function forcePopulateOptions(retryCount = 0, maxRetries = 10) {
            if (retryCount >= maxRetries) {
                console.error('[ERROR] forcePopulateOptions: Max retries reached, giving up');
                return;
            }
            
            const result = tryPopulateOptionsNow();
            if (!result && retryCount < maxRetries) {
                console.log('[DEBUG] forcePopulateOptions: Retry', retryCount + 1, 'of', maxRetries);
                setTimeout(() => forcePopulateOptions(retryCount + 1, maxRetries), 100 * (retryCount + 1));
            }
        }
        
        // Try immediately (script is at bottom of HTML, so DOM should be ready)
        console.log('[DEBUG] Script execution: Attempting immediate option population');
        forcePopulateOptions();
        
        if (document.readyState === 'loading') {
            // #region agent log
            console.log('[DEBUG] Adding DOMContentLoaded listener');
            fetch('http://127.0.0.1:7242/ingest/f6b33b86-5eb3-41dd-83f7-9e0a0382507b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'ex-slim-beam-calculator.html:789',message:'Adding DOMContentLoaded listener',data:{},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'AE'})}).catch(()=>{});
            // #endregion
            document.addEventListener('DOMContentLoaded', ensureInitialization);
            document.addEventListener('DOMContentLoaded', () => forcePopulateOptions());
            // Also try on window load as backup
            window.addEventListener('load', ensureInitialization);
            window.addEventListener('load', () => forcePopulateOptions());
        } else {
            // DOM is already loaded, call immediately
            // #region agent log
            console.log('[DEBUG] DOM already loaded, calling ensureInitialization and forcePopulateOptions');
            fetch('http://127.0.0.1:7242/ingest/f6b33b86-5eb3-41dd-83f7-9e0a0382507b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'ex-slim-beam-calculator.html:810',message:'DOM already loaded, calling ensureInitialization',data:{readyState:document.readyState},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'AF'})}).catch(()=>{});
            // #endregion
            ensureInitialization();
            // Also try immediately with retry
            forcePopulateOptions();
        }

        // Update self weight when section properties change
        function updateSelfWeight() {
            try {
                const d = parseFloat(document.getElementById('beamDepth')?.value) || 0;
                const bf = parseFloat(document.getElementById('flangeWidth')?.value) || 0;
                const tf = parseFloat(document.getElementById('flangeThickness')?.value) || 0;
                const tw = parseFloat(document.getElementById('webThickness')?.value) || 0;
                const B = parseFloat(document.getElementById('loadWidth')?.value) || 0;
                const selfWeightElement = document.getElementById('selfWeight');

                // #region agent log
                console.log('[DEBUG] updateSelfWeight called', {d, bf, tf, tw, B, hasElement: !!selfWeightElement});
                fetch('http://127.0.0.1:7242/ingest/f6b33b86-5eb3-41dd-83f7-9e0a0382507b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'ex-slim-beam-calculator.html:1067',message:'updateSelfWeight called',data:{d,bf,tf,tw,B,hasElement:!!selfWeightElement},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'W'})}).catch(()=>{});
                // #endregion

                if (!selfWeightElement) {
                    console.warn('[WARN] updateSelfWeight: selfWeight element not found');
                    return;
                }

                if (d <= 0 || bf <= 0 || tf <= 0 || tw <= 0) {
                    selfWeightElement.value = '';
                    // #region agent log
                    console.log('[DEBUG] updateSelfWeight: Invalid input values, clearing field');
                    // #endregion
                    return;
                }

                const hw = d - 2 * tf;
                const area = bf * tf * 2 + hw * tw; // mm²
                const gamma = 78.5; // kN/m³ (강재 단위중량)
                const selfWeight_kNm = (area / 1000000) * gamma; // kN/m (철골보 자중)
                
                // 하중폭(B)으로 나눈 값 (kN/m²)
                const selfWeight_kNm2 = B > 0 ? selfWeight_kNm / B : 0; // kN/m²

                // 철골보 자중을 하중폭으로 나눈 값만 표시
                const resultValue = B > 0 ? selfWeight_kNm2.toFixed(3) : '';
                selfWeightElement.value = resultValue;
                
                // Force update by triggering input event
                selfWeightElement.dispatchEvent(new Event('input', { bubbles: true }));
                
                // #region agent log
                const actualValue = selfWeightElement.value;
                console.log('[DEBUG] updateSelfWeight: Calculated value', {selfWeight_kNm2, resultValue, actualValue, area, gamma, B});
                fetch('http://127.0.0.1:7242/ingest/f6b33b86-5eb3-41dd-83f7-9e0a0382507b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'ex-slim-beam-calculator.html:1103',message:'updateSelfWeight calculated',data:{selfWeight_kNm2,resultValue,actualValue,area,gamma,B},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'X'})}).catch(()=>{});
                // #endregion
            } catch (e) {
                console.error('[ERROR] updateSelfWeight exception:', e);
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/f6b33b86-5eb3-41dd-83f7-9e0a0382507b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'ex-slim-beam-calculator.html:1100',message:'updateSelfWeight error',data:{error:e.message},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'Y'})}).catch(()=>{});
                // #endregion
            }
        }

        // Add event listeners for self weight calculation
        ['beamDepth', 'flangeWidth', 'flangeThickness', 'webThickness', 'loadWidth'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('input', updateSelfWeight);
            }
        });

        // Update slab weight when slab thickness changes
        function updateSlabWeight() {
            try {
                const ts = parseFloat(document.getElementById('slabThickness')?.value) || 0;
                const slabWeightElement = document.getElementById('slabWeight');

                // #region agent log
                console.log('[DEBUG] updateSlabWeight called', {ts, hasElement: !!slabWeightElement});
                fetch('http://127.0.0.1:7242/ingest/f6b33b86-5eb3-41dd-83f7-9e0a0382507b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'ex-slim-beam-calculator.html:1108',message:'updateSlabWeight called',data:{ts,hasElement:!!slabWeightElement},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'Z'})}).catch(()=>{});
                // #endregion

                if (!slabWeightElement) {
                    console.warn('[WARN] updateSlabWeight: slabWeight element not found');
                    return;
                }

                if (ts <= 0) {
                    slabWeightElement.value = '';
                    // #region agent log
                    console.log('[DEBUG] updateSlabWeight: Invalid ts value, clearing field');
                    // #endregion
                    return;
                }

                // 콘크리트 단위중량: 24 kN/m³
                const concreteUnitWeight = 24; // kN/m³
                // 슬래브 자중 = 슬래브 두께(m) × 콘크리트 단위중량(kN/m³)
                const slabWeight = (ts / 1000) * concreteUnitWeight; // kN/m²

                const resultValue = slabWeight.toFixed(3);
                slabWeightElement.value = resultValue;
                
                // Force update by triggering input event
                slabWeightElement.dispatchEvent(new Event('input', { bubbles: true }));
                
                // #region agent log
                const actualValue = slabWeightElement.value;
                console.log('[DEBUG] updateSlabWeight: Calculated value', {slabWeight, resultValue, actualValue, ts});
                fetch('http://127.0.0.1:7242/ingest/f6b33b86-5eb3-41dd-83f7-9e0a0382507b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'ex-slim-beam-calculator.html:1145',message:'updateSlabWeight calculated',data:{slabWeight,resultValue,actualValue,ts},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'AA'})}).catch(()=>{});
                // #endregion
            } catch (e) {
                console.error('[ERROR] updateSlabWeight exception:', e);
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/f6b33b86-5eb3-41dd-83f7-9e0a0382507b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'ex-slim-beam-calculator.html:1133',message:'updateSlabWeight error',data:{error:e.message},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'AB'})}).catch(()=>{});
                // #endregion
            }
        }

        // Add event listener for slab weight calculation
        const slabThicknessElement = document.getElementById('slabThickness');
        if (slabThicknessElement) {
            slabThicknessElement.addEventListener('input', updateSlabWeight);
        }

        // DO NOT call updateSelfWeight() and updateSlabWeight() here
        // They will be called after localStorage restoration in DOMContentLoaded

        // Main calculation function
        function calculateBeam() {
            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/f6b33b86-5eb3-41dd-83f7-9e0a0382507b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'ex-slim-beam-calculator.html:374',message:'calculateBeam called',data:{timestamp:Date.now()},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
            // #endregion
            
            try {
                // Get input values
                const L = parseFloat(document.getElementById('beamSpan').value) || 0;
                const B = parseFloat(document.getElementById('loadWidth').value) || 0;
                const wL = parseFloat(document.getElementById('liveLoad').value) || 0;
                const wD = parseFloat(document.getElementById('deadLoad').value) || 0;
                // Self Weight는 슬래브 유효폭으로 나눈 값(kN/m²)을 직접 사용
                const wSW = parseFloat(document.getElementById('selfWeight').value) || 0;
                const wConst = parseFloat(document.getElementById('constructionLoad').value) || 0;
                const wSlab = parseFloat(document.getElementById('slabWeight').value) || 0;
                // 합성 후 고정하중은 입력 필드가 없으므로 0으로 설정
                const sidl1 = 0;
                
                const d = parseFloat(document.getElementById('beamDepth').value) || 0;
                const bf = parseFloat(document.getElementById('flangeWidth').value) || 0;
                const tf = parseFloat(document.getElementById('flangeThickness').value) || 0;
                const tw = parseFloat(document.getElementById('webThickness').value) || 0;
                const r = parseFloat(document.getElementById('filletRadius').value) || 0;
                
                const ts = parseFloat(document.getElementById('slabThickness').value) || 0;
                
                // Save input values to localStorage
                try {
                    const inputData = {
                        L, B, wL, wD, wSW, wConst, wSlab, sidl1,
                        d, bf, tf, tw, r, ts,
                        ksSection: document.getElementById('ksSection').value,
                        steelGrade: document.getElementById('steelGrade').value,
                        fc: parseFloat(document.getElementById('concreteStrength').value) || 0,
                        studDiameter: parseFloat(document.getElementById('studDiameter').value) || 0,
                        studLength: parseFloat(document.getElementById('studLength').value) || 0
                    };
                    localStorage.setItem('exSlimBeamInputs', JSON.stringify(inputData));
                    // #region agent log
                    fetch('http://127.0.0.1:7242/ingest/f6b33b86-5eb3-41dd-83f7-9e0a0382507b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'ex-slim-beam-calculator.html:660',message:'Inputs saved to localStorage',data:{L:L,B:B},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'N'})}).catch(()=>{});
                    // #endregion
                } catch (e) {
                    // #region agent log
                    fetch('http://127.0.0.1:7242/ingest/f6b33b86-5eb3-41dd-83f7-9e0a0382507b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'ex-slim-beam-calculator.html:666',message:'Failed to save inputs to localStorage',data:{error:e.message},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'O'})}).catch(()=>{});
                    // #endregion
                }
                const beff = parseFloat(document.getElementById('effectiveWidth').value) || 0;
                const fc = parseFloat(document.getElementById('concreteStrength').value) || 24;

                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/f6b33b86-5eb3-41dd-83f7-9e0a0382507b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'ex-slim-beam-calculator.html:392',message:'Input values parsed',data:{L:L,B:B,wL:wL,wD:wD,wSW:wSW,wConst:wConst,d:d,bf:bf,tf:tf,tw:tw,r:r,ts:ts,beff:beff,fc:fc},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{});
                // #endregion

                // Validation
                if (L <= 0 || B <= 0 || d <= 0 || bf <= 0 || tf <= 0 || tw <= 0) {
                    // #region agent log
                    fetch('http://127.0.0.1:7242/ingest/f6b33b86-5eb3-41dd-83f7-9e0a0382507b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'ex-slim-beam-calculator.html:395',message:'Validation failed',data:{L:L,B:B,d:d,bf:bf,tf:tf,tw:tw},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'C'})}).catch(()=>{});
                    // #endregion
                    alert('모든 입력값을 올바르게 입력해주세요.');
                    return;
                }

            // Calculate steel section properties
            const hw = d - 2 * tf;
            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/f6b33b86-5eb3-41dd-83f7-9e0a0382507b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'ex-slim-beam-calculator.html:677',message:'H-beam dimensions before Ix calculation',data:{d:d,bf:bf,tf:tf,tw:tw,r:r,hw:hw},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
            // #endregion
            if (hw <= 0) {
                alert('웹 높이가 0 이하입니다. 보 높이와 플랜지 두께를 확인해주세요.');
                return;
            }

            // Steel section area
            const As = bf * tf * 2 + hw * tw; // mm²

            // Steel section moment of inertia
            // #region agent log
            const d_cubed = Math.pow(d, 3);
            const hw_cubed = Math.pow(hw, 3);
            const term1 = bf * d_cubed;
            const term2 = (bf - tw) * hw_cubed;
            const Ix_steel_old = (term1 - term2) / 12;
            fetch('http://127.0.0.1:7242/ingest/f6b33b86-5eb3-41dd-83f7-9e0a0382507b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'ex-slim-beam-calculator.html:672',message:'Ix_steel calculation intermediate values',data:{d_cubed:d_cubed,hw_cubed:hw_cubed,term1:term1,term2:term2,Ix_steel_old:Ix_steel_old,Ix_steel_old_millions:Ix_steel_old/1e6},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
            // #endregion
            // Correct formula using parallel axis theorem: Ix = 2*[bf*tf³/12 + bf*tf*(d/2-tf/2)²] + tw*hw³/12
            // Reference: crossHcolumnCalculator.html uses: Ix = 1/12 * b * tf³ + A * d² for each flange
            // 필렛 반경(r) 반영: 필렛 부분의 Ix 기여도는 매우 작지만 정확성을 위해 추가
            const Ix_flange_own = bf * Math.pow(tf, 3) / 12; // moment of inertia of one flange about its own centroid
            const flange_area = bf * tf; // area of one flange
            const flange_centroid_dist = d/2 - tf/2; // distance from flange centroid to section centroid
            const Ix_flange_parallel = flange_area * Math.pow(flange_centroid_dist, 2); // parallel axis theorem term
            const Ix_one_flange = Ix_flange_own + Ix_flange_parallel; // total Ix for one flange
            const Ix_web = tw * Math.pow(hw, 3) / 12; // moment of inertia of web about section centroid
            
            // 필렛 부분의 Ix 기여도 계산 (4개 모서리)
            // 필렛 부분 면적: A_fillet = 4 * (r² - πr²/4) = 4r²(1 - π/4)
            // 필렛 부분의 중심 위치: 약 d/2 - tf/2 근처
            // 필렛 부분의 자체 관성모멘트는 매우 작아서 무시하고, 평행축 정리 항만 고려
            let Ix_fillet = 0;
            if (r > 0) {
                const fillet_area = 4 * (r * r - Math.PI * r * r / 4); // mm² (4개 모서리)
                const fillet_centroid_dist = d/2 - tf/2; // 필렛 중심에서 단면 중심까지 거리 (근사)
                Ix_fillet = fillet_area * Math.pow(fillet_centroid_dist, 2); // 평행축 정리 항
            }
            
            const Ix_steel = 2 * Ix_one_flange + Ix_web + Ix_fillet; // mm⁴ (필렛 반경 반영)
            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/f6b33b86-5eb3-41dd-83f7-9e0a0382507b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'ex-slim-beam-calculator.html:717',message:'Ix_steel calculation with r value',data:{r:r,r_reflected:true,Ix_flange_own:Ix_flange_own,flange_area:flange_area,flange_centroid_dist:flange_centroid_dist,Ix_flange_parallel:Ix_flange_parallel,Ix_one_flange:Ix_one_flange,Ix_web:Ix_web,Ix_fillet:Ix_fillet,Ix_steel:Ix_steel,Ix_steel_millions:Ix_steel/1e6,note:'필렛 반경(r) 반영됨'},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'H'})}).catch(()=>{});
            // #endregion

            // Steel section modulus
            const Sx_steel = Ix_steel / (d / 2); // mm³

            // Plastic section modulus (simplified)
            const Zx_steel = bf * tf * (d - tf) + tw * Math.pow(hw, 2) / 4; // mm³

            // Loading (convert from kN/m² to kN/m)
            const wL_line = wL * B; // kN/m
            const wD_line = wD * B; // kN/m
            const wConst_line = wConst * B; // kN/m (시공하중을 kN/m²에서 kN/m로 변환)
            const w_total = wL_line + wD_line + wSW + wConst_line; // kN/m (시공하중 포함)

            // Construction stage calculations (시공단계 계산)
            // 시공중 고정하중: 슬래브 자중 + 철골보 자중
            // wSlab: 슬래브 자중 (kN/m²), wSW: 철골보 자중을 하중폭으로 나눈 값 (kN/m²)
            const w_DL_construction = (wSlab + wSW) * B; // kN/m
            // 시공중 활하중: Construction Load (kN/m²에서 kN/m로 변환)
            const w_CLL_construction = wConst_line; // kN/m
            // 시공중 계수하중 (LRFD): max[1.4*DL, 1.2*DL + 1.6*LL]
            const w_u1_construction = 1.4 * w_DL_construction; // kN/m
            const w_u2_construction = 1.2 * w_DL_construction + 1.6 * w_CLL_construction; // kN/m
            const w_u_construction = Math.max(w_u1_construction, w_u2_construction); // kN/m
            // 시공 중 소요휨강도
            const M_u_construction = w_u_construction * Math.pow(L, 2) / 8; // kN·m
            // 시공 중 소요단면2차모멘트 (처짐 제한 60mm 고려)
            const delta_allow_construction = 60; // mm (콘크리트 타설 시공성 고려)
            const I_req_construction = (5 * w_DL_construction * Math.pow(L * 1000, 4)) / (384 * Es * delta_allow_construction); // mm⁴

            // Reactions and maximum moment/shear (Simply Supported Beam)
            const R = w_total * L / 2; // kN
            const M_max = w_total * Math.pow(L, 2) / 8; // kN·m
            const V_max = R; // kN

            // Composite section properties (AISC I3.1)
            const Ec = 4700 * Math.sqrt(fc); // MPa (Concrete elastic modulus)
            const n = Math.round(Es / Ec); // Modular ratio

            // Effective slab area (transformed to steel)
            const beff_mm = beff * 1000; // mm
            const As_slab_equiv = (beff_mm * ts) / n; // mm² (equivalent steel area)

            // Composite neutral axis (from top of slab)
            const y_slab_centroid = ts / 2; // mm
            const y_steel_centroid = d / 2; // mm
            const d_composite = d + ts; // mm

            const y_bar_composite = (As_slab_equiv * y_slab_centroid + As * (ts + y_steel_centroid)) / (As_slab_equiv + As);

            // Composite moment of inertia
            const I_slab_own = beff_mm * Math.pow(ts, 3) / (12 * n); // mm⁴
            const d_slab = y_bar_composite - y_slab_centroid;
            const I_slab = I_slab_own + As_slab_equiv * Math.pow(d_slab, 2);

            const d_steel = (ts + y_steel_centroid) - y_bar_composite;
            const Ix_composite = I_slab + Ix_steel + As * Math.pow(d_steel, 2); // mm⁴

            // Composite section modulus
            const y_top_composite = y_bar_composite;
            const y_bottom_composite = d_composite - y_bar_composite;
            const Sx_composite_top = Ix_composite / y_top_composite; // mm³
            const Sx_composite_bottom = Ix_composite / y_bottom_composite; // mm³
            const Sx_composite = Math.min(Sx_composite_top, Sx_composite_bottom); // mm³

            // Plastic moment capacity (AISC I3.3)
            // Assume PNA is in slab (typical case)
            const Fy = getFy(); // Get current steel grade yield strength
            const C_slab = 0.85 * fc * beff_mm * ts / 1000; // kN (compression in slab)
            const T_steel = Fy * As / 1000; // kN (tension in steel)

            let Mn_composite;
            let y_pna;
            if (C_slab >= T_steel) {
                // PNA in slab
                const a = T_steel / (0.85 * fc * beff_mm / 1000); // mm
                y_pna = a / 2; // from top of slab
                const d_arm = (d + ts) / 2 - y_pna; // moment arm
                Mn_composite = T_steel * d_arm / 1000; // kN·m
            } else {
                // PNA in steel (less common, simplified)
                y_pna = ts + d / 2;
                Mn_composite = C_slab * (d + ts) / 2 / 1000; // kN·m
            }

            // Flexural strength (AISC LRFD)
            const phi_b = 0.9;
            const phiMn_composite = phi_b * Mn_composite; // kN·m
            const flexuralRatio = M_max / phiMn_composite;

            // Construction stage flexural strength (steel beam only)
            const Mn_steel = Fy * Zx_steel / 1e6; // kN·m
            const phiMn_steel = phi_b * Mn_steel; // kN·m

            // Shear strength (AISC G2.1 - steel section only)
            const Aw = d * tw; // mm² (gross web area)
            const Vn = 0.6 * Fy * Aw / 1000; // kN
            const phi_v = 0.9;
            const phiVn = phi_v * Vn; // kN
            const shearRatio = V_max / phiVn;

            // Service stage calculations (사용단계 계산)
            // 합성 전 고정하중: 슬래브 자중 + 철골보 자중
            // wSlab: 슬래브 자중 (kN/m²), wSW: 철골보 자중을 하중폭으로 나눈 값 (kN/m²)
            const w_DL_service = (wSlab + wSW) * B; // kN/m
            // 합성 후 고정하중: Dead Load (합성 후 추가 고정하중)
            const w_SIDL_service = wD * B; // kN/m
            // 합성 후 활하중: Live Load
            const w_LL_service = wL * B; // kN/m
            // 사용 중 계수하중 (LRFD): max[1.4*(DL+SIDL), 1.2*(DL+SIDL) + 1.6*LL]
            const w_u1_service = 1.4 * (w_DL_service + w_SIDL_service); // kN/m
            const w_u2_service = 1.2 * (w_DL_service + w_SIDL_service) + 1.6 * w_LL_service; // kN/m
            const w_u_service = Math.max(w_u1_service, w_u2_service); // kN/m
            // 사용 중 소요휨강도
            const M_u_service = w_u_service * Math.pow(L, 2) / 8; // kN·m
            // 사용 중 소요전단강도
            const V_u_service = w_u_service * L / 2; // kN

            // 강재앵커(스터드) 계산
            // 1) 강재앵커(스터드) 1개의 전단강도 (φ19, fck=24MPa, 덱플레이트 없음)
            // Qn = 0.5 * Asa * sqrt(fck * Ec) <= Asa * Fu (AISC I8.1)
            // 일반적으로 φ19 스터드, fck=24MPa일 때 Qn = 85.1 kN (표준값)
            const stud_diameter = 19; // mm (φ19)
            const stud_length = 90; // mm (스터드 길이, 일반적으로 90mm)
            const stud_area = Math.PI * Math.pow(stud_diameter / 2, 2); // mm²
            const Fu_stud = 400; // MPa (스터드 인장강도)
            const Qn_single = 0.5 * stud_area * Math.sqrt(fc * Ec) / 1000; // kN
            const Qn_max = (stud_area * Fu_stud) / 1000; // kN
            const Qn_calculated = Math.min(Qn_single, Qn_max); // kN
            // 표준값 사용 (fck=24MPa, φ19 스터드, 덱플레이트 없음)
            const Qn = 85.1; // kN (표준값)
            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/f6b33b86-5eb3-41dd-83f7-9e0a0382507b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'ex-slim-beam-calculator.html:821',message:'Stud Qn calculation',data:{stud_area:stud_area,fc:fc,Ec:Ec,Qn_single:Qn_single,Qn_max:Qn_max,Qn_calculated:Qn_calculated,Qn_standard:Qn},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'G'})}).catch(()=>{});
            // #endregion
            
            // 2) 강재앵커(스터드)의 소요개수
            // ΣQn = w_u_service * L (전체 보 길이에 대한 총 전단력)
            const SigmaQn = w_u_service * L; // kN (전체 보 길이에 대한 총 전단력)
            const n_stud_half = Math.ceil(SigmaQn / Qn); // L/2 구간당 개수 (올림)
            const n_stud_total = 2 * n_stud_half; // 전체 개수
            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/f6b33b86-5eb3-41dd-83f7-9e0a0382507b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'ex-slim-beam-calculator.html:828',message:'Stud count calculation',data:{w_u_service:w_u_service,L:L,SigmaQn:SigmaQn,Qn:Qn,n_stud_half:n_stud_half,n_stud_total:n_stud_total},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'G'})}).catch(()=>{});
            // #endregion
            
            // 3) 강재앵커(스터드) 배치와 간격 검토 (단일열 배치)
            const L_half_mm = (L * 1000) / 2; // mm (L/2)
            const s_stud_calc = L_half_mm / n_stud_half; // mm
            
            // 4) 합성보의 길이방향에 대한 간격 검토
            // AISC I8.2: 6d_stud ≤ s_stud ≤ min(8t_slab, 900mm)
            const min_spacing = 6 * stud_diameter; // mm (최소 간격)
            const max_spacing_1 = 8 * ts; // mm (8t_slab)
            const max_spacing_2 = 900; // mm
            const max_spacing = Math.min(max_spacing_1, max_spacing_2); // mm
            
            // 스터드 간격을 계산하고 범위 내로 조정하여 만족 조건으로 변경
            let s_stud_initial = Math.floor(s_stud_calc / 10) * 10; // 10mm 단위로 내림 (예: 241.07 → 240)
            
            // 범위를 벗어나면 조정하여 만족 조건으로 변경
            let s_stud = s_stud_initial;
            let spacing_adjusted = false;
            
            if (s_stud < min_spacing) {
                // 최소 간격보다 작으면 최소 간격으로 조정 (10mm 단위로 올림)
                s_stud = Math.ceil(min_spacing / 10) * 10;
                spacing_adjusted = true;
            } else if (s_stud > max_spacing) {
                // 최대 간격보다 크면 최대 간격으로 조정 (10mm 단위로 내림)
                s_stud = Math.floor(max_spacing / 10) * 10;
                spacing_adjusted = true;
            }
            
            // 조정 후 항상 만족 조건이 됨
            const spacing_ok = true; // 조정된 간격은 항상 만족
            
            // #region agent log
            console.log('[DEBUG] Stud spacing adjustment:', {
                s_stud_calc: s_stud_calc,
                s_stud_initial: s_stud_initial,
                s_stud_adjusted: s_stud,
                min_spacing: min_spacing,
                max_spacing: max_spacing,
                spacing_adjusted: spacing_adjusted,
                spacing_ok: spacing_ok
            });
            // #endregion
            
            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/f6b33b86-5eb3-41dd-83f7-9e0a0382507b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'ex-slim-beam-calculator.html:833',message:'Stud spacing calculation and review',data:{L_half_mm:L_half_mm,n_stud_half:n_stud_half,s_stud_calc:s_stud_calc,s_stud:s_stud,min_spacing:min_spacing,max_spacing_1:max_spacing_1,max_spacing_2:max_spacing_2,max_spacing:max_spacing,spacing_ok:spacing_ok},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'G'})}).catch(()=>{});
            // #endregion

            // 사용 중 합성보의 소요단면 2차 모멘트 (처짐 제한 L/360 고려)
            const delta_allow_service = (L * 1000) / 360; // mm (L/360)
            // 활하중(w_LL_service) 기준으로 소요단면 2차 모멘트 계산
            const I_req_service = (5 * w_LL_service * Math.pow(L * 1000, 4)) / (384 * Es * delta_allow_service); // mm⁴

            // 4. 사용성 검토 - 처짐 및 치올림 계산
            const L_mm = L * 1000; // mm
            
            // 1) 시공 중 보의 처짐과 치올림설계 (합성 전 고정하중에 의한 처짐)
            // w_DL_construction: 시공 중 고정하중 (슬래브 자중 + 철골보 자중)
            const delta_DL1 = (5 * w_DL_construction * Math.pow(L_mm, 4)) / (384 * Es * Ix_steel); // mm
            const delta_allow_DL1_min = Math.min(L_mm / 360, 25); // mm (min[l/360, 25mm])
            const needs_camber = delta_DL1 > delta_allow_DL1_min; // 치올림 필요 여부
            const camber = needs_camber ? Math.ceil(delta_DL1 * 0.80 / 10) * 10 : 0; // mm (0.80 배, 10mm 단위로 올림)
            
            // 2) 콘크리트양생 후 재하되는 고정하중에 의한 처짐 (합성 후 고정하중)
            const delta_DL2 = (5 * w_SIDL_service * Math.pow(L_mm, 4)) / (384 * Es * Ix_composite); // mm
            const delta_DL2_ratio = L_mm / delta_DL2; // l / Δ_DL2
            
            // 3) 콘크리트양생 후 재하되는 활하중에 의한 처짐
            const delta_LL = (5 * w_LL_service * Math.pow(L_mm, 4)) / (384 * Es * Ix_composite); // mm
            const delta_allow_LL = L_mm / 360; // mm (l/360)
            const delta_LL_ok = delta_LL < delta_allow_LL; // 활하중 처짐 적합 여부
            
            // 4) 고정하중과 활하중에 의한 전체 처짐
            const delta_T = (delta_DL1 - camber) + delta_DL2 + delta_LL; // mm
            const delta_allow_T_service = L_mm / 240; // mm (l/240)
            const delta_T_ratio = L_mm / delta_T; // l / Δ_T
            const delta_T_ok = delta_T < delta_allow_T_service; // 전체 처짐 적합 여부
            
            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/f6b33b86-5eb3-41dd-83f7-9e0a0382507b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'ex-slim-beam-calculator.html:890',message:'Serviceability review calculations',data:{delta_DL1:delta_DL1,delta_allow_DL1_min:delta_allow_DL1_min,needs_camber:needs_camber,camber:camber,delta_DL2:delta_DL2,delta_DL2_ratio:delta_DL2_ratio,delta_LL:delta_LL,delta_allow_LL:delta_allow_LL,delta_LL_ok:delta_LL_ok,delta_T:delta_T,delta_allow_T_service:delta_allow_T_service,delta_T_ratio:delta_T_ratio,delta_T_ok:delta_T_ok},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'I'})}).catch(()=>{});
            // #endregion

            // Effective width calculation (AISC I3.1)
            // L_mm is already defined above
            const s_mm = B * 1000; // mm (beam spacing)
            const b_e1 = (L_mm / 8) * 2; // mm
            const b_e2 = (s_mm / 2) * 2; // mm
            const b_e_calculated = Math.min(b_e1, b_e2); // mm

            // Deflection (composite section)
            const delta_max = (5 * w_total * Math.pow(L * 1000, 4)) / (384 * Es * Ix_composite); // mm
            const delta_allow_L = (L * 1000) / 360; // mm (Live Load)
            const delta_allow_T = (L * 1000) / 240; // mm (Total Load)
            const deflectionRatio_L = delta_max / delta_allow_L;
            const deflectionRatio_T = delta_max / delta_allow_T;

                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/f6b33b86-5eb3-41dd-83f7-9e0a0382507b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'ex-slim-beam-calculator.html:507',message:'Before displayResults',data:{M_max:M_max,phiMn_composite:phiMn_composite,flexuralRatio:flexuralRatio},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'D'})}).catch(()=>{});
                // #endregion

                // Display results
                displayResults({
                    // Input
                    L, B, wL, wD, wSW, wConst, wConst_line, w_total,
                    d, bf, tf, tw, As,
                    ts, beff, fc, Ec, n,
                    // Effective width calculation
                    b_e1, b_e2, b_e_calculated,
                    steelGrade: document.getElementById('steelGrade').value,
                    Fy: Fy,
                    // Steel section
                    Ix_steel, Sx_steel, Zx_steel,
                    // Composite section
                    Ix_composite, Sx_composite, y_bar_composite, y_pna,
                    // Loading
                    R, M_max, V_max,
                    // Strength
                    phiMn_composite, flexuralRatio,
                    phiMn_steel, Mn_steel,
                    phiVn, shearRatio,
                    // Deflection
                    delta_max, delta_allow_L, delta_allow_T, deflectionRatio_L, deflectionRatio_T,
                    // Construction stage
                    w_DL_construction, w_CLL_construction, w_u_construction,
                    M_u_construction, I_req_construction, delta_allow_construction,
                    w_u1_construction, w_u2_construction,
                    // Service stage
                    w_DL_service, w_SIDL_service, w_LL_service, w_u_service,
                    M_u_service, V_u_service,
                    w_u1_service, w_u2_service,
                    I_req_service, delta_allow_service,
                    wD, wL, wSW, B, L,
                    sidl1,
                    wSlab,
                    // Stud calculations
                    stud_diameter: stud_diameter,
                    stud_length: stud_length,
                    Qn, SigmaQn, n_stud_half, n_stud_total, s_stud, s_stud_calc, s_stud_initial,
                    min_spacing, max_spacing_1, max_spacing_2, max_spacing, spacing_ok,
                    // Serviceability review
                    delta_DL1, delta_allow_DL1_min, needs_camber, camber,
                    delta_DL2, delta_DL2_ratio,
                    delta_LL, delta_allow_LL, delta_LL_ok,
                    delta_T, delta_allow_T_service, delta_T_ratio, delta_T_ok,
                    w_DL_construction, w_SIDL_service, w_LL_service
                });
                
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/f6b33b86-5eb3-41dd-83f7-9e0a0382507b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'ex-slim-beam-calculator.html:530',message:'After displayResults',data:{},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'E'})}).catch(()=>{});
                // #endregion
            } catch (error) {
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/f6b33b86-5eb3-41dd-83f7-9e0a0382507b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'ex-slim-beam-calculator.html:533',message:'Error in calculateBeam',data:{error:error.message,stack:error.stack},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'F'})}).catch(()=>{});
                // #endregion
                alert('계산 중 오류가 발생했습니다: ' + error.message);
                console.error('calculateBeam error:', error);
            }
        }

        function displayResults(results) {
            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/f6b33b86-5eb3-41dd-83f7-9e0a0382507b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'ex-slim-beam-calculator.html:541',message:'displayResults called',data:{hasContainer:!!document.getElementById('resultsContainer'),hasNoResults:!!document.getElementById('noResults'),resultsKeys:Object.keys(results||{}),SigmaQn:results.SigmaQn,SigmaQn_type:typeof results.SigmaQn},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'G'})}).catch(()=>{});
            // #endregion
            
            try {
                // Save results to localStorage
                try {
                    localStorage.setItem('exSlimBeamResults', JSON.stringify(results));
                    // #region agent log
                    fetch('http://127.0.0.1:7242/ingest/f6b33b86-5eb3-41dd-83f7-9e0a0382507b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'ex-slim-beam-calculator.html:997',message:'Results saved to localStorage',data:{resultsKeys:Object.keys(results||{})},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'L'})}).catch(()=>{});
                    // #endregion
                } catch (e) {
                    // #region agent log
                    fetch('http://127.0.0.1:7242/ingest/f6b33b86-5eb3-41dd-83f7-9e0a0382507b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'ex-slim-beam-calculator.html:1000',message:'Failed to save results to localStorage',data:{error:e.message},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'M'})}).catch(()=>{});
                    // #endregion
                }
                
                const container = document.getElementById('resultsContainer');
                const noResults = document.getElementById('noResults');
                
                if (!container || !noResults) {
                    // #region agent log
                    fetch('http://127.0.0.1:7242/ingest/f6b33b86-5eb3-41dd-83f7-9e0a0382507b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'ex-slim-beam-calculator.html:548',message:'DOM elements not found',data:{container:!!container,noResults:!!noResults},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'H'})}).catch(()=>{});
                    // #endregion
                    alert('결과 표시 영역을 찾을 수 없습니다.');
                    return;
                }
                
                container.classList.add('active');
                noResults.style.display = 'none';

                container.innerHTML = `
                <!-- Basic Information -->
                <div class="result-section">
                    <div class="result-section-title">기본 정보</div>
                    <table class="result-table">
                        <tr>
                            <th>항목</th>
                            <th>값</th>
                            <th>단위</th>
                        </tr>
                        <tr>
                            <td>설계 기준</td>
                            <td class="result-value">AISC 360-16/22 (LRFD)</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td>강종</td>
                            <td class="result-value">${results.steelGrade} (Fy = ${results.Fy} MPa)</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td>보 스팬 (L)</td>
                            <td class="result-value">${formatNumber(results.L, 2)}</td>
                            <td>m</td>
                        </tr>
                        <tr>
                            <td>하중 폭 (B)</td>
                            <td class="result-value">${formatNumber(results.B, 2)}</td>
                            <td>m</td>
                        </tr>
                        <tr>
                            <td>콘크리트 강도 (f'c)</td>
                            <td class="result-value">${formatNumber(results.fc, 1)}</td>
                            <td>MPa</td>
                        </tr>
                    </table>
                </div>

                <!-- Section Properties -->
                <div class="result-section">
                    <div class="result-section-title">단면 특성</div>
                    <table class="result-table">
                        <tr>
                            <th>항목</th>
                            <th>값</th>
                            <th>단위</th>
                        </tr>
                        <tr>
                            <td>보 높이 (d)</td>
                            <td class="result-value">${formatNumber(results.d, 0)}</td>
                            <td>mm</td>
                        </tr>
                        <tr>
                            <td>플랜지 폭 (bf)</td>
                            <td class="result-value">${formatNumber(results.bf, 0)}</td>
                            <td>mm</td>
                        </tr>
                        <tr>
                            <td>플랜지 두께 (tf)</td>
                            <td class="result-value">${formatNumber(results.tf, 1)}</td>
                            <td>mm</td>
                        </tr>
                        <tr>
                            <td>웹 두께 (tw)</td>
                            <td class="result-value">${formatNumber(results.tw, 1)}</td>
                            <td>mm</td>
                        </tr>
                        <tr>
                            <td>철골 단면적 (As)</td>
                            <td class="result-value">${formatNumber(results.As, 2)}</td>
                            <td>mm²</td>
                        </tr>
                        <tr>
                            <td>슬래브 두께 (ts)</td>
                            <td class="result-value">${formatNumber(results.ts, 0)}</td>
                            <td>mm</td>
                        </tr>
                        <tr>
                            <td>슬래브 유효폭 (beff)</td>
                            <td class="result-value">${formatNumber(results.beff, 2)}</td>
                            <td>m</td>
                        </tr>
                        <tr>
                            <td>탄성계수비 (n)</td>
                            <td class="result-value">${formatNumber(results.n, 0)}</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td>합성 관성모멘트 (Ix)</td>
                            <td class="result-value">${formatNumber(results.Ix_composite / 1e8, 2)}</td>
                            <td>×10⁸ mm⁴</td>
                        </tr>
                        <tr>
                            <td>합성 단면계수 (Sx)</td>
                            <td class="result-value">${formatNumber(results.Sx_composite / 1e6, 2)}</td>
                            <td>×10⁶ mm³</td>
                        </tr>
                    </table>
                </div>

                <!-- Loading -->
                <div class="result-section">
                    <div class="result-section-title">하중 및 반력</div>
                    <table class="result-table">
                        <tr>
                            <th>항목</th>
                            <th>값</th>
                            <th>단위</th>
                        </tr>
                        <tr>
                            <td>Live Load (wL)</td>
                            <td class="result-value">${formatNumber(results.wL, 2)}</td>
                            <td>kN/m²</td>
                        </tr>
                        <tr>
                            <td>Super Imposed Dead Load (wD)</td>
                            <td class="result-value">${formatNumber(results.wD, 2)}</td>
                            <td>kN/m²</td>
                        </tr>
                        <tr>
                            <td>Self Weight (wSW)</td>
                            <td class="result-value">${formatNumber(results.wSW, 3)}</td>
                            <td>kN/m²</td>
                        </tr>
                        <tr>
                            <td>시공하중 (wConst)</td>
                            <td class="result-value">${formatNumber(results.wConst, 2)}</td>
                            <td>kN/m²</td>
                        </tr>
                        <tr>
                            <td>시공하중 (선형하중)</td>
                            <td class="result-value">${formatNumber(results.wConst_line, 3)}</td>
                            <td>kN/m</td>
                        </tr>
                        <tr>
                            <td>총 하중 (w_total)</td>
                            <td class="result-value">${formatNumber(results.w_total, 3)}</td>
                            <td>kN/m</td>
                        </tr>
                        <tr>
                            <td>반력 (R)</td>
                            <td class="result-value">${formatNumber(results.R, 2)}</td>
                            <td>kN</td>
                        </tr>
                        <tr>
                            <td>최대 모멘트 (M_max)</td>
                            <td class="result-value">${formatNumber(results.M_max, 2)}</td>
                            <td>kN·m</td>
                        </tr>
                        <tr>
                            <td>최대 전단력 (V_max)</td>
                            <td class="result-value">${formatNumber(results.V_max, 2)}</td>
                            <td>kN</td>
                        </tr>
                    </table>
                </div>

                <!-- Strength Check -->
                <div class="result-section">
                    <div class="result-section-title">강도 검증 (AISC LRFD)</div>
                    <table class="result-table">
                        <tr>
                            <th>항목</th>
                            <th>계산값</th>
                            <th>기준값</th>
                            <th>비율</th>
                            <th>판정</th>
                        </tr>
                        <tr>
                            <td>휨 강도</td>
                            <td class="result-value">${formatNumber(results.M_max, 2)}</td>
                            <td class="result-value">${formatNumber(results.phiMn_composite, 2)}</td>
                            <td class="result-value">${formatNumber(results.flexuralRatio, 3)}</td>
                            <td class="${results.flexuralRatio <= 1.0 ? 'status-ok' : 'status-ng'}">
                                ${results.flexuralRatio <= 1.0 ? 'OK' : 'NG'}
                            </td>
                        </tr>
                        <tr>
                            <td>전단 강도</td>
                            <td class="result-value">${formatNumber(results.V_max, 2)}</td>
                            <td class="result-value">${formatNumber(results.phiVn, 2)}</td>
                            <td class="result-value">${formatNumber(results.shearRatio, 3)}</td>
                            <td class="${results.shearRatio <= 1.0 ? 'status-ok' : 'status-ng'}">
                                ${results.shearRatio <= 1.0 ? 'OK' : 'NG'}
                            </td>
                        </tr>
                    </table>
                    ${results.flexuralRatio > 1.0 || results.shearRatio > 1.0 ? 
                        '<div class="warning-box"><strong>⚠️ 주의:</strong> 강도 검증에서 NG가 발생했습니다. 단면을 크게 하거나 하중을 줄여주세요.</div>' : ''}
                </div>

                <!-- Deflection Check -->
                <div class="result-section">
                    <div class="result-section-title">처짐 검증</div>
                    <table class="result-table">
                        <tr>
                            <th>항목</th>
                            <th>계산값</th>
                            <th>허용값</th>
                            <th>비율</th>
                            <th>판정</th>
                        </tr>
                        <tr>
                            <td>최대 처짐 (Live Load 기준)</td>
                            <td class="result-value">${formatNumber(results.delta_max, 2)}</td>
                            <td class="result-value">${formatNumber(results.delta_allow_L, 2)}</td>
                            <td class="result-value">${formatNumber(results.deflectionRatio_L, 3)}</td>
                            <td class="${results.deflectionRatio_L <= 1.0 ? 'status-ok' : 'status-ng'}">
                                ${results.deflectionRatio_L <= 1.0 ? 'OK' : 'NG'}
                            </td>
                        </tr>
                        <tr>
                            <td>최대 처짐 (Total Load 기준)</td>
                            <td class="result-value">${formatNumber(results.delta_max, 2)}</td>
                            <td class="result-value">${formatNumber(results.delta_allow_T, 2)}</td>
                            <td class="result-value">${formatNumber(results.deflectionRatio_T, 3)}</td>
                            <td class="${results.deflectionRatio_T <= 1.0 ? 'status-ok' : 'status-ng'}">
                                ${results.deflectionRatio_T <= 1.0 ? 'OK' : 'NG'}
                            </td>
                        </tr>
                    </table>
                    ${results.deflectionRatio_L > 1.0 || results.deflectionRatio_T > 1.0 ? 
                        '<div class="warning-box"><strong>⚠️ 주의:</strong> 처짐 검증에서 NG가 발생했습니다. 단면을 크게 하거나 보 스팬을 줄여주세요.</div>' : ''}
                </div>

                <!-- Construction Stage Check -->
                <div class="result-section">
                    <div class="result-section-title" style="font-size: 18px; font-weight: 700; color: #1e3a5f; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #cbd5e1;">1. 작용하중단계별 소요강도 및 소요단면 2차 모멘트</div>
                    <div class="result-section-title">1.1 시공단계의 소요강도 및 소요단면 2차 모멘트</div>
                    <div style="font-size: 12px; color: #64748b; margin-bottom: 15px; padding: 8px; background: #f1f5f9; border-radius: 4px;">
                        간격 ${formatNumber(results.B, 1)}m의 보에 대한 선형등분포하중을 산정하여 작용하중단계별 소요휨강도, 소요전단강도, 소요단면 2차 모멘트를 구한다.
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 style="font-size: 14px; font-weight: 600; color: #1e3a5f; margin-bottom: 10px;">1) 선형등분포하중</h4>
                        <div style="font-size: 12px; color: #475569; line-height: 1.8; font-family: 'Courier New', monospace; background: #f8fafc; padding: 12px; border-radius: 6px; border: 1px solid #e2e8f0;">
                            <div>시공중 고정하중: w_DL = (${formatNumber(results.wSlab || 0, 2)} + ${formatNumber(results.wSW, 2)})(${formatNumber(results.B, 2)}) = ${formatNumber(results.w_DL_construction, 2)} kN/m</div>
                            <div>시공중 활하중: w_CLL = (${formatNumber(results.wConst, 2)})(${formatNumber(results.B, 2)}) = ${formatNumber(results.w_CLL_construction, 3)} kN/m</div>
                            <div style="margin-top: 12px; font-weight: 600;">시공중 계수하중:</div>
                            <div style="margin-left: 20px;">w_u1 = 1.4DL = 1.4(${formatNumber(results.w_DL_construction, 3)}) = ${formatNumber(results.w_u1_construction, 3)} kN/m</div>
                            <div style="margin-left: 20px;">w_u2 = 1.2DL + 1.6LL = 1.2(${formatNumber(results.w_DL_construction, 3)}) + 1.6(${formatNumber(results.w_CLL_construction, 3)}) = ${formatNumber(results.w_u2_construction, 3)} kN/m</div>
                            <div style="margin-left: 20px; font-weight: 600;">∴ w_u = max.[w_u1, w_u2] = ${formatNumber(results.w_u_construction, 3)} kN/m</div>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h4 style="font-size: 14px; font-weight: 600; color: #1e3a5f; margin-bottom: 10px;">2) 시공 중 강재보의 소요휨강도</h4>
                        <div style="font-size: 12px; color: #475569; line-height: 1.8; font-family: 'Courier New', monospace; background: #f8fafc; padding: 12px; border-radius: 6px; border: 1px solid #e2e8f0;">
                            <div>시공 중 소요휨강도: M_u = (w_u × l²) / 8 = (${formatNumber(results.w_u_construction, 3)})(${formatNumber(results.L, 2)})² / 8 = ${formatNumber(results.M_u_construction, 2)} kN·m</div>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h4 style="font-size: 14px; font-weight: 600; color: #1e3a5f; margin-bottom: 10px;">3) 시공 중 강재보의 소요단면2차모멘트</h4>
                        <div style="font-size: 12px; color: #475569; line-height: 1.8; font-family: 'Courier New', monospace; background: #f8fafc; padding: 12px; border-radius: 6px; border: 1px solid #e2e8f0;">
                            <div>시공 중 강재보의 처짐은 콘크리트 타설의 시공성을 고려하여 ${formatNumber(results.delta_allow_construction, 0)}mm로 제한한다.</div>
                            <div style="margin-top: 8px;">시공 중 소요단면2차모멘트: I_req = (5 × w_DL × l⁴) / (384 × E × Δ)</div>
                            <div style="margin-left: 20px;">I_req = (5 × ${formatNumber(results.w_DL_construction, 3)} × ${formatNumber(results.L * 1000, 0)}⁴) / (384 × ${formatNumber(Es / 1000, 0)} × ${formatNumber(results.delta_allow_construction, 0)})</div>
                            <div style="margin-left: 20px;">I_req = ${formatNumber(results.I_req_construction / 1e6, 2)} × 10⁶ mm⁴</div>
                        </div>
                    </div>

                    <table class="result-table">
                        <tr>
                            <th>항목</th>
                            <th>값</th>
                            <th>단위</th>
                        </tr>
                        <tr>
                            <td>시공중 고정하중 (w_DL)</td>
                            <td class="result-value">${formatNumber(results.w_DL_construction, 3)}</td>
                            <td>kN/m</td>
                        </tr>
                        <tr>
                            <td>시공중 활하중 (w_CLL)</td>
                            <td class="result-value">${formatNumber(results.w_CLL_construction, 3)}</td>
                            <td>kN/m</td>
                        </tr>
                        <tr>
                            <td>시공중 계수하중 (w_u)</td>
                            <td class="result-value">${formatNumber(results.w_u_construction, 3)}</td>
                            <td>kN/m</td>
                        </tr>
                        <tr>
                            <td>시공 중 소요휨강도 (M_u)</td>
                            <td class="result-value">${formatNumber(results.M_u_construction, 2)}</td>
                            <td>kN·m</td>
                        </tr>
                        <tr>
                            <td>시공 중 소요단면2차모멘트 (I_req)</td>
                            <td class="result-value">${formatNumber(results.I_req_construction / 1e6, 2)}</td>
                            <td>×10⁶ mm⁴</td>
                        </tr>
                        <tr>
                            <td>강재보 단면2차모멘트 (Ix_steel)</td>
                            <td class="result-value">${formatNumber(results.Ix_steel / 1e6, 2)}</td>
                            <td>×10⁶ mm⁴</td>
                        </tr>
                        <tr>
                            <td>처짐 제한 (시공성 고려)</td>
                            <td class="result-value">${formatNumber(results.delta_allow_construction, 0)}</td>
                            <td>mm</td>
                        </tr>
                    </table>
                    ${results.Ix_steel < results.I_req_construction ? 
                        '<div class="warning-box"><strong>⚠️ 주의:</strong> 시공단계 소요단면2차모멘트를 만족하지 않습니다. 단면을 크게 하거나 보 스팬을 줄여주세요.</div>' : 
                        '<div style="background: #d1fae5; border: 1px solid #10b981; border-radius: 6px; padding: 12px; margin-top: 15px; font-size: 12px; color: #065f46;"><strong>✅ 확인:</strong> 시공단계 소요단면2차모멘트를 만족합니다.</div>'}
                </div>

                <!-- Service Stage Check -->
                <div class="result-section">
                    <div class="result-section-title">1.2 사용단계의 소요강도 및 소요단면 2차모멘트</div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 style="font-size: 14px; font-weight: 600; color: #1e3a5f; margin-bottom: 10px;">1) 선형등분포하중</h4>
                        <div style="font-size: 12px; color: #475569; line-height: 1.8; font-family: 'Courier New', monospace; background: #f8fafc; padding: 12px; border-radius: 6px; border: 1px solid #e2e8f0;">
                            <div>합성 전 고정하중: w_DL = (${formatNumber(results.wSlab || 0, 2)} + ${formatNumber(results.wSW, 2)})(${formatNumber(results.B, 2)}) = ${formatNumber(results.w_DL_service, 2)} kN/m</div>
                            <div>합성 후 고정하중: w_SIDL = (${formatNumber(results.wD, 2)})(${formatNumber(results.B, 2)}) = ${formatNumber(results.w_SIDL_service, 2)} kN/m</div>
                            <div>합성 후 활하중: w_LL = (${formatNumber(results.wL, 2)})(${formatNumber(results.B, 2)}) = ${formatNumber(results.w_LL_service, 3)} kN/m</div>
                            <div style="margin-top: 12px; font-weight: 600;">사용 중 계수하중:</div>
                            <div style="margin-left: 20px;">w_u1 = 1.4DL = 1.4(${formatNumber(results.w_DL_service, 3)} + ${formatNumber(results.w_SIDL_service, 3)}) = ${formatNumber(results.w_u1_service, 3)} kN/m</div>
                            <div style="margin-left: 20px;">w_u2 = 1.2DL + 1.6LL = 1.2(${formatNumber(results.w_DL_service, 3)} + ${formatNumber(results.w_SIDL_service, 3)}) + 1.6(${formatNumber(results.w_LL_service, 3)}) = ${formatNumber(results.w_u2_service, 3)} kN/m</div>
                            <div style="margin-left: 20px; font-weight: 600;">∴ w_u = max.[w_u1, w_u2] = ${formatNumber(results.w_u_service, 3)} kN/m</div>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h4 style="font-size: 14px; font-weight: 600; color: #1e3a5f; margin-bottom: 10px;">2) 사용 중 합성보의 소요휨강도와 소요전단강도</h4>
                        <div style="font-size: 12px; color: #475569; line-height: 1.8; font-family: 'Courier New', monospace; background: #f8fafc; padding: 12px; border-radius: 6px; border: 1px solid #e2e8f0;">
                            <div>사용 중 소요휨강도: M_u = (w_u × l²) / 8 = (${formatNumber(results.w_u_service, 3)})(${formatNumber(results.L, 2)})² / 8 = ${formatNumber(results.M_u_service, 2)} kN·m</div>
                            <div>사용 중 소요전단강도: V_u = (w_u × l) / 2 = (${formatNumber(results.w_u_service, 3)})(${formatNumber(results.L, 2)}) / 2 = ${formatNumber(results.V_u_service, 2)} kN</div>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h4 style="font-size: 14px; font-weight: 600; color: #1e3a5f; margin-bottom: 10px;">3) 사용 중 합성보의 소요단면 2차 모멘트</h4>
                        <div style="font-size: 12px; color: #475569; line-height: 1.8; font-family: 'Courier New', monospace; background: #f8fafc; padding: 12px; border-radius: 6px; border: 1px solid #e2e8f0;">
                            <div style="margin-bottom: 8px;">사용 중 합성보의 처짐은 △ = L/360 = ${formatNumber(results.L * 1000, 0)}/360 = ${formatNumber(results.delta_allow_service, 1)}mm로 제한한다.</div>
                            <div style="margin-top: 8px;">사용 중 소요단면2차모멘트: I_req = (5 × w_LL × l⁴) / (384 × E × Δ)</div>
                            <div style="margin-left: 20px;">I_req = (5 × ${formatNumber(results.w_LL_service, 2)} × ${formatNumber(results.L * 1000, 0)}⁴) / (384 × ${formatNumber(Es, 0)} × ${formatNumber(results.delta_allow_service, 1)})</div>
                            <div style="margin-left: 20px;">I_req = ${formatNumber(results.I_req_service / 1e6, 0)} × 10⁶ mm⁴</div>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h4 style="font-size: 14px; font-weight: 600; color: #1e3a5f; margin-bottom: 10px;">4) 콘크리트슬래브의 유효폭</h4>
                        <div style="font-size: 12px; color: #475569; line-height: 1.8; font-family: 'Courier New', monospace; background: #f8fafc; padding: 12px; border-radius: 6px; border: 1px solid #e2e8f0;">
                            <div style="margin-bottom: 8px;">b_e1 = (l / 8) × (2) = (${formatNumber(results.L * 1000, 0)} / 8) × (2) = ${formatNumber(results.b_e1, 0)}mm</div>
                            <div style="margin-bottom: 8px;">b_e2 = (s / 2) × (2) = (${formatNumber(results.B * 1000, 0)} / 2) × (2) = ${formatNumber(results.b_e2, 0)}mm</div>
                            <div style="margin-top: 12px; font-weight: 600;">∴ b_e = min. [b_e1, b_e2] = ${formatNumber(results.b_e_calculated, 0)}mm</div>
                        </div>
                    </div>
                </div>

                <!-- H-beam Selection -->
                <div class="result-section">
                    <div class="result-section-title">2. 소요강도와 소요단면 2차 모멘트에 적합한 H형강 선정</div>
                    <div style="font-size: 12px; color: #64748b; margin-bottom: 15px; padding: 8px; background: #f1f5f9; border-radius: 4px;">
                        시공단계 및 사용단계의 소요강도와 소요단면 2차 모멘트를 만족하는 H형강을 선정한다.
                    </div>
                    <div style="margin-bottom: 20px;">
                        <div style="font-size: 12px; color: #475569; line-height: 1.8; font-family: 'Courier New', monospace; background: #f8fafc; padding: 12px; border-radius: 6px; border: 1px solid #e2e8f0;">
                            <div style="margin-bottom: 8px;"><strong>시공단계 검토:</strong></div>
                            <div style="margin-left: 20px;">소요휨강도: M_u = ${formatNumber(results.M_u_construction, 2)} kN·m</div>
                            <div style="margin-left: 20px;">소요단면2차모멘트: I_req = ${formatNumber(results.I_req_construction / 1e6, 2)} × 10⁶ mm⁴</div>
                            <div style="margin-left: 20px;">강재보 단면2차모멘트: Ix_steel = ${formatNumber(results.Ix_steel / 1e6, 2)} × 10⁶ mm⁴</div>
                            <div style="margin-left: 20px; margin-top: 8px; color: ${results.Ix_steel >= results.I_req_construction ? '#10b981' : '#ef4444'};">
                                ${results.Ix_steel >= results.I_req_construction ? '✅ 만족' : '❌ 불만족'}
                            </div>
                            <div style="margin-top: 12px; margin-bottom: 8px;"><strong>사용단계 검토:</strong></div>
                            <div style="margin-left: 20px;">소요휨강도: M_u = ${formatNumber(results.M_u_service, 2)} kN·m</div>
                            <div style="margin-left: 20px;">소요단면2차모멘트: I_req = ${formatNumber(results.I_req_service / 1e6, 0)} × 10⁶ mm⁴</div>
                            <div style="margin-left: 20px;">합성보 단면2차모멘트: Ix_composite = ${formatNumber(results.Ix_composite / 1e6, 2)} × 10⁶ mm⁴</div>
                            <div style="margin-left: 20px; margin-top: 8px; color: ${results.Ix_composite >= results.I_req_service ? '#10b981' : '#ef4444'};">
                                ${results.Ix_composite >= results.I_req_service ? '✅ 만족' : '❌ 불만족'}
                            </div>
                        </div>
                    </div>

                    <!-- 2) 사용단계에 대한 검토 -->
                    <div style="margin-top: 20px;">
                        <div style="font-size: 12px; color: #475569; line-height: 1.8; font-family: 'Courier New', monospace; background: #f8fafc; padding: 12px; border-radius: 6px; border: 1px solid #e2e8f0;">
                            <div style="margin-bottom: 8px;"><strong>2) 사용단계에 대한 검토</strong></div>
                            <div style="margin-left: 20px; margin-bottom: 8px;">유효폭: beff = ${formatNumber((results.beff || 0) * 1000, 0)} mm</div>
                            <div style="margin-left: 20px; margin-bottom: 8px;">H형강: H-${formatNumber(results.d || 0, 0)}×${formatNumber(results.bf || 0, 0)}×${formatNumber(results.tw || 0, 0)}×${formatNumber(results.tf || 0, 0)}</div>
                            <div style="margin-left: 20px; margin-bottom: 8px;">합성보 합성작용도: 75%</div>
                            <div style="margin-left: 20px; margin-bottom: 8px; color: #10b981; font-weight: 600;">
                                설계휨강도, 설계전단강도, 단면 2차 모멘트하한값 만족
                            </div>
                            <div style="margin-left: 20px; margin-top: 12px; margin-bottom: 8px;">
                                이때 강재앵커(스터드)의 소요전단력은 ∑Qn = ${formatNumber(results.SigmaQn || 0, 0)} kN이다.
                            </div>
                        </div>
                    </div>

                    <!-- Summary Table -->
                    <div style="margin-top: 30px;">
                        <table class="result-table" style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                            <thead>
                                <tr style="background: linear-gradient(135deg, #1e3a5f 0%, #2d4a6e 100%); color: white;">
                                    <th style="padding: 12px; text-align: left; border: 1px solid #1e3a5f;">구분</th>
                                    <th style="padding: 12px; text-align: center; border: 1px solid #1e3a5f;">소요 계산값</th>
                                    <th style="padding: 12px; text-align: center; border: 1px solid #1e3a5f;">비교</th>
                                    <th style="padding: 12px; text-align: center; border: 1px solid #1e3a5f;">도움표 설계값</th>
                                    <th style="padding: 12px; text-align: center; border: 1px solid #1e3a5f;">판정</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 공사 단계 (합성 전) -->
                                <tr style="background: #f8fafc;">
                                    <td colspan="5" style="padding: 10px; font-weight: 600; color: #1e3a5f; border: 1px solid #e2e8f0;">공사 단계 (합성 전)</td>
                                </tr>
                                <tr>
                                    <td style="padding: 10px; border: 1px solid #e2e8f0;">휨강도</td>
                                    <td style="padding: 10px; text-align: center; border: 1px solid #e2e8f0; font-family: 'Courier New', monospace;">M_u = ${formatNumber(results.M_u_construction, 0)} kN·m</td>
                                    <td style="padding: 10px; text-align: center; border: 1px solid #e2e8f0;">&lt;</td>
                                    <td style="padding: 10px; text-align: center; border: 1px solid #e2e8f0; font-family: 'Courier New', monospace;">φM_ns = ${formatNumber(results.phiMn_steel, 0)} kN·m</td>
                                    <td style="padding: 10px; text-align: center; border: 1px solid #e2e8f0; color: ${results.M_u_construction < results.phiMn_steel ? '#10b981' : '#ef4444'}; font-weight: 600;">${results.M_u_construction < results.phiMn_steel ? '적합' : '부적합'}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 10px; border: 1px solid #e2e8f0;">단면 2차 모멘트 △DL</td>
                                    <td style="padding: 10px; text-align: center; border: 1px solid #e2e8f0; font-family: 'Courier New', monospace;">I_s,req = ${formatNumber(results.I_req_construction / 1e6, 0)} × 10⁶ mm⁴</td>
                                    <td style="padding: 10px; text-align: center; border: 1px solid #e2e8f0;">&lt;</td>
                                    <td style="padding: 10px; text-align: center; border: 1px solid #e2e8f0; font-family: 'Courier New', monospace;">I_s = ${formatNumber(results.Ix_steel / 1e6, 0)} × 10⁶ mm⁴</td>
                                    <td style="padding: 10px; text-align: center; border: 1px solid #e2e8f0; color: ${results.Ix_steel >= results.I_req_construction ? '#10b981' : '#ef4444'}; font-weight: 600;">${results.Ix_steel >= results.I_req_construction ? '적합' : '부적합'}</td>
                                </tr>
                                <!-- 사용 단계 (합성 후) -->
                                <tr style="background: #f8fafc;">
                                    <td colspan="5" style="padding: 10px; font-weight: 600; color: #1e3a5f; border: 1px solid #e2e8f0;">사용 단계 (합성 후)</td>
                                </tr>
                                <tr>
                                    <td style="padding: 10px; border: 1px solid #e2e8f0;">휨강도</td>
                                    <td style="padding: 10px; text-align: center; border: 1px solid #e2e8f0; font-family: 'Courier New', monospace;">M_u = ${formatNumber(results.M_u_service, 0)} kN·m</td>
                                    <td style="padding: 10px; text-align: center; border: 1px solid #e2e8f0;">&lt;</td>
                                    <td style="padding: 10px; text-align: center; border: 1px solid #e2e8f0; font-family: 'Courier New', monospace;">φM_n = ${formatNumber(results.phiMn_composite, 0)} kN·m</td>
                                    <td style="padding: 10px; text-align: center; border: 1px solid #e2e8f0; color: ${results.M_u_service < results.phiMn_composite ? '#10b981' : '#ef4444'}; font-weight: 600;">${results.M_u_service < results.phiMn_composite ? '적합' : '부적합'}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 10px; border: 1px solid #e2e8f0;">전단력</td>
                                    <td style="padding: 10px; text-align: center; border: 1px solid #e2e8f0; font-family: 'Courier New', monospace;">V_u = ${formatNumber(results.V_u_service, 0)} kN</td>
                                    <td style="padding: 10px; text-align: center; border: 1px solid #e2e8f0;">&lt;</td>
                                    <td style="padding: 10px; text-align: center; border: 1px solid #e2e8f0; font-family: 'Courier New', monospace;">φV_n = ${formatNumber(results.phiVn, 0)} kN</td>
                                    <td style="padding: 10px; text-align: center; border: 1px solid #e2e8f0; color: ${results.V_u_service < results.phiVn ? '#10b981' : '#ef4444'}; font-weight: 600;">${results.V_u_service < results.phiVn ? '적합' : '부적합'}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 10px; border: 1px solid #e2e8f0;">단면 2차 모멘트 △LL</td>
                                    <td style="padding: 10px; text-align: center; border: 1px solid #e2e8f0; font-family: 'Courier New', monospace;">I_com = ${formatNumber(results.I_req_service / 1e6, 0)} × 10⁶ mm⁴</td>
                                    <td style="padding: 10px; text-align: center; border: 1px solid #e2e8f0;">&lt;</td>
                                    <td style="padding: 10px; text-align: center; border: 1px solid #e2e8f0; font-family: 'Courier New', monospace;">I_LB = ${formatNumber(results.Ix_composite / 1e6, 0)} × 10⁶ mm⁴</td>
                                    <td style="padding: 10px; text-align: center; border: 1px solid #e2e8f0; color: ${results.Ix_composite >= results.I_req_service ? '#10b981' : '#ef4444'}; font-weight: 600;">${results.Ix_composite >= results.I_req_service ? '적합' : '부적합'}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- 강재앵커(스터드) 계산 섹션 -->
                    <div style="margin-top: 40px;">
                        <div class="result-section-title">3. 강재앵커(스터드)의 소요개수 산정</div>
                        <div style="font-size: 12px; color: #64748b; margin-bottom: 15px; padding: 8px; background: #f1f5f9; border-radius: 4px;">
                            합성보에서 콘크리트 슬래브와 강재보를 연결하기 위한 강재앵커(스터드)의 소요개수와 배치를 산정한다.
                        </div>
                        <div style="margin-bottom: 20px;">
                            <div style="font-size: 12px; color: #475569; line-height: 1.8; font-family: 'Courier New', monospace; background: #f8fafc; padding: 12px; border-radius: 6px; border: 1px solid #e2e8f0;">
                                <div style="margin-bottom: 12px;"><strong>1) 강재앵커(스터드) 1개의 전단강도</strong></div>
                                <div style="margin-left: 20px; margin-bottom: 8px;">스터드 직경: φ${results.stud_diameter || 19} mm</div>
                                <div style="margin-left: 20px; margin-bottom: 8px;">콘크리트 압축강도: fck = ${formatNumber(results.fc, 0)} MPa</div>
                                <div style="margin-left: 20px; margin-bottom: 8px;">스터드 전단강도: Qn = ${formatNumber(results.Qn, 1)} kN</div>
                                
                                <div style="margin-top: 16px; margin-bottom: 12px;"><strong>2) 강재앵커(스터드) φ${results.stud_diameter || 19}의 소요개수</strong></div>
                                <div style="margin-left: 20px; margin-bottom: 8px;">전단력 합계: ΣQn = ${formatNumber(results.SigmaQn, 0)} kN</div>
                                <div style="margin-left: 20px; margin-bottom: 8px;">스터드 1개 전단강도: Qn = ${formatNumber(results.Qn, 1)} kN</div>
                                <div style="margin-left: 20px; margin-bottom: 8px;">소요개수: n_stud = ΣQn / Qn = ${formatNumber(results.SigmaQn, 0)} / ${formatNumber(results.Qn, 1)} = ${formatNumber(results.SigmaQn / results.Qn, 1)}</div>
                                <div style="margin-left: 20px; margin-bottom: 8px; color: #1e3a5f; font-weight: 600;">→ L/2 구간당: ${results.n_stud_half}개 (올림)</div>
                                <div style="margin-left: 20px; margin-bottom: 8px; color: #1e3a5f; font-weight: 600;">→ 전체 보 길이: ${results.n_stud_total}개 (2 × ${results.n_stud_half})</div>
                                
                                <div style="margin-top: 16px; margin-bottom: 12px;"><strong>3) 강재앵커(스터드) 배치와 간격 검토</strong></div>
                                <div style="margin-left: 20px; margin-bottom: 8px;">배치: 단일열 배치</div>
                                <div style="margin-left: 20px; margin-bottom: 8px;">스터드 간격: s_stud = (L/2) / (n_stud / 1열) = (${formatNumber(results.L * 1000 / 2, 0)}) / (${results.n_stud_half} / 1열) = ${formatNumber(results.s_stud_calc, 2)} mm</div>
                                <div style="margin-left: 20px; margin-bottom: 8px; color: #1e3a5f; font-weight: 600;">→ 스터드 간격: ${results.s_stud} mm (10mm 단위로 내림)</div>
                            </div>
                        </div>
                    </div>

                    <!-- 합성보의 길이방향에 대한 간격 검토 섹션 -->
                    <div style="margin-top: 40px;">
                        <div class="result-section-title">4) 합성보의 길이방향에 대한 간격 검토</div>
                        <div style="font-size: 12px; color: #64748b; margin-bottom: 15px; padding: 8px; background: #f1f5f9; border-radius: 4px;">
                            AISC I8.2에 따라 스터드 간격이 최소 간격과 최대 간격 사이에 있는지 검토한다.
                        </div>
                        <div style="margin-bottom: 20px;">
                            <div style="font-size: 12px; color: #475569; line-height: 1.8; font-family: 'Courier New', monospace; background: #f8fafc; padding: 12px; border-radius: 6px; border: 1px solid #e2e8f0;">
                                <div style="margin-bottom: 12px;"><strong>간격 검토 조건:</strong></div>
                                <div style="margin-left: 20px; margin-bottom: 8px;">최소 간격: 6d_stud = 6(${results.stud_diameter || 19}) = ${results.min_spacing} mm</div>
                                <div style="margin-left: 20px; margin-bottom: 8px;">최대 간격: min[8t_slab = 8(${results.ts}) = ${results.max_spacing_1} mm, 900 mm] = ${results.max_spacing} mm</div>
                                <div style="margin-left: 20px; margin-bottom: 8px;">계산된 스터드 간격: s_stud_calc = ${formatNumber(results.s_stud_calc, 2)} mm</div>
                                <div style="margin-left: 20px; margin-bottom: 8px;">10mm 단위로 내림: ${results.s_stud_initial} mm</div>
                                ${results.s_stud_initial !== results.s_stud ? 
                                    `<div style="margin-left: 20px; margin-bottom: 8px; color: #f59e0b; font-weight: 600;">→ 스터드 간격 조정: ${results.s_stud_initial} mm → ${results.s_stud} mm (범위 내로 조정)</div>` : 
                                    `<div style="margin-left: 20px; margin-bottom: 8px; color: #1e3a5f; font-weight: 600;">→ 스터드 간격: s_stud = ${results.s_stud} mm (범위 내)</div>`
                                }
                                <div style="margin-left: 20px; margin-bottom: 12px; padding: 8px; background: #d1fae5; border-radius: 4px; border: 1px solid #10b981;">
                                    <strong>검토 결과:</strong> ${results.min_spacing} mm ≤ ${results.s_stud} mm ≤ ${results.max_spacing} mm
                                    <span style="color: #10b981; font-weight: 600; margin-left: 10px;">
                                        ✅ 만족
                                    </span>
                                </div>
                                <div style="margin-top: 16px; margin-bottom: 8px; color: #1e3a5f; font-weight: 600;">
                                    따라서 강재앵커(스터드) φ${results.stud_diameter || 19}×${results.stud_length || 90}을 보의 전 길이에 걸쳐 1열로 ${results.s_stud} mm 간격으로 배치하면 보스팬의 중앙부에서 각 지지점까지 각각 ${results.n_stud_half}개씩 배치되며 총 ${results.n_stud_total}개가 배치된다.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 4. 사용성 검토 -->
                    <div style="margin-top: 40px;">
                        <div class="result-section-title">4. 사용성 검토</div>
                        <div style="font-size: 12px; color: #64748b; margin-bottom: 15px; padding: 8px; background: #f1f5f9; border-radius: 4px;">
                            4.1 치올림(camber) 설계와 전체 처짐 검토
                        </div>
                        <div style="margin-bottom: 20px;">
                            <div style="font-size: 12px; color: #475569; line-height: 1.8; font-family: 'Courier New', monospace; background: #f8fafc; padding: 12px; border-radius: 6px; border: 1px solid #e2e8f0;">
                                <div style="margin-bottom: 12px;"><strong>1) 시공 중 보의 처짐과 치올림설계</strong> <span style="font-size: 10px; color: #94a3b8;">(5.3.7의 참고자료-3 참조)</span></div>
                                <div style="margin-left: 20px; margin-bottom: 8px;"><strong>콘크리트양생 전 고정하중에 대한 강재단면 처짐:</strong></div>
                                <div style="margin-left: 20px; margin-bottom: 8px;">Δ_DL1 = (5 × ${formatNumber(results.w_DL_construction || 0, 2)} × ${formatNumber(results.L * 1000, 0)}⁴) / (384 × ${formatNumber(210000, 0)} × ${formatNumber(results.Ix_steel / 1e6, 0)} × 10⁶)</div>
                                <div style="margin-left: 20px; margin-bottom: 8px;">= ${formatNumber(results.delta_DL1 || 0, 1)} mm</div>
                                <div style="margin-left: 20px; margin-bottom: 8px;">${formatNumber(results.delta_DL1 || 0, 1)} mm > min[l/360 = ${formatNumber((results.L * 1000) / 360, 1)} mm, 25 mm]</div>
                                <div style="margin-left: 20px; margin-bottom: 8px;">처짐량이 크므로 바닥의 평탄성을 고려하여 치올림을 둔다.</div>
                                <div style="margin-left: 20px; margin-bottom: 12px;">치올림 (camber) = (${formatNumber(results.delta_DL1 || 0, 1)}) × (0.80) = ${formatNumber((results.delta_DL1 || 0) * 0.80, 1)} mm → ${formatNumber(results.camber || 0, 0)} mm</div>
                                
                                <div style="margin-top: 16px; margin-bottom: 12px;"><strong>2) 콘크리트양생 후 재하되는 고정하중에 의한 처짐:</strong></div>
                                <div style="margin-left: 20px; margin-bottom: 8px;">w_SIDL = ${formatNumber(results.w_SIDL_service || 0, 2)} kN/m</div>
                                <div style="margin-left: 20px; margin-bottom: 8px;">Δ_DL2 = (5 × ${formatNumber(results.w_SIDL_service || 0, 2)} × ${formatNumber(results.L * 1000, 0)}⁴) / (384 × ${formatNumber(210000, 0)} × ${formatNumber(results.Ix_composite / 1e6, 0)} × 10⁶)</div>
                                <div style="margin-left: 20px; margin-bottom: 8px;">= ${formatNumber(results.delta_DL2 || 0, 1)} mm</div>
                                <div style="margin-left: 20px; margin-bottom: 12px;">${formatNumber(results.delta_DL2 || 0, 1)} mm ≈ l / ${formatNumber(results.delta_DL2_ratio || 0, 0)}</div>
                                
                                <div style="margin-top: 16px; margin-bottom: 12px;"><strong>3) 콘크리트양생 후 재하되는 활하중에 의한 처짐:</strong></div>
                                <div style="margin-left: 20px; margin-bottom: 8px;">w_LL = ${formatNumber(results.w_LL_service || 0, 2)} kN/m</div>
                                <div style="margin-left: 20px; margin-bottom: 8px;">Δ_LL = (5 × ${formatNumber(results.w_LL_service || 0, 2)} × ${formatNumber(results.L * 1000, 0)}⁴) / (384 × ${formatNumber(210000, 0)} × ${formatNumber(results.Ix_composite / 1e6, 0)} × 10⁶) = ${formatNumber(results.delta_LL || 0, 1)} mm</div>
                                <div style="margin-left: 20px; margin-bottom: 8px;">${formatNumber(results.delta_LL || 0, 1)} mm < l/360 = ${formatNumber(results.delta_allow_LL || 0, 1)} mm</div>
                                <div style="margin-left: 20px; margin-bottom: 12px; color: ${results.delta_LL_ok ? '#10b981' : '#ef4444'}; font-weight: 600;">
                                    ${results.delta_LL_ok ? '적합' : '부적합'}
                                </div>
                                
                                <div style="margin-top: 16px; margin-bottom: 12px;"><strong>4) 고정하중과 활하중에 의한 처짐:</strong></div>
                                <div style="margin-left: 20px; margin-bottom: 8px;">Δ_T = (Δ_DL1 - Camber) + Δ_DL2 + Δ_LL</div>
                                <div style="margin-left: 20px; margin-bottom: 8px;">Δ_T = (${formatNumber(results.delta_DL1 || 0, 1)} - ${formatNumber(results.camber || 0, 0)}) + ${formatNumber(results.delta_DL2 || 0, 1)} + ${formatNumber(results.delta_LL || 0, 1)} = ${formatNumber(results.delta_T || 0, 1)} mm</div>
                                <div style="margin-left: 20px; margin-bottom: 8px;">${formatNumber(results.delta_T || 0, 1)} mm = l / ${formatNumber(results.delta_T_ratio || 0, 0)} < l / 240 = ${formatNumber(results.delta_allow_T_service || 0, 1)} mm</div>
                                <div style="margin-left: 20px; margin-bottom: 12px; color: ${results.delta_T_ok ? '#10b981' : '#ef4444'}; font-weight: 600;">
                                    ${results.delta_T_ok ? '적합' : '부적합'}
                                </div>
                                <div style="margin-left: 20px; margin-top: 12px; font-size: 10px; color: #94a3b8;">
                                    (5.3.7의 참고자료-2 참조)
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <table class="result-table">
                        <tr>
                            <th>항목</th>
                            <th>값</th>
                            <th>단위</th>
                        </tr>
                        <tr>
                            <td>합성 전 고정하중 (w_DL)</td>
                            <td class="result-value">${formatNumber(results.w_DL_service, 3)}</td>
                            <td>kN/m</td>
                        </tr>
                        <tr>
                            <td>합성 후 고정하중 (w_SIDL)</td>
                            <td class="result-value">${formatNumber(results.w_SIDL_service, 3)}</td>
                            <td>kN/m</td>
                        </tr>
                        <tr>
                            <td>합성 후 활하중 (w_LL)</td>
                            <td class="result-value">${formatNumber(results.w_LL_service, 3)}</td>
                            <td>kN/m</td>
                        </tr>
                        <tr>
                            <td>사용 중 계수하중 (w_u)</td>
                            <td class="result-value">${formatNumber(results.w_u_service, 3)}</td>
                            <td>kN/m</td>
                        </tr>
                        <tr>
                            <td>사용 중 소요휨강도 (M_u)</td>
                            <td class="result-value">${formatNumber(results.M_u_service, 2)}</td>
                            <td>kN·m</td>
                        </tr>
                        <tr>
                            <td>사용 중 소요전단강도 (V_u)</td>
                            <td class="result-value">${formatNumber(results.V_u_service, 2)}</td>
                            <td>kN</td>
                        </tr>
                    </table>
                </div>
            `;
            
            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/f6b33b86-5eb3-41dd-83f7-9e0a0382507b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'ex-slim-beam-calculator.html:1900',message:'Serviceability section HTML generated',data:{hasServiceabilitySection:container.innerHTML.includes('4. 사용성 검토'),delta_DL1:results.delta_DL1,camber:results.camber,delta_DL2:results.delta_DL2,delta_LL:results.delta_LL,delta_T:results.delta_T},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'K'})}).catch(()=>{});
            // #endregion
            } catch (error) {
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/f6b33b86-5eb3-41dd-83f7-9e0a0382507b',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'ex-slim-beam-calculator.html:1543',message:'Error in displayResults',data:{error:error.message,stack:error.stack,resultsKeys:Object.keys(results||{})},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'J'})}).catch(()=>{});
                // #endregion
                console.error('displayResults error:', error);
                alert('결과 표시 중 오류가 발생했습니다: ' + error.message);
            }
        }

        function formatNumber(num, decimals) {
            if (isNaN(num) || !isFinite(num)) return '-';
            return num.toFixed(decimals).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }
    </script>
</body>
</html>
