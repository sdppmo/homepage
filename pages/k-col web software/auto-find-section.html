<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto Find Section : Cross H ê¸°ë‘¥ ìë™êµ¬ì¡°ê³„ì‚° ë° ì² ê³¨ê¸°ë‘¥ BOQ ì‚°ì¶œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3a5f, #2d5a87);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .header a {
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            font-size: 14px;
            padding: 8px 16px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            transition: all 0.2s;
        }

        .header a:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .main-content {
            padding: 30px;
        }

        .section {
            background: #f8fafc;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e3a5f;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .input-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .input-group input,
        .input-group select {
            padding: 8px 12px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            font-size: 14px;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        /* í•˜ì¤‘ ì…ë ¥ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .load-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .load-table th,
        .load-table td {
            padding: 10px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        .load-table th {
            background: #1e3a5f;
            color: white;
            font-weight: 600;
            font-size: 12px;
        }

        .load-table td input {
            width: 100%;
            padding: 6px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            font-size: 13px;
        }

        .load-table tbody tr:nth-child(even) {
            background: #f8fafc;
        }

        .load-table tbody tr:hover {
            background: #e8f4f8;
        }

        /* ê²°ê³¼ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 11px;
        }

        .result-table th,
        .result-table td {
            padding: 8px 6px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        .result-table th {
            background: #1e3a5f;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
        }

        .result-table tbody tr:nth-child(even) {
            background: #f8fafc;
        }

        .result-table tbody tr:hover {
            background: #e8f4f8;
        }

        /* BOQ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .boq-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 12px;
        }

        .boq-table th,
        .boq-table td {
            padding: 10px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        .boq-table th {
            background: #2d5a87;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .boq-table tbody tr:nth-child(even) {
            background: #f8fafc;
        }

        .boq-table tbody tr:hover {
            background: #e8f4f8;
        }

        .boq-table .total-row {
            background: #e8f4f8;
            font-weight: 600;
            color: #1e3a5f;
        }

        .boq-section {
            background: #f8fafc;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #e2e8f0;
            display: none;
        }

        .boq-section.show {
            display: block;
        }

        .btn-secondary {
            background: #667eea;
            color: white;
        }

        .btn-secondary:hover {
            background: #5568d3;
        }
    </style>
    <!-- SheetJS for Excel file handling -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Auto Find Section : Cross H ê¸°ë‘¥ ìë™êµ¬ì¡°ê³„ì‚° ë° ì² ê³¨ê¸°ë‘¥ BOQ ì‚°ì¶œ</h1>
            <a href="crossHcolumnCalculator.html">â† ê³„ì‚°ê¸°ë¡œ ëŒì•„ê°€ê¸°</a>
        </div>

        <div class="main-content">
            <!-- ê³µí†µ ì„¤ì • -->
            <div class="section">
                <div class="section-title">ê³µí†µ ì„¤ì •</div>
                <div class="input-row">
                    <div class="input-group">
                        <label>ê¸°ë‘¥ ê°œìˆ˜</label>
                        <input type="number" id="columnCount" value="3" min="1" max="20" onchange="updateLoadTable()" oninput="updateLoadTable()">
                    </div>
                    <div class="input-group">
                        <label>Kx</label>
                        <input type="number" id="Kx" value="0.8" step="0.1" min="0.1">
                    </div>
                    <div class="input-group">
                        <label>Ky</label>
                        <input type="number" id="Ky" value="0.8" step="0.1" min="0.1">
                    </div>
                    <div class="input-group">
                        <label>Kz</label>
                        <input type="number" id="Kz" value="0.8" step="0.1" min="0.1">
                    </div>
                </div>
                <div class="input-row" style="margin-top: 15px;">
                    <div class="input-group">
                        <label>Lx (m)</label>
                        <input type="number" id="Lx" value="4.5" step="0.001" min="0.1">
                    </div>
                    <div class="input-group">
                        <label>Ly (m)</label>
                        <input type="number" id="Ly" value="4.5" step="0.001" min="0.1">
                    </div>
                </div>
                <div class="input-row" style="margin-top: 15px;">
                    <div class="input-group">
                        <label>Type1 ê¸¸ì´ (m)</label>
                        <input type="number" id="Lx_type1" value="26.478" step="0.001" min="0.1" onchange="updateTypeLengths()">
                    </div>
                    <div class="input-group">
                        <label>Type2 ê¸¸ì´ (m)</label>
                        <input type="number" id="Lx_type2" value="23.678" step="0.001" min="0.1" onchange="updateTypeLengths()">
                    </div>
                    <div class="input-group">
                        <label>Type3 ê¸¸ì´ (m)</label>
                        <input type="number" id="Lx_type3" value="25.938" step="0.001" min="0.1" onchange="updateTypeLengths()">
                    </div>
                    <div class="input-group">
                        <label>Type4 ê¸¸ì´ (m)</label>
                        <input type="number" id="Lx_type4" value="22.438" step="0.001" min="0.1" onchange="updateTypeLengths()">
                    </div>
                </div>
                <div class="input-row" style="margin-top: 15px;">
                    <div class="input-group">
                        <label>tw ìµœì†Œ ë‘ê»˜ (mm)</label>
                        <input type="number" id="twMin" value="8" step="1" min="1" max="50" onchange="updateThicknessRanges()">
                    </div>
                    <div class="input-group">
                        <label>tw ìµœëŒ€ ë‘ê»˜ (mm)</label>
                        <input type="number" id="twMax" value="16" step="1" min="1" max="50" onchange="updateThicknessRanges()">
                    </div>
                    <div class="input-group">
                        <label>tf ìµœì†Œ ë‘ê»˜ (mm)</label>
                        <input type="number" id="tfMin" value="10" step="1" min="1" max="50" onchange="updateThicknessRanges()">
                    </div>
                    <div class="input-group">
                        <label>tf ìµœëŒ€ ë‘ê»˜ (mm)</label>
                        <input type="number" id="tfMax" value="20" step="1" min="1" max="50" onchange="updateThicknessRanges()">
                    </div>
                </div>
                <div style="margin-top: 15px; padding: 10px; background: #e8f4f8; border-radius: 4px; font-size: 12px;">
                    <strong>ê³ ì • ì¹˜ìˆ˜:</strong> ì„¸ ê°€ì§€ ì¡°í•©ì„ ê³„ì‚°í•˜ì—¬ ë‹¨ê°€ë¥¼ ë°˜ì˜í•œ ê°€ì¥ ê²½ì œì ì¸ ë‹¨ë©´ì„ ì„ íƒí•©ë‹ˆë‹¤.<br>
                    â€¢ ì¡°í•© 1: BH1=500, BH2=500, B1=300, B2=300 (SM420, SM355)<br>
                    â€¢ ì¡°í•© 2: BH1=450, BH2=450, B1=250, B2=250 (SM420, SM355)<br>
                    â€¢ ì¡°í•© 3: H400, H450, H500, H506, H482, H488, H582, H588, H600 (Rolled H, SM355ë§Œ)<br>
                    â€¢ ê°•ì¢…: SM420 (1,900,000ì›/í†¤), SM355 (1,830,000ì›/í†¤) - ë‹¨ê°€ ë°˜ì˜í•˜ì—¬ ë¹„êµ<br>
                    â€¢ tw1=tw2 (<span id="twRangeDisplay">8~16</span>mm), tf1=tf2 (<span id="tfRangeDisplay">10~20</span>mm)
                </div>
            </div>


            <!-- í•˜ì¤‘ ì…ë ¥ -->
            <div class="section">
                <div class="section-title" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>í•˜ì¤‘ ì…ë ¥</span>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="exportLoadToExcel()" style="padding: 6px 12px; background: #38a169; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                            ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                        </button>
                        <label for="excelFileInput" style="padding: 6px 12px; background: #667eea; color: white; border-radius: 4px; cursor: pointer; font-size: 13px; display: inline-block;">
                            ğŸ“¤ ì—‘ì…€ ì—…ë¡œë“œ
                        </label>
                        <input type="file" id="excelFileInput" accept=".xlsx,.xls" style="display: none;" onchange="importLoadFromExcel(event)">
                    </div>
                </div>
                <table class="load-table">
                    <thead>
                        <tr>
                            <th>No.</th>
                            <th>ê¸°ë‘¥ ì´ë¦„</th>
                            <th>Pu (kN)</th>
                            <th>Mux (kNÂ·m)</th>
                            <th>Muy (kNÂ·m)</th>
                        </tr>
                    </thead>
                    <tbody id="loadTableBody">
                        <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                    </tbody>
                </table>
            </div>

            <!-- ê³„ì‚° ë° ê²°ê³¼ -->
            <div class="section">
                <div class="section-title">ê³„ì‚° ë° ê²°ê³¼</div>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="calculateAll()" style="flex: 1;">
                        Auto Find Section Result
                    </button>
                    <button class="btn btn-secondary" onclick="printCalculationSheet()" style="flex: 1;">
                        ğŸ“„ ê³„ì‚°ì„œ ì¶œë ¥
                    </button>
                    <button class="btn" onclick="exportResultToExcel()" style="flex: 1; background: #667eea; color: white;">
                        ğŸ“¥ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ (Excel)
                    </button>
                    <button class="btn" onclick="generateBOQ()" style="flex: 1; background: #38a169; color: white;">
                        ğŸ“‹ BOQ ì‚°ì¶œ
                    </button>
                </div>
                <div style="overflow-x: auto;">
                    <table class="result-table" id="resultTable">
                        <thead>
                            <tr>
                                <th rowspan="2">No.</th>
                                <th rowspan="2">ê¸°ë‘¥ëª…</th>
                                <th rowspan="2">Pu (kN)</th>
                                <th rowspan="2">P-M-M</th>
                                <th rowspan="2">ê°•ì¢…</th>
                                <th rowspan="2">ì¡°í•©</th>
                                <th colspan="6">ê·œê²©</th>
                                <th rowspan="2">ë‹¨ë©´ì <br>(mmÂ²)</th>
                                <th rowspan="2">ë‹¨ì¤‘<br>(kg/m)</th>
                                <th rowspan="2">ë‹¨ê°€<br>(ì›/í†¤)</th>
                                <th rowspan="2">ë‹¨ìœ„ê¸¸ì´ë‹¹<br>ê¸ˆì•¡(ì›/m)</th>
                            </tr>
                            <tr>
                                <th>K</th>
                                <th>L</th>
                                <th>H</th>
                                <th>B</th>
                                <th>tw</th>
                                <th>tf</th>
                            </tr>
                        </thead>
                        <tbody id="resultTableBody">
                            <!-- ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- BOQ ì‚°ì¶œ -->
            <div class="section boq-section" id="boqSection">
                <div class="section-title">BOQ (Bill of Quantities) - ê³µì‚¬ ìˆ˜ëŸ‰ ì‚°ì¶œì„œ</div>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="btn" onclick="printBOQ()" style="background: #38a169; color: white;">
                        ğŸ–¨ï¸ BOQ ì¸ì‡„
                    </button>
                    <button class="btn" onclick="exportBOQToCSV()" style="background: #667eea; color: white;">
                        ğŸ“¥ CSV ë‹¤ìš´ë¡œë“œ
                    </button>
                </div>
                <div style="overflow-x: auto;">
                    <table class="boq-table" id="boqTable">
                        <thead>
                            <tr>
                                <th>No.</th>
                                <th>ê¸°ë‘¥ëª…</th>
                                <th>ì¡°í•©</th>
                                <th>ê·œê²©</th>
                                <th>H<br>(mm)</th>
                                <th>B<br>(mm)</th>
                                <th>tw<br>(mm)</th>
                                <th>tf<br>(mm)</th>
                                <th>ë‹¨ë©´ì <br>(mmÂ²)</th>
                                <th>ë‹¨ì¤‘<br>(kg/m)</th>
                                <th>ê¸¸ì´<br>(m)</th>
                                <th>ê°œìˆ˜</th>
                                <th>ì´ ì¤‘ëŸ‰<br>(kg)</th>
                                <th>ê°•ì¢…</th>
                            </tr>
                        </thead>
                        <tbody id="boqTableBody">
                            <!-- BOQ ë°ì´í„°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì„¸ ê°€ì§€ ì¡°í•© ì •ì˜
        const combinations = [
            { H1: 500, H2: 500, B1: 300, B2: 300, name: 'BH500Ã—B300' },
            { H1: 450, H2: 450, B1: 250, B2: 250, name: 'BH450Ã—B250' },
            // ì¡°í•© 3: Rolled H ë‹¨ë©´ë“¤
            { H1: 400, H2: 400, B1: 200, B2: 200, name: 'H400Ã—B200' },
            { H1: 450, H2: 450, B1: 200, B2: 200, name: 'H450Ã—B200' },
            { H1: 500, H2: 500, B1: 200, B2: 200, name: 'H500Ã—B200' },
            { H1: 506, H2: 506, B1: 201, B2: 201, name: 'H506Ã—B201' },
            { H1: 482, H2: 482, B1: 300, B2: 300, name: 'H482Ã—B300' },
            { H1: 488, H2: 488, B1: 300, B2: 300, name: 'H488Ã—B300' },
            { H1: 582, H2: 582, B1: 300, B2: 300, name: 'H582Ã—B300' },
            { H1: 588, H2: 588, B1: 300, B2: 300, name: 'H588Ã—B300' },
            { H1: 600, H2: 600, B1: 200, B2: 200, name: 'H600Ã—B200' }
        ];
        
        // ë‘ê»˜ ë²”ìœ„ë¥¼ ë™ì ìœ¼ë¡œ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
        function getTwRange() {
            const twMin = parseInt(document.getElementById('twMin')?.value) || 8;
            const twMax = parseInt(document.getElementById('twMax')?.value) || 16;
            const range = [];
            for (let i = twMin; i <= twMax; i++) {
                range.push(i);
            }
            return range;
        }
        
        function getTfRange() {
            const tfMin = parseInt(document.getElementById('tfMin')?.value) || 10;
            const tfMax = parseInt(document.getElementById('tfMax')?.value) || 20;
            const range = [];
            for (let i = tfMin; i <= tfMax; i++) {
                range.push(i);
            }
            return range;
        }
        
        const steelDensity = 7850; // kg/mÂ³

        // í•˜ì¤‘ ë°ì´í„° ë°°ì—´
        let columnData = [];
        // ê³„ì‚° ê²°ê³¼ ë°°ì—´ (ì „ì—­)
        let currentResults = [];

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            updateLoadTable();
            updateThicknessRanges(); // ë‘ê»˜ ë²”ìœ„ ì´ˆê¸° í‘œì‹œ
            addLoginModal();
            addBOQLengthModal();
            addSubMaterialModal();
            addUnitPriceModal();
            
            // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
            document.addEventListener('click', function(e) {
                const loginModal = document.getElementById('loginModal');
                if (loginModal && e.target === loginModal) {
                    closeLoginModal();
                }
                const boqLengthModal = document.getElementById('boqLengthModal');
                if (boqLengthModal && e.target === boqLengthModal) {
                    closeBOQLengthModal();
                }
                const subMaterialModal = document.getElementById('subMaterialModal');
                if (subMaterialModal && e.target === subMaterialModal) {
                    closeSubMaterialModal();
                }
                const unitPriceModal = document.getElementById('unitPriceModal');
                if (unitPriceModal && e.target === unitPriceModal) {
                    closeUnitPriceModal();
                }
            });
        });

        // í•˜ì¤‘ ì…ë ¥ í…Œì´ë¸” ì—…ë°ì´íŠ¸ (ê¸°ë‘¥ ê°œìˆ˜ì— ë”°ë¼ ë™ì  ìƒì„±)
        function updateLoadTable() {
            const tbody = document.getElementById('loadTableBody');
            if (!tbody) return;
            
            const count = parseInt(document.getElementById('columnCount').value) || 3;
            
            // ê¸°ì¡´ ë°ì´í„° ë³´ì¡´
            const existingData = {};
            columnData.forEach(col => {
                existingData[col.no] = col;
            });
            
            tbody.innerHTML = '';
            columnData = [];
            
            // ì…ë ¥í•œ ê°œìˆ˜ë§Œí¼ í–‰ ìƒì„±
            for (let i = 1; i <= count; i++) {
                const existing = existingData[i];
                const colName = `KC${i}`;
                columnData.push({
                    no: i,
                    name: existing?.name || colName,
                    pu: existing?.pu || 0,
                    mux: existing?.mux || 0,
                    muy: existing?.muy || 0
                });
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-weight: 600; color: #667eea; text-align: center;">${i}</td>
                    <td><input type="text" id="col${i}_name" value="${existing?.name || colName}" 
                               placeholder="ê¸°ë‘¥ ì´ë¦„" style="width: 100%; padding: 6px; border: 1px solid #cbd5e0; border-radius: 4px;"
                               onchange="updateColumnData(${i}, 'name', this.value)"></td>
                    <td><input type="number" id="col${i}_Pu" value="${existing?.pu || 0}" step="0.1" placeholder="Pu" 
                               style="width: 100%; padding: 6px; border: 1px solid #cbd5e0; border-radius: 4px;"
                               onchange="updateColumnData(${i}, 'pu', this.value)"></td>
                    <td><input type="number" id="col${i}_Mux" value="${existing?.mux || 0}" step="0.1" placeholder="Mux" 
                               style="width: 100%; padding: 6px; border: 1px solid #cbd5e0; border-radius: 4px;"
                               onchange="updateColumnData(${i}, 'mux', this.value)"></td>
                    <td><input type="number" id="col${i}_Muy" value="${existing?.muy || 0}" step="0.1" placeholder="Muy" 
                               style="width: 100%; padding: 6px; border: 1px solid #cbd5e0; border-radius: 4px;"
                               onchange="updateColumnData(${i}, 'muy', this.value)"></td>
                `;
                tbody.appendChild(row);
            }
        }

        // ê¸°ì¡´ updateColumnTable í•¨ìˆ˜ ì œê±°í•˜ê³  updateLoadTable ì‚¬ìš©

        // í•˜ì¤‘ ë°ì´í„° ì—…ë°ì´íŠ¸
        function updateColumnData(no, field, value) {
            const col = columnData.find(c => c.no === no);
            if (col) {
                if (field === 'name') {
                    col.name = value;
                } else if (field === 'pu') {
                    col.pu = parseFloat(value) || 0;
                } else if (field === 'mux') {
                    col.mux = parseFloat(value) || 0;
                } else if (field === 'muy') {
                    col.muy = parseFloat(value) || 0;
                }
            }
        }

        // í•˜ì¤‘ ì…ë ¥ ë°ì´í„°ë¥¼ ì—‘ì…€ë¡œ ë‹¤ìš´ë¡œë“œ
        function exportLoadToExcel() {
            try {
                // í˜„ì¬ columnDataë¥¼ ì‚¬ìš©í•˜ì—¬ ì›Œí¬ë¶ ìƒì„±
                const wsData = [
                    ['No.', 'ê¸°ë‘¥ ì´ë¦„', 'Pu (kN)', 'Mux (kNÂ·m)', 'Muy (kNÂ·m)']
                ];
                
                columnData.forEach(col => {
                    wsData.push([
                        col.no,
                        col.name || `KC${col.no}`,
                        col.pu || 0,
                        col.mux || 0,
                        col.muy || 0
                    ]);
                });
                
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                
                // ì»¬ëŸ¼ ë„ˆë¹„ ì„¤ì •
                ws['!cols'] = [
                    { wch: 5 },   // No.
                    { wch: 15 },  // ê¸°ë‘¥ ì´ë¦„
                    { wch: 12 },  // Pu
                    { wch: 12 },  // Mux
                    { wch: 12 }   // Muy
                ];
                
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'í•˜ì¤‘ì…ë ¥');
                
                // íŒŒì¼ëª… ìƒì„± (í˜„ì¬ ë‚ ì§œ/ì‹œê°„ í¬í•¨)
                const now = new Date();
                const dateStr = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}`;
                const fileName = `í•˜ì¤‘ì…ë ¥_${dateStr}.xlsx`;
                
                XLSX.writeFile(wb, fileName);
                alert(`í•˜ì¤‘ ì…ë ¥ ë°ì´í„°ê°€ "${fileName}" íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`);
            } catch (error) {
                console.error('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ì—‘ì…€ íŒŒì¼ì—ì„œ í•˜ì¤‘ ì…ë ¥ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        function importLoadFromExcel(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // ì²« ë²ˆì§¸ ì‹œíŠ¸ ì‚¬ìš©
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // JSONìœ¼ë¡œ ë³€í™˜
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
                    
                    if (jsonData.length < 2) {
                        alert('ì—‘ì…€ íŒŒì¼ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. í—¤ë” í–‰ê³¼ ìµœì†Œ 1ê°œì˜ ë°ì´í„° í–‰ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                        return;
                    }
                    
                    // í—¤ë” í™•ì¸ (ì²« ë²ˆì§¸ í–‰)
                    const headers = jsonData[0].map(h => String(h).toLowerCase().trim());
                    const noIdx = headers.findIndex(h => h.includes('no') || h === 'no.');
                    const nameIdx = headers.findIndex(h => h.includes('ê¸°ë‘¥') || h.includes('name') || h.includes('ì´ë¦„'));
                    const puIdx = headers.findIndex(h => h.includes('pu'));
                    const muxIdx = headers.findIndex(h => h.includes('mux'));
                    const muyIdx = headers.findIndex(h => h.includes('muy'));
                    
                    if (puIdx === -1) {
                        alert('ì—‘ì…€ íŒŒì¼ì— "Pu" ì»¬ëŸ¼ì´ ì—†ìŠµë‹ˆë‹¤. ì»¬ëŸ¼ëª…ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                        return;
                    }
                    
                    // ë°ì´í„° íŒŒì‹±
                    const importedData = [];
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (!row || row.length === 0) continue;
                        
                        const no = noIdx !== -1 ? (parseInt(row[noIdx]) || i) : i;
                        const name = nameIdx !== -1 ? String(row[nameIdx] || '').trim() || `KC${i}` : `KC${i}`;
                        const pu = puIdx !== -1 ? parseFloat(row[puIdx]) || 0 : 0;
                        const mux = muxIdx !== -1 ? parseFloat(row[muxIdx]) || 0 : 0;
                        const muy = muyIdx !== -1 ? parseFloat(row[muyIdx]) || 0 : 0;
                        
                        importedData.push({ no, name, pu, mux, muy });
                    }
                    
                    if (importedData.length === 0) {
                        alert('ì—‘ì…€ íŒŒì¼ì—ì„œ ìœ íš¨í•œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }
                    
                    // columnData ì—…ë°ì´íŠ¸
                    columnData = importedData;
                    
                    // ê¸°ë‘¥ ê°œìˆ˜ ì—…ë°ì´íŠ¸ (ì—‘ì…€ì— ì‹¤ì œë¡œ ìˆëŠ” í–‰ ìˆ˜ ì‚¬ìš©)
                    const actualCount = importedData.length;
                    document.getElementById('columnCount').value = actualCount;
                    
                    // í…Œì´ë¸” ì—…ë°ì´íŠ¸
                    updateLoadTable();
                    
                    alert(`${importedData.length}ê°œì˜ í•˜ì¤‘ ì…ë ¥ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
                } catch (error) {
                    console.error('ì—‘ì…€ íŒŒì¼ ì½ê¸° ì˜¤ë¥˜:', error);
                    alert('ì—‘ì…€ íŒŒì¼ ì½ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            };
            
            reader.readAsArrayBuffer(file);
            
            // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™” (ê°™ì€ íŒŒì¼ ë‹¤ì‹œ ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡)
            event.target.value = '';
        }

        // ê¸¸ì´ íƒ€ì…ë³„ Lx, Ly ê°€ì ¸ì˜¤ê¸° (ê¸°ë³¸ê°’ ì‚¬ìš©)
        function getLengthsForType(type) {
            // ê¸°ë³¸ê°’ 4.5m ì‚¬ìš©
            const Lx = 4.5;
            const Ly = 4.5;
            return { Lx: Lx * 1000, Ly: Ly * 1000 }; // m to mm
        }

        // ì¼ë°˜ H-beam ë‹¨ë©´ ê³„ì‚° í•¨ìˆ˜
        function calculateSingleHBeam(tw, tf, Fy, E, nu, Kx, Ky, Kz, Lx, Ly, Pu, Mux, Muy) {
            const h = H_single;
            const b = B_single;
            const r = 0; // Built-up ë¶€ì¬
            
            // ë‹¨ë©´ ê³„ì‚°
            const hw = h - 2 * tf;
            const d = h / 2 - tf / 2;
            
            // ë‹¨ë©´ì 
            const ag1 = b * tf;
            const ag2 = b * tf;
            const ag3 = hw * tw;
            const ag4 = 4 * (r * r - Math.PI * r * r / 4);
            const area = ag1 + ag2 + ag3 + ag4;
            
            // ê´€ì„±ëª¨ë©˜íŠ¸
            const Ix1 = 1/12 * b * Math.pow(tf, 3) + ag1 * Math.pow(d, 2);
            const Ix2 = 1/12 * b * Math.pow(tf, 3) + ag1 * Math.pow(d, 2);
            const Ix3 = 1/12 * tw * Math.pow(hw, 3);
            const Ix = Ix1 + Ix2 + Ix3;
            
            const Iy1 = 1/12 * tf * Math.pow(b, 3);
            const Iy2 = 1/12 * tf * Math.pow(b, 3);
            const Iy3 = 1/12 * hw * Math.pow(tw, 3);
            const Iy = Iy1 + Iy2 + Iy3;
            
            // íšŒì „ë°˜ê²½
            const ix = Math.sqrt(Ix / area);
            const iy = Math.sqrt(Iy / area);
            
            // íƒ„ì„± ë‹¨ë©´ê³„ìˆ˜
            const sx = Ix / (h / 2);
            const sy = Iy / (b / 2);
            
            // ì†Œì„± ë‹¨ë©´ê³„ìˆ˜
            // Zx = B*tf*(H-tf) + tw*(H-2*tf)^2/4
            const zx = b * tf * (h - tf) + tw * Math.pow(hw, 2) / 4;
            
            // Zy = tf*B^2/2 + (H-2*tf)*tw^2/4
            const zy = tf * Math.pow(b, 2) / 2 + hw * Math.pow(tw, 2) / 4;
            
            // ë¹„í‹€ë¦¼ ìƒìˆ˜
            const J = (2 * b * Math.pow(tf, 3) + h * Math.pow(tw, 3)) / 3;
            
            // ì¢Œêµ´ ìƒìˆ˜
            const cw = Iy * Math.pow(h - tf, 2) / 4;
            
            // Plate thickness ratio for compression (flange)
            const lcfr = 0.56 * Math.sqrt(E / Fy);
            const lcf = b / (2 * tf);
            const isSlenderFlange = lcf > lcfr;
            
            // ì„¸ì¥ë¹„
            const lambdaX = Kx * Lx / ix;
            const lambdaY = Ky * Ly / iy;
            const lambda = Math.max(lambdaX, lambdaY);
            
            // ì¢Œêµ´ ì‘ë ¥
            const Fe1 = Math.pow(Math.PI, 2) * E / Math.pow(lambda, 2);
            const G = E / (2 * (1 + nu));
            const Fe2 = (Math.pow(Math.PI, 2) * E * cw / Math.pow(Kz * Lx, 2) + G * J) / (Ix + Iy);
            const Fe = Math.min(Fe1, Fe2);
            const Fcr = Math.pow(0.658, Fy / Fe) * Fy;
            
            // ì••ì¶• ê°•ë„
            const phi_c = 0.9;
            const phi_Pn = phi_c * area * Fcr / 1000; // kN
            
            // íœ¨ ê°•ë„
            const Mpx = Math.min(Fy * zx, 1.6 * Fy * sx) / 1000000; // kN.m
            const Mpy = Math.min(Fy * zy, 1.6 * Fy * sy) / 1000000; // kN.m
            const phi_b = 0.9;
            const phi_Mnx = phi_b * Mpx;
            const phi_Mny = phi_b * Mpy;
            
            // ë¹„ìœ¨ ê³„ì‚°
            const ratio_comp = Pu / phi_Pn;
            const ratio_bendX = phi_Mnx > 0 ? Mux / phi_Mnx : 0;
            const ratio_bendY = phi_Mny > 0 ? Muy / phi_Mny : 0;
            
            // P-M-M ì¡°í•©
            let ratio_pmm;
            if (ratio_comp >= 0.2) {
                ratio_pmm = ratio_comp + (8/9) * (ratio_bendX + ratio_bendY);
            } else {
                ratio_pmm = ratio_comp / 2 + (ratio_bendX + ratio_bendY);
            }
            
            const isCompressiveNG = phi_Pn < Pu;
            
            return { phi_Pn, area, ratio_pmm, tw, tf, lcf, lcfr, isSlenderFlange, isCompressiveNG };
        }
        
        // Cross H ë‹¨ë©´ ê³„ì‚° í•¨ìˆ˜ (H, B íŒŒë¼ë¯¸í„° ì¶”ê°€)
        function calculateSection(tw, tf, Fy, E, nu, Kx, Ky, Kz, Lx, Ly, Pu, Mux, Muy, h1, h2, b1, b2) {
            // ===== ì…ë ¥ê°’ ê°€ì ¸ì˜¤ê¸° (Main Calculator quickCalculateì™€ ë™ì¼) =====
            const tw1 = tw;
            const tf1 = tf;
            const r1 = 0; // Built-up ë¶€ì¬
            
            const tw2 = tw;
            const tf2 = tf;
            const r2 = 0; // Built-up ë¶€ì¬

            // ===== HBeam Class calculations (Main Calculatorì™€ ì™„ì „íˆ ë™ì¼) =====
            const hw3 = h1 - 2 * tf1;
            const hw6 = h2 - 2 * tf2;
            const d1 = h1/2 - tf1/2;
            const d4 = h2/2 - tf2/2;

            // Total section area - Cross H section
            const ag1 = b1 * tf1;
            const ag2 = b1 * tf1;
            const ag3 = hw3 * tw1;
            const ag4 = b2 * tf2;
            const ag5 = b2 * tf2;
            const ag6 = hw6 * tw2;
            const ag7 = 4 * (r1*r1 - Math.PI * r1*r1 / 4);
            const ag8 = 4 * (r2*r2 - Math.PI * r2*r2 / 4);
            const ag9 = tw1 * tw2;
            const area = ag1 + ag2 + ag3 + ag4 + ag5 + ag6 + ag7 + ag8 - ag9;

            // Second inertia moment X-axis
            const Ix1 = 1/12 * b1 * Math.pow(tf1, 3) + ag1 * Math.pow(d1, 2);
            const Ix2 = 1/12 * b1 * Math.pow(tf1, 3) + ag1 * Math.pow(d1, 2);
            const Ix3 = 1/12 * tw1 * Math.pow(hw3, 3);
            const Ix4 = 1/12 * tf2 * Math.pow(b2, 3);
            const Ix5 = 1/12 * tf2 * Math.pow(b2, 3);
            const Ix6 = 1/12 * hw6 * Math.pow(tw2, 3);
            const Ix = Ix1 + Ix2 + Ix3 + Ix4 + Ix5 + Ix6;

            // Second inertia moment Y-axis
            const Iy4 = 1/12 * b2 * Math.pow(tf2, 3) + ag4 * Math.pow(d4, 2);
            const Iy5 = 1/12 * b2 * Math.pow(tf2, 3) + ag4 * Math.pow(d4, 2);
            const Iy6 = 1/12 * tw2 * Math.pow(hw6, 3);
            const Iy1 = 1/12 * tf1 * Math.pow(b1, 3);
            const Iy2 = 1/12 * tf1 * Math.pow(b1, 3);
            const Iy3 = 1/12 * hw3 * Math.pow(tw2, 3);
            const Iy = Iy1 + Iy2 + Iy3 + Iy4 + Iy5 + Iy6;

            // Radius of gyration
            const ix = Math.sqrt(Ix / area);
            const iy = Math.sqrt(Iy / area);

            // Elastic section modulus
            const sx = Ix / (h1 / 2);
            const sy = Iy / (h2 / 2);

            // Plastic section modulus Zx
            const Zx1 = (b1 * tf1) * d1;
            const Zx2 = (b1 * tf1) * d1;
            const Zx3 = (tw1 * hw3/2) * hw3/4;
            const Zx4 = (tw1 * hw3/2) * hw3/4;
            const Zx5 = (b2*b2 * tf2 / 2);
            const Zx6 = (tw2 * hw6 / 8) * 2;
            const zx = Zx1 + Zx2 + Zx3 + Zx4 + Zx5 + Zx6;

            // Plastic section modulus Zy
            const Zy1 = (b2 * tf2) * d4;
            const Zy2 = (b2 * tf2) * d4;
            const Zy3 = (tw2 * hw6/2) * hw6/4;
            const Zy4 = (tw2 * hw6/2) * hw6/4;
            const Zy5 = (b1*b1 * tf1 / 2);
            const Zy6 = (tw1 * hw3 / 8) * 2;
            const zy = Zy1 + Zy2 + Zy3 + Zy4 + Zy5 + Zy6;

            // Torsional constant J
            const J1 = (2*b1 * Math.pow(tf1, 3) + h1*Math.pow(tw1, 3)) / 3;
            const J2 = (2*b2 * Math.pow(tf2, 3) + h2*Math.pow(tw2, 3)) / 3;
            const J = J1 + J2;

            // Warping constant Cw
            const cw = Iy * Math.pow(h1 - tf1, 2) / 4;

            // ===== Column Class calculations =====
            // Plate thickness ratio for compression (Minor Section)
            const lcfr = 0.56 * Math.sqrt(E / Fy); // Î»cfr = 0.56 âˆš(E / Fy)
            const lcf = b2 / (2 * tf2); // Î»cf = B2 / 2 / tf2
            const isSlenderFlange = lcf > lcfr; // Î»cf > Î»cfrì´ë©´ Slender
            
            // Slenderness ratio
            const lambdaX = Kx * Lx / ix;
            const lambdaY = Ky * Ly / iy;
            const lambda = Math.max(lambdaX, lambdaY);

            // Flexural Buckling Stress Fe1
            const Fe1 = Math.pow(Math.PI, 2) * E / Math.pow(lambda, 2);

            // Torsional Buckling Stress Fe2
            const G = E / (2 * (1 + nu));
            const Fe2 = (Math.pow(Math.PI, 2) * E * cw / Math.pow(Kz * Lx, 2) + G * J) / (Ix + Iy);

            // Critical stress Fcr
            const Fe = Math.min(Fe1, Fe2);
            const Fcr = Math.pow(0.658, Fy / Fe) * Fy;

            // Compressive Strength phi_Pn
            const phi_c = 0.9;
            const phi_Pn = phi_c * area * Fcr / 1000; // kN

            // Flexural Strength - Mpx, Mpy
            const Mpx = Math.min(Fy * zx, 1.6 * Fy * sx) / 1000000; // kN.m
            const Mpy = Math.min(Fy * zy, 1.6 * Fy * sy) / 1000000; // kN.m
            const phi_b = 0.9;
            const phi_Mnx = phi_b * Mpx;
            const phi_Mny = phi_b * Mpy;

            // ===== ë¹„ìœ¨ ê³„ì‚° =====
            const ratio_comp = Pu / phi_Pn;
            const ratio_bendX = phi_Mnx > 0 ? Mux / phi_Mnx : 0;
            const ratio_bendY = phi_Mny > 0 ? Muy / phi_Mny : 0;

            // P-M-M ì¡°í•©
            let ratio_pmm;
            if (ratio_comp >= 0.2) {
                ratio_pmm = ratio_comp + (8/9) * (ratio_bendX + ratio_bendY);
            } else {
                ratio_pmm = ratio_comp / 2 + (ratio_bendX + ratio_bendY);
            }

            // ë””ë²„ê¹…: Main Calculatorì™€ ë¹„êµ (tw=9, tf=10, Pu=7561ì¼ ë•Œ)
            if (tw === 9 && tf === 10 && Math.abs(Pu - 7561) < 1) {
                console.log('=== Auto Find Section ê³„ì‚° ê²°ê³¼ (tw=9, tf=10, Pu=7561) ===');
                console.log(`area: ${area.toFixed(2)}`);
                console.log(`Ix: ${Ix.toFixed(2)}, Iy: ${Iy.toFixed(2)}`);
                console.log(`ix: ${ix.toFixed(2)}, iy: ${iy.toFixed(2)}`);
                console.log(`lambda: ${lambda.toFixed(4)}`);
                console.log(`Fe1: ${Fe1.toFixed(2)}, Fe2: ${Fe2.toFixed(2)}, Fe: ${Fe.toFixed(2)}`);
                console.log(`Fcr: ${Fcr.toFixed(2)}`);
                console.log(`phi_Pn: ${phi_Pn.toFixed(2)}`);
                console.log(`Mpx: ${Mpx.toFixed(4)}, Mpy: ${Mpy.toFixed(4)}`);
                console.log(`phi_Mnx: ${phi_Mnx.toFixed(4)}, phi_Mny: ${phi_Mny.toFixed(4)}`);
                console.log(`ratio_comp: ${ratio_comp.toFixed(6)}`);
                console.log(`ratio_bendX: ${ratio_bendX.toFixed(6)}, ratio_bendY: ${ratio_bendY.toFixed(6)}`);
                console.log(`P-M-M: ${ratio_pmm.toFixed(6)}`);
                console.log(`Lx: ${Lx}, Ly: ${Ly}, Kx: ${Kx}, Ky: ${Ky}, Kz: ${Kz}`);
                console.log(`Fy: ${Fy}, E: ${E}, nu: ${nu}`);
            }

            // Ï†Pn < Puì¸ ê²½ìš° NG ì²´í¬
            const isCompressiveNG = phi_Pn < Pu; // Ï†Pn < Puì´ë©´ NG
            
            return { phi_Pn, area, ratio_pmm, tw, tf, lcf, lcfr, isSlenderFlange, isCompressiveNG };
        }

        // Auto Find Section: ìµœì  tw, tf ì¡°í•© ì°¾ê¸° (íŠ¹ì • H, B ì¡°í•©ì— ëŒ€í•´)
        function findOptimalSection(Pu, Mux, Muy, Fy, E, nu, Kx, Ky, Kz, Lx, Ly, h1, h2, b1, b2) {
            let bestTw = null;
            let bestTf = null;
            let bestArea = Infinity;
            let bestPMM = 0;
            let bestDiff = Infinity; // 1.0ê³¼ì˜ ì°¨ì´
            let bestIsSlenderFlange = false;

            // ëª¨ë“  tw, tf ì¡°í•© ì‹œë„
            const twRange = getTwRange();
            const tfRange = getTfRange();
            for (const tw of twRange) {
                for (const tf of tfRange) {
                    if (tf < tw) continue; // tf >= tw ì¡°ê±´

                    const result = calculateSection(tw, tf, Fy, E, nu, Kx, Ky, Kz, Lx, Ly, Pu, Mux, Muy, h1, h2, b1, b2);
                    
                    // Î»cf > Î»cfrì¸ ê²½ìš° ì œì™¸ (Slender flange)
                    if (result.isSlenderFlange) continue;
                    
                    // P-M-M â‰¤ 1.0ì„ ë§Œì¡±í•˜ëŠ” ìµœì†Œ ë‹¨ë©´ì  ë‹¨ë©´ ì°¾ê¸° (ratioëŠ” 1.0ê¹Œì§€ í—ˆìš©)
                    if (result.ratio_pmm > 0 && result.ratio_pmm <= 1.0) {
                        if (result.area < bestArea) {
                            bestArea = result.area;
                            bestTw = tw;
                            bestTf = tf;
                            bestPMM = result.ratio_pmm;
                            bestDiff = Math.abs(1.0 - result.ratio_pmm);
                            bestIsSlenderFlange = result.isSlenderFlange;
                        }
                    }
                }
            }

            // P-M-M â‰¤ 1.0ì„ ë§Œì¡±í•˜ëŠ” ë‹¨ë©´ì´ ì—†ìœ¼ë©´, P-M-Mê°€ ê°€ì¥ ì‘ì€ ë‹¨ë©´ ë°˜í™˜
            // ratioëŠ” 1.0ê¹Œì§€ í—ˆìš©í•˜ë¯€ë¡œ, 1.0ì„ ì´ˆê³¼í•˜ëŠ” ê²½ìš°ëŠ” ìµœì†Œ ratioë¥¼ ì„ íƒ (ë‹¨, Î»cf â‰¤ Î»cfrì´ê³  Ï†Pn â‰¥ Puì¸ ê²½ìš°ë§Œ)
            if (bestTw === null) {
                let minPMM = Infinity;
                const twRange2 = getTwRange();
                const tfRange2 = getTfRange();
                for (const tw of twRange2) {
                    for (const tf of tfRange2) {
                        if (tf < tw) continue;
                        const result = calculateSection(tw, tf, Fy, E, nu, Kx, Ky, Kz, Lx, Ly, Pu, Mux, Muy, h1, h2, b1, b2);
                        
                        // Î»cf > Î»cfrì¸ ê²½ìš° ì œì™¸
                        if (result.isSlenderFlange) continue;
                        
                        // Ï†Pn < Puì¸ ê²½ìš° ì œì™¸ (NG)
                        if (result.isCompressiveNG) continue;
                        
                        if (result.ratio_pmm < minPMM) {
                            minPMM = result.ratio_pmm;
                            bestArea = result.area;
                            bestTw = tw;
                            bestTf = tf;
                            bestPMM = result.ratio_pmm;
                            bestIsSlenderFlange = result.isSlenderFlange;
                        }
                    }
                }
            }

            return { tw: bestTw, tf: bestTf, area: bestArea, ratioPMM: bestPMM, isSlenderFlange: bestIsSlenderFlange };
        }

        // ë‹¨ì¤‘ ê³„ì‚° (kg/m)
        function calculateUnitWeight(area) {
            return (area / 1000000) * steelDensity;
        }

        // ëª¨ë“  ê³„ì‚° ìˆ˜í–‰
        function calculateAll() {
            const E = 210000;
            const nu = 0.3;
            const Kx = parseFloat(document.getElementById('Kx').value) || 0.8;
            const Ky = parseFloat(document.getElementById('Ky').value) || 0.8;
            const Kz = parseFloat(document.getElementById('Kz').value) || 0.8;

            currentResults = [];
            const tbody = document.getElementById('resultTableBody');
            tbody.innerHTML = '';

            // ì…ë ¥ í…Œì´ë¸”ì—ì„œ í˜„ì¬ ê°’ì„ ë‹¤ì‹œ ì½ì–´ì™€ì„œ columnData ì—…ë°ì´íŠ¸
            const count = parseInt(document.getElementById('columnCount').value) || 0;
            columnData = [];
            
            for (let i = 1; i <= count; i++) {
                const nameInput = document.getElementById(`col${i}_name`);
                const puInput = document.getElementById(`col${i}_Pu`);
                const muxInput = document.getElementById(`col${i}_Mux`);
                const muyInput = document.getElementById(`col${i}_Muy`);
                
                if (nameInput || puInput || muxInput || muyInput) {
                    columnData.push({
                        no: i,
                        name: nameInput?.value?.trim() || `KC${i}`,
                        pu: parseFloat(puInput?.value) || 0,
                        mux: parseFloat(muxInput?.value) || 0,
                        muy: parseFloat(muyInput?.value) || 0
                    });
                }
            }

            // columnData ë°°ì—´ì˜ ëª¨ë“  ê¸°ë‘¥ì— ëŒ€í•´ ê³„ì‚° (ê¸°ë³¸ ê¸¸ì´ íƒ€ì… 1 ì‚¬ìš©)
            if (columnData.length === 0) {
                alert('í•˜ì¤‘ ì…ë ¥ í…Œì´ë¸”ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. Pu ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            console.log(`ê³„ì‚° ì‹œì‘: ${columnData.length}ê°œ ê¸°ë‘¥ ì²˜ë¦¬`);
            
            columnData.forEach(col => {
                try {
                    // Pu ê°’ì´ 0ì´ê±°ë‚˜ ì…ë ¥ë˜ì§€ ì•Šì€ ê²½ìš°ë„ ê²°ê³¼ì— í¬í•¨ (ê²½ê³  í‘œì‹œ)
                    if (col.pu <= 0) {
                        currentResults.push({
                            no: col.no,
                            name: col.name || `KC${col.no}`,
                            pu: col.pu || 0,
                            mux: col.mux || 0,
                            muy: col.muy || 0,
                            pmm: 0,
                            steelGrade: 'SM420/SM355',
                            combination: '-',
                            kx: Kx,
                            lx: 4.5,
                            ly: 4.5,
                            h: 0,
                            b: 0,
                            tw: 0,
                            tf: 0,
                            area: 0,
                            unitWeight: 0,
                            Fy: 355,
                            E: E,
                            nu: nu,
                            Ky: Ky,
                            Kz: Kz,
                            isSlenderFlange: false,
                            lcf: 0,
                            lcfr: 0,
                            isCompressiveNG: false,
                            phi_Pn: 0,
                            H1: 0,
                            H2: 0,
                            B1: 0,
                            B2: 0,
                            warning: 'Pu ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'
                        });
                        console.warn(`ê¸°ë‘¥ ${col.name || col.no}: Pu ê°’ì´ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.`);
                        return;
                    }
                    
                    // ê³µí†µ ì„¤ì •ì˜ Lx, Ly ê°’ ì‚¬ìš©
                    const commonLx = parseFloat(document.getElementById('Lx')?.value) || 4.5; // m
                    const commonLy = parseFloat(document.getElementById('Ly')?.value) || 4.5; // m
                    const Lx = commonLx * 1000; // m to mm
                    const Ly = commonLy * 1000; // m to mm
                    
                    // ì¡°í•©ë³„ ê°•ì¢… ì„¤ì •: ì¡°í•© 1, 2ëŠ” SM420ê³¼ SM355, ì¡°í•© 3ì€ SM355ë§Œ
                    const steelGradesForComb1_2 = [
                        { fy: 420, unitPrice: 1900000 }, // SM420: 1,900,000ì›/í†¤
                        { fy: 355, unitPrice: 1830000 }  // SM355: 1,830,000ì›/í†¤
                    ];
                    const steelGradesForComb3 = [
                        { fy: 355, unitPrice: 1830000 }  // SM355: 1,830,000ì›/í†¤
                    ];
                    let bestResult = null;
                    let bestCombination = null;
                    let bestFy = null;
                    let bestUnitPrice = null;
                    let bestCostPerMeter = Infinity; // ë‹¨ìœ„ ê¸¸ì´ë‹¹ ê¸ˆì•¡ (ì›/m)
                    
                    // ì¡°í•©ë³„ë¡œ ê³„ì‚°
                    combinations.forEach((comb, combIndex) => {
                        // ì¡°í•© 1, 2 (ì¸ë±ìŠ¤ 0, 1)ëŠ” SM420ê³¼ SM355 ëª¨ë‘ ê³„ì‚°
                        // ì¡°í•© 3 (ì¸ë±ìŠ¤ 2 ì´ìƒ)ì€ SM355ë§Œ ê³„ì‚°
                        const steelGrades = (combIndex < 2) ? steelGradesForComb1_2 : steelGradesForComb3;
                        
                        for (const steel of steelGrades) {
                            const fy = steel.fy;
                            const unitPricePerTon = steel.unitPrice;
                            const unitPricePerKg = unitPricePerTon / 1000; // í†¤ë‹¹ ë‹¨ê°€ë¥¼ kgë‹¹ ë‹¨ê°€ë¡œ ë³€í™˜
                            
                            const optimal = findOptimalSection(
                                col.pu, col.mux, col.muy, fy, E, nu, Kx, Ky, Kz, Lx, Ly,
                                comb.H1, comb.H2, comb.B1, comb.B2
                            );
                            
                            if (optimal && optimal.tw && optimal.tf) {
                                // ë‹¨ì¤‘ ê³„ì‚°
                                const unitWeight = calculateUnitWeight(optimal.area);
                                // ë‹¨ìœ„ ê¸¸ì´ë‹¹ ê¸ˆì•¡ = ë‹¨ì¤‘(kg/m) Ã— ë‹¨ê°€(ì›/kg)
                                const costPerMeter = unitWeight * unitPricePerKg;
                                
                                // ë” ì‘ì€ ë‹¨ìœ„ ê¸¸ì´ë‹¹ ê¸ˆì•¡ì„ ì„ íƒ (ë‹¨ê°€ ë°˜ì˜)
                                if (costPerMeter < bestCostPerMeter) {
                                    bestResult = optimal;
                                    bestCombination = comb;
                                    bestFy = fy;
                                    bestUnitPrice = unitPricePerTon;
                                    bestCostPerMeter = costPerMeter;
                                }
                            }
                        }
                    });
                    
                    if (bestResult && bestResult.tw && bestResult.tf) {
                        // ìµœì¢… ê³„ì‚° ê²°ê³¼ (ì¬ê³„ì‚°ì„ ìœ„í•´)
                        const calcResult = calculateSection(
                            bestResult.tw, bestResult.tf, bestFy, E, nu, Kx, Ky, Kz, Lx, Ly, 
                            col.pu, col.mux, col.muy,
                            bestCombination.H1, bestCombination.H2, bestCombination.B1, bestCombination.B2
                        );
                        
                        const unitWeight = calculateUnitWeight(bestResult.area);
                        const costPerMeter = unitWeight * (bestUnitPrice / 1000); // ë‹¨ìœ„ ê¸¸ì´ë‹¹ ê¸ˆì•¡ (ì›/m)

                        // ê²°ê³¼ ê°ì²´ ìƒì„±
                        currentResults.push({
                            no: col.no,
                            name: col.name || `KC${col.no}`,
                            pu: col.pu,
                            mux: col.mux,
                            muy: col.muy,
                            pmm: bestResult.ratioPMM || calcResult.ratio_pmm || 0,
                            steelGrade: `SM${bestFy}`,
                            combination: bestCombination.name,
                            kx: Kx,
                            lx: Lx / 1000, // mm to m
                            ly: Ly / 1000, // mm to m
                            h: bestCombination.H1,
                            b: bestCombination.B1,
                            tw: bestResult.tw,
                            tf: bestResult.tf,
                            area: bestResult.area,
                            unitWeight: unitWeight,
                            unitPrice: bestUnitPrice, // í†¤ë‹¹ ë‹¨ê°€
                            costPerMeter: costPerMeter, // ë‹¨ìœ„ ê¸¸ì´ë‹¹ ê¸ˆì•¡
                            Fy: bestFy,
                            E: E,
                            nu: nu,
                            Ky: Ky,
                            Kz: Kz,
                            isSlenderFlange: bestResult.isSlenderFlange || calcResult.isSlenderFlange,
                            lcf: calcResult.lcf,
                            lcfr: calcResult.lcfr,
                            isCompressiveNG: calcResult.isCompressiveNG,
                            phi_Pn: calcResult.phi_Pn,
                            H1: bestCombination.H1,
                            H2: bestCombination.H2,
                            B1: bestCombination.B1,
                            B2: bestCombination.B2
                        });
                        
                        console.log(`ê¸°ë‘¥ ${col.name || col.no}: ê°•ì¢…=SM${bestFy}, ì¡°í•©=${bestCombination.name}, Pu=${col.pu}, tw=${bestResult.tw}, tf=${bestResult.tf}, P-M-M=${bestResult.ratioPMM?.toFixed(3)}, Area=${bestResult.area?.toFixed(2)}, ë‹¨ê°€=${bestUnitPrice.toLocaleString()}ì›/í†¤, ë‹¨ìœ„ê¸¸ì´ë‹¹ê¸ˆì•¡=${costPerMeter.toFixed(0)}ì›/m`);
                    } else {
                        // ìµœì  ë‹¨ë©´ì„ ì°¾ì§€ ëª»í•œ ê²½ìš°ë„ ê²°ê³¼ì— í¬í•¨ (ê²½ê³  í‘œì‹œ)
                        currentResults.push({
                            no: col.no,
                            name: col.name || `KC${col.no}`,
                            pu: col.pu,
                            mux: col.mux,
                            muy: col.muy,
                            pmm: 0,
                            steelGrade: 'SM420/SM355',
                            combination: '-',
                            kx: Kx,
                            lx: Lx / 1000,
                            ly: Ly / 1000,
                            h: 0,
                            b: 0,
                            tw: 0,
                            tf: 0,
                            area: 0,
                            unitWeight: 0,
                            Fy: 355,
                            E: E,
                            nu: nu,
                            Ky: Ky,
                            Kz: Kz,
                            isSlenderFlange: false,
                            lcf: 0,
                            lcfr: 0,
                            isCompressiveNG: false,
                            phi_Pn: 0,
                            H1: 0,
                            H2: 0,
                            B1: 0,
                            B2: 0,
                            warning: 'ìµœì  ë‹¨ë©´ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í•˜ì¤‘ ì¡°ê±´ì„ í™•ì¸í•´ì£¼ì„¸ìš”.'
                        });
                        console.error(`ê¸°ë‘¥ ${col.name || col.no}: ëª¨ë“  ì¡°í•©ê³¼ ê°•ì¢…(SM420, SM355)ì—ì„œ ìµœì  ë‹¨ë©´ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                    }
                } catch (error) {
                    // ê³„ì‚° ì˜¤ë¥˜ê°€ ë°œìƒí•œ ê²½ìš°ë„ ê²°ê³¼ì— í¬í•¨ (ê²½ê³  í‘œì‹œ)
                    currentResults.push({
                        no: col.no,
                        name: col.name || `KC${col.no}`,
                        pu: col.pu || 0,
                        mux: col.mux || 0,
                        muy: col.muy || 0,
                        pmm: 0,
                        steelGrade: 'SM420/SM355',
                        combination: '-',
                        kx: Kx,
                        lx: 4.5,
                        ly: 4.5,
                        h: 0,
                        b: 0,
                        tw: 0,
                        tf: 0,
                        area: 0,
                        unitWeight: 0,
                        Fy: 355,
                        E: E,
                        nu: nu,
                        Ky: Ky,
                        Kz: Kz,
                        isSlenderFlange: false,
                        lcf: 0,
                        lcfr: 0,
                        isCompressiveNG: false,
                        phi_Pn: 0,
                        H1: 0,
                        H2: 0,
                        B1: 0,
                        B2: 0,
                        warning: `ê³„ì‚° ì˜¤ë¥˜: ${error.message}`
                    });
                    console.error(`ê¸°ë‘¥ ${col.name || col.no} ê³„ì‚° ì˜¤ë¥˜:`, error);
                }
            });

            // ê²°ê³¼ í…Œì´ë¸”ì— í‘œì‹œ
            if (currentResults.length > 0) {
                renderResults();
                console.log(`ê³„ì‚° ì™„ë£Œ: ${currentResults.length}ê°œ ê²°ê³¼ ìƒì„±ë¨`);
            } else {
                tbody.innerHTML = '<tr><td colspan="13" style="text-align: center; padding: 30px; color: #999;">Pu ê°’ì„ ì…ë ¥í•œ í•˜ì¤‘ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                console.warn('ê³„ì‚° ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. Pu ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            }
        }

        // ê²°ê³¼ í…Œì´ë¸” ë Œë”ë§
        function renderResults() {
            const tbody = document.getElementById('resultTableBody');
            tbody.innerHTML = '';
            
            // ë™ì  ë‘ê»˜ ë²”ìœ„ ê°€ì ¸ì˜¤ê¸°
            const twMin = parseInt(document.getElementById('twMin')?.value) || 8;
            const twMax = parseInt(document.getElementById('twMax')?.value) || 16;
            const tfMin = parseInt(document.getElementById('tfMin')?.value) || 10;
            const tfMax = parseInt(document.getElementById('tfMax')?.value) || 20;
            
            currentResults.forEach(result => {
                const row = document.createElement('tr');
                row.setAttribute('data-no', result.no);
                
                // ê²½ê³  ë©”ì‹œì§€ê°€ ìˆëŠ” ê²½ìš°
                if (result.warning) {
                    row.innerHTML = `
                        <td style="text-align: center; font-weight: 600;">${result.no}</td>
                        <td colspan="14" style="text-align: center; padding: 15px; color: #e53e3e; font-weight: 600; background: #fed7d7; border-radius: 4px;">
                            ${result.name}: ${result.warning}
                        </td>
                    `;
                    row.style.backgroundColor = '#fed7d7';
                } else {
                    // Î»cf > Î»cfr ê²½ê³  í‘œì‹œ
                    const slenderWarning = result.isSlenderFlange ? 
                        `<div style="color: #e53e3e; font-size: 11px; margin-top: 4px; font-weight: 600;">âš  Slender check needed</div>` : '';
                    
                    // Ï†Pn < Pu ê²½ê³  í‘œì‹œ (NG)
                    const compressiveWarning = result.isCompressiveNG ? 
                        `<div style="color: #e53e3e; font-size: 11px; margin-top: 4px; font-weight: 600;">âš  Compressive NG (Ï†Pn < Pu)</div>` : '';
                    
                    const warningText = slenderWarning + compressiveWarning;
                    
                    row.innerHTML = `
                        <td style="text-align: center; font-weight: 600;">${result.no}</td>
                        <td style="font-weight: 600; color: #667eea;">${result.name}${warningText}</td>
                        <td style="text-align: right;">${result.pu.toFixed(1)}</td>
                        <td class="pmm-cell" style="text-align: right; ${result.pmm > 1.0 ? 'color: #e53e3e; font-weight: 600;' : 'color: #38a169;'}">${result.pmm > 0 ? result.pmm.toFixed(3) : '-'}</td>
                        <td style="text-align: center;">${result.steelGrade}</td>
                        <td style="text-align: center; font-weight: 600; color: #667eea;">${result.combination || '-'}</td>
                        <td style="text-align: center;">${result.kx.toFixed(1)}</td>
                        <td style="text-align: right;">${result.lx.toFixed(1)}</td>
                        <td style="text-align: center;">${result.h}</td>
                        <td style="text-align: center;">${result.b}</td>
                        <td style="text-align: center;">
                            <input type="number" id="tw_${result.no}" value="${result.tw || ''}" min="${twMin}" max="${twMax}" step="1" 
                                   style="width: 60px; text-align: center; font-weight: 600; color: #667eea; border: 1px solid #cbd5e0; border-radius: 4px; padding: 4px;"
                                   onchange="recalculateRow(${result.no})">
                        </td>
                        <td style="text-align: center;">
                            <input type="number" id="tf_${result.no}" value="${result.tf || ''}" min="${tfMin}" max="${tfMax}" step="1"
                                   style="width: 60px; text-align: center; font-weight: 600; color: #667eea; border: 1px solid #cbd5e0; border-radius: 4px; padding: 4px;"
                                   onchange="recalculateRow(${result.no})">
                        </td>
                        <td class="area-cell" style="text-align: right;">${result.area ? result.area.toFixed(2) : '-'}</td>
                        <td class="weight-cell" style="text-align: right;">${result.unitWeight ? result.unitWeight.toFixed(4) : '-'}</td>
                        <td style="text-align: right; color: #667eea; font-weight: 600;">${result.unitPrice ? result.unitPrice.toLocaleString('ko-KR') : '-'}</td>
                        <td style="text-align: right; color: #38a169; font-weight: 600;">${result.costPerMeter ? result.costPerMeter.toFixed(0) : '-'}</td>
                    `;
                }
                tbody.appendChild(row);
            });
            
            // ì¡°í•© 1/2ì™€ ì¡°í•© 3 ê²°ê³¼ í™•ì¸
            const comb3Names = ['H400Ã—B200', 'H450Ã—B200', 'H500Ã—B200', 'H506Ã—B201', 'H482Ã—B300', 'H488Ã—B300', 'H582Ã—B300', 'H588Ã—B300', 'H600Ã—B200'];
            const hasComb3Result = currentResults.some(result => {
                if (result.warning || !result.combination) return false;
                return comb3Names.some(name => result.combination === name);
            });
            const hasComb1_2Result = currentResults.some(result => {
                if (result.warning || !result.combination) return false;
                return result.combination.startsWith('BH'); // ì¡°í•©1,2ëŠ” BHë¡œ ì‹œì‘
            });
            
            // ê¸°ì¡´ Note ì œê±°
            const existingNote1 = document.getElementById('comb3NoResultNote');
            if (existingNote1) existingNote1.remove();
            const existingNote2 = document.getElementById('combParallelNote');
            if (existingNote2) existingNote2.remove();
            
            // Note ì¶”ê°€ ì¡°ê±´ í™•ì¸
            const tableContainer = tbody.parentElement.parentElement; // tableì˜ ë¶€ëª¨ div
            
            // ì¡°ê±´ 1: ì¡°í•© 1/2ì™€ ì¡°í•© 3ì´ ë³‘í–‰ í‘œê¸°ë  ë•Œ
            if (hasComb1_2Result && hasComb3Result) {
                const noteDiv = document.createElement('div');
                noteDiv.id = 'combParallelNote';
                noteDiv.style.cssText = 'margin-top: 15px; padding: 12px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; font-size: 13px; color: #856404; line-height: 1.6;';
                noteDiv.innerHTML = '<strong>Note:</strong> ì¡°í•© 1 ë˜ëŠ” ì¡°í•© 2 (Built-Up Cross H&lt;SM420/SM355&gt;)ì™€ ì¡°í•© 3 (Rolled H ë‹¨ë©´&lt;SM355&gt;)ì´ ë³‘í–‰í•˜ì—¬ í‘œê¸°ë©ë‹ˆë‹¤. BOQì‘ì„±ì‹œ ìœ ì˜í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.';
                tableContainer.appendChild(noteDiv);
            }
            // ì¡°ê±´ 2: ì¡°í•© 3 ê²°ê³¼ê°€ ì—†ì„ ë•Œ
            else if (!hasComb3Result && currentResults.length > 0) {
                const noteDiv = document.createElement('div');
                noteDiv.id = 'comb3NoResultNote';
                noteDiv.style.cssText = 'margin-top: 15px; padding: 12px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; font-size: 13px; color: #856404; line-height: 1.6;';
                noteDiv.innerHTML = '<strong>Note:</strong> ì¡°í•© 3 (Rolled H ë‹¨ë©´&lt;SM355&gt;: H400, H450, H500, H506, H482, H488, H582, H588, H600)ì˜ ì ìš©ì´ ì—†ìŠµë‹ˆë‹¤. SM420 ë‹¨ë©´ì´ ë³´ë‹¤ ê²½ì œì  ë‹¨ë©´ì¸ ê²°ê³¼ê°’ì„ ì œê³µí•©ë‹ˆë‹¤.';
                tableContainer.appendChild(noteDiv);
            }
        }

        // Auto Find Section ê²°ê³¼ë¥¼ Excelë¡œ ë‹¤ìš´ë¡œë“œ
        function exportResultToExcel() {
            if (!currentResults || currentResults.length === 0) {
                alert('ë‹¤ìš´ë¡œë“œí•  ê²°ê³¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ê³„ì‚°ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                // í—¤ë” í–‰ ìƒì„±
                const wsData = [
                    ['No.', 'ê¸°ë‘¥ëª…', 'Pu (kN)', 'P-M-M', 'ê°•ì¢…', 'ì¡°í•©', 'K', 'L (m)', 'H (mm)', 'B (mm)', 'tw (mm)', 'tf (mm)', 'ë‹¨ë©´ì  (mmÂ²)', 'ë‹¨ì¤‘ (kg/m)', 'ë‹¨ê°€ (ì›/í†¤)', 'ë‹¨ìœ„ê¸¸ì´ë‹¹ ê¸ˆì•¡ (ì›/m)', 'ë¹„ê³ ']
                ];

                // ë°ì´í„° í–‰ ì¶”ê°€
                currentResults.forEach(result => {
                    if (result.warning) {
                        // ê²½ê³ ê°€ ìˆëŠ” ê²½ìš°
                        wsData.push([
                            result.no || '',
                            result.name || '',
                            result.pu || 0,
                            '-',
                            '-',
                            '-',
                            '-',
                            '-',
                            '-',
                            '-',
                            '-',
                            '-',
                            '-',
                            '-',
                            '-',
                            '-',
                            result.warning || ''
                        ]);
                    } else {
                        // ì •ìƒ ê²°ê³¼
                        const remarks = [];
                        if (result.isSlenderFlange) {
                            remarks.push('Slender check needed');
                        }
                        if (result.isCompressiveNG) {
                            remarks.push('Compressive NG (Ï†Pn < Pu)');
                        }
                        if (result.pmm > 1.0) {
                            remarks.push('P-M-M > 1.0');
                        }

                        wsData.push([
                            result.no || '',
                            result.name || '',
                            result.pu ? result.pu.toFixed(1) : 0,
                            result.pmm > 0 ? result.pmm.toFixed(3) : '-',
                            result.steelGrade || '-',
                            result.combination || '-',
                            result.kx ? result.kx.toFixed(1) : '-',
                            result.lx ? result.lx.toFixed(1) : '-',
                            result.h || '-',
                            result.b || '-',
                            result.tw || '-',
                            result.tf || '-',
                            result.area ? result.area.toFixed(2) : '-',
                            result.unitWeight ? result.unitWeight.toFixed(4) : '-',
                            result.unitPrice ? result.unitPrice.toLocaleString('ko-KR') : '-',
                            result.costPerMeter ? result.costPerMeter.toFixed(0) : '-',
                            remarks.join(', ') || '-'
                        ]);
                    }
                });

                // ì›Œí¬ë¶ ìƒì„±
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(wsData);

                // ì—´ ë„ˆë¹„ ì„¤ì •
                ws['!cols'] = [
                    { wch: 6 },   // No.
                    { wch: 12 },  // ê¸°ë‘¥ëª…
                    { wch: 10 },  // Pu
                    { wch: 10 },  // P-M-M
                    { wch: 10 },  // ê°•ì¢…
                    { wch: 15 },  // ì¡°í•©
                    { wch: 6 },   // K
                    { wch: 8 },   // L
                    { wch: 8 },   // H
                    { wch: 8 },   // B
                    { wch: 8 },   // tw
                    { wch: 8 },   // tf
                    { wch: 12 },  // ë‹¨ë©´ì 
                    { wch: 10 },  // ë‹¨ì¤‘
                    { wch: 12 },  // ë‹¨ê°€
                    { wch: 15 },  // ë‹¨ìœ„ê¸¸ì´ë‹¹ ê¸ˆì•¡
                    { wch: 30 }   // ë¹„ê³ 
                ];

                // ì‹œíŠ¸ ì¶”ê°€
                XLSX.utils.book_append_sheet(wb, ws, 'Auto Find Section Result');

                // íŒŒì¼ëª… ìƒì„± (ë‚ ì§œ í¬í•¨)
                const now = new Date();
                const dateStr = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}`;
                const fileName = `AutoFindSectionResult_${dateStr}.xlsx`;

                // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                XLSX.writeFile(wb, fileName);
                alert(`Auto Find Section ê²°ê³¼ê°€ "${fileName}" íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`);
            } catch (error) {
                console.error('Excel ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('Excel íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // íŠ¹ì • í–‰ ì¬ê³„ì‚° (tw, tf ë³€ê²½ ì‹œ)
        function recalculateRow(no) {
            const result = currentResults.find(r => r.no === no);
            if (!result) return;

            const tw = parseFloat(document.getElementById(`tw_${no}`).value);
            const tf = parseFloat(document.getElementById(`tf_${no}`).value);
            
            const twMin = parseInt(document.getElementById('twMin')?.value) || 8;
            const twMax = parseInt(document.getElementById('twMax')?.value) || 16;
            const tfMin = parseInt(document.getElementById('tfMin')?.value) || 10;
            const tfMax = parseInt(document.getElementById('tfMax')?.value) || 20;

            if (!tw || !tf || tf < tw) {
                alert(`ê¸°ë‘¥ ${result.name}: tfëŠ” twë³´ë‹¤ í¬ê±°ë‚˜ ê°™ì•„ì•¼ í•©ë‹ˆë‹¤.`);
                // ì›ë˜ ê°’ìœ¼ë¡œ ë³µì›
                document.getElementById(`tw_${no}`).value = result.tw;
                document.getElementById(`tf_${no}`).value = result.tf;
                return;
            }
            
            if (tw < twMin || tw > twMax) {
                alert(`ê¸°ë‘¥ ${result.name}: twëŠ” ${twMin}~${twMax}mm ë²”ìœ„ ë‚´ì—¬ì•¼ í•©ë‹ˆë‹¤.`);
                document.getElementById(`tw_${no}`).value = result.tw;
                document.getElementById(`tf_${no}`).value = result.tf;
                return;
            }
            
            if (tf < tfMin || tf > tfMax) {
                alert(`ê¸°ë‘¥ ${result.name}: tfëŠ” ${tfMin}~${tfMax}mm ë²”ìœ„ ë‚´ì—¬ì•¼ í•©ë‹ˆë‹¤.`);
                document.getElementById(`tw_${no}`).value = result.tw;
                document.getElementById(`tf_${no}`).value = result.tf;
                return;
            }

            try {
                // ì¬ê³„ì‚° (ê¸°ì¡´ ì¡°í•© ë° ê¸¸ì´ ì‚¬ìš©)
                const calcResult = calculateSection(
                    tw, tf, result.Fy, result.E, result.nu, result.kx, result.Ky, result.Kz, 
                    result.lx * 1000, result.ly * 1000, result.pu, result.mux, result.muy,
                    result.H1, result.H2, result.B1, result.B2
                );
                const unitWeight = calculateUnitWeight(calcResult.area);
                
                // Î»cf > Î»cfr ì²´í¬
                const lcfr = 0.56 * Math.sqrt(result.E / result.Fy);
                const lcf = result.B2 / (2 * tf);
                const isSlenderFlange = lcf > lcfr;
                
                // Ï†Pn < Pu ì²´í¬ (NG)
                const isCompressiveNG = calcResult.phi_Pn < result.pu;

                // ê²°ê³¼ ì—…ë°ì´íŠ¸
                result.tw = tw;
                result.tf = tf;
                result.pmm = calcResult.ratio_pmm || 0;
                result.area = calcResult.area;
                result.unitWeight = unitWeight;
                result.isSlenderFlange = isSlenderFlange;
                result.lcf = lcf;
                result.lcfr = lcfr;
                result.isCompressiveNG = isCompressiveNG;
                result.phi_Pn = calcResult.phi_Pn;

                // í…Œì´ë¸” ì…€ ì—…ë°ì´íŠ¸
                const row = document.querySelector(`tr[data-no="${no}"]`);
                if (row) {
                    // ê¸°ë‘¥ëª… ì…€ì— ê²½ê³  ë©”ì‹œì§€ ì¶”ê°€/ì œê±°
                    const nameCell = row.querySelector('td:nth-child(2)');
                    if (nameCell) {
                        const baseName = result.name.split('âš ')[0].trim();
                        let warningHTML = '';
                        if (isSlenderFlange) {
                            warningHTML += `<div style="color: #e53e3e; font-size: 11px; margin-top: 4px; font-weight: 600;">âš  Slender check needed</div>`;
                        }
                        if (isCompressiveNG) {
                            warningHTML += `<div style="color: #e53e3e; font-size: 11px; margin-top: 4px; font-weight: 600;">âš  Compressive NG (Ï†Pn < Pu)</div>`;
                        }
                        nameCell.innerHTML = baseName + warningHTML;
                    }
                    
                    const pmmCell = row.querySelector('.pmm-cell');
                    const areaCell = row.querySelector('.area-cell');
                    const weightCell = row.querySelector('.weight-cell');

                    if (pmmCell) {
                        pmmCell.textContent = result.pmm > 0 ? result.pmm.toFixed(3) : '-';
                        pmmCell.style.color = result.pmm > 1.0 ? '#e53e3e' : '#38a169';
                        pmmCell.style.fontWeight = result.pmm > 1.0 ? '600' : 'normal';
                    }
                    if (areaCell) {
                        areaCell.textContent = result.area ? result.area.toFixed(2) : '-';
                    }
                    if (weightCell) {
                        weightCell.textContent = result.unitWeight ? result.unitWeight.toFixed(4) : '-';
                    }
                }

                console.log(`ê¸°ë‘¥ ${result.name}: tw=${tw}, tf=${tf}ë¡œ ì¬ê³„ì‚° - P-M-M=${result.pmm.toFixed(3)}, Area=${result.area.toFixed(2)}`);
            } catch (error) {
                console.error(`ê¸°ë‘¥ ${result.name} ì¬ê³„ì‚° ì˜¤ë¥˜:`, error);
                alert(`ì¬ê³„ì‚° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            }
        }

        // Type ê¸¸ì´ ë°ì´í„° ì €ì¥
        let typeLengths = {
            type1: 26.478,
            type2: 23.678,
            type3: 25.938,
            type4: 22.438
        };

        // ê¸°ë‘¥ë³„ Type ê¸¸ì´ ë°ì´í„° ì €ì¥
        let columnLengthData = {};

        // Type ê¸¸ì´ ì—…ë°ì´íŠ¸
        function updateTypeLengths() {
            typeLengths.type1 = parseFloat(document.getElementById('Lx_type1').value) || 26.478;
            typeLengths.type2 = parseFloat(document.getElementById('Lx_type2').value) || 23.678;
            typeLengths.type3 = parseFloat(document.getElementById('Lx_type3').value) || 25.938;
            typeLengths.type4 = parseFloat(document.getElementById('Lx_type4').value) || 22.438;
        }

        // ë‘ê»˜ ë²”ìœ„ ì—…ë°ì´íŠ¸ ë° í‘œì‹œ
        function updateThicknessRanges() {
            const twMin = parseInt(document.getElementById('twMin')?.value) || 8;
            const twMax = parseInt(document.getElementById('twMax')?.value) || 16;
            const tfMin = parseInt(document.getElementById('tfMin')?.value) || 10;
            const tfMax = parseInt(document.getElementById('tfMax')?.value) || 20;
            
            // ìµœì†Œê°’ì´ ìµœëŒ€ê°’ë³´ë‹¤ í¬ë©´ êµì •
            if (twMin > twMax) {
                document.getElementById('twMax').value = twMin;
            }
            if (tfMin > tfMax) {
                document.getElementById('tfMax').value = tfMin;
            }
            
            // ì•ˆë‚´ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
            const twRangeDisplay = document.getElementById('twRangeDisplay');
            const tfRangeDisplay = document.getElementById('tfRangeDisplay');
            if (twRangeDisplay) {
                twRangeDisplay.textContent = `${twMin}~${twMax}`;
            }
            if (tfRangeDisplay) {
                tfRangeDisplay.textContent = `${tfMin}~${tfMax}`;
            }
        }

        // BOQ ìƒì„± í•¨ìˆ˜ (ê¸¸ì´ ì…ë ¥ ëª¨ë‹¬ ë¨¼ì € í‘œì‹œ)
        function generateBOQ() {
            if (currentResults.length === 0) {
                alert('ë¨¼ì € ê³„ì‚°ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ê¸°ë‘¥ë³„ë¡œ ê³ ìœ í•œ ì´ë¦„ ì¶”ì¶œ
            const uniqueColumns = {};
            currentResults.forEach(result => {
                if (!uniqueColumns[result.name]) {
                    const existingData = columnLengthData[result.name] || {};
                    uniqueColumns[result.name] = {
                        name: result.name,
                        count_type1: existingData.count_type1 || 0,
                        count_type2: existingData.count_type2 || 0,
                        count_type3: existingData.count_type3 || 0,
                        count_type4: existingData.count_type4 || 0
                    };
                }
            });

            // ê¸¸ì´ ì…ë ¥ ëª¨ë‹¬ í‘œì‹œ
            showBOQLengthModal(Object.values(uniqueColumns));
        }

        // BOQ ê¸¸ì´ ì…ë ¥ ëª¨ë‹¬ í‘œì‹œ (ê¸°ë‘¥ë³„ Type ê°œìˆ˜ ì…ë ¥)
        function showBOQLengthModal(columns) {
            const modal = document.getElementById('boqLengthModal');
            if (!modal) {
                addBOQLengthModal();
            }

            const tbody = document.getElementById('boqLengthTableBody');
            tbody.innerHTML = '';

            columns.forEach((col, index) => {
                // ê¸°ì¡´ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ 0
                const existingData = columnLengthData[col.name] || {};
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="text-align: center; font-weight: 600;">${index + 1}</td>
                    <td style="font-weight: 600; color: #667eea;">${col.name}</td>
                    <td>
                        <div style="margin-bottom: 5px; font-size: 11px; color: #718096;">${typeLengths.type1.toFixed(3)}m</div>
                        <input type="number" id="count_${col.name}_type1" value="${existingData.count_type1 || 0}" 
                               step="1" min="0" placeholder="ê°œìˆ˜"
                               oninput="updateTypeTotals()"
                               style="width: 100%; padding: 8px; border: 1px solid #cbd5e0; border-radius: 4px; text-align: center;">
                    </td>
                    <td>
                        <div style="margin-bottom: 5px; font-size: 11px; color: #718096;">${typeLengths.type2.toFixed(3)}m</div>
                        <input type="number" id="count_${col.name}_type2" value="${existingData.count_type2 || 0}" 
                               step="1" min="0" placeholder="ê°œìˆ˜"
                               oninput="updateTypeTotals()"
                               style="width: 100%; padding: 8px; border: 1px solid #cbd5e0; border-radius: 4px; text-align: center;">
                    </td>
                    <td>
                        <div style="margin-bottom: 5px; font-size: 11px; color: #718096;">${typeLengths.type3.toFixed(3)}m</div>
                        <input type="number" id="count_${col.name}_type3" value="${existingData.count_type3 || 0}" 
                               step="1" min="0" placeholder="ê°œìˆ˜"
                               oninput="updateTypeTotals()"
                               style="width: 100%; padding: 8px; border: 1px solid #cbd5e0; border-radius: 4px; text-align: center;">
                    </td>
                    <td>
                        <div style="margin-bottom: 5px; font-size: 11px; color: #718096;">${typeLengths.type4.toFixed(3)}m</div>
                        <input type="number" id="count_${col.name}_type4" value="${existingData.count_type4 || 0}" 
                               step="1" min="0" placeholder="ê°œìˆ˜"
                               oninput="updateTypeTotals()"
                               style="width: 100%; padding: 8px; border: 1px solid #cbd5e0; border-radius: 4px; text-align: center;">
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // ì´ˆê¸° í•©ê³„ ê³„ì‚°
            updateTypeTotals();

            document.getElementById('boqLengthModal').style.display = 'flex';
        }

        // Typeë³„ í•©ì‚° ë° ì „ì²´ ê°œìˆ˜ ê³„ì‚° ë° í‘œì‹œ
        function updateTypeTotals() {
            const tbody = document.getElementById('boqLengthTableBody');
            if (!tbody) return;

            let totalType1 = 0;
            let totalType2 = 0;
            let totalType3 = 0;
            let totalType4 = 0;

            // ëª¨ë“  í–‰ì˜ ì…ë ¥ê°’ í•©ì‚°
            const rows = tbody.querySelectorAll('tr');
            rows.forEach(row => {
                const inputs = row.querySelectorAll('input[type="number"]');
                if (inputs.length >= 4) {
                    totalType1 += parseInt(inputs[0].value) || 0;
                    totalType2 += parseInt(inputs[1].value) || 0;
                    totalType3 += parseInt(inputs[2].value) || 0;
                    totalType4 += parseInt(inputs[3].value) || 0;
                }
            });

            // í•©ê³„ í‘œì‹œ
            const totalType1El = document.getElementById('totalType1');
            const totalType2El = document.getElementById('totalType2');
            const totalType3El = document.getElementById('totalType3');
            const totalType4El = document.getElementById('totalType4');
            const totalAllEl = document.getElementById('totalAll');

            if (totalType1El) totalType1El.textContent = totalType1;
            if (totalType2El) totalType2El.textContent = totalType2;
            if (totalType3El) totalType3El.textContent = totalType3;
            if (totalType4El) totalType4El.textContent = totalType4;

            // ì „ì²´ ê°œìˆ˜ ê³„ì‚°
            const totalAll = totalType1 + totalType2 + totalType3 + totalType4;
            if (totalAllEl) totalAllEl.textContent = totalAll;
        }

        // BOQ ê¸¸ì´ ì…ë ¥ ëª¨ë‹¬ ë‹«ê¸°
        function closeBOQLengthModal() {
            const modal = document.getElementById('boqLengthModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // ì†Œë¶€ì¬ ì¶”ê°€ í•­ëª© ë°ì´í„° ì €ì¥
        let subMaterialItems = [];

        // BOQ Type ê°œìˆ˜ ë°ì´í„°ë¥¼ ì—‘ì…€ë¡œ ë‹¤ìš´ë¡œë“œ
        function exportBOQTypeCountToExcel() {
            try {
                const tbody = document.getElementById('boqLengthTableBody');
                if (!tbody || tbody.children.length === 0) {
                    alert('ê¸°ë‘¥ë³„ Type ê°œìˆ˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                // ì›Œí¬ë¶ ë°ì´í„° ìƒì„±
                const wsData = [
                    ['No.', 'ê¸°ë‘¥ëª…', 'Type1 ê°œìˆ˜', 'Type2 ê°œìˆ˜', 'Type3 ê°œìˆ˜', 'Type4 ê°œìˆ˜']
                ];
                
                // Type ê¸¸ì´ ì •ë³´ë„ í¬í•¨
                wsData.push([
                    '', 
                    `(Type1: ${typeLengths.type1.toFixed(3)}m)`, 
                    `(Type2: ${typeLengths.type2.toFixed(3)}m)`, 
                    `(Type3: ${typeLengths.type3.toFixed(3)}m)`, 
                    `(Type4: ${typeLengths.type4.toFixed(3)}m)`
                ]);
                wsData.push([]); // ë¹ˆ í–‰
                
                const rows = tbody.querySelectorAll('tr');
                rows.forEach((row, index) => {
                    const noCell = row.querySelector('td:first-child');
                    const nameCell = row.querySelector('td:nth-child(2)');
                    const inputs = row.querySelectorAll('input[type="number"]');
                    
                    if (noCell && nameCell && inputs.length >= 4) {
                        const no = noCell.textContent.trim();
                        const name = nameCell.textContent.trim();
                        const type1Count = parseInt(inputs[0].value) || 0;
                        const type2Count = parseInt(inputs[1].value) || 0;
                        const type3Count = parseInt(inputs[2].value) || 0;
                        const type4Count = parseInt(inputs[3].value) || 0;
                        
                        wsData.push([
                            no,
                            name,
                            type1Count,
                            type2Count,
                            type3Count,
                            type4Count
                        ]);
                    }
                });
                
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                
                // ì»¬ëŸ¼ ë„ˆë¹„ ì„¤ì •
                ws['!cols'] = [
                    { wch: 5 },   // No.
                    { wch: 15 },  // ê¸°ë‘¥ëª…
                    { wch: 12 },  // Type1
                    { wch: 12 },  // Type2
                    { wch: 12 },  // Type3
                    { wch: 12 }   // Type4
                ];
                
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'BOQ Type ê°œìˆ˜');
                
                // íŒŒì¼ëª… ìƒì„±
                const now = new Date();
                const dateStr = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}`;
                const fileName = `BOQ_Typeê°œìˆ˜_${dateStr}.xlsx`;
                
                XLSX.writeFile(wb, fileName);
                alert(`BOQ Type ê°œìˆ˜ ë°ì´í„°ê°€ "${fileName}" íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`);
            } catch (error) {
                console.error('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ì—‘ì…€ íŒŒì¼ì—ì„œ BOQ Type ê°œìˆ˜ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        function importBOQTypeCountFromExcel(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // ì²« ë²ˆì§¸ ì‹œíŠ¸ ì‚¬ìš©
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // JSONìœ¼ë¡œ ë³€í™˜
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
                    
                    if (jsonData.length < 2) {
                        alert('ì—‘ì…€ íŒŒì¼ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }
                    
                    // í—¤ë” ì°¾ê¸° (ì²« ë²ˆì§¸ í–‰ ë˜ëŠ” ë°ì´í„° í–‰ ì¤‘ í•˜ë‚˜)
                    let headerRowIdx = 0;
                    let dataStartRowIdx = 1;
                    
                    // ì²« ë²ˆì§¸ í–‰ì´ í—¤ë”ì¸ì§€ í™•ì¸
                    const firstRow = jsonData[0] || [];
                    if (firstRow[0] && String(firstRow[0]).toLowerCase().includes('no')) {
                        headerRowIdx = 0;
                        dataStartRowIdx = 1;
                    }
                    
                    // í—¤ë” ì°¾ê¸°
                    const headers = jsonData[headerRowIdx].map(h => String(h).toLowerCase().trim());
                    const noIdx = headers.findIndex(h => h.includes('no') || h === 'no.');
                    const nameIdx = headers.findIndex(h => h.includes('ê¸°ë‘¥') || h.includes('name') || h.includes('ëª…'));
                    const type1Idx = headers.findIndex(h => h.includes('type1') || h.includes('type 1'));
                    const type2Idx = headers.findIndex(h => h.includes('type2') || h.includes('type 2'));
                    const type3Idx = headers.findIndex(h => h.includes('type3') || h.includes('type 3'));
                    const type4Idx = headers.findIndex(h => h.includes('type4') || h.includes('type 4'));
                    
                    if (type1Idx === -1 || type2Idx === -1 || type3Idx === -1 || type4Idx === -1) {
                        alert('ì—‘ì…€ íŒŒì¼ì— Type1~Type4 ì»¬ëŸ¼ì´ ì—†ìŠµë‹ˆë‹¤. ì»¬ëŸ¼ëª…ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                        return;
                    }
                    
                    // ë°ì´í„° íŒŒì‹± ë° ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸
                    let importedCount = 0;
                    for (let i = dataStartRowIdx; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (!row || row.length === 0) continue;
                        
                        // ë¹ˆ í–‰ ë˜ëŠ” í—¤ë” ì •ë³´ í–‰ ìŠ¤í‚µ
                        const firstCell = String(row[0] || '').trim().toLowerCase();
                        if (!firstCell || firstCell.includes('type') || firstCell === '') continue;
                        
                        const name = nameIdx !== -1 ? String(row[nameIdx] || '').trim() : '';
                        if (!name) continue; // ê¸°ë‘¥ëª…ì´ ì—†ìœ¼ë©´ ìŠ¤í‚µ
                        
                        const type1Count = type1Idx !== -1 ? parseInt(row[type1Idx]) || 0 : 0;
                        const type2Count = type2Idx !== -1 ? parseInt(row[type2Idx]) || 0 : 0;
                        const type3Count = type3Idx !== -1 ? parseInt(row[type3Idx]) || 0 : 0;
                        const type4Count = type4Idx !== -1 ? parseInt(row[type4Idx]) || 0 : 0;
                        
                        // í•´ë‹¹ ê¸°ë‘¥ì˜ ì…ë ¥ í•„ë“œ ì°¾ì•„ì„œ ì—…ë°ì´íŠ¸
                        const type1Input = document.getElementById(`count_${name}_type1`);
                        const type2Input = document.getElementById(`count_${name}_type2`);
                        const type3Input = document.getElementById(`count_${name}_type3`);
                        const type4Input = document.getElementById(`count_${name}_type4`);
                        
                        if (type1Input && type2Input && type3Input && type4Input) {
                            type1Input.value = type1Count;
                            type2Input.value = type2Count;
                            type3Input.value = type3Count;
                            type4Input.value = type4Count;
                            
                            // ì´ë²¤íŠ¸ ë°œìƒ (í•©ê³„ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´)
                            type1Input.dispatchEvent(new Event('input', { bubbles: true }));
                            
                            importedCount++;
                        }
                    }
                    
                    if (importedCount > 0) {
                        // í•©ê³„ ì—…ë°ì´íŠ¸
                        updateTypeTotals();
                        alert(`${importedCount}ê°œì˜ ê¸°ë‘¥ Type ê°œìˆ˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
                    } else {
                        alert('ì—‘ì…€ íŒŒì¼ì—ì„œ ìœ íš¨í•œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë‘¥ëª…ì´ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
                    }
                } catch (error) {
                    console.error('ì—‘ì…€ íŒŒì¼ ì½ê¸° ì˜¤ë¥˜:', error);
                    alert('ì—‘ì…€ íŒŒì¼ ì½ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            };
            
            reader.readAsArrayBuffer(file);
            
            // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
            event.target.value = '';
        }

        // BOQ ê¸¸ì´ ì…ë ¥ ì™„ë£Œ í›„ ì‹¤ì œ BOQ ìƒì„±
        function proceedWithBOQGeneration() {
            // ì…ë ¥ëœ ê¸°ë‘¥ë³„ Type ê°œìˆ˜ ë°ì´í„° ì €ì¥
            const uniqueColumns = {};
            currentResults.forEach(result => {
                if (!uniqueColumns[result.name]) {
                    uniqueColumns[result.name] = result.name;
                }
            });

            Object.keys(uniqueColumns).forEach(colName => {
                columnLengthData[colName] = {
                    count_type1: parseInt(document.getElementById(`count_${colName}_type1`).value) || 0,
                    count_type2: parseInt(document.getElementById(`count_${colName}_type2`).value) || 0,
                    count_type3: parseInt(document.getElementById(`count_${colName}_type3`).value) || 0,
                    count_type4: parseInt(document.getElementById(`count_${colName}_type4`).value) || 0
                };
            });

            closeBOQLengthModal();
            // ë‹¨ê°€ ì…ë ¥ ëª¨ë‹¬ í‘œì‹œ
            showUnitPriceModal();
        }

        // ë‹¨ê°€ ì…ë ¥ ëª¨ë‹¬ í‘œì‹œ
        function showUnitPriceModal() {
            const modal = document.getElementById('unitPriceModal');
            if (!modal) {
                addUnitPriceModal();
            }

            // ì €ì¥ëœ ë‹¨ê°€ ë¶ˆëŸ¬ì˜¤ê¸° (ì½¤ë§ˆ ì¶”ê°€)
            const savedPrices = JSON.parse(localStorage.getItem('boqUnitPrices')) || {};
            const priceSM420 = typeof savedPrices.mainMaterialSM420 === 'number' ? savedPrices.mainMaterialSM420 : (parseFloat(savedPrices.mainMaterialSM420) || 1900000);
            const priceSM355 = typeof savedPrices.mainMaterialSM355 === 'number' ? savedPrices.mainMaterialSM355 : (parseFloat(savedPrices.mainMaterialSM355) || 1830000);
            const priceSub = typeof savedPrices.subMaterial === 'number' ? savedPrices.subMaterial : (parseFloat(savedPrices.subMaterial) || 1900000);
            document.getElementById('mainMaterialUnitPriceSM420').value = priceSM420.toLocaleString('ko-KR');
            document.getElementById('mainMaterialUnitPriceSM355').value = priceSM355.toLocaleString('ko-KR');
            document.getElementById('subMaterialUnitPrice').value = priceSub.toLocaleString('ko-KR');

            document.getElementById('unitPriceModal').style.display = 'flex';
        }

        // ë‹¨ê°€ ì…ë ¥ ëª¨ë‹¬ ë‹«ê¸°
        function closeUnitPriceModal() {
            const modal = document.getElementById('unitPriceModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // ìˆ«ìì— ì½¤ë§ˆ ì¶”ê°€ í•¨ìˆ˜
        function formatNumberWithComma(input) {
            // ì½¤ë§ˆ ì œê±° í›„ ìˆ«ìë§Œ ì¶”ì¶œ
            let value = input.value.replace(/[^0-9]/g, '');
            // ì½¤ë§ˆ ì¶”ê°€
            if (value) {
                value = parseInt(value).toLocaleString('ko-KR');
            }
            input.value = value;
        }

        // ì½¤ë§ˆ ì œê±° í›„ ìˆ«ì ë°˜í™˜ í•¨ìˆ˜
        function removeCommaAndParse(value) {
            return parseFloat(value.replace(/[^0-9]/g, '')) || 0;
        }

        // ë‹¨ê°€ ì €ì¥ í›„ BOQ ìƒì„±
        function proceedWithUnitPrice() {
            const mainMaterialPriceSM420 = removeCommaAndParse(document.getElementById('mainMaterialUnitPriceSM420').value) || 1900000;
            const mainMaterialPriceSM355 = removeCommaAndParse(document.getElementById('mainMaterialUnitPriceSM355').value) || 1830000;
            const subMaterialPrice = removeCommaAndParse(document.getElementById('subMaterialUnitPrice').value) || 1900000;

            // ë‹¨ê°€ ì €ì¥
            const unitPrices = {
                mainMaterialSM420: mainMaterialPriceSM420,
                mainMaterialSM355: mainMaterialPriceSM355,
                subMaterial: subMaterialPrice
            };
            localStorage.setItem('boqUnitPrices', JSON.stringify(unitPrices));

            closeUnitPriceModal();
            // BOQ ìƒì„±
            generateBOQWithLengths();
        }

        // ë‹¨ê°€ ì…ë ¥ ëª¨ë‹¬ HTML ì¶”ê°€
        function addUnitPriceModal() {
            const modalHTML = `
                <div id="unitPriceModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center; overflow-y: auto; padding: 20px;">
                    <div style="background: white; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                        <h2 style="margin-bottom: 20px; color: #1e3a5f; font-size: 24px; text-align: center;">ë‹¨ê°€ ì…ë ¥</h2>
                        <p style="margin-bottom: 20px; color: #718096; font-size: 14px; text-align: center;">BOQ ìƒì„±ì„ ìœ„í•´ ì£¼ë¶€ì¬ ë° ì†Œë¶€ì¬ ë‹¨ê°€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: #4a5568; font-weight: 600;">ì£¼ë¶€ì¬ ë‹¨ê°€ - SM420 (í†¤ë‹¹ ì›)</label>
                            <input type="text" id="mainMaterialUnitPriceSM420" 
                                   value="1,900,000"
                                   placeholder="SM420 ì£¼ë¶€ì¬ ë‹¨ê°€"
                                   oninput="formatNumberWithComma(this)"
                                   style="width: 100%; padding: 12px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 16px; text-align: right;">
                            <p style="margin-top: 5px; color: #718096; font-size: 12px;">ê¸°ë³¸ê°’: 1,900,000ì›/í†¤</p>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: #4a5568; font-weight: 600;">ì£¼ë¶€ì¬ ë‹¨ê°€ - SM355 (í†¤ë‹¹ ì›)</label>
                            <input type="text" id="mainMaterialUnitPriceSM355" 
                                   value="1,830,000"
                                   placeholder="SM355 ì£¼ë¶€ì¬ ë‹¨ê°€"
                                   oninput="formatNumberWithComma(this)"
                                   style="width: 100%; padding: 12px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 16px; text-align: right;">
                            <p style="margin-top: 5px; color: #718096; font-size: 12px;">ê¸°ë³¸ê°’: 1,830,000ì›/í†¤</p>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: #4a5568; font-weight: 600;">ì†Œë¶€ì¬ ë‹¨ê°€ (í†¤ë‹¹ ì›)</label>
                            <input type="text" id="subMaterialUnitPrice" 
                                   value="1,900,000"
                                   placeholder="ì†Œë¶€ì¬ ë‹¨ê°€"
                                   oninput="formatNumberWithComma(this)"
                                   style="width: 100%; padding: 12px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 16px; text-align: right;">
                            <p style="margin-top: 5px; color: #718096; font-size: 12px;">ê¸°ë³¸ê°’: 1,900,000ì›/í†¤ (SM420 ê¸°ì¤€)</p>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button onclick="proceedWithUnitPrice()" 
                                    style="padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer;">
                                BOQ ìƒì„±
                            </button>
                            <button onclick="closeUnitPriceModal()" 
                                    style="padding: 12px 24px; background: #cbd5e0; color: #4a5568; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer;">
                                ì·¨ì†Œ
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // ì†Œë¶€ì¬ ì¶”ê°€ í•­ëª© ì…ë ¥ ëª¨ë‹¬ í‘œì‹œ
        function showSubMaterialModal() {
            const modal = document.getElementById('subMaterialModal');
            if (!modal) {
                addSubMaterialModal();
            }

            // ê¸°ì¡´ ì†Œë¶€ì¬ í•­ëª© ë¡œë“œ
            const tbody = document.getElementById('subMaterialTableBody');
            tbody.innerHTML = '';

            // ê¸°ë³¸ í•­ëª© (ìš©ì ‘ì¬, í˜„ì¥ ë³¼íŠ¸ì´ìŒ)ì€ ìë™ ê³„ì‚°ë˜ë¯€ë¡œ ì œì™¸
            // ì‚¬ìš©ìê°€ ì¶”ê°€í•œ í•­ëª©ë§Œ í‘œì‹œ
            subMaterialItems.forEach((item, index) => {
                const row = createSubMaterialRow(item, index);
                tbody.appendChild(row);
            });

            // ë¹ˆ í–‰ í•˜ë‚˜ ì¶”ê°€ (ìƒˆ í•­ëª© ì…ë ¥ìš©)
            const emptyRow = createSubMaterialRow(null, subMaterialItems.length);
            tbody.appendChild(emptyRow);

            document.getElementById('subMaterialModal').style.display = 'flex';
        }

        // ì†Œë¶€ì¬ í–‰ ìƒì„±
        function createSubMaterialRow(item, index) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td style="text-align: center; font-weight: 600;">${index + 1}</td>
                <td>
                    <input type="text" id="subType_${index}" value="${item?.type || ''}" 
                           placeholder="ì†Œë¶€ì¬ ì¢…ë¥˜" 
                           style="width: 100%; padding: 8px; border: 1px solid #cbd5e0; border-radius: 4px;">
                </td>
                <td>
                    <input type="text" id="subSpec_${index}" value="${item?.spec || ''}" 
                           placeholder="ê·œê²©/ì‚¬ì–‘" 
                           style="width: 100%; padding: 8px; border: 1px solid #cbd5e0; border-radius: 4px;">
                </td>
                <td>
                    <input type="text" id="subUnit_${index}" value="${item?.unit || ''}" 
                           placeholder="ë‹¨ìœ„" 
                           style="width: 100%; padding: 8px; border: 1px solid #cbd5e0; border-radius: 4px;">
                </td>
                <td>
                    <input type="number" id="subQty_${index}" value="${item?.quantity || ''}" 
                           step="0.01" min="0" placeholder="ìˆ˜ëŸ‰" 
                           style="width: 100%; padding: 8px; border: 1px solid #cbd5e0; border-radius: 4px;">
                </td>
                <td>
                    <input type="text" id="subGrade_${index}" value="${item?.steelGrade || 'SM420'}" 
                           placeholder="ê°•ì¢…" 
                           style="width: 100%; padding: 8px; border: 1px solid #cbd5e0; border-radius: 4px;">
                </td>
                <td>
                    <input type="number" id="subWeight_${index}" value="${item?.totalSteelWeight || ''}" 
                           step="0.01" min="0" placeholder="ì² ê³¨ë¬¼ëŸ‰(kg)" 
                           style="width: 100%; padding: 8px; border: 1px solid #cbd5e0; border-radius: 4px;">
                </td>
                <td>
                    <input type="number" id="subSurcharge_${index}" value="${item?.surcharge || ''}" 
                           step="0.01" min="0" placeholder="í• ì¦(kg)" 
                           style="width: 100%; padding: 8px; border: 1px solid #cbd5e0; border-radius: 4px;">
                </td>
                <td>
                    <input type="number" id="subAmount_${index}" value="${item?.amount || ''}" 
                           step="1" min="0" placeholder="ê¸ˆì•¡(ì›)" 
                           style="width: 100%; padding: 8px; border: 1px solid #cbd5e0; border-radius: 4px;">
                </td>
                <td>
                    <input type="text" id="subRemark_${index}" value="${item?.remark || ''}" 
                           placeholder="ë¹„ê³ " 
                           style="width: 100%; padding: 8px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 11px;">
                </td>
                <td style="text-align: center;">
                    <button onclick="removeSubMaterialRow(${index})" 
                            style="padding: 4px 8px; background: #e53e3e; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                        ì‚­ì œ
                    </button>
                </td>
            `;
            return row;
        }

        // ì†Œë¶€ì¬ í–‰ ì‚­ì œ
        function removeSubMaterialRow(index) {
            subMaterialItems.splice(index, 1);
            showSubMaterialModal(); // ëª¨ë‹¬ ìƒˆë¡œê³ ì¹¨
        }

        // ì†Œë¶€ì¬ ì¶”ê°€ í•­ëª© ì…ë ¥ ëª¨ë‹¬ ë‹«ê¸°
        function closeSubMaterialModal() {
            const modal = document.getElementById('subMaterialModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // ì†Œë¶€ì¬ ì¶”ê°€ í•­ëª© ì €ì¥ í›„ BOQ ìƒì„±
        function proceedWithSubMaterialBOQ() {
            // ì…ë ¥ëœ ì†Œë¶€ì¬ í•­ëª© ì €ì¥
            subMaterialItems = [];
            const tbody = document.getElementById('subMaterialTableBody');
            const rows = tbody.querySelectorAll('tr');

            rows.forEach((row, index) => {
                const type = document.getElementById(`subType_${index}`)?.value.trim();
                const spec = document.getElementById(`subSpec_${index}`)?.value.trim();
                const unit = document.getElementById(`subUnit_${index}`)?.value.trim();
                const quantity = parseFloat(document.getElementById(`subQty_${index}`)?.value) || 0;
                const steelGrade = document.getElementById(`subGrade_${index}`)?.value.trim() || 'SM420';
                const totalSteelWeight = parseFloat(document.getElementById(`subWeight_${index}`)?.value) || 0;
                const surcharge = parseFloat(document.getElementById(`subSurcharge_${index}`)?.value) || 0;
                const amount = parseFloat(document.getElementById(`subAmount_${index}`)?.value) || 0;
                const remark = document.getElementById(`subRemark_${index}`)?.value.trim() || '';

                // ìµœì†Œí•œ ì¢…ë¥˜ë‚˜ ê·œê²©ì´ ì…ë ¥ëœ ê²½ìš°ë§Œ ì €ì¥
                if (type || spec) {
                    subMaterialItems.push({
                        type: type || 'ê¸°íƒ€',
                        spec: spec || '',
                        unit: unit || 'ê°œ',
                        quantity: quantity,
                        steelGrade: steelGrade,
                        totalSteelWeight: totalSteelWeight,
                        surcharge: surcharge,
                        amount: amount,
                        remark: remark
                    });
                }
            });

            closeSubMaterialModal();
            generateBOQWithLengths();
        }

        // ì‹¤ì œ BOQ ìƒì„± í•¨ìˆ˜ (ê¸¸ì´ ë°ì´í„° ì‚¬ìš©)
        function generateBOQWithLengths() {

            let totalWeight = 0;
            let totalArea = 0;
            let totalCount = 0;

            // ê¸°ë‘¥ë³„ë¡œ ê·¸ë£¹í™”í•˜ì—¬ ë™ì¼ ê·œê²© í•©ì‚° (Typeë³„ ê°œìˆ˜ ì‚¬ìš©)
            const groupedResults = {};
            currentResults.forEach(result => {
                if (!result.tw || !result.tf) return; // ìœ íš¨í•˜ì§€ ì•Šì€ ê²°ê³¼ ì œì™¸
                
                // ê¸°ë‘¥ëª…ì— ë”°ë¼ Typeë³„ ê°œìˆ˜ ê°€ì ¸ì˜¤ê¸°
                const colCounts = columnLengthData[result.name] || {};
                
                // ê° Typeë³„ë¡œ ê°œìˆ˜ë§Œí¼ BOQ ì•„ì´í…œ ìƒì„±
                for (let type = 1; type <= 4; type++) {
                    const count = colCounts[`count_type${type}`] || 0;
                    if (count <= 0) continue; // ê°œìˆ˜ê°€ 0ì´ë©´ ê±´ë„ˆë›°ê¸°
                    
                    const length = typeLengths[`type${type}`] || 4.5;
                    const key = `${result.h}-${result.b}-${result.tw}-${result.tf}-${result.steelGrade}-Type${type}-${length}`;
                    
                    if (!groupedResults[key]) {
                        groupedResults[key] = {
                            combination: result.combination,
                            h: result.h,
                            b: result.b,
                            tw: result.tw,
                            tf: result.tf,
                            area: result.area,
                            unitWeight: result.unitWeight,
                            length: length,
                            lengthType: type,
                            steelGrade: result.steelGrade,
                            count: 0,
                            names: []
                        };
                    }
                    groupedResults[key].count += count;
                    // ê¸°ë‘¥ëª…ì— ê°œìˆ˜ í‘œì‹œ
                    for (let i = 0; i < count; i++) {
                        groupedResults[key].names.push(count > 1 ? `${result.name}-Type${type}-${i + 1}` : `${result.name}-Type${type}`);
                    }
                }
            });

            // BOQ ì•„ì´í…œ ë°°ì—´ ìƒì„±
            const boqItems = [];
            Object.keys(groupedResults).forEach(key => {
                const item = groupedResults[key];
                const totalWeightItem = item.unitWeight * item.length * item.count;
                totalWeight += totalWeightItem;
                totalArea += item.area * item.count;
                totalCount += item.count;

                boqItems.push({
                    combination: item.combination,
                    h: item.h,
                    b: item.b,
                    tw: item.tw,
                    tf: item.tf,
                    area: item.area,
                    unitWeight: item.unitWeight,
                    length: item.length,
                    lengthType: item.lengthType,
                    steelGrade: item.steelGrade,
                    count: item.count,
                    names: item.names,
                    H1: item.H1,
                    H2: item.H2,
                    B1: item.B1,
                    B2: item.B2
                });
            });

            // localStorageì— BOQ ë°ì´í„° ì €ì¥
            const boqData = {
                items: boqItems,
                summary: {
                    totalCount: totalCount,
                    totalArea: totalArea,
                    totalWeight: totalWeight
                },
                subMaterials: subMaterialItems, // ì†Œë¶€ì¬ ì¶”ê°€ í•­ëª© í¬í•¨
                autoFindResults: currentResults, // Auto Find Section ê²°ê³¼ í¬í•¨
                typeLengths: typeLengths, // Typeë³„ ê¸¸ì´ ì •ë³´
                columnLengthData: columnLengthData // ê¸°ë‘¥ë³„ Type ê°œìˆ˜ ì •ë³´
            };
            localStorage.setItem('boqData', JSON.stringify(boqData));

            // ìƒˆ ì°½ì—ì„œ BOQ ë¦¬í¬íŠ¸ ì—´ê¸°
            const boqWindow = window.open('boq-report.html', '_blank', 'width=1400,height=900');
            
            if (!boqWindow) {
                alert('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. íŒì—… ì°¨ë‹¨ì„ í•´ì œí•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }

            console.log(`BOQ ìƒì„± ì™„ë£Œ: ${totalCount}ê°œ ê¸°ë‘¥, ì´ ì¤‘ëŸ‰: ${totalWeight.toFixed(2)} kg`);
        }

        // BOQ ì¸ì‡„ í•¨ìˆ˜
        function printBOQ() {
            const boqSection = document.getElementById('boqSection');
            if (!boqSection.classList.contains('show')) {
                alert('ë¨¼ì € BOQë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ì¸ì‡„ìš© ìŠ¤íƒ€ì¼ ì¶”ê°€
            const printStyle = `
                <style>
                    @media print {
                        body * {
                            visibility: hidden;
                        }
                        .boq-section, .boq-section * {
                            visibility: visible;
                        }
                        .boq-section {
                            position: absolute;
                            left: 0;
                            top: 0;
                            width: 100%;
                        }
                        .section-title {
                            font-size: 20px;
                            margin-bottom: 20px;
                        }
                        .boq-table {
                            font-size: 10px;
                        }
                        .boq-table th,
                        .boq-table td {
                            padding: 6px;
                        }
                        button {
                            display: none;
                        }
                    }
                </style>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>BOQ - ê³µì‚¬ ìˆ˜ëŸ‰ ì‚°ì¶œì„œ</title>
                        ${printStyle}
                        <style>
                            body {
                                font-family: 'Segoe UI', Arial, sans-serif;
                                padding: 20px;
                            }
                            .boq-table {
                                width: 100%;
                                border-collapse: collapse;
                                font-size: 11px;
                            }
                            .boq-table th,
                            .boq-table td {
                                padding: 8px;
                                text-align: center;
                                border: 1px solid #333;
                            }
                            .boq-table th {
                                background: #2d5a87;
                                color: white;
                                font-weight: 600;
                            }
                            .boq-table .total-row {
                                background: #e8f4f8;
                                font-weight: 600;
                            }
                            h1 {
                                text-align: center;
                                margin-bottom: 20px;
                            }
                        </style>
                    </head>
                    <body>
                        <h1>BOQ (Bill of Quantities) - ê³µì‚¬ ìˆ˜ëŸ‰ ì‚°ì¶œì„œ</h1>
                        ${boqSection.innerHTML}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // BOQ CSV ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
        function exportBOQToCSV() {
            if (currentResults.length === 0) {
                alert('ë¨¼ì € ê³„ì‚°ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ê¸°ë‘¥ë³„ë¡œ ê·¸ë£¹í™” (ê¸¸ì´ íƒ€ì…ë³„ë¡œë„ êµ¬ë¶„)
            const groupedResults = {};
            currentResults.forEach(result => {
                if (!result.tw || !result.tf) return;
                
                const key = `${result.h}-${result.b}-${result.tw}-${result.tf}-${result.steelGrade}-${result.lengthType || 1}`;
                if (!groupedResults[key]) {
                    groupedResults[key] = {
                        combination: result.combination,
                        h: result.h,
                        b: result.b,
                        tw: result.tw,
                        tf: result.tf,
                        area: result.area,
                        unitWeight: result.unitWeight,
                        length: result.lx,
                        lengthType: result.lengthType || 1,
                        steelGrade: result.steelGrade,
                        count: 0,
                        names: []
                    };
                }
                groupedResults[key].count++;
                groupedResults[key].names.push(result.name);
            });

            // CSV í—¤ë”
            let csv = 'No.,ê¸°ë‘¥ëª…,ì¡°í•©,ê·œê²©,H(mm),B(mm),tw(mm),tf(mm),ë‹¨ë©´ì (mmÂ²),ë‹¨ì¤‘(kg/m),ê¸¸ì´(m),ê¸¸ì´íƒ€ì…,ê°œìˆ˜,ì´ì¤‘ëŸ‰(kg),ê°•ì¢…\n';

            // CSV ë°ì´í„°
            let rowNo = 1;
            let totalWeight = 0;
            let totalCount = 0;

            Object.keys(groupedResults).forEach(key => {
                const item = groupedResults[key];
                const totalWeightItem = item.unitWeight * item.length * item.count;
                totalWeight += totalWeightItem;
                totalCount += item.count;

                csv += `${rowNo++},${item.names.join(';')},${item.combination},H${item.h}Ã—B${item.b},${item.h},${item.b},${item.tw},${item.tf},${item.area.toFixed(2)},${item.unitWeight.toFixed(4)},${item.length.toFixed(2)},íƒ€ì…${item.lengthType},${item.count},${totalWeightItem.toFixed(2)},${item.steelGrade}\n`;
            });

            // í•©ê³„ í–‰
            csv += `í•©ê³„,,,,,,,,,,${totalCount},${totalWeight.toFixed(2)},\n`;

            // BOM ì¶”ê°€ (í•œê¸€ ê¹¨ì§ ë°©ì§€)
            const bom = '\uFEFF';
            const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `BOQ_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ê³„ì‚°ì„œ ì¶œë ¥ í•¨ìˆ˜ (ë¡œê·¸ì¸ ì²´í¬ í¬í•¨)
        function printCalculationSheet() {
            // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
            if (!checkLoginStatus()) {
                showLoginModal();
                return;
            }

            // ë¡œê·¸ì¸ëœ ê²½ìš° ê³„ì‚°ì„œ ì¶œë ¥ ì§„í–‰
            proceedWithPrintCalculationSheet();
        }

        // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
        function checkLoginStatus() {
            const loginData = JSON.parse(localStorage.getItem('kcolLoginData')) || null;
            if (loginData && loginData.isLoggedIn) {
                // ë¡œê·¸ì¸ ë§Œë£Œ ì‹œê°„ í™•ì¸ (24ì‹œê°„)
                const now = new Date().getTime();
                if (now - loginData.loginTime < 24 * 60 * 60 * 1000) {
                    return true;
                } else {
                    // ë§Œë£Œëœ ê²½ìš° ë¡œê·¸ì¸ ì •ë³´ ì œê±°
                    localStorage.removeItem('kcolLoginData');
                }
            }
            return false;
        }

        // ë¡œê·¸ì¸ ëª¨ë‹¬ í‘œì‹œ
        function showLoginModal() {
            const modal = document.getElementById('loginModal');
            if (modal) {
                modal.style.display = 'flex';
                document.getElementById('loginUserId').focus();
            }
        }

        // ë¡œê·¸ì¸ ëª¨ë‹¬ ë‹«ê¸°
        function closeLoginModal() {
            const modal = document.getElementById('loginModal');
            if (modal) {
                modal.style.display = 'none';
                document.getElementById('loginUserId').value = '';
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginError').textContent = '';
            }
        }

        // ë¡œê·¸ì¸ ì²˜ë¦¬
        function handleLogin() {
            const userId = document.getElementById('loginUserId').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!userId || !password) {
                document.getElementById('loginError').textContent = 'IDì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                return;
            }

            // ê°„ë‹¨í•œ ì¸ì¦ (ì‹¤ì œë¡œëŠ” ì„œë²„ API í˜¸ì¶œ í•„ìš”)
            // í…ŒìŠ¤íŠ¸ìš©: userIdì™€ passwordê°€ ëª¨ë‘ ì…ë ¥ë˜ë©´ ë¡œê·¸ì¸ ì„±ê³µ
            const loginData = {
                isLoggedIn: true,
                userId: userId,
                loginTime: new Date().getTime()
            };
            localStorage.setItem('kcolLoginData', JSON.stringify(loginData));

            closeLoginModal();
            // ë¡œê·¸ì¸ í›„ ê³„ì‚°ì„œ ì¶œë ¥ ê³„ì† ì§„í–‰
            proceedWithPrintCalculationSheet();
        }

        // ê³„ì‚°ì„œ ì¶œë ¥ ì§„í–‰ (ë¡œê·¸ì¸ í›„)
        function proceedWithPrintCalculationSheet() {
            if (currentResults.length === 0) {
                alert('ë¨¼ì € ê³„ì‚°ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ì²« ë²ˆì§¸ ê¸°ë‘¥ì˜ ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ì—¬ ê³„ì‚°ì„œ ìƒì„±
            const firstResult = currentResults[0];
            const col = columnData.find(c => c.no === firstResult.no);
            
            if (!col) {
                alert('ê¸°ë‘¥ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // ì¼ë°˜ H-beamì˜ ê²½ìš° ê³„ì‚°ì„œ ì¶œë ¥ ë¶ˆê°€ (Cross H Columnë§Œ ì§€ì›)
            if (firstResult.sectionType === 'H-beam') {
                alert('ì¼ë°˜ H-beamì˜ ê³„ì‚°ì„œ ì¶œë ¥ì€ í˜„ì¬ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Cross H Columnë§Œ ê³„ì‚°ì„œë¥¼ ì¶œë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }

            // ì…ë ¥ ë°ì´í„° ì €ì¥ (Main Calculator í˜•ì‹ê³¼ í˜¸í™˜)
            const inputData = {
                // Section Dimensions
                H1: firstResult.H1,
                B1: firstResult.B1,
                tw1: firstResult.tw,
                tf1: firstResult.tf,
                r1: 0, // Built-up ë¶€ì¬
                H2: firstResult.H2,
                B2: firstResult.B2,
                tw2: firstResult.tw,
                tf2: firstResult.tf,
                r2: 0, // Built-up ë¶€ì¬
                // Material
                steelGrade: firstResult.steelGrade || 'SM420',
                Fy: firstResult.Fy || 420,
                E: 210000,
                nu: 0.3,
                // Length & Buckling
                Lx: firstResult.lx || 4.5,
                Ly: firstResult.ly || 4.5,
                Lb: firstResult.lx || 4.5,
                Kx: parseFloat(document.getElementById('Kx').value) || 0.8,
                Ky: parseFloat(document.getElementById('Ky').value) || 0.8,
                Kz: parseFloat(document.getElementById('Kz').value) || 0.8,
                Cb: 1.0,
                // Design Load
                Pu: col.pu,
                Mux: col.mux,
                Muy: col.muy,
                Vux: 0,
                Vuy: 0,
                // Name
                name: col.name || 'Auto Find Section'
            };

            // localStorageì— ì €ì¥
            localStorage.setItem('kcolInputData', JSON.stringify(inputData));

            // ê³„ì‚°ì„œ í˜ì´ì§€ë¥¼ ìƒˆ ì°½ì—ì„œ ì—´ê¸°
            const calcWindow = window.open('Cross-H-Column-Calculation-Data1.html', '_blank');
            
            if (calcWindow) {
                console.log('ê³„ì‚°ì„œ ì¶œë ¥: ì²« ë²ˆì§¸ ê¸°ë‘¥ ë°ì´í„° ì‚¬ìš©');
                console.log('ê¸°ë‘¥ëª…:', col.name);
                console.log('Pu:', col.pu, 'Mux:', col.mux, 'Muy:', col.muy);
                console.log('tw:', firstResult.tw, 'tf:', firstResult.tf);
            }
        }

        // ì†Œë¶€ì¬ ì¶”ê°€ í•­ëª© ì…ë ¥ ëª¨ë‹¬ HTML ì¶”ê°€
        function addSubMaterialModal() {
            const modalHTML = `
                <div id="subMaterialModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001; align-items: center; justify-content: center; overflow-y: auto; padding: 20px;">
                    <div style="background: white; border-radius: 12px; padding: 30px; max-width: 1200px; width: 95%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                        <h2 style="margin-bottom: 20px; color: #1e3a5f; font-size: 24px; text-align: center;">ì†Œë¶€ì¬ ì¶”ê°€ í•­ëª© ì…ë ¥</h2>
                        <p style="margin-bottom: 20px; color: #718096; font-size: 14px; text-align: center;">ì¶”ê°€ ì†Œë¶€ì¬ í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”. (ìš©ì ‘ì¬, í˜„ì¥ ë³¼íŠ¸ì´ìŒì€ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤)</p>
                        <div style="overflow-x: auto; margin-bottom: 20px;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                                <thead>
                                    <tr style="background: #1e3a5f; color: white;">
                                        <th style="padding: 10px; text-align: center; border: 1px solid #e2e8f0;">No.</th>
                                        <th style="padding: 10px; text-align: center; border: 1px solid #e2e8f0;">ì†Œë¶€ì¬ ì¢…ë¥˜</th>
                                        <th style="padding: 10px; text-align: center; border: 1px solid #e2e8f0;">ê·œê²©/ì‚¬ì–‘</th>
                                        <th style="padding: 10px; text-align: center; border: 1px solid #e2e8f0;">ë‹¨ìœ„</th>
                                        <th style="padding: 10px; text-align: center; border: 1px solid #e2e8f0;">ìˆ˜ëŸ‰</th>
                                        <th style="padding: 10px; text-align: center; border: 1px solid #e2e8f0;">ê°•ì¢…</th>
                                        <th style="padding: 10px; text-align: center; border: 1px solid #e2e8f0;">ì² ê³¨ë¬¼ëŸ‰(kg)</th>
                                        <th style="padding: 10px; text-align: center; border: 1px solid #e2e8f0;">í• ì¦(kg)</th>
                                        <th style="padding: 10px; text-align: center; border: 1px solid #e2e8f0;">ê¸ˆì•¡(ì›)</th>
                                        <th style="padding: 10px; text-align: center; border: 1px solid #e2e8f0;">ë¹„ê³ </th>
                                        <th style="padding: 10px; text-align: center; border: 1px solid #e2e8f0;">ì‚­ì œ</th>
                                    </tr>
                                </thead>
                                <tbody id="subMaterialTableBody">
                                    <!-- ì†Œë¶€ì¬ í•­ëª©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                                </tbody>
                            </table>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button onclick="proceedWithSubMaterialBOQ()" 
                                    style="padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer;">
                                BOQ ìƒì„±
                            </button>
                            <button onclick="closeSubMaterialModal()" 
                                    style="padding: 12px 24px; background: #cbd5e0; color: #4a5568; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer;">
                                ì·¨ì†Œ
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // BOQ ê¸¸ì´ ì…ë ¥ ëª¨ë‹¬ HTML ì¶”ê°€
        function addBOQLengthModal() {
            const modalHTML = `
                <div id="boqLengthModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center; overflow-y: auto; padding: 20px;">
                    <div style="background: white; border-radius: 12px; padding: 30px; max-width: 900px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="margin: 0; color: #1e3a5f; font-size: 24px;">ê¸°ë‘¥ë³„ Type ê°œìˆ˜ ì…ë ¥</h2>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="exportBOQTypeCountToExcel()" style="padding: 6px 12px; background: #38a169; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                                    ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                                </button>
                                <label for="boqTypeCountExcelInput" style="padding: 6px 12px; background: #667eea; color: white; border-radius: 4px; cursor: pointer; font-size: 13px; display: inline-block; margin: 0;">
                                    ğŸ“¤ ì—‘ì…€ ì—…ë¡œë“œ
                                </label>
                                <input type="file" id="boqTypeCountExcelInput" accept=".xlsx,.xls" style="display: none;" onchange="importBOQTypeCountFromExcel(event)">
                            </div>
                        </div>
                        <p style="margin-bottom: 20px; color: #718096; font-size: 14px; text-align: center;">BOQ ìƒì„±ì„ ìœ„í•´ ê° ê¸°ë‘¥ë³„ Type1~Type4 ê°œìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
                        <div style="overflow-x: auto; margin-bottom: 20px;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #1e3a5f; color: white;">
                                        <th style="padding: 12px; text-align: center; border: 1px solid #e2e8f0;">No.</th>
                                        <th style="padding: 12px; text-align: center; border: 1px solid #e2e8f0;">ê¸°ë‘¥ëª…</th>
                                        <th style="padding: 12px; text-align: center; border: 1px solid #e2e8f0;">Type1 ê°œìˆ˜</th>
                                        <th style="padding: 12px; text-align: center; border: 1px solid #e2e8f0;">Type2 ê°œìˆ˜</th>
                                        <th style="padding: 12px; text-align: center; border: 1px solid #e2e8f0;">Type3 ê°œìˆ˜</th>
                                        <th style="padding: 12px; text-align: center; border: 1px solid #e2e8f0;">Type4 ê°œìˆ˜</th>
                                    </tr>
                                </thead>
                                <tbody id="boqLengthTableBody">
                                    <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
                                </tbody>
                                <tfoot id="boqLengthTableFooter" style="background: #f7fafc; font-weight: 600;">
                                    <tr>
                                        <td colspan="2" style="padding: 12px; text-align: center; border: 1px solid #e2e8f0; color: #1e3a5f;">í•©ê³„</td>
                                        <td id="totalType1" style="padding: 12px; text-align: center; border: 1px solid #e2e8f0; color: #667eea;">0</td>
                                        <td id="totalType2" style="padding: 12px; text-align: center; border: 1px solid #e2e8f0; color: #667eea;">0</td>
                                        <td id="totalType3" style="padding: 12px; text-align: center; border: 1px solid #e2e8f0; color: #667eea;">0</td>
                                        <td id="totalType4" style="padding: 12px; text-align: center; border: 1px solid #e2e8f0; color: #667eea;">0</td>
                                    </tr>
                                    <tr style="background: #e6fffa; border-top: 2px solid #38a169;">
                                        <td colspan="2" style="padding: 12px; text-align: center; border: 1px solid #e2e8f0; color: #1e3a5f; font-size: 14px;">ì „ì²´ ê°œìˆ˜</td>
                                        <td colspan="4" id="totalAll" style="padding: 12px; text-align: center; border: 1px solid #e2e8f0; color: #38a169; font-size: 16px;">0</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button onclick="proceedWithBOQGeneration()" 
                                    style="padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer;">
                                BOQ ìƒì„±
                            </button>
                            <button onclick="closeBOQLengthModal()" 
                                    style="padding: 12px 24px; background: #cbd5e0; color: #4a5568; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer;">
                                ì·¨ì†Œ
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // ë¡œê·¸ì¸ ëª¨ë‹¬ HTML ì¶”ê°€
        function addLoginModal() {
            // ì´ë¯¸ ëª¨ë‹¬ì´ ìˆìœ¼ë©´ ì¶”ê°€í•˜ì§€ ì•ŠìŒ
            if (document.getElementById('loginModal')) {
                return;
            }

            const modalHTML = `
                <div id="loginModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 12px; padding: 30px; max-width: 400px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                        <h2 style="margin-bottom: 20px; color: #1e3a5f; font-size: 24px; text-align: center;">ë¡œê·¸ì¸</h2>
                        <p style="margin-bottom: 20px; color: #718096; font-size: 14px; text-align: center;">ê³„ì‚°ì„œ ì¶œë ¥ì„ ìœ„í•´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: #4a5568; font-weight: 600; font-size: 14px;">ID (ì‚¬ì—…ìë²ˆí˜¸)</label>
                            <input type="text" id="loginUserId" placeholder="ì‚¬ì—…ìë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" 
                                   style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 14px;"
                                   onkeypress="if(event.key==='Enter') handleLogin()">
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; color: #4a5568; font-weight: 600; font-size: 14px;">ë¹„ë°€ë²ˆí˜¸</label>
                            <input type="password" id="loginPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" 
                                   style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 14px;"
                                   onkeypress="if(event.key==='Enter') handleLogin()">
                        </div>
                        <div id="loginError" style="color: #e53e3e; font-size: 13px; margin-bottom: 15px; min-height: 20px; text-align: center;"></div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="handleLogin()" 
                                    style="flex: 1; padding: 12px; background: #667eea; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer;">
                                ë¡œê·¸ì¸
                            </button>
                            <button onclick="closeLoginModal()" 
                                    style="flex: 1; padding: 12px; background: #cbd5e0; color: #4a5568; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer;">
                                ì·¨ì†Œ
                            </button>
                        </div>
                        <div style="margin-top: 15px; text-align: center; font-size: 12px; color: #718096;">
                            <a href="#" style="color: #667eea; text-decoration: none;">íšŒì›ê°€ì…</a> | 
                            <a href="#" style="color: #667eea; text-decoration: none;">ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</a>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
    </script>
</body>
</html>