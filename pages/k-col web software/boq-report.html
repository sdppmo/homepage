<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOQ ì‚°ì¶œì„œ - K-COL</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            padding: 20px;
            color: #1a202c;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }

        .header h1 {
            color: #1e3a5f;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header .subtitle {
            color: #718096;
            font-size: 14px;
        }

        .info-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 8px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-size: 12px;
            color: #718096;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .info-value {
            font-size: 16px;
            color: #1a202c;
            font-weight: 600;
        }

        .boq-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
            font-size: 13px;
        }

        .boq-table thead {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .boq-table th {
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            border: 1px solid #e2e8f0;
        }

        .boq-table td {
            padding: 10px 8px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        .boq-table tbody tr:nth-child(even) {
            background: #f7fafc;
        }

        .boq-table tbody tr:hover {
            background: #edf2f7;
        }

        .text-left {
            text-align: left;
        }

        .text-right {
            text-align: right;
        }

        .total-row {
            background: #e6fffa !important;
            font-weight: 700;
            color: #1e3a5f;
        }

        .total-row td {
            border-top: 2px solid #38a169;
            border-bottom: 2px solid #38a169;
        }

        .actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 30px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-print {
            background: #38a169;
            color: white;
        }

        .btn-print:hover {
            background: #2f855a;
        }

        .btn-export {
            background: #667eea;
            color: white;
        }

        .btn-export:hover {
            background: #5568d3;
        }

        .btn-close {
            background: #718096;
            color: white;
        }

        .btn-close:hover {
            background: #4a5568;
        }

        @media print {
            body {
                padding: 0;
                background: white;
            }

            .container {
                box-shadow: none;
                padding: 20px;
            }

            .actions {
                display: none;
            }

            .boq-table {
                page-break-inside: auto;
            }

            .boq-table tr {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>BOQ (Bill of Quantities)</h1>
            <div class="subtitle">ê³µì‚¬ ìˆ˜ëŸ‰ ì‚°ì¶œì„œ</div>
        </div>

        <div class="info-section">
            <div class="info-item">
                <div class="info-label">ì‘ì„±ì¼</div>
                <div class="info-value" id="reportDate"></div>
            </div>
            <div class="info-item">
                <div class="info-label">ì´ ê¸°ë‘¥ ê°œìˆ˜</div>
                <div class="info-value" id="totalCount">0</div>
            </div>
            <div class="info-item">
                <div class="info-label">ì´ ë‹¨ë©´ì </div>
                <div class="info-value" id="totalArea">0 mmÂ²</div>
            </div>
            <div class="info-item">
                <div class="info-label">ì´ ì¤‘ëŸ‰</div>
                <div class="info-value" id="totalWeight">0 kg</div>
            </div>
            <div class="info-item">
                <div class="info-label">ì´ ê¸ˆì•¡</div>
                <div class="info-value" id="totalAmount" style="color: #667eea; font-size: 18px; font-weight: 700;">0ì›</div>
            </div>
        </div>

        <div style="margin-bottom: 30px;">
            <div style="margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h2 style="color: #1e3a5f; font-size: 20px; margin: 0; padding-bottom: 10px; border-bottom: 2px solid #667eea; flex: 1;">1. ê¸°ë‘¥ ë¬¼ëŸ‰ ì •ë¦¬(Cross H) - Auto Find Selection ê¸°ëŠ¥</h2>
                </div>
                <div style="display: flex; justify-content: flex-end; padding: 10px; background: #f7fafc; border-radius: 6px; margin-top: 10px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px; font-weight: 600; color: #4a5568;">
                        <input type="checkbox" id="quantityGroupingCheckbox" onchange="loadBOQData()" style="width: 18px; height: 18px; cursor: pointer;">
                        <span>ë¬¼ëŸ‰ ê¸°ì¤€ ê·¸ë£¹í•‘ (ë§ì€ ìˆœ ì •ë ¬ + ì‘ì€ ë¬¼ëŸ‰ ìœ ì‚¬ ë‹¨ë©´ í†µí•©)</span>
                    </label>
                </div>
            </div>
            <table class="boq-table">
                <thead>
                    <tr>
                        <th>No.</th>
                        <th>ê¸°ë‘¥ëª…</th>
                        <th>ì¡°í•©</th>
                        <th>H<br>(mm)</th>
                        <th>B<br>(mm)</th>
                        <th>tw<br>(mm)</th>
                        <th>tf<br>(mm)</th>
                        <th>ë‹¨ë©´ì <br>(mmÂ²)</th>
                        <th>ë‹¨ì¤‘<br>(kg/m)</th>
                        <th>ê¸¸ì´<br>(m)</th>
                        <th>ê¸¸ì´íƒ€ì…</th>
                        <th>ê°œìˆ˜</th>
                        <th>ì´ ì¤‘ëŸ‰<br>(kg)</th>
                        <th>ê°•ì¢…</th>
                        <th>ê¸ˆì•¡<br>(ì›)</th>
                </tr>
            </thead>
            <tbody id="boqTableBody">
                <!-- BOQ ë°ì´í„°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </tbody>
            <tfoot>
                <tr class="total-row">
                    <td colspan="11" class="text-right" style="font-weight: 700;">í•©ê³„</td>
                    <td id="totalCountFooter">0</td>
                    <td id="totalWeightFooter">0</td>
                    <td>-</td>
                    <td id="totalColumnAmountFooter" class="text-right" style="font-weight: 700;">0ì›</td>
                </tr>
            </tfoot>
            </table>
        </div>

        <div style="margin-top: 40px;">
            <div style="margin-bottom: 15px;">
                <h2 style="color: #1e3a5f; font-size: 20px; margin: 0; padding-bottom: 10px; border-bottom: 2px solid #667eea; flex: 1;">2. ì£¼ê¸°ë‘¥ Built-UP ë¶€ì¬ ë¬¼ëŸ‰ ì •ë¦¬</h2>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f7fafc; border-radius: 6px; margin-top: 10px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px; font-weight: 600; color: #4a5568;">
                        <input type="checkbox" id="plateGroupingCheckbox" onchange="loadBOQData()" style="width: 18px; height: 18px; cursor: pointer;">
                        <span>ë¬¼ëŸ‰ ê¸°ì¤€ ê·¸ë£¹í•‘ (ë§ì€ ìˆœ ì •ë ¬ + ì‘ì€ ë¬¼ëŸ‰ ìœ ì‚¬ ë‹¨ë©´ í†µí•©)</span>
                    </label>
                    <button onclick="showThicknessMergeModal()" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">
                        ğŸ”§ ë‘ê»˜ í†µí•© ì„¤ì •
                    </button>
                </div>
            </div>
            <table class="boq-table">
                <thead>
                    <tr>
                        <th>No.</th>
                        <th>Plate ì¢…ë¥˜<br>(ë‘ê»˜, mm)</th>
                        <th>ì‚¬ìš©ë¶€ìœ„</th>
                        <th>í­<br>(mm)</th>
                        <th>ë‘ê»˜<br>(mm)</th>
                        <th>ë‹¨ì¤‘<br>(kg/m)</th>
                        <th>ê¸¸ì´<br>(m)</th>
                        <th>ê°œìˆ˜</th>
                        <th>ì´ ì¤‘ëŸ‰<br>(kg)</th>
                        <th>ê°•ì¢…</th>
                        <th>ë¹„ê³ </th>
                    </tr>
                </thead>
                <tbody id="plateTableBody">
                    <!-- Plate ë¬¼ëŸ‰ ë°ì´í„°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td colspan="7" class="text-right" style="font-weight: 700;">í•©ê³„</td>
                        <td id="plateTotalCountFooter">0</td>
                        <td id="plateTotalWeightFooter">0</td>
                        <td>-</td>
                        <td id="plateTotalNoteFooter">-</td>
                    </tr>
                </tfoot>
            </table>
            <!-- NOTE -->
            <div style="margin-top: 15px; padding: 12px 16px; background: #fffbf0; border-left: 4px solid #f6ad55; border-radius: 6px; font-size: 13px; color: #744210; line-height: 1.6;">
                <strong>Note:</strong> ì¡°ì •ëœ Plate ë‘ê»˜ëŠ” ë‘ê»˜í†µí•©ì„¤ì •ë‚´ì— ê·œì¹™ì´ ì¡´ì¬í•˜ë¯€ë¡œ ì‹ ê·œ Auto Find Sectionì„ ì›í•˜ë©´ <span style="color: #e53e3e; font-weight: 600;">ë‘ê»˜í†µí•©ì„¤ì •ë‚´ ê·œì¹™ì„ ì‚­ì œí•˜ê³  ì‹¤í–‰</span>í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.
            </div>
        </div>

        <!-- Rolled H ë¬¼ëŸ‰ ì •ë¦¬ (ì¡°í•©3ì´ ìˆì„ ë•Œë§Œ í‘œì‹œ) -->
        <div id="rolledHSection" style="margin-top: 40px; display: none;">
            <div style="margin-bottom: 15px;">
                <h2 style="color: #1e3a5f; font-size: 20px; margin: 0; padding-bottom: 10px; border-bottom: 2px solid #667eea; flex: 1;">3. Rolled H ë¬¼ëŸ‰ ì •ë¦¬</h2>
                <div style="display: flex; justify-content: flex-end; padding: 10px; background: #f7fafc; border-radius: 6px; margin-top: 10px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px; font-weight: 600; color: #4a5568;">
                        <input type="checkbox" id="rolledHGroupingCheckbox" onchange="loadBOQData()" style="width: 18px; height: 18px; cursor: pointer;">
                        <span>ë¬¼ëŸ‰ ê¸°ì¤€ ê·¸ë£¹í•‘ (ë§ì€ ìˆœ ì •ë ¬ + ì‘ì€ ë¬¼ëŸ‰ ìœ ì‚¬ ë‹¨ë©´ í†µí•©)</span>
                    </label>
                </div>
            </div>
            <table class="boq-table">
                <thead>
                    <tr>
                        <th>No.</th>
                        <th>ê¸°ë‘¥ë²ˆí˜¸</th>
                        <th>ë‹¨ë©´ ê·œê²©</th>
                        <th>ê¸¸ì´<br>(m)</th>
                        <th>ê°œìˆ˜</th>
                        <th>ë‹¨ì¤‘<br>(kg/m)</th>
                        <th>ì´ ì¤‘ëŸ‰<br>(kg)</th>
                        <th>ê°•ì¢…</th>
                        <th>ë¹„ê³ </th>
                    </tr>
                </thead>
                <tbody id="rolledHTableBody">
                    <!-- Rolled H ë¬¼ëŸ‰ ë°ì´í„°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td colspan="4" class="text-right" style="font-weight: 700;">í•©ê³„</td>
                        <td id="rolledHTotalCountFooter">0</td>
                        <td>-</td>
                        <td id="rolledHTotalWeightFooter">0</td>
                        <td>-</td>
                        <td id="rolledHTotalNoteFooter">-</td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div id="subMaterialSection" style="margin-top: 40px;">
            <h2 id="subMaterialTitle" style="color: #1e3a5f; font-size: 20px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #667eea;">3. ì†Œë¶€ì¬ ë¬¼ëŸ‰ ì •ë¦¬</h2>
            <table class="boq-table">
                <thead>
                    <tr>
                        <th>No.</th>
                        <th>ì†Œë¶€ì¬ ì¢…ë¥˜</th>
                        <th>ê·œê²©/ì‚¬ì–‘</th>
                        <th>ë‹¨ìœ„</th>
                        <th>ìˆ˜ëŸ‰</th>
                        <th>ê°•ì¢…</th>
                        <th>ì£¼ê¸°ë‘¥ë¶€ì¬ë¬¼ëŸ‰<br>(kg)</th>
                        <th>í• ì¦<br>(15%)</th>
                        <th>ì†Œë¶€ì¬ ë‹¨ê°€<br>(ì›/í†¤)</th>
                        <th>ê¸ˆì•¡<br>(ì›)</th>
                        <th>ë¹„ê³ </th>
                    </tr>
                </thead>
                <tbody id="subMaterialTableBody">
                    <!-- ì†Œë¶€ì¬ ë¬¼ëŸ‰ ë°ì´í„°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td colspan="4" class="text-right" style="font-weight: 700;">í•©ê³„</td>
                        <td id="subMaterialTotalQtyFooter">0</td>
                        <td>-</td>
                        <td id="subMaterialTotalWeightFooter">0</td>
                        <td id="subMaterialTotalSurchargeFooter">0</td>
                        <td id="subMaterialTotalUnitPriceFooter">0</td>
                        <td id="subMaterialTotalAmountFooter">0</td>
                        <td>-</td>
                    </tr>
                </tfoot>
            </table>
        </div>


        <div class="actions">
            <button class="btn btn-print" onclick="window.print()">ğŸ–¨ï¸ ì¸ì‡„</button>
            <button class="btn btn-export" onclick="exportToCSV()">ğŸ“¥ CSV ë‹¤ìš´ë¡œë“œ</button>
            <button class="btn" style="background: #667eea; color: white;" onclick="showSubMaterialModal()">â• ì†Œë¶€ì¬ ì¶”ê°€</button>
            <button class="btn btn-close" onclick="window.close()">ë‹«ê¸°</button>
        </div>
    </div>

    <!-- ë‘ê»˜ í†µí•© ì„¤ì • ëª¨ë‹¬ -->
    <div id="thicknessMergeModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10002; align-items: center; justify-content: center; overflow-y: auto; padding: 20px;">
        <div style="background: white; border-radius: 12px; padding: 30px; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid #667eea;">
                <h2 style="color: #1e3a5f; font-size: 22px; margin: 0;">ë‘ê»˜ í†µí•© ì„¤ì •</h2>
                <button onclick="closeThicknessMergeModal()" style="background: none; border: none; font-size: 24px; color: #999; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">&times;</button>
            </div>
            
            <div style="margin-bottom: 20px; padding: 15px; background: #f7fafc; border-radius: 8px;">
                <h3 style="color: #4a5568; font-size: 16px; margin-bottom: 15px;">í˜„ì¬ ë‘ê»˜ í˜„í™©</h3>
                <div id="currentThicknessList" style="max-height: 200px; overflow-y: auto;">
                    <!-- í˜„ì¬ ë‘ê»˜ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <h3 style="color: #4a5568; font-size: 16px; margin-bottom: 15px;">ë‘ê»˜ í†µí•© ê·œì¹™ ì¶”ê°€</h3>
                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                    <label style="font-weight: 600; color: #4a5568;">From:</label>
                    <input type="number" id="mergeFromThickness" placeholder="ì˜ˆ: 11" min="1" max="100" step="1" style="padding: 8px 12px; border: 1px solid #cbd5e0; border-radius: 6px; width: 100px; font-size: 14px;">
                    <label style="font-weight: 600; color: #4a5568;">To:</label>
                    <input type="number" id="mergeToThickness" placeholder="ì˜ˆ: 12" min="1" max="100" step="1" style="padding: 8px 12px; border: 1px solid #cbd5e0; border-radius: 6px; width: 100px; font-size: 14px;">
                    <button onclick="addThicknessMergeRule()" style="padding: 8px 16px; background: #38a169; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">ì¶”ê°€</button>
                </div>
            </div>

            <div style="margin-bottom: 25px;">
                <h3 style="color: #4a5568; font-size: 16px; margin-bottom: 15px;">í†µí•© ê·œì¹™ ëª©ë¡</h3>
                <div id="mergeRulesList" style="min-height: 100px; max-height: 200px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 6px; padding: 10px;">
                    <!-- í†µí•© ê·œì¹™ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="closeThicknessMergeModal()" style="padding: 10px 20px; background: #718096; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">ì·¨ì†Œ</button>
                <button onclick="applyThicknessMerge()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">ì ìš©</button>
            </div>
        </div>
    </div>

    <script>
        // ë¬¼ëŸ‰ ê¸°ì¤€ BOQ ì•„ì´í…œ ê·¸ë£¹í•‘ í•¨ìˆ˜
        function groupBOQItemsByQuantity(items) {
            if (!items || items.length === 0) return items;

            // ê° ì•„ì´í…œì˜ ë¬¼ëŸ‰ ê³„ì‚° (unitWeight Ã— length Ã— count)
            const itemsWithQuantity = items.map(item => {
                const quantity = item.unitWeight * item.length * item.count;
                return {
                    ...item,
                    quantity: quantity
                };
            });

            // ë¬¼ëŸ‰ ìˆœìœ¼ë¡œ ì •ë ¬ (í° ê²ƒë¶€í„°)
            itemsWithQuantity.sort((a, b) => (b.quantity || 0) - (a.quantity || 0));

            // ì „ì²´ ë¬¼ëŸ‰ í•©ê³„ ê³„ì‚°
            const totalQuantity = itemsWithQuantity.reduce((sum, item) => sum + (item.quantity || 0), 0);

            // ë¬¼ëŸ‰ì´ ì ì€ í•­ëª© ê¸°ì¤€ ì„¤ì • (ì „ì²´ì˜ 5% ì´í•˜)
            const smallQuantityThreshold = totalQuantity * 0.05;

            // í° ë¬¼ëŸ‰ í•­ëª©ê³¼ ì‘ì€ ë¬¼ëŸ‰ í•­ëª© ë¶„ë¦¬
            const largeQuantityItems = [];
            const smallQuantityItems = [];

            itemsWithQuantity.forEach(item => {
                if (item.quantity >= smallQuantityThreshold) {
                    largeQuantityItems.push(item);
                } else {
                    smallQuantityItems.push(item);
                }
            });

            // ì‘ì€ ë¬¼ëŸ‰ í•­ëª©ë“¤ì„ ìœ ì‚¬í•œ ë‹¨ë©´ë¼ë¦¬ ê·¸ë£¹í•‘
            const groupedSmallItems = [];
            const tolerance = 0.15; // 15% ì˜¤ì°¨ í—ˆìš©

            smallQuantityItems.forEach(item => {
                if (!item.h || !item.b || !item.tw || !item.tf) {
                    largeQuantityItems.push(item);
                    return;
                }

                // ê¸°ì¡´ ê·¸ë£¹ì—ì„œ ìœ ì‚¬í•œ ë‹¨ë©´ ì°¾ê¸°
                let foundGroup = false;
                for (let group of groupedSmallItems) {
                    const groupItem = group.items[0];
                    if (!groupItem.h || !groupItem.b || !groupItem.tw || !groupItem.tf) continue;

                    // H, B, tw, tfê°€ ëª¨ë‘ Â±15% ì´ë‚´ì´ê³ , ì¡°í•©ê³¼ ê°•ì¢…ì´ ê°™ì€ì§€ í™•ì¸
                    const hDiff = Math.abs(item.h - groupItem.h) / groupItem.h;
                    const bDiff = Math.abs(item.b - groupItem.b) / groupItem.b;
                    const twDiff = Math.abs(item.tw - groupItem.tw) / groupItem.tw;
                    const tfDiff = Math.abs(item.tf - groupItem.tf) / groupItem.tf;
                    const sameCombination = item.combination === groupItem.combination;
                    const sameSteelGrade = item.steelGrade === groupItem.steelGrade;

                    if (hDiff <= tolerance && bDiff <= tolerance &&
                        twDiff <= tolerance && tfDiff <= tolerance &&
                        sameCombination && sameSteelGrade) {
                        // ìœ ì‚¬í•œ ë‹¨ë©´ ê·¸ë£¹ì— ì¶”ê°€
                        group.items.push(item);
                        group.totalQuantity += item.quantity || 0;
                        group.totalCount += item.count || 0;
                        group.totalLength += item.length * item.count || 0;
                        group.names.push(...item.names);
                        foundGroup = true;
                        break;
                    }
                }

                if (!foundGroup) {
                    // ìƒˆë¡œìš´ ê·¸ë£¹ ìƒì„±
                    groupedSmallItems.push({
                        items: [item],
                        totalQuantity: item.quantity || 0,
                        totalCount: item.count || 0,
                        totalLength: item.length * item.count || 0,
                        names: [...item.names],
                        representative: item
                    });
                }
            });

            // ê·¸ë£¹í•‘ëœ ì‘ì€ ë¬¼ëŸ‰ í•­ëª©ë“¤ì„ í•˜ë‚˜ì˜ ì•„ì´í…œìœ¼ë¡œ ë³€í™˜
            const groupedItems = groupedSmallItems.map(group => {
                const rep = group.representative;
                const avgLength = group.totalCount > 0 ? group.totalLength / group.totalCount : rep.length;
                
                return {
                    ...rep,
                    names: group.names.length > 1 ? 
                        [`${group.names[0]} ì™¸ ${group.names.length - 1}ê°œ`] : 
                        group.names,
                    quantity: group.totalQuantity,
                    count: group.totalCount,
                    length: avgLength,
                    isGrouped: true,
                    originalNames: group.names,
                    originalCount: group.items.length
                };
            });

            // í° ë¬¼ëŸ‰ í•­ëª© + ê·¸ë£¹í•‘ëœ ì‘ì€ ë¬¼ëŸ‰ í•­ëª© (ê·¸ë£¹í•‘ëœ í•­ëª©ë„ ë¬¼ëŸ‰ìˆœ ì •ë ¬)
            groupedItems.sort((a, b) => (b.quantity || 0) - (a.quantity || 0));

            return [...largeQuantityItems, ...groupedItems];
        }

        // BOQ ë°ì´í„° ë¡œë“œ
        function loadBOQData() {
            const boqData = JSON.parse(localStorage.getItem('boqData')) || null;
            
            if (!boqData || !boqData.items || boqData.items.length === 0) {
                document.getElementById('boqTableBody').innerHTML = 
                    '<tr><td colspan="14" style="text-align: center; padding: 30px; color: #999;">BOQ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                document.getElementById('plateTableBody').innerHTML = 
                    '<tr><td colspan="10" style="text-align: center; padding: 30px; color: #999;">Plate ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            // ì‘ì„±ì¼ í‘œì‹œ
            const now = new Date();
            document.getElementById('reportDate').textContent = 
                `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;

            // ì´ê³„ ê³„ì‚°
            let totalCount = 0;
            let totalArea = 0;
            let totalWeight = 0;
            let totalColumnAmount = 0;
            // ì €ì¥ëœ ì£¼ë¶€ì¬ ë‹¨ê°€ ë¶ˆëŸ¬ì˜¤ê¸° (ê¸°ë³¸ê°’: SM420 1,900,000ì›/í†¤, SM355 1,830,000ì›/í†¤)
            const savedPrices = JSON.parse(localStorage.getItem('boqUnitPrices')) || {};
            const columnUnitPriceSM420 = savedPrices.mainMaterialSM420 || 1900000; // SM420 í†¤ë‹¹ ë‹¨ê°€ (ì›)
            const columnUnitPriceSM355 = savedPrices.mainMaterialSM355 || 1830000; // SM355 í†¤ë‹¹ ë‹¨ê°€ (ì›)
            const steelDensity = 7850; // kg/mÂ³

            const tbody = document.getElementById('boqTableBody');
            tbody.innerHTML = '';

            // ë¬¼ëŸ‰ ê¸°ì¤€ ê·¸ë£¹í•‘ ì ìš© ì—¬ë¶€ í™•ì¸
            const applyGrouping = document.getElementById('quantityGroupingCheckbox')?.checked || false;
            let itemsToDisplay = boqData.items;

            // ê·¸ë£¹í•‘ì´ í™œì„±í™”ëœ ê²½ìš°
            if (applyGrouping) {
                itemsToDisplay = groupBOQItemsByQuantity(boqData.items);
            } else {
                // ê·¸ë£¹í•‘ì´ ë¹„í™œì„±í™”ëœ ê²½ìš° ì›ë³¸ ìˆœì„œ ìœ ì§€
                itemsToDisplay = boqData.items;
            }

            itemsToDisplay.forEach((item, index) => {
                const totalWeightItem = item.unitWeight * item.length * item.count;
                totalCount += item.count;
                totalArea += item.area * item.count;
                totalWeight += totalWeightItem;

                // ê¸°ë‘¥ ê¸ˆì•¡ ê³„ì‚°: ì¤‘ëŸ‰(í†¤) Ã— ë‹¨ê°€ (ê°•ì¢…ë³„)
                const weightInTon = totalWeightItem / 1000; // kg to ton
                let columnUnitPrice = 0;
                if (item.steelGrade === 'SM420' || item.steelGrade.includes('SM420')) {
                    columnUnitPrice = columnUnitPriceSM420;
                } else if (item.steelGrade === 'SM355' || item.steelGrade.includes('SM355')) {
                    columnUnitPrice = columnUnitPriceSM355;
                } else {
                    columnUnitPrice = columnUnitPriceSM420; // ê¸°ë³¸ê°’
                }
                const columnAmount = weightInTon * columnUnitPrice;
                totalColumnAmount += columnAmount;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td class="text-left">${item.names.join(', ')}</td>
                    <td>${item.combination}</td>
                    <td>${item.h}</td>
                    <td>${item.b}</td>
                    <td>${item.tw}</td>
                    <td>${item.tf}</td>
                    <td class="text-right">${item.area.toFixed(2)}</td>
                    <td class="text-right">${item.unitWeight.toFixed(2)}</td>
                    <td class="text-right">${item.length.toFixed(2)}</td>
                    <td>Type${item.lengthType || ''}</td>
                    <td>${item.count}</td>
                    <td class="text-right">${parseFloat(totalWeightItem.toFixed(2)).toLocaleString('ko-KR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td>${item.steelGrade}</td>
                    <td class="text-right">${columnAmount > 0 ? Math.round(columnAmount).toLocaleString('ko-KR') : '-'}</td>
                `;
                tbody.appendChild(row);
            });

            // ì´ê³„ í‘œì‹œ
            document.getElementById('totalCount').textContent = totalCount;
            document.getElementById('totalArea').textContent = totalArea.toFixed(2) + ' mmÂ²';
            document.getElementById('totalWeight').textContent = parseFloat(totalWeight.toFixed(2)).toLocaleString('ko-KR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' kg';
            document.getElementById('totalCountFooter').textContent = totalCount;
            document.getElementById('totalWeightFooter').textContent = parseFloat(totalWeight.toFixed(2)).toLocaleString('ko-KR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('totalColumnAmountFooter').textContent = totalColumnAmount > 0 ? Math.round(totalColumnAmount).toLocaleString('ko-KR') + 'ì›' : '0ì›';

            // ì¡°í•©1/2(Built-UP)ì™€ ì¡°í•©3(Rolled H) ë¶„ë¦¬ (ê·¸ë£¹í•‘ ì ìš©ëœ items ì‚¬ìš©)
            const comb3Names = ['H400Ã—B200', 'H450Ã—B200', 'H500Ã—B200', 'H506Ã—B201', 'H482Ã—B300', 'H488Ã—B300', 'H582Ã—B300', 'H588Ã—B300', 'H600Ã—B200'];
            const rolledHItems = itemsToDisplay.filter(item => {
                return comb3Names.some(name => item.combination === name);
            });
            const builtUpItems = itemsToDisplay.filter(item => {
                return !comb3Names.some(name => item.combination === name);
            });
            
            // ì¡°í•©1/2ì™€ ì¡°í•©3ì´ í•¨ê»˜ ìˆëŠ”ì§€ í™•ì¸
            const hasComb1_2 = builtUpItems.length > 0;
            const hasComb3 = rolledHItems.length > 0;
            const hasBoth = hasComb1_2 && hasComb3;
            
            // Built-UP ë¶€ì¬ Plate ë¬¼ëŸ‰ ì •ë¦¬ (ì¡°í•©1/2ë§Œ ì²˜ë¦¬)
            if (hasComb1_2) {
                generatePlateBOQ(builtUpItems);
            }
            
            // ì¡°í•©1/2ì™€ ì¡°í•©3ì´ í•¨ê»˜ ìˆì„ ë•Œë§Œ Rolled H ë¬¼ëŸ‰ ì •ë¦¬ í‘œì‹œ
            if (hasBoth) {
                generateRolledHBOQ(rolledHItems);
                // ì†Œë¶€ì¬ ë¬¼ëŸ‰ ì •ë¦¬ ì œëª©ì„ "4. ì†Œë¶€ì¬ ë¬¼ëŸ‰ ì •ë¦¬"ë¡œ ë³€ê²½
                document.getElementById('subMaterialTitle').textContent = '4. ì†Œë¶€ì¬ ë¬¼ëŸ‰ ì •ë¦¬';
            } else {
                // ì¡°í•©3ë§Œ ìˆê±°ë‚˜ ì—†ìœ¼ë©´ Rolled H ì„¹ì…˜ ìˆ¨ê¹€
                document.getElementById('rolledHSection').style.display = 'none';
                // ì†Œë¶€ì¬ ë¬¼ëŸ‰ ì •ë¦¬ ì œëª©ì„ "3. ì†Œë¶€ì¬ ë¬¼ëŸ‰ ì •ë¦¬"ë¡œ ìœ ì§€
                document.getElementById('subMaterialTitle').textContent = '3. ì†Œë¶€ì¬ ë¬¼ëŸ‰ ì •ë¦¬';
            }
            
            // ì´ ê¸ˆì•¡ ê³„ì‚° ë° í‘œì‹œ (ê¸°ë‘¥ ê¸ˆì•¡ + ì†Œë¶€ì¬ ê¸ˆì•¡)
            updateTotalAmount();
        }

        // ì´ ê¸ˆì•¡ ì—…ë°ì´íŠ¸
        function updateTotalAmount() {
            // ê¸°ë‘¥ ê¸ˆì•¡ í•©ê³„
            const totalColumnAmount = parseFloat(
                document.getElementById('totalColumnAmountFooter').textContent.replace(/[^0-9.]/g, '')
            ) || 0;
            
            // ì†Œë¶€ì¬ ê¸ˆì•¡ í•©ê³„
            const subMaterialTotalAmount = parseFloat(
                document.getElementById('subMaterialTotalAmountFooter').textContent.replace(/[^0-9.]/g, '')
            ) || 0;
            
            // ì´ ê¸ˆì•¡ = ê¸°ë‘¥ ê¸ˆì•¡ + ì†Œë¶€ì¬ ê¸ˆì•¡
            const totalAmount = totalColumnAmount + subMaterialTotalAmount;
            
            // ì´ ê¸ˆì•¡ í‘œì‹œ (ì†Œìˆ˜ì  ì œê±°)
            document.getElementById('totalAmount').textContent = Math.round(totalAmount).toLocaleString('ko-KR') + 'ì›';
        }

        // Plate ë¬¼ëŸ‰ ê¸°ì¤€ ê·¸ë£¹í•‘ í•¨ìˆ˜
        function groupPlateItemsByQuantity(plates) {
            if (!plates || plates.length === 0) return plates;

            // ë¬¼ëŸ‰ ìˆœìœ¼ë¡œ ì •ë ¬ (í° ê²ƒë¶€í„°)
            plates.sort((a, b) => (b.totalWeight || 0) - (a.totalWeight || 0));

            // ì „ì²´ ë¬¼ëŸ‰ í•©ê³„ ê³„ì‚°
            const totalQuantity = plates.reduce((sum, plate) => sum + (plate.totalWeight || 0), 0);

            // ë¬¼ëŸ‰ì´ ì ì€ í•­ëª© ê¸°ì¤€ ì„¤ì • (ì „ì²´ì˜ 5% ì´í•˜)
            const smallQuantityThreshold = totalQuantity * 0.05;

            // í° ë¬¼ëŸ‰ í•­ëª©ê³¼ ì‘ì€ ë¬¼ëŸ‰ í•­ëª© ë¶„ë¦¬
            const largeQuantityItems = [];
            const smallQuantityItems = [];

            plates.forEach(plate => {
                if (plate.totalWeight >= smallQuantityThreshold) {
                    largeQuantityItems.push(plate);
                } else {
                    smallQuantityItems.push(plate);
                }
            });

            // ì‘ì€ ë¬¼ëŸ‰ í•­ëª©ë“¤ì„ ìœ ì‚¬í•œ ë‹¨ë©´(ë‘ê»˜, í­)ë¼ë¦¬ ê·¸ë£¹í•‘
            const groupedSmallItems = [];
            const tolerance = 0.15; // 15% ì˜¤ì°¨ í—ˆìš©
            
            // ì €ì¥ëœ ë‘ê»˜ í†µí•© ê·œì¹™ ì‚¬ìš© (ìµœì‹  ê°’ ë¡œë“œ)
            const thicknessMapping = JSON.parse(localStorage.getItem('thicknessMergeRules')) || {};

            smallQuantityItems.forEach(plate => {
                if (!plate.thickness_mm || !plate.avgWidth) {
                    largeQuantityItems.push(plate);
                    return;
                }

                // ì›ë³¸ ë‘ê»˜ ì €ì¥ (ë§¤í•‘ ì „)
                const originalThickness = plate.thickness_mm;

                // ë‘ê»˜ ë§¤í•‘ ì ìš© (ì‚¬ìš©ìê°€ ì„¤ì •í•œ ê·œì¹™ ì‚¬ìš©) - ë°ì´í„° ê°’ ìì²´ë¥¼ ë³€ê²½
                if (thicknessMapping[plate.thickness_mm]) {
                    plate.thickness_mm = thicknessMapping[plate.thickness_mm];
                    plate.thickness = thicknessMapping[plate.thickness_mm];
                }
                const adjustedThickness = plate.thickness_mm;
                
                // ì›ë³¸ ë‘ê»˜ ì •ë³´ë¥¼ plate ê°ì²´ì— ì €ì¥
                plate._originalThickness = originalThickness;

                // ê¸°ì¡´ ê·¸ë£¹ì—ì„œ ìœ ì‚¬í•œ ë‹¨ë©´ ì°¾ê¸°
                let foundGroup = false;
                for (let group of groupedSmallItems) {
                    const groupPlate = group.items[0];
                    if (!groupPlate.thickness_mm || !groupPlate.avgWidth) continue;

                    // ë‘ê»˜ê°€ ê°™ê±°ë‚˜, ë‘ê»˜ì™€ í­ì´ Â±15% ì´ë‚´ì¸ì§€ í™•ì¸
                    const thicknessMatch = adjustedThickness === groupPlate.thickness_mm;
                    const thicknessDiff = Math.abs(adjustedThickness - groupPlate.thickness_mm) / groupPlate.thickness_mm;
                    const widthDiff = Math.abs(plate.avgWidth - groupPlate.avgWidth) / groupPlate.avgWidth;

                    if (thicknessMatch || (thicknessDiff <= tolerance && widthDiff <= tolerance)) {
                        // ìœ ì‚¬í•œ ë‹¨ë©´ ê·¸ë£¹ì— ì¶”ê°€
                        group.items.push(plate);
                        group.totalWeight += plate.totalWeight || 0;
                        group.totalCount += plate.totalCount || 0;
                        group.totalLength += plate.totalLength || 0;
                        group.usageParts = [...new Set([...group.usageParts.split(', '), ...plate.usageParts.split(', ')])].join(', ');
                        
                        // ì›ë³¸ ë‘ê»˜ ì •ë³´ ì €ì¥
                        if (!group.originalThicknessMap) {
                            group.originalThicknessMap = {};
                        }
                        const originalThick = plate._originalThickness || plate.thickness_mm;
                        if (!group.originalThicknessMap[originalThick]) {
                            group.originalThicknessMap[originalThick] = 0;
                        }
                        group.originalThicknessMap[originalThick] += plate.totalWeight || 0;
                        
                        foundGroup = true;
                        break;
                    }
                }

                if (!foundGroup) {
                    // ìƒˆë¡œìš´ ê·¸ë£¹ ìƒì„± (ì›ë³¸ ë‘ê»˜ ì •ë³´ ì €ì¥)
                    const originalThick = plate._originalThickness || plate.thickness_mm;
                    const newGroup = {
                        items: [plate],
                        totalWeight: plate.totalWeight || 0,
                        totalCount: plate.totalCount || 0,
                        totalLength: plate.totalLength || 0,
                        usageParts: plate.usageParts,
                        representative: plate,  // ë§¤í•‘ëœ ë‘ê»˜ê°€ ì ìš©ëœ plate ì‚¬ìš©
                        originalThicknessMap: {}
                    };
                    newGroup.originalThicknessMap[originalThick] = plate.totalWeight || 0;
                    groupedSmallItems.push(newGroup);
                }
            });

            // í†µí•© ì „ ë¬¼ëŸ‰ ì •ë³´ë¥¼ ì €ì¥í•˜ê¸° ìœ„í•œ ì›ë³¸ ë°ì´í„° ë³µì‚¬
            const originalPlatesMap = {};
            smallQuantityItems.forEach(plate => {
                // ì›ë³¸ ë‘ê»˜ ì •ë³´ ì €ì¥ (ë§¤í•‘ ì „)
                const originalThickness = thicknessMapping[plate.thickness_mm] ? 
                    Object.keys(thicknessMapping).find(k => thicknessMapping[k] === plate.thickness_mm) || plate.thickness_mm :
                    plate.thickness_mm;
                const key = `${plate.thickness_mm}_${plate.avgWidth}_${plate.usageParts}`;
                originalPlatesMap[key] = {
                    originalThickness: originalThickness,
                    weight: plate.totalWeight
                };
            });

            // ê·¸ë£¹í•‘ëœ ì‘ì€ ë¬¼ëŸ‰ í•­ëª©ë“¤ì„ í•˜ë‚˜ì˜ ì•„ì´í…œìœ¼ë¡œ ë³€í™˜
            const groupedItems = groupedSmallItems.map(group => {
                const rep = group.representative;
                const avgUnitWeight = group.totalLength > 0 ? group.totalWeight / group.totalLength : rep.unitWeight;
                
                // í†µí•© ì „ ë¬¼ëŸ‰ ì •ë³´ ìˆ˜ì§‘ (ê·¸ë£¹ì˜ itemsì—ì„œ ì›ë³¸ ë‘ê»˜ í™•ì¸)
                const thicknessBeforeMerge = group.originalThicknessMap || {};
                
                // group.itemsì˜ ì›ë³¸ ë‘ê»˜ ì •ë³´ë¡œ ì¶”ê°€ ë³´ì •
                group.items.forEach(item => {
                    // ì›ë³¸ ë‘ê»˜ ì‚¬ìš© (_originalThicknessê°€ ì €ì¥ë˜ì–´ ìˆìœ¼ë©´ ì‚¬ìš©)
                    const originalThickness = item._originalThickness || item.thickness_mm;
                    
                    if (!thicknessBeforeMerge[originalThickness]) {
                        thicknessBeforeMerge[originalThickness] = 0;
                    }
                    thicknessBeforeMerge[originalThickness] += item.totalWeight || 0;
                });
                
                // í†µí•© ì •ë³´ í…ìŠ¤íŠ¸ ìƒì„±
                const mergeInfoParts = [];
                Object.keys(thicknessBeforeMerge).sort((a, b) => parseFloat(a) - parseFloat(b)).forEach(thick => {
                    const weight = thicknessBeforeMerge[thick];
                    mergeInfoParts.push(`${thick}mm: ${parseFloat(weight.toFixed(2)).toLocaleString('ko-KR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}kg`);
                });
                const mergeInfo = mergeInfoParts.join(', ');
                const mergedThickness = rep.thickness_mm;
                const mergedWeight = group.totalWeight;
                
                // ë§¤í•‘ëœ ë‘ê»˜ê°€ ì ìš©ëœ ê°ì²´ ìƒì„± (ë°ì´í„° ê°’ ìì²´ë¥¼ ë³€ê²½)
                const mappedPlate = {
                    ...rep,
                    thickness_mm: rep.thickness_mm,  // ì´ë¯¸ ë§¤í•‘ì´ ì ìš©ëœ ê°’
                    thickness: rep.thickness_mm,     // ì´ë¯¸ ë§¤í•‘ì´ ì ìš©ëœ ê°’
                    usageParts: group.usageParts,
                    totalWeight: group.totalWeight,
                    totalCount: group.totalCount,
                    totalLength: group.totalLength,
                    unitWeight: avgUnitWeight,
                    isGrouped: true,
                    originalCount: group.items.length,
                    mergeInfo: mergeInfoParts.length > 0 ? `${mergeInfo} â†’ ${mergedThickness}mm: ${parseFloat(mergedWeight.toFixed(2)).toLocaleString('ko-KR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}kg` : ''
                };
                
                return mappedPlate;
            });

            // í° ë¬¼ëŸ‰ í•­ëª© + ê·¸ë£¹í•‘ëœ ì‘ì€ ë¬¼ëŸ‰ í•­ëª© (ê·¸ë£¹í•‘ëœ í•­ëª©ë„ ë¬¼ëŸ‰ìˆœ ì •ë ¬)
            groupedItems.sort((a, b) => (b.totalWeight || 0) - (a.totalWeight || 0));

            return [...largeQuantityItems, ...groupedItems];
        }

        // Built-UP ë¶€ì¬ Plate ë¬¼ëŸ‰ ì •ë¦¬ ìƒì„±
        function generatePlateBOQ(items) {
            const plateData = {}; // { "tw8-H1-Web": {...}, "tf13-H1-Flange": {...} }
            const steelDensity = 7850; // kg/mÂ³
            
            // ì¡°í•©3(Rolled H) ì œì™¸: Built-UP ë¶€ì¬ ë¬¼ëŸ‰ ì •ë¦¬ì—ì„œëŠ” ì¡°í•©3ì„ ë¹¼ê³  ì²˜ë¦¬
            const comb3Names = ['H400Ã—B200', 'H450Ã—B200', 'H500Ã—B200', 'H506Ã—B201', 'H482Ã—B300', 'H488Ã—B300', 'H582Ã—B300', 'H588Ã—B300', 'H600Ã—B200'];
            const builtUpItemsOnly = items.filter(item => {
                return !comb3Names.some(name => item.combination === name);
            });
            
            // ì €ì¥ëœ ë‘ê»˜ í†µí•© ê·œì¹™ ì‚¬ìš© (ìµœì‹  ê°’ ë¡œë“œ)
            const thicknessMapping = JSON.parse(localStorage.getItem('thicknessMergeRules')) || {};

            builtUpItemsOnly.forEach(item => {
                // Auto Find Sectionì—ì„œ ì €ì¥ëœ H1, H2, B1, B2 ì‚¬ìš© (ì—†ìœ¼ë©´ h, b ì‚¬ìš©)
                const H1 = item.H1 || item.h;
                const H2 = item.H2 || item.h;
                const B1 = item.B1 || item.b;
                const B2 = item.B2 || item.b;
                
                // ë””ë²„ê¹…: H1, H2, B1, B2 ê°’ í™•ì¸
                if (!item.H1 || !item.H2 || !item.B1 || !item.B2) {
                    console.warn('[BOQ Plate] H1/H2/B1/B2ê°€ ì—†ì–´ì„œ h/b ì‚¬ìš©:', {
                        name: item.names?.[0] || 'unknown',
                        H1: item.H1, H2: item.H2, B1: item.B1, B2: item.B2,
                        h: item.h, b: item.b,
                        ì‚¬ìš©ê°’: { H1, H2, B1, B2 }
                    });
                }
                
                // ì›ë³¸ ë‘ê»˜ ì €ì¥
                const originalTw1 = item.tw;
                const originalTw2 = item.tw;
                const originalTf1 = item.tf;
                const originalTf2 = item.tf;
                
                // ì›ë³¸ í­ ì €ì¥ (ì›ë³¸ tfë¡œ ê³„ì‚°)
                const originalH1WebWidth = H1 - 2 * originalTf1;
                const originalH2WebWidth = H2 - 2 * originalTf2;
                
                // ë‘ê»˜ ë§¤í•‘ ì ìš© (8mm â†’ 9mm ë“±)
                let tw1 = item.tw;
                let tw2 = item.tw;
                let tf1 = item.tf;
                let tf2 = item.tf;
                
                if (thicknessMapping[tw1]) {
                    tw1 = thicknessMapping[tw1];
                }
                if (thicknessMapping[tw2]) {
                    tw2 = thicknessMapping[tw2];
                }
                if (thicknessMapping[tf1]) {
                    tf1 = thicknessMapping[tf1];
                }
                if (thicknessMapping[tf2]) {
                    tf2 = thicknessMapping[tf2];
                }

                // H1 Web Plate (tw1)
                const h1WebKey = `tw${tw1}-H1-Web`;
                if (!plateData[h1WebKey]) {
                    const webWidth = H1 - 2 * tf1; // Web ì‹¤ì œ í­ (í†µí•© í›„)
                    plateData[h1WebKey] = {
                        thickness: tw1,
                        type: 'Web',
                        section: 'H1',
                        width: webWidth,
                        thickness_mm: tw1,
                        originalThickness: originalTw1, // ì›ë³¸ ë‘ê»˜ ì €ì¥
                        originalWidth: originalH1WebWidth, // ì›ë³¸ í­ ì €ì¥
                        unitWeight: 0,
                        totalLength: 0,
                        totalCount: 0,
                        totalWeight: 0,
                        steelGrade: item.steelGrade
                    };
                }
                plateData[h1WebKey].totalLength += item.length * item.count;
                plateData[h1WebKey].totalCount += item.count;

                // H1 Flange Plate (tf1) - ìƒí•˜ 2ê°œ
                const h1FlangeKey = `tf${tf1}-H1-Flange`;
                if (!plateData[h1FlangeKey]) {
                    plateData[h1FlangeKey] = {
                        thickness: tf1,
                        type: 'Flange',
                        section: 'H1',
                        width: B1,
                        thickness_mm: tf1,
                        originalThickness: originalTf1, // ì›ë³¸ ë‘ê»˜ ì €ì¥
                        unitWeight: 0,
                        totalLength: 0,
                        totalCount: 0,
                        totalWeight: 0,
                        steelGrade: item.steelGrade
                    };
                }
                plateData[h1FlangeKey].totalLength += item.length * item.count * 2;
                plateData[h1FlangeKey].totalCount += item.count * 2;

                // H2 Web Plate (tw2)
                const h2WebKey = `tw${tw2}-H2-Web`;
                if (!plateData[h2WebKey]) {
                    const webWidth = H2 - 2 * tf2; // Web ì‹¤ì œ í­ (í†µí•© í›„)
                    plateData[h2WebKey] = {
                        thickness: tw2,
                        type: 'Web',
                        section: 'H2',
                        width: webWidth,
                        thickness_mm: tw2,
                        originalThickness: originalTw2, // ì›ë³¸ ë‘ê»˜ ì €ì¥
                        originalWidth: originalH2WebWidth, // ì›ë³¸ í­ ì €ì¥
                        unitWeight: 0,
                        totalLength: 0,
                        totalCount: 0,
                        totalWeight: 0,
                        steelGrade: item.steelGrade
                    };
                }
                plateData[h2WebKey].totalLength += item.length * item.count;
                plateData[h2WebKey].totalCount += item.count;

                // H2 Flange Plate (tf2) - ì¢Œìš° 2ê°œ
                const h2FlangeKey = `tf${tf2}-H2-Flange`;
                if (!plateData[h2FlangeKey]) {
                    plateData[h2FlangeKey] = {
                        thickness: tf2,
                        type: 'Flange',
                        section: 'H2',
                        width: B2,
                        thickness_mm: tf2,
                        originalThickness: originalTf2, // ì›ë³¸ ë‘ê»˜ ì €ì¥
                        unitWeight: 0,
                        totalLength: 0,
                        totalCount: 0,
                        totalWeight: 0,
                        steelGrade: item.steelGrade
                    };
                }
                plateData[h2FlangeKey].totalLength += item.length * item.count * 2;
                plateData[h2FlangeKey].totalCount += item.count * 2;
            });

            // ë‹¨ì¤‘ ê³„ì‚° ë° ì´ ì¤‘ëŸ‰ ê³„ì‚°
            Object.keys(plateData).forEach(key => {
                const plate = plateData[key];
                
                // ì›ë³¸ ë‘ê»˜ë¡œ ë‹¨ì¤‘ ê³„ì‚° (í†µí•© ì „ ë¬¼ëŸ‰) - ì›ë³¸ í­ ì‚¬ìš©
                const originalThickness = plate.originalThickness || plate.thickness_mm;
                const originalWidth = plate.originalWidth || plate.width; // ì›ë³¸ í­ (í†µí•© ì „)
                const originalUnitWeight = (originalWidth * originalThickness * steelDensity) / 1000000;
                const originalTotalWeight = originalUnitWeight * plate.totalLength;
                
                // í†µí•© í›„ ë‘ê»˜ë¡œ ë‹¨ì¤‘ ê³„ì‚° (í†µí•© í›„ ë¬¼ëŸ‰)
                plate.unitWeight = (plate.width * plate.thickness_mm * steelDensity) / 1000000;
                plate.totalWeight = plate.unitWeight * plate.totalLength;
                
                // ì›ë³¸ ë¬¼ëŸ‰ ì €ì¥ (í†µí•© ê·œì¹™ í™•ì¸ìš©)
                plate.originalTotalWeight = originalTotalWeight;
                plate.originalThicknessValue = originalThickness; // ì›ë³¸ ë‘ê»˜ ê°’ ì €ì¥
                
                // ë””ë²„ê¹…: ë‘ê»˜ í†µí•©ì´ ì ìš©ëœ ê²½ìš° ì½˜ì†”ì— ì¶œë ¥
                if (originalThickness !== plate.thickness_mm) {
                    console.log(`[ë‘ê»˜ í†µí•©] ${key}: ${originalThickness}mm â†’ ${plate.thickness_mm}mm`, {
                        ì›ë³¸ë¬¼ëŸ‰: originalTotalWeight.toFixed(2) + 'kg',
                        í†µí•©í›„ë¬¼ëŸ‰: plate.totalWeight.toFixed(2) + 'kg',
                        ê¸¸ì´: plate.totalLength.toFixed(2) + 'm',
                        í­: plate.width.toFixed(2) + 'mm'
                    });
                }
            });

            // ë‘ê»˜ë³„ë¡œ ê·¸ë£¹í™”í•˜ì—¬ í•©ì‚°
            const plateByThickness = {}; // { "8": [...], "13": [...] }
            
            Object.keys(plateData).forEach(key => {
                const plate = plateData[key];
                const thickness = plate.thickness_mm;
                
                if (!plateByThickness[thickness]) {
                    plateByThickness[thickness] = [];
                }
                plateByThickness[thickness].push(plate);
            });

            // ë‘ê»˜ë³„ í•©ì‚° ë°ì´í„° ìƒì„±
            const aggregatedPlates = [];
            Object.keys(plateByThickness).sort((a, b) => parseFloat(a) - parseFloat(b)).forEach(thickness => {
                const plates = plateByThickness[thickness];
                
                // ì‚¬ìš©ë¶€ìœ„ ì •ë³´ ìˆ˜ì§‘ (ì¤‘ë³µ ì œê±°)
                const usageParts = plates.map(p => `${p.section} ${p.type}`).join(', ');
                
                // í­ ì •ë³´ (í‰ê·  ë˜ëŠ” ëŒ€í‘œê°’, ì‹¤ì œë¡œëŠ” ê°ê° ë‹¤ë¥¼ ìˆ˜ ìˆìŒ)
                // í•©ì‚° ì‹œì—ëŠ” ê° Plateì˜ ì¤‘ëŸ‰ì„ í•©ì‚°í•˜ë¯€ë¡œ í­ì€ í‘œì‹œìš©ìœ¼ë¡œ í‰ê·  ì‚¬ìš©
                const avgWidth = plates.reduce((sum, p) => sum + p.width, 0) / plates.length;
                
                // ì´ ê¸¸ì´, ê°œìˆ˜, ì¤‘ëŸ‰ í•©ì‚°
                const totalLength = plates.reduce((sum, p) => sum + p.totalLength, 0);
                const totalCount = plates.reduce((sum, p) => sum + p.totalCount, 0);
                const totalWeight = plates.reduce((sum, p) => sum + p.totalWeight, 0);
                
                // í‰ê·  ë‹¨ì¤‘ ê³„ì‚° (ì´ ì¤‘ëŸ‰ / ì´ ê¸¸ì´)
                const avgUnitWeight = totalLength > 0 ? totalWeight / totalLength : 0;
                
                // ê°•ì¢… (ëª¨ë‘ ë™ì¼í•˜ë‹¤ê³  ê°€ì •)
                const steelGrade = plates[0].steelGrade;
                
                // ì›ë³¸ ë‘ê»˜ ì •ë³´ ìˆ˜ì§‘ (ë§¤í•‘ ì „ ë‘ê»˜)
                // originalThickness ë˜ëŠ” originalThicknessValueë¥¼ ì‚¬ìš©
                const originalThicknesses = plates.map(p => {
                    return p.originalThickness || p.originalThicknessValue || p.thickness_mm;
                }).filter((t, i, arr) => arr.indexOf(t) === i);
                
                // ì›ë³¸ ë¬¼ëŸ‰ í•©ì‚° (í†µí•© ì „ ë¬¼ëŸ‰) - ê° Plateì˜ originalTotalWeight í•©ì‚°
                const originalTotalWeight = plates.reduce((sum, p) => sum + (p.originalTotalWeight || p.totalWeight), 0);
                
                // ë””ë²„ê¹…: ëª¨ë“  ë‘ê»˜ë³„ í•©ì‚° ì •ë³´ ì¶œë ¥ (8mm, 9mm, 11mm, 12mm í¬í•¨)
                console.log(`[í…Œì´ë¸” ë‘ê»˜ë³„ í•©ì‚°] ${thickness}mm:`, {
                    ì›ë³¸ë‘ê»˜: originalThicknesses.join(', ') + 'mm',
                    ì›ë³¸ë¬¼ëŸ‰: originalTotalWeight.toFixed(2) + 'kg',
                    í†µí•©í›„ë¬¼ëŸ‰: totalWeight.toFixed(2) + 'kg',
                    ì°¨ì´: (totalWeight - originalTotalWeight).toFixed(2) + 'kg',
                    ì´ê¸¸ì´: totalLength.toFixed(2) + 'm',
                    ì´ê°œìˆ˜: totalCount + 'ê°œ',
                    plateê°œìˆ˜: plates.length + 'ê°œ'
                });
                
                aggregatedPlates.push({
                    thickness: parseFloat(thickness),
                    usageParts: usageParts,
                    avgWidth: avgWidth,
                    thickness_mm: parseFloat(thickness),
                    originalThicknesses: originalThicknesses, // ì›ë³¸ ë‘ê»˜ ëª©ë¡
                    originalTotalWeight: originalTotalWeight, // ì›ë³¸ ë¬¼ëŸ‰ (í†µí•© ì „)
                    unitWeight: avgUnitWeight,
                    totalLength: totalLength,
                    totalCount: totalCount,
                    totalWeight: totalWeight, // í†µí•© í›„ ë¬¼ëŸ‰
                    steelGrade: steelGrade
                });
            });

            // ë¬¼ëŸ‰ ê¸°ì¤€ ê·¸ë£¹í•‘ ì ìš© ì—¬ë¶€ í™•ì¸
            const applyPlateGrouping = document.getElementById('plateGroupingCheckbox')?.checked || false;
            let platesToDisplay = aggregatedPlates;

            // ê·¸ë£¹í•‘ì´ í™œì„±í™”ëœ ê²½ìš°
            if (applyPlateGrouping) {
                platesToDisplay = groupPlateItemsByQuantity(aggregatedPlates);
            }

            // Plate í…Œì´ë¸” ë Œë”ë§
            const plateTbody = document.getElementById('plateTableBody');
            plateTbody.innerHTML = '';

            let plateTotalCount = 0;
            let plateTotalWeight = 0;
            let rowNo = 1;

            // ë‘ê»˜ ë§¤í•‘ ê·œì¹™: í…Œì´ë¸” í‘œì‹œìš© (11mm â†’ 12mm)
            const thicknessDisplayMapping = {
                11: 12  // 11mmë¥¼ 12mmë¡œ í‘œì‹œ
            };

            platesToDisplay.forEach(plate => {
                plateTotalCount += plate.totalCount;
                plateTotalWeight += plate.totalWeight;

                // 25í†¤(25,000kg) ë¯¸ë§Œì¸ ê²½ìš° "í›„íŒì£¼ë¬¸" ë…¸íŠ¸ ì¶”ê°€
                const weightInTon = plate.totalWeight / 1000;
                const note = weightInTon < 25 ? 'í›„íŒì£¼ë¬¸' : '';
                
                // í†µí•© ì •ë³´ê°€ ìˆìœ¼ë©´ ë¹„ê³ ì— í‘œì‹œ
                let mergeNote = '';
                const thicknessMapping = JSON.parse(localStorage.getItem('thicknessMergeRules')) || {};
                
                if (plate.mergeInfo) {
                    // ê·¸ë£¹í•‘ëœ í•­ëª©ì˜ í†µí•© ì •ë³´
                    mergeNote = plate.mergeInfo;
                } else {
                    // ê·¸ë£¹í•‘ë˜ì§€ ì•Šì€ í•­ëª©: ë‘ê»˜ í†µí•© ê·œì¹™ í™•ì¸
                    // í˜„ì¬ ë‘ê»˜ê°€ í†µí•© ê·œì¹™ì˜ ê²°ê³¼ì¸ì§€ í™•ì¸
                    const mergedFromThicknesses = Object.keys(thicknessMapping)
                        .map(from => parseFloat(from))
                        .filter(from => thicknessMapping[from] === plate.thickness_mm);
                    
                    // ì›ë³¸ ë‘ê»˜ ëª©ë¡ì—ì„œ í†µí•© ê·œì¹™ì´ ì ìš©ëœ ê²ƒ ì°¾ê¸°
                    if (plate.originalThicknesses && plate.originalThicknesses.length > 0) {
                        // originalThicknessesì—ì„œ í˜„ì¬ thickness_mmì™€ ë‹¤ë¥¸ ê²ƒë“¤ ì¤‘, í†µí•© ê·œì¹™ì— í•´ë‹¹í•˜ëŠ” ê²ƒ ì°¾ê¸°
                        const appliedMerges = plate.originalThicknesses
                            .filter(t => t !== plate.thickness_mm && mergedFromThicknesses.includes(t));
                        
                        if (appliedMerges.length > 0) {
                            // ì›ë³¸ ë¬¼ëŸ‰ê³¼ í†µí•© í›„ ë¬¼ëŸ‰ ë¹„êµ
                            const originalWeight = plate.originalTotalWeight || plate.totalWeight;
                            const mergedWeight = plate.totalWeight;
                            const weightDiff = Math.abs(mergedWeight - originalWeight);
                            const isWeightMatch = weightDiff < 0.01; // 0.01kg ì´í•˜ ì°¨ì´ëŠ” ì¼ì¹˜ë¡œ ê°„ì£¼
                            
                            if (isWeightMatch) {
                                mergeNote = appliedMerges.map(t => `${t}mm â†’ ${plate.thickness_mm}mm`).join(', ');
                            } else {
                                // ë¬¼ëŸ‰ ë¶ˆì¼ì¹˜ ì‹œ ì›ë³¸ ë¬¼ëŸ‰ í‘œì‹œ
                                mergeNote = appliedMerges.map(t => `${t}mm â†’ ${plate.thickness_mm}mm`).join(', ') + 
                                    ` (ì›ë³¸: ${parseFloat(originalWeight.toFixed(2)).toLocaleString('ko-KR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}kg)`;
                            }
                        } else if (mergedFromThicknesses.length > 0) {
                            // originalThicknessesì— ì—†ì§€ë§Œ í†µí•© ê·œì¹™ì´ ìˆëŠ” ê²½ìš° (ë‹¤ë¥¸ ë‘ê»˜ê°€ ê°™ì€ ë‘ê»˜ë¡œ í†µí•©ëœ ê²½ìš°)
                            mergeNote = mergedFromThicknesses.map(t => `${t}mm â†’ ${plate.thickness_mm}mm`).join(', ');
                        }
                    } else if (mergedFromThicknesses.length > 0) {
                        // originalThicknessesê°€ ì—†ìœ¼ë©´ í†µí•© ê·œì¹™ë§Œìœ¼ë¡œ í‘œì‹œ
                        mergeNote = mergedFromThicknesses.map(t => `${t}mm â†’ ${plate.thickness_mm}mm`).join(', ');
                    }
                }
                
                // ë¹„ê³  ì»¬ëŸ¼ì— í†µí•© ì •ë³´ì™€ í›„íŒì£¼ë¬¸ ì •ë³´ ëª¨ë‘ í‘œì‹œ
                const noteParts = [mergeNote, note].filter(n => n);
                let noteTextHtml = noteParts.join(' | ');
                
                // í›„íŒì£¼ë¬¸ì„ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ í‘œì‹œ
                if (note === 'í›„íŒì£¼ë¬¸') {
                    noteTextHtml = noteParts.map(part => {
                        if (part === 'í›„íŒì£¼ë¬¸') {
                            return `<span style="color: #e53e3e; font-weight: 600;">${part}</span>`;
                        }
                        return part;
                    }).join(' | ');
                }
                
                const noteTextColor = noteTextHtml ? (note === 'í›„íŒì£¼ë¬¸' ? '#4a5568' : '#4a5568') : '#666';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${rowNo++}</td>
                    <td>${plate.thickness_mm}mm</td>
                    <td>${plate.usageParts}</td>
                    <td class="text-right">${plate.avgWidth.toFixed(2)}</td>
                    <td class="text-right">${plate.thickness_mm}</td>
                    <td class="text-right">${plate.unitWeight.toFixed(2)}</td>
                    <td class="text-right">${plate.totalLength.toFixed(2)}</td>
                    <td>${plate.totalCount}</td>
                    <td class="text-right">${parseFloat(plate.totalWeight.toFixed(2)).toLocaleString('ko-KR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td>${plate.steelGrade}</td>
                    <td class="text-left" style="color: ${noteTextColor}; font-weight: ${mergeNote ? '600' : 'normal'}; font-size: ${mergeNote ? '12px' : '11px'}; line-height: 1.5;">${noteTextHtml || '-'}</td>
                `;
                plateTbody.appendChild(row);
            });

            // Plate í•©ê³„ì— ëŒ€í•œ ë…¸íŠ¸ (ì „ì²´ í•©ê³„ê°€ 25í†¤ ë¯¸ë§Œì¸ ê²½ìš°)
            // Built-UP í•­ëª©ë§Œì˜ ì´ì¤‘ëŸ‰ ê³„ì‚° (ì¡°í•©3 ì œì™¸)
            const builtUpTotalWeight = builtUpItemsOnly.reduce((sum, item) => {
                return sum + (item.unitWeight * item.length * item.count);
            }, 0);
            
            // Built-UP í•­ëª©ë§Œì˜ ì´ì¤‘ëŸ‰ì„ Plate ì´ì¤‘ëŸ‰ìœ¼ë¡œ ì‚¬ìš© (ì¡°í•©3 ì œì™¸)
            const plateTotalWeightForDisplay = builtUpTotalWeight;
            const totalWeightInTon = plateTotalWeightForDisplay / 1000;
            const totalNote = totalWeightInTon < 25 ? 'í›„íŒì£¼ë¬¸' : '';

            // Plate í•©ê³„ í‘œì‹œ (Built-UP í•­ëª©ë§Œì˜ ì´ì¤‘ëŸ‰)
            document.getElementById('plateTotalCountFooter').textContent = plateTotalCount;
            document.getElementById('plateTotalWeightFooter').textContent = parseFloat(plateTotalWeightForDisplay.toFixed(2)).toLocaleString('ko-KR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('plateTotalNoteFooter').textContent = totalNote;
            if (totalNote) {
                document.getElementById('plateTotalNoteFooter').style.color = '#e53e3e';
                document.getElementById('plateTotalNoteFooter').style.fontWeight = '600';
            }

            // ì†Œë¶€ì¬ ë¬¼ëŸ‰ ì •ë¦¬ ìƒì„± (ì¡°í•©3 ì œì™¸ëœ Built-UP í•­ëª©ë§Œ)
            generateSubMaterialBOQ(builtUpItemsOnly);
            
            // ê¸°ë‘¥ TYPEë³„ ê¸¸ì´ í…Œì´ë¸” ìƒì„±
            console.log('loadBOQData - boqData.typeLengths:', boqData.typeLengths);
            console.log('loadBOQData - boqData.columnLengthData:', boqData.columnLengthData);
        }

        // Rolled H ë¬¼ëŸ‰ ê¸°ì¤€ ê·¸ë£¹í•‘ í•¨ìˆ˜
        function groupRolledHItemsByQuantity(groups) {
            if (!groups || groups.length === 0) return groups;

            // ë¬¼ëŸ‰ ìˆœìœ¼ë¡œ ì •ë ¬ (í° ê²ƒë¶€í„°)
            groups.sort((a, b) => (b.totalWeight || 0) - (a.totalWeight || 0));

            // ì „ì²´ ë¬¼ëŸ‰ í•©ê³„ ê³„ì‚°
            const totalQuantity = groups.reduce((sum, group) => sum + (group.totalWeight || 0), 0);

            // ë¬¼ëŸ‰ì´ ì ì€ í•­ëª© ê¸°ì¤€ ì„¤ì • (ì „ì²´ì˜ 5% ì´í•˜)
            const smallQuantityThreshold = totalQuantity * 0.05;

            // í° ë¬¼ëŸ‰ í•­ëª©ê³¼ ì‘ì€ ë¬¼ëŸ‰ í•­ëª© ë¶„ë¦¬
            const largeQuantityItems = [];
            const smallQuantityItems = [];

            groups.forEach(group => {
                if (group.totalWeight >= smallQuantityThreshold) {
                    largeQuantityItems.push(group);
                } else {
                    smallQuantityItems.push(group);
                }
            });

            // ì‘ì€ ë¬¼ëŸ‰ í•­ëª©ë“¤ì„ ìœ ì‚¬í•œ ë‹¨ë©´(ì¡°í•©, ê¸¸ì´)ë¼ë¦¬ ê·¸ë£¹í•‘
            const groupedSmallItems = [];
            const tolerance = 0.15; // 15% ì˜¤ì°¨ í—ˆìš©

            smallQuantityItems.forEach(group => {
                if (!group.combination || !group.length) {
                    largeQuantityItems.push(group);
                    return;
                }

                // ê¸°ì¡´ ê·¸ë£¹ì—ì„œ ìœ ì‚¬í•œ ë‹¨ë©´ ì°¾ê¸°
                let foundGroup = false;
                for (let g of groupedSmallItems) {
                    const gGroup = g.items[0];
                    if (!gGroup.combination || !gGroup.length) continue;

                    // ì¡°í•©ì´ ê°™ê³  ê¸¸ì´ê°€ Â±15% ì´ë‚´ì¸ì§€ í™•ì¸
                    const sameCombination = group.combination === gGroup.combination;
                    const lengthDiff = Math.abs(group.length - gGroup.length) / gGroup.length;

                    if (sameCombination && lengthDiff <= tolerance) {
                        // ìœ ì‚¬í•œ ë‹¨ë©´ ê·¸ë£¹ì— ì¶”ê°€
                        g.items.push(group);
                        g.totalWeight += group.totalWeight || 0;
                        g.totalCount += group.count || 0;
                        g.names = [...new Set([...g.names, ...group.names])];
                        foundGroup = true;
                        break;
                    }
                }

                if (!foundGroup) {
                    // ìƒˆë¡œìš´ ê·¸ë£¹ ìƒì„±
                    groupedSmallItems.push({
                        items: [group],
                        totalWeight: group.totalWeight || 0,
                        totalCount: group.count || 0,
                        names: [...group.names],
                        representative: group
                    });
                }
            });

            // ê·¸ë£¹í•‘ëœ ì‘ì€ ë¬¼ëŸ‰ í•­ëª©ë“¤ì„ í•˜ë‚˜ì˜ ì•„ì´í…œìœ¼ë¡œ ë³€í™˜
            const groupedItems = groupedSmallItems.map(g => {
                const rep = g.representative;
                const avgLength = g.totalCount > 0 ? rep.length : rep.length; // í‰ê·  ê¸¸ì´ ê³„ì‚° í•„ìš”ì‹œ ìˆ˜ì •
                
                return {
                    ...rep,
                    names: g.names.length > 1 ? 
                        [`${g.names[0]} ì™¸ ${g.names.length - 1}ê°œ`] : 
                        g.names,
                    totalWeight: g.totalWeight,
                    count: g.totalCount,
                    length: rep.length,
                    isGrouped: true,
                    originalNames: g.names,
                    originalCount: g.items.length
                };
            });

            // í° ë¬¼ëŸ‰ í•­ëª© + ê·¸ë£¹í•‘ëœ ì‘ì€ ë¬¼ëŸ‰ í•­ëª© (ê·¸ë£¹í•‘ëœ í•­ëª©ë„ ë¬¼ëŸ‰ìˆœ ì •ë ¬)
            groupedItems.sort((a, b) => (b.totalWeight || 0) - (a.totalWeight || 0));

            return [...largeQuantityItems, ...groupedItems];
        }

        // Rolled H ë¬¼ëŸ‰ ì •ë¦¬ ìƒì„± (ì¡°í•©3)
        function generateRolledHBOQ(items) {
            // Rolled H ì„¹ì…˜ í‘œì‹œ
            document.getElementById('rolledHSection').style.display = 'block';
            
            const tbody = document.getElementById('rolledHTableBody');
            tbody.innerHTML = '';
            
            let totalCount = 0;
            let totalWeight = 0;
            let rowNo = 1;
            
            // ì¡°í•©ë³„ë¡œ ê·¸ë£¹í™”í•˜ì—¬ í•©ì‚°
            const groupedData = {}; // { "H400Ã—B200-26.478": {...} }
            
            items.forEach(item => {
                const key = `${item.combination}-${item.length.toFixed(2)}`;
                if (!groupedData[key]) {
                    groupedData[key] = {
                        combination: item.combination,
                        length: item.length,
                        count: 0,
                        unitWeight: item.unitWeight,
                        totalWeight: 0,
                        names: [],
                        steelGrade: item.steelGrade
                    };
                }
                groupedData[key].count += item.count;
                groupedData[key].totalWeight += item.unitWeight * item.length * item.count;
                groupedData[key].names.push(...item.names);
            });
            
            // ë¬¼ëŸ‰ ê¸°ì¤€ ê·¸ë£¹í•‘ ì ìš© ì—¬ë¶€ í™•ì¸
            const applyRolledHGrouping = document.getElementById('rolledHGroupingCheckbox')?.checked || false;
            let groupsToDisplay = Object.values(groupedData);

            // ê·¸ë£¹í•‘ì´ í™œì„±í™”ëœ ê²½ìš°
            if (applyRolledHGrouping) {
                groupsToDisplay = groupRolledHItemsByQuantity(Object.values(groupedData));
            }

            // ê·¸ë£¹í™”ëœ ë°ì´í„°ë¥¼ í…Œì´ë¸”ì— í‘œì‹œ
            groupsToDisplay.forEach(group => {
                totalCount += group.count;
                totalWeight += group.totalWeight;
                
                const row = document.createElement('tr');
                // ê·¸ë£¹í•‘ëœ í•­ëª©ì¸ ê²½ìš° ê¸°ë‘¥ëª… í‘œì‹œ
                let displayNames = [...new Set(group.names)].join(', ');
                if (group.isGrouped && group.originalCount > 1) {
                    displayNames = group.names[0] || displayNames;
                }
                
                row.innerHTML = `
                    <td>${rowNo++}</td>
                    <td class="text-left">${displayNames}</td>
                    <td>${group.combination}</td>
                    <td class="text-right">${group.length.toFixed(2)}</td>
                    <td>${group.count}</td>
                    <td class="text-right">${group.unitWeight.toFixed(2)}</td>
                    <td class="text-right">${parseFloat(group.totalWeight.toFixed(2)).toLocaleString('ko-KR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td>${group.steelGrade}</td>
                    <td>-</td>
                `;
                tbody.appendChild(row);
            });
            
            // í•©ê³„ í‘œì‹œ
            document.getElementById('rolledHTotalCountFooter').textContent = totalCount;
            document.getElementById('rolledHTotalWeightFooter').textContent = parseFloat(totalWeight.toFixed(2)).toLocaleString('ko-KR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('rolledHTotalNoteFooter').textContent = '-';
        }

        // ì†Œë¶€ì¬ ë¬¼ëŸ‰ ì •ë¦¬ ìƒì„±
        function generateSubMaterialBOQ(items) {
            const subMaterialData = [];
            const surchargeRate = 0.15; // í• ì¦ë¥  15%

            // ì „ì²´ ì² ê³¨ ë¬¼ëŸ‰ ê³„ì‚° (ê¸°ë‘¥ + Plate)
            // ê¸°ë‘¥ ë¬¼ëŸ‰: 1ë²ˆ ê¸°ë‘¥ ë¬¼ëŸ‰ ì •ë¦¬ í…Œì´ë¸”ì˜ í•©ê³„ ì‚¬ìš© (ì¡°í•©3 í¬í•¨ ì „ì²´)
            const columnTotalWeightText = document.getElementById('totalWeightFooter').textContent || '0';
            const columnTotalWeight = parseFloat(columnTotalWeightText.replace(/[^0-9.]/g, '')) || 0;
            
            // Plate ë¬¼ëŸ‰: Plate ë¬¼ëŸ‰ ì •ë¦¬ í…Œì´ë¸”ì˜ í•©ê³„ ì‚¬ìš© (ëª¨ë“  ë¹„ìˆ«ì ë¬¸ì ì œê±° í›„ íŒŒì‹±)
            const plateTotalWeightText = document.getElementById('plateTotalWeightFooter').textContent || '0';
            const plateTotalWeight = parseFloat(plateTotalWeightText.replace(/[^0-9.]/g, '')) || 0;
            
            // ì „ì²´ ì² ê³¨ë¬¼ëŸ‰ = ê¸°ë‘¥ ë¬¼ëŸ‰ + Plate ë¬¼ëŸ‰
            const totalSteelWeight = columnTotalWeight + plateTotalWeight;

            // ì†Œë¶€ì¬ ì¢…ë¥˜ë³„ë¡œ ì •ë¦¬
            // 1. 3 PLATE (ì ‘í•©ë¶€) - ì „ì²´ ì² ê³¨ë¬¼ëŸ‰ì˜ 15%
            const plate3Weight = totalSteelWeight * 0.15; // ì „ì²´ ì² ê³¨ë¬¼ëŸ‰ì˜ 15%
            const plate3Surcharge = columnTotalWeight * surchargeRate; // í• ì¦ 15% (ì£¼ê¸°ë‘¥ ì´ì¤‘ëŸ‰ ê¸°ì¤€)
            
            // ì €ì¥ëœ ì†Œë¶€ì¬ ë‹¨ê°€ ë¶ˆëŸ¬ì˜¤ê¸° (ê¸°ë³¸ê°’: 1,900,000ì›/í†¤)
            const savedPrices = JSON.parse(localStorage.getItem('boqUnitPrices')) || {};
            const plate3UnitPrice = savedPrices.subMaterial || 1900000; // í†¤ë‹¹ ë‹¨ê°€
            console.log('ì†Œë¶€ì¬ ë‹¨ê°€:', plate3UnitPrice, 'ì €ì¥ëœ ê°’:', savedPrices);
            
            // ì†Œë¶€ì¬ ê¸ˆì•¡ ê³„ì‚°: í• ì¦ Ã— ë‹¨ê°€
            const plate3SurchargeInTon = plate3Surcharge / 1000; // í• ì¦ì„ í†¤ ë‹¨ìœ„ë¡œ ë³€í™˜
            const plate3Amount = plate3SurchargeInTon * plate3UnitPrice; // í• ì¦ Ã— ë‹¨ê°€

            if (plate3Weight > 0) {
                // SM355/SM420 ê°•ì¢… í‘œì‹œ
                const plate3SteelGrade = 'SM355/SM420';
                
                subMaterialData.push({
                    type: '3 PLATE',
                    spec: 'ì ‘í•©ë¶€',
                    unit: 'Ton',
                    quantity: '', // ìˆ˜ëŸ‰ ë¹ˆ ë¬¸ìì—´
                    steelGrade: plate3SteelGrade,
                    totalSteelWeight: columnTotalWeight.toFixed(2), // ì£¼ê¸°ë‘¥ì˜ ì´ì¤‘ëŸ‰ê³¼ ë™ì¼
                    surcharge: plate3Surcharge.toFixed(2),
                    amount: plate3Amount, // ì´ì¤‘ëŸ‰ Ã— ë‹¨ê°€
                    remark: 'ì „ì²´ ì² ê³¨ë¬¼ëŸ‰ì˜ 15%'
                });
            }

            // 2. ì‚¬ìš©ìê°€ ì¶”ê°€í•œ ì†Œë¶€ì¬ í•­ëª© (í˜ì´ì§€ ë¡œë“œ ì‹œ ë³µì›ëœ ë°ì´í„° ì‚¬ìš©)
            if (typeof subMaterialItems !== 'undefined' && subMaterialItems.length > 0) {
                subMaterialItems.forEach(item => {
                    // ì‚¬ìš©ìê°€ ì¶”ê°€í•œ ì†Œë¶€ì¬ í•­ëª©ì˜ ê¸ˆì•¡ ê³„ì‚°: í• ì¦ Ã— ë‹¨ê°€
                    const itemSurcharge = parseFloat(item.surcharge) || 0;
                    const itemSurchargeInTon = itemSurcharge / 1000;
                    
                    // ê¸ˆì•¡ = í• ì¦ Ã— ë‹¨ê°€
                    const itemTotalAmount = itemSurchargeInTon * plate3UnitPrice;
                    
                    subMaterialData.push({
                        type: item.type,
                        spec: item.spec,
                        unit: item.unit,
                        quantity: item.quantity || 0,
                        steelGrade: item.steelGrade || 'SM420',
                        totalSteelWeight: columnTotalWeight.toFixed(2), // ì£¼ê¸°ë‘¥ ì´ì¤‘ëŸ‰ê³¼ ë™ì¼
                        surcharge: itemSurcharge.toFixed(2),
                        amount: itemTotalAmount, // í• ì¦ Ã— ë‹¨ê°€
                        remark: item.remark || ''
                    });
                });
            }

            // ì†Œë¶€ì¬ í…Œì´ë¸” ë Œë”ë§
            const subMaterialTbody = document.getElementById('subMaterialTableBody');
            subMaterialTbody.innerHTML = '';

            if (subMaterialData.length === 0) {
                subMaterialTbody.innerHTML = 
                    '<tr><td colspan="11" style="text-align: center; padding: 30px; color: #999;">ì†Œë¶€ì¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                document.getElementById('subMaterialTotalQtyFooter').textContent = '0';
                document.getElementById('subMaterialTotalWeightFooter').textContent = '0';
                document.getElementById('subMaterialTotalSurchargeFooter').textContent = '0';
                document.getElementById('subMaterialTotalUnitPriceFooter').textContent = '0';
                document.getElementById('subMaterialTotalAmountFooter').textContent = '0';
                return;
            }

            let subMaterialTotalQty = 0;
            let subMaterialTotalWeight = 0;
            let subMaterialTotalSurcharge = 0;
            let subMaterialTotalSubMaterialWeight = 0;
            let subMaterialTotalAmount = 0;

            subMaterialData.forEach((item, index) => {
                const qty = parseFloat(item.quantity) || 0;
                // ì£¼ê¸°ë‘¥ë¶€ì¬ë¬¼ëŸ‰ì€ ì£¼ê¸°ë‘¥ ì´ì¤‘ëŸ‰ê³¼ ë™ì¼í•˜ê²Œ í‘œì‹œ
                const weight = columnTotalWeight; // ì£¼ê¸°ë‘¥ ì´ì¤‘ëŸ‰ ì‚¬ìš©
                const surcharge = parseFloat(item.surcharge) || 0;
                const amount = parseFloat(item.amount) || 0;

                subMaterialTotalQty += qty;
                // ì£¼ê¸°ë‘¥ë¶€ì¬ë¬¼ëŸ‰ í•©ê³„ëŠ” ê° í–‰ë§ˆë‹¤ ì£¼ê¸°ë‘¥ ì´ì¤‘ëŸ‰ì„ ë”í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, ë§ˆì§€ë§‰ì— ì£¼ê¸°ë‘¥ ì´ì¤‘ëŸ‰ìœ¼ë¡œ ì„¤ì •
                subMaterialTotalSurcharge += surcharge;
                subMaterialTotalAmount += amount;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td class="text-left">${item.type}</td>
                    <td class="text-left">${item.spec}</td>
                    <td>${item.unit}</td>
                    <td class="text-right">${item.quantity === '' || item.quantity === null || item.quantity === undefined ? '' : (qty > 0 ? qty.toFixed(2) : '')}</td>
                    <td>${item.steelGrade}</td>
                    <td class="text-right">${parseFloat(weight.toFixed(2)).toLocaleString('ko-KR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td class="text-right">${parseFloat(surcharge.toFixed(2)).toLocaleString('ko-KR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td class="text-right">${plate3UnitPrice.toLocaleString()}</td>
                    <td class="text-right">${amount > 0 ? Math.round(amount).toLocaleString('ko-KR') : '-'}</td>
                    <td class="text-left" style="font-size: 11px; color: #666;">${item.remark || ''}</td>
                `;
                subMaterialTbody.appendChild(row);
            });

            // ì†Œë¶€ì¬ í•©ê³„ í‘œì‹œ
            document.getElementById('subMaterialTotalQtyFooter').textContent = subMaterialTotalQty.toFixed(2);
            // ì´ ì¤‘ëŸ‰ = ì£¼ê¸°ë‘¥ì˜ ì´ì¤‘ëŸ‰ (ê¸°ë‘¥ ë¬¼ëŸ‰ë§Œ)
            document.getElementById('subMaterialTotalWeightFooter').textContent = columnTotalWeight > 0 ? parseFloat(columnTotalWeight.toFixed(2)).toLocaleString('ko-KR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0';
            document.getElementById('subMaterialTotalSurchargeFooter').textContent = subMaterialTotalSurcharge > 0 ? parseFloat(subMaterialTotalSurcharge.toFixed(2)).toLocaleString('ko-KR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0';
            // ì†Œë¶€ì¬ ë‹¨ê°€ í‘œì‹œ
            document.getElementById('subMaterialTotalUnitPriceFooter').textContent = plate3UnitPrice.toLocaleString();
            document.getElementById('subMaterialTotalAmountFooter').textContent = subMaterialTotalAmount > 0 ? Math.round(subMaterialTotalAmount).toLocaleString('ko-KR') + 'ì›' : '-';
            
            // ì´ ê¸ˆì•¡ ì—…ë°ì´íŠ¸
            updateTotalAmount();
        }

        // Auto Find Selection Table ìƒì„±
        function generateAutoFindTable(autoFindResults) {
            const tbody = document.getElementById('autoFindTableBody');
            tbody.innerHTML = '';
            
            console.log('generateAutoFindTable í˜¸ì¶œë¨, autoFindResults:', autoFindResults);
            
            if (!autoFindResults || autoFindResults.length === 0) {
                console.log('autoFindResultsê°€ ë¹„ì–´ìˆìŒ');
                tbody.innerHTML = '<tr><td colspan="16" style="text-align: center; padding: 30px; color: #999;">Auto Find Selection ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }
            
            let rowNo = 1;
            autoFindResults.forEach((result) => {
                // ê²½ê³  ë©”ì‹œì§€ê°€ ìˆëŠ” ê²½ìš° ê±´ë„ˆë›°ê¸°
                if (result.warning) {
                    console.log('ê²½ê³  ë©”ì‹œì§€ê°€ ìˆëŠ” í•­ëª© ê±´ë„ˆë›°ê¸°:', result.name || result.no);
                    return;
                }
                
                console.log('í–‰ ì¶”ê°€:', rowNo, result.name || result.no, result);
                
                const currentRowNo = rowNo++;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${currentRowNo}</td>
                    <td class="text-left" style="font-weight: 600; color: #667eea;">${result.name || `KC${result.no}`}</td>
                    <td class="text-right">${result.pu !== undefined && result.pu !== null ? result.pu.toFixed(2) : '-'}</td>
                    <td class="text-right">${result.mux !== undefined && result.mux !== null ? result.mux.toFixed(2) : '-'}</td>
                    <td class="text-right">${result.muy !== undefined && result.muy !== null ? result.muy.toFixed(2) : '-'}</td>
                    <td class="text-right" style="${result.pmm > 1.0 ? 'color: #e53e3e; font-weight: 600;' : 'color: #38a169;'}">${result.pmm !== undefined && result.pmm !== null && result.pmm > 0 ? result.pmm.toFixed(2) : '-'}</td>
                    <td>${result.steelGrade || '-'}</td>
                    <td style="font-weight: 600; color: #667eea;">${result.combination || '-'}</td>
                    <td>${result.h || '-'}</td>
                    <td>${result.b || '-'}</td>
                    <td>${result.tw || '-'}</td>
                    <td>${result.tf || '-'}</td>
                    <td class="text-right">${result.area !== undefined && result.area !== null ? result.area.toFixed(2) : '-'}</td>
                    <td class="text-right">${result.unitWeight !== undefined && result.unitWeight !== null ? result.unitWeight.toFixed(2) : '-'}</td>
                    <td class="text-right" style="color: #667eea; font-weight: 600;">${result.unitPrice !== undefined && result.unitPrice !== null ? result.unitPrice.toLocaleString('ko-KR') : '-'}</td>
                    <td class="text-right" style="color: #38a169; font-weight: 600;">${result.costPerMeter !== undefined && result.costPerMeter !== null ? result.costPerMeter.toFixed(2) : '-'}</td>
                `;
                tbody.appendChild(row);
            });
            
            console.log('generateAutoFindTable ì™„ë£Œ, ì¶”ê°€ëœ í–‰ ìˆ˜:', rowNo - 1);
        }


        // CSV ë‹¤ìš´ë¡œë“œ
        function exportToCSV() {
            const boqData = JSON.parse(localStorage.getItem('boqData')) || null;
            
            if (!boqData || !boqData.items || boqData.items.length === 0) {
                alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            let csv = 'No.,ê¸°ë‘¥ëª…,ì¡°í•©,H(mm),B(mm),tw(mm),tf(mm),ë‹¨ë©´ì (mmÂ²),ë‹¨ì¤‘(kg/m),ê¸¸ì´(m),ê¸¸ì´íƒ€ì…,ê°œìˆ˜,ì´ ì¤‘ëŸ‰(kg),ê°•ì¢…\n';

            boqData.items.forEach((item, index) => {
                const totalWeightItem = item.unitWeight * item.length * item.count;
                csv += `${index + 1},"${item.names.join(', ')}",${item.combination},${item.h},${item.b},${item.tw},${item.tf},${item.area.toFixed(2)},${item.unitWeight.toFixed(2)},${item.length.toFixed(2)},Type${item.lengthType || ''},${item.count},${totalWeightItem.toFixed(2)},${item.steelGrade}\n`;
            });

            // ì´ê³„ ì¶”ê°€
            let totalCount = 0;
            let totalWeight = 0;
            boqData.items.forEach(item => {
                totalCount += item.count;
                totalWeight += item.unitWeight * item.length * item.count;
            });
            csv += `í•©ê³„,,,,,,,,,,,,${totalCount},${totalWeight.toFixed(2)},\n`;

            // BOM ì¶”ê°€ (í•œê¸€ ê¹¨ì§ ë°©ì§€)
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `BOQ_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¡œë“œ
        // ë‘ê»˜ í†µí•© ê·œì¹™ ì €ì¥ (localStorage)
        let thicknessMergeRules = JSON.parse(localStorage.getItem('thicknessMergeRules')) || {};

        // ë‘ê»˜ í†µí•© ëª¨ë‹¬ í‘œì‹œ
        function showThicknessMergeModal() {
            const modal = document.getElementById('thicknessMergeModal');
            if (!modal) return;

            // í˜„ì¬ ë‘ê»˜ë³„ ë¬¼ëŸ‰ í‘œì‹œ
            updateCurrentThicknessList();
            
            // í†µí•© ê·œì¹™ ëª©ë¡ í‘œì‹œ
            updateMergeRulesList();

            modal.style.display = 'flex';
        }

        // ë‘ê»˜ í†µí•© ëª¨ë‹¬ ë‹«ê¸°
        function closeThicknessMergeModal() {
            const modal = document.getElementById('thicknessMergeModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // í˜„ì¬ ë‘ê»˜ë³„ ë¬¼ëŸ‰ ëª©ë¡ ì—…ë°ì´íŠ¸
        function updateCurrentThicknessList() {
            const boqData = JSON.parse(localStorage.getItem('boqData')) || null;
            if (!boqData || !boqData.items) {
                document.getElementById('currentThicknessList').innerHTML = '<p style="color: #999;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            // Built-UP í•­ëª©ë§Œ í•„í„°ë§
            const comb3Names = ['H400Ã—B200', 'H450Ã—B200', 'H500Ã—B200', 'H506Ã—B201', 'H482Ã—B300', 'H488Ã—B300', 'H582Ã—B300', 'H588Ã—B300', 'H600Ã—B200'];
            const builtUpItems = boqData.items.filter(item => {
                return !comb3Names.some(name => item.combination === name);
            });

            // Plate ë‹¨ìœ„ë¡œ ë¬¼ëŸ‰ ê³„ì‚° (generatePlateBOQì™€ ë™ì¼í•œ ë°©ì‹)
            const steelDensity = 7850; // kg/mÂ³
            const plateData = {}; // { "tw8-H1-Web": {...}, "tf13-H1-Flange": {...} }
            
            // generatePlateBOQì™€ ë™ì¼í•˜ê²Œ plateData ìƒì„±
            builtUpItems.forEach(item => {
                const H1 = item.H1 || item.h;
                const H2 = item.H2 || item.h;
                const B1 = item.B1 || item.b;
                const B2 = item.B2 || item.b;
                const tw = item.tw;
                const tf = item.tf;
                
                // H1 Web Plate (tw)
                const h1WebKey = `tw${tw}-H1-Web`;
                if (!plateData[h1WebKey]) {
                    const webWidth = H1 - 2 * tf;
                    plateData[h1WebKey] = {
                        thickness: tw,
                        thickness_mm: tw,
                        width: webWidth,
                        totalLength: 0,
                        totalCount: 0,
                        totalWeight: 0
                    };
                }
                plateData[h1WebKey].totalLength += item.length * item.count;
                plateData[h1WebKey].totalCount += item.count;
                
                // H1 Flange Plate (tf) - ìƒí•˜ 2ê°œ
                const h1FlangeKey = `tf${tf}-H1-Flange`;
                if (!plateData[h1FlangeKey]) {
                    plateData[h1FlangeKey] = {
                        thickness: tf,
                        thickness_mm: tf,
                        width: B1,
                        totalLength: 0,
                        totalCount: 0,
                        totalWeight: 0
                    };
                }
                plateData[h1FlangeKey].totalLength += item.length * item.count * 2;
                plateData[h1FlangeKey].totalCount += item.count * 2;
                
                // H2 Web Plate (tw)
                const h2WebKey = `tw${tw}-H2-Web`;
                if (!plateData[h2WebKey]) {
                    const webWidth = H2 - 2 * tf;
                    plateData[h2WebKey] = {
                        thickness: tw,
                        thickness_mm: tw,
                        width: webWidth,
                        totalLength: 0,
                        totalCount: 0,
                        totalWeight: 0
                    };
                }
                plateData[h2WebKey].totalLength += item.length * item.count;
                plateData[h2WebKey].totalCount += item.count;
                
                // H2 Flange Plate (tf) - ì¢Œìš° 2ê°œ
                const h2FlangeKey = `tf${tf}-H2-Flange`;
                if (!plateData[h2FlangeKey]) {
                    plateData[h2FlangeKey] = {
                        thickness: tf,
                        thickness_mm: tf,
                        width: B2,
                        totalLength: 0,
                        totalCount: 0,
                        totalWeight: 0
                    };
                }
                plateData[h2FlangeKey].totalLength += item.length * item.count * 2;
                plateData[h2FlangeKey].totalCount += item.count * 2;
            });
            
            // ë‹¨ì¤‘ ê³„ì‚° ë° ì´ ì¤‘ëŸ‰ ê³„ì‚° (generatePlateBOQì™€ ë™ì¼)
            Object.keys(plateData).forEach(key => {
                const plate = plateData[key];
                plate.unitWeight = (plate.width * plate.thickness_mm * steelDensity) / 1000000;
                plate.totalWeight = plate.unitWeight * plate.totalLength;
            });
            
            // ë‘ê»˜ë³„ë¡œ ê·¸ë£¹í™”í•˜ì—¬ í•©ì‚° (generatePlateBOQì™€ ë™ì¼)
            const thicknessData = {};
            Object.keys(plateData).forEach(key => {
                const plate = plateData[key];
                const thickness = plate.thickness_mm;
                
                if (!thicknessData[thickness]) {
                    thicknessData[thickness] = { weight: 0, count: 0 };
                }
                thicknessData[thickness].weight += plate.totalWeight;
                thicknessData[thickness].count += plate.totalCount;
            });

            // í†µí•© ê·œì¹™ í™•ì¸ (From ë‘ê»˜ì— ì·¨ì†Œì„  í‘œì‹œ)
            const thicknessMergeRules = JSON.parse(localStorage.getItem('thicknessMergeRules')) || {};
            const mergedFromThicknesses = Object.keys(thicknessMergeRules).map(from => parseFloat(from));
            
            // ë‘ê»˜ë³„ë¡œ ì •ë ¬í•˜ì—¬ í‘œì‹œ (ë¬¼ëŸ‰ ì œì™¸)
            const sortedThickness = Object.keys(thicknessData).sort((a, b) => parseFloat(a) - parseFloat(b));
            let html = '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 13px;">';
            sortedThickness.forEach(thickness => {
                const thicknessValue = parseFloat(thickness);
                const isMerged = mergedFromThicknesses.includes(thicknessValue);
                const textDecoration = isMerged ? 'text-decoration: line-through;' : '';
                const textColor = isMerged ? '#999' : '#667eea';
                
                html += `
                    <div style="padding: 10px; background: white; border-radius: 6px; border: 1px solid #e2e8f0;">
                        <div style="font-weight: 600; color: ${textColor}; ${textDecoration}">${thickness}mm</div>
                    </div>
                `;
            });
            html += '</div>';
            document.getElementById('currentThicknessList').innerHTML = html || '<p style="color: #999;">ë‘ê»˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        }

        // í†µí•© ê·œì¹™ ëª©ë¡ ì—…ë°ì´íŠ¸
        function updateMergeRulesList() {
            const rulesList = document.getElementById('mergeRulesList');
            const rules = thicknessMergeRules;

            if (Object.keys(rules).length === 0) {
                rulesList.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">í†µí•© ê·œì¹™ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            let html = '<div style="display: flex; flex-direction: column; gap: 8px;">';
            Object.keys(rules).forEach(from => {
                const to = rules[from];
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f7fafc; border-radius: 6px;">
                        <span style="font-weight: 600; color: #4a5568;">${from}mm â†’ ${to}mm</span>
                        <button onclick="removeThicknessMergeRule(${from})" style="padding: 4px 12px; background: #e53e3e; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">ì‚­ì œ</button>
                    </div>
                `;
            });
            html += '</div>';
            rulesList.innerHTML = html;
        }

        // í†µí•© ê·œì¹™ ì¶”ê°€
        function addThicknessMergeRule() {
            const from = parseInt(document.getElementById('mergeFromThickness').value);
            const to = parseInt(document.getElementById('mergeToThickness').value);

            if (!from || !to) {
                alert('Fromê³¼ To ê°’ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (from === to) {
                alert('Fromê³¼ To ê°’ì´ ê°™ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            thicknessMergeRules[from] = to;
            localStorage.setItem('thicknessMergeRules', JSON.stringify(thicknessMergeRules));
            
            document.getElementById('mergeFromThickness').value = '';
            document.getElementById('mergeToThickness').value = '';
            
            updateMergeRulesList();
        }

        // í†µí•© ê·œì¹™ ì‚­ì œ
        function removeThicknessMergeRule(from) {
            delete thicknessMergeRules[from];
            localStorage.setItem('thicknessMergeRules', JSON.stringify(thicknessMergeRules));
            updateMergeRulesList();
        }

        // í†µí•© ê·œì¹™ ì ìš©
        function applyThicknessMerge() {
            localStorage.setItem('thicknessMergeRules', JSON.stringify(thicknessMergeRules));
            closeThicknessMergeModal();
            loadBOQData(); // ë°ì´í„° ë‹¤ì‹œ ë¡œë“œí•˜ì—¬ í†µí•© ê·œì¹™ ì ìš©
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¡œë“œ ë° ì†Œë¶€ì¬ í•­ëª© ë³µì›
        window.addEventListener('load', function() {
            loadBOQData();
            
            // ì €ì¥ëœ ì†Œë¶€ì¬ í•­ëª© ë³µì›
            const boqData = JSON.parse(localStorage.getItem('boqData')) || null;
            if (boqData && boqData.subMaterials) {
                subMaterialItems = boqData.subMaterials;
            }

            // ì €ì¥ëœ ë‘ê»˜ í†µí•© ê·œì¹™ ë³µì›
            thicknessMergeRules = JSON.parse(localStorage.getItem('thicknessMergeRules')) || {};

            // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
            document.addEventListener('click', function(e) {
                const subMaterialModal = document.getElementById('subMaterialModal');
                if (subMaterialModal && e.target === subMaterialModal) {
                    closeSubMaterialModal();
                }
                const thicknessMergeModal = document.getElementById('thicknessMergeModal');
                if (thicknessMergeModal && e.target === thicknessMergeModal) {
                    closeThicknessMergeModal();
                }
            });
        });
    </script>
    <!-- Auth handled by Edge Function, no client-side guard needed -->
    <script src="../../js/auth-config.js"></script>
    <script src="../../js/auth.js"></script>
</body>
</html>
