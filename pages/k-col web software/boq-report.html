<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOQ ì‚°ì¶œì„œ - K-COL</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            padding: 20px;
            color: #1a202c;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }

        .header h1 {
            color: #1e3a5f;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header .subtitle {
            color: #718096;
            font-size: 14px;
        }

        .info-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 8px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-size: 12px;
            color: #718096;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .info-value {
            font-size: 16px;
            color: #1a202c;
            font-weight: 600;
        }

        .boq-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
            font-size: 13px;
        }

        .boq-table thead {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .boq-table th {
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            border: 1px solid #e2e8f0;
        }

        .boq-table td {
            padding: 10px 8px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        .boq-table tbody tr:nth-child(even) {
            background: #f7fafc;
        }

        .boq-table tbody tr:hover {
            background: #edf2f7;
        }

        .text-left {
            text-align: left;
        }

        .text-right {
            text-align: right;
        }

        .total-row {
            background: #e6fffa !important;
            font-weight: 700;
            color: #1e3a5f;
        }

        .total-row td {
            border-top: 2px solid #38a169;
            border-bottom: 2px solid #38a169;
        }

        .actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 30px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-print {
            background: #38a169;
            color: white;
        }

        .btn-print:hover {
            background: #2f855a;
        }

        .btn-export {
            background: #667eea;
            color: white;
        }

        .btn-export:hover {
            background: #5568d3;
        }

        .btn-close {
            background: #718096;
            color: white;
        }

        .btn-close:hover {
            background: #4a5568;
        }

        @media print {
            body {
                padding: 0;
                background: white;
            }

            .container {
                box-shadow: none;
                padding: 20px;
            }

            .actions {
                display: none;
            }

            .boq-table {
                page-break-inside: auto;
            }

            .boq-table tr {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>BOQ (Bill of Quantities)</h1>
            <div class="subtitle">ê³µì‚¬ ìˆ˜ëŸ‰ ì‚°ì¶œì„œ</div>
        </div>

        <div class="info-section">
            <div class="info-item">
                <div class="info-label">ì‘ì„±ì¼</div>
                <div class="info-value" id="reportDate"></div>
            </div>
            <div class="info-item">
                <div class="info-label">ì´ ê¸°ë‘¥ ê°œìˆ˜</div>
                <div class="info-value" id="totalCount">0</div>
            </div>
            <div class="info-item">
                <div class="info-label">ì´ ë‹¨ë©´ì </div>
                <div class="info-value" id="totalArea">0 mmÂ²</div>
            </div>
            <div class="info-item">
                <div class="info-label">ì´ ì¤‘ëŸ‰</div>
                <div class="info-value" id="totalWeight">0 kg</div>
            </div>
            <div class="info-item">
                <div class="info-label">ì´ ê¸ˆì•¡</div>
                <div class="info-value" id="totalAmount" style="color: #667eea; font-size: 18px; font-weight: 700;">0ì›</div>
            </div>
        </div>

        <div style="margin-bottom: 30px;">
            <h2 style="color: #1e3a5f; font-size: 20px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #667eea;">1. ê¸°ë‘¥ ë¬¼ëŸ‰ ì •ë¦¬(Cross H) - Auto Find Selection ê¸°ëŠ¥</h2>
            <table class="boq-table">
                <thead>
                    <tr>
                        <th>No.</th>
                        <th>ê¸°ë‘¥ëª…</th>
                        <th>ì¡°í•©</th>
                        <th>H<br>(mm)</th>
                        <th>B<br>(mm)</th>
                        <th>tw<br>(mm)</th>
                        <th>tf<br>(mm)</th>
                        <th>ë‹¨ë©´ì <br>(mmÂ²)</th>
                        <th>ë‹¨ì¤‘<br>(kg/m)</th>
                        <th>ê¸¸ì´<br>(m)</th>
                        <th>ê¸¸ì´íƒ€ì…</th>
                        <th>ê°œìˆ˜</th>
                        <th>ì´ ì¤‘ëŸ‰<br>(kg)</th>
                        <th>ê°•ì¢…</th>
                        <th>ê¸ˆì•¡<br>(ì›)</th>
                </tr>
            </thead>
            <tbody id="boqTableBody">
                <!-- BOQ ë°ì´í„°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </tbody>
            <tfoot>
                <tr class="total-row">
                    <td colspan="11" class="text-right" style="font-weight: 700;">í•©ê³„</td>
                    <td id="totalCountFooter">0</td>
                    <td id="totalWeightFooter">0</td>
                    <td>-</td>
                    <td id="totalColumnAmountFooter" class="text-right" style="font-weight: 700;">0ì›</td>
                </tr>
            </tfoot>
            </table>
        </div>

        <div style="margin-top: 40px;">
            <h2 style="color: #1e3a5f; font-size: 20px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #667eea;">2. ì£¼ê¸°ë‘¥ Built-UP ë¶€ì¬ ë¬¼ëŸ‰ ì •ë¦¬</h2>
            <table class="boq-table">
                <thead>
                    <tr>
                        <th>No.</th>
                        <th>Plate ì¢…ë¥˜<br>(ë‘ê»˜, mm)</th>
                        <th>ì‚¬ìš©ë¶€ìœ„</th>
                        <th>í­<br>(mm)</th>
                        <th>ë‘ê»˜<br>(mm)</th>
                        <th>ë‹¨ì¤‘<br>(kg/m)</th>
                        <th>ê¸¸ì´<br>(m)</th>
                        <th>ê°œìˆ˜</th>
                        <th>ì´ ì¤‘ëŸ‰<br>(kg)</th>
                        <th>ê°•ì¢…</th>
                        <th>ë¹„ê³ </th>
                    </tr>
                </thead>
                <tbody id="plateTableBody">
                    <!-- Plate ë¬¼ëŸ‰ ë°ì´í„°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td colspan="7" class="text-right" style="font-weight: 700;">í•©ê³„</td>
                        <td id="plateTotalCountFooter">0</td>
                        <td id="plateTotalWeightFooter">0</td>
                        <td>-</td>
                        <td id="plateTotalNoteFooter">-</td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div style="margin-top: 40px;">
            <h2 style="color: #1e3a5f; font-size: 20px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #667eea;">3. ì†Œë¶€ì¬ ë¬¼ëŸ‰ ì •ë¦¬</h2>
            <table class="boq-table">
                <thead>
                    <tr>
                        <th>No.</th>
                        <th>ì†Œë¶€ì¬ ì¢…ë¥˜</th>
                        <th>ê·œê²©/ì‚¬ì–‘</th>
                        <th>ë‹¨ìœ„</th>
                        <th>ìˆ˜ëŸ‰</th>
                        <th>ê°•ì¢…</th>
                        <th>ì£¼ê¸°ë‘¥ë¶€ì¬ë¬¼ëŸ‰<br>(kg)</th>
                        <th>í• ì¦<br>(15%)</th>
                        <th>ì†Œë¶€ì¬ ë‹¨ê°€<br>(ì›/í†¤)</th>
                        <th>ê¸ˆì•¡<br>(ì›)</th>
                        <th>ë¹„ê³ </th>
                    </tr>
                </thead>
                <tbody id="subMaterialTableBody">
                    <!-- ì†Œë¶€ì¬ ë¬¼ëŸ‰ ë°ì´í„°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td colspan="4" class="text-right" style="font-weight: 700;">í•©ê³„</td>
                        <td id="subMaterialTotalQtyFooter">0</td>
                        <td>-</td>
                        <td id="subMaterialTotalWeightFooter">0</td>
                        <td id="subMaterialTotalSurchargeFooter">0</td>
                        <td id="subMaterialTotalUnitPriceFooter">0</td>
                        <td id="subMaterialTotalAmountFooter">0</td>
                        <td>-</td>
                    </tr>
                </tfoot>
            </table>
        </div>


        <div class="actions">
            <button class="btn btn-print" onclick="window.print()">ğŸ–¨ï¸ ì¸ì‡„</button>
            <button class="btn btn-export" onclick="exportToCSV()">ğŸ“¥ CSV ë‹¤ìš´ë¡œë“œ</button>
            <button class="btn" style="background: #667eea; color: white;" onclick="showSubMaterialModal()">â• ì†Œë¶€ì¬ ì¶”ê°€</button>
            <button class="btn btn-close" onclick="window.close()">ë‹«ê¸°</button>
        </div>
    </div>

    <script>
        // BOQ ë°ì´í„° ë¡œë“œ
        function loadBOQData() {
            const boqData = JSON.parse(localStorage.getItem('boqData')) || null;
            
            if (!boqData || !boqData.items || boqData.items.length === 0) {
                document.getElementById('boqTableBody').innerHTML = 
                    '<tr><td colspan="14" style="text-align: center; padding: 30px; color: #999;">BOQ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                document.getElementById('plateTableBody').innerHTML = 
                    '<tr><td colspan="10" style="text-align: center; padding: 30px; color: #999;">Plate ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            // ì‘ì„±ì¼ í‘œì‹œ
            const now = new Date();
            document.getElementById('reportDate').textContent = 
                `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;

            // ì´ê³„ ê³„ì‚°
            let totalCount = 0;
            let totalArea = 0;
            let totalWeight = 0;
            let totalColumnAmount = 0;
            // ì €ì¥ëœ ì£¼ë¶€ì¬ ë‹¨ê°€ ë¶ˆëŸ¬ì˜¤ê¸° (ê¸°ë³¸ê°’: SM420 1,900,000ì›/í†¤, SM355 1,830,000ì›/í†¤)
            const savedPrices = JSON.parse(localStorage.getItem('boqUnitPrices')) || {};
            const columnUnitPriceSM420 = savedPrices.mainMaterialSM420 || 1900000; // SM420 í†¤ë‹¹ ë‹¨ê°€ (ì›)
            const columnUnitPriceSM355 = savedPrices.mainMaterialSM355 || 1830000; // SM355 í†¤ë‹¹ ë‹¨ê°€ (ì›)
            const steelDensity = 7850; // kg/mÂ³

            const tbody = document.getElementById('boqTableBody');
            tbody.innerHTML = '';

            boqData.items.forEach((item, index) => {
                const totalWeightItem = item.unitWeight * item.length * item.count;
                totalCount += item.count;
                totalArea += item.area * item.count;
                totalWeight += totalWeightItem;

                // ê¸°ë‘¥ ê¸ˆì•¡ ê³„ì‚°: ì¤‘ëŸ‰(í†¤) Ã— ë‹¨ê°€ (ê°•ì¢…ë³„)
                const weightInTon = totalWeightItem / 1000; // kg to ton
                let columnUnitPrice = 0;
                if (item.steelGrade === 'SM420' || item.steelGrade.includes('SM420')) {
                    columnUnitPrice = columnUnitPriceSM420;
                } else if (item.steelGrade === 'SM355' || item.steelGrade.includes('SM355')) {
                    columnUnitPrice = columnUnitPriceSM355;
                } else {
                    columnUnitPrice = columnUnitPriceSM420; // ê¸°ë³¸ê°’
                }
                const columnAmount = weightInTon * columnUnitPrice;
                totalColumnAmount += columnAmount;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td class="text-left">${item.names.join(', ')}</td>
                    <td>${item.combination}</td>
                    <td>${item.h}</td>
                    <td>${item.b}</td>
                    <td>${item.tw}</td>
                    <td>${item.tf}</td>
                    <td class="text-right">${item.area.toFixed(2)}</td>
                    <td class="text-right">${item.unitWeight.toFixed(2)}</td>
                    <td class="text-right">${item.length.toFixed(2)}</td>
                    <td>Type${item.lengthType || ''}</td>
                    <td>${item.count}</td>
                    <td class="text-right">${parseFloat(totalWeightItem.toFixed(2)).toLocaleString('ko-KR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td>${item.steelGrade}</td>
                    <td class="text-right">${columnAmount > 0 ? Math.round(columnAmount).toLocaleString('ko-KR') : '-'}</td>
                `;
                tbody.appendChild(row);
            });

            // ì´ê³„ í‘œì‹œ
            document.getElementById('totalCount').textContent = totalCount;
            document.getElementById('totalArea').textContent = totalArea.toFixed(2) + ' mmÂ²';
            document.getElementById('totalWeight').textContent = parseFloat(totalWeight.toFixed(2)).toLocaleString('ko-KR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' kg';
            document.getElementById('totalCountFooter').textContent = totalCount;
            document.getElementById('totalWeightFooter').textContent = parseFloat(totalWeight.toFixed(2)).toLocaleString('ko-KR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('totalColumnAmountFooter').textContent = totalColumnAmount > 0 ? Math.round(totalColumnAmount).toLocaleString('ko-KR') + 'ì›' : '0ì›';

            // Built-UP ë¶€ì¬ Plate ë¬¼ëŸ‰ ì •ë¦¬
            generatePlateBOQ(boqData.items);
            
            // ì´ ê¸ˆì•¡ ê³„ì‚° ë° í‘œì‹œ (ê¸°ë‘¥ ê¸ˆì•¡ + ì†Œë¶€ì¬ ê¸ˆì•¡)
            updateTotalAmount();
        }

        // ì´ ê¸ˆì•¡ ì—…ë°ì´íŠ¸
        function updateTotalAmount() {
            // ê¸°ë‘¥ ê¸ˆì•¡ í•©ê³„
            const totalColumnAmount = parseFloat(
                document.getElementById('totalColumnAmountFooter').textContent.replace(/[^0-9.]/g, '')
            ) || 0;
            
            // ì†Œë¶€ì¬ ê¸ˆì•¡ í•©ê³„
            const subMaterialTotalAmount = parseFloat(
                document.getElementById('subMaterialTotalAmountFooter').textContent.replace(/[^0-9.]/g, '')
            ) || 0;
            
            // ì´ ê¸ˆì•¡ = ê¸°ë‘¥ ê¸ˆì•¡ + ì†Œë¶€ì¬ ê¸ˆì•¡
            const totalAmount = totalColumnAmount + subMaterialTotalAmount;
            
            // ì´ ê¸ˆì•¡ í‘œì‹œ (ì†Œìˆ˜ì  ì œê±°)
            document.getElementById('totalAmount').textContent = Math.round(totalAmount).toLocaleString('ko-KR') + 'ì›';
        }

        // Built-UP ë¶€ì¬ Plate ë¬¼ëŸ‰ ì •ë¦¬ ìƒì„±
        function generatePlateBOQ(items) {
            const plateData = {}; // { "tw8-H1-Web": {...}, "tf13-H1-Flange": {...} }
            const steelDensity = 7850; // kg/mÂ³

            items.forEach(item => {
                const H1 = item.H1 || item.h;
                const H2 = item.H2 || item.h;
                const B1 = item.B1 || item.b;
                const B2 = item.B2 || item.b;
                const tw1 = item.tw;
                const tw2 = item.tw;
                const tf1 = item.tf;
                const tf2 = item.tf;

                // H1 Web Plate (tw1)
                const h1WebKey = `tw${tw1}-H1-Web`;
                if (!plateData[h1WebKey]) {
                    const webWidth = H1 - 2 * tf1; // Web ì‹¤ì œ í­
                    plateData[h1WebKey] = {
                        thickness: tw1,
                        type: 'Web',
                        section: 'H1',
                        width: webWidth,
                        thickness_mm: tw1,
                        unitWeight: 0,
                        totalLength: 0,
                        totalCount: 0,
                        totalWeight: 0,
                        steelGrade: item.steelGrade
                    };
                }
                plateData[h1WebKey].totalLength += item.length * item.count;
                plateData[h1WebKey].totalCount += item.count;

                // H1 Flange Plate (tf1) - ìƒí•˜ 2ê°œ
                const h1FlangeKey = `tf${tf1}-H1-Flange`;
                if (!plateData[h1FlangeKey]) {
                    plateData[h1FlangeKey] = {
                        thickness: tf1,
                        type: 'Flange',
                        section: 'H1',
                        width: B1,
                        thickness_mm: tf1,
                        unitWeight: 0,
                        totalLength: 0,
                        totalCount: 0,
                        totalWeight: 0,
                        steelGrade: item.steelGrade
                    };
                }
                plateData[h1FlangeKey].totalLength += item.length * item.count * 2;
                plateData[h1FlangeKey].totalCount += item.count * 2;

                // H2 Web Plate (tw2)
                const h2WebKey = `tw${tw2}-H2-Web`;
                if (!plateData[h2WebKey]) {
                    const webWidth = H2 - 2 * tf2; // Web ì‹¤ì œ í­
                    plateData[h2WebKey] = {
                        thickness: tw2,
                        type: 'Web',
                        section: 'H2',
                        width: webWidth,
                        thickness_mm: tw2,
                        unitWeight: 0,
                        totalLength: 0,
                        totalCount: 0,
                        totalWeight: 0,
                        steelGrade: item.steelGrade
                    };
                }
                plateData[h2WebKey].totalLength += item.length * item.count;
                plateData[h2WebKey].totalCount += item.count;

                // H2 Flange Plate (tf2) - ì¢Œìš° 2ê°œ
                const h2FlangeKey = `tf${tf2}-H2-Flange`;
                if (!plateData[h2FlangeKey]) {
                    plateData[h2FlangeKey] = {
                        thickness: tf2,
                        type: 'Flange',
                        section: 'H2',
                        width: B2,
                        thickness_mm: tf2,
                        unitWeight: 0,
                        totalLength: 0,
                        totalCount: 0,
                        totalWeight: 0,
                        steelGrade: item.steelGrade
                    };
                }
                plateData[h2FlangeKey].totalLength += item.length * item.count * 2;
                plateData[h2FlangeKey].totalCount += item.count * 2;
            });

            // ë‹¨ì¤‘ ê³„ì‚° ë° ì´ ì¤‘ëŸ‰ ê³„ì‚°
            Object.keys(plateData).forEach(key => {
                const plate = plateData[key];
                // ë‹¨ì¤‘(kg/m) = í­(mm) Ã— ë‘ê»˜(mm) Ã— ë°€ë„(kg/mÂ³) / 1,000,000
                plate.unitWeight = (plate.width * plate.thickness_mm * steelDensity) / 1000000;
                // ì´ ì¤‘ëŸ‰(kg) = ë‹¨ì¤‘(kg/m) Ã— ì´ ê¸¸ì´(m)
                plate.totalWeight = plate.unitWeight * plate.totalLength;
            });

            // ë‘ê»˜ë³„ë¡œ ê·¸ë£¹í™”í•˜ì—¬ í•©ì‚°
            const plateByThickness = {}; // { "8": [...], "13": [...] }
            
            Object.keys(plateData).forEach(key => {
                const plate = plateData[key];
                const thickness = plate.thickness_mm;
                
                if (!plateByThickness[thickness]) {
                    plateByThickness[thickness] = [];
                }
                plateByThickness[thickness].push(plate);
            });

            // ë‘ê»˜ë³„ í•©ì‚° ë°ì´í„° ìƒì„±
            const aggregatedPlates = [];
            Object.keys(plateByThickness).sort((a, b) => parseFloat(a) - parseFloat(b)).forEach(thickness => {
                const plates = plateByThickness[thickness];
                
                // ì‚¬ìš©ë¶€ìœ„ ì •ë³´ ìˆ˜ì§‘ (ì¤‘ë³µ ì œê±°)
                const usageParts = plates.map(p => `${p.section} ${p.type}`).join(', ');
                
                // í­ ì •ë³´ (í‰ê·  ë˜ëŠ” ëŒ€í‘œê°’, ì‹¤ì œë¡œëŠ” ê°ê° ë‹¤ë¥¼ ìˆ˜ ìˆìŒ)
                // í•©ì‚° ì‹œì—ëŠ” ê° Plateì˜ ì¤‘ëŸ‰ì„ í•©ì‚°í•˜ë¯€ë¡œ í­ì€ í‘œì‹œìš©ìœ¼ë¡œ í‰ê·  ì‚¬ìš©
                const avgWidth = plates.reduce((sum, p) => sum + p.width, 0) / plates.length;
                
                // ì´ ê¸¸ì´, ê°œìˆ˜, ì¤‘ëŸ‰ í•©ì‚°
                const totalLength = plates.reduce((sum, p) => sum + p.totalLength, 0);
                const totalCount = plates.reduce((sum, p) => sum + p.totalCount, 0);
                const totalWeight = plates.reduce((sum, p) => sum + p.totalWeight, 0);
                
                // í‰ê·  ë‹¨ì¤‘ ê³„ì‚° (ì´ ì¤‘ëŸ‰ / ì´ ê¸¸ì´)
                const avgUnitWeight = totalLength > 0 ? totalWeight / totalLength : 0;
                
                // ê°•ì¢… (ëª¨ë‘ ë™ì¼í•˜ë‹¤ê³  ê°€ì •)
                const steelGrade = plates[0].steelGrade;
                
                aggregatedPlates.push({
                    thickness: parseFloat(thickness),
                    usageParts: usageParts,
                    avgWidth: avgWidth,
                    thickness_mm: parseFloat(thickness),
                    unitWeight: avgUnitWeight,
                    totalLength: totalLength,
                    totalCount: totalCount,
                    totalWeight: totalWeight,
                    steelGrade: steelGrade
                });
            });

            // Plate í…Œì´ë¸” ë Œë”ë§
            const plateTbody = document.getElementById('plateTableBody');
            plateTbody.innerHTML = '';

            let plateTotalCount = 0;
            let plateTotalWeight = 0;
            let rowNo = 1;

            aggregatedPlates.forEach(plate => {
                plateTotalCount += plate.totalCount;
                plateTotalWeight += plate.totalWeight;

                // 25í†¤(25,000kg) ë¯¸ë§Œì¸ ê²½ìš° "í›„íŒì£¼ë¬¸" ë…¸íŠ¸ ì¶”ê°€
                const weightInTon = plate.totalWeight / 1000;
                const note = weightInTon < 25 ? 'í›„íŒì£¼ë¬¸' : '';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${rowNo++}</td>
                    <td>${plate.thickness_mm}mm</td>
                    <td>${plate.usageParts}</td>
                    <td class="text-right">${plate.avgWidth.toFixed(2)}</td>
                    <td class="text-right">${plate.thickness_mm}</td>
                    <td class="text-right">${plate.unitWeight.toFixed(2)}</td>
                    <td class="text-right">${plate.totalLength.toFixed(2)}</td>
                    <td>${plate.totalCount}</td>
                    <td class="text-right">${parseFloat(plate.totalWeight.toFixed(2)).toLocaleString('ko-KR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td>${plate.steelGrade}</td>
                    <td class="text-left" style="color: ${note ? '#e53e3e' : '#666'}; font-weight: ${note ? '600' : 'normal'}; font-size: ${note ? '12px' : '11px'};">${note}</td>
                `;
                plateTbody.appendChild(row);
            });

            // Plate í•©ê³„ì— ëŒ€í•œ ë…¸íŠ¸ (ì „ì²´ í•©ê³„ê°€ 25í†¤ ë¯¸ë§Œì¸ ê²½ìš°)
            // ì£¼ê¸°ë‘¥ ì´ì¤‘ëŸ‰ ê°€ì ¸ì˜¤ê¸° (1ë²ˆ ê¸°ë‘¥ ë¬¼ëŸ‰ ì •ë¦¬ í…Œì´ë¸”ì˜ í•©ê³„)
            const columnTotalWeightText = document.getElementById('totalWeightFooter').textContent || '0';
            const columnTotalWeight = parseFloat(columnTotalWeightText.replace(/[^0-9.]/g, '')) || 0;
            
            // ì£¼ê¸°ë‘¥ ì´ì¤‘ëŸ‰ì„ Plate ì´ì¤‘ëŸ‰ìœ¼ë¡œ ì‚¬ìš© (1ë²ˆê³¼ ë™ì¼í•˜ê²Œ)
            const plateTotalWeightForDisplay = columnTotalWeight;
            const totalWeightInTon = plateTotalWeightForDisplay / 1000;
            const totalNote = totalWeightInTon < 25 ? 'í›„íŒì£¼ë¬¸' : '';

            // Plate í•©ê³„ í‘œì‹œ (ì£¼ê¸°ë‘¥ ì´ì¤‘ëŸ‰ê³¼ ë™ì¼)
            document.getElementById('plateTotalCountFooter').textContent = plateTotalCount;
            document.getElementById('plateTotalWeightFooter').textContent = parseFloat(plateTotalWeightForDisplay.toFixed(2)).toLocaleString('ko-KR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('plateTotalNoteFooter').textContent = totalNote;
            if (totalNote) {
                document.getElementById('plateTotalNoteFooter').style.color = '#e53e3e';
                document.getElementById('plateTotalNoteFooter').style.fontWeight = '600';
            }

            // ì†Œë¶€ì¬ ë¬¼ëŸ‰ ì •ë¦¬ ìƒì„±
            generateSubMaterialBOQ(items);
            
            // ê¸°ë‘¥ TYPEë³„ ê¸¸ì´ í…Œì´ë¸” ìƒì„±
            console.log('loadBOQData - boqData.typeLengths:', boqData.typeLengths);
            console.log('loadBOQData - boqData.columnLengthData:', boqData.columnLengthData);
        }

        // ì†Œë¶€ì¬ ë¬¼ëŸ‰ ì •ë¦¬ ìƒì„±
        function generateSubMaterialBOQ(items) {
            const subMaterialData = [];
            const surchargeRate = 0.15; // í• ì¦ë¥  15%

            // ì „ì²´ ì² ê³¨ ë¬¼ëŸ‰ ê³„ì‚° (ê¸°ë‘¥ + Plate)
            // ê¸°ë‘¥ ë¬¼ëŸ‰: ê¸°ë‘¥ ë¬¼ëŸ‰ ì •ë¦¬ í…Œì´ë¸”ì˜ í•©ê³„ ì‚¬ìš© (ëª¨ë“  ë¹„ìˆ«ì ë¬¸ì ì œê±° í›„ íŒŒì‹±)
            const columnTotalWeightText = document.getElementById('totalWeightFooter').textContent || '0';
            const columnTotalWeight = parseFloat(columnTotalWeightText.replace(/[^0-9.]/g, '')) || 0;
            
            // Plate ë¬¼ëŸ‰: Plate ë¬¼ëŸ‰ ì •ë¦¬ í…Œì´ë¸”ì˜ í•©ê³„ ì‚¬ìš© (ëª¨ë“  ë¹„ìˆ«ì ë¬¸ì ì œê±° í›„ íŒŒì‹±)
            const plateTotalWeightText = document.getElementById('plateTotalWeightFooter').textContent || '0';
            const plateTotalWeight = parseFloat(plateTotalWeightText.replace(/[^0-9.]/g, '')) || 0;
            
            // ì „ì²´ ì² ê³¨ë¬¼ëŸ‰ = ê¸°ë‘¥ ë¬¼ëŸ‰ + Plate ë¬¼ëŸ‰
            const totalSteelWeight = columnTotalWeight + plateTotalWeight;

            // ì†Œë¶€ì¬ ì¢…ë¥˜ë³„ë¡œ ì •ë¦¬
            // 1. 3 PLATE (ì ‘í•©ë¶€) - ì „ì²´ ì² ê³¨ë¬¼ëŸ‰ì˜ 15%
            const plate3Weight = totalSteelWeight * 0.15; // ì „ì²´ ì² ê³¨ë¬¼ëŸ‰ì˜ 15%
            const plate3Surcharge = columnTotalWeight * surchargeRate; // í• ì¦ 15% (ì£¼ê¸°ë‘¥ ì´ì¤‘ëŸ‰ ê¸°ì¤€)
            
            // ì €ì¥ëœ ì†Œë¶€ì¬ ë‹¨ê°€ ë¶ˆëŸ¬ì˜¤ê¸° (ê¸°ë³¸ê°’: 1,900,000ì›/í†¤)
            const savedPrices = JSON.parse(localStorage.getItem('boqUnitPrices')) || {};
            const plate3UnitPrice = savedPrices.subMaterial || 1900000; // í†¤ë‹¹ ë‹¨ê°€
            console.log('ì†Œë¶€ì¬ ë‹¨ê°€:', plate3UnitPrice, 'ì €ì¥ëœ ê°’:', savedPrices);
            
            // ì†Œë¶€ì¬ ê¸ˆì•¡ ê³„ì‚°: í• ì¦ Ã— ë‹¨ê°€
            const plate3SurchargeInTon = plate3Surcharge / 1000; // í• ì¦ì„ í†¤ ë‹¨ìœ„ë¡œ ë³€í™˜
            const plate3Amount = plate3SurchargeInTon * plate3UnitPrice; // í• ì¦ Ã— ë‹¨ê°€

            if (plate3Weight > 0) {
                // SM355/SM420 ê°•ì¢… í‘œì‹œ
                const plate3SteelGrade = 'SM355/SM420';
                
                subMaterialData.push({
                    type: '3 PLATE',
                    spec: 'ì ‘í•©ë¶€',
                    unit: 'Ton',
                    quantity: '', // ìˆ˜ëŸ‰ ë¹ˆ ë¬¸ìì—´
                    steelGrade: plate3SteelGrade,
                    totalSteelWeight: columnTotalWeight.toFixed(2), // ì£¼ê¸°ë‘¥ì˜ ì´ì¤‘ëŸ‰ê³¼ ë™ì¼
                    surcharge: plate3Surcharge.toFixed(2),
                    amount: plate3Amount, // ì´ì¤‘ëŸ‰ Ã— ë‹¨ê°€
                    remark: 'ì „ì²´ ì² ê³¨ë¬¼ëŸ‰ì˜ 15%'
                });
            }

            // 2. ì‚¬ìš©ìê°€ ì¶”ê°€í•œ ì†Œë¶€ì¬ í•­ëª© (í˜ì´ì§€ ë¡œë“œ ì‹œ ë³µì›ëœ ë°ì´í„° ì‚¬ìš©)
            if (typeof subMaterialItems !== 'undefined' && subMaterialItems.length > 0) {
                subMaterialItems.forEach(item => {
                    // ì‚¬ìš©ìê°€ ì¶”ê°€í•œ ì†Œë¶€ì¬ í•­ëª©ì˜ ê¸ˆì•¡ ê³„ì‚°: í• ì¦ Ã— ë‹¨ê°€
                    const itemSurcharge = parseFloat(item.surcharge) || 0;
                    const itemSurchargeInTon = itemSurcharge / 1000;
                    
                    // ê¸ˆì•¡ = í• ì¦ Ã— ë‹¨ê°€
                    const itemTotalAmount = itemSurchargeInTon * plate3UnitPrice;
                    
                    subMaterialData.push({
                        type: item.type,
                        spec: item.spec,
                        unit: item.unit,
                        quantity: item.quantity || 0,
                        steelGrade: item.steelGrade || 'SM420',
                        totalSteelWeight: columnTotalWeight.toFixed(2), // ì£¼ê¸°ë‘¥ ì´ì¤‘ëŸ‰ê³¼ ë™ì¼
                        surcharge: itemSurcharge.toFixed(2),
                        amount: itemTotalAmount, // í• ì¦ Ã— ë‹¨ê°€
                        remark: item.remark || ''
                    });
                });
            }

            // ì†Œë¶€ì¬ í…Œì´ë¸” ë Œë”ë§
            const subMaterialTbody = document.getElementById('subMaterialTableBody');
            subMaterialTbody.innerHTML = '';

            if (subMaterialData.length === 0) {
                subMaterialTbody.innerHTML = 
                    '<tr><td colspan="11" style="text-align: center; padding: 30px; color: #999;">ì†Œë¶€ì¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                document.getElementById('subMaterialTotalQtyFooter').textContent = '0';
                document.getElementById('subMaterialTotalWeightFooter').textContent = '0';
                document.getElementById('subMaterialTotalSurchargeFooter').textContent = '0';
                document.getElementById('subMaterialTotalUnitPriceFooter').textContent = '0';
                document.getElementById('subMaterialTotalAmountFooter').textContent = '0';
                return;
            }

            let subMaterialTotalQty = 0;
            let subMaterialTotalWeight = 0;
            let subMaterialTotalSurcharge = 0;
            let subMaterialTotalSubMaterialWeight = 0;
            let subMaterialTotalAmount = 0;

            subMaterialData.forEach((item, index) => {
                const qty = parseFloat(item.quantity) || 0;
                // ì£¼ê¸°ë‘¥ë¶€ì¬ë¬¼ëŸ‰ì€ ì£¼ê¸°ë‘¥ ì´ì¤‘ëŸ‰ê³¼ ë™ì¼í•˜ê²Œ í‘œì‹œ
                const weight = columnTotalWeight; // ì£¼ê¸°ë‘¥ ì´ì¤‘ëŸ‰ ì‚¬ìš©
                const surcharge = parseFloat(item.surcharge) || 0;
                const amount = parseFloat(item.amount) || 0;

                subMaterialTotalQty += qty;
                // ì£¼ê¸°ë‘¥ë¶€ì¬ë¬¼ëŸ‰ í•©ê³„ëŠ” ê° í–‰ë§ˆë‹¤ ì£¼ê¸°ë‘¥ ì´ì¤‘ëŸ‰ì„ ë”í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, ë§ˆì§€ë§‰ì— ì£¼ê¸°ë‘¥ ì´ì¤‘ëŸ‰ìœ¼ë¡œ ì„¤ì •
                subMaterialTotalSurcharge += surcharge;
                subMaterialTotalAmount += amount;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td class="text-left">${item.type}</td>
                    <td class="text-left">${item.spec}</td>
                    <td>${item.unit}</td>
                    <td class="text-right">${item.quantity === '' || item.quantity === null || item.quantity === undefined ? '' : (qty > 0 ? qty.toFixed(2) : '')}</td>
                    <td>${item.steelGrade}</td>
                    <td class="text-right">${parseFloat(weight.toFixed(2)).toLocaleString('ko-KR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td class="text-right">${parseFloat(surcharge.toFixed(2)).toLocaleString('ko-KR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td class="text-right">${plate3UnitPrice.toLocaleString()}</td>
                    <td class="text-right">${amount > 0 ? Math.round(amount).toLocaleString('ko-KR') : '-'}</td>
                    <td class="text-left" style="font-size: 11px; color: #666;">${item.remark || ''}</td>
                `;
                subMaterialTbody.appendChild(row);
            });

            // ì†Œë¶€ì¬ í•©ê³„ í‘œì‹œ
            document.getElementById('subMaterialTotalQtyFooter').textContent = subMaterialTotalQty.toFixed(2);
            // ì´ ì¤‘ëŸ‰ = ì£¼ê¸°ë‘¥ì˜ ì´ì¤‘ëŸ‰ (ê¸°ë‘¥ ë¬¼ëŸ‰ë§Œ)
            document.getElementById('subMaterialTotalWeightFooter').textContent = columnTotalWeight > 0 ? parseFloat(columnTotalWeight.toFixed(2)).toLocaleString('ko-KR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0';
            document.getElementById('subMaterialTotalSurchargeFooter').textContent = subMaterialTotalSurcharge > 0 ? parseFloat(subMaterialTotalSurcharge.toFixed(2)).toLocaleString('ko-KR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0';
            // ì†Œë¶€ì¬ ë‹¨ê°€ í‘œì‹œ
            document.getElementById('subMaterialTotalUnitPriceFooter').textContent = plate3UnitPrice.toLocaleString();
            document.getElementById('subMaterialTotalAmountFooter').textContent = subMaterialTotalAmount > 0 ? Math.round(subMaterialTotalAmount).toLocaleString('ko-KR') + 'ì›' : '-';
            
            // ì´ ê¸ˆì•¡ ì—…ë°ì´íŠ¸
            updateTotalAmount();
        }

        // Auto Find Selection Table ìƒì„±
        function generateAutoFindTable(autoFindResults) {
            const tbody = document.getElementById('autoFindTableBody');
            tbody.innerHTML = '';
            
            console.log('generateAutoFindTable í˜¸ì¶œë¨, autoFindResults:', autoFindResults);
            
            if (!autoFindResults || autoFindResults.length === 0) {
                console.log('autoFindResultsê°€ ë¹„ì–´ìˆìŒ');
                tbody.innerHTML = '<tr><td colspan="16" style="text-align: center; padding: 30px; color: #999;">Auto Find Selection ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }
            
            let rowNo = 1;
            autoFindResults.forEach((result) => {
                // ê²½ê³  ë©”ì‹œì§€ê°€ ìˆëŠ” ê²½ìš° ê±´ë„ˆë›°ê¸°
                if (result.warning) {
                    console.log('ê²½ê³  ë©”ì‹œì§€ê°€ ìˆëŠ” í•­ëª© ê±´ë„ˆë›°ê¸°:', result.name || result.no);
                    return;
                }
                
                console.log('í–‰ ì¶”ê°€:', rowNo, result.name || result.no, result);
                
                const currentRowNo = rowNo++;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${currentRowNo}</td>
                    <td class="text-left" style="font-weight: 600; color: #667eea;">${result.name || `KC${result.no}`}</td>
                    <td class="text-right">${result.pu !== undefined && result.pu !== null ? result.pu.toFixed(2) : '-'}</td>
                    <td class="text-right">${result.mux !== undefined && result.mux !== null ? result.mux.toFixed(2) : '-'}</td>
                    <td class="text-right">${result.muy !== undefined && result.muy !== null ? result.muy.toFixed(2) : '-'}</td>
                    <td class="text-right" style="${result.pmm > 1.0 ? 'color: #e53e3e; font-weight: 600;' : 'color: #38a169;'}">${result.pmm !== undefined && result.pmm !== null && result.pmm > 0 ? result.pmm.toFixed(2) : '-'}</td>
                    <td>${result.steelGrade || '-'}</td>
                    <td style="font-weight: 600; color: #667eea;">${result.combination || '-'}</td>
                    <td>${result.h || '-'}</td>
                    <td>${result.b || '-'}</td>
                    <td>${result.tw || '-'}</td>
                    <td>${result.tf || '-'}</td>
                    <td class="text-right">${result.area !== undefined && result.area !== null ? result.area.toFixed(2) : '-'}</td>
                    <td class="text-right">${result.unitWeight !== undefined && result.unitWeight !== null ? result.unitWeight.toFixed(2) : '-'}</td>
                    <td class="text-right" style="color: #667eea; font-weight: 600;">${result.unitPrice !== undefined && result.unitPrice !== null ? result.unitPrice.toLocaleString('ko-KR') : '-'}</td>
                    <td class="text-right" style="color: #38a169; font-weight: 600;">${result.costPerMeter !== undefined && result.costPerMeter !== null ? result.costPerMeter.toFixed(2) : '-'}</td>
                `;
                tbody.appendChild(row);
            });
            
            console.log('generateAutoFindTable ì™„ë£Œ, ì¶”ê°€ëœ í–‰ ìˆ˜:', rowNo - 1);
        }


        // CSV ë‹¤ìš´ë¡œë“œ
        function exportToCSV() {
            const boqData = JSON.parse(localStorage.getItem('boqData')) || null;
            
            if (!boqData || !boqData.items || boqData.items.length === 0) {
                alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            let csv = 'No.,ê¸°ë‘¥ëª…,ì¡°í•©,H(mm),B(mm),tw(mm),tf(mm),ë‹¨ë©´ì (mmÂ²),ë‹¨ì¤‘(kg/m),ê¸¸ì´(m),ê¸¸ì´íƒ€ì…,ê°œìˆ˜,ì´ ì¤‘ëŸ‰(kg),ê°•ì¢…\n';

            boqData.items.forEach((item, index) => {
                const totalWeightItem = item.unitWeight * item.length * item.count;
                csv += `${index + 1},"${item.names.join(', ')}",${item.combination},${item.h},${item.b},${item.tw},${item.tf},${item.area.toFixed(2)},${item.unitWeight.toFixed(2)},${item.length.toFixed(2)},Type${item.lengthType || ''},${item.count},${totalWeightItem.toFixed(2)},${item.steelGrade}\n`;
            });

            // ì´ê³„ ì¶”ê°€
            let totalCount = 0;
            let totalWeight = 0;
            boqData.items.forEach(item => {
                totalCount += item.count;
                totalWeight += item.unitWeight * item.length * item.count;
            });
            csv += `í•©ê³„,,,,,,,,,,,,${totalCount},${totalWeight.toFixed(2)},\n`;

            // BOM ì¶”ê°€ (í•œê¸€ ê¹¨ì§ ë°©ì§€)
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `BOQ_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¡œë“œ
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¡œë“œ ë° ì†Œë¶€ì¬ í•­ëª© ë³µì›
        window.addEventListener('load', function() {
            loadBOQData();
            
            // ì €ì¥ëœ ì†Œë¶€ì¬ í•­ëª© ë³µì›
            const boqData = JSON.parse(localStorage.getItem('boqData')) || null;
            if (boqData && boqData.subMaterials) {
                subMaterialItems = boqData.subMaterials;
            }

            // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
            document.addEventListener('click', function(e) {
                const subMaterialModal = document.getElementById('subMaterialModal');
                if (subMaterialModal && e.target === subMaterialModal) {
                    closeSubMaterialModal();
                }
            });
        });
    </script>
</body>
</html>
