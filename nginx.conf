worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

# Limit worker file descriptors
worker_rlimit_nofile 8192;

events {
    worker_connections 1024;
    use epoll;
    multi_accept on;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # ============================================================
    # SECURITY: Hide nginx version in error pages and headers
    # ============================================================
    server_tokens off;

    # ============================================================
    # SECURITY: Real IP from Lightsail ALB (reverse proxy)
    # Lightsail uses AWS internal ranges for load balancer
    # ============================================================
    set_real_ip_from 10.0.0.0/8;
    set_real_ip_from 172.16.0.0/12;
    set_real_ip_from 192.168.0.0/16;
    real_ip_header X-Forwarded-For;
    real_ip_recursive on;

    # ============================================================
    # SECURITY: Rate Limiting Zones (DDoS Protection)
    # ============================================================
    # General request rate: 10 requests/second per IP, burst of 20
    limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;
    
    # Strict rate for potential attack vectors: 2 requests/second
    limit_req_zone $binary_remote_addr zone=strict:10m rate=2r/s;

    # Connection limit per IP
    limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

    # Rate limit response code (429 Too Many Requests)
    limit_req_status 429;
    limit_conn_status 429;

    # ============================================================
    # SECURITY: Buffer Size Limits (Prevent Buffer Overflow)
    # ============================================================
    client_body_buffer_size 1k;
    client_header_buffer_size 1k;
    client_max_body_size 1k;           # Static site needs no uploads
    large_client_header_buffers 2 1k;

    # ============================================================
    # SECURITY: Timeout Hardening (Slowloris Protection)
    # ============================================================
    client_body_timeout 10s;
    client_header_timeout 10s;
    send_timeout 10s;
    keepalive_timeout 15s;
    keepalive_requests 100;

    # Reset lingering connections quickly
    reset_timedout_connection on;

    # ============================================================
    # Logging with security-relevant fields
    # ============================================================
    log_format security '$remote_addr - $remote_user [$time_local] '
                        '"$request" $status $body_bytes_sent '
                        '"$http_referer" "$http_user_agent" '
                        '$request_time $upstream_response_time '
                        '"$http_x_forwarded_for" "$http_x_real_ip"';

    access_log /var/log/nginx/access.log security;

    # ============================================================
    # Performance (safe settings)
    # ============================================================
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    types_hash_max_size 2048;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_min_length 256;
    gzip_types text/plain text/css text/xml application/json application/javascript 
               application/xml application/xml+rss text/javascript image/svg+xml;

    # ============================================================
    # SECURITY: Block bad bots and scanners (User-Agent filtering)
    # - Empty user agents blocked
    # - Security scanners blocked (nikto, sqlmap, nmap, masscan, zgrab)
    # - Legitimate tools allowed (python-requests, curl, wget)
    # - Search engines allowed (bot, crawl, spider)
    # ============================================================
    map $http_user_agent $bad_bot {
        default                                 0;
        "~*^$"                                  1;
        "~*(nikto|sqlmap|nmap|masscan|zgrab)"  1;
        "~*(python-requests|curl|wget)"        0;
        "~*(bot|crawl|spider)"                 0;
    }

    # ============================================================
    # SECURITY: Block suspicious request patterns
    # ============================================================
    # Block suspicious request patterns:
    # - Path traversal (..)
    # - Injection characters (<>'";)
    # - Sensitive files (etc/passwd, etc/shadow)
    # - Script extensions (.php, .asp, .jsp, .cgi)
    # - WordPress attacks (wp-admin, wp-login, xmlrpc)
    # - Config/Git files (.git, .env, .config)
    # - Admin panels (phpmyadmin)
    map $request_uri $suspicious_request {
        default                    0;
        "~*\.\."                   1;
        "~*[<>'\";]"               1;
        "~*etc/passwd"             1;
        "~*etc/shadow"             1;
        "~*\.php"                  1;
        "~*\.asp"                  1;
        "~*\.jsp"                  1;
        "~*\.cgi"                  1;
        "~*wp-admin"               1;
        "~*wp-login"               1;
        "~*xmlrpc"                 1;
        "~*\.git"                  1;
        "~*\.env"                  1;
        "~*\.config"               1;
        "~*phpmyadmin"             1;
    }

    # ============================================================
    # SERVER BLOCK
    # ============================================================
    server {
        listen 80 default_server;
        server_name _;
        root /usr/share/nginx/html;
        index index.html;

        # ============================================================
        # SECURITY: Connection and Rate Limits
        # ============================================================
        limit_conn conn_limit 20;          # Max 20 concurrent connections per IP
        limit_req zone=general burst=20 nodelay;

        # ============================================================
        # SECURITY: Only allow safe HTTP methods for static site
        # ============================================================
        if ($request_method !~ ^(GET|HEAD)$) {
            return 405;
        }

        # ============================================================
        # SECURITY: Block bad bots
        # ============================================================
        if ($bad_bot) {
            return 403;
        }

        # ============================================================
        # SECURITY: Block suspicious requests
        # ============================================================
        if ($suspicious_request) {
            return 403;
        }

        # ============================================================
        # SECURITY: Comprehensive Security Headers
        # ============================================================
        # Prevent clickjacking
        add_header X-Frame-Options "SAMEORIGIN" always;
        
        # Prevent MIME-type sniffing
        add_header X-Content-Type-Options "nosniff" always;
        
        # XSS protection (legacy browsers)
        add_header X-XSS-Protection "1; mode=block" always;
        
        # Referrer policy - don't leak URLs
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        
        # Permissions policy - disable unnecessary APIs
        add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()" always;
        
        # Content Security Policy - restrict resource loading
        add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data:; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://*.supabase.co https://cdn.jsdelivr.net https://api.frankfurter.dev https://open.er-api.com; frame-src 'self' https://www.youtube.com https://youtube.com; frame-ancestors 'self'; form-action 'self'; base-uri 'self';" always;

        # ============================================================
        # SECURITY: Deny access to sensitive patterns FIRST
        # ============================================================
        
        # Block hidden files (., .git, .env, etc.)
        location ~ /\. {
            deny all;
            access_log off;
            log_not_found off;
            return 404;
        }

        # Block backup files
        location ~* \.(bak|backup|old|orig|save|swp|tmp)$ {
            deny all;
            return 404;
        }

        # Block config files
        location ~* \.(ini|log|conf|config|yml|yaml|toml|json)$ {
            deny all;
            return 404;
        }

        # ============================================================
        # Health check endpoint (for ALB health checks)
        # ============================================================
        location = /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # ============================================================
        # Main location
        # ============================================================
        location / {
            try_files $uri $uri/ =404;
            
            # Security headers for all responses from this location
            add_header X-Frame-Options "SAMEORIGIN" always;
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-XSS-Protection "1; mode=block" always;
            add_header Referrer-Policy "strict-origin-when-cross-origin" always;
            add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()" always;
            add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data:; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://*.supabase.co https://cdn.jsdelivr.net https://api.frankfurter.dev https://open.er-api.com; frame-src 'self' https://www.youtube.com https://youtube.com; frame-ancestors 'self'; form-action 'self'; base-uri 'self';" always;
        }

        # ============================================================
        # Static assets - cache with revalidation
        # ============================================================
        location ~* \.(png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|jfif)$ {
            expires 1y;
            add_header Cache-Control "public, immutable" always;
            add_header X-Frame-Options "SAMEORIGIN" always;
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-XSS-Protection "1; mode=block" always;
            add_header Referrer-Policy "strict-origin-when-cross-origin" always;
            access_log off;
            limit_req zone=general burst=50 nodelay;
        }

        # CSS/JS - short cache with revalidation (avoids hard refresh issues)
        location ~* \.(css|js)$ {
            expires 1h;
            add_header Cache-Control "public, must-revalidate" always;
            add_header X-Frame-Options "SAMEORIGIN" always;
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-XSS-Protection "1; mode=block" always;
            add_header Referrer-Policy "strict-origin-when-cross-origin" always;
            access_log off;
            limit_req zone=general burst=50 nodelay;
        }

        # ============================================================
        # HTML files - no caching
        # ============================================================
        location ~* \.html$ {
            expires -1;
            add_header Cache-Control "no-store, no-cache, must-revalidate" always;
            add_header X-Frame-Options "SAMEORIGIN" always;
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-XSS-Protection "1; mode=block" always;
            add_header Referrer-Policy "strict-origin-when-cross-origin" always;
            add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()" always;
            add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data:; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://*.supabase.co https://cdn.jsdelivr.net https://api.frankfurter.dev https://open.er-api.com; frame-src 'self' https://www.youtube.com https://youtube.com; frame-ancestors 'self'; form-action 'self'; base-uri 'self';" always;
        }

        # ============================================================
        # Error handling - don't reveal internal paths
        # ============================================================
        error_page 400 401 403 404 /404.html;
        error_page 500 502 503 504 /50x.html;
        
        location = /404.html {
            internal;
            root /usr/share/nginx/html;
        }
        
        location = /50x.html {
            internal;
            return 503 "Service temporarily unavailable";
        }
    }
}
